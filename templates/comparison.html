<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ç­”å¯¹æ¯”</title>
    <style>
        /* ===== è®¾è®¡ä»¤ç‰Œç³»ç»Ÿ ===== */
        :root {
            /* é¢œè‰²ç³»ç»Ÿ */
            --bg: #ffffff;
            --surface: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --brand: #2563eb;
            --brand-hover: #1d4ed8;
            --border: #e5e7eb;
            --hover: #f3f4f6;
            --success: #10b981;
            --danger: #dc2626;
            --warning: #f59e0b;
            
            /* åœ†è§’ç³»ç»Ÿ */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            /* é˜´å½±ç³»ç»Ÿ */
            --elev-1: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
            --elev-2: 0 4px 20px rgba(0,0,0,.08);
            --elev-3: 0 8px 24px rgba(0,0,0,.12);
            --elev-dropdown: 0 8px 24px rgba(0,0,0,.15);
            
            /* é—´è·ç³»ç»Ÿ */
            --space-2: 8px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* å­—å·è¡Œé«˜ç³»ç»Ÿ */
            --fs-12: 12px;
            --fs-14: 14px;
            --fs-16: 16px;
            --fs-20: 20px;
            --fs-24: 24px;
            --lh-1_4: 1.4;
            --lh-1_6: 1.6;
            
            /* è¿‡æ¸¡åŠ¨ç”» */
            --transition: box-shadow .2s, transform .15s, border-color .2s, background .2s;
        }
        
        /* æš—è‰²ä¸»é¢˜æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --surface: #1e293b;
                --text: #f1f5f9;
                --muted: #94a3b8;
                --border: #334155;
                --hover: #334155;
            }
        }

        /* ===== åŸºç¡€é‡ç½®ä¸å…¨å±€æ ·å¼ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: var(--lh-1_6);
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: auto;
            font-size: var(--fs-14);
        }

        .container {
            width: 100%;
            margin: 0;
            padding: var(--space-6);
            max-width: none;
        }

        /* ===== é¡¶éƒ¨Headerç»„ä»¶ ===== */
        .header {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--elev-2);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .header:hover {
            box-shadow: var(--elev-3);
        }

        .header h1 {
            font-size: var(--fs-24);
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .upload-section {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: var(--brand);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            font-size: var(--fs-14);
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--elev-1);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .file-input-button:hover {
            background: var(--brand-hover);
            transform: translateY(-1px);
            box-shadow: var(--elev-2);
        }

        .file-input-button:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }

        .file-name {
            color: var(--muted);
            font-size: var(--fs-14);
            margin-left: var(--space-2);
        }

        /* ===== æŸ¥è¯¢æ˜¾ç¤ºå¡ç‰‡ ===== */
        .query-display {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            border-left: 4px solid var(--brand);
            backdrop-filter: blur(10px);
            box-shadow: var(--elev-2);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .query-display:hover {
            box-shadow: var(--elev-3);
        }

        .query-display.sticky {
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--elev-3);
            margin-bottom: 0; /* ç¡®ä¿ç´§è´´ä¸‹æ–¹å†…å®¹ */
        }

        .query-text {
            font-size: var(--fs-20);
            font-weight: 600;
            line-height: var(--lh-1_6);
            color: var(--text);
            margin-bottom: var(--space-4);
        }

        .query-number {
            font-size: var(--fs-12);
            font-weight: 500;
            color: var(--muted);
            padding: var(--space-2) var(--space-4);
            background: var(--hover);
            border-radius: var(--radius-sm);
            display: inline-block;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border);
            margin-left: var(--space-4);
        }

        .query-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            overflow: hidden;
            max-height: 200px; /* è¶³å¤Ÿå¤§çš„åˆå§‹é«˜åº¦ */
        }

        .query-display.collapsed .query-nav {
            max-height: 0 !important;
            opacity: 0;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .query-display.collapsed {
            padding: var(--space-2) var(--space-6);
            margin-bottom: var(--space-2);
        }

        .query-display.collapsed .query-header-row {
            margin-bottom: 0 !important;
        }

        .query-display.collapsed .query-text {
            margin-bottom: 0;
        }

        .query-fold-button {
            background: var(--hover);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: var(--space-1) var(--space-2);
            cursor: pointer;
            font-size: var(--fs-12);
            color: var(--muted);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .query-fold-button:hover {
            background: var(--border);
            color: var(--text);
        }

        .query-fold-button.collapsed::after {
            content: 'â–¼';
        }

        .query-fold-button:not(.collapsed)::after {
            content: 'â–²';
        }

        .nav-buttons {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        /* ===== æœç´¢ä¸‹æ‹‰æ¡† ===== */
        .search-results {
            position: fixed;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--elev-dropdown);
            max-height: 320px;
            overflow-y: auto;
            z-index: 9999999;
            display: none;
            margin-top: 0px;
            width: 200px;
            backdrop-filter: blur(10px);
        }

        .search-result-item {
            padding: var(--space-2) var(--space-4);
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .search-result-item:hover {
            background: var(--hover);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-number {
            font-weight: 600;
            color: var(--brand);
            margin-right: var(--space-2);
        }

        .search-result-content {
            color: var(--text);
            font-size: var(--fs-14);
            line-height: var(--lh-1_4);
        }

        .search-section {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
        }

        .search-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .search-type-select {
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--fs-14);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
        }

        .search-type-select:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-type-select:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }

        .search-input {
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--fs-14);
            width: 200px;
            transition: var(--transition);
            background: var(--surface);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-input:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }

        .search-button {
            background: var(--brand);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--fs-14);
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--elev-1);
        }

        .search-button:hover {
            background: var(--brand-hover);
            transform: translateY(-1px);
            box-shadow: var(--elev-2);
        }

        .search-button:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }

        /* ===== å¯¼èˆªæŒ‰é’® ===== */
        .nav-button {
            background: var(--brand);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--fs-14);
            font-weight: 500;
            transition: var(--transition);
            min-width: 80px;
            height: 36px;
            backdrop-filter: blur(10px);
            box-shadow: var(--elev-1);
        }

        .nav-button:hover:not(:disabled) {
            background: var(--brand-hover);
            transform: translateY(-1px);
            box-shadow: var(--elev-2);
        }

        .nav-button:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }

        .nav-button:disabled {
            background: var(--muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .query-info {
            color: var(--muted);
            font-size: var(--fs-14);
            font-weight: 500;
            background: var(--hover);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border);
        }

        /* ===== åˆ—é€‰æ‹©å¡ç‰‡ ===== */
        .column-selection {
            background: var(--surface);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            box-shadow: var(--elev-2);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .column-selection:hover {
            box-shadow: var(--elev-3);
        }

        .column-selection.collapsed {
            padding: var(--space-3) var(--space-4);
        }

        .column-selection.expanded {
            padding: var(--space-6);
        }

        .column-selection h3 {
            font-size: var(--fs-20);
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--text);
        }

        .column-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0;
            border-radius: var(--radius-lg);
            transition: var(--transition);
            user-select: none;
        }

        .column-selection-header:hover {
            background: var(--hover);
            padding: var(--space-2);
            margin: calc(-1 * var(--space-2));
        }

        .column-selection-header h3 {
            margin: 0;
            font-size: var(--fs-18);
            font-weight: 600;
            color: var(--text);
        }

        .toggle-icon {
            font-size: var(--fs-16);
            color: var(--muted);
            transition: transform 0.2s ease;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .column-selection-content {
            padding: 0 var(--space-4) var(--space-4);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 200px;
            }
        }

        .auto-mode-checkbox {
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--border);
        }

        .auto-mode-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--brand);
            outline: none;
            border: 1px solid var(--border);
        }

        .auto-mode-checkbox input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .auto-mode-checkbox label {
            margin-left: var(--space-2);
            font-size: var(--fs-14);
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
        }

        .column-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            align-items: center;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .column-checkbox:hover {
            background: var(--hover);
        }

        .column-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--brand);
            outline: none;
            border: 1px solid var(--border);
        }

        .column-checkbox input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .column-checkbox input[type="checkbox"]:checked {
            background: var(--brand);
            border-color: var(--brand);
        }

        .column-checkbox label {
            cursor: pointer;
            font-size: var(--fs-14);
            color: var(--text);
            transition: var(--transition);
        }

        .column-checkbox label:hover {
            color: var(--brand);
        }

        /* ===== å¯¹æ¯”ç½‘æ ¼ ===== */
        .comparison-grid {
            display: grid;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            width: 100%;
            grid-auto-rows: 1fr;
            align-items: stretch;
        }

        .comparison-column {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 0;
            box-shadow: var(--elev-2);
            min-width: 0;
            overflow-wrap: break-word;
            flex: 1;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            position: relative;
            user-select: text;
        }

        .comparison-column:hover {
            box-shadow: var(--elev-3);
        }

        .comparison-column.dragging {
            cursor: grabbing;
            opacity: 0.7;
            transform: rotate(2deg);
            z-index: 1000;
            user-select: none;
        }

        .comparison-column.drag-over {
            border: 2px dashed var(--brand);
            background: rgba(37, 99, 235, 0.05);
        }

        .drag-handle {
            display: none; /* éšè—æ‹–æ‹½bar */
        }

        .comparison-column:hover .drag-handle {
            display: none; /* å³ä½¿hoverä¹Ÿéšè— */
        }

        .drag-handle:hover {
            background: var(--brand);
            color: white;
            border-color: var(--brand);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* æ¨¡å‹æ ‡é¢˜åŒºåŸŸå®¹å™¨ */
        .column-header-container {
            position: sticky;
            top: 0;
            background: var(--surface);
            margin-bottom: 0;
            padding: var(--space-2) calc(var(--space-4) - 4px);
            border-bottom: 2px solid var(--border);
            flex-shrink: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky; /* sticky å®šä½ï¼Œä¸ºç»å¯¹å®šä½çš„æ‹–æ‹½æŠŠæ‰‹æä¾›å®šä½ä¸Šä¸‹æ–‡ */
        }
        
        /* å½“æŸ¥è¯¢åŒºåŸŸå›ºå®šæ—¶ï¼Œè°ƒæ•´æ¨¡å‹æ ‡é¢˜çš„topå€¼ */
        body.query-sticky .column-header-container {
            top: var(--query-sticky-height, 180px); /* åŠ¨æ€è®¡ç®—çš„æŸ¥è¯¢åŒºåŸŸé«˜åº¦ */
            margin-top: 0; /* ç¡®ä¿ç´§è´´ query display åº•éƒ¨ */
        }

        /* å½“ query-display å›ºå®šæ—¶ï¼Œè°ƒæ•´ comparison-grid çš„ä½ç½® */
        body.query-sticky .comparison-grid {
            margin-top: 0; /* ç¡®ä¿å†…å®¹ç´§è´´ query display åº•éƒ¨ */
        }

        .column-header {
            font-size: 16px;
            font-weight: 600;
            color: #000000; /* é»‘è‰² */
            margin: 0;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            flex-shrink: 1;
        }

        /* å¾½æ ‡å®¹å™¨ */
        .badges-container {
            display: flex;
            gap: var(--space-2);
            align-items: center;
            justify-content: flex-end;
            margin-bottom: var(--space-2);
        }
        
        /* èƒœç‡å’Œå­—æ•°æ ‡ç­¾ */
        .win-rate-large { 
            font-size: var(--fs-10); 
            font-weight: 600; 
            margin-left: 2px;
            white-space: nowrap;
        }
        .metric-muted { 
            font-size: var(--fs-10); 
            color: var(--muted);
            white-space: nowrap;
        }
        .badge-label {
            font-size: 9px;
            color: var(--muted);
            margin-right: 2px;
            white-space: nowrap;
        }
        
        /* è¿›åº¦æ¡å®¹å™¨ */
        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: #e5e7eb; /* æµ…ç°è‰²èƒŒæ™¯ */
            border-radius: 2px;
            margin: var(--space-2) 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* ç¤ºä¾‹å†…å®¹é¢„è§ˆ */
        .content-preview {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--border);
        }
        
        .content-preview-label {
            font-size: var(--fs-12);
            color: var(--muted);
            margin-bottom: var(--space-2);
        }
        
        .content-preview-text {
            font-size: var(--fs-14);
            color: var(--text);
            line-height: var(--lh-1_5);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* èƒœç‡å¾½æ ‡ */
        .win-rate-badge {
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            background: #10b981; /* green-500 */
            color: white;
            border: 1px solid #10b981;
            font-size: var(--fs-12);
            font-weight: 500;
            line-height: 1.2;
            user-select: none;
            white-space: nowrap;
        }

        /* å­—æ•°å¾½æ ‡ */
        .char-count-badge {
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            background: var(--brand);
            color: white;
            border: 1px solid var(--brand);
            font-size: var(--fs-10);
            font-weight: 500;
            line-height: 1;
            user-select: none;
            box-shadow: var(--elev-1);
        }

        .char-count-badge.char-count-badge--max {
            background: #ef4444; /* red-500 */
            border-color: #ef4444;
        }

        .column-content {
            color: var(--text);
            line-height: var(--lh-1_6);
            flex: 1;
            padding: 0 calc(var(--space-4) - 4px) calc(var(--space-4) - 4px) calc(var(--space-4) - 4px);
        }

        /* ===== ç©ºçŠ¶æ€ ===== */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-6);
            color: var(--muted);
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--elev-2);
            border: 1px solid var(--border);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.6;
        }

        .empty-state-text {
            font-size: var(--fs-16);
            margin-bottom: var(--space-2);
            font-weight: 500;
        }

        .empty-state-subtext {
            font-size: var(--fs-14);
            color: var(--muted);
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 1440px) {
            .container {
                padding: var(--space-4);
            }
            
            .comparison-grid {
                gap: var(--space-4);
            }
        }

        @media (max-width: 1280px) {
            .header {
                flex-direction: column;
                gap: var(--space-4);
                text-align: center;
            }
            
            .query-nav {
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .search-section {
                margin-left: 0;
                width: 100%;
            }
            
            .search-controls {
                flex-direction: column;
                width: 100%;
                gap: var(--space-2);
            }
            
            .search-type-select {
                width: 100%;
            }
            
            .search-input {
                width: 100%;
            }
        }

        @media (max-width: 1024px) {
            .column-checkboxes {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: var(--space-2);
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-2);
            }
            
            .header h1 {
                font-size: var(--fs-20);
            }
            
            .query-text {
                font-size: var(--fs-16);
            }
            
            .column-selection h3 {
                font-size: var(--fs-16);
            }
            
            .column-header {
                font-size: var(--fs-16);
            }
            
            .nav-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .nav-button {
                width: 100%;
            }
        }

        /* ===== å¯è®¿é—®æ€§å¢å¼º ===== */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }

        /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
        @media (prefers-contrast: high) {
            :root {
                --border: #000000;
                --text: #000000;
                --muted: #333333;
            }
        }

        /* ===== Markdownæ¸²æŸ“æ ·å¼ä¼˜åŒ– ===== */
        /* æ ‡é¢˜æ ·å¼ - ä½¿ç”¨è®¾è®¡ä»¤ç‰Œ */
        /* æ ‡é¢˜å­—ä½“å¤§å°æ¯”ä¾‹ï¼šH1 : H2 : H3 : H4 : P â‰ˆ 1.4 : 1.25 : 1.12 : 1.05 : 1 */
        /* åŸºå‡† P = 14px */
        .markdown-h1{font-size:19.6px;font-weight:600;color:#000000;margin-top:var(--space-4);margin-bottom:var(--space-2);line-height:1.3}
        .markdown-h2{font-size:17.5px;font-weight:600;color:#000000;margin-top:var(--space-4);margin-bottom:var(--space-2);line-height:1.4}
        .markdown-h3{font-size:15.68px;font-weight:600;color:#000000;margin-top:var(--space-4);margin-bottom:var(--space-2);line-height:1.4}
        .markdown-h4{font-size:14.7px;font-weight:600;color:#000000;margin:var(--space-4) 0 var(--space-2);line-height:1.4}
        .markdown-h5{font-size:var(--fs-14);font-weight:600;color:#000000;margin:var(--space-4) 0 var(--space-2);line-height:1.4}
        .markdown-h6{font-size:var(--fs-12);font-weight:600;color:#000000;margin:var(--space-2) 0 var(--space-2);line-height:1.4}
        /* æ®µè½æ ·å¼ */
        .markdown-p{margin:0 0 var(--space-4);line-height:var(--lh-1_6);color:#4a4a4f}
        /* åˆ—è¡¨æ ·å¼ */
        .markdown-ul{margin:0 0 var(--space-4);list-style-type:disc;list-style-position:inside}
        .markdown-ol{margin:0 0 var(--space-4);list-style-type:decimal;list-style-position:inside}
        .markdown-li{margin-bottom:var(--space-2);line-height:var(--lh-1_4);color:#4a4a4f}
        .markdown-blockquote{border-left:4px solid var(--brand);background:var(--hover);padding:var(--space-4) var(--space-4);margin:var(--space-4) 0;border-radius:0 var(--radius-md) var(--radius-md) 0;color:#4a4a4f;font-style:italic}
        /* ä»£ç æ ·å¼ */
        .markdown-code{background:var(--hover);color:var(--danger);padding:var(--space-2) var(--space-2);border-radius:var(--radius-sm);font-family:ui-monospace,Menlo,monospace;font-size:0.9em}
        /* è¡¨æ ¼æ ·å¼ */
        .markdown-table-wrapper{overflow-x:auto;margin:var(--space-4) 0;-webkit-overflow-scrolling:touch}
        .markdown-table{border-collapse:collapse;width:100%;border:1px solid var(--border);min-width:500px}
        .markdown-table thead,.markdown-table-thead{background:var(--hover)}
        .markdown-table th,.markdown-table-th{background:var(--hover);border:1px solid var(--border);padding:var(--space-2) var(--space-4);text-align:left;font-weight:600;font-size:var(--fs-14);min-width:80px;white-space:nowrap;vertical-align:top;color:#000000}
        .markdown-table td,.markdown-table-td{border:1px solid var(--border);padding:var(--space-2) var(--space-4);font-size:var(--fs-14);min-width:100px;max-width:250px;vertical-align:top;color:#4a4a4f}
        .markdown-table tr,.markdown-table-tr{border-bottom:1px solid var(--border)}
        .markdown-hr{border:none;border-top:1px solid var(--border);margin:var(--space-6) 0}
        .markdown-link{color:var(--brand);text-decoration:none;border-bottom:1px solid transparent;transition:var(--transition)}
        .markdown-link:hover{color:var(--brand-hover);border-bottom-color:var(--brand)}
        .markdown-del{text-decoration:line-through;color:#4a4a4f}
        .markdown-pre{background:var(--hover);border:1px solid var(--border);border-radius:var(--radius-sm);padding:var(--space-4);margin:var(--space-4) 0;overflow-x:auto;font-family:ui-monospace,Menlo,monospace;font-size:0.9em;line-height:var(--lh-1_6)}
        .markdown-code-block{background:transparent;padding:0;border:none;color:#4a4a4f;white-space:pre-wrap}
        .markdown-img{max-width:100%;height:auto;border-radius:var(--radius-md);margin:var(--space-4) 0;display:block}
        .markdown-img-scroll-container{width:100%;overflow-x:auto;overflow-y:hidden;margin:var(--space-4) 0;scroll-snap-type:x mandatory;scrollbar-width:none;-ms-overflow-style:none;padding:0;box-sizing:border-box}
        .markdown-img-scroll-container::-webkit-scrollbar{display:none}
        .markdown-img-scroll-container-inner{display:flex;flex-direction:row;gap:8px;padding:0;width:max-content}
        .markdown-img-scroll-item{flex-shrink:0;scroll-snap-align:start;box-sizing:border-box;display:flex;flex-direction:column;width:160px;height:160px}
        .markdown-img-scroll-item img{width:100%;height:100%;object-fit:cover;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:block;margin:0;aspect-ratio:1/1}
        .markdown-img-scroll-item div[data-fallback="img"]{width:100%;height:100%;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;flex-direction:column;justify-content:center;align-items:center;border:2px dashed #ddd;background:#f8f9fa;padding:20px;box-sizing:border-box;margin:0;aspect-ratio:1/1}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>å›ç­”å¯¹æ¯”</h1>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
                    <button class="file-input-button">ä¸Šä¼ Excelæ–‡ä»¶</button>
                </div>
                <span id="fileName" class="file-name"></span>
            </div>
        </div>

        <!-- Query Display -->
        <div class="query-display" id="queryDisplay" style="display: none;">
            <div class="query-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="query-text" id="queryText"></div>
                    <div class="query-number" id="queryNumber"></div>
                </div>
                <button class="query-fold-button" id="queryFoldButton" onclick="toggleQueryFold()" title="æŠ˜å /å±•å¼€"></button>
            </div>
            <div class="query-nav">
                <div class="nav-buttons">
                    <button class="nav-button" id="prevQuery" onclick="previousQuery()">ä¸Šä¸€ä¸ª</button>
                    <button class="nav-button" id="nextQuery" onclick="nextQuery()">ä¸‹ä¸€ä¸ª</button>
                    <div class="query-info" id="queryInfo"></div>
                </div>
                <div class="search-section">
                    <div class="search-controls">
                        <select id="searchType" class="search-type-select">
                            <option value="number">æœç´¢ç¼–å·</option>
                            <option value="content">æœç´¢å†…å®¹</option>
                        </select>
                        <div style="position: relative;">
                            <input type="text" id="searchInput" class="search-input" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹..." />
                            <div class="search-results" id="searchResults"></div>
                        </div>
                    </div>
                    <button class="search-button" onclick="searchQuery()">æœç´¢</button>
                </div>
            </div>
        </div>

        <!-- Column Selection -->
        <div class="column-selection" id="columnSelection" style="display: none;">
            <div class="column-selection-header" onclick="toggleColumnSelection()">
                <h3>æ¨¡å‹åº”ç”¨é€‰æ‹©</h3>
                <span class="toggle-icon" id="toggleIcon">â–¼</span>
            </div>
            <div class="column-selection-content" id="columnSelectionContent" style="display: none;">
                <div class="auto-mode-checkbox">
                    <input type="checkbox" id="autoMode" checked onchange="toggleAutoMode()">
                    <label for="autoMode">ä»…å±•ç¤ºæœ‰å›å¤çš„æ¨¡å‹</label>
                </div>
                <div class="column-checkboxes" id="columnCheckboxes"></div>
            </div>
        </div>

        <!-- Comparison Grid -->
        <div class="comparison-grid" id="comparisonGrid"></div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">ğŸ“Š</div>
            <div class="empty-state-text">è¯·ä¸Šä¼ Excelæ–‡ä»¶å¼€å§‹å¯¹æ¯”</div>
            <div class="empty-state-subtext">æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let excelData = null;
        let winRateData = null; // èƒœç‡æ•°æ®
        let charCountData = null; // å­—æ•°ç»Ÿè®¡æ•°æ®
        let currentQueryIndex = 0;
        let selectedColumns = [];
        let autoMode = true; // é»˜è®¤å¼€å¯è‡ªåŠ¨æ¨¡å¼

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                loadExcelFile(file);
            }
        });

        // åŠ è½½Excelæ–‡ä»¶
        function loadExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è¯»å– response sheetï¼ˆæŸ¥è¯¢å’Œç­”æ¡ˆï¼‰
                    const responseSheet = workbook.Sheets['response'] || workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(responseSheet, { header: 1 });
                    
                    // è¯»å– èƒœç‡ sheet
                    if (workbook.Sheets['èƒœç‡']) {
                        winRateData = XLSX.utils.sheet_to_json(workbook.Sheets['èƒœç‡'], { header: 1 });
                    }
                    
                    // è¯»å– å­—æ•°ç»Ÿè®¡ sheet
                    if (workbook.Sheets['å­—æ•°ç»Ÿè®¡']) {
                        charCountData = XLSX.utils.sheet_to_json(workbook.Sheets['å­—æ•°ç»Ÿè®¡'], { header: 1 });
                    }
                    
                    console.log('Excel sheets loaded:', {
                        response: excelData?.length,
                        winRate: winRateData?.length,
                        charCount: charCountData?.length
                    });
                    
                    // è¾“å‡ºå„ä¸ªsheetçš„åˆ—åï¼Œæ–¹ä¾¿è°ƒè¯•
                    if (excelData && excelData[0]) {
                        console.log('Response åˆ—å:', excelData[0]);
                    }
                    if (winRateData && winRateData[0]) {
                        console.log('èƒœç‡ åˆ—å:', winRateData[0]);
                    }
                    if (charCountData && charCountData[0]) {
                        console.log('å­—æ•°ç»Ÿè®¡ åˆ—å:', charCountData[0]);
                    }
                    
                    if (excelData.length > 0) {
                        setupColumnSelection();
                        showQueryDisplay();
                        updateQueryDisplay();
                    }
                } catch (error) {
                    const errorMsg = error && (error.message || String(error)) || 'æœªçŸ¥é”™è¯¯';
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + errorMsg + '\n\nè¯·ç¡®è®¤ä¸º .xlsx/.xls æ ¼å¼ï¼Œä¸”æœªåŠ å¯†/æŸå');
                    console.error('Excel parsing error:', error);
                    console.error('Error stack:', error.stack);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // åˆ‡æ¢è‡ªåŠ¨æ¨¡å¼
        function toggleAutoMode() {
            const autoModeCheckbox = document.getElementById('autoMode');
            autoMode = autoModeCheckbox.checked;
            
            if (autoMode) {
                // å¼€å¯è‡ªåŠ¨æ¨¡å¼ï¼Œæ¸…ç©ºæ‰‹åŠ¨é€‰æ‹©çš„æ¨¡å‹
                clearManualSelection();
                try {
                updateComparisonGrid();
            } catch (err) {
                console.error('Error in updateComparisonGrid:', err);
                alert('æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼æ—¶å‡ºé”™ï¼š' + (err.message || err));
            }
            } else {
                // å…³é—­è‡ªåŠ¨æ¨¡å¼ï¼Œä½¿ç”¨æ‰‹åŠ¨é€‰æ‹©çš„æ¨¡å‹
                updateColumnSelection();
            }
        }

        // æ¸…ç©ºæ‰‹åŠ¨é€‰æ‹©çš„æ¨¡å‹
        function clearManualSelection() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }

        // åˆ‡æ¢åˆ—é€‰æ‹©åŒºåŸŸçš„å±•å¼€/æŠ˜å 
        function toggleColumnSelection() {
            const content = document.getElementById('columnSelectionContent');
            const icon = document.getElementById('toggleIcon');
            const container = document.getElementById('columnSelection');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('expanded');
                container.classList.remove('collapsed');
                container.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('expanded');
                container.classList.remove('expanded');
                container.classList.add('collapsed');
            }
        }

        // è®¾ç½®åˆ—é€‰æ‹©
        function setupColumnSelection() {
            const checkboxesContainer = document.getElementById('columnCheckboxes');
            const columnSelection = document.getElementById('columnSelection');
            const content = document.getElementById('columnSelectionContent');
            
            // å›ºå®šæ˜¾ç¤º9ä¸ªæ¨¡å‹é€‰é¡¹ï¼Œä¸ä¾èµ–Excelæ•°æ®
            const modelOptions = [
                'Deepseek',
                'ChatGPT', 
                'ç‚¹ç‚¹',
                'Kimi',
                'è±†åŒ…',
                'Gemini',
                'é—®ä¸€é—®',
                'Grok',
                'å…ƒå®'
            ];
            
            checkboxesContainer.innerHTML = '';
            
            modelOptions.forEach((modelName, index) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'column-checkbox';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="model_${index}" value="${modelName}" onchange="updateColumnSelection()">
                    <label for="model_${index}">${modelName}</label>
                `;
                checkboxesContainer.appendChild(checkboxDiv);
            });
            
            // æ˜¾ç¤ºåˆ—é€‰æ‹©åŒºåŸŸï¼Œä½†å†…å®¹é»˜è®¤æŠ˜å 
            columnSelection.style.display = 'block';
            content.style.display = 'none';
            columnSelection.classList.add('collapsed');
        }

        // æ›´æ–°åˆ—é€‰æ‹©
        function updateColumnSelection() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked');
            selectedColumns = [];
            
            // å¦‚æœç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©äº†æ¨¡å‹ï¼Œè‡ªåŠ¨å…³é—­è‡ªåŠ¨æ¨¡å¼
            if (checkboxes.length > 0) {
                autoMode = false;
                document.getElementById('autoMode').checked = false;
            }
            
            if (excelData && excelData.length > 0) {
                const headers = excelData[0];
                
                Array.from(checkboxes).forEach(cb => {
                    const modelName = cb.value;
                    // åœ¨Excelè¡¨å¤´ä¸­æŸ¥æ‰¾å¯¹åº”çš„åˆ—ç´¢å¼•
                    const columnIndex = headers.findIndex(header => 
                        header && header.trim() === modelName
                    );
                    
                    if (columnIndex !== -1) {
                        selectedColumns.push({
                            index: columnIndex,
                            name: modelName
                        });
                    }
                });
            }
            
            try {
                updateComparisonGrid();
            } catch (err) {
                console.error('Error in updateComparisonGrid:', err);
                alert('æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼æ—¶å‡ºé”™ï¼š' + (err.message || err));
            }
        }

        // æ˜¾ç¤ºæŸ¥è¯¢æ˜¾ç¤ºåŒºåŸŸ
        function showQueryDisplay() {
            document.getElementById('queryDisplay').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        // æ›´æ–°æŸ¥è¯¢æ˜¾ç¤º
        function updateQueryDisplay() {
            if (!excelData || excelData.length <= 1) return;
            
            const currentRow = excelData[currentQueryIndex + 1]; // +1 å› ä¸ºç¬¬ä¸€è¡Œæ˜¯header
            const headers = excelData[0];
            
            // æŸ¥æ‰¾initial_questionåˆ—çš„ç´¢å¼•
            const initialQuestionIndex = headers.findIndex(header => 
                header && header.toLowerCase().includes('initial_question')
            );
            
            const queryColumn = initialQuestionIndex >= 0 ? currentRow[initialQuestionIndex] : currentRow[0];
            
            // è·å–ç¬¬äºŒåˆ—çš„ç¼–å·ï¼ˆç´¢å¼•1ï¼‰
            const queryNumber = currentRow[1] || 'æ— ç¼–å·';
            
            document.getElementById('queryText').textContent = queryColumn || 'æ— æŸ¥è¯¢å†…å®¹';
            document.getElementById('queryNumber').textContent = `ç¼–å·: ${queryNumber}`;
            document.getElementById('queryInfo').textContent = `ç¬¬ ${currentQueryIndex + 1} ä¸ªæŸ¥è¯¢ï¼Œå…± ${excelData.length - 1} ä¸ª`;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevQuery').disabled = currentQueryIndex === 0;
            document.getElementById('nextQuery').disabled = currentQueryIndex >= excelData.length - 2;
            
            try {
                updateComparisonGrid();
            } catch (err) {
                console.error('Error in updateComparisonGrid:', err);
                alert('æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼æ—¶å‡ºé”™ï¼š' + (err.message || err));
            }
        }

        // è®¡ç®—æ€§æ»šåŠ¨åˆ°ç­”æ¡ˆåŒºé¡¶éƒ¨ï¼ˆè€ƒè™‘ sticky é«˜åº¦ï¼‰
        function scrollAnswersToTop() {
            const queryDisplay = document.getElementById('queryDisplay');
            const grid = document.getElementById('comparisonGrid');
            if (!queryDisplay || !grid) return;

            // å¦‚æœ queryDisplay å¤„äº sticky çŠ¶æ€ï¼Œç”¨å®ƒçš„å®é™…é«˜åº¦åšåç§»
            // æˆ–è€…ä½¿ç”¨ CSS å˜é‡ä¸­çš„é«˜åº¦ï¼ˆæ›´ç¨³å®šï¼‰
            const stickyHeight = getComputedStyle(document.documentElement)
                .getPropertyValue('--query-sticky-height')
                .trim()
                .replace('px', '') || 0;
            const stickyOffset = stickyHeight ? parseInt(stickyHeight) : 
                (queryDisplay.classList.contains('sticky') ? queryDisplay.offsetHeight : 0);

            // ç›®æ ‡ä½ç½® = comparisonGrid ç›¸å¯¹è§†å£çš„ top + å½“å‰æ»šåŠ¨é‡ - sticky é«˜åº¦ - ä¸€ç‚¹ç‚¹å†…è¾¹è·
            const targetY = window.scrollY + grid.getBoundingClientRect().top - stickyOffset - 8;

            // ç”¨ä¸¤å¸§ RAFï¼Œç¡®ä¿ DOM æ¸²æŸ“å®Œå†æ»šåŠ¨ï¼ˆæ¯” setTimeout(0) æ›´ç¨³ï¼‰
            requestAnimationFrame(() =>
                requestAnimationFrame(() => {
                    window.scrollTo({ top: Math.max(targetY, 0), behavior: 'auto' });
                    // é‡ç½®æ¨ªå‘å›¾å»Šçš„æ»šåŠ¨ä½ç½®
                    resetHorizontalGalleries();
                })
            );
        }

        // é‡ç½®æ¨ªå‘å›¾å»Šçš„æ»šåŠ¨ä½ç½®
        function resetHorizontalGalleries() {
            document.querySelectorAll('.markdown-img-scroll-container').forEach(sc => {
                sc.scrollLeft = 0;
            });
        }

        // ä¸Šä¸€ä¸ªæŸ¥è¯¢
        function previousQuery() {
            if (currentQueryIndex > 0) {
                currentQueryIndex--;
                updateQueryDisplay();
                scrollAnswersToTop();
            }
        }

        // ä¸‹ä¸€ä¸ªæŸ¥è¯¢
        function nextQuery() {
            if (currentQueryIndex < excelData.length - 2) {
                currentQueryIndex++;
                updateQueryDisplay();
                scrollAnswersToTop();
            }
        }

        // æ›´æ–° sticky é«˜åº¦
        function updateStickyHeights() {
            const queryDisplay = document.getElementById('queryDisplay');
            if (!queryDisplay) return;
            
            // å¦‚æœ query-display æ˜¯ sticky çŠ¶æ€ï¼Œæ›´æ–°é«˜åº¦
            if (queryDisplay.classList.contains('sticky')) {
                const queryHeight = queryDisplay.offsetHeight;
                document.documentElement.style.setProperty('--query-sticky-height', `${queryHeight}px`);
            }
        }

        // åˆ‡æ¢æŸ¥è¯¢æ˜¾ç¤ºåŒºåŸŸçš„æŠ˜å çŠ¶æ€
        function toggleQueryFold() {
            const queryDisplay = document.getElementById('queryDisplay');
            const foldButton = document.getElementById('queryFoldButton');
            if (!queryDisplay || !foldButton) return;
            
            queryDisplay.classList.toggle('collapsed');
            foldButton.classList.toggle('collapsed');
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåæ›´æ–° sticky é«˜åº¦
            setTimeout(() => {
                updateStickyHeights();
            }, 300); // ä¸ CSS transition æ—¶é—´ä¸€è‡´
        }

        // å®æ—¶æœç´¢å‡½æ•°
        function performSearch(searchTerm) {
            if (!excelData) return;

            const headers = excelData[0];
            const searchType = document.getElementById('searchType').value;
            
            // æŸ¥æ‰¾ç¼–å·åˆ—ï¼ˆç¬¬äºŒåˆ—ï¼‰å’Œå†…å®¹åˆ—ï¼ˆç¬¬ä¸‰åˆ—ï¼‰
            const numberColumnIndex = 1; // ç¬¬äºŒåˆ—
            const contentColumnIndex = 2; // ç¬¬ä¸‰åˆ—
            
            const searchResults = [];
            
            if (searchType === 'number') {
                // åªæœç´¢ç¼–å·ï¼ˆç¬¬äºŒåˆ—ï¼‰
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    const numberValue = row[numberColumnIndex];
                    
                    if (numberValue && numberValue.toString().toLowerCase().includes(searchTerm.toLowerCase())) {
                        searchResults.push({
                            index: i - 1,
                            type: 'ç¼–å·',
                            value: numberValue,
                            content: row[contentColumnIndex] || 'æ— å†…å®¹'
                        });
                    }
                }
            } else if (searchType === 'content') {
                // åªæœç´¢å†…å®¹ï¼ˆç¬¬ä¸‰åˆ—ï¼‰
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    const contentValue = row[contentColumnIndex];
                    
                    if (contentValue && contentValue.toString().toLowerCase().includes(searchTerm.toLowerCase())) {
                        searchResults.push({
                            index: i - 1,
                            type: 'å†…å®¹',
                            value: contentValue,
                            content: contentValue
                        });
                    }
                }
            }
            
            console.log('æœç´¢ç»“æœ:', searchResults);
            
            if (searchResults.length === 0) {
                hideSearchResults();
            } else if (searchResults.length === 1) {
                // åªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥è·³è½¬
                currentQueryIndex = searchResults[0].index;
                updateQueryDisplay();
                hideSearchResults();
            } else {
                // å¤šä¸ªç»“æœï¼Œæ˜¾ç¤ºä¸‹æ‹‰é€‰æ‹©æ¡†
                showSearchResults(searchResults);
            }
        }

        // æœç´¢æŸ¥è¯¢
        function searchQuery() {
            console.log('æœç´¢å‡½æ•°è¢«è°ƒç”¨');
            const searchTerm = document.getElementById('searchInput').value.trim();
            console.log('æœç´¢è¯:', searchTerm);
            console.log('Excelæ•°æ®æ˜¯å¦å­˜åœ¨:', !!excelData);
            
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                return;
            }
            
            if (!excelData) {
                alert('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶');
                return;
            }

            const headers = excelData[0];
            console.log('è¡¨å¤´:', headers);
            console.log('å‰3è¡Œæ•°æ®:', excelData.slice(0, 4));
            
            // æŸ¥æ‰¾ç¼–å·åˆ—ï¼ˆç¬¬äºŒåˆ—ï¼‰å’Œå†…å®¹åˆ—ï¼ˆç¬¬ä¸‰åˆ—ï¼‰
            const numberColumnIndex = 1; // ç¬¬äºŒåˆ—
            const contentColumnIndex = 2; // ç¬¬ä¸‰åˆ—
            
            console.log('æœç´¢ç¼–å·åˆ—ç´¢å¼•:', numberColumnIndex);
            console.log('æœç´¢å†…å®¹åˆ—ç´¢å¼•:', contentColumnIndex);
            console.log('æœç´¢è¯:', searchTerm);
            
            const searchResults = [];
            
            // æœç´¢ç¼–å·ï¼ˆç¬¬äºŒåˆ—ï¼‰
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                const numberValue = row[numberColumnIndex];
                
                console.log(`æ£€æŸ¥ç¬¬${i}è¡Œç¼–å·åˆ—:`, numberValue, 'æœç´¢è¯:', searchTerm);
                
                if (numberValue && numberValue.toString().toLowerCase().includes(searchTerm.toLowerCase())) {
                    console.log('åœ¨ç¼–å·åˆ—æ‰¾åˆ°åŒ¹é…:', numberValue, 'è¡Œç´¢å¼•:', i);
                    searchResults.push({
                        index: i - 1,
                        type: 'ç¼–å·',
                        value: numberValue,
                        content: row[contentColumnIndex] || 'æ— å†…å®¹'
                    });
                }
            }
            
            // æœç´¢å†…å®¹ï¼ˆç¬¬ä¸‰åˆ—ï¼‰
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                const contentValue = row[contentColumnIndex];
                
                if (contentValue && contentValue.toString().toLowerCase().includes(searchTerm.toLowerCase())) {
                    console.log('åœ¨å†…å®¹åˆ—æ‰¾åˆ°åŒ¹é…:', contentValue, 'è¡Œç´¢å¼•:', i);
                    // é¿å…é‡å¤æ·»åŠ ï¼ˆå¦‚æœç¼–å·åˆ—å·²ç»æ·»åŠ äº†ï¼‰
                    const existingResult = searchResults.find(result => result.index === i - 1);
                    if (!existingResult) {
                        searchResults.push({
                            index: i - 1,
                            type: 'å†…å®¹',
                            value: contentValue,
                            content: contentValue
                        });
                    }
                }
            }
            
            console.log('æœç´¢ç»“æœæ•°é‡:', searchResults.length);
            
            if (searchResults.length === 0) {
                console.log('æœªæ‰¾åˆ°åŒ¹é…çš„æŸ¥è¯¢');
                alert('æœªæ‰¾åˆ°åŒ¹é…çš„æŸ¥è¯¢');
                hideSearchResults();
            } else if (searchResults.length === 1) {
                // åªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥è·³è½¬
                currentQueryIndex = searchResults[0].index;
                updateQueryDisplay();
                hideSearchResults();
            } else {
                // å¤šä¸ªç»“æœï¼Œæ˜¾ç¤ºä¸‹æ‹‰é€‰æ‹©æ¡†
                showSearchResults(searchResults);
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœä¸‹æ‹‰æ¡†
        function showSearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            const searchInput = document.getElementById('searchInput');
            
            // è·å–æœç´¢æ¡†çš„ä½ç½®
            const inputRect = searchInput.getBoundingClientRect();
            
            // å…³é”®ï¼šæŠŠä¸‹æ‹‰æŒ‚åˆ° bodyï¼Œé¿å…ç¥–å…ˆçš„ backdrop-filter/transform å½±å“
            if (resultsContainer.parentElement !== document.body) {
                document.body.appendChild(resultsContainer);
            }
            
            resultsContainer.innerHTML = '';
            
            results.forEach((result, idx) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.onclick = () => selectSearchResult(result);
                
                // è·å–ç¼–å·å’Œqueryå†…å®¹
                const numberValue = excelData[result.index + 1][1]; // ç¬¬äºŒåˆ—ï¼ˆç¼–å·ï¼‰
                const queryContent = excelData[result.index + 1][2]; // ç¬¬ä¸‰åˆ—ï¼ˆqueryå†…å®¹ï¼‰
                
                resultItem.innerHTML = `
                    <div class="search-result-content">
                        <span style="color: var(--brand); font-weight: 500;">${numberValue}</span>
                        <span style="color: var(--text); margin-left: 8px;">${queryContent}</span>
                    </div>
                `;
                
                resultsContainer.appendChild(resultItem);
            });
            
            // è®¾ç½®ä¸‹æ‹‰æ¡†ä½ç½®
            resultsContainer.style.position = 'fixed';
            resultsContainer.style.top = (inputRect.bottom) + 'px'; // è´´åœ¨è¾“å…¥æ¡†ä¸‹ç¼˜
            resultsContainer.style.left = inputRect.left + 'px';
            resultsContainer.style.width = inputRect.width + 'px';
            resultsContainer.style.zIndex = '2147483647'; // æœ€é«˜å±‚çº§ä¿é™©
            resultsContainer.style.display = 'block';
        }

        // éšè—æœç´¢ç»“æœä¸‹æ‹‰æ¡†
        function hideSearchResults() {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.style.display = 'none';
        }

        // é€‰æ‹©æœç´¢ç»“æœ
        function selectSearchResult(result) {
            currentQueryIndex = result.index;
            updateQueryDisplay();
            hideSearchResults();
        }

        // æ›´æ–°æœç´¢è¾“å…¥æ¡†placeholder
        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('searchInput');
            const searchType = document.getElementById('searchType').value;
            
            if (searchType === 'number') {
                searchInput.placeholder = 'è¯·è¾“å…¥ç¼–å·...';
            } else if (searchType === 'content') {
                searchInput.placeholder = 'è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹...';
            }
        }

        // æœç´¢æ¡†å®æ—¶æœç´¢å’Œç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchTypeSelect = document.getElementById('searchType');
            
            if (searchInput) {
                // å®æ—¶æœç´¢
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim();
                    if (searchTerm.length >= 2) { // è‡³å°‘2ä¸ªå­—ç¬¦æ‰å¼€å§‹æœç´¢
                        performSearch(searchTerm);
                    } else {
                        hideSearchResults();
                    }
                });
                
                // å›è½¦é”®æœç´¢
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchQuery();
                    }
                });
            }
            
            // æœç´¢ç±»å‹æ”¹å˜æ—¶æ›´æ–°placeholder
            if (searchTypeSelect) {
                searchTypeSelect.addEventListener('change', function() {
                    updateSearchPlaceholder();
                    // æ¸…ç©ºæœç´¢è¾“å…¥æ¡†
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = '';
                        hideSearchResults();
                    }
                });
                
                // åˆå§‹åŒ–placeholder
                updateSearchPlaceholder();
            }
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                const searchInputEl = document.getElementById('searchInput');
                const resultsEl = document.getElementById('searchResults');
                if (
                    searchInputEl && resultsEl &&
                    e.target !== searchInputEl &&
                    !searchInputEl.contains(e.target) &&
                    e.target !== resultsEl &&
                    !resultsEl.contains(e.target)
                ) {
                    hideSearchResults();
                }
            });
            
            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ˜¾ç¤ºæ¡†æ¶
            setupColumnSelection();
            try {
                updateComparisonGrid();
            } catch (err) {
                console.error('Error in updateComparisonGrid:', err);
                alert('æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼æ—¶å‡ºé”™ï¼š' + (err.message || err));
            }
            setupStickyQueryDisplay();
        });

        // è®¾ç½®æŸ¥è¯¢æ˜¾ç¤ºåŒºåŸŸçš„ç²˜æ€§å®šä½
        function setupStickyQueryDisplay() {
            const queryDisplay = document.getElementById('queryDisplay');
            if (!queryDisplay) return;

            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', function() {
                const queryDisplayRect = queryDisplay.getBoundingClientRect();
                const headerHeight = 80; // å‡è®¾headeré«˜åº¦çº¦ä¸º80px
                
                // å½“æŸ¥è¯¢æ˜¾ç¤ºåŒºåŸŸæ»šåŠ¨åˆ°è·ç¦»é¡¶éƒ¨ä¸€å®šè·ç¦»æ—¶ï¼Œæ·»åŠ stickyç±»
                if (queryDisplayRect.top <= headerHeight + 20) {
                    queryDisplay.classList.add('sticky');
                    document.body.classList.add('query-sticky');
                    
                    // åŠ¨æ€è®¡ç®—æŸ¥è¯¢åŒºåŸŸçš„å®é™…é«˜åº¦ï¼Œå¹¶æ›´æ–°æ¨¡å‹æ ‡é¢˜çš„topå€¼
                    const queryHeight = queryDisplay.offsetHeight;
                    // ç›´æ¥ä½¿ç”¨ queryHeightï¼Œè®©å†…å®¹ç´§è´´ query display åº•éƒ¨
                    document.documentElement.style.setProperty('--query-sticky-height', `${queryHeight}px`);
                } else {
                    queryDisplay.classList.remove('sticky');
                    document.body.classList.remove('query-sticky');
                }
            });
        }

        // ä»å­—æ•°ç»Ÿè®¡è¡¨è·å–å­—æ•°
        function getCharCount(modelName, queryIndex) {
            if (!charCountData || charCountData.length <= queryIndex + 1) return null;
            
            const headers = charCountData[0];
            const row = charCountData[queryIndex + 1];
            
            if (!row) return null;
            
            // æŸ¥æ‰¾æ¨¡å‹åå¯¹åº”çš„åˆ— - å…ˆç²¾ç¡®åŒ¹é…
            let columnIndex = headers.findIndex(h => h === modelName);
            
            // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•å®½æ¾åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™å’Œç©ºæ ¼ï¼‰
            if (columnIndex === -1) {
                const normalizedModelName = modelName.toLowerCase().trim();
                columnIndex = headers.findIndex(h => {
                    if (!h) return false;
                    return h.toString().toLowerCase().trim() === normalizedModelName;
                });
            }
            
            if (columnIndex === -1) {
                console.warn(`å­—æ•°ç»Ÿè®¡æœªæ‰¾åˆ°æ¨¡å‹: ${modelName}`, 'å¯ç”¨çš„åˆ—:', headers);
                return null;
            }
            
            const value = row[columnIndex];
            return value || null;
        }
        
        // ä»èƒœç‡è¡¨è·å–èƒœç‡æ•°æ®
        function getWinRate(modelName, queryIndex) {
            if (!winRateData || winRateData.length <= queryIndex + 1) return null;
            
            const headers = winRateData[0];
            const row = winRateData[queryIndex + 1];
            
            if (!row) return null;
            
            // æŸ¥æ‰¾æ¨¡å‹åå¯¹åº”çš„åˆ— - å…ˆç²¾ç¡®åŒ¹é…
            let columnIndex = headers.findIndex(h => h === modelName);
            
            // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•å®½æ¾åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™å’Œç©ºæ ¼ï¼‰
            if (columnIndex === -1) {
                const normalizedModelName = modelName.toLowerCase().trim();
                columnIndex = headers.findIndex(h => {
                    if (!h) return false;
                    return h.toString().toLowerCase().trim() === normalizedModelName;
                });
            }
            
            if (columnIndex === -1) {
                console.warn(`èƒœç‡æ•°æ®æœªæ‰¾åˆ°æ¨¡å‹: ${modelName}`, 'å¯ç”¨çš„åˆ—:', headers);
                return null;
            }
            
            const value = row[columnIndex];
            return value || null;
        }

        // æ ¹æ®æ•°å€¼åœ¨æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´çš„ä½ç½®ï¼Œè¿”å›æ¸å˜è‰²
        // æœ€å°å€¼->ç»¿è‰²ï¼Œä¸­é—´å€¼->é»„è‰²/æ©™è‰²ï¼Œæœ€å¤§å€¼->çº¢è‰²
        function getGradientColor(value, minValue, maxValue) {
            if (minValue === maxValue) return '#3b82f6'; // å¦‚æœéƒ½ä¸€æ ·ï¼Œè¿”å›è“è‰²
            
            // å½’ä¸€åŒ–åˆ° 0-1
            const ratio = (value - minValue) / (maxValue - minValue);
            
            let r, g, b;
            if (ratio < 0.5) {
                // ç»¿è‰² (34, 197, 94) åˆ° é»„è‰² (234, 179, 8)
                const localRatio = ratio * 2;
                r = Math.round(34 + (234 - 34) * localRatio);
                g = Math.round(197 + (179 - 197) * localRatio);
                b = Math.round(94 + (8 - 94) * localRatio);
            } else {
                // é»„è‰² (234, 179, 8) åˆ° çº¢è‰² (239, 68, 68)
                const localRatio = (ratio - 0.5) * 2;
                r = Math.round(234 + (239 - 234) * localRatio);
                g = Math.round(179 + (68 - 179) * localRatio);
                b = Math.round(8 + (68 - 8) * localRatio);
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        // è§£æèƒœç‡å­—ç¬¦ä¸²ï¼Œæå–ç™¾åˆ†æ¯”æ•°å€¼
        function parseWinRate(winRateStr) {
            if (!winRateStr) return null;
            const match = winRateStr.toString().match(/(\d+\.?\d*)%/);
            return match ? parseFloat(match[1]) : null;
        }
        
        // æ¨¡å‹åç§°ç¼©å†™æ˜ å°„
        function getDisplayName(modelName) {
            const nameMap = {
                'ChatGPT': 'ChatGPT',
                'Deepseek': 'Deepseek',
                'deepseek': 'Deepseek',
                'chatgpt': 'ChatGPT'
            };
            return nameMap[modelName] || modelName;
        }

        // æ›´æ–°å¯¹æ¯”ç½‘æ ¼
        function updateComparisonGrid() {
            const grid = document.getElementById('comparisonGrid');
            
            if (!excelData) {
                // æ²¡æœ‰Excelæ•°æ®æ—¶ï¼Œæ˜¾ç¤ºä¿çš®çš„æç¤º
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--muted);">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”</div>
                        <div style="font-size: 18px; margin-bottom: 12px; font-weight: 500;">è¿˜æ²¡æœ‰é€‰æ‹©è¦å¯¹æ¯”çš„åˆ—å‘¢~</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">ä¸Šä¼ Excelæ–‡ä»¶å¹¶é€‰æ‹©åˆ—åï¼Œå°±èƒ½çœ‹åˆ°ç²¾å½©çš„å¯¹æ¯”å•¦ï¼</div>
                        <div style="font-size: 12px; color: #9ca3af;">âœ¨ æœŸå¾…ä½ çš„æ•°æ®å“¦ âœ¨</div>
                    </div>
                `;
                grid.style.gridTemplateColumns = '1fr';
                return;
            }
            
            const currentRow = excelData[currentQueryIndex + 1];
            const headers = excelData[0];
            let columnsToShow = [];
            
            if (autoMode) {
                // è‡ªåŠ¨æ¨¡å¼ï¼šåªæ˜¾ç¤ºæœ‰å†…å®¹çš„æ¨¡å‹
                const modelNames = ['Deepseek', 'ChatGPT', 'ç‚¹ç‚¹', 'Kimi', 'è±†åŒ…', 'Gemini', 'é—®ä¸€é—®', 'Grok', 'å…ƒå®'];
                
                modelNames.forEach(modelName => {
                    const columnIndex = headers.findIndex(header => 
                        header && header.trim() === modelName
                    );
                    
                    if (columnIndex !== -1) {
                        const content = currentRow[columnIndex] || '';
                        // åªæœ‰å½“å†…å®¹ä¸ä¸ºç©ºæ—¶æ‰æ˜¾ç¤º
                        if (content.trim()) {
                            columnsToShow.push({
                                index: columnIndex,
                                name: modelName
                            });
                        }
                    }
                });
            } else {
                // æ‰‹åŠ¨æ¨¡å¼ï¼šæ˜¾ç¤ºç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹
                columnsToShow = selectedColumns;
            }
            
            if (columnsToShow.length === 0) {
                // æ²¡æœ‰è¦æ˜¾ç¤ºçš„åˆ—æ—¶ï¼Œæ˜¾ç¤ºæç¤º
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--muted);">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“</div>
                        <div style="font-size: 18px; margin-bottom: 12px; font-weight: 500;">å½“å‰æŸ¥è¯¢æ²¡æœ‰æ¨¡å‹å›å¤</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">è¯•è¯•åˆ‡æ¢åˆ°å…¶ä»–æŸ¥è¯¢ï¼Œæˆ–è€…æ‰‹åŠ¨é€‰æ‹©æ¨¡å‹</div>
                        <div style="font-size: 12px; color: #9ca3af;">ğŸ’¡ æç¤ºï¼šå¯ä»¥å…³é—­ã€Œä»…å±•ç¤ºæœ‰å›å¤çš„æ¨¡å‹ã€æ¥æŸ¥çœ‹æ‰€æœ‰æ¨¡å‹</div>
                    </div>
                `;
                grid.style.gridTemplateColumns = '1fr';
                return;
            }
            
            grid.innerHTML = '';
            
            // è®¾ç½®ç½‘æ ¼åˆ—æ•° - å¹³é“ºæ’‘æ»¡æ•´é¡µï¼Œç¡®ä¿åˆ—å¹³å‡åˆ†é…
            grid.style.gridTemplateColumns = `repeat(${columnsToShow.length}, minmax(0, 1fr))`;
            grid.style.width = '100%';
            grid.style.display = 'grid';
            
            // ç”¨äºæ”¶é›†æ•°æ®ï¼Œç¨åç»Ÿä¸€åº”ç”¨æ¸å˜è‰²
            const charCountBadges = [];
            const charCounts = [];
            const winRateBadges = [];
            const winRateValues = [];
            const winRateMap = new Map(); // æ¨¡å‹å -> èƒœç‡å€¼çš„æ˜ å°„

            columnsToShow.forEach((column, index) => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'comparison-column';
                columnDiv.dataset.columnIndex = index;
                
                // æ·»åŠ æ‹–æ‹½æ‰‹æŸ„
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle';
                dragHandle.innerHTML = 'â‹®â‹®';
                dragHandle.title = 'æ‹–æ‹½é‡æ–°æ’åº';
                dragHandle.style.cursor = 'grab';
                
                // åˆ›å»ºæ ‡é¢˜å®¹å™¨
                const headerContainer = document.createElement('div');
                headerContainer.className = 'column-header-container';
                
                // åˆ›å»ºå¤´éƒ¨å†…å®¹åŒºåŸŸï¼ˆflexå¸ƒå±€ï¼šæ¨¡å‹åã€èƒœç‡ã€å­—æ•°åœ¨åŒä¸€è¡Œï¼‰
                const headerContent = document.createElement('div');
                headerContent.style.display = 'flex';
                headerContent.style.justifyContent = 'space-between';
                headerContent.style.alignItems = 'center';
                headerContent.style.marginBottom = 'var(--space-2)';
                headerContent.style.flexWrap = 'nowrap';
                
                // å·¦ä¾§ï¼šæ¨¡å‹åç§°
                const headerLeft = document.createElement('div');
                headerLeft.style.display = 'flex';
                headerLeft.style.alignItems = 'center';
                headerLeft.style.flex = '1';
                headerLeft.style.minWidth = '0';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'column-header';
                headerDiv.textContent = getDisplayName(column.name);
                headerDiv.title = column.name;
                headerDiv.style.margin = '0';
                headerDiv.style.marginBottom = '0';
                headerLeft.appendChild(headerDiv);
                // é¢„å…ˆè®¡ç®—èƒœç‡ï¼Œä¾›æ˜¾æ€§åŒ–å’Œå³ä¾§å¾½æ ‡å…±ç”¨
                const winRate = getWinRate(column.name, currentQueryIndex);
                let winRateValue = null;
                if (winRate) {
                    winRateValue = parseWinRate(winRate);
                }
                // å¤§å·ç™¾åˆ†æ¯”å·²ç§»é™¤ï¼Œä½¿ç”¨å³ä¾§çš„èƒœç‡æ•°å­—
                
                // å³ä¾§ï¼šèƒœç‡å’Œå­—æ•°
                const headerRight = document.createElement('div');
                headerRight.style.display = 'flex';
                headerRight.style.gap = '4px';
                headerRight.style.alignItems = 'center';
                headerRight.style.flexWrap = 'nowrap';
                headerRight.style.flexShrink = '0';
                
                // èƒœç‡å¾½æ ‡ - ä»èƒœç‡è¡¨è·å–
                // å³ä¾§ï¼šèƒœç‡æ•°å­—ï¼ˆæ— åº•è‰²ï¼‰
                if (winRateValue !== null) {
                    const winRateLabel = document.createElement('span');
                    winRateLabel.className = 'badge-label';
                    winRateLabel.textContent = 'èƒœç‡';
                    headerRight.appendChild(winRateLabel);
                    const winRateText = document.createElement('span');
                    winRateText.className = 'win-rate-large';
                    winRateText.textContent = (winRateValue.toFixed(2)) + '%';
                    // é¢œè‰²ç”±åé¢çš„æ¸å˜è‰²ä»£ç ç»Ÿä¸€è®¾ç½®
                    headerRight.appendChild(winRateText);
                }

// å­—æ•°å¾½æ ‡ - ä»å­—æ•°ç»Ÿè®¡è¡¨è·å–
                const charCount = getCharCount(column.name, currentQueryIndex) || 0;
                const countLabel = document.createElement('span');
                countLabel.className = 'badge-label';
                countLabel.textContent = 'å­—æ•°';
                headerRight.appendChild(countLabel);
                const countText = document.createElement('span');
                countText.className = 'metric-muted';
                countText.textContent = String(charCount);
                headerRight.appendChild(countText);

// æ”¶é›†èƒœç‡æ•°æ®
                if (winRateValue !== null) {
                    winRateValues.push(winRateValue);
                    winRateMap.set(column.name, winRateValue); // å­˜å…¥æ˜ å°„
                }
                
                // æ”¶é›†å­—æ•°æ•°æ®
                charCountBadges.push(countText);
                charCounts.push(charCount || 0);
                
                headerContent.appendChild(headerLeft);
                headerContent.appendChild(headerRight);
                
                // ç»„è£…æ ‡é¢˜å®¹å™¨
                headerContainer.appendChild(dragHandle);
                headerContainer.appendChild(headerContent);
                
                // æ£€æŸ¥å¹¶è°ƒæ•´æ¨¡å‹åç§°å­—ä½“å¤§å°ï¼Œé¿å…ä¸å³ä¾§å†…å®¹é‡å 
                requestAnimationFrame(() => {
                    try {
                        const headerRightRect = headerRight.getBoundingClientRect();
                        let headerLeftRect = headerLeft.getBoundingClientRect();
                        
                        // å¦‚æœå·¦ä¾§å’Œå³ä¾§é‡å ï¼Œç¼©å°æ¨¡å‹åç§°å­—ä½“
                        if (headerLeftRect.right > headerRightRect.left) {
                            let fontSize = 16; // åˆå§‹å­—ä½“å¤§å°
                            
                            // é€æ­¥ç¼©å°å­—ä½“ï¼Œç›´åˆ°ä¸é‡å 
                            while (headerLeftRect.right > headerRightRect.left && fontSize > 10) {
                                fontSize -= 0.5;
                                headerDiv.style.fontSize = fontSize + 'px';
                                // é‡æ–°è·å–ä½ç½®
                                headerLeftRect = headerLeft.getBoundingClientRect();
                                if (headerLeftRect.right <= headerRightRect.left) {
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error adjusting font size:', e);
                    }
                });
                
                // è¿›åº¦æ¡ï¼ˆæ ¹æ®èƒœç‡ç™¾åˆ†æ¯”ï¼‰- ä½œä¸ºåˆ†å‰²çº¿
                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-bar-container';
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                if (winRateValue !== null) {
                    progressBar.style.width = Math.max(winRateValue, 1) + '%'; // è‡³å°‘1%å®½åº¦
                    // é¢œè‰²ç”±åé¢çš„æ¸å˜è‰²ä»£ç ç»Ÿä¸€è®¾ç½®ï¼Œå…ˆè®¾ä¸ºé»˜è®¤è‰²
                    progressBar.style.background = '#e5e7eb';
                } else {
                    progressBar.style.width = '0%';
                    progressBar.style.background = '#e5e7eb';
                }
                progressContainer.appendChild(progressBar);
                headerContainer.appendChild(progressContainer);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'column-content';
                const content = currentRow[column.index] || '';
                contentDiv.innerHTML = renderMarkdown(content);
                
                // è°ƒæ•´å›¾ç‰‡æ»šåŠ¨å®¹å™¨çš„å®½åº¦ï¼ˆ1:1æ¯”ä¾‹ï¼Œå›ºå®š160pxï¼‰
                const adjustImageScrollContainers = () => {
                    const scrollContainers = contentDiv.querySelectorAll('.markdown-img-scroll-container');
                    scrollContainers.forEach(container => {
                        if (container.offsetWidth === 0) return; // å¦‚æœå®¹å™¨å®½åº¦ä¸º0ï¼Œè·³è¿‡
                        
                        // å›¾ç‰‡å›ºå®šä¸º160pxå®½åº¦å’Œé«˜åº¦ï¼ˆ1:1æ¯”ä¾‹ï¼‰
                        const itemWidth = 160;
                        
                        const items = container.querySelectorAll('.markdown-img-scroll-item');
                        items.forEach(item => {
                            item.style.width = `${itemWidth}px`;
                            item.style.minWidth = `${itemWidth}px`;
                            item.style.maxWidth = `${itemWidth}px`;
                        });
                    });
                };
                
                // ç«‹å³è°ƒæ•´ä¸€æ¬¡
                setTimeout(adjustImageScrollContainers, 0);
                
                // ç›‘å¬å›¾ç‰‡åŠ è½½å®Œæˆï¼Œé‡æ–°è°ƒæ•´
                const images = contentDiv.querySelectorAll('.markdown-img-scroll-item img');
                images.forEach(img => {
                    if (img.complete) {
                        adjustImageScrollContainers();
                    } else {
                        img.addEventListener('load', adjustImageScrollContainers, { once: true });
                        img.addEventListener('error', adjustImageScrollContainers, { once: true });
                    }
                });
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                const scrollContainers = contentDiv.querySelectorAll('.markdown-img-scroll-container');
                if (scrollContainers.length > 0) {
                    const resizeObserver = new ResizeObserver(() => {
                        adjustImageScrollContainers();
                    });
                    scrollContainers.forEach(container => {
                        resizeObserver.observe(container);
                    });
                }
                
                columnDiv.appendChild(headerContainer);
                columnDiv.appendChild(contentDiv);
                grid.appendChild(columnDiv);
            });
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
            setupDragAndDrop();

            // å­—æ•°ç°åœ¨æ˜¯ç°è‰²çº¯æ–‡æœ¬ï¼Œä¸éœ€è¦æ¸å˜è‰²
            // å­—æ•°æ¸å˜è‰²ä»£ç å·²ç§»é™¤
            
            // åº”ç”¨èƒœç‡æ¸å˜è‰²ï¼ˆæœ€ä½->ç»¿è‰²ï¼Œæœ€é«˜->çº¢è‰²ï¼‰- åªæ›´æ–°å¤§å·ç™¾åˆ†æ¯”é¢œè‰²
            if (winRateValues.length > 0) {
                const minRate = Math.min(...winRateValues);
                const maxRate = Math.max(...winRateValues);
                
                // æ›´æ–°æ¯ä¸ªæ¨¡å‹å³ä¾§çš„èƒœç‡æ•°å­—é¢œè‰²å’Œè¿›åº¦æ¡é¢œè‰²
                const columns = document.querySelectorAll('.comparison-column');
                columns.forEach((column) => {
                    // ä» dataset æˆ– header ä¸­è·å–æ¨¡å‹å
                    const columnIndex = parseInt(column.dataset.columnIndex);
                    if (columnIndex >= 0 && columnIndex < columnsToShow.length) {
                        const modelName = columnsToShow[columnIndex].name;
                        const rate = winRateMap.get(modelName);
                        
                        if (rate !== undefined) {
                            const color = getGradientColor(rate, minRate, maxRate);
                            // æ›´æ–°å³ä¾§çš„èƒœç‡æ•°å­—é¢œè‰²
                            const winRateText = column.querySelector('.column-header-container .win-rate-large');
                            if (winRateText) {
                                winRateText.style.color = color;
                            }
                            // æ›´æ–°è¿›åº¦æ¡é¢œè‰²
                            const progressBar = column.querySelector('.progress-bar');
                            if (progressBar) {
                                progressBar.style.background = color;
                            }
                        }
                    }
                });
            }
        }

        // è®¾ç½®æ‹–æ‹½æ’åºåŠŸèƒ½
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.comparison-column');
            let draggedElement = null;
            
            columns.forEach(column => {
                const dragHandle = column.querySelector('.drag-handle');
                if (!dragHandle) return;
                
                // æ‹–æ‹½æ‰‹æŸ„æŒ‰ä¸‹æ—¶ï¼Œä½¿æ•´ä¸ªåˆ—å¯æ‹–æ‹½
                dragHandle.addEventListener('mousedown', function(e) {
                    column.draggable = true;
                    dragHandle.style.cursor = 'grabbing';
                });
                
                // æ‹–æ‹½æ‰‹æŸ„é‡Šæ”¾æ—¶ï¼Œå–æ¶ˆåˆ—çš„å¯æ‹–æ‹½çŠ¶æ€
                dragHandle.addEventListener('mouseup', function(e) {
                    column.draggable = false;
                    dragHandle.style.cursor = 'grab';
                });
                
                // æ‹–æ‹½å¼€å§‹
                column.addEventListener('dragstart', function(e) {
                    // åªåœ¨é€šè¿‡æ‹–æ‹½æ‰‹æŸ„æ‹–æ‹½æ—¶æ‰å…è®¸
                    if (!column.draggable) {
                        e.preventDefault();
                        return;
                    }
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });
                
                // æ‹–æ‹½ç»“æŸ
                column.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    this.draggable = false;
                    if (dragHandle) {
                        dragHandle.style.cursor = 'grab';
                    }
                    // ç§»é™¤æ‰€æœ‰æ‹–æ‹½æ‚¬åœæ•ˆæœ
                    document.querySelectorAll('.comparison-column').forEach(col => {
                        col.classList.remove('drag-over');
                    });
                    draggedElement = null;
                });
                
                // æ‹–æ‹½è¿›å…¥
                column.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    if (this !== draggedElement) {
                        this.classList.add('drag-over');
                    }
                });
                
                // æ‹–æ‹½ç¦»å¼€
                column.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });
                
                // æ‹–æ‹½æ‚¬åœ
                column.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                // æ‹–æ‹½æ”¾ä¸‹
                column.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    if (draggedElement && this !== draggedElement) {
                        // è·å–æ‹–æ‹½å…ƒç´ çš„ç´¢å¼•å’Œç›®æ ‡å…ƒç´ çš„ç´¢å¼•
                        const draggedIndex = parseInt(draggedElement.dataset.columnIndex);
                        const targetIndex = parseInt(this.dataset.columnIndex);
                        
                        // é‡æ–°æ’åº selectedColumns æ•°ç»„
                        const draggedColumn = selectedColumns[draggedIndex];
                        selectedColumns.splice(draggedIndex, 1);
                        selectedColumns.splice(targetIndex, 0, draggedColumn);
                        
                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼
                        try {
                updateComparisonGrid();
            } catch (err) {
                console.error('Error in updateComparisonGrid:', err);
                alert('æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼æ—¶å‡ºé”™ï¼š' + (err.message || err));
            }
                    }
                });
            });
        }

        // Markdownæ¸²æŸ“å‡½æ•° - å¤ç”¨md_check.htmlçš„é€»è¾‘
        function renderMarkdown(md) {
            if (!md) return '';

            // 1. å¤„ç†ä»£ç å— - å®Œå…¨å¯¹é½ MarkdownRenderer.tsx
            md = md.replace(/```([^`\n]*)\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre style="display: block; background: #f3f4f6; padding: 16px; border-radius: 4px; margin: 16px 0; overflow-x: auto;"><code>${escapeHtml(code)}</code></pre>`;
            });

            // 2. å¤„ç†å›¾ç‰‡ - å®Œå…¨å¯¹é½ MarkdownRenderer.tsx
            md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
                return `<img class="markdown-img" alt="${alt}" src="${src}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div data-fallback="img" style="display: none;"><div style="font-size: 24px; margin-bottom: 10px;">ğŸ–¼ï¸</div><div style="color: #666; margin-bottom: 10px;">å›¾ç‰‡åŠ è½½å¤±è´¥</div><div style="font-size: 12px; color: #999; margin-bottom: 10px;">${alt || 'å›¾ç‰‡'}</div><a href="${src}" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none; font-size: 14px;">ğŸ”— ç‚¹å‡»æŸ¥çœ‹åŸå›¾</a></div>`;
            });

            // 3. å¤„ç†é“¾æ¥ï¼ˆå›¾ç‰‡åˆ†ç»„å°†åœ¨æœ€åç”¨ DOM åå¤„ç†ï¼‰

            // 4. å¤„ç†é“¾æ¥
            md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

            // 5. å¤„ç†ç²—ä½“ã€æ–œä½“ã€åˆ é™¤çº¿
            md = md.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                   .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                   .replace(/~~([^~]+)~~/g, '<del class="markdown-del">$1</del>');

            // 6. å¤„ç†æ ‡é¢˜ - å®Œå…¨å¯¹é½ MarkdownRenderer.tsx
            md = md.replace(/^#\s+(.*)$/gm, '<h1 class="markdown-h1">$1</h1>')
                   .replace(/^##\s+(.*)$/gm, '<h2 class="markdown-h2">$1</h2>')
                   .replace(/^###\s+(.*)$/gm, '<h3 class="markdown-h3">$1</h3>')
                   .replace(/^####\s+(.*)$/gm, '<h4 class="markdown-h4">$1</h4>')
                   .replace(/^#####\s+(.*)$/gm, '<h5 class="markdown-h5">$1</h5>')
                   .replace(/^######\s+(.*)$/gm, '<h6 class="markdown-h6">$1</h6>');

            // 7. å¤„ç†å¼•ç”¨
            md = md.replace(/^>\s?(.*)$/gm, '<blockquote class="markdown-blockquote">$1</blockquote>');

            // 8. å¤„ç†æ°´å¹³çº¿
            md = md.replace(/^---$/gm, '<hr class="markdown-hr">');

            // 9. å¤„ç†æ— åºåˆ—è¡¨ - æ”¯æŒåµŒå¥—ï¼Œå¯¹é½ MarkdownRenderer.tsx
            md = md.replace(/^(?:\s{0,3})[*+-]\s+.+(?:\n(?:\s{0,3})[*+-]\s+.+)*/gm, (match) => {
                const lines = match.split('\n');
                const result = [];
                let currentLevel = 0;
                let currentList = [];
                let listStack = [];

                for (const line of lines) {
                    const match = line.match(/^(\s*)([*+-])\s+(.+)$/);
                    if (match) {
                        const [, indent, bullet, content] = match;
                        const level = Math.floor(indent.length / 2);

                        if (level > currentLevel) {
                            if (currentList.length > 0) {
                                listStack.push(currentList);
                            }
                            currentList = [];
                            currentLevel = level;
                        } else if (level < currentLevel) {
                            if (currentList.length > 0) {
                                const nestedUl = `<ul class="markdown-ul">${currentList.join('')}</ul>`;
                                if (listStack.length > 0) {
                                    listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedUl}</li>`);
                                } else {
                                    result.push(nestedUl);
                                }
                            }
                            currentList = [];
                            currentLevel = level;
                        }

                        currentList.push(`<li class="markdown-li">${content}</li>`);
                    }
                }

                if (currentList.length > 0) {
                    const finalUl = `<ul class="markdown-ul">${currentList.join('')}</ul>`;
                    if (listStack.length > 0) {
                        listStack[listStack.length - 1].push(`<li class="markdown-li">${finalUl}</li>`);
                    } else {
                        result.push(finalUl);
                    }
                }

                while (listStack.length > 0) {
                    const nestedList = listStack.pop();
                    const nestedUl = `<ul class="markdown-ul">${nestedList.join('')}</ul>`;
                    if (listStack.length > 0) {
                        listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedUl}</li>`);
                    } else {
                        result.push(nestedUl);
                    }
                }

                return result.join('');
            });

            // 10. å¤„ç†æœ‰åºåˆ—è¡¨ - æ”¯æŒåµŒå¥—ï¼Œä¿ç•™åŸå§‹æ•°å­—ç¼–å·
            md = md.replace(/^(?:\s{0,3})\d+\.\s+.+(?:\n(?:\s{0,3})\d+\.\s+.+)*/gm, (match) => {
                const lines = match.split('\n');
                const result = [];
                let currentLevel = 0;
                let currentList = [];
                let listStack = [];

                for (const line of lines) {
                    const match = line.match(/^(\s*)(\d+)\.\s+(.+)$/);
                    if (match) {
                        const [, indent, number, content] = match;
                        const level = Math.floor(indent.length / 2);

                        if (level > currentLevel) {
                            if (currentList.length > 0) {
                                listStack.push(currentList);
                            }
                            currentList = [];
                            currentLevel = level;
                        } else if (level < currentLevel) {
                            if (currentList.length > 0) {
                                const nestedOl = `<ol class="markdown-ol">${currentList.join('')}</ol>`;
                                if (listStack.length > 0) {
                                    listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedOl}</li>`);
                                } else {
                                    result.push(nestedOl);
                                }
                            }
                            currentList = [];
                            currentLevel = level;
                        }

                        currentList.push(`<li class="markdown-li" value="${number}">${content}</li>`);
                    }
                }

                if (currentList.length > 0) {
                    const finalOl = `<ol class="markdown-ol">${currentList.join('')}</ol>`;
                    if (listStack.length > 0) {
                        listStack[listStack.length - 1].push(`<li class="markdown-li">${finalOl}</li>`);
                    } else {
                        result.push(finalOl);
                    }
                }

                while (listStack.length > 0) {
                    const nestedList = listStack.pop();
                    const nestedOl = `<ol class="markdown-ol">${nestedList.join('')}</ol>`;
                    if (listStack.length > 0) {
                        listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedOl}</li>`);
                    } else {
                        result.push(nestedOl);
                    }
                }

                return result.join('');
            });

            // 11. å¤„ç†è¡Œå†…ä»£ç 
            md = md.replace(/`([^`]+)`/g, '<code class="markdown-code">$1</code>');

            // 12. å¤„ç†è¡¨æ ¼ - å®Œå…¨å¯¹é½ MarkdownRenderer.tsx
            md = md.replace(/^(\|.+\|)\s*\n(\|[ :\-|]+\|)\s*\n((?:\|.*\|\s*\n?)*)/gm, (match, header, sep, body) => {
                if (!sep.match(/^[\s|]*[-:|\s]+[\s|]*$/)) return match;

                const toRow = line => line.trim().replace(/^\||\|$/g, '').split('|').map(s => s.trim());
                const headers = toRow(header);
                const rows = body.trim().split(/\n/).filter(Boolean).map(toRow);

                const alignRow = toRow(sep);
                const aligns = alignRow.map(align => {
                    if (align.startsWith(':') && align.endsWith(':')) return 'center';
                    if (align.endsWith(':')) return 'right';
                    if (align.startsWith(':')) return 'left';
                    return null;
                });

                const thead = `<thead class="markdown-table-thead"><tr>${headers.map((h, i) =>
                    `<th class="markdown-table-th"${aligns[i] ? ` style="text-align: ${aligns[i]}"` : ''}>${h}</th>`
                ).join('')}</tr></thead>`;

                const tbody = `<tbody>${rows.map(r =>
                    `<tr class="markdown-table-tr">${r.map((c, i) =>
                        `<td class="markdown-table-td"${aligns[i] ? ` style="text-align: ${aligns[i]}"` : ''}>${c}</td>`
                    ).join('')}</tr>`
                ).join('')}</tbody>`;

                return `<div class="markdown-table-wrapper" style="overflow-x: auto; margin: 16px 0; -webkit-overflow-scrolling: touch;"><table class="markdown-table">${thead}${tbody}</table></div>\n`;
            });

            // 13. å¤„ç†æ®µè½ - å®Œå…¨å¯¹é½ MarkdownRenderer.tsx
            md = md.split(/\n/).map(line => {
                const t = line.trimStart(); // å¿½ç•¥è¡Œé¦–ç©ºç™½
                if (/^<(h\d|ul|ol|pre|blockquote|img|table|hr|div|code)\b/.test(t)) return t;
                if (!t.trim()) return '';
                return `<p class="markdown-p">${t}</p>`;
            }).join('\n');
            
            // 14. DOM åå¤„ç†ï¼šæŠŠç›¸é‚»å›¾ç‰‡ï¼ˆå…è®¸ä¸­é—´è·Ÿç€ fallback divï¼‰åˆå¹¶æˆæ¨ªæ»‘å®¹å™¨
            const wrapper = document.createElement('div');
            wrapper.innerHTML = md;
            
            // å…ˆå¤„ç†ï¼šæŠŠåªå«å›¾ç‰‡ï¼ˆå’Œå¯é€‰ fallback divï¼‰çš„æ®µè½ <p> æ‹†æ‰ï¼ˆunwrapï¼‰
            (function unwrapImageParagraphs(root) {
                // é€’å½’å¤„ç†æ‰€æœ‰èŠ‚ç‚¹
                const processNode = (node) => {
                    // å…ˆé€’å½’å¤„ç†å­èŠ‚ç‚¹
                    const children = Array.from(node.children);
                    children.forEach(child => {
                        processNode(child);
                    });
                    
                    // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯æ®µè½
                    if (node.tagName === 'P' && node.parentNode) {
                        const p = node;
                        const pChildren = Array.from(p.childNodes);
                        let hasOnlyImages = true;
                        let imageNodes = [];
                        
                        for (let j = 0; j < pChildren.length; j++) {
                            const child = pChildren[j];
                            // æ£€æŸ¥å­èŠ‚ç‚¹æ˜¯å¦è¿˜åœ¨æ®µè½ä¸­
                            if (!child.parentNode || child.parentNode !== p) continue;
                            
                            if (child.nodeType === 1) { // Element node
                                if (child.tagName === 'IMG' && child.classList.contains('markdown-img')) {
                                    imageNodes.push(child);
                                    // æ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ fallback div
                                    if (j + 1 < pChildren.length) {
                                        const next = pChildren[j + 1];
                                        if (next && next.parentNode === p && next.nodeType === 1 && next.tagName === 'DIV' && 
                                            next.getAttribute('data-fallback') === 'img') {
                                            imageNodes.push(next);
                                            j++; // è·³è¿‡ fallback div
                                        }
                                    }
                                } else if (!(child.tagName === 'DIV' && child.getAttribute('data-fallback') === 'img')) {
                                    // æœ‰å…¶ä»–å…ƒç´ èŠ‚ç‚¹ï¼ˆä¸æ˜¯ fallback divï¼‰
                                    hasOnlyImages = false;
                                    break;
                                }
                            } else if (child.nodeType === 3 && child.textContent.trim()) {
                                // æœ‰éç©ºç™½æ–‡æœ¬èŠ‚ç‚¹
                                hasOnlyImages = false;
                                break;
                            }
                        }
                        
                        // å¦‚æœæ®µè½åªåŒ…å«å›¾ç‰‡ï¼Œå°±æ‹†æ‰æ®µè½æ ‡ç­¾
                        if (hasOnlyImages && imageNodes.length > 0) {
                            const parent = p.parentNode;
                            if (parent) {
                                imageNodes.forEach(n => {
                                    if (n.parentNode === p && p.parentNode === parent) {
                                        parent.insertBefore(n, p);
                                    }
                                });
                                if (p.parentNode === parent) {
                                    parent.removeChild(p);
                                }
                            }
                        } else {
                            // å¦‚æœæ®µè½åªåŒ…å« fallback(div[data-fallback="img"]) ä¹Ÿæ‹†æ‰
                            const nodes = Array.from(p.childNodes).filter(n => n.nodeType === 1 && n.parentNode === p);
                            const onlyFallback = nodes.length === 1 && 
                                nodes[0].tagName === 'DIV' && 
                                nodes[0].getAttribute('data-fallback') === 'img';
                            if (onlyFallback) {
                                const parent = p.parentNode;
                                if (parent && nodes[0].parentNode === p) {
                                    parent.insertBefore(nodes[0], p);
                                    if (p.parentNode === parent) {
                                        parent.removeChild(p);
                                    }
                                }
                            }
                        }
                    }
                };
                
                processNode(root);
            })(wrapper);
            
            // é€’å½’å¤„ç†æ‰€æœ‰èŠ‚ç‚¹ï¼ŒæŠŠç›¸é‚»å›¾ç‰‡åˆ†ç»„
            (function groupConsecutiveImages(root) {
                let nodes = Array.from(root.childNodes);
                let i = 0;
                
                while (i < nodes.length) {
                    let start = i;
                    let group = [];
                    
                    // æ”¶é›†ä¸€ä¸ªå›¾ç‰‡é¡¹ï¼šimg + å¯é€‰çš„ fallback div
                    function collectOneItem(idx) {
                        if (idx >= nodes.length) return null;
                        const img = nodes[idx];
                        if (!(img && img.nodeType === 1 && img.tagName === 'IMG' && img.classList.contains('markdown-img'))) {
                            return null;
                        }
                        const item = [img];
                        
                        // æ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ fallback div
                        if (idx + 1 < nodes.length) {
                            const maybeFallback = nodes[idx + 1];
                            if (maybeFallback && maybeFallback.nodeType === 1 && 
                                maybeFallback.tagName === 'DIV' && 
                                maybeFallback.getAttribute('data-fallback') === 'img') {
                                item.push(maybeFallback);
                            }
                        }
                        return item;
                    }
                    
                    // å°è¯•æ”¶é›†è¿ç»­çš„å¤šé¡¹
                    while (true) {
                        const item = collectOneItem(i);
                        if (!item) break;
                        
                        group.push(item);
                        i += item.length;
                        
                        // å…è®¸ä¸­é—´æœ‰çº¯ç©ºç™½æ–‡æœ¬èŠ‚ç‚¹
                        while (i < nodes.length && nodes[i].nodeType === 3 && !nodes[i].textContent.trim()) {
                            i++;
                        }
                        
                        // æ£€æŸ¥ä¸‹ä¸€é¡¹
                        const nextItem = collectOneItem(i);
                        if (!nextItem) break;
                    }
                    
                    if (group.length >= 2) {
                        // æ„é€ æ¨ªæ»‘å®¹å™¨
                        const sc = document.createElement('div');
                        sc.className = 'markdown-img-scroll-container';
                        const inner = document.createElement('div');
                        inner.className = 'markdown-img-scroll-container-inner';
                        sc.appendChild(inner);
                        
                        group.forEach(item => {
                            const slot = document.createElement('div');
                            slot.className = 'markdown-img-scroll-item';
                            
                            // ç§»å…¥ img å’Œå®ƒçš„ fallback
                            item.forEach(n => {
                                // å»æ‰å•å›¾æ ·å¼ marginï¼Œäº¤ç»™å®¹å™¨æ§åˆ¶
                                if (n.tagName === 'IMG') {
                                    n.classList.remove('markdown-img');
                                }
                                slot.appendChild(n);
                            });
                            
                            inner.appendChild(slot);
                        });
                        
                        // ç”¨å®¹å™¨æ›¿æ¢è¿™æ®µèŠ‚ç‚¹
                        let before = nodes[start];
                        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªä»åœ¨ root ä¸‹çš„å‚ç…§èŠ‚ç‚¹
                        while (before && before.parentNode !== root) {
                            start++;
                            if (start < nodes.length) {
                                before = nodes[start];
                            } else {
                                before = null;
                                break;
                            }
                        }
                        if (before && before.parentNode === root) {
                            root.insertBefore(sc, before);
                        } else {
                            root.appendChild(sc);
                        }
                        
                        // åˆ é™¤è¢«åˆ†ç»„çš„æ—§èŠ‚ç‚¹ï¼ˆåªåˆ è¿˜åœ¨ root ä¸‹çš„ï¼‰
                        group.flat().forEach(n => {
                            if (n.parentNode === root) {
                                root.removeChild(n);
                            }
                        });
                        
                        // é‡æ–°æŠ“å–èŠ‚ç‚¹åˆ—è¡¨å¹¶ç»§ç»­
                        nodes = Array.from(root.childNodes);
                        const scIndex = nodes.indexOf(sc);
                        i = scIndex + 1;
                    } else {
                        i++;
                    }
                }
                
                // é€’å½’å¤„ç†å­èŠ‚ç‚¹ï¼ˆå¤„ç†æ®µè½å†…çš„å›¾ç‰‡ï¼‰
                Array.from(root.children).forEach(child => {
                    if (child.tagName !== 'DIV' || !child.classList.contains('markdown-img-scroll-container')) {
                        groupConsecutiveImages(child);
                    }
                });
            })(wrapper);
            
            // è¿”å›æœ€ç»ˆ HTML
            return wrapper.innerHTML;
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
