<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MDæ£€æŸ¥</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- å¤‡ç”¨ï¼šCDN æ ‡è®°åº“ï¼Œå¦‚æœä¸å¯ç”¨åˆ™é™çº§åˆ°æœ¬åœ° renderMarkdown -->
<script>
  (function(){
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js';
    s.onload = function(){ console.log('marked loaded'); };
    s.onerror = function(){ console.warn('marked CDN load failed, using local renderer'); };
    document.head.appendChild(s);
  })();
</script>
    <style>
  :root{--bg:#f6f7fb;--card:#fff;--txt:#111;--muted:#6b7280;--brand:#2563eb;--ok:#10b981;--warn:#b91c1c}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;min-height:100vh;color:var(--txt);display:flex;flex-direction:column}
  .header{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:18px 18px 0;display:flex;justify-content:space-between;align-items:center}
  .header h1{margin:0;font-size:24px;color:var(--brand)}
  .header p{margin:8px 0 0;color:var(--muted);font-size:14px}
  .header-right{display:flex;align-items:center;gap:20px}
  .query-section{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:15px 18px;margin:0 18px;display:flex;flex-direction:column;gap:12px}
  .query-display{display:flex;align-items:center;gap:10px}
  .link-display{display:flex;align-items:center;gap:10px}
  .query-label{font-size:16px;color:var(--muted);font-weight:600}
  .query-text{font-size:16px;color:var(--txt);background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:8px 12px;flex:1;min-width:200px;font-weight:500}
  .copy-btn{background:var(--brand);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;transition:all 0.2s ease}
  .copy-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .navigation-buttons{display:flex;gap:10px;justify-content:center}
  .nav-btn{background:#f8f9fa;color:var(--txt);border:1px solid #e9ecef;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:14px;transition:all 0.2s ease;flex:1;min-width:80px}
  .nav-btn:hover{background:#e9ecef;transform:translateY(-1px)}
  .prev-btn{border-color:var(--brand);color:var(--brand)}
  .prev-btn:hover{background:var(--brand);color:#fff}
  .next-btn{border-color:var(--ok);color:var(--ok)}
  .next-btn:hover{background:var(--ok);color:#fff}
  .upload-section{display:flex;align-items:center;gap:15px}
  .upload-btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 20px;cursor:pointer;font-size:14px;transition:all 0.2s ease}
  .upload-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .file-info{background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--muted);width:200px;min-height:20px;transition:all 0.2s ease}
  .progress-section{display:flex;align-items:center;gap:15px;justify-content:flex-end}
  .progress-bar{width:180px;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--brand),var(--ok));width:0%;transition:width 0.3s ease;border-radius:4px}
  .progress-text{font-size:12px;color:var(--muted);min-width:70px;text-align:right}
  .container{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:18px;flex:1}
  .excel-display-section{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:0 18px;display:flex;flex-direction:column}
  .excel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e9ecef}
  .excel-header h3{margin:0;font-size:18px;color:var(--brand)}
  .excel-header-buttons{display:flex;align-items:center;gap:10px}
  .download-btn{background:var(--ok);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;transition:all 0.2s ease}
  .download-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .close-btn{background:none;border:none;font-size:24px;color:var(--muted);cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s ease}
  .close-btn:hover{background:#f8f9fa;color:var(--warn)}
  .excel-content{flex:1;overflow:auto;max-height:400px}
  .no-file-message{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--muted)}
  .no-file-icon{font-size:48px;margin-bottom:15px;opacity:0.6}
  .no-file-message p{margin:0 0 8px;font-size:18px;color:var(--txt)}
  .no-file-hint{font-size:14px;color:var(--muted)}
  .file-info-display{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center}
  .file-info-icon{font-size:48px;margin-bottom:15px;opacity:0.8}
  .file-info-display h4{margin:0 0 20px;font-size:20px;color:var(--brand)}
  .file-details{background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;min-width:300px}
  .file-details p{margin:0 0 10px;font-size:14px;color:var(--txt)}
  .file-details p:last-child{margin-bottom:0}
  .processing-note{background:#e3f2fd;border:1px solid #bbdefb;border-radius:8px;padding:15px;color:var(--brand)}
  .processing-note p{margin:0 0 5px;font-size:16px;font-weight:500}
  .processing-note span{font-size:14px;opacity:0.8}
  .error-message{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center;color:var(--warn)}
  .error-icon{font-size:48px;margin-bottom:15px}
  .error-message h4{margin:0 0 10px;font-size:18px;color:var(--warn)}
  .error-message p{margin:0;font-size:14px;color:var(--muted)}
  .empty-message{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center;color:var(--muted)}
  .empty-icon{font-size:48px;margin-bottom:15px;opacity:0.6}
  .empty-message h4{margin:0 0 10px;font-size:18px;color:var(--txt)}
  .empty-message p{margin:0;font-size:14px;color:var(--muted)}
  .excel-table{width:100%;border-collapse:collapse;font-size:14px}
  .excel-table th,.excel-table td{border:1px solid #e9ecef;padding:8px 12px;text-align:left;vertical-align:top}
  .excel-table th{background:#f8f9fa;font-weight:600;color:var(--txt)}
  .excel-table td{background:#fff}
  .excel-table tr:nth-child(even) td{background:#fafafa}
  .markdown-cell{max-width:400px;word-wrap:break-word}
  .markdown-cell p{margin:0 0 2px;line-height:1.2}
  .markdown-cell p:last-child{margin-bottom:0}
  .markdown-cell img{max-width:100%;height:auto;border-radius:4px;margin:4px 0}
  .markdown-cell a{color:var(--brand);text-decoration:none}
  .markdown-cell a:hover{text-decoration:underline}
  
  /* å¢å¼ºçš„Markdownæ¸²æŸ“æ ·å¼ */
  .markdown-h1{font-size:28px;font-weight:700;color:var(--txt);margin:24px 0 16px;line-height:1.3;border-bottom:2px solid var(--brand);padding-bottom:8px}
  .markdown-h2{font-size:24px;font-weight:600;color:var(--txt);margin:20px 0 12px;line-height:1.4}
  .markdown-h3{font-size:20px;font-weight:600;color:var(--brand);margin:16px 0 10px;line-height:1.4}
  .markdown-h4{font-size:18px;font-weight:600;color:var(--txt);margin:14px 0 8px;line-height:1.4}
  .markdown-h5{font-size:16px;font-weight:600;color:var(--txt);margin:12px 0 6px;line-height:1.4}
  .markdown-h6{font-size:14px;font-weight:600;color:var(--muted);margin:10px 0 4px;line-height:1.4}
  .markdown-p{margin:2px 0;line-height:1.2;color:var(--txt)}
  .markdown-ul,.markdown-ol{margin:8px 0;padding-left:32px}
  .markdown-li{margin:1px 0;line-height:1.1;color:var(--txt);padding-left:16px}
  .markdown-ul .markdown-li{list-style-type:disc}
  .markdown-ul .markdown-ul .markdown-li{list-style-type:circle}
  .markdown-ul .markdown-ul .markdown-ul .markdown-li{list-style-type:square}
  .markdown-ol .markdown-li{list-style-type:decimal}
  .markdown-blockquote{border-left:4px solid var(--brand);background:#f8f9fa;padding:12px 16px;margin:16px 0;border-radius:0 8px 8px 0;color:var(--muted);font-style:italic}
  .markdown-code{background:#f1f3f4;color:var(--warn);padding:2px 6px;border-radius:4px;font-family:ui-monospace,Menlo,monospace;font-size:0.9em}
  .markdown-table{border-collapse:collapse;width:100%;margin:10px 0;border:1px solid #ddd}
  .markdown-table th,.markdown-table td{border:1px solid #ddd;padding:6px 8px;text-align:left}
  .markdown-table th{background:#f8f9fa;font-weight:600}
  .markdown-hr{border:none;border-top:1px solid #ddd;margin:20px 0}
  .markdown-link{color:var(--brand);text-decoration:none;border-bottom:1px solid transparent;transition:border-color 0.2s}
  .markdown-link:hover{color:var(--brand);border-bottom-color:var(--brand)}
  .markdown-pre{background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:16px;margin:16px 0;overflow-x:auto;font-family:ui-monospace,Menlo,monospace;font-size:0.9em;line-height:1.5}
  .markdown-code-block{background:transparent;padding:0;border:none;color:var(--txt);white-space:pre-wrap}
  .markdown-blockquote{border-left:4px solid var(--brand);background:#f8f9fa;padding:12px 16px;margin:16px 0;border-radius:0 6px 6px 0;color:var(--muted);font-style:italic;position:relative}
  .markdown-blockquote::before{content:'"';font-size:2em;color:var(--brand);position:absolute;top:8px;left:8px;opacity:0.3}
  .preview .markdown-h1,.preview .markdown-h2,.preview .markdown-h3,.preview .markdown-h4,.preview .markdown-h5,.preview .markdown-h6,
  .preview .markdown-p,.preview .markdown-ul,.preview .markdown-ol,.preview .markdown-li,.preview .markdown-blockquote,.preview .markdown-code{color:inherit}
  .web-link{color:var(--brand);text-decoration:none;word-break:break-all}
  .web-link:hover{text-decoration:underline}
  .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .excel-table .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table td .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .excel-table td .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table tr:hover td{background:#f0f7ff}
  .footer{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:18px 18px 18px;text-align:center}
  .footer p{margin:0;color:var(--muted);font-size:12px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;min-height:0;overflow-y:auto}
  .panel.left-panel{height:calc(100vh - 236px)}
  .panel.right-panel{height:calc(100vh - 236px);display:flex;flex-direction:column;flex:1;min-height:200px}
  .panel.copy-panel{flex:1;min-height:200px}
  .panel.button-panel{flex:0 0 auto;height:auto;min-height:auto;padding:12px 14px}
  h3{margin:0 0 8px;font-size:16px;color:var(--brand)}
  .preview{flex:1;overflow:auto;border:1px dashed #e5e7eb;border-radius:10px;padding:14px;background:#fff;min-height:0;overflow-y:auto;display:flex;flex-direction:column;height:100%;white-space:normal}
  .preview img{max-width:100%;display:block;margin:10px 0;border-radius:8px}
  .right{display:flex;flex-direction:column;gap:8px;height:calc(100vh - 236px)}
  .copy-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;flex:6}
  .markdown-section{flex:4}
  textarea{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;font-family:ui-monospace,Menlo,monospace;resize:none;min-height:0;line-height:1.5}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .btn{border:none;border-radius:10px;padding:8px 14px;background:var(--brand);color:#fff;cursor:pointer}
  .btn:hover{filter:brightness(.96)}
  .btn-outline{background:#fff;color:#374151;border:1px solid #d1d5db}
  .btn-ok{background:var(--ok)}
  .grid-full{grid-column:1/3}
  .muted{color:var(--muted);font-size:12px}
  .error{display:none;margin-bottom:10px;padding:8px 12px;border-radius:10px;background:#FEF2F2;border:1px solid #FCA5A5;color:var(--warn)}
  .tag{font-size:12px;color:#111;background:#eef2ff;border:1px solid #e0e7ff;border-radius:8px;padding:3px 8px}
  
    </style>
</head>
<body>
    <div class="header">
        <h1>MDæ£€æŸ¥</h1>
        <div class="header-right">
            <div class="upload-section">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.xlsm,.csv" style="display:none" onchange="handleFileUpload(this)">
                <button class="upload-btn" onclick="document.getElementById('excelFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                <div id="fileInfo" class="file-info">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">ç­‰å¾…æ£€æŸ¥</div>
            </div>
        </div>
    </div>
    
    <div class="query-section">
        <div class="query-display">
            <span class="query-label">å½“å‰æ£€æŸ¥é¡¹ï¼š</span>
            <span id="currentQuery" class="query-text">æœªè®¾ç½®</span>
        </div>
        <div class="navigation-buttons">
            <button class="nav-btn next-btn" onclick="nextQuery()">ä¸‹ä¸€ä¸ª</button>
            <button class="nav-btn prev-btn" onclick="previousQuery()">ä¸Šä¸€ä¸ª</button>
        </div>
    </div>

    <div class="container">
        <div class="panel left-panel">
            <h3>ç­”æ¡ˆ MD æ¸²æŸ“</h3>
            <div id="errorBox" class="error"></div>
            <div id="renderedPreview" class="preview" style="flex:1;min-height:400px;"></div>
        </div>

        <div class="panel right-panel">
            <div class="row">
                <h3 style="flex:1">MDå†…å®¹è¾“å…¥</h3>
                <button class="btn btn-outline" onclick="clearLeft()">æ¸…ç©º</button>
            </div>
            <textarea id="leftMarkdown" placeholder="ä»è¡¨æ ¼è‡ªåŠ¨è·å–å½“å‰queryçš„answerâ€¦"></textarea>
            <div class="muted" style="margin-top:6px">è‡ªåŠ¨ä»è¡¨æ ¼è·å–å½“å‰queryçš„answerå†…å®¹ã€‚</div>
        </div>
    </div>
    
            
        </div>
    </div>
    
    <div class="excel-display-section" id="excelDisplaySection">
        <div class="excel-header">
            <h3>Excel å†…å®¹å±•ç¤º</h3>
            <div class="excel-header-buttons">
                <button class="download-btn" onclick="downloadExcel()" id="downloadBtn" style="display:none">ä¸‹è½½Excel</button>
                <button class="close-btn" onclick="closeExcelDisplay()">Ã—</button>
            </div>
        </div>
        <div class="excel-content" id="excelContent">
            <div class="no-file-message">
                <div class="no-file-icon">ğŸ“„</div>
                <p>æœªä¸Šä¼ æ–‡æ¡£</p>
                <span class="no-file-hint">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œä¸Šä¼ </span>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Â© 2025 MDæ£€æŸ¥ Â· æ™ºèƒ½Markdownå†…å®¹æ£€æŸ¥å·¥å…·</p>
    </div>

    <script>
/* ---------- Markdown é¢„è§ˆï¼ˆç®€å•æ¸²æŸ“ï¼‰ ---------- */
function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function renderMarkdown(md){
  if(!md) return '';
  
  // å¤„ç†ä»£ç å—
  md = md.replace(/```([^`\n]*)\n([\s\S]*?)```/g,(m,lang,code)=>'<pre><code>'+escapeHtml(code)+'</code></pre>');
  
  // å¤„ç†å›¾ç‰‡ - å…ˆå°è¯•æ­£å¸¸æ¸²æŸ“ï¼Œå¤±è´¥æ—¶æ˜¾ç¤ºå ä½ç¬¦
  md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
    console.log('Processing image:', {match, alt, src});
    
    // ä¸ºæ‰€æœ‰å›¾ç‰‡æ·»åŠ é”™è¯¯å¤„ç†ï¼Œä¸é¢„å…ˆåˆ¤æ–­åŸŸå
    return `<img alt="${alt}" src="${src}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <div style="display: none; border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; margin: 10px 0;">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ–¼ï¸</div>
        <div style="color: #666; margin-bottom: 10px;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
        <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${alt || 'å›¾ç‰‡'}</div>
        <a href="${src}" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none; font-size: 14px;">
          ğŸ”— ç‚¹å‡»æŸ¥çœ‹åŸå›¾
        </a>
      </div>`;
  });
  
  // å¤„ç†é“¾æ¥
  md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  
  // å¤„ç†ç²—ä½“å’Œæ–œä½“
  md = md.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\*([^*]+)\*/g,'<em>$1</em>');
  
  // å¤„ç†æ ‡é¢˜ - å¢å¼ºæ ·å¼
  md = md.replace(/^######\s+(.*)$/gm,'<h6 class="markdown-h6">$1</h6>')
         .replace(/^#####\s+(.*)$/gm,'<h5 class="markdown-h5">$1</h5>')
         .replace(/^####\s+(.*)$/gm,'<h4 class="markdown-h4">$1</h4>')
         .replace(/^###\s+(.*)$/gm,'<h3 class="markdown-h3">$1</h3>')
         .replace(/^##\s+(.*)$/gm,'<h2 class="markdown-h2">$1</h2>')
         .replace(/^#\s+(.*)$/gm,'<h1 class="markdown-h1">$1</h1>');
  
  // å¤„ç†å¼•ç”¨
  md = md.replace(/^\>\s?(.*)$/gm,'<blockquote class="markdown-blockquote">$1</blockquote>');
  
  // å¤„ç†æ°´å¹³çº¿
  md = md.replace(/^---$/gm,'<hr class="markdown-hr">');
  
  // å¤„ç†æ— åºåˆ—è¡¨ - æ”¯æŒåµŒå¥—
  md = md.replace(/^(?:\s*[-*+]\s+.+(?:\n(?:\s{2,}[-*+]\s+.+)*)*)/gm, block => {
    const lines = block.trim().split(/\n/);
    const result = [];
    let currentLevel = 0;
    let currentList = [];
    let listStack = []; // ç”¨äºè·Ÿè¸ªåµŒå¥—çš„åˆ—è¡¨å±‚çº§
    
    for (const line of lines) {
      const match = line.match(/^(\s*)([-*+])\s+(.+)$/);
      if (match) {
        const [, indent, bullet, content] = match;
        const level = Math.floor(indent.length / 2);
        
        if (level > currentLevel) {
          // å¼€å§‹æ–°çš„åµŒå¥—åˆ—è¡¨
          if (currentList.length > 0) {
            listStack.push(currentList);
          }
          currentList = [];
          currentLevel = level;
        } else if (level < currentLevel) {
          // ç»“æŸå½“å‰åµŒå¥—åˆ—è¡¨
          if (currentList.length > 0) {
            const nestedUl = `<ul class="markdown-ul">${currentList.join('')}</ul>`;
            if (listStack.length > 0) {
              listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedUl}</li>`);
            } else {
              result.push(nestedUl);
            }
          }
          currentList = [];
          currentLevel = level;
        }
        
        currentList.push(`<li class="markdown-li">${content}</li>`);
      }
    }
    
    // å¤„ç†å‰©ä½™çš„åˆ—è¡¨é¡¹
    if (currentList.length > 0) {
      const finalUl = `<ul class="markdown-ul">${currentList.join('')}</ul>`;
      if (listStack.length > 0) {
        listStack[listStack.length - 1].push(`<li class="markdown-li">${finalUl}</li>`);
      } else {
        result.push(finalUl);
      }
    }
    
    // å¤„ç†æ‰€æœ‰åµŒå¥—çš„åˆ—è¡¨
    while (listStack.length > 0) {
      const nestedList = listStack.pop();
      const nestedUl = `<ul class="markdown-ul">${nestedList.join('')}</ul>`;
      if (listStack.length > 0) {
        listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedUl}</li>`);
      } else {
        result.push(nestedUl);
      }
    }
    
    return result.join('');
  });
  
  // å¤„ç†æœ‰åºåˆ—è¡¨ - ä¿ç•™åŸå§‹åºå·
  md = md.replace(/^(?:\s*\d+\.\s+.+\n?)+/gm, block=>{
    const items = block.trim().split(/\n/).map(l=>{
      const match = l.match(/^\s*(\d+)\.\s+(.+)$/);
      if (match) {
        const [, number, content] = match;
        return `<li class="markdown-li" value="${number}">${content}</li>`;
      }
      return '';
    }).filter(item => item.length > 0);
    return '<ol class="markdown-ol">' + items.join('') + '</ol>';
  });
  
  // å¤„ç†è¡Œå†…ä»£ç 
  md = md.replace(/`([^`]+)`/g,'<code class="markdown-code">$1</code>');
  
  // å¤„ç†è¡¨æ ¼ - ç²¾ç¡®åŒ¹é…ï¼Œä¸å½±å“åç»­æ®µè½
  md = md.replace(/^(\|.+\|)\s*\n(\|[ :\-|]+\|)\s*\n((?:\|.*\|\s*\n?)*)/gm, (match, header, sep, body) => {
    // ç¡®ä¿åˆ†éš”è¡ŒåŒ…å«è¶³å¤Ÿçš„è¿å­—ç¬¦
    if (!sep.match(/^[\s|]*[-:|\s]+[\s|]*$/)) {
      return match; // ä¸æ˜¯æœ‰æ•ˆçš„è¡¨æ ¼åˆ†éš”è¡Œï¼Œè¿”å›åŸæ–‡æœ¬
    }
    
    const toRow = line => line.trim().replace(/^\||\|$/g, '').split('|').map(s => s.trim());
    
    const headers = toRow(header);
    const rows = body.trim().split(/\n/).filter(Boolean).map(toRow);
    
    const thead = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
    
    return `<table class="markdown-table">${thead}${tbody}</table>\n`;
  });
  
  // å¤„ç†æ®µè½
  return md.split(/\n/).map(l=>{
    if(/^<h\d|^<ul>|^<ol>|^<pre>|^<blockquote>|^<img|^<table|^<hr/.test(l)) return l;
    if(!l.trim()) return '';
    return '<p class="markdown-p">'+l+'</p>';
  }).join('\n');
}

/* ---------- è¡¨æ ¼æ•°æ®ç®¡ç† ---------- */
let currentQueryIndex = 0;
let extractedData = []; // å­˜å‚¨ä»Excelæå–çš„queryå’Œansweræ•°æ®

// Markdownæ ¼å¼æ£€æµ‹å‡½æ•°
function isMarkdownFormat(text) {
    if (!text || typeof text !== 'string') return false;
    // æ£€æŸ¥æ˜¯å¦åŒ…å«markdownæ ¼å¼çš„é“¾æ¥ [text](url)
    return /\[.*?\]\(.*?\)/.test(text) || text.includes('![') || text.includes('](') || 
           /^#{1,6}\s+/.test(text) || /\*\*.*?\*\*/.test(text) || /\*.*?\*/.test(text) ||
           /^[-*+]\s+/.test(text) || /^\d+\.\s+/.test(text) || /`.*?`/.test(text);
}

function extractDataFromExcel(excelData) {
    extractedData = [];
    
    if (!excelData || excelData.length === 0) {
        updateQueryDisplay();
        return;
    }
    
    console.log('å¼€å§‹æå–Excelæ•°æ®ï¼Œæ€»è¡Œæ•°:', excelData.length);
    
    // éå†æ‰€æœ‰è¡Œï¼ŒæŸ¥æ‰¾æ•°æ®
    for (let i = 1; i < excelData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
        const row = excelData[i];
        if (row && row.length > 3) {
            const queryCode = row[0] || '';
            const query = row[1] || `æŸ¥è¯¢ ${extractedData.length + 1}`;
            const answer = row[3] || ''; // ç¬¬å››åˆ—ï¼ˆç´¢å¼•3ï¼‰
            
            if (queryCode && query && answer) {
                console.log('æå–åˆ°æ•°æ®:', { queryCode, query, answer });
                
                extractedData.push({
                    queryCode: queryCode,
                    query: query,
                    answer: answer,
                    rowNumber: i
                });
            }
        }
    }
    
    console.log('æœ€ç»ˆæå–çš„æ•°æ®:', extractedData);
    
    // é€‰æ‹©ç¬¬ä¸€ä¸ªquery
    currentQueryIndex = 0;
    updateQueryDisplay();
    updateMergedMarkdownForCurrentQuery();
}

function updateQueryDisplay() {
    console.log('updateQueryDisplay called');
    const queryText = document.getElementById('currentQuery');
    const linkText = document.getElementById('currentLink');
    
    if (extractedData.length === 0) {
        console.log('No extracted data, clearing display');
        if (queryText) queryText.textContent = 'æœªè®¾ç½®';
        if (linkText) linkText.textContent = 'æœªè®¾ç½®';
    } else if (currentQueryIndex >= 0 && currentQueryIndex < extractedData.length) {
        const queryCode = extractedData[currentQueryIndex].queryCode;
        const query = extractedData[currentQueryIndex].query;
        const answer = extractedData[currentQueryIndex].answer;
        
        if (queryText) {
            queryText.textContent = `${queryCode} ${query}`;
        }
        
        if (linkText) {
            linkText.textContent = answer.substring(0, 100) + (answer.length > 100 ? '...' : '');
        }
    } else {
        if (queryText) queryText.textContent = 'æœªè®¾ç½®';
        if (linkText) linkText.textContent = 'æœªè®¾ç½®';
    }
}

function updateMergedMarkdownForCurrentQuery() {
    if (currentQueryIndex < 0 || currentQueryIndex >= extractedData.length) {
        console.log('updateMergedMarkdownForCurrentQuery - invalid index:', currentQueryIndex);
        return;
    }
    
    const currentData = extractedData[currentQueryIndex];
    if (!currentData) {
        console.log('updateMergedMarkdownForCurrentQuery - no data at index:', currentQueryIndex);
        return;
    }
    
    // æ›´æ–°MDå†…å®¹è¾“å…¥
    const leftMarkdown = document.getElementById('leftMarkdown');
    if (leftMarkdown) {
        leftMarkdown.value = currentData.answer;
    }
    
    // æ‰§è¡Œæ£€æŸ¥
    if (typeof mergeNow === 'function') {
        mergeNow();
    }
}

function switchToQuery(dataIndex) {
    console.log('switchToQuery called with dataIndex:', dataIndex);
    
    if (dataIndex < 0 || dataIndex >= extractedData.length) {
        console.log('Invalid dataIndex:', dataIndex);
        showMessage('æ— æ•ˆçš„queryç´¢å¼•', 'warn');
        return;
    }
    
    // æ›´æ–°å½“å‰queryç´¢å¼•
    currentQueryIndex = dataIndex;
    console.log('Updated currentQueryIndex to:', currentQueryIndex);
    
    // æ›´æ–°queryæ˜¾ç¤º
    updateQueryDisplay();
    
    // æ›´æ–°MDå†…å®¹
    updateMergedMarkdownForCurrentQuery();
    
    const cd = extractedData[currentQueryIndex];
    if (cd) {
        showMessage(`å·²åˆ‡æ¢åˆ°query: ${cd.queryCode} ${cd.query}`, 'success');
    }
}

function nextQuery() {
    if (extractedData.length === 0) {
        showMessage('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'warn');
        return;
    }
    
    if (currentQueryIndex < extractedData.length - 1) {
        currentQueryIndex++;
        updateQueryDisplay();
        updateMergedMarkdownForCurrentQuery();
        showMessage(`åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªquery: ${extractedData[currentQueryIndex].queryCode}`, 'info');
    } else {
        showMessage('å·²ç»æ˜¯æœ€åä¸€ä¸ªquery', 'info');
    }
}

function previousQuery() {
    if (extractedData.length === 0) {
        showMessage('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'warn');
        return;
    }
    
    if (currentQueryIndex > 0) {
        currentQueryIndex--;
        updateQueryDisplay();
        updateMergedMarkdownForCurrentQuery();
        showMessage(`åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªquery: ${extractedData[currentQueryIndex].queryCode}`, 'info');
    } else {
        showMessage('å·²ç»æ˜¯ç¬¬ä¸€ä¸ªquery', 'info');
    }
}


/* ---------- å·²åˆ é™¤MDæ£€æŸ¥åŠŸèƒ½ ---------- */
function checkMarkdown(mdContent) {
    const checks = [];
    
    // æ£€æŸ¥markdownæ ¼å¼éœ²å‡º
    const markdownSymbols = mdContent.match(/\*\*[^*]+\*\*|\*[^*]+\*|`[^`]+`|#{1,6}\s+|^\s*[-*+]\s+|^\s*\d+\.\s+|^\s*>\s+/gm) || [];
    const unrenderedSymbols = [];
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¸²æŸ“çš„markdownç¬¦å·
    if (mdContent.includes('**') && !mdContent.includes('<strong>')) {
        unrenderedSymbols.push('ç²—ä½“ç¬¦å· **');
    }
    if (mdContent.includes('*') && !mdContent.includes('<em>') && !mdContent.includes('<strong>')) {
        unrenderedSymbols.push('æ–œä½“ç¬¦å· *');
    }
    if (mdContent.includes('`') && !mdContent.includes('<code>')) {
        unrenderedSymbols.push('ä»£ç ç¬¦å· `');
    }
    if (mdContent.includes('###') && !mdContent.includes('<h3>')) {
        unrenderedSymbols.push('æ ‡é¢˜ç¬¦å· ###');
    }
    if (mdContent.includes('---') && !mdContent.includes('<hr')) {
        unrenderedSymbols.push('åˆ†å‰²çº¿ç¬¦å· ---');
    }
    if (mdContent.includes('|') && !mdContent.includes('<table')) {
        unrenderedSymbols.push('è¡¨æ ¼ç¬¦å· |');
    }
    
    if (unrenderedSymbols.length > 0) {
        checks.push({
            type: 'fail',
            icon: 'âš ï¸',
            text: `å‘ç°æœªæ¸²æŸ“çš„markdownæ ¼å¼: ${unrenderedSymbols.join(', ')}`,
            status: 'å¤±è´¥'
        });
    } else {
        checks.push({
            type: 'pass',
            icon: 'âœ…',
            text: 'æœªå‘ç°markdownæ ¼å¼éœ²å‡º',
            status: 'é€šè¿‡'
        });
    }
    
    // æ£€æŸ¥æ ‡é¢˜ç»“æ„
    const headings = mdContent.match(/^#{1,6}\s+.+$/gm) || [];
    if (headings.length > 0) {
        checks.push({
            type: 'pass',
            icon: 'âœ…',
            text: `å‘ç° ${headings.length} ä¸ªæ ‡é¢˜`,
            status: 'é€šè¿‡'
        });
    } else {
        checks.push({
            type: 'fail',
            icon: 'âŒ',
            text: 'æœªå‘ç°ä»»ä½•æ ‡é¢˜',
            status: 'å¤±è´¥'
        });
    }
    
    // æ£€æŸ¥å›¾ç‰‡
    const images = mdContent.match(/!\[([^\]]*)\]\(([^)]+)\)/g) || [];
    if (images.length > 0) {
        checks.push({
            type: 'pass',
            icon: 'âœ…',
            text: `å‘ç° ${images.length} å¼ å›¾ç‰‡`,
            status: 'é€šè¿‡'
        });
    } else {
        checks.push({
            type: 'fail',
            icon: 'âŒ',
            text: 'æœªå‘ç°ä»»ä½•å›¾ç‰‡',
            status: 'å¤±è´¥'
        });
    }
    
    // æ£€æŸ¥é“¾æ¥
    const links = mdContent.match(/\[([^\]]+)\]\(([^)]+)\)/g) || [];
    if (links.length > 0) {
        checks.push({
            type: 'pass',
            icon: 'âœ…',
            text: `å‘ç° ${links.length} ä¸ªé“¾æ¥`,
            status: 'é€šè¿‡'
        });
    } else {
        checks.push({
            type: 'fail',
            icon: 'âŒ',
            text: 'æœªå‘ç°ä»»ä½•é“¾æ¥',
            status: 'å¤±è´¥'
        });
    }
    
    // æ£€æŸ¥ä»£ç å—
    const codeBlocks = mdContent.match(/```[\s\S]*?```/g) || [];
    if (codeBlocks.length > 0) {
        checks.push({
            type: 'pass',
            icon: 'âœ…',
            text: `å‘ç° ${codeBlocks.length} ä¸ªä»£ç å—`,
            status: 'é€šè¿‡'
        });
    } else {
        checks.push({
            type: 'fail',
            icon: 'âŒ',
            text: 'æœªå‘ç°ä»»ä½•ä»£ç å—',
            status: 'å¤±è´¥'
        });
    }
    
    // æ£€æŸ¥åˆ—è¡¨
    const lists = mdContent.match(/^[\s]*[-*+]\s+.+$/gm) || [];
    if (lists.length > 0) {
        checks.push({
            type: 'pass',
            icon: 'âœ…',
            text: `å‘ç° ${lists.length} ä¸ªåˆ—è¡¨é¡¹`,
            status: 'é€šè¿‡'
        });
    } else {
        checks.push({
            type: 'fail',
            icon: 'âŒ',
            text: 'æœªå‘ç°ä»»ä½•åˆ—è¡¨',
            status: 'å¤±è´¥'
        });
    }
    
    return checks;
}

function generateCheckResult(checks) {
    let result = '# MDæ£€æŸ¥ç»“æœ\n\n';
    
    checks.forEach(check => {
        result += `## ${check.icon} ${check.text}\n`;
        result += `**çŠ¶æ€**: ${check.status}\n\n`;
    });
    
    const passCount = checks.filter(c => c.type === 'pass').length;
    const totalCount = checks.length;
    
    result += `## ğŸ“Š æ£€æŸ¥æ€»ç»“\n`;
    result += `- é€šè¿‡: ${passCount}/${totalCount}\n`;
    result += `- æˆåŠŸç‡: ${Math.round((passCount/totalCount)*100)}%\n\n`;
    
    return result;
}

function renderCheckResult(checks) {
    let html = '<div class="check-result">';
    html += '<h3>ğŸ“‹ æ£€æŸ¥ç»“æœ</h3>';
    
    checks.forEach(check => {
        html += `
            <div class="check-item ${check.type}">
                <span class="check-icon">${check.icon}</span>
                <span class="check-text">${check.text}</span>
                <span class="check-status ${check.type}">${check.status}</span>
            </div>
        `;
    });
    
    const passCount = checks.filter(c => c.type === 'pass').length;
    const totalCount = checks.length;
    
    html += `
        <div class="check-item">
            <span class="check-icon">ğŸ“Š</span>
            <span class="check-text">æ€»è®¡: ${passCount}/${totalCount} é€šè¿‡</span>
            <span class="check-status">${Math.round((passCount/totalCount)*100)}%</span>
        </div>
    `;
    
    html += '</div>';
    return html;
}

/* ---------- åŸºç¡€å·¥å…· ---------- */
function sanitize(s){return (s||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');}

/* ---------- äº¤äº’ ---------- */
function showError(msg){ const b=document.getElementById('errorBox'); b.textContent=msg||''; b.style.display=msg?'block':'none'; }
function clearLeft(){ document.getElementById('leftMarkdown').value=''; mergeNow(); }

function performCheck() {
    const mdContent = document.getElementById('leftMarkdown').value;
    if (!mdContent.trim()) {
        showMessage('è¯·å…ˆè¾“å…¥MDå†…å®¹', 'warn');
        return;
    }
    
    const checks = checkMarkdown(mdContent);
    const resultHtml = renderCheckResult(checks);
    
    document.getElementById('checkResultDisplay').innerHTML = resultHtml;
    document.getElementById('checkResultPanel').style.display = 'block';
    
    showMessage('æ£€æŸ¥å®Œæˆ', 'success');
}

function copyCheckResult() {
    const resultDisplay = document.getElementById('checkResultDisplay');
    if (!resultDisplay || !resultDisplay.innerHTML.trim()) {
        showMessage('æ²¡æœ‰å¯å¤åˆ¶çš„æ£€æŸ¥ç»“æœ', 'warn');
        return;
    }
    
    // è·å–æ£€æŸ¥ç»“æœæ–‡æœ¬
    const mdContent = document.getElementById('leftMarkdown').value;
    const checks = checkMarkdown(mdContent);
    const resultText = generateCheckResult(checks);
    
    navigator.clipboard.writeText(resultText).then(() => {
        showMessage('æ£€æŸ¥ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'warn');
    });
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    let backgroundColor = 'var(--brand)';
    
    if (type === 'warn') {
        backgroundColor = 'var(--warn)';
    } else if (type === 'success') {
        backgroundColor = 'var(--ok)';
    }
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${backgroundColor};
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

function mergeNow(){
  try{
    const left  = sanitize(document.getElementById('leftMarkdown').value||'');

    console.log('mergeNow called with left:', left.substring(0, 100) + '...');

    if(!left.trim()){
      document.getElementById('renderedPreview').innerHTML='';
      showError('');
      return;
    }

    // æ¸²æŸ“MDå†…å®¹åˆ°é¢„è§ˆåŒºåŸŸ
    const renderedContent = renderMarkdown(left);
    console.log('Rendered content:', renderedContent.substring(0, 200) + '...');
    document.getElementById('renderedPreview').innerHTML = renderedContent;
    showError('');
  }catch(e){
    console.error('Error in mergeNow:', e);
    showError('æ£€æŸ¥å‡ºé”™ï¼š' + e.message);
  }
}

// æ–‡ä»¶ä¸Šä¼ ç›¸å…³å‡½æ•°
function handleFileUpload(input) {
    const file = input.files[0];
    const fileInfo = document.getElementById('fileInfo');
    
    if (file) {
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        fileInfo.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        fileInfo.style.color = 'var(--ok)';
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå¯è§£æçš„è¡¨æ ¼æ–‡ä»¶
        const lower = file.name.toLowerCase();
        if (/(\.xlsx|\.xls|\.xlsm|\.csv)$/.test(lower)) {
            // å¤„ç†Excelæ–‡ä»¶
            processExcelFile(file);
        } else {
            showMessage('è¯·é€‰æ‹©è¡¨æ ¼æ–‡ä»¶ (.xlsx/.xls/.xlsm/.csv)', 'warn');
            fileInfo.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            fileInfo.style.color = 'var(--muted)';
        }
    } else {
        fileInfo.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
        fileInfo.style.color = 'var(--muted)';
    }
}

function processExcelFile(file) {
    console.log('å¤„ç†Excelæ–‡ä»¶:', file.name);
    setTimeout(() => {
        console.log('æ˜¾ç¤ºExcelæ–‡ä»¶ä¿¡æ¯');
        displayExcelFileInfo(file);
    }, 1000);
}

function displayExcelFileInfo(file) {
    const excelDisplaySection = document.getElementById('excelDisplaySection');
    const excelContent = document.getElementById('excelContent');
    const closeBtn = document.querySelector('.close-btn');
    
    // è§£æExcelæ–‡ä»¶å¹¶æ˜¾ç¤ºå†…å®¹
    parseExcelFile(file, excelContent, closeBtn, excelDisplaySection);
}

function parseExcelFile(file, excelContent, closeBtn, excelDisplaySection) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', dense: true, cellDates: true });
            
            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // è½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œä¿ç•™ç©ºå•å…ƒæ ¼
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            
            // æ˜¾ç¤ºè¡¨æ ¼å†…å®¹
            displayExcelTable(jsonData, excelContent, closeBtn, excelDisplaySection);
            
        } catch (error) {
            console.error('Excelè§£æé”™è¯¯:', error);
            excelContent.innerHTML = `
                <div class="error-message">
                    <div class="error-icon">âŒ</div>
                    <h4>æ–‡ä»¶è§£æå¤±è´¥</h4>
                    <p>æ— æ³•è§£æè¡¨æ ¼æ–‡ä»¶ï¼Œè¯·ç¡®è®¤ï¼š1) æ–‡ä»¶æœªæŸåï¼›2) ä½¿ç”¨ .xlsx/.xls/.xlsm/.csvï¼›3) éå—ä¿æŠ¤å¯†ç æ–‡ä»¶ã€‚</p>
                </div>
            `;
            closeBtn.style.display = 'flex';
        }
    };
    
    reader.onerror = function() {
        excelContent.innerHTML = `
            <div class="error-message">
                <div class="error-icon">âŒ</div>
                <h4>æ–‡ä»¶è¯»å–å¤±è´¥</h4>
                <p>æ— æ³•è¯»å–æ–‡ä»¶ï¼Œè¯·é‡è¯•</p>
            </div>
        `;
        closeBtn.style.display = 'flex';
    };
    
    reader.readAsArrayBuffer(file);
}

function displayExcelTable(data, excelContent, closeBtn, excelDisplaySection) {
    if (!data || data.length === 0) {
        excelContent.innerHTML = `
            <div class="empty-message">
                <div class="empty-icon">ğŸ“‹</div>
                <h4>è¡¨æ ¼ä¸ºç©º</h4>
                <p>Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®</p>
            </div>
        `;
        closeBtn.style.display = 'flex';
        return;
    }
    
    // ç”Ÿæˆè¡¨æ ¼HTML
    let tableHTML = '<table class="excel-table">';
    
    // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
    data.forEach((row, rowIndex) => {
        if (rowIndex === 0) {
            // ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
            tableHTML += '<thead><tr>';
            row.forEach(cell => {
                const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
                tableHTML += `<th>${cellValue}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
        } else {
            // æ•°æ®è¡Œ
            tableHTML += '<tr>';
            row.forEach((cell, cellIndex) => {
                const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
                
                // ç¬¬ä¸€åˆ—ï¼ˆç´¢å¼•ä¸º0ï¼‰ç‰¹æ®Šå¤„ç†ï¼šqueryç¼–ç å¯ç‚¹å‡»
                if (cellIndex === 0) {
                    // æŸ¥æ‰¾å¯¹åº”çš„extractedDataç´¢å¼•ï¼Œä½¿ç”¨queryCodeåŒ¹é…
                    const dataIndex = extractedData.findIndex(item => item.queryCode === cellValue);
                    if (dataIndex !== -1) {
                        tableHTML += `<td><span class="clickable-query-code" onclick="switchToQuery(${dataIndex});">${cellValue}</span></td>`;
                    } else {
                        tableHTML += `<td>${cellValue}</td>`;
                    }
                } else if (cellIndex === 3) {
                    // ç¬¬å››åˆ—ï¼ˆç´¢å¼•ä¸º3ï¼‰ç‰¹æ®Šå¤„ç†ï¼šæ”¯æŒMarkdownæ¸²æŸ“
                    if (isMarkdownFormat(cellValue)) {
                        // å¦‚æœæ˜¯Markdownæ ¼å¼ï¼Œè¿›è¡Œæ¸²æŸ“
                        const renderedContent = renderMarkdown(cellValue);
                        tableHTML += `<td class="markdown-cell">${renderedContent}</td>`;
                    } else {
                        // æ™®é€šæ–‡æœ¬
                        tableHTML += `<td>${cellValue}</td>`;
                    }
                } else {
                    // å…¶ä»–åˆ—æ­£å¸¸æ˜¾ç¤º
                    tableHTML += `<td>${cellValue}</td>`;
                }
            });
            tableHTML += '</tr>';
        }
    });
    
    tableHTML += '</tbody></table>';
    
    excelContent.innerHTML = tableHTML;
    closeBtn.style.display = 'flex';
    
    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.style.display = 'flex';
    
    // å­˜å‚¨Excelæ•°æ®åˆ°å…¨å±€å˜é‡
    window.excelData = data;
    
    // æå–queryå’Œansweræ•°æ®
    extractDataFromExcel(data);
    
    // é‡æ–°ç”Ÿæˆè¡¨æ ¼HTMLï¼Œä½¿ç”¨æ›´æ–°åçš„extractedData
    refreshExcelDisplay();
    
    showMessage('Excelæ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
}

function refreshExcelDisplay() {
    if (!window.excelData) return;
    
    const excelContent = document.getElementById('excelContent');
    const closeBtn = document.querySelector('.close-btn');
    
    // é‡æ–°ç”Ÿæˆè¡¨æ ¼HTML
    let tableHTML = '<table class="excel-table">';
    
    // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
    window.excelData.forEach((row, rowIndex) => {
        if (rowIndex === 0) {
            // ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
            tableHTML += '<thead><tr>';
            row.forEach(cell => {
                const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
                tableHTML += `<th>${cellValue}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
        } else {
            // æ•°æ®è¡Œ
            tableHTML += '<tr>';
            row.forEach((cell, cellIndex) => {
                const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
                
                // ç¬¬ä¸€åˆ—ï¼ˆç´¢å¼•ä¸º0ï¼‰ç‰¹æ®Šå¤„ç†ï¼šqueryç¼–ç å¯ç‚¹å‡»
                if (cellIndex === 0) {
                    // æŸ¥æ‰¾å¯¹åº”çš„extractedDataç´¢å¼•ï¼Œä½¿ç”¨queryCodeåŒ¹é…
                    const dataIndex = extractedData.findIndex(item => item.queryCode === cellValue);
                    if (dataIndex !== -1) {
                        tableHTML += `<td><span class="clickable-query-code" onclick="switchToQuery(${dataIndex});">${cellValue}</span></td>`;
                    } else {
                        tableHTML += `<td>${cellValue}</td>`;
                    }
                } else if (cellIndex === 3) {
                    // ç¬¬å››åˆ—ï¼ˆç´¢å¼•ä¸º3ï¼‰ç‰¹æ®Šå¤„ç†ï¼šæ”¯æŒMarkdownæ¸²æŸ“
                    if (isMarkdownFormat(cellValue)) {
                        // å¦‚æœæ˜¯Markdownæ ¼å¼ï¼Œè¿›è¡Œæ¸²æŸ“
                        const renderedContent = renderMarkdown(cellValue);
                        tableHTML += `<td class="markdown-cell">${renderedContent}</td>`;
                    } else {
                        // æ™®é€šæ–‡æœ¬
                        tableHTML += `<td>${cellValue}</td>`;
                    }
                } else {
                    // å…¶ä»–åˆ—æ­£å¸¸æ˜¾ç¤º
                    tableHTML += `<td>${cellValue}</td>`;
                }
            });
            tableHTML += '</tr>';
        }
    });
    
    tableHTML += '</tbody></table>';
    
    excelContent.innerHTML = tableHTML;
    closeBtn.style.display = 'flex';
    
    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.style.display = 'flex';
}

function closeExcelDisplay() {
    const excelContent = document.getElementById('excelContent');
    const closeBtn = document.querySelector('.close-btn');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // æ¢å¤ä¸ºæœªä¸Šä¼ çŠ¶æ€
    excelContent.innerHTML = `
        <div class="no-file-message">
            <div class="no-file-icon">ğŸ“„</div>
            <p>æœªä¸Šä¼ æ–‡æ¡£</p>
            <span class="no-file-hint">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œä¸Šä¼ </span>
        </div>
    `;
    closeBtn.style.display = 'none';
    downloadBtn.style.display = 'none';
    
    // æ¸…ç©ºæ•°æ®
    window.excelData = null;
    extractedData = [];
    currentQueryIndex = 0;
    updateQueryDisplay();
}

function downloadExcel() {
    if (!window.excelData) {
        showMessage('æ²¡æœ‰å¯ä¸‹è½½çš„Excelæ•°æ®', 'warn');
        return;
    }
    
    try {
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // åˆ›å»ºå·¥ä½œè¡¨
        const ws = XLSX.utils.aoa_to_sheet(window.excelData);
        
        // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        
        // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `md_check_${timestamp}.xlsx`;
        
        // ä¸‹è½½æ–‡ä»¶
        XLSX.writeFile(wb, filename);
        
        showMessage('Excelæ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
    } catch (error) {
        console.error('ä¸‹è½½Excelå¤±è´¥:', error);
        showMessage('ä¸‹è½½Excelå¤±è´¥ï¼Œè¯·é‡è¯•', 'warn');
    }
}

// è¿™äº›å‡½æ•°å·²ç»åœ¨ä¸Šé¢å®šä¹‰äº†ï¼Œè¿™é‡Œç§»é™¤é‡å¤å®šä¹‰

document.addEventListener('DOMContentLoaded', ()=>{
  console.log('Setting initial tip content');
  document.getElementById('renderedPreview').innerHTML = '<div class="muted" style="text-align: center; padding: 40px 20px;">ç­‰å¾…ä¸Šä¼ Excelæ–‡ä»¶å¹¶é€‰æ‹©æ£€æŸ¥é¡¹...</div>';
  document.getElementById('leftMarkdown').addEventListener('input', mergeNow);
  
  // åˆå§‹åŒ–æ˜¾ç¤º
  updateQueryDisplay();
});
    </script>
</body>
</html>
