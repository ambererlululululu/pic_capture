<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据分析 - Query评分与字数关系</title>
    <style>
        /* ========== 设计变量 ========== */
        :root {
            /* 主题色 */
            --primary-gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            --primary-color: #6366F1;
            --primary-hover: #5558E3;
            
            /* 背景渐变 */
            --bg-gradient: linear-gradient(160deg, #4f46e5 0%, #8b5cf6 50%, #ec4899 120%);
            
            /* 文字颜色 */
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            
            /* 背景色 */
            --bg-white: #ffffff;
            --bg-gray-50: #f9fafb;
            --bg-gray-100: #f3f4f6;
            
            /* 边框色 */
            --border-color: #e5e7eb;
            
            /* 阴影 */
            --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.04);
            --shadow-md: 0 10px 30px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 20px 50px rgba(15, 23, 42, 0.12);
            --shadow-hover: 0 15px 40px rgba(15, 23, 42, 0.15);
            
            /* 圆角 */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            
            /* 间距 */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
        }

        /* ========== 全局样式 ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: var(--space-xl) var(--space-md);
            position: relative;
        }

        /* 添加半透明蒙层让背景不那么扎眼 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* ========== 顶部 Header ========== */
        .header {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            animation: slideDown 0.5s ease-out;
        }

        .header-left {
            flex: 1;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .header-icon {
            font-size: 32px;
            line-height: 1;
        }

        h1 {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
        }

        .header-subtitle {
            color: var(--text-tertiary);
            font-size: 15px;
            line-height: 1.6;
            margin-top: var(--space-xs);
        }

        .help-button {
            background: transparent;
            color: var(--primary-color);
            border: 1.5px solid var(--border-color);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .help-button:hover {
            background: var(--bg-gray-50);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* ========== 上传区卡片 ========== */
        .upload-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            animation: slideUp 0.5s ease-out 0.1s backwards;
        }

        .upload-card-header {
            margin-bottom: var(--space-lg);
        }

        .upload-card-title {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .upload-card-desc {
            color: var(--text-tertiary);
            font-size: 14px;
            line-height: 1.5;
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .upload-button {
            background: var(--primary-gradient);
            color: white;
            padding: 12px 28px;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        .upload-button:active {
            transform: translateY(0);
        }

        .file-info {
            flex: 1;
            min-width: 200px;
        }

        .file-name {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .file-meta {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        /* ========== 提示区域 ========== */
        .empty-state {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl) var(--space-xl);
            box-shadow: var(--shadow-md);
            text-align: center;
            animation: fadeIn 0.5s ease-out 0.2s backwards;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .empty-state-text {
            color: var(--text-tertiary);
            font-size: 15px;
            line-height: 1.6;
        }

        /* ========== 加载状态 ========== */
        .loading {
            display: none;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            border: 3px solid var(--bg-gray-100);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--space-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* ========== 错误提示 ========== */
        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            display: none;
            border-left: 4px solid #dc2626;
            animation: shake 0.5s ease-out;
        }

        .error.active {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ========== 结果区域 ========== */
        .results {
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* 统计卡片网格 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card-title {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        /* 图表卡片 */
        .chart-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }

        .chart-card-title {
            flex: 1;
        }

        .chart-card-title h2 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .chart-card-desc {
            color: var(--text-tertiary);
            font-size: 13px;
            line-height: 1.5;
        }

        .chart-container {
            width: 100%;
            height: 450px;
            margin-bottom: var(--space-md);
        }

        /* 洞察卡片 */
        .insight {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 3px solid var(--primary-color);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-top: var(--space-md);
        }

        .insight-title {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
            margin-bottom: var(--space-xs);
        }

        .insight-text {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 14px;
        }

        /* ========== 动画 ========== */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========== 响应式 ========== */
        @media (max-width: 768px) {
            body {
                padding: var(--space-md) var(--space-sm);
            }

            .header {
                flex-direction: column;
                gap: var(--space-md);
            }

            h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .upload-area {
                flex-direction: column;
                align-items: stretch;
            }

            .upload-button {
                width: 100%;
                justify-content: center;
            }

            .chart-container {
                height: 350px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }

            .header-icon {
                font-size: 24px;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-title">
                    <span class="header-icon">📊</span>
                    <h1>Query评分与字数关系分析</h1>
                </div>
                <p class="header-subtitle">
                    上传包含"字数统计"和"胜率"两个sheet的Excel文件，系统将自动进行数据分析和可视化展示
                </p>
            </div>
            <button class="help-button" onclick="showHelp()">💡 使用说明</button>
        </div>

        <!-- 上传卡片 -->
        <div class="upload-card">
            <div class="upload-card-header">
                <h3 class="upload-card-title">上传数据文件</h3>
                <p class="upload-card-desc">请上传 Excel 文件，支持 .xlsx 和 .xls 格式</p>
            </div>
            
            <div class="upload-area">
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
                    <button class="upload-button" onclick="document.getElementById('excelFile').click()">
                        <span>📁</span>
                        <span>选择文件</span>
                    </button>
                </div>
                <div class="file-info">
                    <div class="file-name" id="fileName">未选择文件</div>
                    <div class="file-meta" id="fileMeta"></div>
                </div>
            </div>
        </div>

        <!-- 错误提示 -->
        <div id="error" class="error"></div>

        <!-- 加载状态 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p class="loading-text">正在分析数据，请稍候...</p>
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">📈</div>
            <p class="empty-state-text">请先上传数据文件，系统将为您生成详细的分析报告</p>
        </div>

        <!-- 结果区域 -->
        <div id="results" class="results">
            <!-- 统计卡片 -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- 散点图 -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>📈 字数与胜率关系分析</h2>
                        <p class="chart-card-desc">通过散点图和回归线展示两个变量之间的相关性</p>
                    </div>
                </div>
                <div id="scatterPlot" class="chart-container"></div>
                <div class="insight" id="correlationInsight"></div>
            </div>

            <!-- 箱线图 -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>📦 按字数区间的胜率分布</h2>
                        <p class="chart-card-desc">将字数分为5个区间，展示每个区间的胜率分布情况</p>
                    </div>
                </div>
                <div id="boxPlot" class="chart-container"></div>
                <div class="insight" id="distributionInsight"></div>
            </div>

            <!-- 热力图 -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>🔥 变量相关性热力图</h2>
                        <p class="chart-card-desc">通过颜色深浅展示变量之间的相关性强度</p>
                    </div>
                </div>
                <div id="heatmap" class="chart-container"></div>
                <div class="insight" id="heatmapInsight"></div>
            </div>

            <!-- 模型对比 -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>🏆 不同模型的平均表现对比</h2>
                        <p class="chart-card-desc">对比各模型的平均字数和平均胜率</p>
                    </div>
                </div>
                <div id="modelComparison" class="chart-container"></div>
                <div class="insight" id="modelInsight"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // 帮助说明
        function showHelp() {
            alert('使用说明：\n\n1. 准备包含"字数统计"和"胜率"两个sheet的Excel文件\n2. 点击"选择文件"按钮上传\n3. 系统将自动分析并生成可视化报告\n4. 可以通过鼠标交互查看详细数据\n5. 支持缩放、平移等操作');
        }

        // 文件上传处理
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 显示文件信息
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                const uploadTime = new Date().toLocaleString('zh-CN');
                
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileMeta').textContent = `${fileSize} · 上传于 ${uploadTime}`;
                
                // 隐藏空状态
                document.getElementById('emptyState').style.display = 'none';
                
                // 加载并分析
                loadAndAnalyze(file);
            }
        });

        async function loadAndAnalyze(file) {
            // 显示加载状态
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('error').classList.remove('active');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });

                // 读取字数统计和胜率sheet
                const charCountSheet = workbook.Sheets['字数统计'];
                const winRateSheet = workbook.Sheets['胜率'];

                if (!charCountSheet || !winRateSheet) {
                    throw new Error('Excel文件必须包含"字数统计"和"胜率"两个sheet');
                }

                const charCountData = XLSX.utils.sheet_to_json(charCountSheet, { header: 1 });
                const winRateData = XLSX.utils.sheet_to_json(winRateSheet, { header: 1 });

                // 转换为长格式数据
                const tidyData = convertToTidyFormat(charCountData, winRateData);

                // 执行分析
                analyzeData(tidyData);

                // 隐藏加载，显示结果
                setTimeout(() => {
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('results').classList.add('active');
                }, 500);

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('error').textContent = '❌ ' + error.message;
                document.getElementById('error').classList.add('active');
                console.error(error);
            }
        }

        function convertToTidyFormat(charCountData, winRateData) {
            const tidyData = [];
            
            const charHeaders = charCountData[0];
            const winHeaders = winRateData[0];

            for (let i = 1; i < Math.max(charCountData.length, winRateData.length); i++) {
                const charRow = charCountData[i] || [];
                const winRow = winRateData[i] || [];
                
                const queryId = charRow[0] || winRow[0];

                for (let j = 1; j < charHeaders.length; j++) {
                    const model = charHeaders[j];
                    const wordCount = charRow[j];
                    const winRateStr = winRow[j];

                    if (wordCount || winRateStr) {
                        let rating = null;
                        if (winRateStr) {
                            const match = winRateStr.toString().match(/(\d+\.?\d*)%/);
                            rating = match ? parseFloat(match[1]) : null;
                        }

                        tidyData.push({
                            query: queryId,
                            model: model,
                            word_count: wordCount ? parseInt(wordCount) : null,
                            rating: rating
                        });
                    }
                }
            }

            return tidyData;
        }

        function analyzeData(data) {
            const validData = data.filter(d => d.word_count != null && d.rating != null);

            displayBasicStats(validData);
            createScatterPlot(validData);
            createBoxPlot(validData);
            createHeatmap(validData);
            createModelComparison(validData);
        }

        function displayBasicStats(data) {
            const wordCounts = data.map(d => d.word_count);
            const ratings = data.map(d => d.rating);

            const stats = {
                '📝 字数统计': {
                    '均值': mean(wordCounts).toFixed(2),
                    '中位数': median(wordCounts).toFixed(2),
                    '标准差': std(wordCounts).toFixed(2),
                    '最小值': Math.min(...wordCounts),
                    '最大值': Math.max(...wordCounts)
                },
                '🎯 胜率统计': {
                    '均值': mean(ratings).toFixed(2) + '%',
                    '中位数': median(ratings).toFixed(2) + '%',
                    '标准差': std(ratings).toFixed(2) + '%',
                    '最小值': Math.min(...ratings).toFixed(2) + '%',
                    '最大值': Math.max(...ratings).toFixed(2) + '%'
                },
                '📊 数据概览': {
                    '总样本数': data.length,
                    '模型数量': new Set(data.map(d => d.model)).size,
                    'Query数量': new Set(data.map(d => d.query)).size
                }
            };

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            Object.entries(stats).forEach(([title, items]) => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h3 class="stat-card-title">${title}</h3>
                    ${Object.entries(items).map(([label, value]) => `
                        <div class="stat-item">
                            <span class="stat-label">${label}</span>
                            <span class="stat-value">${value}</span>
                        </div>
                    `).join('')}
                `;
                statsGrid.appendChild(card);
            });
        }

        function createScatterPlot(data) {
            const trace = {
                x: data.map(d => d.word_count),
                y: data.map(d => d.rating),
                mode: 'markers',
                type: 'scatter',
                name: '数据点',
                marker: {
                    size: 10,
                    color: data.map(d => d.rating),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: '胜率%',
                        thickness: 15
                    },
                    line: {
                        color: 'white',
                        width: 1
                    }
                },
                text: data.map(d => `模型: ${d.model}<br>字数: ${d.word_count}<br>胜率: ${d.rating}%`),
                hovertemplate: '%{text}<extra></extra>'
            };

            const regression = calculateRegression(
                data.map(d => d.word_count),
                data.map(d => d.rating)
            );

            const regressionTrace = {
                x: regression.x,
                y: regression.y,
                mode: 'lines',
                name: '回归线',
                line: { 
                    color: '#ef4444', 
                    width: 3,
                    dash: 'dash'
                }
            };

            const layout = {
                xaxis: { 
                    title: '字数',
                    gridcolor: '#f3f4f6'
                },
                yaxis: { 
                    title: '胜率 (%)',
                    gridcolor: '#f3f4f6'
                },
                hovermode: 'closest',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('scatterPlot', [trace, regressionTrace], layout, {responsive: true});

            const correlation = calculateCorrelation(
                data.map(d => d.word_count),
                data.map(d => d.rating)
            );

            document.getElementById('correlationInsight').innerHTML = `
                <div class="insight-title">📈 相关性分析</div>
                <div class="insight-text">
                    字数与胜率的相关系数为 <strong>${correlation.toFixed(3)}</strong>。
                    ${Math.abs(correlation) > 0.7 ? '存在<strong>强</strong>' : 
                      Math.abs(correlation) > 0.4 ? '存在<strong>中等</strong>' : 
                      '存在<strong>弱</strong>'}${correlation > 0 ? '正' : '负'}相关关系。
                    ${correlation > 0.3 ? '这表明字数越多，胜率往往越高。' : 
                      correlation < -0.3 ? '这表明字数越多，胜率反而越低。' : 
                      '字数与胜率之间的关系不明显。'}
                </div>
            `;
        }

        function createBoxPlot(data) {
            const wordCounts = data.map(d => d.word_count);
            const min = Math.min(...wordCounts);
            const max = Math.max(...wordCounts);
            const interval = (max - min) / 5;

            const bins = [];
            for (let i = 0; i < 5; i++) {
                bins.push({
                    label: `${Math.round(min + i * interval)}-${Math.round(min + (i + 1) * interval)}`,
                    min: min + i * interval,
                    max: min + (i + 1) * interval,
                    data: []
                });
            }

            data.forEach(d => {
                for (let i = 0; i < bins.length; i++) {
                    if (d.word_count >= bins[i].min && d.word_count < bins[i].max) {
                        bins[i].data.push(d.rating);
                        break;
                    }
                }
            });

            const traces = bins.map((bin, i) => ({
                y: bin.data,
                type: 'box',
                name: bin.label,
                boxmean: 'sd',
                marker: { color: `hsl(${i * 60}, 70%, 60%)` }
            }));

            const layout = {
                xaxis: { title: '字数区间' },
                yaxis: { title: '胜率 (%)' },
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('boxPlot', traces, layout, {responsive: true});

            document.getElementById('distributionInsight').innerHTML = `
                <div class="insight-title">📦 分布分析</div>
                <div class="insight-text">
                    箱线图展示了不同字数区间的胜率分布情况。箱体表示四分位距（IQR），中间的线表示中位数，
                    钻石标记表示均值。可以观察到不同字数区间的胜率中位数和离散程度。
                </div>
            `;
        }

        function createHeatmap(data) {
            const wordCounts = data.map(d => d.word_count);
            const ratings = data.map(d => d.rating);

            const corrMatrix = [
                [1, calculateCorrelation(wordCounts, ratings)],
                [calculateCorrelation(ratings, wordCounts), 1]
            ];

            const trace = {
                z: corrMatrix,
                x: ['字数', '胜率'],
                y: ['字数', '胜率'],
                type: 'heatmap',
                colorscale: 'RdBu',
                zmid: 0,
                text: corrMatrix.map(row => row.map(val => val.toFixed(3))),
                texttemplate: '%{text}',
                textfont: { size: 18, family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            const layout = {
                xaxis: { side: 'bottom' },
                yaxis: { autorange: 'reversed' },
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('heatmap', [trace], layout, {responsive: true});

            document.getElementById('heatmapInsight').innerHTML = `
                <div class="insight-title">🔥 相关性矩阵</div>
                <div class="insight-text">
                    热力图显示了变量之间的相关性强度。颜色越红表示正相关越强，越蓝表示负相关越强。
                    对角线为1表示变量与自身完全相关。
                </div>
            `;
        }

        function createModelComparison(data) {
            const modelStats = {};
            data.forEach(d => {
                if (!modelStats[d.model]) {
                    modelStats[d.model] = {
                        wordCounts: [],
                        ratings: []
                    };
                }
                modelStats[d.model].wordCounts.push(d.word_count);
                modelStats[d.model].ratings.push(d.rating);
            });

            const models = Object.keys(modelStats);
            const avgWordCounts = models.map(m => mean(modelStats[m].wordCounts));
            const avgRatings = models.map(m => mean(modelStats[m].ratings));

            const trace1 = {
                x: models,
                y: avgWordCounts,
                name: '平均字数',
                type: 'bar',
                marker: { 
                    color: '#6366f1',
                    line: { color: 'white', width: 2 }
                }
            };

            const trace2 = {
                x: models,
                y: avgRatings,
                name: '平均胜率',
                type: 'bar',
                yaxis: 'y2',
                marker: { 
                    color: '#ec4899',
                    line: { color: 'white', width: 2 }
                }
            };

            const layout = {
                xaxis: { title: '模型' },
                yaxis: { 
                    title: '平均字数',
                    gridcolor: '#f3f4f6'
                },
                yaxis2: {
                    title: '平均胜率 (%)',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: '#f3f4f6'
                },
                barmode: 'group',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('modelComparison', [trace1, trace2], layout, {responsive: true});

            const bestModel = models[avgRatings.indexOf(Math.max(...avgRatings))];
            const mostVerbose = models[avgWordCounts.indexOf(Math.max(...avgWordCounts))];

            document.getElementById('modelInsight').innerHTML = `
                <div class="insight-title">🏆 模型表现</div>
                <div class="insight-text">
                    <strong>${bestModel}</strong> 的平均胜率最高（${Math.max(...avgRatings).toFixed(2)}%），
                    <strong>${mostVerbose}</strong> 的平均字数最多（${Math.max(...avgWordCounts).toFixed(0)}字）。
                    ${bestModel === mostVerbose ? '最佳模型同时也是最详细的模型。' : ''}
                </div>
            `;
        }

        // 统计函数
        function mean(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        function median(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        function std(arr) {
            const avg = mean(arr);
            const squareDiffs = arr.map(value => Math.pow(value - avg, 2));
            return Math.sqrt(mean(squareDiffs));
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return numerator / denominator;
        }

        function calculateRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const minX = Math.min(...x);
            const maxX = Math.max(...x);
            const regressionX = [minX, maxX];
            const regressionY = regressionX.map(xi => slope * xi + intercept);

            return { x: regressionX, y: regressionY, slope, intercept };
        }
    </script>
</body>
</html>
