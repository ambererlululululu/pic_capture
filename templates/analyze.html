<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æ - Queryè¯„åˆ†ä¸å­—æ•°å…³ç³»</title>
    <style>
        /* ========== è®¾è®¡å˜é‡ ========== */
        :root {
            /* ä¸»é¢˜è‰² */
            --primary-gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            --primary-color: #6366F1;
            --primary-hover: #5558E3;
            
            /* èƒŒæ™¯æ¸å˜ */
            --bg-gradient: linear-gradient(160deg, #4f46e5 0%, #8b5cf6 50%, #ec4899 120%);
            
            /* æ–‡å­—é¢œè‰² */
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            
            /* èƒŒæ™¯è‰² */
            --bg-white: #ffffff;
            --bg-gray-50: #f9fafb;
            --bg-gray-100: #f3f4f6;
            
            /* è¾¹æ¡†è‰² */
            --border-color: #e5e7eb;
            
            /* é˜´å½± */
            --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.04);
            --shadow-md: 0 10px 30px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 20px 50px rgba(15, 23, 42, 0.12);
            --shadow-hover: 0 15px 40px rgba(15, 23, 42, 0.15);
            
            /* åœ†è§’ */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            
            /* é—´è· */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
        }

        /* ========== å…¨å±€æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: var(--space-xl) var(--space-md);
            position: relative;
        }

        /* æ·»åŠ åŠé€æ˜è’™å±‚è®©èƒŒæ™¯ä¸é‚£ä¹ˆæ‰çœ¼ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* ========== é¡¶éƒ¨ Header ========== */
        .header {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            animation: slideDown 0.5s ease-out;
        }

        .header-left {
            flex: 1;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .header-icon {
            font-size: 32px;
            line-height: 1;
        }

        h1 {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
        }

        .header-subtitle {
            color: var(--text-tertiary);
            font-size: 15px;
            line-height: 1.6;
            margin-top: var(--space-xs);
        }

        .help-button {
            background: transparent;
            color: var(--primary-color);
            border: 1.5px solid var(--border-color);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .help-button:hover {
            background: var(--bg-gray-50);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* ========== ä¸Šä¼ åŒºå¡ç‰‡ ========== */
        .upload-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            animation: slideUp 0.5s ease-out 0.1s backwards;
        }

        .upload-card-header {
            margin-bottom: var(--space-lg);
        }

        .upload-card-title {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .upload-card-desc {
            color: var(--text-tertiary);
            font-size: 14px;
            line-height: 1.5;
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .upload-button {
            background: var(--primary-gradient);
            color: white;
            padding: 12px 28px;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        .upload-button:active {
            transform: translateY(0);
        }

        .file-info {
            flex: 1;
            min-width: 200px;
        }

        .file-name {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .file-meta {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        /* ========== æç¤ºåŒºåŸŸ ========== */
        .empty-state {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl) var(--space-xl);
            box-shadow: var(--shadow-md);
            text-align: center;
            animation: fadeIn 0.5s ease-out 0.2s backwards;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .empty-state-text {
            color: var(--text-tertiary);
            font-size: 15px;
            line-height: 1.6;
        }

        /* ========== åŠ è½½çŠ¶æ€ ========== */
        .loading {
            display: none;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            border: 3px solid var(--bg-gray-100);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--space-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* ========== é”™è¯¯æç¤º ========== */
        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            display: none;
            border-left: 4px solid #dc2626;
            animation: shake 0.5s ease-out;
        }

        .error.active {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ========== ç»“æœåŒºåŸŸ ========== */
        .results {
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card-title {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        /* å›¾è¡¨å¡ç‰‡ */
        .chart-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }

        .chart-card-title {
            flex: 1;
        }

        .chart-card-title h2 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .chart-card-desc {
            color: var(--text-tertiary);
            font-size: 13px;
            line-height: 1.5;
        }

        .chart-container {
            width: 100%;
            height: 450px;
            margin-bottom: var(--space-md);
        }

        /* æ´å¯Ÿå¡ç‰‡ */
        .insight {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 3px solid var(--primary-color);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-top: var(--space-md);
        }

        .insight-title {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
            margin-bottom: var(--space-xs);
        }

        .insight-text {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 14px;
        }

        /* ========== åŠ¨ç”» ========== */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========== å“åº”å¼ ========== */
        @media (max-width: 768px) {
            body {
                padding: var(--space-md) var(--space-sm);
            }

            .header {
                flex-direction: column;
                gap: var(--space-md);
            }

            h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .upload-area {
                flex-direction: column;
                align-items: stretch;
            }

            .upload-button {
                width: 100%;
                justify-content: center;
            }

            .chart-container {
                height: 350px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }

            .header-icon {
                font-size: 24px;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-title">
                    <span class="header-icon">ğŸ“Š</span>
                    <h1>Queryè¯„åˆ†ä¸å­—æ•°å…³ç³»åˆ†æ</h1>
                </div>
                <p class="header-subtitle">
                    ä¸Šä¼ åŒ…å«"å­—æ•°ç»Ÿè®¡"å’Œ"èƒœç‡"ä¸¤ä¸ªsheetçš„Excelæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œæ•°æ®åˆ†æå’Œå¯è§†åŒ–å±•ç¤º
                </p>
            </div>
            <button class="help-button" onclick="showHelp()">ğŸ’¡ ä½¿ç”¨è¯´æ˜</button>
        </div>

        <!-- ä¸Šä¼ å¡ç‰‡ -->
        <div class="upload-card">
            <div class="upload-card-header">
                <h3 class="upload-card-title">ä¸Šä¼ æ•°æ®æ–‡ä»¶</h3>
                <p class="upload-card-desc">è¯·ä¸Šä¼  Excel æ–‡ä»¶ï¼Œæ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
            </div>
            
            <div class="upload-area">
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
                    <button class="upload-button" onclick="document.getElementById('excelFile').click()">
                        <span>ğŸ“</span>
                        <span>é€‰æ‹©æ–‡ä»¶</span>
                    </button>
                </div>
                <div class="file-info">
                    <div class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</div>
                    <div class="file-meta" id="fileMeta"></div>
                </div>
            </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error" class="error"></div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p class="loading-text">æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">ğŸ“ˆ</div>
            <p class="empty-state-text">è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Š</p>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div id="results" class="results">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- æ•£ç‚¹å›¾ -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>ğŸ“ˆ å­—æ•°ä¸èƒœç‡å…³ç³»åˆ†æ</h2>
                        <p class="chart-card-desc">é€šè¿‡æ•£ç‚¹å›¾å’Œå›å½’çº¿å±•ç¤ºä¸¤ä¸ªå˜é‡ä¹‹é—´çš„ç›¸å…³æ€§</p>
                    </div>
                </div>
                <div id="scatterPlot" class="chart-container"></div>
                <div class="insight" id="correlationInsight"></div>
            </div>

            <!-- ç®±çº¿å›¾ -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>ğŸ“¦ æŒ‰å­—æ•°åŒºé—´çš„èƒœç‡åˆ†å¸ƒ</h2>
                        <p class="chart-card-desc">å°†å­—æ•°åˆ†ä¸º5ä¸ªåŒºé—´ï¼Œå±•ç¤ºæ¯ä¸ªåŒºé—´çš„èƒœç‡åˆ†å¸ƒæƒ…å†µ</p>
                    </div>
                </div>
                <div id="boxPlot" class="chart-container"></div>
                <div class="insight" id="distributionInsight"></div>
            </div>

            <!-- çƒ­åŠ›å›¾ -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>ğŸ”¥ å˜é‡ç›¸å…³æ€§çƒ­åŠ›å›¾</h2>
                        <p class="chart-card-desc">é€šè¿‡é¢œè‰²æ·±æµ…å±•ç¤ºå˜é‡ä¹‹é—´çš„ç›¸å…³æ€§å¼ºåº¦</p>
                    </div>
                </div>
                <div id="heatmap" class="chart-container"></div>
                <div class="insight" id="heatmapInsight"></div>
            </div>

            <!-- æ¨¡å‹å¯¹æ¯” -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <h2>ğŸ† ä¸åŒæ¨¡å‹çš„å¹³å‡è¡¨ç°å¯¹æ¯”</h2>
                        <p class="chart-card-desc">å¯¹æ¯”å„æ¨¡å‹çš„å¹³å‡å­—æ•°å’Œå¹³å‡èƒœç‡</p>
                    </div>
                </div>
                <div id="modelComparison" class="chart-container"></div>
                <div class="insight" id="modelInsight"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // å¸®åŠ©è¯´æ˜
        function showHelp() {
            alert('ä½¿ç”¨è¯´æ˜ï¼š\n\n1. å‡†å¤‡åŒ…å«"å­—æ•°ç»Ÿè®¡"å’Œ"èƒœç‡"ä¸¤ä¸ªsheetçš„Excelæ–‡ä»¶\n2. ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®ä¸Šä¼ \n3. ç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æå¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š\n4. å¯ä»¥é€šè¿‡é¼ æ ‡äº¤äº’æŸ¥çœ‹è¯¦ç»†æ•°æ®\n5. æ”¯æŒç¼©æ”¾ã€å¹³ç§»ç­‰æ“ä½œ');
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                const uploadTime = new Date().toLocaleString('zh-CN');
                
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileMeta').textContent = `${fileSize} Â· ä¸Šä¼ äº ${uploadTime}`;
                
                // éšè—ç©ºçŠ¶æ€
                document.getElementById('emptyState').style.display = 'none';
                
                // åŠ è½½å¹¶åˆ†æ
                loadAndAnalyze(file);
            }
        });

        async function loadAndAnalyze(file) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('error').classList.remove('active');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });

                // è¯»å–å­—æ•°ç»Ÿè®¡å’Œèƒœç‡sheet
                const charCountSheet = workbook.Sheets['å­—æ•°ç»Ÿè®¡'];
                const winRateSheet = workbook.Sheets['èƒœç‡'];

                if (!charCountSheet || !winRateSheet) {
                    throw new Error('Excelæ–‡ä»¶å¿…é¡»åŒ…å«"å­—æ•°ç»Ÿè®¡"å’Œ"èƒœç‡"ä¸¤ä¸ªsheet');
                }

                const charCountData = XLSX.utils.sheet_to_json(charCountSheet, { header: 1 });
                const winRateData = XLSX.utils.sheet_to_json(winRateSheet, { header: 1 });

                // è½¬æ¢ä¸ºé•¿æ ¼å¼æ•°æ®
                const tidyData = convertToTidyFormat(charCountData, winRateData);

                // æ‰§è¡Œåˆ†æ
                analyzeData(tidyData);

                // éšè—åŠ è½½ï¼Œæ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('results').classList.add('active');
                }, 500);

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('error').textContent = 'âŒ ' + error.message;
                document.getElementById('error').classList.add('active');
                console.error(error);
            }
        }

        function convertToTidyFormat(charCountData, winRateData) {
            const tidyData = [];
            
            const charHeaders = charCountData[0];
            const winHeaders = winRateData[0];

            for (let i = 1; i < Math.max(charCountData.length, winRateData.length); i++) {
                const charRow = charCountData[i] || [];
                const winRow = winRateData[i] || [];
                
                const queryId = charRow[0] || winRow[0];

                for (let j = 1; j < charHeaders.length; j++) {
                    const model = charHeaders[j];
                    const wordCount = charRow[j];
                    const winRateStr = winRow[j];

                    if (wordCount || winRateStr) {
                        let rating = null;
                        if (winRateStr) {
                            const match = winRateStr.toString().match(/(\d+\.?\d*)%/);
                            rating = match ? parseFloat(match[1]) : null;
                        }

                        tidyData.push({
                            query: queryId,
                            model: model,
                            word_count: wordCount ? parseInt(wordCount) : null,
                            rating: rating
                        });
                    }
                }
            }

            return tidyData;
        }

        function analyzeData(data) {
            const validData = data.filter(d => d.word_count != null && d.rating != null);

            displayBasicStats(validData);
            createScatterPlot(validData);
            createBoxPlot(validData);
            createHeatmap(validData);
            createModelComparison(validData);
        }

        function displayBasicStats(data) {
            const wordCounts = data.map(d => d.word_count);
            const ratings = data.map(d => d.rating);

            const stats = {
                'ğŸ“ å­—æ•°ç»Ÿè®¡': {
                    'å‡å€¼': mean(wordCounts).toFixed(2),
                    'ä¸­ä½æ•°': median(wordCounts).toFixed(2),
                    'æ ‡å‡†å·®': std(wordCounts).toFixed(2),
                    'æœ€å°å€¼': Math.min(...wordCounts),
                    'æœ€å¤§å€¼': Math.max(...wordCounts)
                },
                'ğŸ¯ èƒœç‡ç»Ÿè®¡': {
                    'å‡å€¼': mean(ratings).toFixed(2) + '%',
                    'ä¸­ä½æ•°': median(ratings).toFixed(2) + '%',
                    'æ ‡å‡†å·®': std(ratings).toFixed(2) + '%',
                    'æœ€å°å€¼': Math.min(...ratings).toFixed(2) + '%',
                    'æœ€å¤§å€¼': Math.max(...ratings).toFixed(2) + '%'
                },
                'ğŸ“Š æ•°æ®æ¦‚è§ˆ': {
                    'æ€»æ ·æœ¬æ•°': data.length,
                    'æ¨¡å‹æ•°é‡': new Set(data.map(d => d.model)).size,
                    'Queryæ•°é‡': new Set(data.map(d => d.query)).size
                }
            };

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            Object.entries(stats).forEach(([title, items]) => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h3 class="stat-card-title">${title}</h3>
                    ${Object.entries(items).map(([label, value]) => `
                        <div class="stat-item">
                            <span class="stat-label">${label}</span>
                            <span class="stat-value">${value}</span>
                        </div>
                    `).join('')}
                `;
                statsGrid.appendChild(card);
            });
        }

        function createScatterPlot(data) {
            const trace = {
                x: data.map(d => d.word_count),
                y: data.map(d => d.rating),
                mode: 'markers',
                type: 'scatter',
                name: 'æ•°æ®ç‚¹',
                marker: {
                    size: 10,
                    color: data.map(d => d.rating),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'èƒœç‡%',
                        thickness: 15
                    },
                    line: {
                        color: 'white',
                        width: 1
                    }
                },
                text: data.map(d => `æ¨¡å‹: ${d.model}<br>å­—æ•°: ${d.word_count}<br>èƒœç‡: ${d.rating}%`),
                hovertemplate: '%{text}<extra></extra>'
            };

            const regression = calculateRegression(
                data.map(d => d.word_count),
                data.map(d => d.rating)
            );

            const regressionTrace = {
                x: regression.x,
                y: regression.y,
                mode: 'lines',
                name: 'å›å½’çº¿',
                line: { 
                    color: '#ef4444', 
                    width: 3,
                    dash: 'dash'
                }
            };

            const layout = {
                xaxis: { 
                    title: 'å­—æ•°',
                    gridcolor: '#f3f4f6'
                },
                yaxis: { 
                    title: 'èƒœç‡ (%)',
                    gridcolor: '#f3f4f6'
                },
                hovermode: 'closest',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('scatterPlot', [trace, regressionTrace], layout, {responsive: true});

            const correlation = calculateCorrelation(
                data.map(d => d.word_count),
                data.map(d => d.rating)
            );

            document.getElementById('correlationInsight').innerHTML = `
                <div class="insight-title">ğŸ“ˆ ç›¸å…³æ€§åˆ†æ</div>
                <div class="insight-text">
                    å­—æ•°ä¸èƒœç‡çš„ç›¸å…³ç³»æ•°ä¸º <strong>${correlation.toFixed(3)}</strong>ã€‚
                    ${Math.abs(correlation) > 0.7 ? 'å­˜åœ¨<strong>å¼º</strong>' : 
                      Math.abs(correlation) > 0.4 ? 'å­˜åœ¨<strong>ä¸­ç­‰</strong>' : 
                      'å­˜åœ¨<strong>å¼±</strong>'}${correlation > 0 ? 'æ­£' : 'è´Ÿ'}ç›¸å…³å…³ç³»ã€‚
                    ${correlation > 0.3 ? 'è¿™è¡¨æ˜å­—æ•°è¶Šå¤šï¼Œèƒœç‡å¾€å¾€è¶Šé«˜ã€‚' : 
                      correlation < -0.3 ? 'è¿™è¡¨æ˜å­—æ•°è¶Šå¤šï¼Œèƒœç‡åè€Œè¶Šä½ã€‚' : 
                      'å­—æ•°ä¸èƒœç‡ä¹‹é—´çš„å…³ç³»ä¸æ˜æ˜¾ã€‚'}
                </div>
            `;
        }

        function createBoxPlot(data) {
            const wordCounts = data.map(d => d.word_count);
            const min = Math.min(...wordCounts);
            const max = Math.max(...wordCounts);
            const interval = (max - min) / 5;

            const bins = [];
            for (let i = 0; i < 5; i++) {
                bins.push({
                    label: `${Math.round(min + i * interval)}-${Math.round(min + (i + 1) * interval)}`,
                    min: min + i * interval,
                    max: min + (i + 1) * interval,
                    data: []
                });
            }

            data.forEach(d => {
                for (let i = 0; i < bins.length; i++) {
                    if (d.word_count >= bins[i].min && d.word_count < bins[i].max) {
                        bins[i].data.push(d.rating);
                        break;
                    }
                }
            });

            const traces = bins.map((bin, i) => ({
                y: bin.data,
                type: 'box',
                name: bin.label,
                boxmean: 'sd',
                marker: { color: `hsl(${i * 60}, 70%, 60%)` }
            }));

            const layout = {
                xaxis: { title: 'å­—æ•°åŒºé—´' },
                yaxis: { title: 'èƒœç‡ (%)' },
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('boxPlot', traces, layout, {responsive: true});

            document.getElementById('distributionInsight').innerHTML = `
                <div class="insight-title">ğŸ“¦ åˆ†å¸ƒåˆ†æ</div>
                <div class="insight-text">
                    ç®±çº¿å›¾å±•ç¤ºäº†ä¸åŒå­—æ•°åŒºé—´çš„èƒœç‡åˆ†å¸ƒæƒ…å†µã€‚ç®±ä½“è¡¨ç¤ºå››åˆ†ä½è·ï¼ˆIQRï¼‰ï¼Œä¸­é—´çš„çº¿è¡¨ç¤ºä¸­ä½æ•°ï¼Œ
                    é’»çŸ³æ ‡è®°è¡¨ç¤ºå‡å€¼ã€‚å¯ä»¥è§‚å¯Ÿåˆ°ä¸åŒå­—æ•°åŒºé—´çš„èƒœç‡ä¸­ä½æ•°å’Œç¦»æ•£ç¨‹åº¦ã€‚
                </div>
            `;
        }

        function createHeatmap(data) {
            const wordCounts = data.map(d => d.word_count);
            const ratings = data.map(d => d.rating);

            const corrMatrix = [
                [1, calculateCorrelation(wordCounts, ratings)],
                [calculateCorrelation(ratings, wordCounts), 1]
            ];

            const trace = {
                z: corrMatrix,
                x: ['å­—æ•°', 'èƒœç‡'],
                y: ['å­—æ•°', 'èƒœç‡'],
                type: 'heatmap',
                colorscale: 'RdBu',
                zmid: 0,
                text: corrMatrix.map(row => row.map(val => val.toFixed(3))),
                texttemplate: '%{text}',
                textfont: { size: 18, family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            const layout = {
                xaxis: { side: 'bottom' },
                yaxis: { autorange: 'reversed' },
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('heatmap', [trace], layout, {responsive: true});

            document.getElementById('heatmapInsight').innerHTML = `
                <div class="insight-title">ğŸ”¥ ç›¸å…³æ€§çŸ©é˜µ</div>
                <div class="insight-text">
                    çƒ­åŠ›å›¾æ˜¾ç¤ºäº†å˜é‡ä¹‹é—´çš„ç›¸å…³æ€§å¼ºåº¦ã€‚é¢œè‰²è¶Šçº¢è¡¨ç¤ºæ­£ç›¸å…³è¶Šå¼ºï¼Œè¶Šè“è¡¨ç¤ºè´Ÿç›¸å…³è¶Šå¼ºã€‚
                    å¯¹è§’çº¿ä¸º1è¡¨ç¤ºå˜é‡ä¸è‡ªèº«å®Œå…¨ç›¸å…³ã€‚
                </div>
            `;
        }

        function createModelComparison(data) {
            const modelStats = {};
            data.forEach(d => {
                if (!modelStats[d.model]) {
                    modelStats[d.model] = {
                        wordCounts: [],
                        ratings: []
                    };
                }
                modelStats[d.model].wordCounts.push(d.word_count);
                modelStats[d.model].ratings.push(d.rating);
            });

            const models = Object.keys(modelStats);
            const avgWordCounts = models.map(m => mean(modelStats[m].wordCounts));
            const avgRatings = models.map(m => mean(modelStats[m].ratings));

            const trace1 = {
                x: models,
                y: avgWordCounts,
                name: 'å¹³å‡å­—æ•°',
                type: 'bar',
                marker: { 
                    color: '#6366f1',
                    line: { color: 'white', width: 2 }
                }
            };

            const trace2 = {
                x: models,
                y: avgRatings,
                name: 'å¹³å‡èƒœç‡',
                type: 'bar',
                yaxis: 'y2',
                marker: { 
                    color: '#ec4899',
                    line: { color: 'white', width: 2 }
                }
            };

            const layout = {
                xaxis: { title: 'æ¨¡å‹' },
                yaxis: { 
                    title: 'å¹³å‡å­—æ•°',
                    gridcolor: '#f3f4f6'
                },
                yaxis2: {
                    title: 'å¹³å‡èƒœç‡ (%)',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: '#f3f4f6'
                },
                barmode: 'group',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI"' }
            };

            Plotly.newPlot('modelComparison', [trace1, trace2], layout, {responsive: true});

            const bestModel = models[avgRatings.indexOf(Math.max(...avgRatings))];
            const mostVerbose = models[avgWordCounts.indexOf(Math.max(...avgWordCounts))];

            document.getElementById('modelInsight').innerHTML = `
                <div class="insight-title">ğŸ† æ¨¡å‹è¡¨ç°</div>
                <div class="insight-text">
                    <strong>${bestModel}</strong> çš„å¹³å‡èƒœç‡æœ€é«˜ï¼ˆ${Math.max(...avgRatings).toFixed(2)}%ï¼‰ï¼Œ
                    <strong>${mostVerbose}</strong> çš„å¹³å‡å­—æ•°æœ€å¤šï¼ˆ${Math.max(...avgWordCounts).toFixed(0)}å­—ï¼‰ã€‚
                    ${bestModel === mostVerbose ? 'æœ€ä½³æ¨¡å‹åŒæ—¶ä¹Ÿæ˜¯æœ€è¯¦ç»†çš„æ¨¡å‹ã€‚' : ''}
                </div>
            `;
        }

        // ç»Ÿè®¡å‡½æ•°
        function mean(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        function median(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        function std(arr) {
            const avg = mean(arr);
            const squareDiffs = arr.map(value => Math.pow(value - avg, 2));
            return Math.sqrt(mean(squareDiffs));
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return numerator / denominator;
        }

        function calculateRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const minX = Math.min(...x);
            const maxX = Math.max(...x);
            const regressionX = [minX, maxX];
            const regressionY = regressionX.map(xi => slope * xi + intercept);

            return { x: regressionX, y: regressionY, slope, intercept };
        }
    </script>
</body>
</html>
