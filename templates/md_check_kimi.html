<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MD 检查-kimi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- 备用：CDN 标记库，如果不可用则降级到本地 renderMarkdown -->
<script>
  (function(){
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js';
    s.onload = function(){ console.log('marked loaded'); };
    s.onerror = function(){ console.warn('marked CDN load failed, using local renderer'); };
    document.head.appendChild(s);
  })();
</script>
    <style>
  :root{--bg:#f6f7fb;--card:#fff;--txt:#111;--muted:#6b7280;--brand:#2563eb;--ok:#10b981;--warn:#b91c1c}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;min-height:100vh;color:var(--txt);display:flex;flex-direction:column}
  .header{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:18px 18px 0;display:flex;justify-content:space-between;align-items:center}
  .header h1{margin:0;font-size:24px;color:var(--brand)}
  .header p{margin:8px 0 0;color:var(--muted);font-size:14px}
  .header-right{display:flex;align-items:center;gap:20px}
  .query-section{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:15px 18px;margin:0 18px;display:flex;flex-direction:column;gap:12px}
  .query-display{display:flex;align-items:center;gap:10px}
  .query-label{font-size:16px;color:var(--muted);font-weight:600}
  .query-text{font-size:16px;color:var(--txt);background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:8px 12px;flex:1;min-width:200px;font-weight:500}
  .copy-btn{background:var(--brand);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;transition:all 0.2s ease}
  .copy-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .navigation-buttons{display:flex;gap:10px;justify-content:center}
  .nav-btn{background:#f8f9fa;color:var(--txt);border:1px solid #e9ecef;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:14px;transition:all 0.2s ease;flex:1;min-width:80px}
  .nav-btn:hover{background:#e9ecef;transform:translateY(-1px)}
  .nav-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .nav-btn:disabled:hover{background:#f8f9fa;transform:none}
  .upload-section{display:flex;align-items:center;gap:15px}
  .upload-btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 20px;cursor:pointer;font-size:14px;transition:all 0.2s ease}
  .upload-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .file-info{background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--muted);width:200px;min-height:20px;transition:all 0.2s ease}
  .progress-section{display:flex;align-items:center;gap:15px;justify-content:flex-end}
  .progress-bar{width:180px;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--brand),var(--ok));width:0%;transition:width 0.3s ease;border-radius:4px}
  .progress-text{font-size:12px;color:var(--muted);min-width:70px;text-align:right}
  .container{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:18px;flex:1}
  .excel-display-section{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:0 18px;display:flex;flex-direction:column}
  .excel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e9ecef}
  .excel-header h3{margin:0;font-size:18px;color:var(--brand)}
  .excel-header-buttons{display:flex;align-items:center;gap:10px}
  .download-btn{background:var(--ok);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;transition:all 0.2s ease}
  .download-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .close-btn{background:none;border:none;font-size:24px;color:var(--muted);cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s ease}
  .close-btn:hover{background:#f8f9fa;color:var(--warn)}
  .excel-content{flex:1;overflow:auto;max-height:400px}
  .no-file-message{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--muted)}
  .no-file-icon{font-size:48px;margin-bottom:15px;opacity:0.6}
  .no-file-message p{margin:0 0 8px;font-size:18px;color:var(--txt)}
  .no-file-hint{font-size:14px;color:var(--muted)}
  .file-info-display{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center}
  .file-info-icon{font-size:48px;margin-bottom:15px;opacity:0.8}
  .file-info-display h4{margin:0 0 20px;font-size:20px;color:var(--brand)}
  .file-details{background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;min-width:300px}
  .file-details p{margin:0 0 10px;font-size:14px;color:var(--txt)}
  .file-details p:last-child{margin-bottom:0}
  .processing-note{background:#e3f2fd;border:1px solid #bbdefb;border-radius:8px;padding:15px;color:var(--brand)}
  .processing-note p{margin:0 0 5px;font-size:16px;font-weight:500}
  .processing-note span{font-size:14px;opacity:0.8}
  .error-message{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center;color:var(--warn)}
  .error-icon{font-size:48px;margin-bottom:15px}
  .error-message h4{margin:0 0 10px;font-size:18px;color:var(--warn)}
  .error-message p{margin:0;font-size:14px;color:var(--muted)}
  .empty-message{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center;color:var(--muted)}
  .empty-icon{font-size:48px;margin-bottom:15px;opacity:0.6}
  .empty-message h4{margin:0 0 10px;font-size:18px;color:var(--txt)}
  .empty-message p{margin:0;font-size:14px;color:var(--muted)}
  .excel-table{width:100%;border-collapse:collapse;font-size:14px}
  .excel-table th,.excel-table td{border:1px solid #e9ecef;padding:8px 12px;text-align:left;vertical-align:top}
  .excel-table th{background:#f8f9fa;font-weight:600;color:var(--txt)}
  .excel-table td{background:#fff}
  .excel-table tr:nth-child(even) td{background:#fafafa}
  .markdown-cell{max-width:400px;word-wrap:break-word}
  .markdown-cell p{margin:0 0 2px;line-height:1.2}
  .markdown-cell p:last-child{margin-bottom:0}
  .markdown-cell img{max-width:100%;height:auto;border-radius:4px;margin:4px 0}
  .markdown-cell a{color:var(--brand);text-decoration:none}
  .markdown-cell a:hover{text-decoration:underline}
  .excel-table td .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .excel-table td .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table tr:hover td{background:#f0f7ff}
  .footer{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:18px 18px 18px;text-align:center}
  .footer p{margin:0;color:var(--muted);font-size:12px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;min-height:0;overflow-y:auto}
  .panel.left-panel{height:calc(100vh - 236px)}
  .panel.right-panel{height:calc(100vh - 236px);display:flex;flex-direction:column;flex:1;min-height:200px}
  .panel.copy-panel{flex:1;min-height:200px}
  .panel.button-panel{flex:0 0 auto;height:auto;min-height:auto;padding:12px 14px}
  h3{margin:0 0 8px;font-size:16px;color:var(--brand)}
  .preview{flex:1;overflow:auto;border:1px dashed #e5e7eb;border-radius:10px;padding:14px;background:#fff;min-height:0;overflow-y:auto;display:flex;flex-direction:column;height:100%;white-space:normal}
  .preview img{max-width:100%;display:block;margin:10px 0;border-radius:8px}
  .right{display:flex;flex-direction:column;gap:8px;height:calc(100vh - 236px)}
  .markdown-section{flex:4}
  textarea{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;font-family:ui-monospace,Menlo,monospace;resize:none;min-height:0;line-height:1.5}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:14px;transition:all 0.2s ease}
  .btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .btn-outline{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .btn-outline:hover{background:var(--brand);color:#fff}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-primary:hover{filter:brightness(.96)}
  .grid-full{grid-column:1/3}
  .muted{color:var(--muted);font-size:12px}
  .error{display:none;margin-bottom:10px;padding:8px 12px;border-radius:10px;background:#FEF2F2;border:1px solid #FCA5A5;color:var(--warn)}
  .tag{font-size:12px;color:#111;background:#eef2ff;border:1px solid #e0e7ff;border-radius:8px;padding:3px 8px}
  
    </style>
</head>
<body>
    <div class="header">
        <h1>MD 检查-kimi</h1>
        <div class="header-right">
            <div class="upload-section">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.xlsm,.csv" style="display:none" onchange="handleFileUpload(this)">
                <button class="upload-btn" onclick="document.getElementById('excelFile').click()">选择文件</button>
                <div id="fileInfo" class="file-info">未选择文件</div>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">等待检查</div>
            </div>
        </div>
    </div>
    
    <div class="query-section">
        <div class="query-display">
            <span class="query-label">当前检查项：</span>
            <span id="currentQuery" class="query-text">未设置</span>
        </div>
        <div class="navigation-buttons">
            <button class="nav-btn next-btn" onclick="nextQuery()">下一个</button>
            <button class="nav-btn prev-btn" onclick="previousQuery()">上一个</button>
        </div>
    </div>

    <div class="container">
        <div class="panel left-panel">
            <h3>答案 MD 渲染</h3>
            <div id="errorBox" class="error"></div>
            <div id="renderedPreview" class="preview" style="flex:1;min-height:400px;"></div>
        </div>

        <div class="panel right-panel">
            <div class="row">
                <h3 style="flex:1">MD内容输入</h3>
                <button class="btn btn-outline" onclick="clearLeft()">清空</button>
            </div>
            <textarea id="leftMarkdown" placeholder="从表格自动获取当前query的answer…"></textarea>
            <div class="muted" style="margin-top:6px">自动从表格获取当前query的answer内容。</div>
        </div>
    </div>
    
            
        </div>
    </div>
    
    <div class="excel-display-section" id="excelDisplaySection">
        <div class="excel-header">
            <h3>Excel 内容展示</h3>
            <div class="excel-header-buttons">
                <button class="download-btn" onclick="downloadExcel()" id="downloadBtn" style="display:none">下载Excel</button>
                <button class="close-btn" onclick="closeExcelDisplay()">×</button>
            </div>
        </div>
        <div class="excel-content" id="excelContent">
            <div class="no-file-message">
                <div class="no-file-icon">📄</div>
                <p>未上传文档</p>
                <div class="no-file-hint">请先上传Excel文件开始检查</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>MD 检查-kimi 工具 | 支持Excel数据导入和Markdown渲染预览</p>
    </div>

    <script>
// 全局变量
let extractedData = [];
let currentQueryIndex = 0;

// 文件上传处理
function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    document.getElementById('fileInfo').textContent = file.name;
    document.getElementById('progressText').textContent = '处理中...';
    document.getElementById('progressFill').style.width = '30%';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            // 处理数据
            processExcelData(jsonData);
            
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = '处理完成';
            
            setTimeout(() => {
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = '等待检查';
            }, 2000);
            
        } catch (error) {
            console.error('文件处理错误:', error);
            showMessage('文件处理失败: ' + error.message, 'warn');
            document.getElementById('progressText').textContent = '处理失败';
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// 处理Excel数据
function processExcelData(data) {
    if (data.length < 2) {
        showMessage('Excel文件数据不足', 'warn');
        return;
    }
    
    // 假设第一行是标题，从第二行开始是数据
    const headers = data[0];
    const rows = data.slice(1);
    
    extractedData = [];
    
    rows.forEach((row, index) => {
        if (row.length >= 4 && row[0] && row[3]) { // 确保有query和answer
            extractedData.push({
                queryCode: row[0] || `Q${index + 1}`,
                query: row[1] || '',
                answer: row[3] || '', // 第四列是answer
                rowIndex: index + 1
            });
        }
    });
    
    if (extractedData.length === 0) {
        showMessage('未找到有效数据', 'warn');
        return;
    }
    
    // 显示Excel内容
    displayExcelContent();
    
    // 切换到第一个query
    currentQueryIndex = 0;
    updateQueryDisplay();
    
    showMessage(`成功导入 ${extractedData.length} 条数据`, 'success');
}

// 显示Excel内容
function displayExcelContent() {
    const content = document.getElementById('excelContent');
    
    if (extractedData.length === 0) {
        content.innerHTML = `
            <div class="empty-message">
                <div class="empty-icon">📊</div>
                <h4>暂无数据</h4>
                <p>请上传包含有效数据的Excel文件</p>
            </div>
        `;
        return;
    }
    
    let tableHTML = `
        <table class="excel-table">
            <thead>
                <tr>
                    <th>编号</th>
                    <th>Query</th>
                    <th>Answer</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    extractedData.forEach((item, index) => {
        const isActive = index === currentQueryIndex ? 'style="background-color: #e3f2fd;"' : '';
        tableHTML += `
            <tr ${isActive}>
                <td><span class="clickable-query-code" onclick="switchToQuery(${index})">${item.queryCode}</span></td>
                <td>${item.query}</td>
                <td class="markdown-cell">${renderMarkdown(item.answer)}</td>
            </tr>
        `;
    });
    
    tableHTML += `
            </tbody>
        </table>
    `;
    
    content.innerHTML = tableHTML;
}

// 更新当前query显示
function updateQueryDisplay() {
    if (extractedData.length === 0) {
        document.getElementById('currentQuery').textContent = '未设置';
        document.getElementById('leftMarkdown').value = '';
        document.getElementById('renderedPreview').innerHTML = '<div class="muted" style="text-align: center; padding: 40px 20px;">等待上传Excel文件并选择检查项...</div>';
        return;
    }
    
    const currentData = extractedData[currentQueryIndex];
    document.getElementById('currentQuery').textContent = currentData.queryCode;
    document.getElementById('leftMarkdown').value = currentData.answer;
    
    // 更新渲染预览
    updateMergedMarkdownForCurrentQuery();
}

// 更新当前query的合并markdown
function updateMergedMarkdownForCurrentQuery() {
    if (extractedData.length === 0) return;
    
    const currentData = extractedData[currentQueryIndex];
    const leftMarkdown = currentData.answer;
    
    // 直接渲染leftMarkdown到预览区域
    const renderedContent = renderMarkdown(leftMarkdown);
    document.getElementById('renderedPreview').innerHTML = renderedContent;
}

// 切换到指定query
function switchToQuery(index) {
    if (index >= 0 && index < extractedData.length) {
        currentQueryIndex = index;
        updateQueryDisplay();
        displayExcelContent(); // 重新渲染表格以更新高亮
        showMessage(`切换到query: ${extractedData[index].queryCode}`, 'info');
    }
}

// 下一个query
function nextQuery() {
    if (currentQueryIndex < extractedData.length - 1) {
        currentQueryIndex++;
        updateQueryDisplay();
        displayExcelContent();
        showMessage(`切换到下一个query: ${extractedData[currentQueryIndex].queryCode}`, 'info');
    } else {
        showMessage('已经是最后一个query', 'info');
    }
}

// 上一个query
function previousQuery() {
    if (currentQueryIndex > 0) {
        currentQueryIndex--;
        updateQueryDisplay();
        displayExcelContent();
        showMessage(`切换到上一个query: ${extractedData[currentQueryIndex].queryCode}`, 'info');
    } else {
        showMessage('已经是第一个query', 'info');
    }
}

// 关闭Excel显示
function closeExcelDisplay() {
    extractedData = [];
    currentQueryIndex = 0;
    document.getElementById('excelContent').innerHTML = `
        <div class="no-file-message">
            <div class="no-file-icon">📄</div>
            <p>未上传文档</p>
            <div class="no-file-hint">请先上传Excel文件开始检查</div>
        </div>
    `;
    updateQueryDisplay();
    showMessage('已清空数据', 'info');
}

// 下载Excel
function downloadExcel() {
    if (extractedData.length === 0) {
        showMessage('没有数据可下载', 'warn');
        return;
    }
    
    // 创建工作簿
    const wb = XLSX.utils.book_new();
    
    // 准备数据
    const wsData = [
        ['Query Code', 'Query', 'Type', 'Answer'],
        ...extractedData.map(item => [item.queryCode, item.query, '', item.answer])
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'MD检查数据');
    
    // 下载文件
    XLSX.writeFile(wb, 'md_check_data.xlsx');
    showMessage('Excel文件已下载', 'success');
}

// 消息显示
function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    let backgroundColor = 'var(--brand)';
    
    if (type === 'warn') {
        backgroundColor = 'var(--warn)';
    } else if (type === 'success') {
        backgroundColor = 'var(--ok)';
    }
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${backgroundColor};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
    `;
    
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Markdown渲染函数
function renderMarkdown(md) {
    if (!md) return '';
    
    // 如果marked库可用，使用它
    if (typeof marked !== 'undefined') {
        try {
            return marked.parse(md);
        } catch (e) {
            console.warn('marked解析失败，使用本地渲染器:', e);
        }
    }
    
    // 本地渲染器
    return renderMarkdownLocal(md);
}

// 本地Markdown渲染器
function renderMarkdownLocal(md) {
    if (!md) return '';
    
    // 处理代码块
    md = md.replace(/```([^\n`]*)\n([\s\S]*?)```/g, (m, lang, code) => {
        return `<pre><code>${escapeHtml(code)}</code></pre>`;
    });
    
    // 处理图片 - 增强支持更多格式，添加错误处理
    md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
        console.log('Processing image:', {match, alt, src});
        
        // 检查是否是受保护的图片链接（如小红书、微博等）
        const protectedDomains = ['xiaohongshu.com', 'weibo.com', 'douyin.com', 'tiktok.com'];
        const isProtected = protectedDomains.some(domain => src.includes(domain));
        
        if (isProtected) {
            // 对于受保护的图片，显示链接和提示
            return `
                <div style="border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; margin: 10px 0;">
                    <div style="font-size: 24px; margin-bottom: 10px;">🖼️</div>
                    <div style="color: #666; margin-bottom: 10px;">图片无法直接显示</div>
                    <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${alt || '图片'}</div>
                    <a href="${src}" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none; font-size: 14px;">
                        🔗 点击查看原图
                    </a>
                </div>
            `;
        }
        
        // 普通图片正常渲染，但添加错误处理
        return `<img alt="${alt}" src="${src}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; margin: 10px 0;">
                <div style="font-size: 24px; margin-bottom: 10px;">🖼️</div>
                <div style="color: #666; margin-bottom: 10px;">图片加载失败</div>
                <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${alt || '图片'}</div>
                <a href="${src}" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none; font-size: 14px;">
                    🔗 点击查看原图
                </a>
            </div>`;
    });
    
    // 处理标题
    md = md.replace(/^#\s+(.*)$/gm, '<h1 class="markdown-h1">$1</h1>')
         .replace(/^##\s+(.*)$/gm, '<h2 class="markdown-h2">$1</h2>')
         .replace(/^###\s+(.*)$/gm, '<h3 class="markdown-h3">$1</h3>')
         .replace(/^####\s+(.*)$/gm, '<h4 class="markdown-h4">$1</h4>')
         .replace(/^#####\s+(.*)$/gm, '<h5 class="markdown-h5">$1</h5>')
         .replace(/^######\s+(.*)$/gm, '<h6 class="markdown-h6">$1</h6>');
  
    // 处理引用
    md = md.replace(/^\>\s?(.*)$/gm,'<blockquote class="markdown-blockquote">$1</blockquote>');
  
    // 处理水平线
    md = md.replace(/^---$/gm,'<hr class="markdown-hr">');
  
    // 处理无序列表 - 支持嵌套
    md = md.replace(/^(?:\s*[-*+]\s+.+(?:\n(?:\s{2,}[-*+]\s+.+)*)*)/gm, block => {
        const lines = block.trim().split(/\n/);
        const result = [];
        let currentLevel = 0;
        let currentList = [];
        let listStack = []; // 用于跟踪嵌套的列表层级
        
        for (const line of lines) {
            const match = line.match(/^(\s*)([-*+])\s+(.+)$/);
            if (match) {
                const [, indent, bullet, content] = match;
                const level = Math.floor(indent.length / 2);
                
                if (level > currentLevel) {
                    // 开始新的嵌套列表
                    if (currentList.length > 0) {
                        listStack.push(currentList);
                    }
                    currentList = [];
                    currentLevel = level;
                } else if (level < currentLevel) {
                    // 结束当前嵌套列表
                    if (currentList.length > 0) {
                        const nestedUl = `<ul class="markdown-ul">${currentList.join('')}</ul>`;
                        if (listStack.length > 0) {
                            listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedUl}</li>`);
                        } else {
                            result.push(nestedUl);
                        }
                    }
                    currentList = [];
                    currentLevel = level;
                }
                
                currentList.push(`<li class="markdown-li">${content}</li>`);
            }
        }
        
        // 处理剩余的列表项
        if (currentList.length > 0) {
            const finalUl = `<ul class="markdown-ul">${currentList.join('')}</ul>`;
            if (listStack.length > 0) {
                listStack[listStack.length - 1].push(`<li class="markdown-li">${finalUl}</li>`);
            } else {
                result.push(finalUl);
            }
        }
        
        // 处理所有嵌套的列表
        while (listStack.length > 0) {
            const nestedList = listStack.pop();
            const nestedUl = `<ul class="markdown-ul">${nestedList.join('')}</ul>`;
            if (listStack.length > 0) {
                listStack[listStack.length - 1].push(`<li class="markdown-li">${nestedUl}</li>`);
            } else {
                result.push(nestedUl);
            }
        }
        
        return result.join('');
    });
  
    // 处理有序列表 - 保留原始序号
    md = md.replace(/^(?:\s*\d+\.\s+.+\n?)+/gm, block=>{
        const items = block.trim().split(/\n/).map(l=>{
            const match = l.match(/^\s*(\d+)\.\s+(.+)$/);
            if (match) {
                const [, number, content] = match;
                return `<li class="markdown-li" value="${number}">${content}</li>`;
            }
            return '';
        }).filter(item => item.length > 0);
        return '<ol class="markdown-ol">' + items.join('') + '</ol>';
    });
  
    // 处理表格 - 精确匹配，不影响后续段落
    md = md.replace(/^(\|.+\|)\s*\n(\|[ :\-|]+\|)\s*\n((?:\|.*\|\s*\n?)*)/gm, (match, header, sep, body) => {
        // 确保分隔行包含足够的连字符
        if (!sep.match(/^[\s|]*[-:|\s]+[\s|]*$/)) {
            return match; // 不是有效的表格分隔行，返回原文本
        }
        
        const toRow = line => line.trim().replace(/^\||\|$/g, '').split('|').map(s => s.trim());
        
        const headers = toRow(header);
        const rows = body.trim().split(/\n/).filter(Boolean).map(toRow);
        
        const thead = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        const tbody = `<tbody>${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
        
        return `<table class="markdown-table">${thead}${tbody}</table>\n`;
    });
  
    // 处理行内代码
    md = md.replace(/`([^`]+)`/g,'<code class="markdown-code">$1</code>');
  
    // 处理段落
    return md.split(/\n/).map(l=>{
        if(/^<h\d|^<ul>|^<ol>|^<pre>|^<blockquote>|^<img|^<table|^<hr/.test(l)) return l;
        if(!l.trim()) return '';
        return '<p class="markdown-p">'+l+'</p>';
    }).join('\n');
}

// HTML转义函数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 工具函数
function sanitize(s){return (s||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');}

/* ---------- 交互 ---------- */
function showError(msg){ const b=document.getElementById('errorBox'); b.textContent=msg||''; b.style.display=msg?'block':'none'; }
function clearLeft(){ document.getElementById('leftMarkdown').value=''; mergeNow(); }

function mergeNow(){
  try{
    const left  = sanitize(document.getElementById('leftMarkdown').value||'');

    console.log('mergeNow called with left:', left.substring(0, 100) + '...');

    if(!left.trim()){
      document.getElementById('renderedPreview').innerHTML='';
      showError('');
      return;
    }

    const rendered = renderMarkdown(left);
    document.getElementById('renderedPreview').innerHTML = rendered;
    showError('');
  }catch(e){
    console.error('mergeNow error:', e);
    showError('渲染出错: ' + e.message);
  }
}

// 这些函数已经在上面定义了，这里移除重复定义

document.addEventListener('DOMContentLoaded', ()=>{
  console.log('Setting initial tip content');
  document.getElementById('renderedPreview').innerHTML = '<div class="muted" style="text-align: center; padding: 40px 20px;">等待上传Excel文件并选择检查项...</div>';
  document.getElementById('leftMarkdown').addEventListener('input', mergeNow);
  
  // 初始化显示
  updateQueryDisplay();
});
    </script>
</body>
</html>
