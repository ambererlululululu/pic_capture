<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Markdown åˆå¹¶ Â· å¥å°¾é”šç‚¹ Â· æ–‡åæŒ‚å›¾ï¼ˆä¸æ”¹å­—ï¼‰</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- å¤‡ç”¨ï¼šCDN æ ‡è®°åº“ï¼Œå¦‚æœä¸å¯ç”¨åˆ™é™çº§åˆ°æœ¬åœ° renderMarkdown -->
<script>
  (function(){
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js';
    s.onload = function(){ console.log('marked loaded'); };
    s.onerror = function(){ console.warn('marked CDN load failed, using local renderer'); };
    document.head.appendChild(s);
  })();
</script>
    <style>
  :root{--bg:#f6f7fb;--card:#fff;--txt:#111;--muted:#6b7280;--brand:#2563eb;--ok:#10b981;--warn:#b91c1c}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;min-height:100vh;color:var(--txt);display:flex;flex-direction:column}
  .header{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:18px 18px 0;display:flex;justify-content:space-between;align-items:center}
  .header h1{margin:0;font-size:24px;color:var(--brand)}
  .header p{margin:8px 0 0;color:var(--muted);font-size:14px}
  .header-right{display:flex;align-items:center;gap:20px}
  .query-section{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:15px 18px;margin:0 18px;display:flex;flex-direction:column;gap:12px}
  .query-display{display:flex;align-items:center;gap:10px}
  .link-display{display:flex;align-items:center;gap:10px}
  .query-label{font-size:16px;color:var(--muted);font-weight:600}
  .query-text{font-size:16px;color:var(--txt);background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:8px 12px;flex:1;min-width:200px;font-weight:500}
  .copy-btn{background:var(--brand);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;transition:all 0.2s ease}
  .copy-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .navigation-buttons{display:flex;gap:10px;justify-content:center}
  .nav-btn{background:#f8f9fa;color:var(--txt);border:1px solid #e9ecef;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:14px;transition:all 0.2s ease;flex:1;min-width:80px}
  .nav-btn:hover{background:#e9ecef;transform:translateY(-1px)}
  .prev-btn{border-color:var(--brand);color:var(--brand)}
  .prev-btn:hover{background:var(--brand);color:#fff}
  .next-btn{border-color:var(--ok);color:var(--ok)}
  .next-btn:hover{background:var(--ok);color:#fff}
  .upload-section{display:flex;align-items:center;gap:15px}
  .upload-btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 20px;cursor:pointer;font-size:14px;transition:all 0.2s ease}
  .upload-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .file-info{background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--muted);width:200px;min-height:20px;transition:all 0.2s ease}
  .progress-section{display:flex;align-items:center;gap:15px;justify-content:flex-end}
  .progress-bar{width:180px;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--brand),var(--ok));width:0%;transition:width 0.3s ease;border-radius:4px}
  .progress-text{font-size:12px;color:var(--muted);min-width:70px;text-align:right}
  .container{display:grid;grid-template-columns:1fr 2fr;gap:8px;padding:18px;flex:1}
  .excel-display-section{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:0 18px;display:flex;flex-direction:column}
  .excel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e9ecef}
  .excel-header h3{margin:0;font-size:18px;color:var(--brand)}
  .excel-header-buttons{display:flex;align-items:center;gap:10px}
  .download-btn{background:var(--ok);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;transition:all 0.2s ease}
  .download-btn:hover{filter:brightness(.96);transform:translateY(-1px)}
  .close-btn{background:none;border:none;font-size:24px;color:var(--muted);cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s ease}
  .close-btn:hover{background:#f8f9fa;color:var(--warn)}
  .excel-content{flex:1;overflow:auto;max-height:400px}
  .no-file-message{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--muted)}
  .no-file-icon{font-size:48px;margin-bottom:15px;opacity:0.6}
  .no-file-message p{margin:0 0 8px;font-size:18px;color:var(--txt)}
  .no-file-hint{font-size:14px;color:var(--muted)}
  .file-info-display{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center}
  .file-info-icon{font-size:48px;margin-bottom:15px;opacity:0.8}
  .file-info-display h4{margin:0 0 20px;font-size:20px;color:var(--brand)}
  .file-details{background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;min-width:300px}
  .file-details p{margin:0 0 10px;font-size:14px;color:var(--txt)}
  .file-details p:last-child{margin-bottom:0}
  .processing-note{background:#e3f2fd;border:1px solid #bbdefb;border-radius:8px;padding:15px;color:var(--brand)}
  .processing-note p{margin:0 0 5px;font-size:16px;font-weight:500}
  .processing-note span{font-size:14px;opacity:0.8}
  .error-message{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center;color:var(--warn)}
  .error-icon{font-size:48px;margin-bottom:15px}
  .error-message h4{margin:0 0 10px;font-size:18px;color:var(--warn)}
  .error-message p{margin:0;font-size:14px;color:var(--muted)}
  .empty-message{display:flex;flex-direction:column;align-items:center;padding:30px 20px;text-align:center;color:var(--muted)}
  .empty-icon{font-size:48px;margin-bottom:15px;opacity:0.6}
  .empty-message h4{margin:0 0 10px;font-size:18px;color:var(--txt)}
  .empty-message p{margin:0;font-size:14px;color:var(--muted)}
  .excel-table{width:100%;border-collapse:collapse;font-size:14px}
  .excel-table th,.excel-table td{border:1px solid #e9ecef;padding:8px 12px;text-align:left;vertical-align:top}
  .excel-table th{background:#f8f9fa;font-weight:600;color:var(--txt)}
  .excel-table td{background:#fff}
  .excel-table tr:nth-child(even) td{background:#fafafa}
  .markdown-cell{max-width:400px;word-wrap:break-word}
  .markdown-cell p{margin:0 0 8px;line-height:1.4}
  .markdown-cell p:last-child{margin-bottom:0}
  .markdown-cell img{max-width:100%;height:auto;border-radius:4px;margin:4px 0}
  .markdown-cell a{color:var(--brand);text-decoration:none}
  .markdown-cell a:hover{text-decoration:underline}
  
  /* å¢å¼ºçš„Markdownæ¸²æŸ“æ ·å¼ */
  .markdown-h1{font-size:28px;font-weight:700;color:var(--txt);margin:24px 0 16px;line-height:1.3;border-bottom:2px solid var(--brand);padding-bottom:8px}
  .markdown-h2{font-size:24px;font-weight:600;color:var(--txt);margin:20px 0 12px;line-height:1.4}
  .markdown-h3{font-size:20px;font-weight:600;color:var(--brand);margin:16px 0 10px;line-height:1.4}
  .markdown-h4{font-size:18px;font-weight:600;color:var(--txt);margin:14px 0 8px;line-height:1.4}
  .markdown-h5{font-size:16px;font-weight:600;color:var(--txt);margin:12px 0 6px;line-height:1.4}
  .markdown-h6{font-size:14px;font-weight:600;color:var(--muted);margin:10px 0 4px;line-height:1.4}
  .markdown-p{margin:8px 0;line-height:1.6;color:var(--txt)}
  .markdown-ul,.markdown-ol{margin:12px 0;padding-left:24px}
  .markdown-li{margin:6px 0;line-height:1.5;color:var(--txt)}
  .markdown-ul .markdown-li{list-style-type:disc}
  .markdown-ol .markdown-li{list-style-type:decimal}
  .markdown-blockquote{border-left:4px solid var(--brand);background:#f8f9fa;padding:12px 16px;margin:16px 0;border-radius:0 8px 8px 0;color:var(--muted);font-style:italic}
  .markdown-code{background:#f1f3f4;color:var(--warn);padding:2px 6px;border-radius:4px;font-family:ui-monospace,Menlo,monospace;font-size:0.9em}
  .preview .markdown-h1,.preview .markdown-h2,.preview .markdown-h3,.preview .markdown-h4,.preview .markdown-h5,.preview .markdown-h6,
  .preview .markdown-p,.preview .markdown-ul,.preview .markdown-ol,.preview .markdown-li,.preview .markdown-blockquote,.preview .markdown-code{color:inherit}
  .web-link{color:var(--brand);text-decoration:none;word-break:break-all}
  .web-link:hover{text-decoration:underline}
  .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .excel-table .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table td .clickable-query-code{color:#2563eb !important;text-decoration:underline !important;cursor:pointer !important}
  .excel-table td .clickable-query-code:hover{color:#1d4ed8 !important;text-decoration:underline !important}
  .excel-table tr:hover td{background:#f0f7ff}
  .footer{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px;margin:18px 18px 18px;text-align:center}
  .footer p{margin:0;color:var(--muted);font-size:12px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;min-height:0;overflow-y:auto}
  .panel.left-panel{height:calc(100vh - 236px)}
  .panel.right-panel{flex:1;min-height:200px}
  .panel.copy-panel{flex:1;min-height:200px}
  .panel.button-panel{flex:0 0 auto;height:auto;min-height:auto;padding:12px 14px}
  h3{margin:0 0 8px;font-size:16px;color:var(--brand)}
  .preview{flex:1;overflow:auto;border:1px dashed #e5e7eb;border-radius:10px;padding:14px;background:#fff;min-height:0;overflow-y:auto;display:flex;flex-direction:column;height:100%}
  .preview img{max-width:100%;display:block;margin:10px 0;border-radius:8px}
  .right{display:flex;flex-direction:column;gap:8px;height:calc(100vh - 236px)}
  .copy-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;flex:6}
  .markdown-section{flex:4}
  textarea{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;font-family:ui-monospace,Menlo,monospace;resize:none;min-height:0;line-height:1.5}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .btn{border:none;border-radius:10px;padding:8px 14px;background:var(--brand);color:#fff;cursor:pointer}
  .btn:hover{filter:brightness(.96)}
  .btn-outline{background:#fff;color:#374151;border:1px solid #d1d5db}
  .btn-ok{background:var(--ok)}
  .grid-full{grid-column:1/3}
  .muted{color:var(--muted);font-size:12px}
  .error{display:none;margin-bottom:10px;padding:8px 12px;border-radius:10px;background:#FEF2F2;border:1px solid #FCA5A5;color:var(--warn)}
  .tag{font-size:12px;color:#111;background:#eef2ff;border:1px solid #e0e7ff;border-radius:8px;padding:3px 8px}
    </style>
</head>
<body>
    <div class="header">
        <h1>Markdown å›¾ç‰‡åˆå¹¶å·¥å…·</h1>
        <div class="header-right">
            <div class="upload-section">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.xlsm,.csv" style="display:none" onchange="handleFileUpload(this)">
                <button class="upload-btn" onclick="document.getElementById('excelFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                <div id="fileInfo" class="file-info">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">ç­‰å¾…å¤„ç†</div>
            </div>
        </div>
    </div>
    
    <div class="query-section">
        <div class="query-display">
            <span class="query-label">å½“å‰ queryï¼š</span>
            <span id="currentQuery" class="query-text">æœªè®¾ç½®</span>
        </div>
        <div class="link-display">
            <button class="copy-btn" onclick="copyLink()">å¤åˆ¶</button>
            <span class="query-label">å½“å‰é“¾æ¥ï¼š</span>
            <span id="currentLink" class="query-text">æœªè®¾ç½®</span>
        </div>
        <div class="navigation-buttons">
            <button class="nav-btn next-btn" onclick="nextQuery()">ä¸‹ä¸€ä¸ª</button>
            <button class="nav-btn prev-btn" onclick="previousQuery()">ä¸Šä¸€ä¸ª</button>
        </div>
    </div>

    <div class="container">
            <div class="panel left-panel">
    <h3>åˆå¹¶åçš„æ¸²æŸ“</h3>
    <div id="errorBox" class="error"></div>
    <div id="renderedPreview" class="preview" style="flex:1;min-height:400px;"></div>
            </div>

  <div class="right">
    <div class="copy-row">
            <div class="panel copy-panel">
      <div class="row">
        <h3 style="flex:1">å¤åˆ¶ 1ï¼ˆæ–‡æœ¬ä¸€ / åŸºçº¿ï¼‰</h3>
        <button class="btn btn-outline" onclick="clearLeft()">æ¸…ç©º</button>
            </div>
      <textarea id="leftMarkdown" placeholder="ç²˜è´´ã€æ–‡æœ¬ä¸€ã€‘ï¼ˆæœ€ç»ˆè¾“å‡ºå°†é€å­—ä¿æŒä¸€è‡´ï¼Œä¸æ”¹ä»»ä½•å­—ï¼‰â€¦"></textarea>
      <div class="muted" style="margin-top:6px">ä»…æ’å…¥å›¾ç‰‡è¡Œï¼›æ–‡å­—ä¸€å­—ä¸æ”¹ã€‚å›¾ç‰‡å§‹ç»ˆæ’åœ¨å¯¹åº”å¥å­çš„<strong>ä¸‹ä¸€è¡Œ</strong>ã€‚</div>
            </div>

    <div class="panel copy-panel">
      <div class="row">
        <h3 style="flex:1">å¤åˆ¶ 2ï¼ˆæ–‡æœ¬äºŒ / åŸæ–‡+å›¾ç‰‡ï¼‰</h3>
        <button class="btn btn-outline" onclick="clearRight()">æ¸…ç©º</button>
                </div>
      <textarea id="rightMarkdown" placeholder="ç²˜è´´ã€æ–‡æœ¬äºŒã€‘ï¼šä¸€æ®µæ–‡å­— â†’ ä¸€å¼ /å‡ å¼ å›¾ â†’ ä¸‹ä¸€æ®µæ–‡å­—â€¦ï¼ˆæ— éœ€ captionï¼‰"></textarea>
      <div class="muted" style="margin-top:6px">ç®—æ³•åªæŒ‰é¡ºåºä¸å¥å°¾åŒ¹é…ï¼Œä¸ä¾èµ–å…³é”®è¯æˆ– captionã€‚</div>
            </div>
    </div>
            
    <div class="panel right-panel markdown-section">
      <div class="row" style="align-items:center;margin-bottom:6px;gap:12px">
        <h3 style="margin:0">åˆå¹¶åçš„ Markdown</h3>
        <button class="btn btn-ok" onclick="copyMerged()">å¤åˆ¶åˆå¹¶ç»“æœ</button>
        <label class="tag">æ¨¡å¼ï¼šå¥å°¾é”šç‚¹ï¼ˆå›ºå®šï¼‰</label>
      </div>
      <textarea id="mergedMarkdown" placeholder="ç»“æœä¼šå‡ºç°åœ¨è¿™é‡Œâ€¦"></textarea>
    </div>
        </div>
    </div>
    
    <div class="excel-display-section" id="excelDisplaySection">
        <div class="excel-header">
            <h3>Excel å†…å®¹å±•ç¤º</h3>
            <div class="excel-header-buttons">
                <button class="download-btn" onclick="downloadExcel()" id="downloadBtn" style="display:none">ä¸‹è½½Excel</button>
                <button class="close-btn" onclick="closeExcelDisplay()">Ã—</button>
            </div>
        </div>
        <div class="excel-content" id="excelContent">
            <div class="no-file-message">
                <div class="no-file-icon">ğŸ“„</div>
                <p>æœªä¸Šä¼ æ–‡æ¡£</p>
                <span class="no-file-hint">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œä¸Šä¼ </span>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Â© 2025 Pic Capture Â· åŸºäºå¥å°¾é”šç‚¹çš„æ™ºèƒ½Markdownåˆå¹¶å·¥å…·</p>
    </div>

    <script>
/* ---------- Markdown é¢„è§ˆï¼ˆç®€å•æ¸²æŸ“ï¼‰ ---------- */
function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function renderMarkdown(md){
  if(!md) return '';
  
  // å¤„ç†ä»£ç å—
  md = md.replace(/```([^`\n]*)\n([\s\S]*?)```/g,(m,lang,code)=>'<pre><code>'+escapeHtml(code)+'</code></pre>');
  
  // å¤„ç†å›¾ç‰‡ - å¢å¼ºæ”¯æŒæ›´å¤šæ ¼å¼
  md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
    console.log('Processing image:', {match, alt, src});
    return `<img alt="${alt}" src="${src}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
  });
  
  // å¤„ç†é“¾æ¥
  md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  
  // å¤„ç†ç²—ä½“å’Œæ–œä½“
  md = md.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\*([^*]+)\*/g,'<em>$1</em>');
  
  // å¤„ç†æ ‡é¢˜ - å¢å¼ºæ ·å¼
  md = md.replace(/^######\s+(.*)$/gm,'<h6 class="markdown-h6">$1</h6>')
         .replace(/^#####\s+(.*)$/gm,'<h5 class="markdown-h5">$1</h5>')
         .replace(/^####\s+(.*)$/gm,'<h4 class="markdown-h4">$1</h4>')
         .replace(/^###\s+(.*)$/gm,'<h3 class="markdown-h3">$1</h3>')
         .replace(/^##\s+(.*)$/gm,'<h2 class="markdown-h2">$1</h2>')
         .replace(/^#\s+(.*)$/gm,'<h1 class="markdown-h1">$1</h1>');
  
  // å¤„ç†å¼•ç”¨
  md = md.replace(/^\>\s?(.*)$/gm,'<blockquote class="markdown-blockquote">$1</blockquote>');
  
  // å¤„ç†æ— åºåˆ—è¡¨ - å¢å¼ºæ ·å¼
  md = md.replace(/^(?:\s*[-*+]\s+.+\n?)+/gm, block=>{
    const items = block.trim().split(/\n/).map(l=>l.replace(/^\s*[-*+]\s+/,'').trim());
    return '<ul class="markdown-ul">' + items.map(it=>'<li class="markdown-li">'+it+'</li>').join('') + '</ul>';
  });
  
  // å¤„ç†æœ‰åºåˆ—è¡¨ - å¢å¼ºæ ·å¼
  md = md.replace(/^(?:\s*\d+\.\s+.+\n?)+/gm, block=>{
    const items = block.trim().split(/\n/).map(l=>l.replace(/^\s*\d+\.\s+/,'').trim());
    return '<ol class="markdown-ol">' + items.map(it=>'<li class="markdown-li">'+it+'</li>').join('') + '</ol>';
  });
  
  // å¤„ç†è¡Œå†…ä»£ç 
  md = md.replace(/`([^`]+)`/g,'<code class="markdown-code">$1</code>');
  
  // å¤„ç†æ®µè½
  return md.split(/\n/).map(l=>{
    if(/^<h\d|^<ul>|^<ol>|^<pre>|^<blockquote>|^<img/.test(l)) return l;
    if(!l.trim()) return '';
    return '<p class="markdown-p">'+l+'</p>';
  }).join('\n');
}

/* ---------- åŸºç¡€å·¥å…· ---------- */
const IMG_MD_LINE=/!\[[^\]]*\]\(([^)]+)\)/;
const IMG_URL=/\(([^)]+)\)/;
function sanitize(s){return (s||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');}
function norm(s){
  return (s||'')
    .replace(/\s+/g,'')                // å»æ‰€æœ‰ç©ºç™½
    .replace(/[""]/g,'"')
    .replace(/['']/g,"'")
    .replace(/ï¼Œ/g,',').replace(/ã€‚/g,'.').replace(/ï¼/g,'!').replace(/ï¼Ÿ/g,'?')
    .replace(/ï¼š/g,':').replace(/ï¼›/g,';').replace(/ï¼ˆ/g,'(').replace(/ï¼‰/g,')');
}

/* å°†æ–‡æœ¬äºŒåˆ‡æˆï¼šæ–‡å­—å— / å›¾ç‰‡å—ï¼ˆä¿æŒé¡ºåºï¼‰ï¼›ä¸çœ‹ caption */
function parseText2Blocks(text2){
  const lines=sanitize(text2).split('\n');
  const blocks=[]; let txt=[], imgs=[];
  const flushTxt=()=>{ const raw = txt.join('\n'); if(raw.replace(/\s+/g,'').length>0) blocks.push({type:'txt', raw}); txt=[]; };
  const flushImgs=()=>{ if(imgs.length>0) blocks.push({type:'imgs', urls:imgs.slice()}); imgs=[]; };

  for(const line of lines){
    const t=line.trim();
    if(IMG_MD_LINE.test(t)){
      flushTxt();
      const m=t.match(IMG_URL); const url=m?m[1].trim():'';
      if(url) imgs.push(url);
    }else{
      if(imgs.length) flushImgs();
      txt.push(line);
    }
  }
  flushTxt(); flushImgs();
  return blocks;
}

/* åœ¨æ–‡æœ¬ä¸€ï¼ˆé€è¡Œï¼‰é‡Œï¼Œç”¨"æœ€åä¸€å¥"æŸ¥æ‰¾å‡†ç¡®çš„é”šç‚¹è¡Œ */
function findAnchorLineIndex(text1Lines, fromIndex, paragraphRaw){
  const p = sanitize(paragraphRaw);
  // å–æœ€åä¸€å¥ï¼ˆæŒ‰å¸¸è§ä¸­æ–‡/è‹±æ–‡å¥æœ«åˆ†éš”ï¼‰
  const sentences = p.split(/(?<=[ã€‚ï¼ï¼Ÿ?!])\s*|\n/).map(s=>s.trim()).filter(s=>s.length>0);
  const last = sentences.length ? sentences[sentences.length-1] : p.trim();
  const lastNorm = norm(last);
  const linesNorm = text1Lines.map(norm);

  // 1) ç›´æ¥åŒ…å«åŒ¹é…ï¼šä» fromIndex å¼€å§‹å‘åæ‰¾ï¼Œä¼˜å…ˆä¿è¯é¡ºåº
  for(let i=fromIndex;i<linesNorm.length;i++){
    if(lastNorm && linesNorm[i].includes(lastNorm)) return i;
  }
  // 2) å…¨å±€å…œåº•ï¼šæ•´ç¯‡å†…ä»»æ„åŒ…å«ï¼ˆé¿å… fromIndex åç§»å¯¼è‡´æ¼åŒ¹é…ï¼‰
  for(let i=0;i<linesNorm.length;i++){
    if(lastNorm && linesNorm[i].includes(lastNorm)) return i;
  }
  // 3) å–æœ«å°¾å­ä¸²ï¼ˆé•¿åº¦ä» 30 é™åˆ° 12ï¼‰ï¼ŒåšåŒ…å«åŒ¹é…
  const base = norm(paragraphRaw);
  for(let L=30; L>=12; L-=3){
    if(base.length<L) continue;
    const sub = base.slice(-L);
    for(let i=fromIndex;i<linesNorm.length;i++){
      if(linesNorm[i].includes(sub)) return i;
    }
    for(let i=0;i<linesNorm.length;i++){
      if(linesNorm[i].includes(sub)) return i;
    }
  }
  // 4) å…œåº•ï¼šè¿”å› fromIndex ä¹‹åçš„æœ€è¿‘éç©ºè¡Œï¼›å¦‚æ— åˆ™æœ€åä¸€ä¸ªéç©ºè¡Œ
  for(let i=fromIndex;i<text1Lines.length;i++){
    if(text1Lines[i].trim()) return i;
  }
  for(let i=text1Lines.length-1;i>=0;i--){
    if(text1Lines[i].trim()) return i;
  }
  return 0;
}

/* ä¸»åˆå¹¶ï¼šæŒ‰"å¥å°¾é”šç‚¹ â†’ æ–‡åæŒ‚å›¾"ï¼Œæ–‡æœ¬ä¸€ä¸€å­—ä¸æ”¹ */
function mergeBySentenceAnchor(text1, text2){
  const t1raw = sanitize(text1);
  const t1lines = t1raw.split('\n');
  const plan = new Map(); // anchorLine -> [urls]
  const blocks = parseText2Blocks(text2);

  let fromIndex = 0;      // ä¸ºä¿è¯é¡ºåºï¼Œä¸‹ä¸€æ¬¡ä¼˜å…ˆä»è¿™é‡Œå¾€åæ‰¾
  let lastAnchor = null;  // æœ€è¿‘ä¸€æ¬¡æ–‡å­—é”šç‚¹

  for(const b of blocks){
    if(b.type==='txt'){
      // æ›´æ–°"æœ€è¿‘ä¸€æ¬¡æ–‡å­—é”šç‚¹"
      const i = findAnchorLineIndex(t1lines, fromIndex, b.raw);
      lastAnchor = i;
      fromIndex = Math.max(i, fromIndex); // å‘å‰æ¨è¿›
    }else if(b.type==='imgs'){
      // å°†æ•´ç»„å›¾ç‰‡æŒ‚åˆ°"æœ€è¿‘ä¸€æ¬¡æ–‡å­—é”šç‚¹"ä¹‹åï¼›è‹¥è¿˜æ²¡è§åˆ°æ–‡å­—ï¼Œåˆ™æŒ‚åˆ°å…¨æ–‡ç¬¬ä¸€å¤„éç©ºè¡Œä¹‹å
      let i = (lastAnchor!=null) ? lastAnchor : findAnchorLineIndex(t1lines, 0, '');
      if(!plan.has(i)) plan.set(i,[]);
      plan.get(i).push(...b.urls);
    }
  }

  // ç”Ÿæˆè¾“å‡ºï¼šåªåœ¨é”šç‚¹è¡Œä¹‹åæ’å…¥å›¾ç‰‡è¡Œï¼›æ–‡æœ¬ä¸€åŸæ ·ä¸æ”¹
  const out=[];
  for(let i=0;i<t1lines.length;i++){
    out.push(t1lines[i]);
    if(plan.has(i)){
      const urls = plan.get(i);
      for(const u of urls) out.push(`![](${u})`);
    }
  }
  const merged = out.join('\n');

  // æ ¡éªŒï¼šæŠŠå›¾ç‰‡è¡Œå»æ‰åï¼Œåº”è¯¥ä¸æ–‡æœ¬ä¸€é€å­—ç›¸åŒ
  const stripped = merged.split('\n').filter(l=>!IMG_MD_LINE.test(l.trim())).join('\n');
  const same = (stripped === t1raw);

  return { merged, same };
}

/* ---------- æ–‡ä»¶ä¸Šä¼ å’Œè¿›åº¦æ¡ ---------- */
        function handleFileUpload(input) {
            const file = input.files[0];
            const fileInfo = document.getElementById('fileInfo');
            
            if (file) {
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                fileInfo.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileInfo.style.color = 'var(--ok)';
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¯è§£æçš„è¡¨æ ¼æ–‡ä»¶
                const lower = file.name.toLowerCase();
                if (/(\.xlsx|\.xls|\.xlsm|\.csv)$/.test(lower)) {
                    // å¤„ç†Excelæ–‡ä»¶ï¼ˆä¸æ˜¾ç¤ºè¿›åº¦æ¡ï¼‰
                    processExcelFile(file);
                } else {
                    alert('è¯·é€‰æ‹©è¡¨æ ¼æ–‡ä»¶ (.xlsx/.xls/.xlsm/.csv)');
                    fileInfo.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                    fileInfo.style.color = 'var(--muted)';
                }
            } else {
                fileInfo.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                fileInfo.style.color = 'var(--muted)';
            }
        }

function simulateProgress() {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressFill.style.width = progress + '%';
        
        if (progress < 30) {
            progressText.textContent = 'æ­£åœ¨å¤åˆ¶é¢˜ç›®...';
        } else if (progress < 60) {
            progressText.textContent = 'æ­£åœ¨å¤„ç†å†…å®¹...';
        } else if (progress < 90) {
            progressText.textContent = 'æ­£åœ¨åˆå¹¶æ•°æ®...';
        } else if (progress < 100) {
            progressText.textContent = 'å³å°†å®Œæˆ...';
        } else {
            progressText.textContent = 'å¤„ç†å®Œæˆ!';
            clearInterval(interval);
        }
    }, 200);
}

/* ---------- Query æ˜¾ç¤ºå’Œå¯¼èˆª ---------- */
let currentQueryIndex = 0;
let extractedData = []; // å­˜å‚¨ä»Excelæå–çš„queryå’Œé“¾æ¥æ•°æ®

function isMarkdownFormat(text) {
    if (!text || typeof text !== 'string') return false;
    // æ£€æŸ¥æ˜¯å¦åŒ…å«markdownæ ¼å¼çš„é“¾æ¥ [text](url)
    return /\[.*?\]\(.*?\)/.test(text) || text.includes('![') || text.includes('](');
}

function isWebLink(text) {
    if (!text || typeof text !== 'string') return false;
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘é¡µé“¾æ¥æ ¼å¼
    return /^https?:\/\/.+/.test(text.trim());
}

// æ–°å¢ï¼šæ£€æµ‹"æ··åˆæ ¼å¼"ï¼ˆé¦–è¡Œæ˜¯é“¾æ¥ï¼Œåç»­å«æœ‰Markdownå†…å®¹ï¼‰
function isHybridFormat(text) {
    if (!text || typeof text !== 'string') return false;
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    console.log('isHybridFormat - lines:', lines);
    if (lines.length < 2) return false;
    const firstIsLink = /^https?:\/\/.+/.test(lines[0]);
    console.log('isHybridFormat - firstIsLink:', firstIsLink, 'first line:', lines[0]);
    if (!firstIsLink) return false;
    // åç»­ä»»æ„ä¸€è¡ŒåŒ…å«markdownç»“æ„æˆ–éé“¾æ¥çš„æ­£æ–‡
    const rest = lines.slice(1).join('\n');
    const hasMarkdown = isMarkdownFormat(rest);
    const hasContent = /[\u4e00-\u9fa5A-Za-z0-9!\-*#`_\[\(]/.test(rest);
    console.log('isHybridFormat - rest content:', rest.substring(0, 100) + '...');
    console.log('isHybridFormat - hasMarkdown:', hasMarkdown, 'hasContent:', hasContent);
    return hasMarkdown || hasContent;
}

// æå–æ··åˆæ ¼å¼ä¸­çš„markdownæ­£æ–‡ï¼ˆå»æ‰é¦–è¡Œé“¾æ¥ï¼‰
function getHybridMarkdown(text) {
    if (!text || typeof text !== 'string') return '';
    const parts = text.split(/\r?\n/);
    console.log('getHybridMarkdown - parts length:', parts.length);
    if (parts.length <= 1) return '';
    const result = parts.slice(1).join('\n').trim();
    console.log('getHybridMarkdown - result length:', result.length, 'first 100 chars:', result.substring(0, 100));
    return result;
}

function extractDataFromExcel(excelData) {
    extractedData = [];
    
    if (!excelData || excelData.length === 0) {
        updateQueryDisplay();
        return;
    }
    
    console.log('å¼€å§‹æå–Excelæ•°æ®ï¼Œæ€»è¡Œæ•°:', excelData.length);
    
    // éå†æ‰€æœ‰è¡Œï¼ŒæŸ¥æ‰¾ç¬¬ä¸‰åˆ—ï¼ˆç´¢å¼•ä¸º2ï¼‰çš„æ•°æ®
    for (let i = 1; i < excelData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
        const row = excelData[i];
        if (row && row.length > 2) {
            const thirdColumn = row[2];
            // å¤„ç†ç½‘é¡µé“¾æ¥å’ŒMarkdownæ ¼å¼
            
            if (thirdColumn && (isWebLink(thirdColumn) || isMarkdownFormat(thirdColumn))) {
        // ç¬¬ä¸€åˆ—ï¼ˆç´¢å¼•ä¸º0ï¼‰æ˜¯queryç¼–ç ï¼Œç¬¬äºŒåˆ—ï¼ˆç´¢å¼•ä¸º1ï¼‰æ˜¯queryå†…å®¹ï¼Œç¬¬ä¸‰åˆ—æ˜¯é“¾æ¥
        const queryCode = row[0] || '';
        const query = row[1] || `æŸ¥è¯¢ ${extractedData.length + 1}`;
        const link = thirdColumn.trim();
        
        console.log('æå–åˆ°æ•°æ®:', { queryCode, query, link });
        
        extractedData.push({
            queryCode: queryCode,
            query: query,
            link: link,
            rowNumber: i,  // ä¿å­˜Excelä¸­çš„å®é™…è¡Œå·
            originalMarkdown: link  // ä¿å­˜åŸå§‹çš„markdownå†…å®¹
        });
            }
        }
    }
    
    console.log('æœ€ç»ˆæå–çš„æ•°æ®:', extractedData);
    
    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªéœ€è¦å¤„ç†çš„queryï¼ˆç¬¬ä¸‰åˆ—æ˜¯ç½‘ç«™é“¾æ¥æˆ–æ··åˆæ ¼å¼ï¼‰
    let firstUnprocessedIndex = -1;
    for (let i = 0; i < extractedData.length; i++) {
        const data = extractedData[i];
        if (data.link && (isWebLink(data.link) || isHybridFormat(data.link))) {
            firstUnprocessedIndex = i;
            break;
        }
    }
    
    // å¦‚æœæ‰¾åˆ°äº†éœ€è¦å¤„ç†çš„queryï¼Œé€‰æ‹©å®ƒï¼›å¦åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
    currentQueryIndex = firstUnprocessedIndex !== -1 ? firstUnprocessedIndex : 0;
    console.log('é€‰æ‹©çš„é»˜è®¤queryç´¢å¼•:', currentQueryIndex);
    updateQueryDisplay();
    // åŒæ­¥æ›´æ–°å¤åˆ¶åŒºï¼ˆä¸ç‚¹å‡»queryä¸€è‡´çš„é€»è¾‘ï¼‰
    updateMergedMarkdownForCurrentQuery();
}

function updateQueryDisplay() {
    console.log('updateQueryDisplay called');
    const queryText = document.getElementById('currentQuery');
    const linkText = document.getElementById('currentLink');
    console.log('queryText element:', queryText);
    console.log('linkText element:', linkText);
    
    if (extractedData.length === 0) {
        console.log('No extracted data, clearing display');
        if (queryText) queryText.textContent = '';
        if (linkText) linkText.textContent = '';
    } else if (currentQueryIndex >= 0 && currentQueryIndex < extractedData.length) {
        const queryCode = extractedData[currentQueryIndex].queryCode;
        const query = extractedData[currentQueryIndex].query;
        console.log('Setting query text to:', `${queryCode} ${query}`);
    if (queryText) {
        console.log('Before update - queryText.textContent:', queryText.textContent);
        queryText.textContent = `${queryCode} ${query}`;
        console.log('After update - queryText.textContent:', queryText.textContent);
        console.log('Query text updated successfully');
    } else {
        console.log('ERROR: queryText element not found!');
    }
        
        // æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹ï¼šæ··åˆ/é“¾æ¥æ˜¾ç¤ºé¦–è¡Œé“¾æ¥ï¼›çº¯Markdownä¸æ˜¾ç¤º
        const linkContent = extractedData[currentQueryIndex].link || '';
        console.log('Link content:', linkContent);
        console.log('Is web link:', isWebLink(linkContent));
        console.log('Is hybrid format:', isHybridFormat(linkContent));
        
        if (isWebLink(linkContent) || isHybridFormat(linkContent)) {
            const firstLine = (linkContent.split(/\r?\n/)[0] || '').trim();
            console.log('First line (link only):', firstLine);
            linkText.textContent = firstLine;
            linkText.style.color = 'var(--txt)';
            linkText.style.fontStyle = 'normal';
        } else if (isMarkdownFormat(linkContent)) {
            linkText.textContent = '';
            linkText.style.color = 'var(--txt)';
            linkText.style.fontStyle = 'normal';
        } else {
            linkText.textContent = linkContent;
            linkText.style.color = 'var(--txt)';
            linkText.style.fontStyle = 'normal';
        }
    } else {
        queryText.textContent = 'æœªè®¾ç½®';
        linkText.textContent = 'æœªè®¾ç½®';
    }
}

function copyQuery() {
    const queryText = document.getElementById('currentQuery').textContent;
    if (queryText && queryText !== 'æœªè®¾ç½®') {
        navigator.clipboard.writeText(queryText).then(() => {
            const copyBtn = document.querySelector('.query-display .copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'å·²å¤åˆ¶';
            copyBtn.style.background = 'var(--ok)';
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = 'var(--brand)';
            }, 1000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
        });
    }
}

function copyLink() {
    if (extractedData.length === 0 || currentQueryIndex < 0 || currentQueryIndex >= extractedData.length) {
        showMessage('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'warn');
        return;
    }
    
    const linkContent = extractedData[currentQueryIndex].link;
    if (linkContent) {
        navigator.clipboard.writeText(linkContent).then(() => {
            const copyBtn = document.querySelector('.link-display .copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'å·²å¤åˆ¶';
            copyBtn.style.background = 'var(--ok)';
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = 'var(--brand)';
            }, 1000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
        });
    } else {
        showMessage('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'warn');
    }
}

function previousQuery() {
    if (extractedData.length === 0) {
        showMessage('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'warn');
        return;
    }
    
    // æ‰¾åˆ°å‰ä¸€ä¸ªéœ€è¦å¤„ç†çš„queryï¼ˆé“¾æ¥æˆ–æ··åˆæ ¼å¼ï¼‰
    let prevIndex = -1;
    for (let i = currentQueryIndex - 1; i >= 0; i--) {
        const data = extractedData[i];
        if (data.link && (isWebLink(data.link) || isHybridFormat(data.link))) {
            prevIndex = i;
            break;
        }
    }
    
    if (prevIndex !== -1) {
        currentQueryIndex = prevIndex;
        updateQueryDisplay();
        // è·Ÿéšç‚¹å‡»è¡Œç­–ç•¥ï¼šè®¾ç½®å¤åˆ¶åŒºå¹¶ç”±åˆå¹¶é€»è¾‘è®¡ç®—
        updateMergedMarkdownForCurrentQuery();
    } else {
        showMessage('æ²¡æœ‰æ›´å¤šéœ€è¦å¤„ç†çš„æŸ¥è¯¢', 'info');
    }
}

function nextQuery() {
    if (extractedData.length === 0) {
        showMessage('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'warn');
        return;
    }
    
    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„queryï¼ˆé“¾æ¥æˆ–æ··åˆæ ¼å¼ï¼‰
    let nextIndex = -1;
    for (let i = currentQueryIndex + 1; i < extractedData.length; i++) {
        const data = extractedData[i];
        if (data.link && (isWebLink(data.link) || isHybridFormat(data.link))) {
            nextIndex = i;
            break;
        }
    }
    
    if (nextIndex !== -1) {
        currentQueryIndex = nextIndex;
        updateQueryDisplay();
        // è·Ÿéšç‚¹å‡»è¡Œç­–ç•¥ï¼šè®¾ç½®å¤åˆ¶åŒºå¹¶ç”±åˆå¹¶é€»è¾‘è®¡ç®—
        updateMergedMarkdownForCurrentQuery();
    } else {
        showMessage('æ²¡æœ‰æ›´å¤šéœ€è¦å¤„ç†çš„æŸ¥è¯¢', 'info');
    }
}

// ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
window.switchToQuery = function(dataIndex) {
    console.log('switchToQuery called with dataIndex:', dataIndex);
    console.log('extractedData length:', extractedData.length);
    console.log('extractedData:', extractedData);
    
    if (dataIndex < 0 || dataIndex >= extractedData.length) {
        console.log('Invalid dataIndex:', dataIndex);
        showMessage('æ— æ•ˆçš„queryç´¢å¼•', 'warn');
        return;
    }
    
    // æ›´æ–°å½“å‰queryç´¢å¼•
    currentQueryIndex = dataIndex;
    console.log('Updated currentQueryIndex to:', currentQueryIndex);
    
    // æ›´æ–°queryæ˜¾ç¤º
    console.log('Calling updateQueryDisplay...');
    updateQueryDisplay();
    console.log('updateQueryDisplay completed');
    
    // æ¸…ç©ºå¤åˆ¶ä¸€å’Œå¤åˆ¶äºŒ
    console.log('Clearing left and right markdown...');
    const leftMarkdown = document.getElementById('leftMarkdown');
    const rightMarkdown = document.getElementById('rightMarkdown');
    console.log('leftMarkdown element:', leftMarkdown);
    console.log('rightMarkdown element:', rightMarkdown);
    
    // è‡ªåŠ¨æ¸…ç©ºå¤åˆ¶ä¸€ã€å¤åˆ¶äºŒè¾“å…¥æ¡†
    clearInputPanels();
    console.log('Left and right markdown cleared');
    
    // æ ¹æ®å½“å‰queryçš„ç¬¬ä¸‰åˆ—å†…å®¹æ›´æ–°åˆå¹¶markdownæ˜¾ç¤º
    updateMergedMarkdownForCurrentQuery();
    
    const cd = extractedData[currentQueryIndex];
    if (cd) {
        showMessage(`å·²åˆ‡æ¢åˆ°query: ${cd.queryCode} ${cd.query}`, 'success');
    }
};

// è‡ªåŠ¨æ¸…ç©ºå¤åˆ¶ä¸€ã€å¤åˆ¶äºŒè¾“å…¥æ¡†çš„å‡½æ•°
function clearInputPanels() {
    const leftMarkdown = document.getElementById('leftMarkdown');
    const rightMarkdown = document.getElementById('rightMarkdown');
    
    if (leftMarkdown) {
        leftMarkdown.removeEventListener('input', mergeNow);
        leftMarkdown.value = '';
        leftMarkdown.addEventListener('input', mergeNow);
    }
    if (rightMarkdown) {
        rightMarkdown.removeEventListener('input', mergeNow);
        rightMarkdown.value = '';
        rightMarkdown.addEventListener('input', mergeNow);
    }
}

// æ ¹æ®å½“å‰queryçš„ç¬¬ä¸‰åˆ—å†…å®¹æ›´æ–°åˆå¹¶markdownæ˜¾ç¤º
function updateMergedMarkdownForCurrentQuery() {
    if (currentQueryIndex < 0 || currentQueryIndex >= extractedData.length) {
        console.log('updateMergedMarkdownForCurrentQuery - invalid index:', currentQueryIndex, 'length:', extractedData.length);
        return;
    }
    
    const currentData = extractedData[currentQueryIndex];
    if (!currentData) {
        console.log('updateMergedMarkdownForCurrentQuery - no data at index:', currentQueryIndex);
        return;
    }
    
    const mergedMarkdown = document.getElementById('mergedMarkdown');
    const renderedPreview = document.getElementById('renderedPreview');
    
    if (!mergedMarkdown || !renderedPreview) {
        console.log('updateMergedMarkdownForCurrentQuery - missing DOM elements');
        return;
    }
    
    // é“¾æ¥/æ··åˆ/çº¯Markdownï¼šä»…æ›´æ–°å¤åˆ¶åŒºï¼›åˆå¹¶åŒºç”± mergeNow åŸºäºå¤åˆ¶åŒºè®¡ç®—ï¼Œä¸å•ç‹¬æ¸…ç©º
    const left = document.getElementById('leftMarkdown');
    const right = document.getElementById('rightMarkdown');
    
    console.log('updateMergedMarkdownForCurrentQuery - currentData.link:', currentData.link);
    console.log('isHybridFormat:', isHybridFormat(currentData.link));
    console.log('isWebLink:', isWebLink(currentData.link));
    
    if (isHybridFormat(currentData.link)) {
        const markdownContent = getHybridMarkdown(currentData.link);
        console.log('Hybrid markdown content:', markdownContent);
        if (left) left.value = markdownContent;
        if (right) right.value = '';
    } else if (isWebLink(currentData.link)) {
        if (left) left.value = '';
        if (right) right.value = '';
    } else {
        // çº¯Markdownï¼šå·¦ä¾§æ”¾å…¥ç°æœ‰å†…å®¹ï¼Œå³ä¾§æ¸…ç©º
        if (left) left.value = currentData.link;
        if (right) right.value = '';
    }
    // ä¾æ®å¤åˆ¶åŒºå†…å®¹é‡æ–°è®¡ç®—åˆå¹¶åŒº
    if (typeof mergeNow === 'function') {
        mergeNow();
    }
}

// æ›´æ–°è¿›åº¦æ¡ï¼ŒåŸºäºç¬¬ä¸‰åˆ—ä¸­markdownæ ¼å¼çš„æ•°é‡
function updateProgressBar() {
    if (!window.excelData || window.excelData.length === 0) {
        return;
    }
    
    let totalRows = 0;
    let markdownRows = 0;
    
    // éå†æ‰€æœ‰è¡Œï¼Œç»Ÿè®¡ç¬¬ä¸‰åˆ—æ•°æ®
    for (let i = 1; i < window.excelData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
        const row = window.excelData[i];
        if (row && row.length > 2) {
            const thirdColumn = row[2];
            if (thirdColumn && (isWebLink(thirdColumn) || isMarkdownFormat(thirdColumn) || isHybridFormat(thirdColumn))) {
                totalRows++;
                // ä»…çº¯Markdownè®¡ä¸ºå·²å®Œæˆ
                if (isMarkdownFormat(thirdColumn) && !isHybridFormat(thirdColumn) && !isWebLink(thirdColumn)) {
                    markdownRows++;
                }
            }
        }
    }
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    if (totalRows > 0) {
        const percentage = Math.round((markdownRows / totalRows) * 100);
        progressFill.style.width = percentage + '%';
        progressText.textContent = `${markdownRows}/${totalRows} (${percentage}%)`;
    } else {
        progressFill.style.width = '0%';
        progressText.textContent = 'ç­‰å¾…å¤„ç†';
    }
}

function showMessage(message, type = 'info') {
    // åˆ›å»ºä¸´æ—¶æç¤ºæ¶ˆæ¯
    const messageDiv = document.createElement('div');
    let backgroundColor = 'var(--brand)';
    
    if (type === 'warn') {
        backgroundColor = 'var(--warn)';
    } else if (type === 'success') {
        backgroundColor = 'var(--ok)';
    }
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${backgroundColor};
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

// åˆå§‹åŒ–
updateQueryDisplay();

// åˆå§‹åŒ–Excelå±•ç¤ºåŒºåŸŸ
document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.querySelector('.close-btn');
    closeBtn.style.display = 'none'; // åˆå§‹éšè—å…³é—­æŒ‰é’®
});

/* ---------- Excel æ–‡ä»¶å¤„ç† ---------- */
function processExcelFile(file) {
    console.log('å¤„ç†Excelæ–‡ä»¶:', file.name);
    // è¿™é‡Œåº”è¯¥è§£æçœŸå®çš„Excelæ–‡ä»¶
    // ç›®å‰æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·åŠŸèƒ½å¼€å‘ä¸­
    setTimeout(() => {
        console.log('æ˜¾ç¤ºExcelæ–‡ä»¶ä¿¡æ¯');
        displayExcelFileInfo(file);
    }, 1000);
}

function displayExcelFileInfo(file) {
    const excelDisplaySection = document.getElementById('excelDisplaySection');
    const excelContent = document.getElementById('excelContent');
    const closeBtn = document.querySelector('.close-btn');
    
    // è§£æExcelæ–‡ä»¶å¹¶æ˜¾ç¤ºå†…å®¹
    parseExcelFile(file, excelContent, closeBtn, excelDisplaySection);
}

function parseExcelFile(file, excelContent, closeBtn, excelDisplaySection) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', dense: true, cellDates: true });
            
            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // è½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œä¿ç•™ç©ºå•å…ƒæ ¼
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            
            // æ˜¾ç¤ºè¡¨æ ¼å†…å®¹
            displayExcelTable(jsonData, excelContent, closeBtn, excelDisplaySection);
            
        } catch (error) {
            console.error('Excelè§£æé”™è¯¯:', error);
            excelContent.innerHTML = `
                <div class="error-message">
                    <div class="error-icon">âŒ</div>
                    <h4>æ–‡ä»¶è§£æå¤±è´¥</h4>
                    <p>æ— æ³•è§£æè¡¨æ ¼æ–‡ä»¶ï¼Œè¯·ç¡®è®¤ï¼š1) æ–‡ä»¶æœªæŸåï¼›2) ä½¿ç”¨ .xlsx/.xls/.xlsm/.csvï¼›3) éå—ä¿æŠ¤å¯†ç æ–‡ä»¶ã€‚</p>
                </div>
            `;
            closeBtn.style.display = 'flex';
        }
    };
    
    reader.onerror = function() {
        excelContent.innerHTML = `
            <div class="error-message">
                <div class="error-icon">âŒ</div>
                <h4>æ–‡ä»¶è¯»å–å¤±è´¥</h4>
                <p>æ— æ³•è¯»å–æ–‡ä»¶ï¼Œè¯·é‡è¯•</p>
            </div>
        `;
        closeBtn.style.display = 'flex';
    };
    
    reader.readAsArrayBuffer(file);
}

function displayExcelTable(data, excelContent, closeBtn, excelDisplaySection) {
    if (!data || data.length === 0) {
        excelContent.innerHTML = `
            <div class="empty-message">
                <div class="empty-icon">ğŸ“‹</div>
                <h4>è¡¨æ ¼ä¸ºç©º</h4>
                <p>Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®</p>
            </div>
        `;
        closeBtn.style.display = 'flex';
        return;
    }
    
    // ç”Ÿæˆè¡¨æ ¼HTML
    let tableHTML = '<table class="excel-table">';
    
    // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
    data.forEach((row, rowIndex) => {
        if (rowIndex === 0) {
            // ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
            tableHTML += '<thead><tr>';
            row.forEach(cell => {
                const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
                tableHTML += `<th>${cellValue}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
        } else {
            // æ•°æ®è¡Œ
            tableHTML += '<tr>';
            row.forEach((cell, cellIndex) => {
                const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
                
                // ç¬¬ä¸‰åˆ—ï¼ˆç´¢å¼•ä¸º2ï¼‰ç‰¹æ®Šå¤„ç†ï¼šæ”¯æŒMarkdownæ¸²æŸ“
                if (cellIndex === 2) {
                    if (isMarkdownFormat(cellValue)) {
                        // å¦‚æœæ˜¯Markdownæ ¼å¼ï¼Œè¿›è¡Œæ¸²æŸ“ï¼ˆä½¿ç”¨æœ¬åœ°æ¸²æŸ“å‡½æ•°ï¼Œé¿å…CDNä¾èµ–ï¼‰
                        const renderedContent = renderMarkdown(cellValue);
                        tableHTML += `<td class="markdown-cell">${renderedContent}</td>`;
                    } else if (isWebLink(cellValue)) {
                        // å¦‚æœæ˜¯ç½‘é¡µé“¾æ¥ï¼Œæ¸²æŸ“ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
                        tableHTML += `<td><a href="${cellValue}" target="_blank" class="web-link">${cellValue}</a></td>`;
                    } else {
                        // æ™®é€šæ–‡æœ¬
                        tableHTML += `<td>${cellValue}</td>`;
                    }
                } else {
                    // å…¶ä»–åˆ—æ­£å¸¸æ˜¾ç¤º
                    tableHTML += `<td>${cellValue}</td>`;
                }
            });
            tableHTML += '</tr>';
        }
    });
    
    tableHTML += '</tbody></table>';
    
    excelContent.innerHTML = tableHTML;
    closeBtn.style.display = 'flex';
    
    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.style.display = 'flex';
    
    // å­˜å‚¨Excelæ•°æ®åˆ°å…¨å±€å˜é‡
    window.excelData = data;
    
    // æå–queryå’Œé“¾æ¥æ•°æ®
    extractDataFromExcel(data);
    
    // åˆ·æ–°Excelæ˜¾ç¤º
    refreshExcelDisplay();
    // è¡¨æ ¼æ¸²æŸ“å®Œæˆåï¼Œä¹ŸåŒæ­¥åˆ·æ–°å¤åˆ¶åŒºï¼ˆé¿å…é¦–æ¬¡åŠ è½½æœªå†™å…¥ï¼‰
    setTimeout(() => {
        updateMergedMarkdownForCurrentQuery();
    }, 0);
    
    // æ›´æ–°è¿›åº¦æ¡
    updateProgressBar();
    
    // ä¸è‡ªåŠ¨æ»šåŠ¨åˆ°Excelå±•ç¤ºåŒºåŸŸ
    // excelDisplaySection.scrollIntoView({ behavior: 'smooth' });
}

function displayExcelContent(data) {
    const excelDisplaySection = document.getElementById('excelDisplaySection');
    const excelContent = document.getElementById('excelContent');
    const closeBtn = document.querySelector('.close-btn');
    
    // ç”Ÿæˆè¡¨æ ¼HTML
    let tableHTML = '<table class="excel-table">';
    
    // è¡¨å¤´
    tableHTML += '<thead><tr>';
    data.headers.forEach(header => {
        tableHTML += `<th>${header}</th>`;
    });
    tableHTML += '</tr></thead>';
    
    // è¡¨æ ¼å†…å®¹
    tableHTML += '<tbody>';
    data.rows.forEach((row, rowIndex) => {
        tableHTML += '<tr>';
        row.forEach((cell, cellIndex) => {
            const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
            
            // ç¬¬ä¸€åˆ—ï¼ˆç´¢å¼•ä¸º0ï¼‰ç‰¹æ®Šå¤„ç†ï¼šqueryç¼–ç å¯ç‚¹å‡»
            if (cellIndex === 0) {
                // æŸ¥æ‰¾å¯¹åº”çš„extractedDataç´¢å¼•ï¼Œä½¿ç”¨queryCodeåŒ¹é…
                const dataIndex = extractedData.findIndex(item => item.queryCode === cellValue);
                if (dataIndex !== -1) {
                    tableHTML += `<td><span class="clickable-query-code" onclick="switchToQuery(${dataIndex});">${cellValue}</span></td>`;
                } else {
                    tableHTML += `<td>${cellValue}</td>`;
                }
            }
            // ç¬¬ä¸‰åˆ—ï¼ˆç´¢å¼•ä¸º2ï¼‰ç‰¹æ®Šå¤„ç†ï¼šæ”¯æŒMarkdownæ¸²æŸ“
            else if (cellIndex === 2) {
                if (isMarkdownFormat(cellValue)) {
                    // å¦‚æœæ˜¯Markdownæ ¼å¼ï¼Œè¿›è¡Œæ¸²æŸ“ï¼ˆä½¿ç”¨æœ¬åœ°æ¸²æŸ“å‡½æ•°ï¼Œé¿å…CDNä¾èµ–ï¼‰
                    const renderedContent = renderMarkdown(cellValue);
                    tableHTML += `<td class="markdown-cell">${renderedContent}</td>`;
                } else if (isWebLink(cellValue)) {
                    // å¦‚æœæ˜¯ç½‘é¡µé“¾æ¥ï¼Œæ¸²æŸ“ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
                    tableHTML += `<td><a href="${cellValue}" target="_blank" class="web-link">${cellValue}</a></td>`;
                } else {
                    // æ™®é€šæ–‡æœ¬
                    tableHTML += `<td>${cellValue}</td>`;
                }
            } else {
                // å…¶ä»–åˆ—æ­£å¸¸æ˜¾ç¤º
                tableHTML += `<td>${cellValue}</td>`;
            }
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    
    excelContent.innerHTML = tableHTML;
    closeBtn.style.display = 'flex'; // æ˜¾ç¤ºå…³é—­æŒ‰é’®
    
    // ä¸è‡ªåŠ¨æ»šåŠ¨åˆ°Excelå±•ç¤ºåŒºåŸŸ
    // excelDisplaySection.scrollIntoView({ behavior: 'smooth' });
}

function closeExcelDisplay() {
    const excelContent = document.getElementById('excelContent');
    const closeBtn = document.querySelector('.close-btn');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // æ¢å¤ä¸ºæœªä¸Šä¼ çŠ¶æ€
    excelContent.innerHTML = `
        <div class="no-file-message">
            <div class="no-file-icon">ğŸ“„</div>
            <p>æœªä¸Šä¼ æ–‡æ¡£</p>
            <span class="no-file-hint">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œä¸Šä¼ </span>
        </div>
    `;
    closeBtn.style.display = 'none'; // éšè—å…³é—­æŒ‰é’®
    downloadBtn.style.display = 'none'; // éšè—ä¸‹è½½æŒ‰é’®
    
    // æ¸…ç©ºæå–çš„æ•°æ®
    extractedData = [];
    currentQueryIndex = 0;
    window.excelData = null;
    updateQueryDisplay();
}

function downloadExcel() {
    if (!window.excelData) {
        showMessage('æ²¡æœ‰å¯ä¸‹è½½çš„Excelæ•°æ®', 'warn');
        return;
    }
    
    try {
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // åˆ›å»ºå·¥ä½œè¡¨
        const ws = XLSX.utils.aoa_to_sheet(window.excelData);
        
        // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        
        // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `updated_excel_${timestamp}.xlsx`;
        
        // ä¸‹è½½æ–‡ä»¶
        XLSX.writeFile(wb, filename);
        
        showMessage('Excelæ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
    } catch (error) {
        console.error('ä¸‹è½½Excelå¤±è´¥:', error);
        showMessage('ä¸‹è½½Excelå¤±è´¥ï¼Œè¯·é‡è¯•', 'warn');
    }
}


/* ---------- äº¤äº’ ---------- */
function showError(msg){ const b=document.getElementById('errorBox'); b.textContent=msg||''; b.style.display=msg?'block':'none'; }
function clearLeft(){ document.getElementById('leftMarkdown').value=''; mergeNow(); }
function clearRight(){ document.getElementById('rightMarkdown').value=''; mergeNow(); }

function copyMerged(){
  const v=document.getElementById('mergedMarkdown').value||'';
  
  if (!v) {
    showMessage('æ²¡æœ‰å¯ä¿å­˜çš„åˆå¹¶ç»“æœ', 'warn');
    return;
  }
  
  if (extractedData.length === 0) {
    showMessage('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'warn');
    return;
  }
  
  if (currentQueryIndex < 0 || currentQueryIndex >= extractedData.length) {
    showMessage('å½“å‰æ²¡æœ‰é€‰ä¸­çš„query', 'warn');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç¡®è®¤è¦†ç›–
  const currentData = extractedData[currentQueryIndex];
  const isCurrentlyWebLink = isWebLink(currentData.link);
  const isCurrentlyHybrid = isHybridFormat(currentData.link);
  const isCurrentlyMarkdown = !isCurrentlyWebLink && !isCurrentlyHybrid && currentData.link && currentData.link.trim() !== '';
  
  if (isCurrentlyMarkdown) {
    // å¦‚æœå½“å‰å·²ç»æ˜¯markdownæ ¼å¼ï¼Œéœ€è¦ç¡®è®¤è¦†ç›–
    const confirmMessage = `å½“å‰query "${currentData.queryCode} ${currentData.query}" å·²æœ‰markdownå†…å®¹ï¼Œæ˜¯å¦ç”¨æ–°çš„å†…å®¹æ›¿æ¢ï¼Ÿ`;
    if (!confirm(confirmMessage)) {
      showMessage('æ“ä½œå·²å–æ¶ˆ', 'info');
      return;
    }
  }
  // å¦‚æœå½“å‰æ˜¯ç½‘ç«™é“¾æ¥æˆ–æ··åˆï¼Œç›´æ¥ä¿å­˜ï¼Œä¸éœ€è¦ç¡®è®¤
  
  // å¼€å§‹å¤„ç†è¿›åº¦æ¡
  simulateProgress();
  
  // å»¶è¿Ÿæ‰§è¡Œæ›´æ–°ï¼Œè®©è¿›åº¦æ¡æœ‰æ—¶é—´æ˜¾ç¤º
  setTimeout(() => {
    // æ›´æ–°å½“å‰queryå¯¹åº”çš„ç¬¬ä¸‰åˆ—æ•°æ®
    updateAnswerInExcel(currentQueryIndex, v);
  }, 1000);
}

function updateAnswerInExcel(queryIndex, markdownContent) {
  if (!window.excelData) {
    showMessage('Excelæ•°æ®ä¸å¯ç”¨', 'warn');
    return;
  }
  
  console.log('å¼€å§‹æ›´æ–°Excelæ•°æ®ï¼ŒqueryIndex:', queryIndex);
  console.log('å½“å‰extractedData:', extractedData);
  console.log('å½“å‰queryçš„link:', extractedData[queryIndex]?.link);
  
  // æ‰¾åˆ°å¯¹åº”çš„è¡Œå¹¶æ›´æ–°ç¬¬ä¸‰åˆ—ï¼ˆç´¢å¼•ä¸º2ï¼‰
  let updated = false;
  let foundRowIndex = -1;
  
  for (let i = 1; i < window.excelData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
    const row = window.excelData[i];
    if (row && row.length > 2) {
      const thirdColumn = row[2];
      console.log(`æ£€æŸ¥ç¬¬${i}è¡Œï¼Œç¬¬ä¸‰åˆ—å†…å®¹:`, thirdColumn);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰queryå¯¹åº”çš„é“¾æ¥
      if (thirdColumn && thirdColumn.trim() === extractedData[queryIndex].link) {
        console.log('æ‰¾åˆ°åŒ¹é…çš„è¡Œï¼Œå‡†å¤‡æ›´æ–°');
        // æ›´æ–°ç¬¬ä¸‰åˆ—ä¸ºåˆå¹¶åçš„markdownå†…å®¹
        row[2] = markdownContent;
        // åŒæ—¶æ›´æ–°extractedDataä¸­çš„linkå­—æ®µ
        extractedData[queryIndex].link = markdownContent;
        updated = true;
        foundRowIndex = i;
        break;
      }
    }
  }
  
  console.log('æ›´æ–°ç»“æœ:', updated, 'æ‰¾åˆ°çš„è¡Œç´¢å¼•:', foundRowIndex);
  
  if (updated) {
    // æ›´æ–°æ˜¾ç¤º
    refreshExcelDisplay();
    // æ›´æ–°å½“å‰é“¾æ¥æ˜¾ç¤º
    updateQueryDisplay();
    // æ›´æ–°è¿›åº¦æ¡
    updateProgressBar();
    showMessage('åˆå¹¶ç»“æœå·²ä¿å­˜åˆ°è¡¨æ ¼', 'success');
  } else {
    showMessage('æœªæ‰¾åˆ°å¯¹åº”çš„è¡Œè¿›è¡Œæ›´æ–°', 'warn');
  }
}

function refreshExcelDisplay() {
  if (!window.excelData) return;
  
  
  const excelContent = document.getElementById('excelContent');
  const closeBtn = document.querySelector('.close-btn');
  
  // é‡æ–°ç”Ÿæˆè¡¨æ ¼HTML
  let tableHTML = '<table class="excel-table">';
  
  // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
  window.excelData.forEach((row, rowIndex) => {
    if (rowIndex === 0) {
      // ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
      tableHTML += '<thead><tr>';
      row.forEach(cell => {
        const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
        tableHTML += `<th>${cellValue}</th>`;
      });
      tableHTML += '</tr></thead><tbody>';
    } else {
      // æ•°æ®è¡Œ
      tableHTML += '<tr>';
      row.forEach((cell, cellIndex) => {
        const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
        
        
        // ç¬¬ä¸€åˆ—ï¼ˆç´¢å¼•ä¸º0ï¼‰ç‰¹æ®Šå¤„ç†ï¼šqueryç¼–ç å¯ç‚¹å‡»
        if (cellIndex === 0) {
          // æŸ¥æ‰¾å¯¹åº”çš„extractedDataç´¢å¼•ï¼Œä½¿ç”¨queryCodeåŒ¹é…
          console.log('Looking for queryCode:', cellValue);
          console.log('Available queryCodes:', extractedData.map(item => item.queryCode));
          const dataIndex = extractedData.findIndex(item => item.queryCode === cellValue);
          console.log('Found dataIndex:', dataIndex);
          
          if (dataIndex !== -1) {
            // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°æ¥ä¿å­˜dataIndexçš„å€¼
            tableHTML += `<td><span class="clickable-query-code" onclick="(function(idx){switchToQuery(idx);})(${dataIndex});">${cellValue}</span></td>`;
          } else {
            // å¦‚æœåŒ¹é…å¤±è´¥ï¼Œä»ç„¶åˆ›å»ºå¯ç‚¹å‡»å…ƒç´ ï¼ˆä½¿ç”¨ç´¢å¼•0ä½œä¸ºé»˜è®¤ï¼‰
            console.log('No match found for:', cellValue, 'using index 0 as default');
            tableHTML += `<td><span class="clickable-query-code" onclick="switchToQuery(0);">${cellValue}</span></td>`;
          }
        }
        // ç¬¬ä¸‰åˆ—ï¼ˆç´¢å¼•ä¸º2ï¼‰ç‰¹æ®Šå¤„ç†ï¼šæ”¯æŒMarkdownæ¸²æŸ“
        else if (cellIndex === 2) {
          
          if (isMarkdownFormat(cellValue)) {
            // å¦‚æœæ˜¯Markdownæ ¼å¼ï¼Œè¿›è¡Œæ¸²æŸ“ï¼ˆä½¿ç”¨æœ¬åœ°æ¸²æŸ“å‡½æ•°ï¼Œé¿å…CDNä¾èµ–ï¼‰
            const renderedContent = renderMarkdown(cellValue);
            tableHTML += `<td class="markdown-cell">${renderedContent}</td>`;
          } else if (isWebLink(cellValue)) {
            // å¦‚æœæ˜¯ç½‘é¡µé“¾æ¥ï¼Œæ¸²æŸ“ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
            tableHTML += `<td><a href="${cellValue}" target="_blank" class="web-link">${cellValue}</a></td>`;
          } else {
            // æ™®é€šæ–‡æœ¬
            tableHTML += `<td>${cellValue}</td>`;
          }
        } else {
          // å…¶ä»–åˆ—æ­£å¸¸æ˜¾ç¤º
          tableHTML += `<td>${cellValue}</td>`;
        }
      });
      tableHTML += '</tr>';
    }
  });
  
  tableHTML += '</tbody></table>';
  
  excelContent.innerHTML = tableHTML;
  closeBtn.style.display = 'flex';
  
  // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
  const downloadBtn = document.getElementById('downloadBtn');
  downloadBtn.style.display = 'flex';
  
  console.log('Excelæ˜¾ç¤ºåˆ·æ–°å®Œæˆ');
}

function mergeNow(){
  try{
    const left  = sanitize(document.getElementById('leftMarkdown').value||'');
    const right = sanitize(document.getElementById('rightMarkdown').value||'');

    if(!left.trim()){
      document.getElementById('mergedMarkdown').value='';
      document.getElementById('renderedPreview').innerHTML='';
      showError('');
      return;
    }
    if(!right.trim()){
      document.getElementById('mergedMarkdown').value = left;
      document.getElementById('renderedPreview').innerHTML = renderMarkdown(left);
      showError('');
      return;
    }

    const { merged, same } = mergeBySentenceAnchor(left, right);
    if(!same){
      showError('âš ï¸ æ ¡éªŒæœªé€šè¿‡ï¼šå»æ‰å›¾ç‰‡åä¸ã€æ–‡æœ¬ä¸€ã€‘ä¸å®Œå…¨ä¸€è‡´ï¼ˆè¯·æ£€æŸ¥æ˜¯å¦è¯¯æ”¹äº†æ–‡æœ¬ä¸€çš„å­—/ç©ºæ ¼/ç©ºè¡Œï¼‰ã€‚');
    }else{
      showError('');
    }
    document.getElementById('mergedMarkdown').value = merged;
    document.getElementById('renderedPreview').innerHTML = renderMarkdown(merged);
  }catch(e){
    console.error(e);
    showError('è¿è¡Œå‡ºé”™ï¼š' + e.message);
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const tip = [
    '# ä½¿ç”¨è¯´æ˜ï½œå¥å°¾é”šç‚¹',
    '1) ä»¥ã€æ–‡æœ¬ä¸€ã€‘ä¸ºåŸºçº¿ï¼Œåªæ’å…¥å›¾ç‰‡è¡Œï¼Œä¸æ”¹ä»»ä½•å­—ï¼›',
    '2) æ¯ç»„å›¾ç‰‡æŒ‚åˆ°å®ƒå‰é¢é‚£æ®µæ–‡å­—çš„"æœ€åä¸€å¥"æ‰€åœ¨è¡Œçš„ä¸‹ä¸€è¡Œï¼›',
    '3) ä¸ä¾èµ– caption/å…³é”®è¯ï¼›ç”¨å¥å°¾åŒ¹é… + å­ä¸²å…œåº•å®šä½ï¼›',
    '4) è‹¥æ–‡æœ¬äºŒå¼€å¤´å°±æœ‰å›¾ï¼Œä¹Ÿä¼šæŒ‚åˆ°æ–‡æœ¬ä¸€ç¬¬ä¸€å¤„éç©ºè¡Œä¹‹åï¼›',
    '5) è‡ªå¸¦æ ¡éªŒï¼šå»å›¾åå¿…é¡»å’Œæ–‡æœ¬ä¸€å®Œå…¨ä¸€è‡´ã€‚'
  ].join('\n');
  console.log('Setting initial tip content');
  document.getElementById('renderedPreview').innerHTML = renderMarkdown(tip);
  document.getElementById('leftMarkdown').addEventListener('input', mergeNow);
  document.getElementById('rightMarkdown').addEventListener('input', mergeNow);
  document.getElementById('mergedMarkdown').addEventListener('input', ()=> {
    document.getElementById('renderedPreview').innerHTML = renderMarkdown(document.getElementById('mergedMarkdown').value||'');
  });
});
    </script>
</body>
</html>