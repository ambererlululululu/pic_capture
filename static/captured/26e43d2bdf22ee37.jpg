"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["16508"],{818289:function(e,t,a){a.d(t,{EventType:function(){return o}});var o={Message:1,Cmd:2,AppAction:3}},972057:function(e,t,a){a.d(t,{getAttachmentFromContentLinkModel:function(){return m},getAttachmentsFromContentFileModel:function(){return _},getAttachmentsFromContentImageModel:function(){return y},getAttachmentsFromContentRefImageModel:function(){return p},getAttachmentsFromImageContentEntities:function(){return g},getAttachmentsFromNestedContentEntities:function(){return v},getImageListFromAttachments:function(){return f},getReferencesFromExt:function(){return u}});var o=a(229079),n=a(4137),i=a(101874),s=a(778816),l=a(568388),r=a(165482),d=a(949932);let c={0:i.AttachmentEnum.Unknown,1:i.AttachmentEnum.File,2:i.AttachmentEnum.Image,3:i.AttachmentEnum.Directory,text:i.AttachmentEnum.Text,attachment:i.AttachmentEnum.File,link:i.AttachmentEnum.Link,image:i.AttachmentEnum.Image,directory:i.AttachmentEnum.Directory,vlm_image:i.AttachmentEnum.VlmImage,file:i.AttachmentEnum.File},u=e=>[...(0,r.parseJSON)((0,o.default)(e,["reference_content"]),[]).map(e=>({type:c[e.type],asrType:e.asrType,name:null==e?void 0:e.fileName,key:null==e?void 0:e.fileKey,url:null==e?void 0:e.link,link:null==e?void 0:e.link,content:null==e?void 0:e.text,extra:null==e?void 0:e.extra,identifier:null==e?void 0:e.identifier,option:null==e?void 0:e.option}))],v=(e,t)=>{let a={};return null==t||t.forEach(e=>{a[e.identifier]=e.fileName}),(null==e?void 0:e.map(e=>{var t,o,i,r,u,v,g,p,m,_,y,f,h,M,C,T,I,S,x,P,E,k,b,R,L,A,O,w,F,j,N,D,U,W,B,G,z,K,J,q,V,$,H,X,Y,Q,Z,ee,et,ea,eo,en,ei,es,el,er,ed,ec;if(e.entity_type===s.NestedMessageEntityType.Image){let t=(0,d.getFileExt)((null===(k=e.entity_content)||void 0===k?void 0:null===(E=k.image)||void 0===E?void 0:E.key)||"");return{type:c.vlm_image,identifier:e.identifier,name:a[e.identifier]||`image.${t}`,key:null===(R=e.entity_content)||void 0===R?void 0:null===(b=R.image)||void 0===b?void 0:b.key,url:null===(O=e.entity_content)||void 0===O?void 0:null===(A=O.image)||void 0===A?void 0:null===(L=A.image_ori)||void 0===L?void 0:L.url,file_review_state:null!==(W=e.file_name_state)&&void 0!==W?W:l.ReviewState.ReviewState_Processing,file_parse_state:null!==(B=e.file_parse_state)&&void 0!==B?B:l.ParseState.ParseState_Processing,option:{width:null===(j=e.entity_content)||void 0===j?void 0:null===(F=j.image)||void 0===F?void 0:null===(w=F.image_ori)||void 0===w?void 0:w.width,height:null===(U=e.entity_content)||void 0===U?void 0:null===(D=U.image)||void 0===D?void 0:null===(N=D.image_ori)||void 0===N?void 0:N.height}}}return e.entity_type===s.NestedMessageEntityType.Directory?{type:c.directory,identifier:e.identifier,name:null===(G=e.entity_content.directory)||void 0===G?void 0:G.name,key:e.identifier,url:"",file_review_state:null!==(z=e.file_name_state)&&void 0!==z?z:l.ReviewState.ReviewState_Processing,file_parse_state:null!==(K=e.file_parse_state)&&void 0!==K?K:l.ParseState.ParseState_Success}:[s.NestedMessageFileType.Audio,s.NestedMessageFileType.Video].includes(null===(o=e.entity_content)||void 0===o?void 0:null===(t=o.file)||void 0===t?void 0:t.file_type)?{type:s.NestedMessageFileType.Audio===(null===(q=e.entity_content)||void 0===q?void 0:null===(J=q.file)||void 0===J?void 0:J.file_type)?"audio":"video",identifier:e.identifier,name:null===($=e.entity_content)||void 0===$?void 0:null===(V=$.file)||void 0===V?void 0:V.file_name,key:null===(X=e.entity_content)||void 0===X?void 0:null===(H=X.file)||void 0===H?void 0:H.key,md5:null===(Q=e.entity_content)||void 0===Q?void 0:null===(Y=Q.file)||void 0===Y?void 0:Y.md5,url:(null===(ee=e.entity_content)||void 0===ee?void 0:null===(Z=ee.file)||void 0===Z?void 0:Z.url)||(null===(en=e.entity_content)||void 0===en?void 0:null===(eo=en.file)||void 0===eo?void 0:null===(ea=eo.image)||void 0===ea?void 0:null===(et=ea.image_ori)||void 0===et?void 0:et.url),size:(0,n.default)(null===(es=e.entity_content)||void 0===es?void 0:null===(ei=es.file)||void 0===ei?void 0:ei.size)?0:Number(null===(er=e.entity_content)||void 0===er?void 0:null===(el=er.file)||void 0===el?void 0:el.size),file_review_state:l.ReviewState.ReviewState_Access,file_parse_state:l.ParseState.ParseState_Success}:{type:c[(null===(r=e.entity_content)||void 0===r?void 0:null===(i=r.file)||void 0===i?void 0:i.file_type)||"attachment"],identifier:e.identifier,name:null===(v=e.entity_content)||void 0===v?void 0:null===(u=v.file)||void 0===u?void 0:u.file_name,key:null===(p=e.entity_content)||void 0===p?void 0:null===(g=p.file)||void 0===g?void 0:g.key,md5:null===(_=e.entity_content)||void 0===_?void 0:null===(m=_.file)||void 0===m?void 0:m.md5,url:(null===(f=e.entity_content)||void 0===f?void 0:null===(y=f.file)||void 0===y?void 0:y.url)||(null===(T=e.entity_content)||void 0===T?void 0:null===(C=T.file)||void 0===C?void 0:null===(M=C.image)||void 0===M?void 0:null===(h=M.image_ori)||void 0===h?void 0:h.url),size:(0,n.default)(null===(S=e.entity_content)||void 0===S?void 0:null===(I=S.file)||void 0===I?void 0:I.size)?0:Number(null===(P=e.entity_content)||void 0===P?void 0:null===(x=P.file)||void 0===x?void 0:x.size),file_review_state:null!==(ed=e.file_name_state)&&void 0!==ed?ed:l.ReviewState.ReviewState_Processing,file_parse_state:null!==(ec=e.file_parse_state)&&void 0!==ec?ec:l.ParseState.ParseState_Processing}}))||[]},g=e=>null==e?void 0:e.map(e=>{var t;return{key:e.key,type:c.image,name:e.file_name,url:null===(t=e.image_ori)||void 0===t?void 0:t.url}}),p=e=>{var t,a;return[...((null===(a=(0,r.parseJSON)((0,o.default)(e,["samantha_context"]),{}))||void 0===a?void 0:null===(t=a.query_context)||void 0===t?void 0:t.ref_images)||[]).map(e=>({type:i.AttachmentEnum.Image,key:e.image_token,url:e.url,extra:{refer_types:e.refer_types},file_review_state:e.review_status,identifier:e.identifier}))]},m=e=>(null==e?void 0:e.repo_id)?{type:c.link,key:e.repo_id,url:e.url,identifier:e.repo_id,name:null==e?void 0:e.repo_name}:{type:c.link,key:e.url,url:e.url},_=e=>{var t;return null===(t=e.file_list)||void 0===t?void 0:t.map(e=>({key:e.key,name:e.file_name,type:c.attachment,url:e.key}))},y=e=>{var t;return(null===(t=e.image_list)||void 0===t?void 0:t.map(e=>{let{key:t,file_name:a,image_ori:o}=e;return{key:t,name:a,type:c.image,url:null==o?void 0:o.url}}))||[]},f=e=>e.map(e=>{let{key:t,name:a,url:o}=e;return{key:t||"",file_name:a,image_ori:{url:o||"",format:"",width:0,height:0},feedback:"",description:"",request_id:"",image_thumb_formats:{},image_thumb_ori_formats:{}}})},569248:function(e,t,a){a.d(t,{getResumeChunkTaskIfNeed:function(){return n},getUrl:function(){return i}});var o=a(810364);let n=e=>{let t=[];for(let a of e)if(function(e){let t=Date.now();return t-function(e){let t=Date.now();if(e%10**(t.toString().length-1)!==e)return e;{let a=1e3*e;return a<t?a:e}}(e||t)<3e5}(Number(a.createTime))){t.push(a);break}return t};function i(e,t){return o.default.stringifyUrl({url:e,query:t})}},703409:function(e,t,a){a.d(t,{dispatchEvent:function(){return s},subscribeEvent:function(){return n},unsubscribeEvent:function(){return i}});var o=a(818289);let n=(e,t)=>{for(let a of e)a.eventEmitter.on("message",e=>t.message(e))},i=e=>{for(let t of e)null==t||t.eventEmitter.off("message"),null==t||t.drop()},s=(e,t)=>{let{event_type:a,message:n,cmd:i,message_list:s}=e;if(a===o.EventType.Message&&s)for(let e of s)t.eventEmitter.emit("message",e);a===o.EventType.Message&&n&&t.eventEmitter.emit("message",n)}},257022:function(e,t,a){a.d(t,{isCodeMessagePayload:function(){return E},isCompositeMessagePayload:function(){return C},isCompositeMessagePayloadOptions:function(){return u},isCompositeMessagePayloadWithFiles:function(){return I},isCompositeMessagePayloadWithImages:function(){return T},isCompositeMessagePayloadWithLinks:function(){return S},isCompositeMessagePayloadWithWebsites:function(){return x},isCopyMessagePayloadOptions:function(){return v},isDirectDeepResearchMessagePayload:function(){return _},isFileMessagePayload:function(){return M},isFileMessagePayloadOptions:function(){return c},isImageMessagePayload:function(){return h},isImageMessagePayloadOptions:function(){return d},isNeedDowngradeToOldAdapter:function(){return L},isNestedMessagePayload:function(){return P},isNestedMessagePayloadOptions:function(){return l},isPptskillMessagePayload:function(){return p},isRegenerate:function(){return y},isSearchEngineMessagePayload:function(){return m},isStepWriteMessagePayload:function(){return k},isTextMessagePayload:function(){return f},isTextMessagePayloadOptions:function(){return r},isUseSamanthaProtocolStageDiffToSend:function(){return b},isUseSamanthaProtocolStageReleaseToSend:function(){return R},isVideoSkillMessagePayload:function(){return g}});var o=a(229079),n=a(165482),i=a(322206),s=a(524129);let l=e=>"nestedItems"in e.payload,r=e=>"text"in e.payload,d=e=>"image"in e.payload||"image_key"in e.payload,c=e=>"file"in e.payload||"file_key"in e.payload,u=e=>"compositeContent"in e.payload,v=e=>{var t;return!!e.payload.operation&&"copySend"in e.payload.operation&&!!(null===(t=e.payload.operation)||void 0===t?void 0:t.copySend)},g=e=>"attachments"in e.payload,p=e=>"gen_ppt_input"in e.payload||"gen_outline_input"in e.payload,m=e=>"up_template_key"in e.payload,_=e=>"direct_research"in e.payload,y=e=>{var t;return!!(e.operation&&"regenerate"in e.operation&&(null===(t=e.operation)||void 0===t?void 0:t.regenerate))},f=e=>"text"in e,h=e=>"image"in e||"image_key"in e,M=e=>"file"in e||"file_key"in e,C=e=>"compositeContent"in e,T=e=>C(e)&&!!e.compositeContent&&"images"in e.compositeContent&&!!e.compositeContent.images,I=e=>C(e)&&!!e.compositeContent&&"files"in e.compositeContent&&!!e.compositeContent.files,S=e=>C(e)&&!!e.compositeContent&&"links"in e.compositeContent&&!!e.compositeContent.links,x=e=>C(e)&&!!e.compositeContent&&"websites"in e.compositeContent&&!!e.compositeContent.websites,P=e=>"nestedItems"in e,E=e=>"sendAttachments"in e,k=e=>{var t;return"gen_outline"===(0,o.default)((0,n.parseJSON)(null==e?void 0:null===(t=e.extraExt)||void 0===t?void 0:t.input_skill,void 0),"variables.action")};function b(e){let{stage:t,botType:a,isNeedDowngrade:o}=e;return"Main"===a&&t===i.LaunchStage.Diff&&!o}function R(e){let{botType:t,stage:a,isNeedDowngrade:o,skill:n}=e;return"Main"===t&&(a===i.LaunchStage.Release&&!o||(null==n?void 0:n.skill_type)===s.SkillType.VideoGeneration||(null==n?void 0:n.skill_type)===s.SkillType.CodeAssistant||(null==n?void 0:n.skill_type)===s.SkillType.MediaUnderstandingByAsr)}let L=e=>{var t,a,o,n;if(null==e?void 0:null===(t=e.ext)||void 0===t?void 0:t.collection_id)return!0;if(null==e?void 0:null===(a=e.ext)||void 0===a?void 0:a.reference_resource)try{return!!(null===(n=JSON.parse(e.ext.reference_resource))||void 0===n?void 0:null===(o=n.collection)||void 0===o?void 0:o.id)}catch(e){}return!1}},382757:function(e,t,a){a.d(t,{sendSupportedMessage:function(){return e7}});var o=a(788432),n=a(486677),i=a(519428),s=a(746167),l=a(101874),r=a(137396);let d=e=>{switch(e){case s.ChatTeaSendSource.GUIDANCE_PAGE:return r.ChatSceneEnum.GENERIC_START_PAGE_NEW_CONVERSATION;case s.ChatTeaSendSource.SKILL_GUIDANCE_PAGE:return r.ChatSceneEnum.SKILL_START_PAGE_NEW_CONVERSATION;case s.ChatTeaSendSource.GUIDANCE_PAGE_CLICK:return r.ChatSceneEnum.CLICK_GUIDANCE_NEW_CONVERSATION;case s.ChatTeaSendSource.SKILL_GUIDANCE_PAGE_CLICK:return r.ChatSceneEnum.CLICK_SKILL_GUIDANCE_NEW_CONVERSATION;case s.ChatTeaSendSource.SUGGEST:return r.ChatSceneEnum.SUGGEST;case s.ChatTeaSendSource.DOC_COPILOT:return r.ChatSceneEnum.DOC_COPILOT;default:return r.ChatSceneEnum.DEFAULT}};var c=a(670899),u=a(266655);function v(e,t,a){var o;return(t="symbol"==typeof(o=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var o=a.call(e,t||"default");if("object"!=typeof o)return o;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?o:o+"")in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class g{getRecordTimestamp(e){return this.recordTimestamp[e]}getRecordTimestamps(){return this.recordTimestamp}setRecordTimestamp(e,t){this.recordTimestamp[e]=t}setCommonTraceParam(e){this.commonTraceParams={...this.commonTraceParams,...e}}setTeaEventTraceParams(e,t){this.teaEventTraceParams[e]={...this.teaEventTraceParams[e],...t}}setTeaEventOtherTraceParams(e){this.teaEventOtherTraceParams={...this.teaEventOtherTraceParams,...e}}getCommonTraceParams(){return this.commonTraceParams}getTeaEventTraceParams(e){return this.teaEventTraceParams[e]}getTeaEventOtherTraceParams(){return this.teaEventOtherTraceParams}addEventReportCount(e){this.eventReportCounts[e]=this.eventReportCounts[e]||0,this.eventReportCounts[e]++}getEventReportCounts(){return this.eventReportCounts}setReportTeaEventFailed(e){this.eventReportSuccessRecords[e]=!1}setReportTeaEventSuccess(e){this.eventReportSuccessRecords[e]=!0}getSuccessTeaEventCounts(){var e,t;return null===(t=(0,u.default)(this.eventReportSuccessRecords))||void 0===t?void 0:null===(e=t.filter(e=>e))||void 0===e?void 0:e.length}getFailTeaEventCounts(){var e,t;return null===(t=(0,u.default)(this.eventReportSuccessRecords))||void 0===t?void 0:null===(e=t.filter(e=>!e))||void 0===e?void 0:e.length}constructor(e){v(this,"recordTimestamp",void 0),v(this,"commonTraceParams",void 0),v(this,"teaEventTraceParams",void 0),v(this,"teaEventOtherTraceParams",void 0),v(this,"eventReportCounts",void 0),v(this,"eventReportSuccessRecords",void 0),this.recordTimestamp={receive_think_reason_start:void 0,receive_think_reason_first_text:void 0,receive_think_reason_end:void 0,receive_batch_message_first_text:void 0,receive_batch_message_first_token:void 0,receive_batch_message_end:void 0},this.commonTraceParams=(null==e?void 0:e.commonTraceParams)||{},this.teaEventTraceParams=(null==e?void 0:e.teaEventTraceParams)||{send_message:{},receive_suggests:{},receive_think_reason:{},receive_batch_message:{}},this.teaEventOtherTraceParams=(null==e?void 0:e.teaEventOtherTraceParams)||{},this.eventReportCounts={},this.eventReportSuccessRecords={}}}var p=a(475261),m=a(230932),_=a(212183),y=a(785926),f=a(322206),h=a(524129),M=a(458524),C=a(165482),T=a(178230),I=a(277828),S=a(845485),x=a(257022),P=a(674157),E=a(629006),k=a(461141),b=a(645298),R=a(745829),L=a(630768),A=a(637319),O=a(83990),w=a(752544),F=a(251132);let j=(e,t)=>{var a,o,n,i;let[s]=e;(0,R.deleteLocalReceivingMessage)(s,b.mockReplyConstantMessageId),(null===(a=t.local)||void 0===a?void 0:a.isReady)&&((0,F.addLocalReceivingMessage)({isRegenerate:t.local.isRegenerate,immerUpdateMessage:e,conversationId:null!==(i=t.conversation_id)&&void 0!==i?i:"",replyId:t.local.isRegenerate?t.reply_id||"":t.local_message_id||"",messageId:"",newLocalMessageId:b.mockReplyConstantMessageId,sectionId:t.section_id,timeout:null==t?void 0:null===(o=t.ext)||void 0===o?void 0:o.timeout,localMessageStatus:l.LocalMessageStatus.WaitingAck,skillType:null==t?void 0:null===(n=t.skill)||void 0===n?void 0:n.skill_type}),(0,F.appendLocalReceivingMessageLink)({isRegenerate:t.local.isRegenerate,immerUpdateMessage:e,newLocalMessageId:b.mockReplyConstantMessageId,messageKey:(0,I.createLocalMessageKey)()}))},N=(e,t,a)=>{a.resolvedConversationId&&e.updateMessageList({conversationId:a.resolvedConversationId,immerUpdate:function(){for(var e,o=arguments.length,n=Array(o),i=0;i<o;i++)n[i]=arguments[i];if(!a.localMessageId)return;let[s]=n,{draftMessageLinks:l,draftLocalMessageMap:r}=s;r[a.localMessageId]=t;let d={isLocalMessage:!0,messageId:a.localMessageId};(null===(e=t.ext)||void 0===e?void 0:e.regen)!=="1"&&l.push(d),j(n,t)}})},D=(e,t)=>{e.updateMessageList({conversationId:t.resolvedConversationId,immerUpdate:e=>{let{draftLocalMessageMap:{[t.localMessageId]:a}}=e;(null==a?void 0:a.local)&&(a.local.failed=!0,a.local.status=l.LocalMessageStatus.PreprocessFailed)}})},U=(e,t,a)=>{a.resolvedConversationId&&e.updateMessageList({conversationId:a.resolvedConversationId,immerUpdate:function(){for(var e,o,n,i=arguments.length,s=Array(i),r=0;r<i;r++)s[r]=arguments[r];let d=t.local_message_id;if(!d)return;let[c]=s,{draftLocalMessageMap:{[d]:u},draftMessageLinks:v}=c,g={...u,...t},{sendMessageStartTimeout:p=b.defaultSendMessageStartTimeout}=(0,k.getChatConfig)("chatMessageConfig")||{};g.create_time=Date.now(),g.local.failedExpired=Date.now()+p,g.local.status=t.local.isRegenerate?l.LocalMessageStatus.SendingRegenerate:l.LocalMessageStatus.Sending,g.local.prevRemoteMessageId=t.local.isRegenerate?null==a?void 0:null===(o=a.operation)||void 0===o?void 0:null===(e=o.regenerate)||void 0===e?void 0:e.regenerateTailMessageId:(null===(n=(0,L.findLastRemoteMessageLink)(v))||void 0===n?void 0:n.messageId)||"";let m=v.findIndex(e=>e.messageId===t.local_message_id);~m&&m!==v.length-1&&v.push(...v.splice(m,1)),c.draftLocalMessageMap[d]=g,j(s,g)}})},W=e=>(0,A.findLastAvailableMessageSelector)(O.useMessageStore.getState(),e);var B=a(959354),G=a(689368);let z=async(e,t)=>{var a,o,n,i;if(!e)return;T.logger.persist.info({eventName:"send_message_start_with_samantha-chat-completion",meta:{local_message_id:null===(a=e[0])||void 0===a?void 0:a.local_message_id,message_id:null===(o=e[0])||void 0===o?void 0:o.message_id,conversation_id:null===(n=e[0])||void 0===n?void 0:n.conversation_id,local_conversation_id:null===(i=e[0])||void 0===i?void 0:i.local_conversation_id}});let s=await (0,G.getChatProtocolPlugin)("SamanthaChat");null==s||s.sendMessage(e,t)};var K=a(843174);let J=()=>{let e,t;return{promise:new Promise((a,o)=>{e=a,t=o}),resolve:e,reject:t}},q=e=>!!e.local_message_id,V=e=>!!e.local_conversation_id||!!e.conversation_id,$=e=>(t,a)=>new Promise((o,n)=>{let i=O.useMessageStore.getState();if(!t.every(q))return T.logger.console.info("local_message_id is empty, skip to send message"),o("skip");if(!t.every(i.hasSendMessageTask))return T.logger.console.info("task is empty, skip to send message"),o("skip");if(t.some(i.isSendMessageExpired))return o("skip");null==e||e(t,a);let s=t.map(e=>({message:e,...J()}));s.forEach(e=>{let{message:t,resolve:a}=e;return i.updateSendMessageTaskFinishFn(t,a)});let l=setTimeout(()=>n(Error("timeout")),a.customSendWaitTimeout||b.sendMessageWaitTimeout);Promise.all(s.map(e=>{let{promise:t}=e;return t})).then(()=>{o("finish"),clearTimeout(l)})}),H=$(async(e,t)=>{var a,o,n,i;T.logger.persist.info({eventName:"send_message_start_with_socket",meta:{local_message_id:null===(a=e[0])||void 0===a?void 0:a.local_message_id,message_id:null===(o=e[0])||void 0===o?void 0:o.message_id,conversation_id:null===(n=e[0])||void 0===n?void 0:n.conversation_id,local_conversation_id:null===(i=e[0])||void 0===i?void 0:i.local_conversation_id}});let s=await (0,G.getChatProtocolPlugin)("AliceChatSocket");null==s||s.sendMessage(e,t)}),X=$(async(e,t)=>{var a,o,n,i;T.logger.persist.info({eventName:"send_message_start_with_http\u2014long-polling",meta:{local_message_id:null===(a=e[0])||void 0===a?void 0:a.local_message_id,message_id:null===(o=e[0])||void 0===o?void 0:o.message_id,conversation_id:null===(n=e[0])||void 0===n?void 0:n.conversation_id,local_conversation_id:null===(i=e[0])||void 0===i?void 0:i.local_conversation_id}});let s=await (0,G.getChatProtocolPlugin)("AliceChatFallback");null==s||s.sendMessage(e,t)}),Y=(e,t)=>{let a=t||e,o=(t,n)=>e(t,n).catch(e=>a(t,n).catch(e=>o(t,n)));return o},Q=e=>e.some(e=>{var t,a;return K.utf8.length(`${(0,C.stringifyJSON)(null==e?void 0:e.content_obj)||""}${(null==e?void 0:null===(t=e.ext)||void 0===t?void 0:t.browser_explain)||""}${(null==e?void 0:null===(a=e.ext)||void 0===a?void 0:a.samantha_context)||""}`)>b.maxSendMessageTextLength}),Z=(e,t)=>{let a=O.useMessageStore.getState();return e.every(q)?e.every(V)?(e.forEach(e=>a.finishSendMessageTask(e.local_message_id)),e.forEach(a.addSendMessageTask),(async e=>{let a;return(Q(e)?Y(X):Y(H,X))(e,t)})(e)):(T.logger.console.info("local_conversation_id or conversation_id is empty, skip sending message"),Promise.resolve()):(T.logger.console.info("local_message_id is empty, skip sending message"),Promise.resolve())};var ee=a(777210);let et=e=>{var t,a,o,n,i,s,l,r,d,c,u,v,g,p;let{messages:m,customSendWaitTimeout:_,isNeedDowngrade:y}=e,f=(null===(t=m[0])||void 0===t?void 0:t.local_conversation_id)||(null===(a=m[0])||void 0===a?void 0:a.conversation_id),h=B.MessageTracer.getInstance(f),M=null!==(p=h.rootSpan)&&void 0!==p?p:h.startSpan("client_send_message"),C=null==M?void 0:M.toCarrier(),T=null===(n=m[0])||void 0===n?void 0:null===(o=n.ext)||void 0===o?void 0:o.useSamanthaChat;if((0,x.isUseSamanthaProtocolStageReleaseToSend)({botType:(null===(s=m[0])||void 0===s?void 0:null===(i=s.local)||void 0===i?void 0:i.botType)||"UGC",stage:null===(r=m[0])||void 0===r?void 0:null===(l=r.local)||void 0===l?void 0:l.samanthaChatStage,isNeedDowngrade:y,skill:null===(d=m[0])||void 0===d?void 0:d.skill})||T){z(m,{headers:C});return}if((0,x.isUseSamanthaProtocolStageDiffToSend)({botType:(null===(u=m[0])||void 0===u?void 0:null===(c=u.local)||void 0===c?void 0:c.botType)||"UGC",stage:null===(g=m[0])||void 0===g?void 0:null===(v=g.local)||void 0===v?void 0:v.samanthaChatStage,isNeedDowngrade:y})){Z(m,{customSendWaitTimeout:_,headers:C}),z(m,{headers:C});return}Z(m,{customSendWaitTimeout:_,headers:C})},ea=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];let o=ee.messageServiceContainer.service;(null==o?void 0:o._messageServiceIsInitialed)?et(...t):null==o||o.tryInitMessageProtocolService(()=>{et(...t)})};var eo=a(304086),en=a(214071),ei=a(778816),es=a(226982),el=a(296493),er=a(218679),ed=a(229079),ec=a(762707),eu=a(725705),ev=a(249254),eg=a(847857);let ep=(e,t)=>({...t.payload,contentType:M.ContentType.Text,isReady:!0,contentObj:{text:(0,eg.getMessageText)(e)},resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,x.isRegenerate)(t.payload),reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}),em=(e,t)=>{var a,o,n,i;let s=null===(a=e.content_obj)||void 0===a?void 0:a.data[0].key;return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Image,isReady:!!s,contentObj:{data:[{key:s}]},local_key:(0,eu.isLocalMessage)(e)?null===(o=e.local)||void 0===o?void 0:o.localKey:void 0,isRegenerate:(0,x.isRegenerate)(t.payload),reportParams:{...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload),message_type:(0,S.getMessageType)(M.ContentType.Image),from:(null===(i=t.payload)||void 0===i?void 0:null===(n=i.reportParams)||void 0===n?void 0:n.from)||""}}},e_=(e,t)=>{var a;return{...t.payload,contentType:M.ContentType.Text,isReady:!0,contentObj:{text:null==e?void 0:null===(a=e.content_obj)||void 0===a?void 0:a.text},resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,x.isRegenerate)(t.payload),reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}},ey=(e,t)=>{var a,o,n,i,s,l,r;let d=null===(a=e.content_obj)||void 0===a?void 0:a.file_list[0].key;return{...t.payload,resolvedConversationId:t.resolvedConversationId,local_key:(0,eu.isLocalMessage)(e)?null===(o=e.local)||void 0===o?void 0:o.localKey:void 0,localMessageId:t.localMessageId,contentType:M.ContentType.File,isReady:!!d,contentObj:{file_list:[{key:d,file_name:null===(s=e.content_obj)||void 0===s?void 0:null===(i=s.file_list)||void 0===i?void 0:null===(n=i[0])||void 0===n?void 0:n.file_name}]},isRegenerate:(0,x.isRegenerate)(t.payload),reportParams:{...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload),message_type:(0,S.getMessageType)(M.ContentType.Image),from:(null===(r=t.payload)||void 0===r?void 0:null===(l=r.reportParams)||void 0===l?void 0:l.from)||""}}},ef=(e,t)=>{var a,o,n,i,s,l,r,d,c;if((0,E.isCompositeMessageWithLinks)(e))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Composite,contentObj:{text:(null===(s=e.content_obj.text)||void 0===s?void 0:s.trim())||"",link_model:{url:(null===(l=e.content_obj.link_model)||void 0===l?void 0:l.url)||""}},isRegenerate:(0,x.isRegenerate)(t.payload),isReady:!0,extraExt:t.payload.extraExt,reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Composite),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}};if((0,E.isCompositeMessageWithWebsites)(e))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Composite,contentObj:{text:(null===(r=e.content_obj.text)||void 0===r?void 0:r.trim())||"",website_model:{pages:(null===(d=e.content_obj.website_model)||void 0===d?void 0:d.pages)||[]}},isReady:!0,isRegenerate:(0,x.isRegenerate)(t.payload),extraExt:t.payload.extraExt,reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Composite),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}};let u=(0,E.isCompositeMessageWithImages)(e),v=(0,E.isCompositeMessageWithFiles)(e),g=u?null===(a=e.content_obj.image_model)||void 0===a?void 0:a.image_list:v?null===(o=e.content_obj.file_model)||void 0===o?void 0:o.file_list:void 0;if(!(null==g?void 0:g[0]))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Text,contentObj:{text:(null===(c=e.content_obj.text)||void 0===c?void 0:c.trim())||""},isReady:!0,isRegenerate:(0,x.isRegenerate)(t.payload),extraExt:t.payload.extraExt,reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}};let p=g.map(e=>{let{key:t}=e;return t});return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentObj:u?{text:(null===(n=e.content_obj.text)||void 0===n?void 0:n.trim())||"",image_model:{image_list:p.map(e=>({key:e}))}}:v?{text:(null===(i=e.content_obj.text)||void 0===i?void 0:i.trim())||"",file_model:{file_list:g.map((e,t)=>({file_name:(0,ev.pickAsString)("file_name")(e),key:p[t]||""}))}}:{},contentType:M.ContentType.Composite,isReady:!0,isRegenerate:(0,x.isRegenerate)(t.payload),extraExt:t.payload.extraExt,reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Composite),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}},eh=(e,t)=>{var a;let o=(0,i.default)(e.content_obj);return null==o||null===(a=o.entities)||void 0===a||a.forEach(e=>{delete e.file_name_state,delete e.file_parse_state}),{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Nested,contentObj:o,isRegenerate:(0,x.isRegenerate)(t.payload),isReady:!0,extraExt:t.payload.extraExt,reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}},eM=(e,t)=>{var a,o,n,s,l,r,d;if((null==e?void 0:e.content_type)===es.ContentType.SamanthaCodeAssistantInput){let a=(0,i.default)(e.content_obj);return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Composite,sendAttachments:[...e.attachments||[]],contentObj:a,isRegenerate:(0,x.isRegenerate)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Composite),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}}if((null==e?void 0:e.content_type)===M.ContentType.Text)return{...ep(e,t),extraExt:{...t.payload.extraExt,useSamanthaChat:"true"}};if((0,E.isCompositeMessage)(e)&&(0,er.default)((0,ed.default)(e,["content_obj","link_model","url"])))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Composite,contentObj:{text:(null===(a=e.content_obj.text)||void 0===a?void 0:a.trim())||"",link_model:{url:(null===(o=e.content_obj.link_model)||void 0===o?void 0:o.url)||"",repo_id:(null===(s=e.content_obj.link_model)||void 0===s?void 0:null===(n=s.extra)||void 0===n?void 0:n.repo_id)||"",repo_name:(null===(r=e.content_obj.link_model)||void 0===r?void 0:null===(l=r.extra)||void 0===l?void 0:l.repo_name)||""}},isRegenerate:(0,x.isRegenerate)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Composite),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}};if((0,E.isNestedMessage)(e)){let a=(0,i.default)(e.content_obj);return null==a||null===(d=a.entities)||void 0===d||d.forEach(e=>{delete e.file_name_state,delete e.file_parse_state}),{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Nested,contentObj:a,isRegenerate:(0,x.isRegenerate)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}}return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:M.ContentType.Nested,contentObj:{},isRegenerate:(0,x.isRegenerate)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}},eC=(e,t)=>(t.payload.extraExt={...t.payload.extraExt,...(0,ec.default)(null==e?void 0:e.ext,["browser_explain","reference_source","browser_plugin_info","translate","input_content_type","reference_resource"])},{...t.payload,contentType:e.content_type,isReady:!0,contentObj:e.content_obj,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,x.isRegenerate)(t.payload),reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}),eT=(e,t)=>({...t.payload,contentType:es.ContentType.SamanthaMediaUnderstandingByAsrInput,isReady:!0,contentObj:e.content_obj,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,x.isRegenerate)(t.payload),reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...t.payload.reportParams,...(0,S.genTeaMeta)(t.payload)}}),eI=(e,t)=>(t.payload.extraExt={source:t.source,...t.payload.extraExt,...(0,ec.default)(null==e?void 0:e.ext,["msg_template_id","collection_id","input_skill","need_create_thread","reference_content","immersive_reading_files","pdf_hover_position","samantha_context","generate_mind_map","answer_with_suggest"])},(0,E.isMediaMessage)(e))?eT(e,t):(0,E.isCodeTextMessage)(e)?eM(e,t):(0,E.isWriteInputMessage)(e)?e_(e,t):(0,E.isExtSamanthaSkillMessage)(e)?eC(e,t):(0,E.isWiderNestedMessage)(e)?eh(e,t):(0,E.isWiderTextMessage)(e)?ep(e,t):(0,E.isImageMessage)(e)||(0,E.isEduExerciseImageMessage)(e)?em(e,t):(0,E.isCompositeMessage)(e)?ef(e,t):(0,E.isNestedMessage)(e)?eh(e,t):(0,E.isFileMessage)(e)?ey(e,t):void 0;var eS=a(544044);let ex=()=>(0,eS.default)(),eP=(e,t)=>{var a;if(!e)return[];let o=null==e?void 0:null===(a=e.ext)||void 0===a?void 0:a.collection_id;if(!o)return[e];let n=O.useMessageStore.getState(),i=n.messageLinkMap[t],s=n.messageMap[t];return i.filter(e=>{var t,a;return(0,E.isSendMessage)(s[e.messageId])&&(null===(a=s[e.messageId])||void 0===a?void 0:null===(t=a.ext)||void 0===t?void 0:t.collection_id)===o}).map(e=>(0,A.getMessageSelector)(n,t,e)).filter(el.notUndefined)},eE=e=>{var t;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.Text,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim()},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},ek=e=>{var t,a,o;let n=[],i=!!e.payload.image_key;return n.push({key:(null===(t=e.payload)||void 0===t?void 0:t.image_key)||"",image_ori:(null===(a=e.payload)||void 0===a?void 0:a.image_ori)||"",image_thumb:(null===(o=e.payload)||void 0===o?void 0:o.image_thumb)||""}),{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.Image,contentObj:{data:n},isReady:i,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Image),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},eb=e=>{let t=[],a=!!e.payload.file_key;return t.push({file_name:e.payload.file_name,key:e.payload.file_key}),{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.File,contentObj:{file_list:t},isReady:a,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.File),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},eR=e=>{var t,a,o,n;let i=!0,s=e=>{let t=[];return null==e||e.forEach(e=>{t.push(e),i&&(i=!!e.key)}),t};return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentObj:(0,x.isCompositeMessagePayloadWithImages)(e.payload)?{text:null===(t=e.payload.compositeContent)||void 0===t?void 0:t.text,image_model:{image_list:s(null===(a=e.payload.compositeContent)||void 0===a?void 0:a.images)}}:(0,x.isCompositeMessagePayloadWithFiles)(e.payload)?{text:e.payload.compositeContent.text,file_model:{file_list:s(e.payload.compositeContent.files)}}:(0,x.isCompositeMessagePayloadWithLinks)(e.payload)?{text:e.payload.compositeContent.text,link_model:{url:e.payload.compositeContent.links[0]}}:(0,x.isCompositeMessagePayloadWithWebsites)(e.payload)?{text:null===(o=e.payload.compositeContent)||void 0===o?void 0:o.text,website_model:{pages:null===(n=e.payload.compositeContent)||void 0===n?void 0:n.websites}}:{},contentType:M.ContentType.Composite,isReady:i,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Composite),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},eL=e=>{let{nestedItems:t,text:a}=e.payload,o=null==t?void 0:t.map(e=>e.type===ei.NestedMessageEntityType.Image?{entity_type:e.type,entity_content:{image:e.image||{}},identifier:e.identifier,file_parse_state:e.parseState,file_name_state:e.reviewState}:e.fileType===ei.NestedMessageFileType.Audio||e.fileType===ei.NestedMessageFileType.Video?{entity_type:e.type,entity_content:{file:{file_name:e.fileName,key:e.fileKey,size:e.size,file_type:e.fileType,md5:e.md5,image:e.image}},identifier:e.identifier,file_parse_state:e.parseState,file_name_state:e.reviewState}:{entity_type:ei.NestedMessageEntityType.File,entity_content:{file:{file_name:e.fileName,key:e.fileKey,size:e.size,file_type:e.fileType,md5:e.md5,image:e.image}},identifier:e.identifier,file_parse_state:e.parseState,file_name_state:e.reviewState},[]);return(null==o?void 0:o.length)===0?{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.Text,contentObj:{text:null==a?void 0:a.trim()},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}:{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.Nested,contentObj:{text:null==a?void 0:a.trim(),entities:o},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Nested),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},eA=e=>{var t,a;if(!(null===(a=e.payload.operation)||void 0===a?void 0:null===(t=a.copySend)||void 0===t?void 0:t.messageLink))return;let{messageLink:o}=e.payload.operation.copySend,n=(0,A.getMessageSelector)(e.store,e.resolvedConversationId,o);if(n)return eI(n,e)},eO=e=>{var t;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.Text,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim()},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},attachments:e.payload.attachments,reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},ew=e=>{var t;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:M.ContentType.Text,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim(),action:e.payload.action,gen_ppt_input:e.payload.gen_ppt_input,gen_outline_input:e.payload.gen_outline_input},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},eF=e=>{var t,a;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:es.ContentType.SamanthaSearchEngineInput,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim(),up_template_key:null===(a=e.payload)||void 0===a?void 0:a.up_template_key},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},ej=e=>{var t,a;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:es.ContentType.SamanthaDeepResearchInput,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim(),direct_research:null===(a=e.payload)||void 0===a?void 0:a.direct_research},isReady:!0,isRegenerate:(0,x.isRegenerate)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,S.getMessageType)(M.ContentType.Text),...e.payload.reportParams,...(0,S.genTeaMeta)(e.payload)}}},eN=e=>{if((0,x.isPptskillMessagePayload)(e))return ew(e);if((0,x.isDirectDeepResearchMessagePayload)(e))return ej(e);if((0,x.isSearchEngineMessagePayload)(e))return eF(e);if((0,x.isNestedMessagePayloadOptions)(e))return eL(e);if((0,x.isTextMessagePayloadOptions)(e))return eE(e);else if((0,x.isImageMessagePayloadOptions)(e))return ek(e);else if((0,x.isFileMessagePayloadOptions)(e))return eb(e);else if((0,x.isCompositeMessagePayloadOptions)(e))return eR(e);else if((0,x.isCopyMessagePayloadOptions)(e))return eA(e);else if((0,x.isVideoSkillMessagePayload)(e))return eO(e)},eD=e=>{var t,a;let o=eN(e);if(o)return[o];let{replace:n,resume:i,remove:s,regenerate:l,resend:r,newChat:d}=e.payload.operation||{},c=null!==(a=null===(t=n||i||s||r||d)||void 0===t?void 0:t.messageLink)&&void 0!==a?a:l?{messageId:l.sentMessageId,isLocalMessage:!1}:void 0,u=(null==d?void 0:d.conversationId)||e.resolvedConversationId,v=c?(0,A.getMessageSelector)(e.store,u,c):void 0,g=(l?eP(v,u):[v].filter(el.notUndefined)).map(t=>{var a,o,s,c,u,v;let g=(null==t?void 0:null===(a=t.ext)||void 0===a?void 0:a.source)||e.payload.reportParams.scene;e.source=l||n&&"edit"!==e.payload.reportParams.scene||r?g:e.payload.reportParams.scene;let p=eI(t,e);return i&&(null==p?void 0:p.extraExt)&&(p.extraExt.ugc_plugin_auth_infos=null!==(c=null===(s=e.payload.extraExt)||void 0===s?void 0:s.ugc_plugin_auth_infos)&&void 0!==c?c:""),d&&(null==p?void 0:p.extraExt)&&(p.extraExt.need_create_thread=null!==(v=null===(u=e.payload.extraExt)||void 0===u?void 0:u.need_create_thread)&&void 0!==v?v:""),(null==p?void 0:null===(o=p.operation)||void 0===o?void 0:o.replace)&&(null==p?void 0:p.extraExt)&&delete p.extraExt.collection_id,p}).filter(el.notUndefined);if(g.length>1&&g.some(e=>{var t;return!(null===(t=e.extraExt)||void 0===t?void 0:t.collection_id)})){let e=ex();g.forEach(t=>(t.extraExt={...t.extraExt,collection_id:e},t))}if(!(0,en.default)(g))return g;throw T.logger.persist.warning("sendMsgUnsupportedTypeOrScene"),Error("Unsupported MessageType")};var eU=a(56742),eW=a(300841),eB=a(949932);let eG=e=>{let t=ez(e);return t.used_prompt?e.reportParams.preset_prompt_type?{...t,prompt_type:"default_prompt",default_prompt_type:e.reportParams.preset_prompt_type}:{...t,prompt_type:"customized_prompt"}:{...t}},ez=e=>{var t;let a=!0;return(0,x.isNestedMessagePayload)(e)&&(null==e?void 0:e.text)===""&&(a=!1),((0,x.isCompositeMessagePayloadWithFiles)(e)||(0,x.isCompositeMessagePayloadWithImages)(e))&&(null==e?void 0:null===(t=e.compositeContent)||void 0===t?void 0:t.text)===""&&(a=!1),(0,x.isImageMessagePayload)(e)&&(a=!1),{used_prompt:+!!a}},eK=e=>{try{var t,a,o,n,i,l,r,d,c,u;if((0,x.isCodeMessagePayload)(e)&&((null==e?void 0:null===(t=e.sendAttachments)||void 0===t?void 0:t.length)||0)>0){let t=e.sendAttachments,a=null==t?void 0:t.map(e=>e.key),n=null==t?void 0:t.map(e=>e.name||e.repo_name||""),i=null==t?void 0:t.map(e=>{var t;return(null==e?void 0:null===(t=e.type)||void 0===t?void 0:t.split("_").map(e=>(0,eU.default)(e)).join(""))||""}),s=null==t?void 0:t.map(e=>e.size||0),l=new Set(i).size>1;return{upload_id:e.preGeneratedLocalMessageId,upload_file_num:null==t?void 0:t.length,upload_file_size:null==s?void 0:s.join(","),is_upload_file:1,is_upload_mix_type:+!!l,upload_file_type:null==i?void 0:i.join(","),collection_id:(null==a?void 0:a.length)===1?a[0]:(0,C.stringifyJSON)(a),collection_name:(null==n?void 0:n.length)===1?n[0]:(0,C.stringifyJSON)(n),upload_collection_way:(null==t?void 0:t.length)===0?void 0:(null==t?void 0:t.length)===1?"single":"multi",upload_from:null===(o=e.reportParams)||void 0===o?void 0:o.upload_from}}if((0,x.isNestedMessagePayload)(e)&&((null==e?void 0:null===(a=e.nestedItems)||void 0===a?void 0:a.length)||0)>=0){let t=e.nestedItems,a=null==t?void 0:t.map(e=>e.fileKey),o=null==t?void 0:t.map(e=>e.fileName||""),i=null==t?void 0:t.map(e=>(0,eB.getFileType)((0,eB.getFileExt)(e.fileName))),s=null==t?void 0:t.map(e=>e.size||0),l=new Set(i).size>1;return{upload_id:e.preGeneratedLocalMessageId,upload_file_num:null==t?void 0:t.length,upload_file_size:null==s?void 0:s.join(","),is_upload_file:1,is_upload_mix_type:+!!l,upload_file_type:null==i?void 0:i.join(","),collection_id:(null==a?void 0:a.length)===1?a[0]:(0,C.stringifyJSON)(a),collection_name:(null==o?void 0:o.length)===1?o[0]:(0,C.stringifyJSON)(o),upload_collection_way:(null==t?void 0:t.length)===0?void 0:(null==t?void 0:t.length)===1?"single":"multi",upload_from:null===(n=e.reportParams)||void 0===n?void 0:n.upload_from}}if((0,x.isCompositeMessagePayloadWithFiles)(e)||(0,x.isCompositeMessagePayloadWithImages)(e)){let t=(0,x.isCompositeMessagePayloadWithFiles)(e)?e.compositeContent.files:null===(i=e.compositeContent)||void 0===i?void 0:i.images,a=(null==t?void 0:t.map(e=>"blob"in e&&e.blob?(0,ev.pickAsString)("name")(e.blob):"file_name"in e?e.file_name:void 0).filter(el.notUndefined)[0])||"",o=(null==t?void 0:t.map(e=>{if("key"in e)return e.key}).filter(el.notUndefined)[0])||"";return{is_upload_file:1,upload_id:e.preGeneratedLocalMessageId,upload_file_num:1,upload_file_size:"0",is_upload_mix_type:0,upload_file_type:(0,eB.getFileType)((0,eB.getFileExt)(a)),collection_id:o,upload_collection_way:"single",upload_from:null===(l=e.reportParams)||void 0===l?void 0:l.upload_from}}if((0,x.isCompositeMessagePayloadWithLinks)(e)){let{links:t}=e.compositeContent,a=1===t.length?t[0]:(0,C.stringifyJSON)(t);return{is_upload_file:1,upload_file_num:null==t?void 0:t.length,upload_file_size:"0",upload_file_type:s.ChatTeaFileType.UPLOAD_FILE_TYPE_LINK,collection_id:a,collection_name:a,upload_collection_way:(null==t?void 0:t.length)===0?void 0:1===t.length?"single":"multi",upload_from:null===(r=e.reportParams)||void 0===r?void 0:r.upload_from}}if((0,x.isImageMessagePayload)(e)){if("image"in e&&e.image)return{is_upload_file:1,upload_id:e.preGeneratedLocalMessageId,upload_file_num:1,upload_file_size:String(e.image.size),is_upload_mix_type:0,upload_file_type:(0,eB.getFileType)((0,eB.getFileExt)((0,ev.pickAsString)("name")(e.image))),collection_id:e.local_key,upload_collection_way:"single",upload_from:null===(d=e.reportParams)||void 0===d?void 0:d.upload_from};if("image_key"in e&&e.image_key)return{is_upload_file:1,upload_id:e.preGeneratedLocalMessageId,upload_file_num:1,upload_file_size:"0",is_upload_mix_type:0,upload_file_type:s.ChatTeaFileType.UPLOAD_FILE_TYPE_IMAGE,collection_id:e.image_key,upload_collection_way:"single",upload_from:null===(c=e.reportParams)||void 0===c?void 0:c.upload_from};return{is_upload_file:0}}if((0,x.isTextMessagePayload)(e))return{is_upload_file:null!==(u=e.reportParams.is_upload_file)&&void 0!==u?u:0};return{is_upload_file:0}}catch(e){return{}}},eJ=e=>{var t,a;let o=null===(t=e.extraExt)||void 0===t?void 0:t.reference_content;if(!o)return{is_quote:null!==(a=e.reportParams.is_quote)&&void 0!==a?a:0,quote_type:e.reportParams.quote_type};let n=(0,C.parseJSON)(o,[])[0];return n?{is_quote:1,quote_type:(0,eW.isRefText)(n)?"text":(0,eW.isRefAttachment)(n)?"file":((0,eW.isRefLink)(n),"url")}:{is_quote:0,quote_type:void 0}},eq={onboarding_first_met:"onboarding_first_met_sug",onboarding_welcome_back:"onboarding_welcome_back_sug"},eV=e=>{let t=O.useMessageStore.getState();return(0,eo.default)(e.map(e=>{e.reportParams={...e.reportParams,...eK(e),...eJ(e),...eG(e)};let{preGeneratedLocalMessageId:a=""}=e,o=(0,S.getAndCheckResolvedConversationId)(e),n=eq[e.reportParams.scene]||e.reportParams.scene,{botId:i=""}=e;return eD({payload:e,resolvedConversationId:o,store:t,localMessageId:a,botId:i,source:n})}))},e$=e=>{var t,a;let{replace:o,remove:n,regenerate:i,resume:s}=e.operation||{};return{is_delta:!1,local_conversation_id:e.localConversationId,bot_id:e.botId,conversation_id:e.conversationId,section_id:e.sectionId,local_message_id:e.localMessageId,message_type:M.MessageType.Message,content_type:e.contentType,content_obj:e.contentObj,create_time:Date.now(),...o||n||s?{message_id:null===(a=o||n||s)||void 0===a?void 0:null===(t=a.messageLink)||void 0===t?void 0:t.messageId}:{},...i?{reply_id:i.sentMessageId,local_message_id:i.sentLocalMessageId}:{},...e.contentType===M.ContentType.Text?{content_source:e.reportParams.content_source||l.ContentSource.Other,template_id:e.reportParams.content_source_template_id}:{},ext:e.extraExt,status:e.messageStatus}};var eH=a(972057),eX=a(456712),eY=a(884068);let eQ=e=>{var t,a,n,i,s,r,d,c,u,v,g,p,_,f,h,C,T;let{payload:I,store:x}=e,{regenerate:P}=I.operation||{},k=[],b=[...(0,eH.getReferencesFromExt)(I.extraExt)],R={conversation_type:null!==(p=(0,y.conversationTypeByIdSelector)(m.useFeedStore.getState(),I.resolvedConversationId||"",!0))&&void 0!==p?p:I.conversationType,...e$(I),...(0,eX.getSkillFromExt)(I.extraExt),status:I.messageStatus,content_obj:I.contentObj,user_type:M.UserType.Human,attachments:k,references:b};return"sendAttachments"in I&&(null===(t=I.sendAttachments)||void 0===t?void 0:t.length)&&k.push(...I.sendAttachments),(null===(a=I.contentObj)||void 0===a?void 0:a.file_model)&&k.push(...(0,eH.getAttachmentsFromContentFileModel)(null===(_=I.contentObj)||void 0===_?void 0:_.file_model)),(null===(n=I.contentObj)||void 0===n?void 0:n.link_model)&&k.push((0,eH.getAttachmentFromContentLinkModel)(I.contentObj.link_model)),(null===(i=I.contentObj)||void 0===i?void 0:i.image_model)&&k.push(...(0,eH.getAttachmentsFromImageContentEntities)(null===(f=I.contentObj.image_model)||void 0===f?void 0:f.image_list)),(null===(s=I.contentObj)||void 0===s?void 0:s.entities)&&k.push(...(0,eH.getAttachmentsFromNestedContentEntities)(I.contentObj.entities,I.nestedItems)),(0,E.isAliceImageMessage)(R)&&k.push(...(0,eH.getAttachmentsFromImageContentEntities)(null===(h=I.contentObj)||void 0===h?void 0:h.data)),(0,E.isImageTextMessage)(R)&&k.push(...(0,eH.getAttachmentsFromContentRefImageModel)(I.extraExt)),(0,E.isAliceFileMessage)(R)&&k.push(...(0,eH.getAttachmentsFromContentFileModel)(I.contentObj)),(0,E.isVideoGenerationSendMessage)(R)&&k.push(...(null==I?void 0:I.attachments)||[]),((0,E.isWiderTextMessage)(R)||(0,E.isImageMessage)(R))&&(0,o.default)(R,{content_obj:{...R.content_obj,...(0,eX.getEditImageConfigFromExt)(R.ext),...(0,eX.getFinishedImageConfigFromExt)(R.ext),...(0,eX.getTranslateInputConfigFromExt)(R.ext),...(0,eX.getImageInputConfigFromExt)(R.ext),...(0,eX.getReadInputConfigFromExt)(R.ext),...(0,eX.getHoverPositionFromExt)(R.ext)}}),(null===(r=R.content_obj)||void 0===r?void 0:r.image_list)&&((0,o.default)(R.content_obj,{data:R.content_obj.image_list}),null===(C=R.content_obj)||void 0===C||delete C.image_list),(null===(d=R.ext)||void 0===d?void 0:d.generate_mind_map)&&(0,o.default)(R.content_obj,(0,eX.getMindMapFromExt)(R.ext)),(null==R?void 0:null===(c=R.ext)||void 0===c?void 0:c.immersive_reading_files)&&(0,o.default)(R.content_obj,(0,eX.getImmersiveFilesFromExt)(R.ext)),(null==R?void 0:null===(u=R.ext)||void 0===u?void 0:u.need_reference)&&(0,o.default)(R.content_obj,(0,eX.getNeedReferenceFromExt)(R.ext)),(null==R?void 0:null===(v=R.ext)||void 0===v?void 0:v.command)&&(0,o.default)(R.content_obj,{command:R.ext.command}),(0,E.isWriteInputMessage)(R)&&(0,o.default)(R,{content_type:es.ContentType.SamanthaWriteInput}),(null===(g=I.extraExt)||void 0===g?void 0:g.artifact_key)&&(0,o.default)(R.content_obj,{artifact_key:null===(T=I.extraExt)||void 0===T?void 0:T.artifact_key}),(0,eY.createLocalMessage)({localMessageStatus:I.isReady?P?l.LocalMessageStatus.SendingRegenerate:l.LocalMessageStatus.Sending:l.LocalMessageStatus.Preprocessing,message:R,failedExpired:(0,S.getFailedExpired)(I.isReady,I.contentType),messageLinks:x.messageLinkMap[I.resolvedConversationId],isRegenerate:I.isRegenerate,prevMessageId:I.isRegenerate?null==P?void 0:P.regenerateTailMessageId:void 0,localKey:"local_key"in I?I.local_key:"",enterFrom:I.reportParams.enter_from,isReady:I.isReady,botType:I.botType,samanthaChatStage:I.reportParams.samantha_protocol_stage,isNova:I.reportParams.is_nova})};var eZ=a(687780),e0=a(680982),e1=a(702427),e2=a(555897),e8=a(239705);let e7=async function(e){let{beforeSendMessage:t,customSendWaitTimeout:a,lifeCycleContext:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,c.onMessageSessionStart)({slardar:{chat_session_scene:"chat_conversation"}});let u=O.useMessageStore.getState();try{var v,k,b,L,F,j,B,G,z,K,J,q,V,$,H,X,Y,Q,Z,et,eo,en,ei,es,el,er,ed,ec,eu,ev,eg,ep,em,e_,ey,ef,eh,eM,eC,eT,eI;let c;for(let t of(e.forEach(e=>{var t;let{operation:a={},preGeneratedLocalMessageId:n}=e;!n&&(0,o.default)(e,{preGeneratedLocalMessageId:(null==a?void 0:null===(t=a.regenerate)||void 0===t?void 0:t.sentLocalMessageId)||(0,I.createLocalMessageId)()})}),e=await (0,e2.emitMessageProcessBefore)(e[0].localConversationId||e[0].conversationId||"","",e))){let{botId:e,conversationId:a=""}=t;(0,o.default)(t,{sectionId:m.useFeedStore.getState().lastSectionIdMap[a]||"",botId:e||(0,_.getBotIdByConversationId)(a)||""})}let eS=eV(e);for(let e of eS){let t=(0,C.parseJSON)((null==e?void 0:null===(v=e.extraExt)||void 0===v?void 0:v.ext_skill_ab)||(null==e?void 0:null===(k=e.extraExt)||void 0===k?void 0:k.input_skill),{}),a=(null==t?void 0:t.skill_type)||0,n=(0,S.getSamanthaProtocolStage)(a),i=n===f.LaunchStage.Release;(0,o.default)(e,{reportParams:{...e.reportParams,samantha_protocol_stage:n,is_nova:i}})}let ex=eS[0].resolvedConversationId||"",eP=eS[0].localMessageId||"";eS=await (0,e2.emitMessageProcessEnd)(ex,"",eS),await (0,e0.handleLocalBreak)(O.useMessageStore,ex);let eE=e1.messageLifeCycleManager.getSessionIdBySentMessageId(ex,eP);if(await (0,e2.emitMessageSessionStart)(ex,eE,{is_delta:!1}),r){let e=e1.messageLifeCycleManager.getSessionLifeCycleContext(ex,eE);for(let[t,a]of(0,n.default)(r))e.set(t,a)}for(let e of eS){let{operation:t}=e;if(null==t?void 0:null===(L=t.resend)||void 0===L?void 0:null===(b=L.messageLink)||void 0===b?void 0:b.messageId){u.logicalDeleteMessage({conversationId:ex,messageLink:null===(q=t.resend)||void 0===q?void 0:q.messageLink,deleteReply:!0});continue}if(null==t?void 0:null===(j=t.replace)||void 0===j?void 0:null===(F=j.messageLink)||void 0===F?void 0:F.messageId){u.logicalDeleteMessage({conversationId:ex,messageLink:null===(V=t.replace)||void 0===V?void 0:V.messageLink,deleteReply:!0});let e=(0,A.getMessageSelector)(u,ex,{isLocalMessage:!1,messageId:null===(H=t.replace)||void 0===H?void 0:null===($=H.messageLink)||void 0===$?void 0:$.messageId});await (0,e8.abortPullMessage)({replyId:null===(Y=t.replace)||void 0===Y?void 0:null===(X=Y.messageLink)||void 0===X?void 0:X.messageId,localMessageId:null==e?void 0:e.local_message_id});continue}if(null==t?void 0:null===(G=t.resume)||void 0===G?void 0:null===(B=G.messageLink)||void 0===B?void 0:B.messageId){let e=(0,A.getMessageSelector)(u,ex,{isLocalMessage:!1,messageId:null===(Z=t.resume)||void 0===Z?void 0:null===(Q=Z.messageLink)||void 0===Q?void 0:Q.messageId});u.logicalDeleteMessage({conversationId:ex,messageLink:null===(et=t.resume)||void 0===et?void 0:et.messageLink,deleteReply:!0}),await (0,e8.abortPullMessage)({replyId:null===(en=t.resume)||void 0===en?void 0:null===(eo=en.messageLink)||void 0===eo?void 0:eo.messageId,localMessageId:null==e?void 0:e.local_message_id});continue}if(null==t?void 0:null===(K=t.remove)||void 0===K?void 0:null===(z=K.messageLink)||void 0===z?void 0:z.messageId){let e=(0,A.getMessageSelector)(u,ex,{isLocalMessage:!1,messageId:null===(es=t.remove)||void 0===es?void 0:null===(ei=es.messageLink)||void 0===ei?void 0:ei.messageId});u.logicalDeleteMessage({conversationId:ex,messageLink:null===(el=t.remove)||void 0===el?void 0:el.messageLink,deleteReply:!0}),u.updateMessageList({conversationId:ex,immerUpdate:(e,a)=>{var o,n,i,s;(null===(n=t.remove)||void 0===n?void 0:null===(o=n.messageLink)||void 0===o?void 0:o.messageId)&&a.resetMessageLink(null===(s=t.remove)||void 0===s?void 0:null===(i=s.messageLink)||void 0===i?void 0:i.messageId)}}),await (0,e8.abortPullMessage)({replyId:null===(ed=t.remove)||void 0===ed?void 0:null===(er=ed.messageLink)||void 0===er?void 0:er.messageId,localMessageId:null==e?void 0:e.local_message_id});continue}if(null==t?void 0:null===(J=t.regenerate)||void 0===J?void 0:J.sentMessageId){let e=(0,A.getMessageSelector)(u,ex,{isLocalMessage:!1,messageId:null===(ec=t.regenerate)||void 0===ec?void 0:ec.sentMessageId});await (0,e8.abortPullMessage)({replyId:null===(eu=t.regenerate)||void 0===eu?void 0:eu.sentMessageId,localMessageId:null==e?void 0:e.local_message_id})}}eS.map(e=>{e.extraExt=(0,S.getSendExt)(e,u)}),eS.some(e=>e.isRegenerate)||function(e){let{conversationId:t,store:a}=e,{lastAvailableMessage:o}=W(t);(0,P.isRegenerateMessage)(o)&&a.updateMessageList({conversationId:t,immerUpdate(e){let{draftMessageLinks:t,draftRegenerateMessageMap:a,draftMessageMap:n,draftLocalMessageMap:i}=e,s=(0,w.createGetMessage)({localMessageMap:i,messageMap:n});t.forEach(t=>{let n=s(t);if((null==n?void 0:n.reply_id)===(null==o?void 0:o.reply_id)){var i;(null===(i=a.messageMap)||void 0===i?void 0:i[t.messageId])&&delete a.messageMap[t.messageId],n&&(0,E.isMessageFailed)(n)&&t.isLocalMessage&&(0,R.logicalDeleteMessage)(e,t)}})}})}({store:u,conversationId:ex}),u.clearSuggestMessage(ex);let ek=eS.map(e=>{var t;let a=eQ({payload:e,store:u});return(null===(t=e.operation)||void 0===t?void 0:t.remove)||N(u,a,e),(0,i.default)(a)});for(let e of ek){let t=e.local_conversation_id||e.conversation_id||"",a=e1.messageLifeCycleManager.getSessionIdBySentMessageId(t,e.local_message_id||""),o=e1.messageLifeCycleManager.getSessionLifeCycleContext(t,a,""),n=ee.messageServiceContainer.get("chatBotService"),i=ee.messageServiceContainer.get("chatViewService"),r=ee.messageServiceContainer.get("chatConfigService"),{loginSource:c}=(null==r?void 0:r.chatReportParams)||{},{conversation:u}=(0,y.getInfoByConversationIdSelector)(m.useFeedStore.getState(),t,e.bot_id);o.set("chatTeaTraceEvent",new g({commonTraceParams:{chat_scene:eS[0].reportParams.scene,chat_sec_scene:eS[0].reportParams.scene===s.ChatTeaScene.SCENE_RESEND?s.ChatTeaSecScene.SEC_SCENE_RESEND:eS[0].reportParams.sec_scene,chat_type:(0,_.getChatTypeForTea)("",t,(0,_.getInfoByConversationId)(t).botInfo),canvas_type:null==i?void 0:null===(ev=i.getCanvasTeaParams())||void 0===ev?void 0:ev.canvas_type,canvas_sub_type:null==i?void 0:null===(eg=i.getCanvasTeaParams())||void 0===eg?void 0:eg.canvas_sub_type},teaEventTraceParams:{receive_suggests:{},receive_think_reason:{},receive_batch_message:{},send_message:{send_message_type:eS[0].reportParams.message_type,...(null==u?void 0:null===(ep=u.thread_source)||void 0===ep?void 0:ep.source_type)===h.ThreadSourceType.MeetingMinutes?{canvas_id:null==u?void 0:null===(em=u.thread_source.meeting_minutes)||void 0===em?void 0:em.identifier}:{},is_quote:+(null!==(eT=eS[0].reportParams.is_quote)&&void 0!==eT?!!eT:(Number(null===(e_=(0,C.parseJSON)(null===(ey=e.ext)||void 0===ey?void 0:ey.reference_content,{}))||void 0===e_?void 0:e_.length)||0)>0),...eS[0].reportParams.content_type===M.ContentType.Text?{original_content_source:eS[0].reportParams.content_source||l.ContentSource.Other}:{},...c?{previous_page:c}:{},...(null===(ef=eS[0].reportParams)||void 0===ef?void 0:ef.enter_from)==="bot_discover"?{user_id:null==r?void 0:r.userId,req_id:eS[0].reportParams.bot_id?null==n?void 0:null===(eh=n.getBotIdToRequestIdMap())||void 0===eh?void 0:eh[eS[0].reportParams.bot_id]:"",recommend_from:s.ChatTeaRecommendFrom.RECOMMEND_FROM_BOT_LIST_DISCOVER}:{},...location.pathname.includes("/chat/new-thread")||location.pathname.includes("/chat/local_")?{current_page:s.ChatTeaCurrentPage.CURRENT_PAGE_CHAT}:{}}},teaEventOtherTraceParams:{...eS[0].reportParams,...null==i?void 0:i.getCanvasTeaParams()}})),o.set("chatEventContext",new p.ChatEventContext({params:{slardar:{chat_session_scene:"chat_conversation",chat_session_id:a,chat_scene:d(null===(eC=eS[0])||void 0===eC?void 0:null===(eM=eC.reportParams)||void 0===eM?void 0:eM.send_source)}}}))}null==t||t(ek);let eb=[];try{for(let e of ek){c=e;let t=e.local_conversation_id||e.conversation_id||"",a=e1.messageLifeCycleManager.getSessionIdBySentMessageId(t,e.local_message_id||""),o=await (0,e2.emitMessageSendingBefore)(t,a,e);eb.push(o)}}catch(e){if(T.logger.console.info({message:"send message failed",error:e}),eS.forEach(e=>D(u,e)),c){let t=(0,i.default)(c);t.final_status={message:null===(eI=t.final_status)||void 0===eI?void 0:eI.message,session:(0,eZ.getLifeCycleError)(e)},(0,e2.emitMessageSessionEndBySendBeforeError)(ex,eE,t)}return}eb.length||eb.push(...ek),eb.forEach((e,t)=>{var a;(null===(a=eS[t].operation)||void 0===a?void 0:a.remove)||U(u,e,eS[t])});let eR=(0,x.isNeedDowngradeToOldAdapter)(null==eb?void 0:eb[0]);for(let e of(ea({messages:eb,customSendWaitTimeout:a,isNeedDowngrade:eR}),ek)){let t=e.local_conversation_id||e.conversation_id||"",a=e1.messageLifeCycleManager.getSessionIdBySentMessageId(t,e.local_message_id||"");await (0,e2.emitMessageSendingStart)(t,a,e)}}catch(e){throw(0,e2.emitMessageSendingEndByError)("","",{is_delta:!1,final_status:{message:"Error",session:(0,eZ.getLifeCycleError)(e)}}),e}}},845485:function(e,t,a){a.d(t,{genTeaMeta:function(){return h},getAndCheckResolvedConversationId:function(){return S},getFailedExpired:function(){return T},getMessageType:function(){return f},getSamanthaProtocolStage:function(){return C},getSendExt:function(){return I}});var o,n=a(629006),i=a(674157),s=a(461141),l=a(212183),r=a(588426),d=a(645298),c=a(458524),u=a(524129),v=a(322206),g=a(896855),p=a(637319),m=a(630768),_=a(777210);let y=((o={}).Text="text",o.Picture="pic",o.File="file",o),f=e=>{let t={[c.ContentType.Text]:y.Text,[c.ContentType.Image]:y.Picture,[c.ContentType.File]:y.File};return e&&t[e]||y.Text},h=e=>{var t;let a=e.botId||(0,l.getBotIdByConversationId)(e.conversationId)||"",o=_.messageServiceContainer.get("chatBotService"),n=null==o?void 0:o.getBot(a),i=null!==(t=e.reportParams.conversation_type)&&void 0!==t?t:(0,r.getConversationTypeById)(e.conversationId);return{bot_id:a,chat_type:(0,l.getChatTypeForTea)("",e.conversationId,n,i),conversation_type:i}},M=[u.SkillType.AcademicSearch],C=e=>{let t=_.messageServiceContainer.get("chatConfigService",!0),a=(null==t?void 0:t.appId)&&[g.WEB_DOUBAO_APP_ID,g.DESKTOP_DOUBAO_APP_ID,g.EXT_DOUBAO_APP_ID].includes(null==t?void 0:t.appId),o=!!~M.findIndex(t=>t===e);return a?o?void 0:v.LaunchStage.Release:void 0},T=(e,t)=>{if(e){let{sendMessageStartTimeout:e=d.defaultSendMessageStartTimeout}=(0,s.getChatConfig)("chatMessageConfig")||{};return Date.now()+e}if(t!==c.ContentType.File)return Date.now()+d.sendImageMessagePreprocessTimeout},I=(e,t)=>{let{resolvedConversationId:a,extraExt:o,reportParams:{scene:s}}=e,{replace:l,remove:r,regenerate:d,resume:c}=e.operation||{},u=function(e){var t;let{conversationId:a,store:o}=e,s=(0,p.getLastAvailableReplyMessageSelector)(o,a);if(!s||(0,n.isImageMessage)(s)||(0,n.isCreationBlockMessage)(s))return;let l=(0,m.findLastLink)(o.messageLinkMap[a],e=>{let t=(0,p.getMessageSelector)(o,a,e);return(0,i.isMessageAvailable)(t)&&(0,i.isRegenerateMessage)(t)});if(l&&!(null==l?void 0:l.isLocalMessage)&&(null===(t=(0,p.getMessageSelector)(o,a,l))||void 0===t?void 0:t.reply_id)===s.reply_id)return l.messageId}({store:t,conversationId:a});return{stream:"1",answer_with_suggest:"1",wiki:"2",media_search_type:"1",...l?{replace:"1"}:{},...r?{delete:"1"}:{},...d?{regen:"1"}:{},...c?{resume:"1"}:{},...l||c||r||d||!u?{}:{lastRegenerateSelectedMessageId:u},..."onboarding_suggestion"===s?{onboarding_v2:"1"}:{},..."keyboard_unlog"===s?{scene:s}:{},...o}},S=e=>{let t=e.localConversationId||e.conversationId;if(!t)throw Error("conversationId is empty");return t}},777210:function(e,t,a){a.r(t),a.d(t,{messageServiceContainer:function(){return w},createChatMessageService:function(){return F},ChatMessageService:function(){return O}});var o=a(907929),n=a(430896),i=a(698392),s=a(922851),l=a(831566),r=a(201272),d=a(178230),c=a(266655),u=a(251913),v=a(670899),g=a(475261),p=a(137396),m=a(569248),_=a(689368),y=a(545652),f=a(83990),h=a(702427),M=a(555897),C=a(818289);let T={process(e){let{data:t}=e;if(t.event_type===C.EventType.Cmd){var a;return{cmd:null===(a=t.cmd)||void 0===a?void 0:a.cmd_type,data:{version:"1.0",data:t.cmd}}}if(t.cmd)return{cmd:t.cmd,data:{version:"2.0",data:t.downlink_body}}}};var I=a(516655);let S={handle:e=>{e.cmd&&e.data&&(0,I.getMessageCmdPluginMatcher)().then(t=>{let a=t.filter(t=>{var a;return null===(a=t.matchPlugin)||void 0===a?void 0:a.call(t,e)}).map(e=>e.pluginIdentifier);if(d.logger.console.info({message:`Received Cmd: ${e.cmd}`}),!a.length){d.logger.console.info({message:`Skip Cmd: ${e.cmd}`});return}(0,_.getMessageCmdPluginList)(a).then(t=>{t.forEach(t=>{var a;return null==t?void 0:null===(a=t.handleCmd)||void 0===a?void 0:a.call(t,e)})})})}};var x=a(472667);async function P(e){let{getCommonSocketParams:t,reportEvent:a,config:o,featureConfig:n,refreshSocketConfig:l}=e;try{var r,d;let e=await (0,_.getChatProtocolPlugin)("AliceChatSocket"),u=await (0,s.getChatService)("chatSocketService");if(null==u||u.init({config:o,options:{consoleSocketPacket:null==n?void 0:n.consoleSocketPacket,refreshSocketConfig:l,getSocketParams:t}}),u){let e=await (0,s.getChatService)("chatCommandService");null==e||e.registerSocketClient(u),null==e||e.registerCommandProcessor(T),null==e||e.registerCommandHandler(S)}let y=()=>{null==u||u.off("open",C)},f=setTimeout(()=>{null==a||a.error({reason:"ws_failed"}),y()},5e3),C=()=>{null==a||a.addDurationPoint("ws"),null==a||a.addDurationPoint("success"),null==a||a.success(),y(),clearTimeout(f)};null==e||e.init();let I=await (0,i.getAsyncChatStore)("samanthaChatProtocolStore"),x=(0,m.getResumeChunkTaskIfNeed)((0,c.default)(I.getState().samanthaChatTaskMap));x.length&&(x.forEach(e=>{var t,a;let o=(null===(a=e.messages)||void 0===a?void 0:null===(t=a[0])||void 0===t?void 0:t.conversation_id)||"",n=e.localMessageId;(0,M.toggleMessageSessionStartWithResumeTask)(o,n)}),null===(r=await (0,_.getChatProtocolPlugin)("SamanthaChat"))||void 0===r||r.resumeTask(x));let P=await (0,i.getAsyncChatStore)("aliceChatProtocolStore");P.setState({aliceChatStreamInitConfig:{poolSize:3,retryAttempt:5,binaryType:null==n?void 0:n.binaryType},aliceChatFallbackInitConfig:o});let E=(0,m.getResumeChunkTaskIfNeed)((0,c.default)(P.getState().aliceChatStreamTaskMap));E.length&&(E.forEach(e=>{let t=e.conversationId||"",a=e.replyId,o=h.messageLifeCycleManager.getSessionIdBySentMessageId(t,a);h.messageLifeCycleManager.getSessionLifeCycleContext(t,o,"").set("chatEventContext",new g.ChatEventContext({params:{slardar:{chat_session_scene:"resume_task",chat_session_id:o,chat_scene:p.ChatSceneEnum.DEFAULT}}})),(0,v.onMessageSessionStart)({slardar:{chat_session_scene:"resume_task",chat_session_id:o}}),(0,M.emitMessageSessionStartWithResumeTask)(t,o,{is_delta:!1})}),null===(d=await (0,_.getChatProtocolPlugin)("AliceChatStream"))||void 0===d||d.resumeTask(E)),null==u||u.on("open",C)}catch(e){throw(0,y.dropAdapters)(),e}}let E=async()=>{try{var e,t,a,o;let n=await (await (0,x.getMessageApiClient)()).rateLimit();f.useMessageStore.getState().updateRateLimitConfig({limitExpired:(null===(e=n.data)||void 0===e?void 0:e.limit_time)?Date.now()+(null===(t=n.data)||void 0===t?void 0:t.limit_time)*1e3:void 0,limitTips:(null===(a=n.data)||void 0===a?void 0:a.limit_tips)||"",isLimited:!!(null===(o=n.data)||void 0===o?void 0:o.is_limit)})}catch(e){e instanceof Error&&d.logger.persist.error({message:"get rate limit failed",error:e})}},k=(0,u.default)(P);var b=a(382973),R=a(382757);function L(e,t,a){var o;return(t="symbol"==typeof(o=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var o=a.call(e,t||"default");if("object"!=typeof o)return o;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?o:o+"")in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}let A=(e,t)=>(0,o.default)(e,e=>e.namespace===t);class O{_clearSendMessageCallbacks(){let{_sendMessageCallbacks:e}=this;this._sendMessageCallbacks=[],e.forEach(e=>e())}getMessageActionPlugins(){var e,t;return null!==(t=null===(e=this._messageActionPlugins)||void 0===e?void 0:e.map(e=>e.Plugin))&&void 0!==t?t:[]}async getAsyncMessageActionPlugins(){var e,t;return(null!==(t=await (null===(e=this._getAsyncMessageActionPlugins)||void 0===e?void 0:e.call(this)))&&void 0!==t?t:[]).map(e=>e.Plugin)}resetStore(){try{f.useMessageStore.setState(b.defaultMessageStore),(0,i.getAsyncChatStore)("samanthaChatProtocolStore").then(e=>{e.setState({samanthaChatTaskMap:{}})}),(0,i.getAsyncChatStore)("aliceChatProtocolStore").then(e=>{e.setState({aliceChatStreamTaskMap:{}})})}catch(e){d.logger.console.info("reset message service store failed")}}async tryInitMessageProtocolService(e){var t;return(e&&this._sendMessageCallbacks.push(e),null===(t=this._initMessageProtocolServiceConfig)||void 0===t?void 0:t.config)?(this._messageServiceIsInitialed||(await k(this._initMessageProtocolServiceConfig),this._messageServiceIsInitialed=!0,await E()),this._clearSendMessageCallbacks(),Promise.resolve({isInitialed:!0})):Promise.resolve({isInitialed:!1})}updateInitMessageProtocolServiceConfig(e){this._initMessageProtocolServiceConfig=e}handleAppInitialed(){this._appIsInitialed=!0,this.tryInitMessageProtocolService()}initEventBinding(){l.DeprecatedChatEvent.on("chat.service.resetAll",this.resetStore.bind(this)),r.DeprecatedFlowEvent.on("app.init",this.handleAppInitialed.bind(this))}async sendMessage(e,t){let a=await (0,s.getChatService)("chatMessageService");return(null==a?void 0:a.deprecatedSendMessage)?a.deprecatedSendMessage(e,t):(0,R.sendSupportedMessage)(e,t)}destroy(){l.DeprecatedChatEvent.off("chat.service.resetAll",this.resetStore),r.DeprecatedFlowEvent.off("app.init",this.handleAppInitialed)}constructor(e){L(this,"ctx",void 0),L(this,"_appIsInitialed",!1),L(this,"_messageActionPlugins",void 0),L(this,"_initMessageProtocolServiceConfig",void 0),L(this,"_messageActionPluginInstances",void 0),L(this,"_messageServiceIsInitialed",!1),L(this,"_sendMessageCallbacks",[]),L(this,"_getAsyncMessageActionPlugins",void 0);let{plugins:t=[],messageProtocolServiceOptions:a}=e;this._initMessageProtocolServiceConfig=a,this._messageActionPlugins=A(t,"message-action"),this._getAsyncMessageActionPlugins=e.getAsyncMessageActionPlugins,this.initEventBinding(),this._appIsInitialed=!1,this._messageServiceIsInitialed=!1}}let w=(0,n.createServiceContainer)(),F=e=>(w.service||(w.service=new O(e)),w.service)},847857:function(e,t,a){a.d(t,{getMessageText:function(){return c},getMessageTextFromLyric:function(){return u},getSearchReplyTypeFromTextMessage:function(){return v},getTextFromTextMessage:function(){return r}});var o=a(218679),n=a(214071),i=a(82760),s=a(629006),l=a(165482);let r=e=>{if((0,s.isWiderTextMessage)(e)||(0,s.isSimpleSearchMessage)(e)||(0,s.isVideoGenerationSendMessage)(e)){var t;return(0,s.isSuperTaskMessage)(e)?d(e):null==e?void 0:null===(t=e.content_obj)||void 0===t?void 0:t.text}},d=e=>{var t,a,o,n,r;if(!e||!(0,s.isSuperTaskMessage)(e))return;let d="";return Array.isArray(e.content_obj)?e.content_obj.filter(e=>(null==e?void 0:e.block_type)===i.ContentType.BLOCK_TEXT).forEach(e=>{let t=(0,l.parseJSON)(e.content,{});t.text&&(d+=`${t.text}
`)}):Array.isArray((null==e?void 0:null===(t=e.content_blocks_tree)||void 0===t?void 0:t.children)||{})&&(null==e||null===(r=e.content_blocks_tree)||void 0===r||null===(n=r.children)||void 0===n||null===(o=n.filter(e=>(null==e?void 0:e.block_type)===i.ContentType.BLOCK_TEXT))||void 0===o||o.forEach(e=>{let t=(null==e?void 0:e.content_obj)||{};(null==t?void 0:t.text)&&(d+=`${t.text}
`)})),d||(null==e?void 0:null===(a=e.content_obj)||void 0===a?void 0:a.text)},c=(e,t,a)=>{if(!e)return;let i=r(e);if((0,o.default)(i))return i;if(!((0,s.isMessageFailed)(e)||(0,s.isWriteArtifactMessage)(e)))return t?(0,n.default)(null==e?void 0:e.content_obj)?`${a} message.content\u{FF1A}${null==e?void 0:e.content}`:`${a} message.content\u{FF1A}

\`\`\`json
${JSON.stringify(null==e?void 0:e.content_obj,void 0,2)}
\`\`\`

`:a},u=e=>{var t;return(0,s.isLyricsToSongLyricMessage)(e)&&(null==e?void 0:null===(t=e.content_obj)||void 0===t?void 0:t.text)||""},v=e=>(0,s.isSimpleSearchTextMessage)(e)?"simple_search":(0,s.isDeepSearchMessage)(e)?"deep_search":(0,s.isAliceCopilotSearchTextMessage)(e)?"complex_search":"ai_search"},545652:function(e,t,a){a.d(t,{dropAdapters:function(){return i}});var o=a(703409),n=a(689368);async function i(){let e=await (0,n.getChatProtocolPlugin)("AliceChatStream"),t=await (0,n.getChatProtocolPlugin)("AliceChatFallback"),a=await (0,n.getChatProtocolPlugin)("SamanthaChat");(0,o.unsubscribeEvent)([e,t,a])}}}]);