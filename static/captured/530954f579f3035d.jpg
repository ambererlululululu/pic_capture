"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["1805"],{604023:function(e,t,a){a.r(t),a.d(t,{AttachmentsStoreService:function(){return w}});var r=a(544044),l=a(705033),i=a(385093),n=a(214071),o=a(746479),c=a(698392),s=a(922851),d=a(165876),u=a(230932),h=a(212183),p=a(777422),m=a(910214),v=a(856392);let S=(e,t)=>{let{chatId:a,skillType:r="default"}=t;a&&(0,c.getChatStore)("attachmentsStore").setState((0,o.produce)(t=>(0,l.default)(t,["attachmentsMap",a,`_${r}`],(0,i.default)(e)?e(f({chatId:a,skillType:r})):e)))},f=e=>{var t,a;let{chatId:r,skillType:l="default"}=e;return r&&null!==(a=null===(t=(0,c.getChatStore)("attachmentsStore").getState().attachmentsMap[r])||void 0===t?void 0:t[`_${l}`])&&void 0!==a?a:[]},g=e=>{let{type:t,fileName:a,from:l,fileKey:i,size:n,blobUrl:o,url:s}=e,d=(0,r.default)(),u={type:t,fileName:a,localKey:d,from:l,size:n,url:s};S(e=>[...e,u],e);let h=(0,c.getChatStore)("attachmentUploadStore");"link"!==t&&h.setState(e=>{let a={...e.preprocessTaskMap,[d]:{type:t,key:i,localKey:d,percent:100,loading:!1,failed:!1,fileKey:i,parseState:1,parsePercent:100,size:n,blobUrl:o}};return{...e,preprocessTaskMap:a}})},y=e=>{var t,a;let{chatId:r,skillType:l}=e;return null===(a=(0,c.getChatSlice)("attachmentUploadStore").preGeneratedLocalMessageIdMap)||void 0===a?void 0:null===(t=a[r])||void 0===t?void 0:t[`_${l}`]},_=e=>{var t;let{chatId:a,skillType:r="default",disablePreprocess:l,file:i,type:n,ctx:o}=e,d=(null===(t=u.useFeedStore.getState().conversationMap[a])||void 0===t?void 0:t.last_section_id)||"";(0,s.getChatService)("attachmentUploadStoreService").then(t=>{var s,u;let h=(0,c.getChatSlice)("attachmentUploadStore"),p=y({chatId:a,skillType:r});p||null==t||t.updatePreGeneratedLocalMessageId(e),p=y({chatId:a,skillType:r});let{local_key:m}=null!==(u=null==t?void 0:t.preprocessFile(i,n,o,{preHandle:l?void 0:{version:"pre_handle_v2",preGeneratedLocalMessageId:p||"",sectionId:d,enableImageVlm:null===(s=h.attachmentUploadConfig)||void 0===s?void 0:s.enableImageVlm}}))&&void 0!==u?u:{};if(m){let t={type:n,file:i,localKey:m,from:o.from};S(e=>[...e,t],e)}})},C=async e=>{let{files:t,type:a,ctx:r}=e,l=await (0,s.getChatService)("attachmentUploadStoreService");if(!l)return;let{local_key:i}=await l.preprocessDir(t,a,r,{preHandle:{version:"pre_handle_code"}}),n=t[0].webkitRelativePath,o=null==n?void 0:n.split("/")[0],c={type:"directory",files:t,localKey:i,from:r.from,dirName:o};S(e=>[...e,c],e)},k=e=>{let{url:t,fileType:a,...r}=e;S(e=>[...e,{type:"link",url:t,fileType:a}],r)},A=async e=>{let{url:t,ctx:a}=e,r=await (0,s.getChatService)("attachmentUploadStoreService");if(!r)return;let{local_key:l}=r.preprocessGithubLink(t,a),i={type:"link",url:t,localKey:l};S(e=>[...e,i],e)},I=e=>{let{index:t,url:a,fileType:r,...l}=e;S(e=>{let l=e[t];if((null==l?void 0:l.type)==="link"&&l.url===a)return e;let i=[...e];return i.splice(t,1,{type:"link",url:a,fileType:r}),i},l)},L=e=>{let{key:t,fileName:a,size:r,...l}=e;S(e=>[...e,{type:"remote",key:t,fileName:a,size:r,from:"remote"}],l)},U=async e=>{let t=e.filter(e=>!("from"in e&&"ai-space"===e.from)).map(e=>{if((0,d.isImage)(e)||(0,d.isFile)(e)){let t=(0,c.getChatStore)("attachmentUploadStore").getState().preprocessTaskMap[e.localKey];return{uri:null==t?void 0:t.key,data_type:(0,d.isImage)(e)?"image":"file"}}}).filter(e=>!!(null==e?void 0:e.uri)),a=(0,v.createReportEvent)({eventName:"delete_attachment_files",meta:{count:e.length,uri_count:t.length,types:e.map(e=>e.type).join(",")}});if((0,n.default)(t)){a.success({meta:{reason:"delete_attachment_files_empty"}});return}try{await m.resourceApiService.DeleteFiles({uris:t}),a.addDurationPoint("success"),a.success()}catch(e){a.error({reason:"delete_attachment_files_error",error:e instanceof Error?e:Error(String(e))})}},b=e=>{let{options:t,index:a,...r}=e,{hardDelete:l=!0}=null!=t?t:{},i=f(r),o=i[a];if(!o)return;let u=i.filter(e=>e!==o);if(((0,d.isImage)(o)||(0,d.isFile)(o))&&(0,s.getChatService)("attachmentUploadStoreService").then(e=>{null==e||e.cancel(o.localKey)}),!(0,d.isLink)(o)&&!(0,d.isRemote)(o)&&!(0,d.isDir)(o)){let e=(0,c.getChatStore)("attachmentUploadStore").getState().preprocessTaskMap[o.localKey];(0,p.trackEvent)("click_attachment_delete",{bot_id:(0,h.getBotIdByConversationId)(r.chatId),uri:e.key||"",success:100===e.percent?"1":"0"})}S(u,r),(0,n.default)(u)&&(0,s.getChatService)("attachmentUploadStoreService").then(e=>{null==e||e.updatePreGeneratedLocalMessageId(r)}),l&&U([o])},M=e=>{let{options:t,...a}=e,{hardDelete:r=!1}=null!=t?t:{};(0,s.getChatService)("attachmentUploadStoreService").then(e=>{null==e||e.updatePreGeneratedLocalMessageId(a)}),r&&U(f(a)),S([],a)},D=e=>{(0,c.getChatStore)("attachmentsStore").setState((0,o.produce)(t=>{t.attachmentsMap[e.chatId]={}}))},K=()=>{(0,c.getChatStore)("attachmentsStore").setState((0,o.produce)(e=>{e.attachmentsMap={}}))},E=e=>{let{index:t,...a}=e,r=f(a)[t];!(!r||(0,d.isLink)(r)||(0,d.isRemote)(r))&&(0,s.getChatService)("attachmentUploadStoreService").then(e=>{var t,l;null==e||e.reUpload(null!==(t=r.localKey)&&void 0!==t?t:"",null!==(l=(0,h.getBotIdByConversationId)(a.chatId))&&void 0!==l?l:"")})};function P(e,t,a){var r;return(t="symbol"==typeof(r=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var r=a.call(e,t||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?r:r+"")in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class w{constructor(){P(this,"addAttachment",_),P(this,"addDirAttachment",C),P(this,"deleteAttachment",b),P(this,"clearAttachments",M),P(this,"clearChatAttachments",D),P(this,"clearAllAttachments",K),P(this,"reuploadAttachment",E),P(this,"addLink",k),P(this,"addGitHubLink",A),P(this,"replaceLink",I),P(this,"addRemoteAttachment",L),P(this,"addAttachmentDirectly",g)}}}}]);