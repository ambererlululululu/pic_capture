"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["78568"],{544052:function(t,e,s){s.d(e,{FileTaskErrorType:function(){return i},ReadOnlyUploadTaskType:function(){return r},UploadTaskStatus:function(){return a}});var r={File:"File",Directory:"Directory"},a={Pending:"Pending",Inflight:"Inflight",Success:"Success",Error:"Error",Paused:"Paused"},i={UploadError:"UploadError",MountError:"MountError",UnsupportedFileType:"UnsupportedFileType"}},433788:function(t,e,s){s.d(e,{DirectoryService:function(){return c}});var r=s(544044),a=s(544052),i=s(436114);function o(t,e,s){var r;return(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var r=s.call(t,e||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?r:r+"")in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class l{addChild(t){this.children.push(t)}constructor({name:t,isDirectory:e,parentNode:s,file:a,isRoot:i=!1}){o(this,"id",(0,r.default)()),o(this,"name",void 0),o(this,"isDirectory",void 0),o(this,"parentNode",void 0),o(this,"children",[]),o(this,"path",""),o(this,"file",void 0),o(this,"isRoot",void 0),this.name=t,this.isDirectory=e,this.parentNode=s,this.file=a,this.isRoot=i||!1}}class n{buildTree(t){for(let s of(this.root=new l({name:"root",isDirectory:!0,parentNode:null,file:new File([],"root")}),t)){var e;let t=(null===(e=s.webkitRelativePath||s.customFilePath)||void 0===e?void 0:e.split("/"))||[],r=this.root,a="";for(let e=0;e<t.length;e++){let i=t[e];a+=(0===e?"":"/")+i;let o=r.children.find(t=>t.name===i);if(o)r=o;else{let o=e<t.length-1,n=new l({name:i,isDirectory:o,parentNode:r,file:s,isRoot:o&&0===e});n.path=a,r.addChild(n),r=n}}}return this.root}bfsTraverse(t){if(!this.root)return;let e=[this.root];for(;e.length>0;){let s=e.shift();s!==this.root&&t(s),e.push(...s.children)}}dfsTraverse(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.root,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i.default;if(t)for(let s of(t!==this.root&&e(t),t.children))this.dfsTraverse(s,e)}displayTree(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.root,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s="";if(t!==this.root){let r="\u2502  ".repeat(e-1)+(e>0?"\u251C\u2500 ":"");s+=`<div class="node">
              ${r}<span class="${(null==t?void 0:t.isDirectory)?"folder":"file"}">
              ${(null==t?void 0:t.isDirectory)?"\uD83D\uDCC1":"\uD83D\uDCC4"} ${null==t?void 0:t.name}
              </span>
          </div>`}for(let r of(null==t?void 0:t.children)||[])s+=this.displayTree(r,e+1);return s}constructor(){o(this,"root",null)}}var u=s(107431);class d extends u.AbstractUploadTask{get canPause(){return!1}get canRetry(){return!1}run(){}pause(){}retry(){}constructor({nodeId:t,...e}){super(e),this.nodeId=t,this._status$.next(a.UploadTaskStatus.Success)}}function p(t,e,s){var r;return(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var r=s.call(t,e||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?r:r+"")in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class c{uploadFiles(t,e){let{mountNodeId:s,meta:a}=e,i=[],o=new d({nodeId:s});this.tasksMap.set(o.id,o);let l=(0,r.default)();return t.forEach(t=>{let e=this.createFileTask({parentTask:o,file:t,batchId:l,meta:a}),s=e.id;this.tasksMap.set(s,e),i.push(e)}),this.startRunTaskParallel(),i.map(t=>t.toReadOnly())}uploadDirectory(t,e){let{mountNodeId:s,meta:a}=e,i=[],o=function(t){let e=new n;return e.buildTree(t),e}(t),l=new d({nodeId:s||""});this.tasksMap.set(l.id,l);let u=(0,r.default)();return o.bfsTraverse(t=>{if(0===t.file.size)return;let{parentNode:e}=t,s=(null==e?void 0:e.parentNode)?this.tasksMap.get(e.id):l,r=t.isDirectory?this.createDirectoryTask({id:t.id,parentTask:s,directoryName:t.name,batchId:u,meta:a,isRoot:t.isRoot}):this.createFileTask({id:t.id,parentTask:s,file:t.file,batchId:u,meta:a}),o=r.id;i.push(r),this.tasksMap.set(o,r)}),this.startRunTaskParallel(),i.map(t=>t.toReadOnly())}startRunTaskParallel(){let t=[...this.runningTasksInfoMap.values()];if(t.length>=6){t.forEach(t=>t.task.run());return}let e=6-t.length,s=[...this.tasksMap.values()].filter(t=>t.getStatus()===a.UploadTaskStatus.Pending).slice(0,e);s.length&&s.forEach(t=>{let{id:e}=t,s={task:t};this.runningTasksInfoMap.set(e,s);let r=t.status$.subscribe(t=>{if([a.UploadTaskStatus.Success,a.UploadTaskStatus.Paused,a.UploadTaskStatus.Error].includes(t)){var s;null===(s=r.unsubscribe)||void 0===s||s.call(r),this.runningTasksInfoMap.delete(e),setTimeout(()=>{this.startRunTaskParallel()},100);return}});s.unsubscribe=()=>r.unsubscribe(),t.run()})}pauseTask(t){let e=this.tasksMap.get(t);(null==e?void 0:e.canPause)&&e.pause()}pauseAllTasks(){[...this.tasksMap.values()].filter(t=>t.canPause).forEach(t=>{t.pause()})}retryTask(t){let e=this.tasksMap.get(t);(null==e?void 0:e.canRetry)&&(e.retry(),this.startRunTaskParallel())}retryAllTasks(){[...this.tasksMap.values()].filter(t=>t.canRetry).forEach(t=>{t.retry()}),this.startRunTaskParallel()}retryAllFailedTasks(){[...this.tasksMap.values()].filter(t=>t.getStatus()===a.UploadTaskStatus.Error&&t.canRetry).forEach(t=>{t.retry()}),this.startRunTaskParallel()}retryAllPausedTasks(){[...this.tasksMap.values()].filter(t=>t.getStatus()===a.UploadTaskStatus.Paused&&t.canRetry).forEach(t=>{t.retry()}),this.startRunTaskParallel()}deleteTask(t){var e;let s=this.tasksMap.get(t);null==s||s.destroy();let r=this.runningTasksInfoMap.get(t);null==r||null===(e=r.unsubscribe)||void 0===e||e.call(r),this.runningTasksInfoMap.delete(t),this.tasksMap.delete(t)}deleteAllTasks(){[...this.tasksMap.keys()].forEach(t=>{this.deleteTask(t)})}destroy(){this.deleteAllTasks()}constructor({createFileTask:t,createDirectoryTask:e}){p(this,"tasksMap",new Map),p(this,"runningTasksInfoMap",new Map),p(this,"createFileTask",void 0),p(this,"createDirectoryTask",void 0),this.createFileTask=t,this.createDirectoryTask=e}}},686761:function(t,e,s){s.d(e,{AbstractUploadDirectoryTask:function(){return l}});var r=s(544052),a=s(178230),i=s(107431);function o(t,e,s){var r;return(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var r=s.call(t,e||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?r:r+"")in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class l extends i.AbstractUploadTask{run(){if(!this.canRun){a.logger.persist.info({eventName:"DirectoryTask_CanNotRun"});return}if(this.getStatus()===r.UploadTaskStatus.Paused)return;a.logger.persist.info({eventName:"DirectoryTask_Start"});let{parentTask:t}=this;if(!t){a.logger.persist.info({eventName:"DirectoryTask_CompleteWithoutMount"}),this._status$.next(r.UploadTaskStatus.Success);return}t.getStatus()===r.UploadTaskStatus.Error?(a.logger.persist.info({eventName:"DirectoryTask_ReadyToMount_ParentTaskErrorRetry"}),t.retry()):t.run(),this._status$.next(r.UploadTaskStatus.Inflight),t.status$.subscribe(async t=>{if(t===r.UploadTaskStatus.Success){a.logger.persist.info({eventName:"DirectoryTask_MountStart"});try{await this.mountNode(),this._status$.next(r.UploadTaskStatus.Success),a.logger.persist.info({eventName:"DirectoryTask_MountSuccess"})}catch(t){t instanceof Error&&a.logger.persist.error({eventName:"DirectoryTask_MountFailed",error:t}),this._status$.next(r.UploadTaskStatus.Error)}}})}get canPause(){return!1}pause(){}toReadOnly(){return{...super.toReadOnly(),type:r.ReadOnlyUploadTaskType.Directory,isRoot:this.isRoot}}constructor({directoryName:t,isRoot:e,meta:s,...r}){super(r),o(this,"directoryName",void 0),o(this,"isRoot",!1),this.directoryName=t,this.isRoot=!!e,this.meta=s}}},661538:function(t,e,s){s.d(e,{AbstractUploadFileTask:function(){return p}});var r=s(701083),a=s(544052),i=s(922851),o=s(698392),l=s(563143),n=s(178230),u=s(107431);function d(t,e,s){var r;return(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var r=s.call(t,e||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?r:r+"")in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class p extends u.AbstractUploadTask{getErrorType(){return this.errorType}async run(){if(!this.canRun){n.logger.persist.info({eventName:"FileTask_CanNotRun"});return}if(this.uploadResult){this.executeMountNode();return}let{file:t}=this;if(await this.tryResumeUploading())return;this._status$.next(a.UploadTaskStatus.Inflight),n.logger.persist.info({eventName:"FileTask_UploadStart",meta:{size:t.size}});let e={complete:e=>{n.logger.persist.info({eventName:"FileTask_UploadComplete",meta:{size:t.size}}),this.uploadResult=e.uploadResult;let{parentTask:s}=this;if(!s){n.logger.persist.info({eventName:"FileTask_CompleteWithoutMount"}),this._status$.next(a.UploadTaskStatus.Success);return}s.getStatus()===a.UploadTaskStatus.Error?(n.logger.persist.info({eventName:"FileTask_ReadyToMount_ParentTaskErrorRetry"}),s.retry()):s.run(),s.status$.subscribe(t=>{t===a.UploadTaskStatus.Success&&(n.logger.persist.info({eventName:"FileTask_MountStart"}),this.executeMountNode())})},progress:t=>{let e=Number(t.percent);Number.isFinite(e)&&this._uploadPercent$.next(e)},error:()=>{n.logger.persist.info({eventName:"FileTask_UploadFailed",meta:{size:this.file.size}}),this.errorType=a.FileTaskErrorType.UploadError,this._status$.next(a.UploadTaskStatus.Error)}};if(this.getCustomUploader){let s=await this.getCustomUploader();if(s){null==s||s.upload(t,{complete:e.complete,progress:e.progress,error:e.error});return}}let s=await (0,i.getChatService)("attachmentUploadStoreService");if(!s)return;let{local_key:r}=s.preprocessFile(t,this.preprocessTaskType(),void 0,{calculateMd5:this.calculateMd5,fileUploadCallbacks:e});this.uploadFileKey=r}async pause(){if(!this.canPause)return;if(this.getStatus()===a.UploadTaskStatus.Pending){this._status$.next(a.UploadTaskStatus.Paused);return}let t=this.getFileKey();if(this.getStatus()===a.UploadTaskStatus.Inflight&&this.uploadFileKey&&t){let e=await (0,i.getChatService)("attachmentUploadStoreService");null==e||e.pause(t,this.preprocessTaskType()),this._status$.next(a.UploadTaskStatus.Paused)}}async executeMountNode(){try{await this.mountNode(),this._status$.next(a.UploadTaskStatus.Success),n.logger.persist.info({eventName:"FileTask_MountSuccess"})}catch(t){n.logger.persist.info({eventName:"FileTask_MountFailed",error:t}),this.errorType=a.FileTaskErrorType.MountError,this._status$.next(a.UploadTaskStatus.Error)}}async tryResumeUploading(){if(!this.uploadFileKey)return!1;let{fileKey:t,loading:e}=(0,o.getChatStore)("attachmentUploadStore").getState().preprocessTaskMap[this.uploadFileKey];if(!t||!e)return!1;n.logger.persist.info({eventName:"FileTask_UploadResume",meta:{size:this.file.size}});let s=await (0,i.getChatService)("attachmentUploadStoreService");return null==s||s.resume(t,this.preprocessTaskType()),this._status$.next(a.UploadTaskStatus.Inflight),!0}getUploadResult(){return this.uploadResult}toReadOnly(){return{...super.toReadOnly(),type:a.ReadOnlyUploadTaskType.File,uploadPercent$:this.uploadPercent$,getFileLocalKey:()=>this.uploadFileKey,getFile:()=>this.file,getErrorType:()=>this.errorType}}preprocessTaskType(){return(0,l.fileIsImage)(this.file)?"image":"file"}getFileKey(){if(!this.uploadFileKey)return;let{fileKey:t}=(0,o.getChatStore)("attachmentUploadStore").getState().preprocessTaskMap[this.uploadFileKey]||{};return t}async destroy(){if(super.destroy(),this.uploadFileKey){let{fileKey:t,loading:e}=(0,o.getChatStore)("attachmentUploadStore").getState().preprocessTaskMap[this.uploadFileKey];if(t&&e){n.logger.persist.info({eventName:"FileTask_UploadCancel"});let e=await (0,i.getChatService)("attachmentUploadStoreService");null==e||e.cancel(t)}}}constructor({file:t,...e}){super(e),d(this,"errorType",void 0),d(this,"file",void 0),d(this,"uploadFileKey",null),d(this,"uploadResult",void 0),d(this,"_uploadPercent$",new r.BehaviorSubject(0)),d(this,"uploadPercent$",this._uploadPercent$.asObservable()),d(this,"getCustomUploader",void 0),d(this,"calculateMd5",!0),this.file=t}}},107431:function(t,e,s){s.d(e,{AbstractUploadTask:function(){return l}});var r=s(544044),a=s(701083),i=s(544052);function o(t,e,s){var r;return(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var r=s.call(t,e||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?r:r+"")in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class l{get canPause(){return[i.UploadTaskStatus.Pending,i.UploadTaskStatus.Inflight].includes(this.getStatus())}get canRetry(){return[i.UploadTaskStatus.Paused,i.UploadTaskStatus.Error].includes(this.getStatus())}get canRun(){return![i.UploadTaskStatus.Inflight,i.UploadTaskStatus.Success].includes(this.getStatus())&&!this.isDestroyed}get isDestroyed(){return this._isDestroyed}retry(){this.canRetry&&this._status$.next(i.UploadTaskStatus.Pending)}toReadOnly(){return{id:this.id,getNodeId:()=>this.nodeId,status$:this.status$,getStatus:()=>this._status$.value,getParentNodeId:()=>{var t;return null===(t=this.parentTask)||void 0===t?void 0:t.getNodeId()},getMeta:()=>this.meta}}async mountNode(){return Promise.reject(Error("not implemented"))}destroy(){this._status$.complete(),this._isDestroyed=!0}constructor({parentTask:t,id:e,batchId:s}){o(this,"_isDestroyed",!1),o(this,"id",void 0),o(this,"batchId",void 0),o(this,"nodeId",void 0),o(this,"_status$",new a.BehaviorSubject(i.UploadTaskStatus.Pending)),o(this,"parentTask",void 0),o(this,"status$",this._status$.asObservable()),o(this,"meta",void 0),o(this,"getStatus",()=>this._status$.value),o(this,"getNodeId",()=>this.nodeId),this.parentTask=t,this.id=e||(0,r.default)(),this.batchId=s}}}}]);