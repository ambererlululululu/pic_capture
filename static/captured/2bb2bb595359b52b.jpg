"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["97005"],{296493:function(e,t,s){s.d(t,{autoExpandFunction:function(){return f},convertBytes:function(){return v},findAndGet:function(){return _},getByIndex:function(){return C},isStringArray:function(){return d},loadScript:function(){return M},notUndefined:function(){return S},toArray:function(){return y},toValidBoolean:function(){return p},toValidNumber:function(){return m},toValidString:function(){return h}});var i=s(605173),n=s(218679),a=s(344417),r=s(385093),l=s(217957),o=s(467851),c=s(578789),g=s.n(c),u=s(172320);let d=e=>(0,i.default)(e)&&e.every(n.default),M=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{timeout:s}=t,i=new Promise((t,s)=>{g()(e,e=>{e?s(e):t()})});(0,a.default)(s)?await Promise.race([i,(0,u.timeoutPromise)(s)]):await i},f=e=>(0,r.default)(e)?e():e,S=e=>!(0,l.default)(e),v=e=>{if(e<0)return"0B";let t=Math.floor(e);return t<1024?`${t}B`:t<1048576?`${Math.round(t/1024)}KB`:t<0x40000000?`${Math.round(t/1048576)}MB`:`${Math.round(t/0x40000000)}GB`},m=e=>{let t=Number(e);if(!isNaN(t))return t},h=e=>{if((0,n.default)(e))return e},p=e=>{if((0,o.default)(e))return e},_=(e,t)=>{for(let s of e){let e=t(s);if(!1!==e)return[s,e]}},y=e=>(0,l.default)(e)?[]:(0,i.default)(e)?e:[e],C=(e,t)=>null==e?void 0:e[t]},475261:function(e,t,s){s.d(t,{ChatEventContext:function(){return r}});var i=s(459735),n=s(4137);function a(e,t,s){var i;return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?i:i+"")in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{setCommonContextParams(e){this.params.common=e}updateCommonContextParamsIfExist(e){this.params.common&&(this.params.common={...this.params.common,...(0,i.default)(e,n.default)})}mergeMessageParamsRecord(e,t){var s,i;let n={...null!==(i=null===(s=this.params.slardar)||void 0===s?void 0:s[e])&&void 0!==i?i:{}};if(!t)return n;for(let e of Object.keys(t))void 0===n[e]?n[e]=t[e]:n[e]={...n[e],...t[e]};return n}setSlardarContextParams(e){var t,s,i,n,a;let{send_message:r,receive_message:l,is_nova:o,suggest_success:c,use_deep_think:g,suggest_length:u,suggest_error:d}=e;this.params.slardar={...this.params.slardar,send_message:this.mergeMessageParamsRecord("send_message",r),receive_message:this.mergeMessageParamsRecord("receive_message",l),is_nova:null!=o?o:null===(t=this.params.slardar)||void 0===t?void 0:t.is_nova,use_deep_think:null!=g?g:null===(s=this.params.slardar)||void 0===s?void 0:s.use_deep_think,suggest_success:null!=c?c:null===(i=this.params.slardar)||void 0===i?void 0:i.suggest_success,suggest_length:null!=u?u:null===(n=this.params.slardar)||void 0===n?void 0:n.suggest_length,suggest_error:null!=d?d:null===(a=this.params.slardar)||void 0===a?void 0:a.suggest_error}}constructor({params:e={}}={}){a(this,"params",void 0),a(this,"state",{session:"",message:""}),a(this,"records",void 0),this.params=e,this.records={beforeMessageSending:{count:0},onMessageSendingStart:{count:0},onMessageSendingEnd:{count:0},onBatchMessageReceivingStart:{count:0},onMessageReceivingStart:{count:0},onMessageReceivingUpdate:{},onMessageReceivingEnd:{count:0},onBatchMessageReceivingEnd:{count:0},onSuggestReceivingStart:{count:0},onSuggestReceivingUpdate:{count:0},onSuggestReceivingEnd:{count:0},onMessageSessionEnd:{count:0}}}}},137396:function(e,t,s){s.d(t,{ChatSceneEnum:function(){return i}});var i={GENERIC_START_PAGE_NEW_CONVERSATION:"generic_start_page_new_conversation",CLICK_GUIDANCE_NEW_CONVERSATION:"guidance_new_conversation",SKILL_START_PAGE_NEW_CONVERSATION:"skill_start_page_new_conversation",CLICK_SKILL_GUIDANCE_NEW_CONVERSATION:"click_skill_guidance_new_conversation",SUGGEST:"suggest",DOC_COPILOT:"doc_copilot",DEFAULT:"normal_conversation"}},246024:function(e,t,s){s.d(t,{getLogIdFromResponse:function(){return i}});let i=e=>{var t;return(null==e?void 0:null===(t=e._meta)||void 0===t?void 0:t.logId)||""}},457251:function(e,t,s){s.d(t,{getDocPdfKey:function(){return a}});var i=s(910214),n=s(856392);let a=async e=>{let t=(0,n.createReportEvent)({eventName:"get_doc_pdf_key"});try{var s,a,r,l;let n=await i.samanthaApiService.GetDocumentInfo({uris:[e]}),o=null===(a=n.data)||void 0===a?void 0:null===(s=a.infos)||void 0===s?void 0:s[e].redirect_pdf;if((null==o?void 0:o.can_redirect)&&(null==o?void 0:null===(r=o.pdf)||void 0===r?void 0:r.key))return t.addDurationPoint("success"),t.success(),null==o?void 0:null===(l=o.pdf)||void 0===l?void 0:l.key;t.error({reason:"get_doc_pdf_key_empty"})}catch(e){t.error({error:e instanceof Error?e:Error(String(e)),reason:"get_doc_pdf_key_failed"})}}},461141:function(e,t,s){s.d(t,{getChatConfig:function(){return l}});var i=s(436531);let n=(e,t)=>{let{configContainer:s}=(0,i.getCurrentResourceController)();!s.isBound(e)&&s.bind(e,t)},a=e=>{let{configContainer:t}=(0,i.getCurrentResourceController)();if(t.isBound(e))return t.get(e)},r=e=>{let{resourceStore:t}=(0,i.getCurrentResourceController)();return t.getState()[e]},l=e=>{let t=a(e);if(t)return t;{let t=r(e),s=null==t?void 0:t.load();if(s instanceof Promise)throw Error(`get config ${e} fail, it is async config`);return n(e,s),a(e)}}},516655:function(e,t,s){s.d(t,{getChatCanvasPluginMatcher:function(){return T},getChatMessageLifeCyclePluginMatcher:function(){return S},getChatProtocolTransformPluginMatcher:function(){return u},getChatReceiveMessageContentBlockMergePluginMatcher:function(){return A},getChatReceiveMessageContentBlockResolvePluginMatcher:function(){return P},getInputEventsPluginMatcher:function(){return p},getMessageCmdPluginMatcher:function(){return L},getMessageErrorPluginMatcher:function(){return k},useChatFooterDisclaimerPluginMatcher:function(){return m},useChatFooterPluginMatcher:function(){return v},useChatHeaderPluginMatcher:function(){return E},useChatMessageListBottomBtnPluginMatcher:function(){return f},useChatReceiveMessageActionBottomPluginMatcher:function(){return V},useChatReceiveMessageActionButtonPluginMatcher:function(){return $},useChatReceiveMessageActionRightPluginMatcher:function(){return z},useChatReceiveMessageBoxBottomPluginMatcher:function(){return D},useChatReceiveMessageBoxLeftPluginMatcher:function(){return G},useChatReceiveMessageBoxPluginMatcher:function(){return d},useChatReceiveMessageBoxRightPluginMatcher:function(){return N},useChatReceiveMessageBoxTopPluginMatcher:function(){return w},useChatReceiveMessageContentBlockPluginMatcher:function(){return b},useChatReceiveMessageGroupBottomPluginMatcher:function(){return y},useChatReceiveMessageGroupPluginMatcher:function(){return C},useChatReceiveMessageSuggestPluginMatcher:function(){return B},useChatSendMessageActionButtonPluginMatcher:function(){return K},useChatSendMessageBoxBottomPluginMatcher:function(){return F},useChatSendMessageBoxLeftPluginMatcher:function(){return j},useChatSendMessageBoxPluginMatcher:function(){return M},useChatSendMessageBoxRightPluginMatcher:function(){return U},useChatSendMessageBoxTopPluginMatcher:function(){return O},useChatShareReceiveMessageBoxPluginMatcher:function(){return W},useChatShareReceiveMessageContentBlockPluginMatcher:function(){return H},useChatShareSendMessageBoxPluginMatcher:function(){return q},useFeedListItemMenuOptionPluginMatcher:function(){return I},useFeedListItemToolButtonPluginMatcher:function(){return x},useGuidanceSuggestionsPluginMatcher:function(){return _},useLauncherDataLoaderPluginMatcher:function(){return R},useSkillBarPluginMatcher:function(){return h}});var i=s(713738),n=s(285272),a=s(436531);let r=(e,t)=>{let{pluginMatcherContainer:s}=(0,a.getCurrentResourceController)();!s.isBound(e)&&s.bind(e,t)},l=e=>{let{pluginMatcherContainer:t}=(0,a.getCurrentResourceController)();if(t.isBound(e))return t.get(e)},o=e=>{let{resourceStore:t}=(0,a.getCurrentResourceController)();return t.getState()[e]},c=e=>async()=>{let t=l(e);if(t)return t;{let t=o(e),s=await (null==t?void 0:t.load());return s?(r(e,s),l(e)):[]}},g=e=>()=>{let[t,s]=(0,i.useState)(()=>{var t;return null!==(t=l(e))&&void 0!==t?t:[]}),[a,g]=(0,i.useState)(!(null==t?void 0:t.length)),[u,d]=(0,i.useState)(void 0),M=c(e);(0,n.default)(async()=>{g(!0),d(void 0),s([]);try{let e=await M();s(e)}catch(e){d(e)}finally{g(!1)}},[e]);let f=o(e),S=null==f?void 0:f.load();return!S||S instanceof Promise?{matcher:t,loading:a,error:u}:(r(e,S),{matcher:l(e),loading:!1,error:void 0})},u=c("chatProtocolTransformPluginMatcher"),d=g("chatReceiveMessageBoxPluginMatcher");c("chatReceiveMessageBoxPluginMatcher");let M=g("chatSendMessageBoxPluginMatcher");c("chatSendMessageBoxPluginMatcher"),c("chatMessageListBottomBtnPluginMatcher");let f=g("chatMessageListBottomBtnPluginMatcher"),S=c("chatMessageLifeCyclePluginMatcher");c("chatFooterPluginMatcher");let v=g("chatFooterPluginMatcher");c("chatFooterDisclaimerPluginMatcher");let m=g("chatFooterDisclaimerPluginMatcher");c("skillBarPluginMatcher");let h=g("skillBarPluginMatcher"),p=c("inputEventsPluginMatcher");g("inputEventsPluginMatcher");let _=g("chatGuidanceSuggestionsPluginMatcher"),y=g("chatReceiveMessageGroupBottomPluginMatcher"),C=g("chatReceiveMessageGroupPluginMatcher"),k=c("chatMessageErrorPluginMatcher"),L=c("chatMessageCmdPluginMatcher"),E=g("chatHeaderPluginMatcher"),T=c("chatCanvasPluginMatcher"),R=g("launcherDataLoaderPluginMatcher");g("launcherResourceLoaderPluginMatcher");let x=g("feedListItemToolButtonPluginMatcher"),I=g("feedListItemMenuOptionPluginMatcher"),A=c("chatReceiveMessageContentBlockMergePluginMatcher"),P=c("chatReceiveMessageContentBlockResolvePluginMatcher");c("chatReceiveMessageContentBlockPluginMatcher");let b=g("chatReceiveMessageContentBlockPluginMatcher"),B=g("chatReceiveMessageSuggestPluginMatcher"),w=g("chatReceiveMessageBoxTopPluginMatcher"),N=g("chatReceiveMessageBoxRightPluginMatcher"),D=g("chatReceiveMessageBoxBottomPluginMatcher"),G=g("chatReceiveMessageBoxLeftPluginMatcher"),O=g("chatSendMessageBoxTopPluginMatcher"),U=g("chatSendMessageBoxRightPluginMatcher"),F=g("chatSendMessageBoxBottomPluginMatcher"),j=g("chatSendMessageBoxLeftPluginMatcher"),W=g("chatShareReceiveMessageBoxPluginMatcher"),q=g("chatShareSendMessageBoxPluginMatcher");c("chatShareReceiveMessageContentBlockPluginMatcher");let H=g("chatShareReceiveMessageContentBlockPluginMatcher"),$=g("chatReceiveMessageActionButtonPluginMatcher"),K=g("chatSendMessageActionButtonPluginMatcher"),V=g("chatReceiveMessageActionBottomPluginMatcher"),z=g("chatReceiveMessageActionRightPluginMatcher")},922851:function(e,t,s){s.d(t,{getChatService:function(){return o}}),s(713738);var i=s(251303),n=s(436531);let a=(e,t)=>{let{serviceContainer:s}=(0,n.getCurrentResourceController)();if(!s.isBound(e)){if(!t)throw Error("chat-ioc-manager: cannot bind empty service");(0,i.isClassContructor)(t),s.bind(e,t)}},r=e=>{let{serviceContainer:t}=(0,n.getCurrentResourceController)();if(t.isBound(e))return t.get(e)},l=e=>{let{resourceStore:t}=(0,n.getCurrentResourceController)();return t.getState()[e]},o=async e=>{let t=r(e);if(t)return(0,i.isClassContructor)(t)?new t:t;{let t=l(e),s=await (null==t?void 0:t.load());if(!s)return;a(e,s);let n=r(e);return(0,i.isClassContructor)(n)?new n:n}}},456712:function(e,t,s){s.d(t,{getDeepThinkStatusFromExt:function(){return f},getEditImageConfigFromExt:function(){return C},getErrorDetailsFromExt:function(){return c},getFinishedImageConfigFromExt:function(){return h},getHoverPositionFromExt:function(){return S},getImageInputConfigFromExt:function(){return p},getImmersiveFilesFromExt:function(){return m},getInputSkill:function(){return k},getInputSkillNoDefault:function(){return L},getIsOnlyAladdinCardFromExt:function(){return M},getMessageActionConfigFromExt:function(){return d},getMindMapFromExt:function(){return v},getNeedReferenceFromExt:function(){return u},getReadInputConfigFromExt:function(){return y},getSkillFromExt:function(){return g},getSkillParamsNoDefault:function(){return E},getTranslateInputConfigFromExt:function(){return _}});var i=s(229079),n=s(4137),a=s(762707),r=s(226982),l=s(165482),o=s(590475);let c=e=>{let t=(0,i.default)(e,["has_err"]);return t?{error_details:{has_error:!0,error_code:Number(t),error_message:"Server Error",locale:""}}:{}},g=e=>{let t=k(e);return{skill:{skill_type:t.skill_type,skill_type_no_default:t.skill_type?t.skill_type:null,skill_id:`${t.skill_type}`,skill_id_no_default:t.skill_type?`${t.skill_type}`:null}}},u=e=>(null==e?void 0:e.need_reference)==="0"?{need_reference:!1}:{},d=e=>(0,l.parseJSON)((0,i.default)(e,["search_action_bar_config"]),{}),M=e=>(0,i.default)(e,["only_alt_card"])?{only_alt_card:"1"}:{},f=e=>!!(0,i.default)(e,["think_broken"]),S=e=>(null==e?void 0:e.pdf_hover_position)?{hover_position:null==e?void 0:e.pdf_hover_position}:{},v=e=>(null==e?void 0:e.generate_mind_map)==="1"?{generate_mind_map:!0}:{},m=e=>(null==e?void 0:e.immersive_reading_files)?{immersive_files:null==e?void 0:e.immersive_reading_files}:{},h=e=>{var t;let s=null===(t=(0,l.parseJSON)((0,i.default)(e,["samantha_context"]),{}))||void 0===t?void 0:t.query_context;return(null==s?void 0:s.finished_image_token)?{finished_image:s}:{}},p=e=>{var t;let s=null===(t=(0,l.parseJSON)((0,i.default)(e,["input_skill"]),void 0))||void 0===t?void 0:t.variables;return(0,n.default)(s)?{}:s},_=e=>{var t;let s=(0,a.default)((0,l.parseJSON)((0,i.default)(e,["input_skill"]),void 0),["variables","show_variables","ext_info"]);return(0,n.default)(null==s?void 0:null===(t=s.variables)||void 0===t?void 0:t.target_lang)?{}:s},y=e=>{let{template_key:t,variables:s}=(0,a.default)((0,l.parseJSON)((0,i.default)(e,["input_skill"]),void 0),["variables","template_key","skill_type"])||{};return t||(null==s?void 0:s.reference_text)?{prompt_tpl:{...(0,n.default)(t)?{}:{tpl_key:t},...(0,n.default)(null==s?void 0:s.reference_text)?{}:{reference_text:null==s?void 0:s.reference_text}}}:{}},C=e=>{var t;let s=null===(t=(0,l.parseJSON)((0,i.default)(e,["samantha_context"]),{}))||void 0===t?void 0:t.query_context;return(null==s?void 0:s.edit_image_url)?{edit_image:s}:{}};function k(e){if(null==e?void 0:e.input_skill){let t=null==e?void 0:e.input_skill;return(0,l.parseJSON)(t,{skill_id:String(r.SkillType.SkillFreeChat),skill_type:r.SkillType.SkillFreeChat})}if(null==e?void 0:e.input_content_type){let t=o.SamanthaContentTypeToSkillTyeMap[Number(null==e?void 0:e.input_content_type)];return{skill_id:String(t),skill_type:Number(t)}}return{skill_id:String(r.SkillType.SkillFreeChat),skill_type:r.SkillType.SkillFreeChat}}function L(e){let t=null==e?void 0:e.input_skill,s=(0,l.parseJSON)(t,{});return s.skill_type?s:null}function E(e){let{skill_id_no_default:t,skill_type_no_default:s}=(null==e?void 0:e.skill)||{};return t&&s?{skill_id:t,skill_type:s}:null}},884277:function(e,t,s){s.d(t,{buildContentBlockTree:function(){return i}});function i(e){if(!e.length)return{contentBlocksTree:void 0,contentBlockNodes:void 0};let t={block_type:0,id:"0",is_finish:!0,children:[]},s={},i={};return e.forEach(e=>{var t;let i=null!==(t=e.parent_id)&&void 0!==t?t:"0";!e.is_deleted&&(s[i]||(s[i]=[]),s[i].push({...e,children:[]}))}),t.children=function e(t){var n;return(null===(n=s[t])||void 0===n?void 0:n.map(t=>{let s=t.id,n={...t,children:e(t.id)};return i[s]=n,n}))||[]}("0"),{contentBlocksTree:t,contentBlockNodes:i}}},590475:function(e,t,s){s.d(t,{SamanthaContentTypeToSkillTyeMap:function(){return a},SkillTypeToSamanthaContentTypeMap:function(){return n}});var i=s(226982);let n={[i.SkillType.SkillImageGen]:i.ContentType.SamanthaImageInput,[i.SkillType.SkillMusicGen]:i.ContentType.SamanthaMusicGenInput,[i.SkillType.SkillSearch]:i.ContentType.SamanthaSearchInput,[i.SkillType.SkillRead]:i.ContentType.SamanthaReadInput,[i.SkillType.SkillWebpage]:i.ContentType.SamanthaWebpageInput,[i.SkillType.SkillTranslate]:i.ContentType.SamanthaTranslate,[i.SkillType.SkillDeepSearch]:i.ContentType.SamanthaDeepSearchInput,[i.SkillType.SkillFreeChat]:i.ContentType.SamanthaText,[i.SkillType.SkillCodeAssistant]:i.ContentType.SamanthaCodeAssistantInput,[i.SkillType.SkillWrite]:i.ContentType.SamanthaWriteInput,[i.SkillType.SkillVideoGeneration]:i.ContentType.SamanthaVideoGenerationInput,[i.SkillType.SkillType_AiPPT]:i.ContentType.SamanthaAiPPTInput,[i.SkillType.SkillCodeInterpreter]:i.ContentType.SamanthaCodeInterpreterInput,[i.SkillType.SkillEdu]:i.ContentType.SamanthaEduInput,[i.SkillType.SkillAiPodcast]:i.ContentType.SamanthaAiPodcastInput,[i.SkillType.DesExtChatSkillPlaceholder]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillTranslate]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillSummaryHighlight]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillExplain]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillDesExtSearchCard]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillLinkPreview]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillDesExtSuggest]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillVideoSummary]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillOneLevelVideoSummary]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillRewriteWithTone]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillCustomSkill]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillSearchMindNote]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillTextToMindNote]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillBilingualSentence]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillAITitle]:i.ContentType.SamanthaText,[i.SkillType.DesExtPodcastTranscript]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillWebsiteDetail]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillSummary]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillMultiWebsites]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillAIToolSummary]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillReferenceAsk]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillMindMap]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillSimplifiedRead]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillGrammar]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillReply]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillSuperTask]:i.ContentType.SamanthaDesExtSupertask,[i.SkillType.SkillTypeMediaUnderstandingByAsr]:i.ContentType.SamanthaMediaUnderstandingByAsrInput,[i.SkillType.SkillSearchEngine]:i.ContentType.SamanthaSearchEngineInput,[i.SkillType.DesExtSkillVideoListSummary]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillCommentAnalyze]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillVideoDeepAnalyze]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillTopicTrendAnalyze]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillPageTranslate]:i.ContentType.SamanthaText,[i.SkillType.SkillDeepResearch]:i.ContentType.SamanthaDeepResearchInput,[i.SkillType.DesExtSkillSharedAppAssistant]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillGrammarCorrection]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillPodcastReading]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillMeetingSummary]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillEncyclopedia]:i.ContentType.SamanthaText,[i.SkillType.DesExtSkillMindMapGenerate]:i.ContentType.SamanthaText,[i.SkillType.SkillUserCustomSkill]:i.ContentType.SamanthaText},a={[i.ContentType.SamanthaSearchInput]:i.SkillType.SkillSearch,[i.ContentType.SamanthaDeepSearchInput]:i.SkillType.SkillDeepSearch,[i.ContentType.SamanthaImageInput]:i.SkillType.SkillImageGen,[i.ContentType.SamanthaMusicGenInput]:i.SkillType.SkillMusicGen,[i.ContentType.SamanthaReadInput]:i.SkillType.SkillRead,[i.ContentType.SamanthaWebpageInput]:i.SkillType.SkillWebpage,[i.ContentType.SamanthaTranslate]:i.SkillType.SkillTranslate,[i.ContentType.SamanthaText]:i.SkillType.SkillFreeChat,[i.ContentType.SamanthaCodeAssistantInput]:i.SkillType.SkillCodeAssistant,[i.ContentType.SamanthaVideoGenerationInput]:i.SkillType.SkillVideoGeneration,[i.ContentType.SamanthaWriteInput]:i.SkillType.SkillWrite,[i.ContentType.SamanthaAiPPTInput]:i.SkillType.SkillType_AiPPT,[i.ContentType.SamanthaEduInput]:i.SkillType.SkillEdu,[i.ContentType.SamanthaCodeInterpreterInput]:i.SkillType.SkillCodeInterpreter,[i.ContentType.SamanthaDesExtSupertask]:i.SkillType.DesExtSkillSuperTask,[i.ContentType.SamanthaMediaUnderstandingByAsrInput]:i.SkillType.SkillTypeMediaUnderstandingByAsr,[i.ContentType.SamanthaDeepResearchInput]:i.SkillType.SkillDeepResearch,[i.ContentType.SamanthaSearchEngineInput]:i.SkillType.SkillSearchEngine}},695422:function(e,t,s){s.d(t,{ChatInputSendMessageStatus:function(){return i},SkillFrom:function(){return n}});var i={Default:"Default",Sending:"Sending",Receiving:"Receiving"},n={ClickSkill:"click_skill",AfterSkill:"after_skill",AfterIntention:"after_intention",KeyboardAt:"keyboard_at",KeyboardSlash:"keyboard_slash",FileUpload:"file_upload",Quote:"quote",Unknown:"unknown",UseURL:"use_url"}},430780:function(e,t,s){var i,n,a,r;s.d(t,{SessionLifeCycleMachineAction:function(){return c},SessionLifeCycleMachineState:function(){return l},SingleReceivingMessageLifeCycleMachineAction:function(){return g},SingleReceivingMessageLifeCycleMachineState:function(){return o}});let l=((i={})[i.Init=0]="Init",i[i.MessageSessionStart=1]="MessageSessionStart",i[i.MessageSendingStart=2]="MessageSendingStart",i[i.BatchMessageReceivingStart=3]="BatchMessageReceivingStart",i[i.SuggestionReceivingStart=4]="SuggestionReceivingStart",i[i.MessageSessionEnd=5]="MessageSessionEnd",i),o=((n={})[n.Init=0]="Init",n[n.MessageReceivingStart=1]="MessageReceivingStart",n[n.MessageReceivingEnd=2]="MessageReceivingEnd",n),c=((a={})[a.StartMessageSession=0]="StartMessageSession",a[a.StartMessageSending=1]="StartMessageSending",a[a.SuccessMessageSending=2]="SuccessMessageSending",a[a.BreakMessageSending=3]="BreakMessageSending",a[a.ErrorMessageSending=4]="ErrorMessageSending",a[a.TimeoutMessageSending=5]="TimeoutMessageSending",a[a.BreakMessageReceiving=6]="BreakMessageReceiving",a[a.ErrorMessageReceiving=7]="ErrorMessageReceiving",a[a.TimeoutMessageReceiving=8]="TimeoutMessageReceiving",a[a.StartSuggestionReceiving=9]="StartSuggestionReceiving",a[a.EndMessageSession=10]="EndMessageSession",a),g=((r={})[r.StartMessageReceiving=0]="StartMessageReceiving",r[r.EndMessageReceiving=1]="EndMessageReceiving",r)},108021:function(e,t,s){s.d(t,{onMessageSessionEnd:function(){return l},onMessageSessionEndInner:function(){return o}});var i=s(178230),n=s(308844),a=s(550520),r=s(913885);let l=(e,t,s,i)=>{o(e.getSessionLifeCycleContext(t,s),i)},o=(e,t)=>{let s=(0,r.getChatEventContext)(e);!(0,n.checkSkipReportLog)(s)&&((0,n.setChatEventRecordInChatContext)(s,"onMessageSessionEnd"),i.logger.persist.success({eventName:"on_message_session_end",meta:a.transformContextParamsToSlardarEventParams.onMessageSessionEnd(s,t)}))}},670899:function(e,t,s){s.d(t,{onMessageSessionStart:function(){return n}});var i=s(178230);let n=e=>{var t,s;i.logger.persist.success({eventName:"on_message_session_start",meta:{chat_session_scene:null===(t=e.slardar)||void 0===t?void 0:t.chat_session_scene,chat_session_id:null===(s=e.slardar)||void 0===s?void 0:s.chat_session_id}})}},308844:function(e,t,s){s.d(t,{checkSkipReportLog:function(){return n},setChatEventRecordInChatContext:function(){return a}});var i=s(178230);let n=e=>{var t,s;return(null==e?void 0:null===(s=e.records)||void 0===s?void 0:null===(t=s.onMessageSessionEnd)||void 0===t?void 0:t.count)===1&&(i.logger.persist.info("message session end, skip report log"),!0)},a=(e,t)=>{if(!e||!t)return;let s=e.records[t];(null==s?void 0:s.count)!==void 0&&(s.count+=1),(null==s?void 0:s.timestamp)===void 0&&(s.timestamp=performance.now())}},913885:function(e,t,s){s.d(t,{getChatEventContext:function(){return a},getTeaTraceEventContext:function(){return n}});var i=s(430780);let n=e=>e.get("chatTeaTraceEvent"),a=e=>{let t=e.get("chatEventContext");return t&&(t.state={session:i.SessionLifeCycleMachineState[e.current_session_state],message:i.SingleReceivingMessageLifeCycleMachineState[e.current_single_receiving_message_state]}),t}},550520:function(e,t,s){s.d(t,{transformContextParamsToSlardarEventParams:function(){return d},transformMessageToContextParams:function(){return l}});var i=s(178230);let n=e=>{var t,s,i,n;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)!==void 0?String(e.error_details.error_code):(null===(s=e.final_status)||void 0===s?void 0:s.message)==="Broken"?"broken":(null===(i=e.final_status)||void 0===i?void 0:i.message)==="Timeout"?"timeout":(null===(n=e.final_status)||void 0===n?void 0:n.message)==="Error"?"unexpected_error":""},a=e=>{var t,s,i;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)!==void 0?String(e.error_details.error_code):(null===(s=e.final_status)||void 0===s?void 0:s.message)==="Broken"?"broken":(null===(i=e.final_status)||void 0===i?void 0:i.message)==="Error"?"unexpected_error":""},r=e=>{var t,s,i,n,a,r;return(null==e?void 0:null===(t=e.error_details)||void 0===t?void 0:t.error_code)!==void 0?String(e.error_details.error_code):(null==e?void 0:null===(s=e.final_status)||void 0===s?void 0:s.session)==="Broken"?"broken":(null==e?void 0:null===(i=e.final_status)||void 0===i?void 0:i.session)==="Timeout"?"timeout":(null==e?void 0:null===(n=e.final_status)||void 0===n?void 0:n.session)==="Error"?"unexpected_error":(null==e?void 0:null===(a=e.final_status)||void 0===a?void 0:a.session)==="ExpectError"?"expect_error":(null==e?void 0:null===(r=e.final_status)||void 0===r?void 0:r.session)==="PanicError"?"panic_error":""},l={beforeMessageSending(e){var t,s;let i={is_nova:(null===(t=e.local)||void 0===t?void 0:t.isNova)?"1":"0",use_deep_think:null===(s=e.ext)||void 0===s?void 0:s.use_deep_think,send_message:{}};return e.local_message_id&&i.send_message&&(i.send_message[e.local_message_id]={local_message_id:e.local_message_id}),i},onMessageSendingStart(e){let t={send_message:{}};if(e.local_message_id&&t.send_message){var s,i;t.send_message[e.local_message_id]={local_message_id:e.local_message_id,content_type:null!==(i=null==e?void 0:null===(s=e.ext)||void 0===s?void 0:s.input_content_type)&&void 0!==i?i:void 0}}return t},onMessageSendingEnd(e){let t={send_message:{}};if(e.local_message_id&&t.send_message){var s,i,a,r,l;t.send_message[e.local_message_id]={local_message_id:e.local_message_id,message_id:e.message_id,inner_log_id:null!==(l=null===(s=e.ext)||void 0===s?void 0:s.inner_log_id)&&void 0!==l?l:null===(i=e.ext)||void 0===i?void 0:i.log_id,log_id:null===(a=e.local_info)||void 0===a?void 0:a.log_id,success:(null===(r=e.final_status)||void 0===r?void 0:r.message)==="Success"?"1":"0",err:n(e),content_type:String(e.content_type)}}return t},onMessageReceivingUpdate(e){let t={receive_message:{}};if(e.message_id&&t.receive_message){var s,i,n,a,r;t.receive_message[e.message_id]={local_message_id:null!==(a=e.local_message_id)&&void 0!==a?a:"",message_id:e.message_id,inner_log_id:null!==(r=null===(s=e.ext)||void 0===s?void 0:s.inner_log_id)&&void 0!==r?r:null===(i=e.ext)||void 0===i?void 0:i.log_id,log_id:null===(n=e.local_info)||void 0===n?void 0:n.log_id,content_type:String(e.content_type)}}return t},onMessageReceivingEnd(e){let t={receive_message:{}};if(e.message_id&&t.receive_message){var s,i,a,r,l,o;t.receive_message[e.message_id]={local_message_id:null!==(l=e.local_message_id)&&void 0!==l?l:"",message_id:e.message_id,inner_log_id:null!==(o=null===(s=e.ext)||void 0===s?void 0:s.inner_log_id)&&void 0!==o?o:null===(i=e.ext)||void 0===i?void 0:i.log_id,log_id:null===(a=e.local_info)||void 0===a?void 0:a.log_id,success:(null===(r=e.final_status)||void 0===r?void 0:r.message)==="Success"?"1":"0",content_type:String(e.content_type),err:n(e)}}return t},onSuggestReceivingStart:()=>({suggest_success:"0"}),onSuggestReceivingEnd(e){var t,s;let i=(null===(t=e.content_obj)||void 0===t?void 0:t.suggest)||(null===(s=e.content_obj)||void 0===s?void 0:s.suggestions),n=Array.isArray(i)?null==i?void 0:i.length:0;return{suggest_success:n>0?"1":"0",suggest_length:n,suggest_error:a(e)}}},o=(e,t)=>{var s,n,a,r;if(!(null==e?void 0:null===(s=e.params)||void 0===s?void 0:s.common))return i.logger.persist.error({error:Error("chat-trace: common parmams is not set")}),{conversation_id:"",local_conversation_id:"",skill_id:"",conversation_type:""};let{params:l}=e,{slardar:o}=l,c={...e.params.common,use_deep_think:null==o?void 0:o.use_deep_think,is_nova:null==o?void 0:o.is_nova,chat_session_scene:null==o?void 0:o.chat_session_scene,chat_session_id:null==o?void 0:o.chat_session_id,chat_scene:null==o?void 0:o.chat_scene},g=Object.keys(null!==(a=null==o?void 0:o.send_message)&&void 0!==a?a:{})[0];if(!g)return c;let{message_id:u,success:d,err:M,local_message_id:f,log_id:S,inner_log_id:v,content_type:m}=null!==(r=null==o?void 0:null===(n=o.send_message)||void 0===n?void 0:n[g])&&void 0!==r?r:{};return c.send_message_id=null!=u?u:"",c.send_local_message_id=null!=f?f:"",c.send_success=null!=d?d:void 0,c.send_err=null!=M?M:void 0,c.send_log_id=S,c.send_inner_log_id=v,c.send_content_type=m,c.lifecycle_state=`session: ${e.state.session}, message:${e.state.message}`,c},c=(e,t)=>{var s,a,r,l,c,g,u,d,M,f;let S={...o(e)};if(!e)return i.logger.persist.error({error:Error("chat-trace: chatEventContext is undefined")}),S;let{params:v,records:m}=e,h=m.onMessageReceivingUpdate[(null==t?void 0:t.message_id)||""],p=(null!==(l=null==h?void 0:h.timestamp_list)&&void 0!==l?l:[]).map((e,t)=>0===t?0:e-h.timestamp_list[t-1]).slice(1),_=null===(a=v.slardar)||void 0===a?void 0:null===(s=a.receive_message)||void 0===s?void 0:s[(null==t?void 0:t.message_id)||""];if(S.receive_message_id=null!==(c=null==_?void 0:_.message_id)&&void 0!==c?c:"",S.receive_local_message_id=null!==(g=null==_?void 0:_.local_message_id)&&void 0!==g?g:"",S.receive_success=null!==(u=null==_?void 0:_.success)&&void 0!==u?u:"0",S.receive_err=null!==(d=null==_?void 0:_.err)&&void 0!==d?d:t?n(t):"unknown",S.receive_log_id=null==_?void 0:_.log_id,S.receive_inner_log_id=null==_?void 0:_.inner_log_id,S.receive_content_type=null!==(M=null==_?void 0:_.content_type)&&void 0!==M?M:void 0,S.lifecycle_state=`session: ${e.state.session}, message:${e.state.message}`,S.receive_stuck_1000_duration=p.filter(e=>e>1e3&&e<=3e3).reduce((e,t)=>e+t,0),S.receive_stuck_3000_duration=p.filter(e=>e>3e3).reduce((e,t)=>e+t,0),S.receive_full_duration=p.reduce((e,t)=>e+t,0),S.receive_full_duration&&(S.receive_stuck_3000_percentage=S.receive_stuck_3000_duration/S.receive_full_duration,S.receive_stuck_1000_percentage=S.receive_stuck_1000_duration/S.receive_full_duration),null==h?void 0:null===(r=h.think_reason_timestamp_list)||void 0===r?void 0:r.length){let e=(null!==(f=null==h?void 0:h.think_reason_timestamp_list)&&void 0!==f?f:[]).map((e,t)=>0===t?0:e-h.think_reason_timestamp_list[t-1]).slice(1);S.receive_think_reason_full_duration=e.reduce((e,t)=>e+t,0)}return S},g=(e,t)=>{var s,n;let a={...o(e,t),...c(e,t)};if(!e)return i.logger.persist.error({error:Error("chat-trace: chatEventContext is undefined")}),a;let{params:r}=e,l=Object.values(null!==(n=null===(s=r.slardar)||void 0===s?void 0:s.receive_message)&&void 0!==n?n:{});return a.session_success=l.length>0&&l.every(e=>"1"===e.success)?"1":"0",a.lifecycle_state=`session: ${e.state.session}, message:${e.state.message}`,a},u=(e,t)=>{var s,n,a;let r={...g(e,t)};if(!e)return i.logger.persist.error({error:Error("chat-trace: chatEventContext is undefined")}),r;let{params:l}=e;return r.suggest_success=null===(s=l.slardar)||void 0===s?void 0:s.suggest_success,r.suggest_length=null===(n=l.slardar)||void 0===n?void 0:n.suggest_length,r.suggest_error=null===(a=l.slardar)||void 0===a?void 0:a.suggest_error,r.lifecycle_state=`session: ${e.state.session}, message:${e.state.message}`,r},d={beforeMessageSending:o,onMessageSendingStart:o,onMessageSendingEnd:o,onThinkingMessageUpdate:o,onBatchMessageReceivingStart:o,onMessageReceivingStart:o,onMessageReceivingUpdate:(e,t)=>{var s,n,a;let r={...o(e)};if(!e)return i.logger.persist.error({error:Error("chat-trace: chatEventContext is undefined")}),r;let{params:l}=e,c=null===(n=l.slardar)||void 0===n?void 0:null===(s=n.receive_message)||void 0===s?void 0:s[(null==t?void 0:t.message_id)||""];c&&(r.receive_message_id=c.message_id,r.receive_local_message_id=c.local_message_id,r.receive_log_id=c.log_id,r.receive_inner_log_id=c.inner_log_id,r.receive_content_type=null!==(a=c.content_type)&&void 0!==a?a:void 0);let{records:g}=e;return r.event_count_err=["beforeMessageSending","onMessageSendingStart","onMessageSendingEnd","onBatchMessageReceivingStart","onMessageReceivingStart"].map(e=>{let t=g[e];return"onMessageReceivingStart"===e?t.count>0?"":e:1===t.count?"":e}).filter(e=>""!==e).join(","),r.lifecycle_state=`session: ${e.state.session}, message:${e.state.message}`,r},onMessageReceivingEnd:c,onBatchMessageReceivingEnd:g,onSuggestReceivingStart:o,onSuggestReceivingEnd:u,onMessageSessionEnd:(e,t)=>{let s={...u(e,t)};if(!e)return i.logger.persist.error({error:Error("chat-trace: chatEventContext is undefined")}),s;let{records:n}=e;s.session_err=r(t);let a="expect_error"===s.session_err||"broken"===s.session_err?[]:"1"!==s.send_success?["beforeMessageSending","onMessageSendingStart","onMessageSendingEnd","onMessageSessionEnd"]:["beforeMessageSending","onMessageSendingStart","onMessageSendingEnd","onBatchMessageReceivingStart","onMessageReceivingStart","onMessageReceivingEnd","onBatchMessageReceivingEnd","onMessageSessionEnd"];return s.event_count_err=a.map(e=>{let t=n[e];return"onMessageReceivingStart"===e||"onMessageReceivingEnd"===e?t.count>0?"":e:1===t.count?"":e}).filter(e=>""!==e).join(","),s.lifecycle_state=`session: ${e.state.session}, message:${e.state.message}`,s}}},475445:function(e,t,s){s.d(t,{getLatestMessageList:function(){return a}});var i=s(83990),n=s(752544);function a(e,t){let s=i.useMessageStore.getState(),a=s.messageLinkMap[e];if(!a)return[];let r=a.slice(Math.max(0,a.length-t)),l=(0,n.createGetMessage)((0,n.getMessageState)(s,e));return r.map(l).filter(Boolean)}},472667:function(e,t,s){s.d(t,{getMessageApiClient:function(){return L}});var i=s(815105),n=s(178230),a=s(307481),r=s(82760),l=s(849049),o=s(39931);let c=async e=>{let{display_content:t="",msg_id:s="",conversation_id:i=""}=e,n=(0,l.getUnlinkMessage)({cmd:a.IMCMD.UPDATE_MSG_CONTENT,uplink_body:{update_msg_content_uplink_body:{message_id:s,display_content:t,conversation_id:i,conversation_type:r.ConversationType.ONE_TO_BOT_CHAT}}}),{status_code:c,status_desc:g}=await (0,o.imGatewayClient)({url:"/im/message/update_content",method:"POST",data:n});return{code:c,msg:g}},g=async e=>{let{message_id:t="",reply_id:s=""}=e,i=(0,l.getUnlinkMessage)({cmd:a.IMCMD.SWITCH_REGENERATE_MSG,uplink_body:{switch_regenerate_msg_uplink_body:{message_id:t,reply_id:s}}}),{status_code:n,status_desc:r}=await (0,o.imGatewayClient)({url:"/im/message/switch_regenerate",method:"POST",data:i});return{code:n,msg:r}};var u=s(58096);let d=(e,t)=>{if(null==e?void 0:e.length){let s=e.filter(e=>e.status===r.MessageStatus.MessageStatus_REGEN_ROOT)[0];if(s)return Object.values(null!=t?t:{}).filter(e=>e.regen_root_id===s.message_id).map(e=>{let t=s.regen_msg_list.some(t=>t.is_visible&&t.msg_id_list.includes(e.message_id));return{...e,status:t?r.MessageStatus.MessageStatus_AVAILABLE:r.MessageStatus.MessageStatus_INVISIBLE,ext:e.ext?{...e.ext,regen_active:t?"1":"0"}:{}}})}return[]},M=async e=>{let{conversation_id:t="",cursor:s,batch_size:i,bot_id:n,message_index_list:c,is_reverse:g,v2_api_ext:M={}}=e,f=(0,l.getUnlinkMessage)({cmd:a.IMCMD.PULL_SINGLE_CHAIN,uplink_body:{pull_singe_chain_uplink_body:{conversation_id:t,anchor_index:Number(null!=s?s:0),conversation_type:r.ConversationType.ONE_TO_BOT_CHAT,direction:!1!==g?r.MessageDirection.OLDER:r.MessageDirection.NEWER,limit:Number(null!=i?i:50),ext:M,filter:{index_list:(null!=c?c:[]).map(e=>Number(e)),bot_id:n}}}}),{status_code:S,status_desc:v,downlink_body:m}=await (0,o.imGatewayClient)({url:"/im/chain/single",method:"POST",data:f}),{pull_singe_chain_downlink_body:h}=null!=m?m:{},{messages:p=[],has_more:_,regen_messages:y={}}=null!=h?h:{},C=d(p,y);for(let e=0;e<p.length;e++){let t=p[e];if(t.status===r.MessageStatus.MessageStatus_REGEN_ROOT){var k;p[e]=null!==(k=Object.values(null!=y?y:{}).find(e=>e.regen_root_id===t.message_id&&t.regen_msg_list.some(t=>t.is_visible&&t.msg_id_list.includes(e.message_id))))&&void 0!==k?k:t,p[e].status=r.MessageStatus.MessageStatus_AVAILABLE}}let L=p.concat(C.filter(e=>e.status===r.MessageStatus.MessageStatus_INVISIBLE)),E=C.map(e=>({...e,status:r.MessageStatus.MessageStatus_AVAILABLE}));return{code:S,msg:v,data:{has_more:_,message_list:L.map(u.mapImMessageBodyToAlicePushMessage),regen_list:E.map(u.mapImMessageBodyToAlicePushMessage)}}},f=async()=>{let e=(0,l.getUnlinkMessage)({cmd:a.IMCMD.CHECK_MESSAGE_SEND_RATE_LIMIT,uplink_body:{check_message_send_rate_limit_uplink_body:{}}}),{status_code:t,status_desc:s,downlink_body:i}=await (0,o.imGatewayClient)({url:"/im/message/send_rate_limit",method:"POST",data:e});return{code:t,msg:s,data:null==i?void 0:i.check_message_send_rate_limit_downlink_body}},S=async e=>{var t;let{conversation_id:s="",message_id:i="",feedbackDetail:n,feedbackSource:c}=e,g=(0,l.getUnlinkMessage)({cmd:a.IMCMD.FEEDBACK_MSG,uplink_body:{feedback_msg_uplink_body:{conversation_id:s,message_id:i,conversation_type:r.ConversationType.ONE_TO_BOT_CHAT,feedback_source:void 0===c?r.MsgFeedbackSource.User:c,feedback_type:null==n?void 0:n.feedback_type,feedback_detail_types:null!==(t=null==n?void 0:n.feedback_detail_types)&&void 0!==t?t:[]}}}),{status_code:u,status_desc:d}=await (0,o.imGatewayClient)({url:"/im/message/feedback_msg",method:"POST",data:g});return{code:u,msg:d}},v=async e=>{let{conversation_id:t="",message_id:s="",regen_message_ids:i=[]}=e,n=i.length>0?i:[s],c=(0,l.getUnlinkMessage)({cmd:a.IMCMD.BATCH_UPDATE_MSG_STATUS,uplink_body:{batch_update_msg_status_uplink_body:{conversation_id:t,conversation_type:r.ConversationType.ONE_TO_BOT_CHAT,message_body_list:n.map(e=>({message_id:e,status:r.MessageStatus.MessageStatus_DELETED,local_message_id:""}))}}}),{status_code:g,status_desc:u}=await (0,o.imGatewayClient)({url:"/im/message/batch_update_status",method:"POST",data:c});return{code:g,msg:u}},m=async e=>{var t,s,i,n,c,g,d;let{request_list:M}=e,f=(0,l.getUnlinkMessage)({cmd:a.IMCMD.BATCH_PULL_SINGLE_CHAIN,uplink_body:{batch_pull_singe_chain_uplink_body:{conversation_type:r.ConversationType.ONE_TO_BOT_CHAT,direction:r.MessageDirection.FROM_LATEST,limit:1,params:null!==(s=null==M?void 0:null===(t=M.map(e=>{var t;return{conversation_id:null!==(t=e.conversation_id)&&void 0!==t?t:""}}))||void 0===t?void 0:t.filter(e=>!!e.conversation_id))&&void 0!==s?s:[],evaluate_ab_params:"",evaluate_common_params:"",ext:{}}}}),{status_code:S,status_desc:v,downlink_body:m}=await (0,o.imGatewayClient)({url:"/im/chain/batch_single",method:"POST",data:f}),{batch_pull_singe_chain_downlink_body:h}=null!=m?m:{},{message_map:p,retry_list:_}=null!=h?h:{},y=Object.keys(null!=p?p:{}),C={},k={};for(let e of y)C[e]=null!==(g=null==p?void 0:null===(n=p[e])||void 0===n?void 0:null===(i=n.messages)||void 0===i?void 0:i.map(u.mapImMessageBodyToAlicePushMessage))&&void 0!==g?g:[],k[e]=Object.values(null!==(d=null==p?void 0:null===(c=p[e])||void 0===c?void 0:c.regen_messages)&&void 0!==d?d:{}).map(u.mapImMessageBodyToAlicePushMessage);return{code:S,msg:v,data:{retry_list:_,message_map:C,regen_map:k}}};function h(e,t,s){var i;return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?i:i+"")in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class p{constructor(){h(this,"rateLimit",()=>f()),h(this,"getMessageList",async e=>{var t,s;let i=await M(e);return(null===(s=i.data)||void 0===s?void 0:null===(t=s.message_list)||void 0===t?void 0:t.length)||n.logger.persist.info({eventName:"IM_chain_single_empty",meta:{conversation_id:e.conversation_id,cursor:e.cursor,batch_size:e.batch_size}}),i}),h(this,"getMessageListByIndexList",e=>M(e)),h(this,"getLatestMessageList",e=>m(e)),h(this,"deleteMessage",e=>v(e)),h(this,"regenSwitch",e=>g(e)),h(this,"feedback",e=>S(e)),h(this,"updateContent",e=>c(e))}}var _=s(910214);function y(e,t,s){var i;return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?i:i+"")in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class C{constructor(){y(this,"rateLimit",async()=>await _.messageApiService.CheckMessageSendRateLimit()),y(this,"getMessageList",async e=>await _.messageApiService.MessageList(e)),y(this,"getMessageListByIndexList",async e=>await _.messageApiService.GetMessageListByIndexList(e)),y(this,"getLatestMessageList",async e=>await _.messageApiService.LatestMessageList(e)),y(this,"deleteMessage",async e=>await _.messageApiService.MessageReport({...e,action:"delete"})),y(this,"regenSwitch",async e=>await _.messageApiService.MessageReport({...e,action:"regen_switch"})),y(this,"feedback",async e=>await _.messageApiService.MessageReport({...e,action:"feedback"})),y(this,"updateContent",async e=>await _.messageApiService.UpdateMsgContent(e))}}let k=async()=>await (0,i.isEnableIMPlatform)()?new p:new C,L=async()=>k()},555897:function(e,t,s){s.d(t,{emitSuggestReceivingEnd:function(){return J},emitMessageProcessBefore:function(){return E},emitMessageProcessEnd:function(){return T},emitMessageSendingBefore:function(){return I},emitBatchMessageReceivingEndBySuccessAndEndMessageSession:function(){return H},emitMessageSendingEndBySuccessAndBatchMessageReceivingStart:function(){return w},emitMessageSendingStart:function(){return P},emitSuggestReceivingUpdate:function(){return V},toggleMessageSessionStartWithResumeTask:function(){return Z},emitMessageSendingEndByBreak:function(){return N},emitBatchMessageReceivingEndBySuccessAndStartSuggestionReceiving:function(){return Q},emitMessageSessionStartWithResumeTask:function(){return x},emitMessageSessionStart:function(){return R},emitBatchMessageReceivingEndByError:function(){return $},emitMessageSessionEndBySendBeforeError:function(){return X},emitThinkingMessageUpdate:function(){return G},toggleMessageReceivingEmitter:function(){return Y},emitBatchMessageReceivingEndByBreak:function(){return K},emitMessageReceivingEndByError:function(){return q},emitMessageSendingEndByError:function(){return D}});var i=s(519428),n=s(430780),a=s(670899),r=s(108021),l=s(475261),o=s(137396),c=s(674157),g=s(629006),u=s(461141),d=s(645298),M=s(178230),f=s(702427),S=s(605173),v=s(467851),m=s(220051),h=s(385093),p=s(516655),_=s(689368),y=s(687780);let C=e=>{let{sessionLifeCycleMachineAction:t,singleRecevingMessageMachineAction:s,lifeCycleEventNames:i,lifeCycleGuard:n=e=>!0,idleExecuteSessionLifeCycleNextAction:a,idleExecuteSessionLifeCycleNextActionIntervalGetter:r}=e;return async(e,l,o)=>new Promise((c,u)=>{f.messageLifeCycleManager.pushQueue(e,l,async()=>{let d=f.messageLifeCycleManager.getSessionLifeCycleMachineState(e,l),C=(0,S.default)(o)?"":(0,g.isSendMessage)(o)?"":o.message_id||"",k=C?f.messageLifeCycleManager.getSingleRecevingMessageLifeCycleMachineState(e,l,C):void 0,L=f.messageLifeCycleManager.getSessionLifeCycleContext(e,l,C),E=n(e,l,o,d,k);if(!E)return c(o);(0,v.default)(E)||(o=E),f.messageLifeCycleManager.clearSessionLifeCycleIdleNextAction(e,l,d);let T=(await (0,p.getChatMessageLifeCyclePluginMatcher)()).map(e=>{var t,s;if((0,S.default)(o)){if(null===(t=e.matchPluginWithPayload)||void 0===t?void 0:t.call(e,o))return e.pluginIdentifier}else if(null===(s=e.matchPlugin)||void 0===s?void 0:s.call(e,o))return e.pluginIdentifier}).filter(m.default),R=(await Promise.all(T.map(e=>(0,_.getChatMessageLifeCyclePlugin)(e)))).filter(e=>!!e),x=o;for(let e of i)for(let t of R){let s=t[e],i=(e,t)=>t,n=(0,h.default)(s)?s:i;try{x=await n(L,x)}catch(t){if(M.logger.persist.error({error:t,message:`message lifecycle [${e}] execute failed, reason:${t.message}`}),(0,y.isLifeCyclePanicError)(t)||(0,y.isLifeCycleExpectError)(t))return u(t)}}f.messageLifeCycleManager.nextSessionLifeCycleMachineState(e,l,t),C&&f.messageLifeCycleManager.nextSingleReceivingMessageLifeCycleMachineState(e,l,C,s),a&&r&&f.messageLifeCycleManager.idleExecuteSessionLifeCycleNextAction(e,l,()=>a(e,l,o),r()),c(x)})})},k=(e,t)=>(s,i,a,l)=>l===t||(M.logger.persist.info({message:`execute ${e} action failed,session_machine_state invalid, current state: ${n.SessionLifeCycleMachineState[l]}, report message session end`}),(0,r.onMessageSessionEnd)(f.messageLifeCycleManager,s,i,a),!1),L=(e,t)=>(s,i)=>s===e&&i===t,E=C({lifeCycleEventNames:["processMessageBefore"]}),T=C({lifeCycleEventNames:["onProcessMessageEnd"]}),R=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.StartMessageSession,lifeCycleEventNames:["onMessageSessionStart"],lifeCycleGuard:(e,t,s,i)=>(f.messageLifeCycleManager.createLifeCycleSessionStore(e,t),!0)}),x=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.StartMessageSession,lifeCycleEventNames:["onMessageSessionStart"],lifeCycleGuard:(e,t,s,i)=>(f.messageLifeCycleManager.createLifeCycleSessionStore(e,t),f.messageLifeCycleManager.forceUpdateSessionLifeCycleMachine(e,t,n.SessionLifeCycleMachineState.BatchMessageReceivingStart),!0)}),I=C({lifeCycleEventNames:["beforeMessageSending"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.MessageSessionStart}),A=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.TimeoutMessageSending,lifeCycleEventNames:["onMessageSendingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,a)=>{if(!k("timeout_message_sending",n.SessionLifeCycleMachineState.MessageSendingStart)(e,t,s,a))return!1;{let e=(0,i.default)(s);return e.final_status={message:"Timeout",session:"Timeout"},e}}}),P=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.StartMessageSending,lifeCycleEventNames:["onMessageSendingStart"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.MessageSessionStart,idleExecuteSessionLifeCycleNextAction:A,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{sendMessageStartTimeout:e=d.defaultSendMessageStartTimeout}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),b=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.TimeoutMessageReceiving,lifeCycleEventNames:["onBatchMessageReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,a)=>{if(!k("timeout_batch_message_receiving",n.SessionLifeCycleMachineState.BatchMessageReceivingStart)(e,t,s,a))return!1;{let e=(0,i.default)(s);return e.final_status={message:"Timeout",session:"Timeout"},e}}}),B=C({singleRecevingMessageMachineAction:n.SingleReceivingMessageLifeCycleMachineAction.EndMessageReceiving,sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.TimeoutMessageReceiving,lifeCycleEventNames:["onMessageReceivingEnd","onBatchMessageReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,a)=>{if(!k("timeout_batch_message_receiving",n.SessionLifeCycleMachineState.BatchMessageReceivingStart)(e,t,s,a))return!1;{let e=(0,i.default)(s);return e.final_status={message:"Timeout",session:"Timeout"},e}}}),w=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.SuccessMessageSending,lifeCycleEventNames:["onMessageSendingEnd","onBatchMessageReceivingStart"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.MessageSendingStart,idleExecuteSessionLifeCycleNextAction:b,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{receiveMessageStartTimeout:e=d.defaultReceiveMessageStartTimeout}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),N=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.BreakMessageSending,lifeCycleEventNames:["onMessageSendingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>k("break_message_sending",n.SessionLifeCycleMachineState.MessageSendingStart)(e,t,s,i)}),D=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.ErrorMessageSending,lifeCycleEventNames:["onMessageSendingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>k("error_message_sending",n.SessionLifeCycleMachineState.MessageSendingStart)(e,t,s,i)}),G=C({lifeCycleEventNames:["onThinkingMessageUpdate"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.BatchMessageReceivingStart,idleExecuteSessionLifeCycleNextAction:B,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{receiveStreamPackageUpdateTimeout:e=d.defaultReceiveStreamPackageUpdateTimeout}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),O=C({singleRecevingMessageMachineAction:n.SingleReceivingMessageLifeCycleMachineAction.StartMessageReceiving,lifeCycleEventNames:["onMessageReceivingStart"],lifeCycleGuard:(e,t,s,i,a)=>L(n.SessionLifeCycleMachineState.BatchMessageReceivingStart,n.SingleReceivingMessageLifeCycleMachineState.Init)(i,a),idleExecuteSessionLifeCycleNextAction:B,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{receiveMessageStartTimeout:e=d.defaultReceiveMessageStartTimeout}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),U=C({lifeCycleEventNames:["onMessageReceivingUpdate"],lifeCycleGuard:(e,t,s,i,a)=>L(n.SessionLifeCycleMachineState.BatchMessageReceivingStart,n.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart)(i,a),idleExecuteSessionLifeCycleNextAction:B,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{receiveStreamPackageUpdateTimeout:e=d.defaultReceiveStreamPackageUpdateTimeout}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),F=C({lifeCycleEventNames:["onMessageReceivingUpdate"],lifeCycleGuard:(e,t,s,i,a)=>L(n.SessionLifeCycleMachineState.BatchMessageReceivingStart,n.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart)(i,a),idleExecuteSessionLifeCycleNextAction:B,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{receiveStreamPackageUpdateTimeoutForAsyncTask:e=d.defaultReceiveStreamPackageUpdateTimeoutForAsyncTask}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),j=C({singleRecevingMessageMachineAction:n.SingleReceivingMessageLifeCycleMachineAction.EndMessageReceiving,lifeCycleEventNames:["onMessageReceivingEnd"],lifeCycleGuard:(e,t,s,i,a)=>L(n.SessionLifeCycleMachineState.BatchMessageReceivingStart,n.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart)(i,a)}),W=C({singleRecevingMessageMachineAction:n.SingleReceivingMessageLifeCycleMachineAction.EndMessageReceiving,lifeCycleEventNames:["onMessageReceivingEnd"],lifeCycleGuard:(e,t,s,i,a)=>L(n.SessionLifeCycleMachineState.BatchMessageReceivingStart,n.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart)(i,a)}),q=C({singleRecevingMessageMachineAction:n.SingleReceivingMessageLifeCycleMachineAction.EndMessageReceiving,lifeCycleEventNames:["onMessageReceivingEnd"],lifeCycleGuard:(e,t,s,i,a)=>L(n.SessionLifeCycleMachineState.BatchMessageReceivingStart,n.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart)(i,a)}),H=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.EndMessageSession,lifeCycleEventNames:["onBatchMessageReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>k("end_message_receiving",n.SessionLifeCycleMachineState.BatchMessageReceivingStart)(e,t,s,i)}),$=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.ErrorMessageReceiving,lifeCycleEventNames:["onBatchMessageReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>k("error_message_receiving",n.SessionLifeCycleMachineState.BatchMessageReceivingStart)(e,t,s,i)}),K=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.BreakMessageReceiving,lifeCycleEventNames:["onBatchMessageReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>k("break_message_receiving",n.SessionLifeCycleMachineState.BatchMessageReceivingStart)(e,t,s,i)}),V=C({lifeCycleEventNames:["onSuggestReceivingUpdate"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.SuggestionReceivingStart}),z=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.EndMessageSession,lifeCycleEventNames:["onSuggestReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,a)=>{if(!k("end_message_session",n.SessionLifeCycleMachineState.SuggestionReceivingStart)(e,t,s,a))return!1;{let e=(0,i.default)(s);return e.final_status={message:"Success",suggest:"Timeout",session:"Timeout"},e}}}),J=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.EndMessageSession,lifeCycleEventNames:["onSuggestReceivingEnd","onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>k("end_message_session",n.SessionLifeCycleMachineState.SuggestionReceivingStart)(e,t,s,i)}),Q=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.StartSuggestionReceiving,lifeCycleEventNames:["onBatchMessageReceivingEnd","onSuggestReceivingStart"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.BatchMessageReceivingStart,idleExecuteSessionLifeCycleNextAction:z,idleExecuteSessionLifeCycleNextActionIntervalGetter:()=>{let{receiveSuggestStartTimeout:e=d.defaultReceiveSuggestStartTimeout}=(0,u.getChatConfig)("chatMessageConfig")||{};return e}}),X=C({sessionLifeCycleMachineAction:n.SessionLifeCycleMachineAction.EndMessageSession,lifeCycleEventNames:["onMessageSessionEnd"],lifeCycleGuard:(e,t,s,i)=>i===n.SessionLifeCycleMachineState.MessageSessionStart}),Y=(e,t,s)=>{if(!s.message_id)return;let i=(0,c.isMessageFinished)(s),n=(0,g.isMessageFailed)(s),a=(0,g.isBrokenMessage)(s),r=(0,c.isAsyncTaskMessage)(s);O(e,t,s),r?F(e,t,s):U(e,t,s),n?q(e,t,s):a?W(e,t,s):i&&j(e,t,s)},Z=(e,t)=>{let s=f.messageLifeCycleManager.getSessionIdBySentMessageId(e,t);f.messageLifeCycleManager.getSessionLifeCycleContext(e,s,"").set("chatEventContext",new l.ChatEventContext({params:{slardar:{chat_session_scene:"resume_task",chat_session_id:s,chat_scene:o.ChatSceneEnum.DEFAULT}}})),(0,a.onMessageSessionStart)({slardar:{chat_session_scene:"resume_task",chat_session_id:s}}),x(e,s,{is_delta:!1})}},702427:function(e,t,s){s.d(t,{messageLifeCycleManager:function(){return f}});var i=s(544044),n=s(113849),a=s(266655),r=s(430780);let l={[r.SessionLifeCycleMachineState.Init]:{[r.SessionLifeCycleMachineAction.StartMessageSession]:r.SessionLifeCycleMachineState.MessageSessionStart},[r.SessionLifeCycleMachineState.MessageSessionStart]:{[r.SessionLifeCycleMachineAction.StartMessageSending]:r.SessionLifeCycleMachineState.MessageSendingStart,[r.SessionLifeCycleMachineAction.BreakMessageSending]:r.SessionLifeCycleMachineState.MessageSessionEnd},[r.SessionLifeCycleMachineState.MessageSendingStart]:{[r.SessionLifeCycleMachineAction.BreakMessageSending]:r.SessionLifeCycleMachineState.MessageSessionEnd,[r.SessionLifeCycleMachineAction.SuccessMessageSending]:r.SessionLifeCycleMachineState.BatchMessageReceivingStart,[r.SessionLifeCycleMachineAction.ErrorMessageSending]:r.SessionLifeCycleMachineState.MessageSessionEnd,[r.SessionLifeCycleMachineAction.TimeoutMessageSending]:r.SessionLifeCycleMachineState.MessageSessionEnd},[r.SessionLifeCycleMachineState.BatchMessageReceivingStart]:{[r.SessionLifeCycleMachineAction.StartSuggestionReceiving]:r.SessionLifeCycleMachineState.SuggestionReceivingStart,[r.SessionLifeCycleMachineAction.BreakMessageReceiving]:r.SessionLifeCycleMachineState.MessageSessionEnd,[r.SessionLifeCycleMachineAction.EndMessageSession]:r.SessionLifeCycleMachineState.MessageSessionEnd,[r.SessionLifeCycleMachineAction.ErrorMessageReceiving]:r.SessionLifeCycleMachineState.MessageSessionEnd,[r.SessionLifeCycleMachineAction.TimeoutMessageReceiving]:r.SessionLifeCycleMachineState.MessageSessionEnd},[r.SessionLifeCycleMachineState.SuggestionReceivingStart]:{[r.SessionLifeCycleMachineAction.EndMessageSession]:r.SessionLifeCycleMachineState.MessageSessionEnd},[r.SessionLifeCycleMachineState.MessageSessionEnd]:{}},o={[r.SingleReceivingMessageLifeCycleMachineState.Init]:{[r.SingleReceivingMessageLifeCycleMachineAction.StartMessageReceiving]:r.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart},[r.SingleReceivingMessageLifeCycleMachineState.MessageReceivingStart]:{[r.SingleReceivingMessageLifeCycleMachineAction.EndMessageReceiving]:r.SingleReceivingMessageLifeCycleMachineState.MessageReceivingEnd},[r.SingleReceivingMessageLifeCycleMachineState.MessageReceivingEnd]:{}};class c{setState(e){this.state=e}getState(){return this.state}resetState(){this.state=this.initState}nextState(e){let t=this.actionMap[this.state][e];void 0!==t&&(this.state=t)}constructor(e,t){var s,i,n;this.initState=e,this.actionMap=t,i=void 0,(s="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(s="state","string"))?n:n+"")in this?Object.defineProperty(this,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[s]=i,this.state=e}}class g extends c{constructor(e=r.SessionLifeCycleMachineState.Init,t=l){super(e,t),this.initState=e,this.actionMap=t}}class u extends c{constructor(e=r.SingleReceivingMessageLifeCycleMachineState.Init,t=o){super(e,t),this.initState=e,this.actionMap=t}}function d(e,t,s){var i;return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?i:i+"")in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function M(){return{context:{},sessionMachine:new g,timers:{},queue:new n.default({concurrency:1}),singleReceivingMessageMachine:{}}}let f=new class{_initSessionStoreIfNeed(e,t){return this.store[e]?this.store[e][t]||(this.store[e][t]=M()):this.store[e]={[t]:M()},this.store[e][t]}_initSessionStoreForce(e,t){return this.store[e]?(this._clearEffect(this.store[e][t]),this.store[e][t]=M()):this.store[e]={[t]:M()},this.store[e][t]}_clearEffect(e){var t;let s=null==e?void 0:e.timers;null===(t=(0,a.default)(s))||void 0===t||t.forEach(e=>{clearTimeout(e)});let i=null==e?void 0:e.queue;null==i||i.clear()}_getSessionLifeCycleContext(e,t){return this._initSessionStoreIfNeed(e,t),{ctx:this.store[e][t].context}}_getSessionLifeCycleIdleNextActionTimer(e,t){return this._initSessionStoreIfNeed(e,t),{timers:this.store[e][t].timers}}_createSessionIdWithSentMessageIdIfNeed(e,t){if(this.sessionIdMap[e]||(this.sessionIdMap[e]={}),!this.sessionIdMap[e][t]){let s=(0,i.default)();this.sessionIdMap[e][t]=s}return this.sessionIdMap[e][t]}getSessionIdBySentMessageId(e,t){return this._createSessionIdWithSentMessageIdIfNeed(e,t)}copySessionIdWithSentMessageId(e,t,s){return this.sessionIdMap[e]||(this.sessionIdMap[e]={}),this.sessionIdMap[e][s]=this.sessionIdMap[e][t],this.sessionIdMap[e][s]}createLifeCycleSessionStore(e,t){return this._initSessionStoreForce(e,t)}getSessionLifeCycleContext(e,t,s){let{ctx:i}=this._getSessionLifeCycleContext(e,t);return{current_session_state:this._getSessionLifeCycleMachine(e,t).getState(),current_single_receiving_message_state:this._getSingleRecevingMessageLifeCycleMachine(e,t,s||"").getState(),get:e=>null==i?void 0:i[e],set:(e,t)=>(i[e]=t,i[e])}}_getAllSingleRecevingMessageLifeCycleMachine(e,t){return this._initSessionStoreIfNeed(e,t),{state:this.store[e][t].singleReceivingMessageMachine,resetState:()=>{this.store[e][t].singleReceivingMessageMachine={}}}}_getSessionLifeCycleMachine(e,t){return this._initSessionStoreIfNeed(e,t),this.store[e][t].sessionMachine}_getSingleRecevingMessageLifeCycleMachine(e,t,s){var i;return this._initSessionStoreIfNeed(e,t),(null===(i=this.store[e][t].singleReceivingMessageMachine)||void 0===i?void 0:i[s])||(this.store[e][t].singleReceivingMessageMachine[s]=new u),this.store[e][t].singleReceivingMessageMachine[s]}nextSessionLifeCycleMachineState(e,t,s){let i=this._getSessionLifeCycleMachine(e,t);void 0!==s&&i.nextState(s)}nextSingleReceivingMessageLifeCycleMachineState(e,t,s,i){let n=this._getSingleRecevingMessageLifeCycleMachine(e,t,s);void 0!==i&&n.nextState(i)}getSessionLifeCycleMachineState(e,t){return this._getSessionLifeCycleMachine(e,t).getState()}forceUpdateSessionLifeCycleMachine(e,t,s){return this._getSessionLifeCycleMachine(e,t).setState(s)}getSingleRecevingMessageLifeCycleMachineState(e,t,s){return this._getSingleRecevingMessageLifeCycleMachine(e,t,s).getState()}pushQueue(e,t,s){this._initSessionStoreIfNeed(e,t),this.store[e][t].queue.add(s)}idleExecuteSessionLifeCycleNextAction(e,t,s,i){let n=this.getSessionLifeCycleMachineState(e,t);this.clearSessionLifeCycleIdleNextAction(e,t,n),this.store[e][t].timers[n]=setTimeout(s,i)}clearSessionLifeCycleIdleNextAction(e,t,s){let{timers:i}=this._getSessionLifeCycleIdleNextActionTimer(e,t);i[s]&&(clearTimeout(i[s]),i[s]=void 0)}moveAllSessionLifeCycle(e,t){this.store[t]=this.store[e],this.sessionIdMap[t]=this.sessionIdMap[e]}constructor(){d(this,"store",{}),d(this,"sessionIdMap",{})}}},277828:function(e,t,s){s.d(t,{createLocalMessageId:function(){return n},createLocalMessageKey:function(){return a}});var i=s(544044);let n=()=>(0,i.default)(),a=()=>(0,i.default)()},83990:function(e,t,s){s.r(t),s.d(t,{createStore:function(){return l},initMessageStore:function(){return c},useMessageStore:function(){return o}});var i=s(952259),n=s(321647),a=s(746479),r=s(382973);let l=e=>{let{prefix:t,isEnableDebug:s,reduxDevToolsSnapshot:l}=e;return((0,a.enablePatches)(),s&&l)?(0,n.create)()((0,i.devtools)((0,i.subscribeWithSelector)(r.createMessageSlice),{name:`${t}chat-message-store`})):(0,n.create)()((0,i.subscribeWithSelector)(r.createMessageSlice))},o=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let{_useMessageStore:i}=o.prototype;if(i)return i(...t);throw Error("useMessageStore is not initialized")};function c(e){let{_useMessageStore:t}=o.prototype||{};if(!t){let t=l({...e});Object.setPrototypeOf(o.prototype,t),Object.defineProperties(o,{...Object.getOwnPropertyDescriptors(t)}),o.prototype._useMessageStore=t}}},899265:function(e,t,s){s.d(t,{messageAtomDefaultState:function(){return i}});let i={messageMap:{},localMessageMap:{},messageLinkMap:{},messageListStatusMap:{},regenerateMessageMap:{},searchResultIsFinishedMap:{},sendMessagePromiseTasks:{},lastMessageMap:{},rateLimitConfig:{isLimited:!1,limitExpired:void 0,limitTips:""},musicAutoPlay:!1}},745829:function(e,t,s){s.d(t,{createMessageAtomSlice:function(){return G},logicalDeleteMessage:function(){return B},replaceLocalMessageByRemote:function(){return D},deleteLocalReplyMessageByReplyId:function(){return U},deleteLocalReceivingMessage:function(){return O},deleteLocalOnboarding:function(){return w},deleteMessageInLocalMessageMapByReplyId:function(){return F},physicalDeleteMessage:function(){return b}});var i=s(339902),n=s(678669),a=s(459735),r=s(4137),l=s(131696),o=s(436114),c=s(217957),g=s(605173),u=s(746479),d=s(101874),M=s(728369),f=s(695422),S=s(840738),v=s(674157),m=s(922851),h=s(689368),p=s(698392),_=s(461141),y=s(645298),C=s(246024),k=s(458524),L=s(178230),E=s(899265),T=s(630768),R=s(752544),x=s(800477),I=s(277828),A=s(555897),P=s(472667);function b(e,t){let{draftLocalMessageMap:s,draftMessageMap:n,draftMessageLinks:a}=e,{isLocalMessage:r,messageId:l}=t;return r?delete s[l]:delete n[l],(0,i.default)(a,e=>e.messageId===l)}function B(e,t){let{isLocalMessage:s,messageId:i}=t,{draftLocalMessageMap:n,draftMessageMap:a}=e;s&&n[i]?n[i].status=k.PushMessageStatus.InVisible:a[i]&&(a[i].status=k.PushMessageStatus.InVisible)}function w(e){let t=b(e,{isLocalMessage:!0,messageId:(0,S.getTemporaryReplyMessageId)(y.onBoardingConstantMessageId)});t>-1&&e.draftMessageLinks.splice(t,1)}let N=(e,t)=>{var s,i,l;let o={...e.ext,...t.ext},c=null===(s=e.local)||void 0===s?void 0:s.localKey;return{...(0,n.default)(e,["local","local_message_id"]),...(0,a.default)((0,n.default)(t,["skill"]),r.default),ext:o,local_info:{...e.local_info,...t.local_info,local_key:c,from:(null===(i=t.local_info)||void 0===i?void 0:i.from)||(null===(l=e.local_info)||void 0===l?void 0:l.from)||d.MessageFrom.Unknown}}};function D(e){let{draft:t,localMessage:s,message:i}=e,{message_id:n}=i,{local_message_id:a}=s;if(!n||!a){L.logger.console.warning("skip replaceLocalMessageWithRemoteMessage: invalid remote/local message");return}t.draftMessageMap[n]=N(s,i);let r=b(t,{isLocalMessage:!0,messageId:a});if(r>-1){var l,o;let e=t.draftMessageLinks[r];return null===(l=t.draftMessageLinks.splice(r,1,{isLocalMessage:!1,messageId:n,messageKey:null!==(o=e.messageKey)&&void 0!==o?o:(0,I.createLocalMessageKey)()}))||void 0===l?void 0:l[0]}L.logger.persist.warning({message:"not found local message to replace",meta:{localMessageId:a}})}let G=(e,t)=>({...E.messageAtomDefaultState,fetchMessageList:async e=>{let{conversationId:t,cursor:s,size:i,v2ApiExt:n}=e;if(s<=0||i<=0||!t||"0"===t){L.logger.console.warning({message:"fetchUpdateMessageList: invalid cursor input",meta:{conversationId:t,cursor:s}});return}try{let e=await (await (0,P.getMessageApiClient)()).getMessageList({conversation_id:t,cursor:s,batch_size:i,v2_api_ext:n}),{data:r}=e,o={from:d.MessageFrom.Api,logId:(0,C.getLogIdFromResponse)(e)},c=(await Promise.all(((null==r?void 0:r.message_list)||[]).reverse().map(async e=>await (0,x.transformAliceChatMessageToMessage)(e,{local_info:o})))).map(e=>({...e,is_delta:!1})),g=c.filter(e=>!!(0,v.isRegenerateMessage)(e)||!!(0,v.isMessageFinished)(e)),u=(0,l.default)(c,e=>{var t;return(null==e?void 0:null===(t=e.async_task)||void 0===t?void 0:t.status)===M.AsyncTaskStatus.AsyncTaskStatusProcessing});if((0,m.getChatService)("chatInputStoreService").then(e=>{var s;return null==e?void 0:e.updateSendMessageStatus(t,(null==u?void 0:null===(s=u.async_task)||void 0===s?void 0:s.status)===M.AsyncTaskStatus.AsyncTaskStatusProcessing?f.ChatInputSendMessageStatus.Receiving:f.ChatInputSendMessageStatus.Default)}),u){var a;(null==u?void 0:null===(a=u.async_task)||void 0===a?void 0:a.id)&&(0,h.getChatProtocolPlugin)("SamanthaChat").then(async e=>{var t,s,i,n,a;let r=(null===(t=u.async_task)||void 0===t?void 0:t.id)||"",l=(await (0,p.getAsyncChatStore)("samanthaChatProtocolStore")).getState().samanthaChatAsyncTaskMap[r],o=(null==l?void 0:null===(s=l.message)||void 0===s?void 0:s.conversation_id)||"",c=(null==l?void 0:null===(i=l.message)||void 0===i?void 0:i.reply_id)||"";(0,A.toggleMessageSessionStartWithResumeTask)(o,c),l?null==e||null===(n=e.resumeAsyncTask)||void 0===n||n.call(e,[l]):null==e||null===(a=e.createAsyncTask)||void 0===a||a.call(e,u,r)})}return{hasMore:!!(null==r?void 0:r.has_more),messages:g,messageLinks:g.map(e=>({messageId:e.message_id||"",isLocalMessage:!1})),regenerateList:(await Promise.all(((null==r?void 0:r.regen_list)||[]).reverse().map(async e=>await (0,x.transformAliceChatMessageToMessage)(e,{local_info:o})))).map(e=>({...e,is_delta:!1}))}}catch(e){throw e instanceof Error&&L.logger.persist.error({message:"fetchUpdateMessageList failed",error:e}),e}},fetchEnoughMessageList:async e=>{let{conversationId:s,cursor:i,size:n,v2ApiExt:a}=e,r=[],l=0,o=i,c=!0,g=!1;for(;c;){let e=await t().fetchMessageList({conversationId:s,cursor:o,size:n,v2ApiExt:a});if(r.push(e),c=!1,!e){g=!1;return}if(e.messages.length===n){let t=e.messages.filter(v.isMessageAvailable).length;(l+=t)<y.defaultCheckAvailableMessageSize&&(L.logger.persist.warning({message:"fetchEnoughMessageList: auto load more",meta:{fetchSize:e.messages.length,currentFetchAvailableMessageSize:t,fetchAvailableSize:l}}),o-=n,c=!0)}c&&r.length>=5&&(c=!1,L.logger.persist.warning({message:"fetchEnoughMessageList: break by maxTry",meta:{fetchAvailableSize:l}})),g=e.hasMore}return 1===r.length?r[0]:r.reduceRight((e,t)=>(t&&(e.messageLinks=e.messageLinks.concat(t.messageLinks),e.messages=e.messages.concat(t.messages),e.regenerateList=e.regenerateList.concat(t.regenerateList)),e),{messages:[],messageLinks:[],regenerateList:[],hasMore:g})},logicalDeleteMessage:e=>{let{conversationId:s,messageLink:i,deleteReply:n=!1}=e;t().createUpdateMessageList(s)(e=>{if(B(e,i),n){let t=(0,T.findAllMessageLinkByMatchEqualId)({replyId:i.messageId,messageLinks:e.draftMessageLinks,getMessage:(0,R.createGetMessage)({localMessageMap:e.draftLocalMessageMap,messageMap:e.draftMessageMap})});(null==t?void 0:t.length)&&t.forEach(t=>B(e,t))}})},clearConversationMessages:t=>{e((0,u.produce)(e=>{e.messageMap[t]&&delete e.messageMap[t],e.localMessageMap[t]&&delete e.localMessageMap[t],e.regenerateMessageMap[t]&&delete e.regenerateMessageMap[t],e.messageLinkMap[t]&&delete e.messageLinkMap[t],e.messageListStatusMap[t]&&delete e.messageListStatusMap[t]}))},updateMessageList:async s=>{let{conversationId:i,immerUpdate:n}=s,a=(0,u.createDraft)(t());a.messageMap[i]||(a.messageMap[i]={}),a.localMessageMap[i]||(a.localMessageMap[i]={}),a.regenerateMessageMap[i]||(a.regenerateMessageMap[i]={messageMap:{}}),a.messageListStatusMap[i]||(a.messageListStatusMap[i]={hasMore:!1,lastCursor:0,inIniting:!1,inLoadingMore:!1}),Array.isArray(a.messageLinkMap[i])||(a.messageLinkMap[i]=[]);let r=function(e,t){let{regenerateMessageMap:s,messageMap:i,messageLinkMap:n,messageListStatusMap:a}=t;return{overrideMessages:t=>{Array.isArray(t)&&t.forEach(t=>{t.message_id&&(i[e][t.message_id]=t)})},overrideMessageLinks:t=>{n[e]=t},overrideRegenerateMessagesAndUpdateLink:t=>{if((0,g.default)(t)&&(null==t?void 0:t.length)){if(s[e]){var i,n;let a=Object.values(s[e].messageMap);(null===(i=t[0])||void 0===i?void 0:i.reply_id)!==(null===(n=a[0])||void 0===n?void 0:n.reply_id)&&(s[e]={messageMap:{}})}else s[e]={messageMap:{}};t.forEach(t=>{let{message_id:i}=t;i&&(s[e].messageMap[i]=t)})}},resetMessageLink:(t,s)=>{var i,a,r,l;let o=null!==(r=null===(a=n[e])||void 0===a?void 0:null===(i=a.findIndex)||void 0===i?void 0:i.call(a,e=>t===e.messageId))&&void 0!==r?r:-1;if(~o){let t=n[e][o];null===(l=n[e])||void 0===l||l.splice(o,1,{...t,...s})}},setMessageStatus:t=>{a[e]=t}}}(i,a);await n({draftMessageMap:a.messageMap[i],draftLocalMessageMap:a.localMessageMap[i],draftMessageLinks:a.messageLinkMap[i],draftMessageListStatus:a.messageListStatusMap[i],draftRegenerateMessageMap:a.regenerateMessageMap[i]},r);let l=[];(0,u.finishDraft)(a,e=>l.push(...e));try{e((0,u.applyPatches)(t(),l))}catch(e){L.logger.console.log(e)}},createUpdateMessageList:e=>s=>t().updateMessageList({conversationId:e,immerUpdate:s}),hasSendMessageTask:e=>!!e.local_message_id&&!!t().sendMessagePromiseTasks[e.local_message_id],addSendMessageTask(t){let{local_message_id:s}=t;if(!s)return;let{sendMessageStartTimeout:i=y.defaultSendMessageStartTimeout}=(0,_.getChatConfig)("chatMessageConfig")||{};e((0,u.produce)(e=>{e.sendMessagePromiseTasks[s]={local_message_id:s,finish:o.default,expired:Date.now()+i}}))},isSendMessageExpired(e){var s;let i=e.local_message_id;if(!i)return!1;let n=null===(s=t().sendMessagePromiseTasks[i])||void 0===s?void 0:s.expired;return!(0,c.default)(n)&&Date.now()-n>0},updateSendMessageTaskFinishFn(s,i){let n=s.local_message_id;if(!n)return;let a=()=>{i(),e((0,u.produce)(e=>{delete e.sendMessagePromiseTasks[n]}))};t().sendMessagePromiseTasks[n]&&e((0,u.produce)(e=>{e.sendMessagePromiseTasks[n].finish=a}))},finishSendMessageTask(e){var s;e&&(null===(s=t().sendMessagePromiseTasks[e])||void 0===s||s.finish())},updateRateLimitConfig:t=>e(()=>({rateLimitConfig:t})),setMusicAutoPlay:t=>{e(()=>({musicAutoPlay:t}))}});function O(e,t){let s=e.draftLocalMessageMap[t];if(null==s?void 0:s.local_message_id){var i;let t=b(e,{isLocalMessage:!0,messageId:s.local_message_id});return{message:s,messageLink:null===(i=e.draftMessageLinks.splice(t,1))||void 0===i?void 0:i[0]}}}function U(e,t){if(!t)return;let s=(0,R.createGetMessage)({localMessageMap:e.draftLocalMessageMap,messageMap:e.draftMessageMap});(0,T.findAllMessageLinkByMatchEqualId)({messageLinks:e.draftMessageLinks,getMessage:s,replyId:t}).forEach(t=>{b(e,{isLocalMessage:!0,messageId:t.messageId});let s=e.draftMessageLinks.findIndex(e=>e.messageId===t.messageId);-1!==s&&e.draftMessageLinks.splice(s,1)})}function F(e,t){if(!t)return;let{draftLocalMessageMap:s}=e;Object.entries(s).forEach(s=>{let[i,n]=s;n.reply_id===t&&b(e,{isLocalMessage:!0,messageId:i})})}},382973:function(e,t,s){let i,n;s.d(t,{defaultMessageStore:function(){return ei},createMessageSlice:function(){return en}});var a=s(4137),r=s(462696),l=s(106656),o=s(204418),c=s(993478),g=s(847546),u=s(746479),d=s(101874),M=s(840738),f=s(674157),S=s(725705),v=s(645298),m=s(458524),h=s(172320),p=s(178230),_=s(296493);let y={suggestMessageMap:{}},C=(e,t)=>({...y,clearSuggestMessage:t=>{e((0,u.produce)(e=>{e.suggestMessageMap[t]&&delete e.suggestMessageMap[t]}))},updateSuggestMessage:(t,s)=>{e(e=>{let i=s(e.suggestMessageMap[t]),n={...e.suggestMessageMap};return i?n[t]=i:delete n[t],{suggestMessageMap:n}})},updateSuggestMessageWithRemote:(e,s)=>{t().updateSuggestMessage(e,t=>{try{var i;if(!(null==s?void 0:s.reply_id))return t;let e=JSON.parse((null===(i=s.ext)||void 0===i?void 0:i.sp)||"[]");return{replyId:s.reply_id,loading:!1,failed:!1,expired:void 0,suggests:(0,_.isStringArray)(e)?e.filter(e=>!!e):[]}}catch(i){return p.logger.persist.warning({message:"load remote sp fail",meta:{conversationId:e,message_id:null==s?void 0:s.message_id,reply_id:null==s?void 0:s.reply_id}}),t}})}});var k=s(910214);let L="data is empty",E={sourceShareCreatorInfoMap:{}},T=(e,t)=>({...E,fetchSourceShareCreatorInfo(s){let{creatorId:i}=s,n=(t().sourceShareCreatorInfoMap[i]||Promise.resolve()).then(e=>{if(!(null==e?void 0:e.nickname))throw Error(L);return e}).catch(e=>(e.message!==L&&p.logger.console.error({message:"failed to fetch share section divider creator profile",error:e}),k.profileApiService.ProfileOverview({visit_id:i}).then(e=>{var t,s,i,n;return{nickname:null===(s=e.data)||void 0===s?void 0:null===(t=s.profile_brief)||void 0===t?void 0:t.nickname,image:null===(n=e.data)||void 0===n?void 0:null===(i=n.profile_brief)||void 0===i?void 0:i.image}})));return e((0,u.produce)(e=>{let{sourceShareCreatorInfoMap:t}=e;t[i]=n})),n}});var R=s(344417);let x={messageShowErrorHasReportedMap:{}},I=(e,t)=>({...x,checkMessageShowErrorHasReported:e=>{let{messageId:s}=e;return!!s&&(0,R.default)(t().messageShowErrorHasReportedMap[s])},updateMessageShowErrorHasReported:s=>{let{messageId:i}=s;if(!i)return;let n=Date.now();e({messageShowErrorHasReportedMap:{...t().messageShowErrorHasReportedMap,[i]:n}})}});var A=s(745829),P=s(788432),b=s(472667);let B={messageFeedbackMap:{}},w=e=>({...B,async updateMessageFeedback(t){let{conversationId:s,messageId:i,detail:n,reportEvent:a}=t;try{await (await (0,b.getMessageApiClient)()).feedback({message_id:i,feedbackDetail:n}),e((0,u.produce)(e=>{let{messageFeedbackMap:t}=e;t[s]||(t[s]={}),t[s][i]||(t[s][i]={}),(0,P.default)(t[s][i],n)})),null==a||a.success()}catch(e){e instanceof Error&&(null==a||a.error({reason:"message report failed",error:e}))}},updateMessageFeedbackStore(t){let{conversationId:s,messageId:i,detail:n}=t;e((0,u.produce)(e=>{let{messageFeedbackMap:t}=e;t[s]||(t[s]={}),t[s][i]||(t[s][i]={}),(0,P.default)(t[s][i],n)}))}});var N=s(899265),D=s(457251),G=s(856392);function O(e,t,s){var i;return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?i:i+"")in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class U{add(e){this.queue.includes(e)||this.queue.push(e),this.queue.length>=this.QUEUE_MAX_LENGTH?(this.run(),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)):this.timeoutId||(this.timeoutId=setTimeout(()=>this.run(),this.TIMEOUT))}async get(e){if(await this.hangPromise,this.promise){var t;let{data:s}=await this.promise;return null==s?void 0:null===(t=s.preview_images)||void 0===t?void 0:t[e]}}run(){var e;this.sended=!0,this.promise=k.samanthaApiService.PDFPreview({uris:this.queue}),null===(e=this.hangResolver)||void 0===e||e.call(this)}constructor(){O(this,"TIMEOUT",300),O(this,"QUEUE_MAX_LENGTH",5),O(this,"queue",[]),O(this,"timeoutId",null),O(this,"promise",null),O(this,"hangResolver",null),O(this,"hangPromise",new Promise(e=>this.hangResolver=e)),O(this,"sended",!1)}}let F=(i=new U,async e=>(i.sended&&(i=new U),i.add(e),await i.get(e)));class j{add(e){this.queue.includes(e)||this.queue.push(e),this.queue.length>=this.QUEUE_MAX_LENGTH?(this.run(),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)):this.timeoutId||(this.timeoutId=setTimeout(()=>this.run(),this.TIMEOUT))}async get(e){if(await this.hangPromise,this.promise){var t;let{data:s}=await this.promise;return null==s?void 0:null===(t=s.results)||void 0===t?void 0:t.find(t=>t.url===e)}}run(){var e;this.sended=!0,this.promise=k.samanthaApiService.SniffLink({links:this.queue,with_link_meta:!0}),null===(e=this.hangResolver)||void 0===e||e.call(this)}constructor(){O(this,"TIMEOUT",300),O(this,"QUEUE_MAX_LENGTH",5),O(this,"queue",[]),O(this,"timeoutId",null),O(this,"promise",null),O(this,"hangResolver",null),O(this,"hangPromise",new Promise(e=>this.hangResolver=e)),O(this,"sended",!1)}}let W=(n=new j,async e=>{n.sended&&(n=new j),n.add(e);let t=await n.get(e);return null==t?void 0:t.link_meta}),q={pdfPreviewMap:{},linkPreviewMap:{}},H=(e,t)=>({...q,async updatePdfPreview(s){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!s)return null;let n=t().pdfPreviewMap[s];if((null==n?void 0:n.timestamp)&&Date.now()-n.timestamp<31536e6)return n;let{fileType:a}=i,r=(0,G.createReportEvent)({eventName:"get_pdf_preview",meta:{file_type:a}});try{let t=s;if("Document"===a){let e=await (0,D.getDocPdfKey)(t);e&&(t=e)}let i=await F(t);if(!i)return r.error({reason:"image_url_empty",error:Error("image_url_empty")}),null;{let t={imageUrl:i,timestamp:Date.now()};return e((0,u.produce)(e=>{let{pdfPreviewMap:i}=e;i[s]=t})),r.addDurationPoint("success"),r.success(),t}}catch(e){return r.error({reason:"get_pdf_preview_failed",error:e instanceof Error?e:Error(String(e))}),null}},async updateLinkPreview(s){if(!s)return null;let i=t().linkPreviewMap[s];if(i)return i;let n=(0,G.createReportEvent)({eventName:"get_url_preview",meta:{url:s}});try{let t=await W(s);if(t)return e((0,u.produce)(e=>{let{linkPreviewMap:i}=e;i[s]=t})),n.addDurationPoint("success"),n.success(),t;return n.error({reason:"url_preview_empty",error:Error("url_preview_empty")}),null}catch(e){return n.error({reason:"get_url_preview_failed",error:e instanceof Error?e:Error(String(e))}),null}}});var $=s(752544),K=s(339902),V=s(179014),z=s(40680),J=s(140666);let Q=(e,t,s)=>e.filter(i=>{if(i.isLocalMessage){let n=s(i);if(~(0,K.default)(e,e=>{if(e===i)return!1;let s=t(e),a=!e.isLocalMessage;return!!(a&&s&&((null==s?void 0:s.message_id)===(null==n?void 0:n.message_id)||(null==s?void 0:s.local_message_id)===(null==n?void 0:n.local_message_id))||a&&(null==n?void 0:n.reply_id)&&(0,f.isMessageLoading)(n)&&(null==s?void 0:s.reply_id)===n.reply_id&&(0,f.isMessageAvailable)(s))}))return!1}return!0}),X=(e,t,s,i)=>{let n=(0,l.default)([...e,...t],e=>e.messageId);n.forEach(e=>{let s=t.find(t=>t.messageId===e.messageId);(null==s?void 0:s.messageKey)&&(e.messageKey=s.messageKey)});let a=Q(n,s,i);return(0,J.sortMessageLinks)(a,s),a},Y=(e,t)=>{let s=(0,V.default)(t,"messageId");return e.map(e=>(0,z.default)(e,s[e.messageId]))};var Z=s(884068),ee=s(630768),et=s(637319),es=s(800477);let ei={...N.messageAtomDefaultState,...y,...B,...E},en=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let[i,n]=t,_=async e=>{var t;let{conversationId:s,messageIndex:i,range:a,isGuest:r,hasPreprocessTask:l,createByLocalConversationId:o,v2ApiExt:c}=e,g=v.defaultFetchMessageSize,u=null!==(t=await n().fetchMergeMessageList({conversationId:s,cursor:i,size:g,range:a,isGuest:r,hasPreprocessTask:l,createByLocalConversationId:o,v2ApiExt:c}))&&void 0!==t?t:[];return 0===u.length&&p.logger.persist.warning({message:"initMessageList empty",meta:{messageIndex:i}}),n().refreshSuggestMessage({conversationId:s}),u};return{...C(...t),...(0,A.createMessageAtomSlice)(...t),...w(...t),...H(...t),...T(...t),...I(...t),fetchMergeMessageList:async e=>{let{conversationId:t,cursor:s,size:i,actionName:a="fetchMergeMessageList",range:r,isGuest:l,hasPreprocessTask:o,createByLocalConversationId:c,v2ApiExt:g}=e,u=n().createUpdateMessageList(t);if(i<=0){p.logger.persist.warning(`skip ${a}: invalid size`);return}let d={conversationId:t,cursor:s,size:i,v2ApiExt:g};try{let e=await n().fetchEnoughMessageList(d);if(!e||!l&&e.messageLinks.length<0)return;return u((t,s)=>{let{draftMessageLinks:i,draftMessageMap:n,draftLocalMessageMap:l}=t,g=(0,$.createGetMessage)({localMessageMap:l,messageMap:n}),u=(0,$.createGetLocalMessage)({localMessageMap:l});s.overrideMessages(e.messages);let M=X(c?Y(e.messageLinks,i):e.messageLinks,i,g,u);M=M.filter(e=>{if(e.isLocalMessage){let t=g(e);if(!(null==t?void 0:t.message_id)&&(null==t?void 0:t.user_type)===m.UserType.Human&&(0,S.isInPreProcessLocalMessage)(t)&&t.local.localKey)return o(t.local.localKey)}return!0}),s.overrideMessageLinks(M);let f=(0,$.getMessageListStatusByRange)({messageLinks:M,getMessage:g,hasMore:e.hasMore,range:r});s.setMessageStatus(f),s.overrideRegenerateMessagesAndUpdateLink(e.regenerateList),p.logger.console.info({message:`${a} finish`,meta:{messages:e.messages,status:f,requestPayload:d}})}),e.messageLinks}catch(e){throw e instanceof Error&&p.logger.persist.error({message:`${a} failed`,error:e,meta:{request:d}}),e}},initMessageList:async e=>{let{messageCursor:t,messageIndex:s,conversationId:i,isGuest:a}=e,r=n().createUpdateMessageList(i),l=n().messageLinkMap[i];Array.isArray(l)&&0!==l.length||r(e=>{let{draftMessageListStatus:t}=e;t.inIniting=!0});try{if(1===t&&0===s)for(let t=0;t<5;t++){let s=500*2**t;try{let t=await _({...e,messageCursor:1,messageIndex:1});if(!a&&!(null==t?void 0:t.length))throw Error("Empty MessageList when invoke _initMessageList");return t}catch(e){if(4===t)throw e;await (0,h.timeoutPromise)(s)}}else{if(!(s<=0)&&(!t||!(s<t)))return await _(e);p.logger.persist.warning({message:"skip initMessageList",meta:{messageCursor:t,messageIndex:s}});return}}catch(e){p.logger.persist.error({eventName:"init_message_list_error",error:e})}finally{r(e=>{let{draftMessageListStatus:t}=e;t.inIniting=!1})}},refreshSuggestMessage(e){let{conversationId:t}=e,{lastAvailableMessage:s}=(0,et.findLastAvailableMessageSelector)(n(),t);s&&n().updateSuggestMessageWithRemote(t,s)},loadMoreMessageList:async(e,t,s)=>{let r=n().messageListStatusMap[e];if(!r||r.lastCursor<=0){p.logger.persist.warning("skip loadMoreMessageList: invalid status");return}let l=v.defaultFetchMessageSize;i((0,u.produce)(t=>{t.messageListStatusMap[e].inLoadingMore=!0}));let o=await n().fetchMergeMessageList({conversationId:e,cursor:r.lastCursor-1,size:l,isGuest:t,hasPreprocessTask:s});return i((0,u.produce)(t=>{t.messageListStatusMap[e].inLoadingMore=!1})),(0,a.default)(o)&&p.logger.persist.warning({message:"skip loadMoreMessageList: invalid api response",meta:{}}),o},initOnboarding:e=>{let{conversationId:t}=e;n().updateMessageList({conversationId:t,immerUpdate:e=>{(0,A.deleteLocalOnboarding)(e);let s=(0,M.getTemporaryReplyMessageId)(v.onBoardingConstantMessageId);e.draftLocalMessageMap[s]=(0,Z.createLocalMessage)({localMessageStatus:d.LocalMessageStatus.ReceivingFirstPackage,message:{is_delta:!1,conversation_id:t,local_message_id:s,reply_id:v.onBoardingConstantMessageId,conversation_type:d.PcchatExprConversationType.Bot,user_type:m.UserType.Bot,ext:{onboarding:"1"}},failedExpired:Date.now()+v.onboardingWaitTimeout,messageLinks:e.draftMessageLinks,isRegenerate:!1}),e.draftMessageLinks.push({isLocalMessage:!0,messageId:s})}})},cancelOnboarding:e=>{let{conversationId:t}=e;n().updateMessageList({conversationId:t,immerUpdate:e=>{(0,A.deleteLocalOnboarding)(e)}})},checkExistRemoteMessage:e=>{let{conversationId:t,messageId:s}=e,i=(0,$.createGetMessage)({localMessageMap:n().localMessageMap[t],messageMap:n().messageMap[t]}),a=n().messageLinkMap[t];return!!(0,ee.findLastMessageLinkByMatchEqualId)({messageLinks:a,replyId:s,getMessage:i})},fetchLastMessages:async e=>{let{conversationIds:t,retryCount:s=2}=e;try{let{data:{message_map:e={},regen_map:i={},retry_list:a=null}={}}=await (await (0,b.getMessageApiClient)()).getLatestMessageList({request_list:t.map(e=>({conversation_id:e}))}),u=(0,r.default)(e,i,(e,t)=>(0,l.default)(e,t,e=>e.message_id)),M=await Promise.all((0,o.default)((0,c.default)(u),async e=>{let t=(0,g.default)(u[e],e=>e.index),s=t?await (0,es.transformAliceChatMessageToMessage)(t,{local_info:{from:d.MessageFrom.Api}}):null,i=s&&(0,f.isMessageAvailable)(s)?{...s,is_delta:!1}:void 0;return[e,i]})),S=Object.fromEntries(M);if((null==a?void 0:a.length)&&s>0){let e=await n().fetchLastMessages({conversationIds:a.map(String),retryCount:s-1});Object.assign(S,e||{})}return S}catch(e){p.logger.persist.error({message:"get latest messages failed",error:e});return}},updateLastMessageMap:async e=>{let{conversationIds:t}=e,s=await n().fetchLastMessages({conversationIds:t,retryCount:2});s&&i((0,u.produce)(e=>{e.lastMessageMap=s}))}}}},637319:function(e,t,s){s.d(t,{findLastAvailableMessageLinkSelector:function(){return f},findLastAvailableMessageSelector:function(){return M},findLastMessageByMatchEqualIdSelector:function(){return h},findLastMessageByReplyIdSelector:function(){return A},findLastMessageSelector:function(){return m},findSendAndAllReplyMessageIndexListSelector:function(){return _},getAllRegenMessagesOfSameReplyIdSelector:function(){return N},getLastAvailableReplyMessageSelector:function(){return y},getLastMessageIndexForUnreadCountSelector:function(){return x},getLastMessageIndexFromMessageLinksSelector:function(){return I},getLastStreamingMessageSelector:function(){return v},getLocalMessageSelector:function(){return p},getMessageByIdSelector:function(){return B},getMessageSelector:function(){return S},getReplyMessageSelector:function(){return P},getSearchReplyMessagesSelector:function(){return R},isFirstChatSelector:function(){return w},isLastAvailableMessage:function(){return C},isLastSendMessage:function(){return T},messageLinkSelector:function(){return k},messageLinksWithStatusSelector:function(){return E},messageListStatusSelector:function(){return L}});var i=s(683204),n=s(266655),a=s(101874),r=s(629006),l=s(674157),o=s(721118),c=s(230932),g=s(645298),u=s(752544),d=s(630768);let M=(e,t)=>{let s=e.messageLinkMap[t]?f(e,t,e.messageLinkMap[t]):void 0;return{lastAvailableMessage:s?S(e,t,s):void 0,lastAvailableMessageLink:s}},f=(e,t,s)=>{for(let i=s.length-1;i>=0;i--){let n=s[i],a=s[i-1],o=S(e,t,n),c=S(e,t,a);if((0,r.isAvailableBatchMessage)(o)&&(0,r.isAvailableBatchMessage)(c))return(0,r.isUnselectedBatchMessage)(o)?a:n;if((0,l.isMessageAvailable)(o))return n}},S=(e,t,s)=>(0,u.createGetMessage)((0,u.getMessageState)(e,t))(s),v=(e,t)=>{let{message:s}=m(e,t,e=>{let{getMessage:t}=e,s=t();return!(0,r.isLocalMessageHasBroken)(s)&&!(0,l.isMessageFinished)(s)&&!(0,r.isBrokenMessage)(s)});return s},m=(e,t,s)=>{let i=(0,u.createGetMessage)((0,u.getMessageState)(e,t)),n=e.messageLinkMap[t],a=(0,d.findLastLink)(n||[],e=>s({messageLink:e,getMessage:()=>i(e)}));return{messageLink:a,message:a?i(a):void 0}},h=(e,t,s)=>{let i=(0,d.findLastMessageLinkByMatchEqualId)({messageLinks:e.messageLinkMap[t],replyId:s,getMessage:(0,u.createGetMessage)((0,u.getMessageState)(e,t))});return i?S(e,t,i):void 0},p=(e,t,s)=>{var i;return(null===(i=e.localMessageMap[t])||void 0===i?void 0:i[s])||{}},_=(e,t,s)=>{let i=e.messageMap[t],n=i[s];if(!n)return[];let a=n.reply_id&&"0"!==n.reply_id?n.reply_id:s,r=i[null!=a?a:""],l=Object.keys(i).filter(e=>{var t;return(null===(t=i[e])||void 0===t?void 0:t.reply_id)===a}).map(e=>Number(i[e].index));return[...r?[Number(r.index)]:[],...l]},y=(e,t)=>{let s=e.messageLinkMap[t],i=(0,u.createGetMessage)({localMessageMap:e.localMessageMap[t],messageMap:e.messageMap[t]}),n=(0,d.findLastLink)(s,e=>{let t=i(e);return!!t&&(0,l.isMessageAvailable)(t)&&!!t.reply_id&&!(0,r.isSendMessage)(t)});return n?i(n):void 0},C=(e,t,s)=>{let{messageLinks:i,resolveConversationId:n}=E(e,t),a=f(e,n,i);return s===(null==a?void 0:a.messageId)},k=(e,t)=>e.messageLinkMap[t]||[],L=(e,t)=>e.messageListStatusMap[t]||{},E=(e,t)=>{let s=L(e,t),i=k(e,t),n=(0,o.conversationSelector)(c.useFeedStore.getState(),t);return(null==n?void 0:n.conversation_type)===a.PcchatExprConversationType.Coco&&0===i.length?{status:L(e,g.assistantConvIdWithoutCache),messageLinks:k(e,g.assistantConvIdWithoutCache),resolveConversationId:g.assistantConvIdWithoutCache}:{status:s,messageLinks:i,resolveConversationId:t}},T=(e,t,s)=>{let{messageLink:i}=m(e,t,e=>{let{getMessage:t}=e,s=t();return(0,r.isSendMessage)(s)&&(0,l.isMessageAvailable)(s)});return s===(null==i?void 0:i.messageId)},R=(e,t)=>{if(!(null==t?void 0:t.reply_id)||!(null==t?void 0:t.message_action_bar)||(0,r.isSendMessage)(t))return[];let s=t.reply_id,i=t.conversation_id||"",n=e.messageLinkMap[i],a=(0,u.createGetMessage)({messageMap:e.messageMap[i],localMessageMap:e.localMessageMap[i]});return(0,d.findAllMessageLinkByMatchEqualId)({messageLinks:n,replyId:s,getMessage:a}).map(e=>a(e)).filter(e=>(null==e?void 0:e.stream_id)===t.stream_id)},x=(e,t,s)=>{var i;let n=I(e,t);return n?Math.max(n,(null!==(i=null==s?void 0:s.badge_count)&&void 0!==i?i:null==s?void 0:s.message_index)||0):(null==s?void 0:s.badge_count)||0},I=(e,t)=>{let s=e.messageLinkMap[t],i=(0,d.findLastRemoteMessageLink)(s);if(!i)return 0;let n=S(e,t,i);return n?Number(n.index||0):0},A=(e,t,s)=>{let{message:i}=m(e,t,e=>{let{messageLink:t}=e;return t.messageId===s});return i},P=(e,t,s)=>{var i;let n=null===(i=e.messageLinkMap[t])||void 0===i?void 0:i.find(i=>{var n;return(null===(n=(i.isLocalMessage?e.localMessageMap:e.messageMap)[t][i.messageId])||void 0===n?void 0:n.reply_id)===s});if(n)return S(e,t,n)},b=(e,t,s)=>{var i;return null===(i=e.messageLinkMap[t])||void 0===i?void 0:i.find(e=>e.messageId===s)},B=(e,t,s)=>{let i=b(e,t,s);if(i)return S(e,t,i)},w=(e,t)=>{if(!(0,i.default)(e.messageMap,t))return!0;{let s=e.messageMap[t];return!!(0,n.default)(s).every(e=>(0,r.isOnBoardingMessage)(e))}},N=(e,t)=>{let s=t.reply_id;if(!t.is_regen||!s||(0,r.isSendMessage)(t))return[];let i=t.conversation_id||"",n=e.messageLinkMap[i],a=(0,u.createGetMessage)({messageMap:e.messageMap[i],localMessageMap:e.localMessageMap[i]});return(0,d.findAllMessageLinkByMatchEqualId)({messageLinks:n,replyId:s,getMessage:a}).map(e=>a(e)).filter(e=>(null==e?void 0:e.stream_id)===t.stream_id||!(null==e?void 0:e.stream_id)&&!t.stream_id)}},630768:function(e,t,s){s.d(t,{findAllMessageLinkByMatchEqualId:function(){return c},findLastLink:function(){return l},findLastMessageLinkByMatchEqualId:function(){return g},findLastRemoteMessageLink:function(){return o},findLatestBatchMessages:function(){return u}});var i=s(754358),n=s(907929),a=s(629006),r=s(475445);let l=(e,t)=>(0,i.default)(e||[],e=>t(e)),o=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return l(e,e=>{var s;return!e.isLocalMessage&&!!e.messageId&&(null===(s=null==t?void 0:t(e))||void 0===s||s)})},c=e=>{let{messageLinks:t=[],replyId:s,getMessage:i}=e;return(0,n.default)(t,e=>{var t;return(null===(t=i(e))||void 0===t?void 0:t.reply_id)===s})},g=e=>{let{messageLinks:t=[],replyId:s,getMessage:i}=e;return l(t,e=>{var t;return(null===(t=i(e))||void 0===t?void 0:t.reply_id)===s})};function u(e){let t=(0,r.getLatestMessageList)(e,10);for(let e=t.length-1;e>0;e--){var s;let i=t[e];if(!(0,a.isBatchMessage)(i))continue;let n=[i];for(;e>0&&(0,a.isBatchMessage)(t[e-1])&&t[e-1].reply_id&&t[e-1].reply_id===(null===(s=t[e])||void 0===s?void 0:s.reply_id);)n.unshift(t[e-1]),e--;return n}}},752544:function(e,t,s){s.d(t,{createGetLocalMessage:function(){return l},createGetMessage:function(){return a},createGetRemoteMessage:function(){return r},getMessageListStatusByRange:function(){return i},getMessageState:function(){return n},isLocalThreadId:function(){return o}});let i=e=>{var t;let{messageLinks:s,getMessage:i,hasMore:n,range:a}=e,r=Number(null===(t=i(s[0]))||void 0===t?void 0:t.index)||0;return{hasMore:r>((null==a?void 0:a.start)||0)||n,lastCursor:r,inIniting:!1,inLoadingMore:!1}},n=(e,t)=>({messageMap:e.messageMap[t],localMessageMap:e.localMessageMap[t],messageLinks:e.messageLinkMap[t],messageListStatus:e.messageListStatusMap[t]}),a=e=>t=>{var s,i;if(!t)return;let{isLocalMessage:n,messageId:a}=t;return n?null===(s=e.localMessageMap)||void 0===s?void 0:s[a]:null===(i=e.messageMap)||void 0===i?void 0:i[a]},r=e=>t=>{var s;if(!t)return;let{isLocalMessage:i,messageId:n}=t;return i?void 0:null===(s=e.messageMap)||void 0===s?void 0:s[n]},l=e=>t=>{var s;if(!t)return;let{isLocalMessage:i,messageId:n}=t;return i?null===(s=e.localMessageMap)||void 0===s?void 0:s[n]:void 0},o=function(e,t){var s,i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sub",a="sub"===n?"localThread_":"localMainThread_";return t?null==e?void 0:null===(s=e.startsWith)||void 0===s?void 0:s.call(e,`${a}${t}_`):null==e?void 0:null===(i=e.startsWith)||void 0===i?void 0:i.call(e,a)}},884068:function(e,t,s){s.d(t,{createLocalMessage:function(){return a}});var i=s(458524),n=s(630768);let a=e=>{var t;let{prevMessageId:s,message:a,messageLinks:r,localMessageStatus:l,failedExpired:o,isRegenerate:c,localKey:g,enterFrom:u,isReady:d,botType:M,samanthaChatStage:f,isNova:S}=e;return{...a,message_type:i.MessageType.Message,create_time:Date.now(),status:a.status||i.PushMessageStatus.Available,local:{samanthaChatStage:f,localKey:g,prevRemoteMessageId:s||(null===(t=(0,n.findLastRemoteMessageLink)(r))||void 0===t?void 0:t.messageId)||"",status:l,failed:!1,isRetried:!1,failedExpired:o,isRegenerate:c,enterFrom:u,isReady:d,botType:M,isNova:S}}}},140666:function(e,t,s){s.d(t,{compareMessageIndex:function(){return a},sortMessageLinks:function(){return r}});var i=s(725705),n=s(425311);function a(e,t){return(Number(null==e?void 0:e.index)||0)-(Number(null==t?void 0:t.index)||0)}let r=(e,t)=>{e.sort((e,s)=>{if(!e.isLocalMessage&&!s.isLocalMessage)return a(t(e),t(s));if(e.isLocalMessage&&s.isLocalMessage){var r,l;return r=t(e),l=t(s),((0,n.transToMilliSecondIfIsSecond)(Number(null==r?void 0:r.create_time))||0)-((0,n.transToMilliSecondIfIsSecond)(Number(null==l?void 0:l.create_time))||0)}if(e.isLocalMessage&&!s.isLocalMessage||!e.isLocalMessage&&s.isLocalMessage){let n=e.isLocalMessage&&!s.isLocalMessage,r=s.isLocalMessage&&!e.isLocalMessage,l=n?t(e):t(s),o=r?t(e):t(s);if(l&&"index"in l)return n?a(l,o):a(o,l);let c=l&&(0,i.isLocalMessage)(l)&&l.local.prevRemoteMessageId?t({messageId:l.local.prevRemoteMessageId,isLocalMessage:!1}):void 0;return c===o?n?1:-1:n?a(c,o):a(o,c)}return 0})}},425311:function(e,t,s){s.d(t,{transToMilliSecondIfIsSecond:function(){return i}});function i(e){let t=Date.now();if(e%10**(t.toString().length-1)!==e)return e;{let s=1e3*e;return s<t?s:e}}},800477:function(e,t,s){s.d(t,{transformAliceChatMessageToMessage:function(){return f}});var i=s(229079),n=s(788432),a=s(678669),r=s(629006),l=s(884277),o=s(456712),c=s(516655),g=s(689368),u=s(588426),d=s(212183),M=s(165482);let f=async(e,t)=>{var s,f,S,v,m;let h={...e,local_info:null==t?void 0:t.local_info,content_obj:(0,M.parseJSON)(e.content,void 0)},p=(0,i.default)(e,["ext","has_err"])?"Error":(0,r.isFinishAliceMessage)(e)?"Success":void 0;if((0,n.default)(h,{conversation_type:(null==t?void 0:t.conversation_type)||(0,u.getConversationTypeById)(e.conversation_id)||(0,u.getConversationTypeById)(e.local_conversation_id,!0),bot_id:e.bot_id||(0,d.getBotIdByConversationId)(e.conversation_id)||(0,d.getBotIdByConversationId)(e.local_conversation_id,!0),is_finish:!!(0,r.isFinishAliceMessage)(e),is_regen:"1"===(0,i.default)(e,["ext","regen"]),regen_active:"1"===(0,i.default)(e,["ext","regen_active"]),has_suggest:"1"===(0,i.default)(e,["ext","has_suggest"]),...(0,o.getErrorDetailsFromExt)(e.ext),...(0,o.getSkillFromExt)(e.ext),security_archive_state:(0,i.default)(e,["ext","archive_state"]),stream_id:Number(null!==(f=(0,i.default)(e,["ext","crowd_test_msg_index"]))&&void 0!==f?f:"0"),ext:e.ext,verbose:{seed_intention:{detail:(0,i.default)(e,["ext","llm_intention_detail"])||"",intention:(0,i.default)(e,["ext","llm_intention"])||"",is_deep_think:(0,i.default)(e,["ext","is_deep_think"])||"",seed_agent_name:(0,i.default)(e,["ext","seed_agent_name"])||"",intention_detail_dict:(0,i.default)(e,["ext","intention_detail_dict"])||"",query_difficulty:(0,i.default)(e,["ext","query_difficulty"])||""},deep_research:{deep_research_id:(0,i.default)(e,["ext","deep_research_id"]),deep_research_stage:Number(null!==(S=(0,i.default)(e,["ext","deep_research_stage"]))&&void 0!==S?S:"0")},super_task:{supertask_id:(0,i.default)(e,["ext","supertask_id"]),supertask_stage:Number(null!==(v=(0,i.default)(e,["ext","supertask_stage"]))&&void 0!==v?v:"0"),supertask_task_type:(0,i.default)(e,["ext","supertask_task_type"])},extra:{risk_tips:(0,i.default)(e,["ext","risk_tips"])||(0,i.default)(e,["ext","extra","risk_tips"])}},final_status:{message:p,session:p}}),e.content_block){let t=e.content_block.map(e=>({is_delta:!1,is_finish:!0,block_type:e.block_type,id:e.block_id||"",parent_id:e.parent_block_id||(0,i.default)(e,"parent_id")||"0",content_obj:"object"==typeof e.content?Object.values(e.content).find(e=>null!=e):"string"==typeof e.content?(0,M.parseJSON)(e.content,void 0):void 0,meta_infos:(null==e?void 0:e.meta_infos)||(0,i.default)(e,"meta_info")||[],is_deleted:!1}));h.content_blocks=t;let{contentBlocksTree:s,contentBlockNodes:n}=(0,l.buildContentBlockTree)(t);h.content_blocks_tree=s,h.content_block_nodes=n}if(null===(s=e.ext)||void 0===s?void 0:s.async_task){let t=(0,M.parseJSON)((0,i.default)(e,["ext","async_task"]),{});h.async_task=t}let _=await (0,c.getChatProtocolTransformPluginMatcher)();if(_){let s=null===(m=_.find(e=>{var t;return null===(t=e.matchPluginForAliceChatMessageToMessage)||void 0===t?void 0:t.call(e,h)}))||void 0===m?void 0:m.pluginIdentifier,i=await (0,g.getChatProtocolTransformPlugin)(s);if(null==i?void 0:i.aliceChatMessageToMessage)return i.aliceChatMessageToMessage(h,e,null==t?void 0:t.local_info)}return(0,a.default)(h,"content","content_block")}},687780:function(e,t,s){s.d(t,{LifeCycleExpectError:function(){return n},getLifeCycleError:function(){return l},isLifeCycleExpectError:function(){return r},isLifeCyclePanicError:function(){return a}});class i extends Error{constructor(e){super(e),this.name="LifecyclePanicError"}}class n extends Error{constructor(e){super(e),this.name="LifeCycleExpectError"}}let a=e=>e instanceof i,r=e=>e instanceof i,l=e=>r(e)?"ExpectError":a(e)?"PanicError":"Error"}}]);