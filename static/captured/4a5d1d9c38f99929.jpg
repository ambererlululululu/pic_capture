"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["86466"],{847364:function(e,t,o){o.d(t,{K:function(){return i}});var a=o(81192),n=o(810197);let i={length(e){let t=0,o=0;for(let a=0;a<e.length;++a)(o=e.charCodeAt(a))<128?t+=1:o<2048?t+=2:(64512&o)==55296&&(64512&e.charCodeAt(a+1))==56320?(++a,t+=4):t+=3;return t},read(e,t,o){if(o-t<1)return"";let a="";for(let n=t;n<o;){let t=e[n++];if(t<=127)a+=String.fromCharCode(t);else if(t>=192&&t<224)a+=String.fromCharCode((31&t)<<6|63&e[n++]);else if(t>=224&&t<240)a+=String.fromCharCode((15&t)<<12|(63&e[n++])<<6|63&e[n++]);else if(t>=240){let o=((7&t)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;a+=String.fromCharCode(55296+(o>>10)),a+=String.fromCharCode(56320+(1023&o))}}return a},write(e,t,o){let a,n;let i=o;for(let i=0;i<e.length;++i)(a=e.charCodeAt(i))<128?t[o++]=a:(a<2048?t[o++]=a>>6|192:((64512&a)==55296&&(64512&(n=e.charCodeAt(i+1)))==56320?(a=65536+((1023&a)<<10)+(1023&n),++i,t[o++]=a>>18|240,t[o++]=a>>12&63|128):t[o++]=a>>12|224,t[o++]=a>>6&63|128),t[o++]=63&a|128);return o-i},posCalcRange(e,t){let o=0,i={},r=(0,a.Z)(t);r=(0,n.Z)(r.sort((e,t)=>e-t));for(let t=0;t<e.length&&(o===r[0]&&(i[r[0]]=t,r.shift()),(64512&e[t].charCodeAt(0))==55296&&(64512&e[t+1].charCodeAt(0))==56320?(o+=this.length(`${e[t]}${e[t+1]}`),t++):o+=this.length(e[t]),r.length);t++);return i},posCalc(e,t){let o="",a=0;for(let n=0;n<e.length;n++)if(o+=e[n],this.length(o)===t){a=n+1;break}return a}}},112847:function(e,t,o){o.d(t,{t:function(){return a}});var a={Message:1,Cmd:2,AppAction:3}},28659:function(e,t,o){o.d(t,{l:function(){return a}});let a=new(o(537065)).v},249138:function(e,t,o){o.d(t,{H0:function(){return c},Id:function(){return v},LX:function(){return m},ay:function(){return g},df:function(){return p},dp:function(){return f},kl:function(){return _},wO:function(){return y}});var a=o(118200),n=o(210230),i=o(81307),r=o(41359),l=o(543281),s=o(910157),d=o(126473);let u={0:i.Ub.Unknown,1:i.Ub.File,2:i.Ub.Image,3:i.Ub.Directory,text:i.Ub.Text,attachment:i.Ub.File,link:i.Ub.Link,image:i.Ub.Image,directory:i.Ub.Directory,vlm_image:i.Ub.VlmImage,file:i.Ub.File},v=e=>[...(0,s.R)((0,a.Z)(e,["reference_content"]),[]).map(e=>({type:u[e.type],asrType:e.asrType,name:null==e?void 0:e.fileName,key:null==e?void 0:e.fileKey,url:null==e?void 0:e.link,link:null==e?void 0:e.link,content:null==e?void 0:e.text,extra:null==e?void 0:e.extra,identifier:null==e?void 0:e.identifier,option:null==e?void 0:e.option}))],c=(e,t)=>{let o={};return null==t||t.forEach(e=>{o[e.identifier]=e.fileName}),(null==e?void 0:e.map(e=>{var t,a,i,s,v,c,p,m,_,g,y,f,h,I,C,x,b,T,S,E,P,M,k,w,R,j,A,L,O,D,N,U,B,Z,G,z,H,F,$,Y,K,V,X,q,W,J,Q,ee,et,eo,ea,en,ei,er,el,es,ed,eu;if(e.entity_type===r.U3.Image){let t=(0,d.lm)((null===(M=e.entity_content)||void 0===M?void 0:null===(P=M.image)||void 0===P?void 0:P.key)||"");return{type:u.vlm_image,identifier:e.identifier,name:o[e.identifier]||`image.${t}`,key:null===(w=e.entity_content)||void 0===w?void 0:null===(k=w.image)||void 0===k?void 0:k.key,url:null===(A=e.entity_content)||void 0===A?void 0:null===(j=A.image)||void 0===j?void 0:null===(R=j.image_ori)||void 0===R?void 0:R.url,file_review_state:null!==(Z=e.file_name_state)&&void 0!==Z?Z:l.m9.ReviewState_Processing,file_parse_state:null!==(G=e.file_parse_state)&&void 0!==G?G:l.MZ.ParseState_Processing,option:{width:null===(D=e.entity_content)||void 0===D?void 0:null===(O=D.image)||void 0===O?void 0:null===(L=O.image_ori)||void 0===L?void 0:L.width,height:null===(B=e.entity_content)||void 0===B?void 0:null===(U=B.image)||void 0===U?void 0:null===(N=U.image_ori)||void 0===N?void 0:N.height}}}return e.entity_type===r.U3.Directory?{type:u.directory,identifier:e.identifier,name:null===(z=e.entity_content.directory)||void 0===z?void 0:z.name,key:e.identifier,url:"",file_review_state:null!==(H=e.file_name_state)&&void 0!==H?H:l.m9.ReviewState_Processing,file_parse_state:null!==(F=e.file_parse_state)&&void 0!==F?F:l.MZ.ParseState_Success}:[r.bQ.Audio,r.bQ.Video].includes(null===(a=e.entity_content)||void 0===a?void 0:null===(t=a.file)||void 0===t?void 0:t.file_type)?{type:r.bQ.Audio===(null===(Y=e.entity_content)||void 0===Y?void 0:null===($=Y.file)||void 0===$?void 0:$.file_type)?"audio":"video",identifier:e.identifier,name:null===(V=e.entity_content)||void 0===V?void 0:null===(K=V.file)||void 0===K?void 0:K.file_name,key:null===(q=e.entity_content)||void 0===q?void 0:null===(X=q.file)||void 0===X?void 0:X.key,md5:null===(J=e.entity_content)||void 0===J?void 0:null===(W=J.file)||void 0===W?void 0:W.md5,url:(null===(ee=e.entity_content)||void 0===ee?void 0:null===(Q=ee.file)||void 0===Q?void 0:Q.url)||(null===(en=e.entity_content)||void 0===en?void 0:null===(ea=en.file)||void 0===ea?void 0:null===(eo=ea.image)||void 0===eo?void 0:null===(et=eo.image_ori)||void 0===et?void 0:et.url),size:(0,n.Z)(null===(er=e.entity_content)||void 0===er?void 0:null===(ei=er.file)||void 0===ei?void 0:ei.size)?0:Number(null===(es=e.entity_content)||void 0===es?void 0:null===(el=es.file)||void 0===el?void 0:el.size),file_review_state:l.m9.ReviewState_Access,file_parse_state:l.MZ.ParseState_Success}:{type:u[(null===(s=e.entity_content)||void 0===s?void 0:null===(i=s.file)||void 0===i?void 0:i.file_type)||"attachment"],identifier:e.identifier,name:null===(c=e.entity_content)||void 0===c?void 0:null===(v=c.file)||void 0===v?void 0:v.file_name,key:null===(m=e.entity_content)||void 0===m?void 0:null===(p=m.file)||void 0===p?void 0:p.key,md5:null===(g=e.entity_content)||void 0===g?void 0:null===(_=g.file)||void 0===_?void 0:_.md5,url:(null===(f=e.entity_content)||void 0===f?void 0:null===(y=f.file)||void 0===y?void 0:y.url)||(null===(x=e.entity_content)||void 0===x?void 0:null===(C=x.file)||void 0===C?void 0:null===(I=C.image)||void 0===I?void 0:null===(h=I.image_ori)||void 0===h?void 0:h.url),size:(0,n.Z)(null===(T=e.entity_content)||void 0===T?void 0:null===(b=T.file)||void 0===b?void 0:b.size)?0:Number(null===(E=e.entity_content)||void 0===E?void 0:null===(S=E.file)||void 0===S?void 0:S.size),file_review_state:null!==(ed=e.file_name_state)&&void 0!==ed?ed:l.m9.ReviewState_Processing,file_parse_state:null!==(eu=e.file_parse_state)&&void 0!==eu?eu:l.MZ.ParseState_Processing}}))||[]},p=e=>null==e?void 0:e.map(e=>{var t;return{key:e.key,type:u.image,name:e.file_name,url:null===(t=e.image_ori)||void 0===t?void 0:t.url}}),m=e=>{var t,o;return[...((null===(o=(0,s.R)((0,a.Z)(e,["samantha_context"]),{}))||void 0===o?void 0:null===(t=o.query_context)||void 0===t?void 0:t.ref_images)||[]).map(e=>({type:i.Ub.Image,key:e.image_token,url:e.url,extra:{refer_types:e.refer_types},file_review_state:e.review_status,identifier:e.identifier}))]},_=e=>(null==e?void 0:e.repo_id)?{type:u.link,key:e.repo_id,url:e.url,identifier:e.repo_id,name:null==e?void 0:e.repo_name}:{type:u.link,key:e.url,url:e.url},g=e=>{var t;return null===(t=e.file_list)||void 0===t?void 0:t.map(e=>({key:e.key,name:e.file_name,type:u.attachment,url:e.key}))},y=e=>{var t;return(null===(t=e.image_list)||void 0===t?void 0:t.map(e=>{let{key:t,file_name:o,image_ori:a}=e;return{key:t,name:o,type:u.image,url:null==a?void 0:a.url}}))||[]},f=e=>e.map(e=>{let{key:t,name:o,url:a}=e;return{key:t||"",file_name:o,image_ori:{url:a||"",format:"",width:0,height:0},feedback:"",description:"",request_id:"",image_thumb_formats:{},image_thumb_ori_formats:{}}})},754068:function(e,t,o){o.d(t,{G:function(){return i},U:function(){return n}});var a=o(955943);let n=e=>{let t=[];for(let o of e)if(function(e){let t=Date.now();return t-function(e){let t=Date.now();if(e%10**(t.toString().length-1)!==e)return e;{let o=1e3*e;return o<t?o:e}}(e||t)<3e5}(Number(o.createTime))){t.push(o);break}return t};function i(e,t){return a.Z.stringifyUrl({url:e,query:t})}},854356:function(e,t,o){o.d(t,{Nu:function(){return r},US:function(){return i},o5:function(){return n}});var a=o(112847);let n=(e,t)=>{for(let o of e)o.eventEmitter.on("message",e=>t.message(e))},i=e=>{for(let t of e)null==t||t.eventEmitter.off("message"),null==t||t.drop()},r=(e,t)=>{let{event_type:o,message:n,cmd:i,message_list:r}=e;if(o===a.t.Message&&r)for(let e of r)t.eventEmitter.emit("message",e);o===a.t.Message&&n&&t.eventEmitter.emit("message",n)}},876029:function(e,t,o){o.d(t,{_:function(){return T}});var a=o(17135);function n(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}let i=Number.MAX_SAFE_INTEGER;class r{isValid(){return"0"!==this.high||"0"!==this.low}constructor(e,t){n(this,"high",void 0),n(this,"low",void 0),this.high=`${e}`,this.low=`${t}`}}let l=(e,t)=>{let o=`${t}`,a=e-o.length;if(a<=0)return o;for(;a;)o=`0${o}`,a--;return o};function s(e){return Number(e).toString(16)}function d(e){return parseInt(e,16)}let u=()=>Math.floor(Math.random()*i+1);class v{genId(){let e=this.addAndGet();return e>=this.maxId?(this.seed=this.randomNumber(),this.genId()):e}addAndGet(){return this.seed+=this.delta,this.seed}constructor(e){n(this,"seed",void 0),n(this,"delta",void 0),n(this,"maxId",void 0),n(this,"randomNumber",void 0),this.randomNumber=e.randomNumber,this.seed=e.randomNumber(),this.maxId=e.maxId,this.delta=e.delta}}let c={toStringW3C(e){let t=l(2,e.version),o=this.traceIdToString(e.traceId),{spanId:a}=e,n=l(2,e.flags);return`${t}-${o}-${a}-${n}`},inject(e){let t={"x-flow-trace":this.toStringW3C(e)};return e.baggage.size>0&&(t["x-flow-baggage"]=this.encodeBaggage(e.baggage)),t},spanIdToString:e=>l(16,s(e)),traceIdToString(e){let t=s(e.high),o=s(e.low);return l(16,t)+l(16,o)},parseCommaSeparatedMap(e,t){try{e=decodeURIComponent(e)}catch(e){return t}let o=e.split(",");for(let e=0;e<o.length;e++){let a=o[e].split("=");2===a.length&&void 0===t.get(a[0])&&t.set(a[0],a[1])}return t},encodeBaggage(e){let t="";for(let[o,a]of e){if(o.includes("=")||o.includes(",")||a.includes("=")||a.includes(","))return"";let e=encodeURIComponent(a||"");t+=t?`,${o}=${e}`:`${o}=${e}`}return t}},p=e=>{let t=e.getContext(),o=e.tags.reduce((e,t)=>({...e,[t[0]]:t[1]}),{});return{trace_log_id:e.logId,trace_id:c.traceIdToString(t.traceId),trace_span_duration:e.duration,trace_parent_id:t.parentId,trace_span_id:e.spanId,trace_span_name:e.name,trace_span_scene:e.scene,trace_span_start_timestamp:e.startTime,trace_status:0,...o}},m=e=>{let t=p(e);(0,a.trackEvent)("flow_telemetry_web",t)},_=()=>1e3*Date.now();function g(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}class y{getBaggageItem(e){return"string"!=typeof e||""===e?"":this.baggage.get(e)||""}isValid(){var e;return void 0!==this.debugInfo||(null===(e=this.traceId)||void 0===e?void 0:e.isValid())}constructor(){g(this,"version",4),g(this,"spanId",void 0),g(this,"parentId",void 0),g(this,"flags",void 0),g(this,"debugInfo",void 0),g(this,"traceId",void 0),g(this,"baggage",void 0),this.spanId="0",this.parentId="0",this.flags=1,this.debugInfo="",this.traceId=new r(0,0),this.baggage=new Map}}function f(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}class h{setTag(e,t){!this._ended&&this.tags.push([e,t])}setParentSpanId(e){this.parentSpanId=e}setTraceId(e){let t=e.slice(0,16),o=e.slice(16);this.traceId=new r(d(t),d(o))}setTags(e){if(!this._ended)for(let t of Object.entries(e))this.tags.push(t)}setBaggageItem(e,t){return this.baggage.set(e,t),this}elapse(){return(_()-this.startTime)/1e3}get duration(){return this._duration}get ended(){return this._ended}get scene(){return this._scene}set scene(e){this._scene=e}init(e){this.baggage=e}start(){this.startTime=_()}finish(){this._ended=!0,this.endTime=_(),this._duration=this.endTime-this.startTime}isRecording(){return!this._ended}toCarrier(){return this.trace.toCarrier(this.getContext())}abort(){this._ended=!0,this.startTime=0}getContext(){let e=new y;return e.traceId=this.traceId,e.spanId=this.spanId,e.parentId=this.parentSpanId,e.baggage=this.baggage,e}constructor(e,t,o,a){f(this,"startTime",0),f(this,"endTime",0),f(this,"_duration",0),f(this,"_ended",!1),f(this,"name",void 0),f(this,"isRootSpan",!0),f(this,"_scene",""),f(this,"parentSpanId",void 0),f(this,"spanId",void 0),f(this,"logId",void 0),f(this,"traceId",void 0),f(this,"trace",void 0),f(this,"tags",void 0),f(this,"baggage",void 0),f(this,"now",_),this.name=e,this.trace=t,this.traceId=o,this.parentSpanId=a||"0",this.baggage=new Map,this.spanId="",this.tags=[]}}function I(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}class C{static create(e){return new C(e)}getSpan(e){return this.spans.get(e)}startSpan(e){let t,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(o.context){let{spanId:a,baggage:n,traceId:i}=o.context;(t=new h(e,this,i,a)).baggage=n}else(t=new h(e,this,this.genTraceId())).spanId=this.genSpanId();return t.start(),t}enableSampling(){return!1}genTraceId(){return new r(u(),u())}genSpanId(){return c.spanIdToString(this.spanIdGenerator.genId())}toCarrier(e){return c.inject(e)}constructor(e){I(this,"name",void 0),I(this,"spans",void 0),I(this,"spanIdGenerator",void 0),this.name=e,this.spans=new Map,this.spanIdGenerator=new v({randomNumber:u,maxId:Number.MAX_SAFE_INTEGER,delta:1})}}var x=o(735980);function b(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}class T{static getInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";return T.traceInstances[e]||(T.traceInstances[e]=new T),T.traceInstances[e]}static moveInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default",o=T.traceInstances[e];T.traceInstances[t]=o,delete T.traceInstances[e]}startSpan(e){var t;let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(null===(t=this.rootSpan)||void 0===t?void 0:t.isRecording())&&this.rootSpan.finish(),this.rootSpan=this.tracer.startSpan(e,o),this.rootSpan.scene="samantha_send_message",this.rootSpan}isValid(){var e;return!!(null===(e=this.rootSpan)||void 0===e?void 0:e.logId)}addWaiter(e){this.waiters.set(e,new Promise(t=>this.resolvers.set(e,t)))}resolveWaiter(e){var t;null===(t=this.resolvers.get(e))||void 0===t||t()}async wait(){return Promise.race([Promise.all(this.waiters.values()),(0,x._)(5e3)])}resetWaiter(){this.waiters=new Map,this.resolvers=new Map}report(){this.rootSpan&&this.isValid()&&m(this.rootSpan),this.rootSpan=void 0}async reportAfterWaiters(){return this.waiters.size&&(await this.wait(),this.resetWaiter()),this.report()}async finishAndReport(){var e;(null===(e=this.rootSpan)||void 0===e?void 0:e.isRecording)&&(this.rootSpan.finish(),await this.reportAfterWaiters())}constructor(){b(this,"rootSpan",void 0),b(this,"tracer",void 0),b(this,"waiters",new Map),b(this,"resolvers",new Map),this.tracer=new C("message-tracer")}}b(T,"traceInstances",{})},720359:function(e,t,o){o.d(t,{d:function(){return i}});var a=o(708481),n=o(644367);let i=async(e,t)=>{var o,i,r,l;if(!e)return;n.k.persist.info({eventName:"send_message_start_with_samantha-chat-completion",meta:{local_message_id:null===(o=e[0])||void 0===o?void 0:o.local_message_id,message_id:null===(i=e[0])||void 0===i?void 0:i.message_id,conversation_id:null===(r=e[0])||void 0===r?void 0:r.conversation_id,local_conversation_id:null===(l=e[0])||void 0===l?void 0:l.local_conversation_id}});let s=await (0,a.cf)("SamanthaChat");null==s||s.sendMessage(e,t)}},882779:function(e,t,o){o.d(t,{$r:function(){return y},BY:function(){return r},Eu:function(){return u},Fd:function(){return E},L2:function(){return s},MX:function(){return v},NC:function(){return d},Nn:function(){return g},Nr:function(){return S},Pf:function(){return M},RP:function(){return m},VT:function(){return C},YE:function(){return _},Zz:function(){return c},_z:function(){return x},ah:function(){return f},cz:function(){return b},dL:function(){return P},gg:function(){return T},gm:function(){return p},m$:function(){return h},qb:function(){return I},sO:function(){return i},tn:function(){return l}});var a=o(771056),n=o(636674);let i=e=>"nestedItems"in e.payload,r=e=>"text"in e.payload,l=e=>"image"in e.payload||"image_key"in e.payload,s=e=>"file"in e.payload||"file_key"in e.payload,d=e=>"compositeContent"in e.payload,u=e=>{var t;return!!e.payload.operation&&"copySend"in e.payload.operation&&!!(null===(t=e.payload.operation)||void 0===t?void 0:t.copySend)},v=e=>"attachments"in e.payload,c=e=>"gen_ppt_input"in e.payload||"gen_outline_input"in e.payload,p=e=>"up_template_key"in e.payload,m=e=>"direct_research"in e.payload,_=e=>{var t;return!!(e.operation&&"regenerate"in e.operation&&(null===(t=e.operation)||void 0===t?void 0:t.regenerate))},g=e=>"text"in e,y=e=>"image"in e||"image_key"in e,f=e=>"file"in e||"file_key"in e,h=e=>"compositeContent"in e,I=e=>h(e)&&!!e.compositeContent&&"images"in e.compositeContent&&!!e.compositeContent.images,C=e=>h(e)&&!!e.compositeContent&&"files"in e.compositeContent&&!!e.compositeContent.files,x=e=>h(e)&&!!e.compositeContent&&"links"in e.compositeContent&&!!e.compositeContent.links,b=e=>h(e)&&!!e.compositeContent&&"websites"in e.compositeContent&&!!e.compositeContent.websites,T=e=>"nestedItems"in e,S=e=>"sendAttachments"in e;function E(e){let{stage:t,botType:o,isNeedDowngrade:n}=e;return"Main"===o&&t===a.Bo.Diff&&!n}function P(e){let{botType:t,stage:o,isNeedDowngrade:i,skill:r}=e;return"Main"===t&&(o===a.Bo.Release&&!i||(null==r?void 0:r.skill_type)===n.SkillType.VideoGeneration||(null==r?void 0:r.skill_type)===n.SkillType.CodeAssistant||(null==r?void 0:r.skill_type)===n.SkillType.MediaUnderstandingByAsr)}let M=e=>{var t,o,a,n;if(null==e?void 0:null===(t=e.ext)||void 0===t?void 0:t.collection_id)return!0;if(null==e?void 0:null===(o=e.ext)||void 0===o?void 0:o.reference_resource)try{return!!(null===(n=JSON.parse(e.ext.reference_resource))||void 0===n?void 0:null===(a=n.collection)||void 0===a?void 0:a.id)}catch{}return!1}},72856:function(e,t,o){o.d(t,{O:function(){return e4}});var a=o(164303),n=o(509403),i=o(81192),r=o(377940),l=o(81307),s=o(154760);let d=e=>{switch(e){case r.H_.GUIDANCE_PAGE:return s.V.GENERIC_START_PAGE_NEW_CONVERSATION;case r.H_.SKILL_GUIDANCE_PAGE:return s.V.SKILL_START_PAGE_NEW_CONVERSATION;case r.H_.GUIDANCE_PAGE_CLICK:return s.V.CLICK_GUIDANCE_NEW_CONVERSATION;case r.H_.SKILL_GUIDANCE_PAGE_CLICK:return s.V.CLICK_SKILL_GUIDANCE_NEW_CONVERSATION;case r.H_.SUGGEST:return s.V.SUGGEST;case r.H_.DOC_COPILOT:return s.V.DOC_COPILOT;default:return s.V.DEFAULT}};var u=o(302282),v=o(508830);function c(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}class p{getRecordTimestamp(e){return this.recordTimestamp[e]}getRecordTimestamps(){return this.recordTimestamp}setRecordTimestamp(e,t){this.recordTimestamp[e]=t}setCommonTraceParam(e){this.commonTraceParams={...this.commonTraceParams,...e}}setTeaEventTraceParams(e,t){this.teaEventTraceParams[e]={...this.teaEventTraceParams[e],...t}}setTeaEventOtherTraceParams(e){this.teaEventOtherTraceParams={...this.teaEventOtherTraceParams,...e}}getCommonTraceParams(){return this.commonTraceParams}getTeaEventTraceParams(e){return this.teaEventTraceParams[e]}getTeaEventOtherTraceParams(){return this.teaEventOtherTraceParams}addEventReportCount(e){this.eventReportCounts[e]=this.eventReportCounts[e]||0,this.eventReportCounts[e]++}getEventReportCounts(){return this.eventReportCounts}setReportTeaEventFailed(e){this.eventReportSuccessRecords[e]=!1}setReportTeaEventSuccess(e){this.eventReportSuccessRecords[e]=!0}getSuccessTeaEventCounts(){var e,t;return null===(t=(0,v.Z)(this.eventReportSuccessRecords))||void 0===t?void 0:null===(e=t.filter(e=>e))||void 0===e?void 0:e.length}getFailTeaEventCounts(){var e,t;return null===(t=(0,v.Z)(this.eventReportSuccessRecords))||void 0===t?void 0:null===(e=t.filter(e=>!e))||void 0===e?void 0:e.length}constructor(e){c(this,"recordTimestamp",void 0),c(this,"commonTraceParams",void 0),c(this,"teaEventTraceParams",void 0),c(this,"teaEventOtherTraceParams",void 0),c(this,"eventReportCounts",void 0),c(this,"eventReportSuccessRecords",void 0),this.recordTimestamp={receive_think_reason_start:void 0,receive_think_reason_first_text:void 0,receive_think_reason_end:void 0,receive_batch_message_first_text:void 0,receive_batch_message_first_token:void 0,receive_batch_message_end:void 0},this.commonTraceParams=(null==e?void 0:e.commonTraceParams)||{},this.teaEventTraceParams=(null==e?void 0:e.teaEventTraceParams)||{send_message:{},receive_suggests:{},receive_think_reason:{},receive_batch_message:{}},this.teaEventOtherTraceParams=(null==e?void 0:e.teaEventOtherTraceParams)||{},this.eventReportCounts={},this.eventReportSuccessRecords={}}}var m=o(915234),_=o(468494),g=o(886421),y=o(792288),f=o(771056),h=o(636674),I=o(455746),C=o(910157),x=o(644367),b=o(789691),T=o(515646),S=o(882779),E=o(148824),P=o(228535),M=o(589944),k=o(666396),w=o(777433),R=o(436462),j=o(744947),A=o(530836),L=o(63746),O=o(831929);let D=(e,t)=>{var o,a,n,i;let[r]=e;(0,w.FL)(r,k.lf),(null===(o=t.local)||void 0===o?void 0:o.isReady)&&((0,O.ae)({isRegenerate:t.local.isRegenerate,immerUpdateMessage:e,conversationId:null!==(i=t.conversation_id)&&void 0!==i?i:"",replyId:t.local.isRegenerate?t.reply_id||"":t.local_message_id||"",messageId:"",newLocalMessageId:k.lf,sectionId:t.section_id,timeout:null==t?void 0:null===(a=t.ext)||void 0===a?void 0:a.timeout,localMessageStatus:l.JR.WaitingAck,skillType:null==t?void 0:null===(n=t.skill)||void 0===n?void 0:n.skill_type}),(0,O.eD)({isRegenerate:t.local.isRegenerate,immerUpdateMessage:e,newLocalMessageId:k.lf,messageKey:(0,b.s)()}))},N=(e,t,o)=>{o.resolvedConversationId&&e.updateMessageList({conversationId:o.resolvedConversationId,immerUpdate:function(){for(var e,a=arguments.length,n=Array(a),i=0;i<a;i++)n[i]=arguments[i];if(!o.localMessageId)return;let[r]=n,{draftMessageLinks:l,draftLocalMessageMap:s}=r;s[o.localMessageId]=t;let d={isLocalMessage:!0,messageId:o.localMessageId};(null===(e=t.ext)||void 0===e?void 0:e.regen)!=="1"&&l.push(d),D(n,t)}})},U=(e,t)=>{e.updateMessageList({conversationId:t.resolvedConversationId,immerUpdate:e=>{let{draftLocalMessageMap:{[t.localMessageId]:o}}=e;(null==o?void 0:o.local)&&(o.local.failed=!0,o.local.status=l.JR.PreprocessFailed)}})},B=(e,t,o)=>{o.resolvedConversationId&&e.updateMessageList({conversationId:o.resolvedConversationId,immerUpdate:function(){for(var e,a,n,i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];let d=t.local_message_id;if(!d)return;let[u]=r,{draftLocalMessageMap:{[d]:v},draftMessageLinks:c}=u,p={...v,...t},{sendMessageStartTimeout:m=k.OY}=(0,M.$)("chatMessageConfig")||{};p.create_time=Date.now(),p.local.failedExpired=Date.now()+m,p.local.status=t.local.isRegenerate?l.JR.SendingRegenerate:l.JR.Sending,p.local.prevRemoteMessageId=t.local.isRegenerate?null==o?void 0:null===(a=o.operation)||void 0===a?void 0:null===(e=a.regenerate)||void 0===e?void 0:e.regenerateTailMessageId:(null===(n=(0,R.Pw)(c))||void 0===n?void 0:n.messageId)||"";let _=c.findIndex(e=>e.messageId===t.local_message_id);~_&&_!==c.length-1&&c.push(...c.splice(_,1)),u.draftLocalMessageMap[d]=p,D(r,p)}})},Z=e=>(0,j.ce)(A.useMessageStore.getState(),e);var G=o(876029),z=o(720359),H=o(708481),F=o(847364);let $=()=>{let e,t;return{promise:new Promise((o,a)=>{e=o,t=a}),resolve:e,reject:t}},Y=e=>!!e.local_message_id,K=e=>!!e.local_conversation_id||!!e.conversation_id,V=e=>(t,o)=>new Promise((a,n)=>{let i=A.useMessageStore.getState();if(!t.every(Y))return x.k.console.info("local_message_id is empty, skip to send message"),a("skip");if(!t.every(i.hasSendMessageTask))return x.k.console.info("task is empty, skip to send message"),a("skip");if(t.some(i.isSendMessageExpired))return a("skip");null==e||e(t,o);let r=t.map(e=>({message:e,...$()}));r.forEach(e=>{let{message:t,resolve:o}=e;return i.updateSendMessageTaskFinishFn(t,o)});let l=setTimeout(()=>n(Error("timeout")),o.customSendWaitTimeout||k._f);Promise.all(r.map(e=>{let{promise:t}=e;return t})).then(()=>{a("finish"),clearTimeout(l)})}),X=V(async(e,t)=>{var o,a,n,i;x.k.persist.info({eventName:"send_message_start_with_socket",meta:{local_message_id:null===(o=e[0])||void 0===o?void 0:o.local_message_id,message_id:null===(a=e[0])||void 0===a?void 0:a.message_id,conversation_id:null===(n=e[0])||void 0===n?void 0:n.conversation_id,local_conversation_id:null===(i=e[0])||void 0===i?void 0:i.local_conversation_id}});let r=await (0,H.cf)("AliceChatSocket");null==r||r.sendMessage(e,t)}),q=V(async(e,t)=>{var o,a,n,i;x.k.persist.info({eventName:"send_message_start_with_http\u2014long-polling",meta:{local_message_id:null===(o=e[0])||void 0===o?void 0:o.local_message_id,message_id:null===(a=e[0])||void 0===a?void 0:a.message_id,conversation_id:null===(n=e[0])||void 0===n?void 0:n.conversation_id,local_conversation_id:null===(i=e[0])||void 0===i?void 0:i.local_conversation_id}});let r=await (0,H.cf)("AliceChatFallback");null==r||r.sendMessage(e,t)}),W=(e,t)=>{let o=t||e,a=(t,n)=>e(t,n).catch(e=>o(t,n).catch(e=>a(t,n)));return a},J=e=>e.some(e=>{var t,o;return F.K.length(`${(0,C.B)(null==e?void 0:e.content_obj)||""}${(null==e?void 0:null===(t=e.ext)||void 0===t?void 0:t.browser_explain)||""}${(null==e?void 0:null===(o=e.ext)||void 0===o?void 0:o.samantha_context)||""}`)>k.sJ}),Q=(e,t)=>{let o=A.useMessageStore.getState();return e.every(Y)?e.every(K)?(e.forEach(e=>o.finishSendMessageTask(e.local_message_id)),e.forEach(o.addSendMessageTask),(async e=>{let o;return(J(e)?W(q):W(X,q))(e,t)})(e)):(x.k.console.info("local_conversation_id or conversation_id is empty, skip sending message"),Promise.resolve()):(x.k.console.info("local_message_id is empty, skip sending message"),Promise.resolve())};var ee=o(54642);let et=e=>{var t,o,a,n,i,r,l,s,d,u,v,c,p,m;let{messages:_,customSendWaitTimeout:g,isNeedDowngrade:y}=e,f=(null===(t=_[0])||void 0===t?void 0:t.local_conversation_id)||(null===(o=_[0])||void 0===o?void 0:o.conversation_id),h=G._.getInstance(f),I=null!==(m=h.rootSpan)&&void 0!==m?m:h.startSpan("client_send_message"),C=null==I?void 0:I.toCarrier(),x=null===(n=_[0])||void 0===n?void 0:null===(a=n.ext)||void 0===a?void 0:a.useSamanthaChat;if((0,S.dL)({botType:(null===(r=_[0])||void 0===r?void 0:null===(i=r.local)||void 0===i?void 0:i.botType)||"UGC",stage:null===(s=_[0])||void 0===s?void 0:null===(l=s.local)||void 0===l?void 0:l.samanthaChatStage,isNeedDowngrade:y,skill:null===(d=_[0])||void 0===d?void 0:d.skill})||x){(0,z.d)(_,{headers:C});return}if((0,S.Fd)({botType:(null===(v=_[0])||void 0===v?void 0:null===(u=v.local)||void 0===u?void 0:u.botType)||"UGC",stage:null===(p=_[0])||void 0===p?void 0:null===(c=p.local)||void 0===c?void 0:c.samanthaChatStage,isNeedDowngrade:y})){Q(_,{customSendWaitTimeout:g,headers:C}),(0,z.d)(_,{headers:C});return}Q(_,{customSendWaitTimeout:g,headers:C})},eo=function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];let a=ee.messageServiceContainer.service;(null==a?void 0:a._messageServiceIsInitialed)?et(...t):null==a||a.tryInitMessageProtocolService(()=>{et(...t)})};var ea=o(422931),en=o(986091),ei=o(41359),er=o(669384),el=o(631150),es=o(477041),ed=o(118200),eu=o(861431),ev=o(414817),ec=o(811208),ep=o(162902);let em=(e,t)=>({...t.payload,contentType:I.ContentType.Text,isReady:!0,contentObj:{text:(0,ep.UD)(e)},resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,S.YE)(t.payload),reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}),e_=(e,t)=>{var o,a,n,i;let r=null===(o=e.content_obj)||void 0===o?void 0:o.data[0].key;return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Image,isReady:!!r,contentObj:{data:[{key:r}]},local_key:(0,ev.H)(e)?null===(a=e.local)||void 0===a?void 0:a.localKey:void 0,isRegenerate:(0,S.YE)(t.payload),reportParams:{...t.payload.reportParams,...(0,T.D)(t.payload),message_type:(0,T.rH)(I.ContentType.Image),from:(null===(i=t.payload)||void 0===i?void 0:null===(n=i.reportParams)||void 0===n?void 0:n.from)||""}}},eg=(e,t)=>{var o;return{...t.payload,contentType:I.ContentType.Text,isReady:!0,contentObj:{text:null==e?void 0:null===(o=e.content_obj)||void 0===o?void 0:o.text},resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,S.YE)(t.payload),reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}},ey=(e,t)=>{var o,a,n,i,r,l,s;let d=null===(o=e.content_obj)||void 0===o?void 0:o.file_list[0].key;return{...t.payload,resolvedConversationId:t.resolvedConversationId,local_key:(0,ev.H)(e)?null===(a=e.local)||void 0===a?void 0:a.localKey:void 0,localMessageId:t.localMessageId,contentType:I.ContentType.File,isReady:!!d,contentObj:{file_list:[{key:d,file_name:null===(r=e.content_obj)||void 0===r?void 0:null===(i=r.file_list)||void 0===i?void 0:null===(n=i[0])||void 0===n?void 0:n.file_name}]},isRegenerate:(0,S.YE)(t.payload),reportParams:{...t.payload.reportParams,...(0,T.D)(t.payload),message_type:(0,T.rH)(I.ContentType.Image),from:(null===(s=t.payload)||void 0===s?void 0:null===(l=s.reportParams)||void 0===l?void 0:l.from)||""}}},ef=(e,t)=>{var o,a,n,i,r,l,s,d,u;if((0,P.O7X)(e))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Composite,contentObj:{text:(null===(r=e.content_obj.text)||void 0===r?void 0:r.trim())||"",link_model:{url:(null===(l=e.content_obj.link_model)||void 0===l?void 0:l.url)||""}},isRegenerate:(0,S.YE)(t.payload),isReady:!0,extraExt:t.payload.extraExt,reportParams:{message_type:(0,T.rH)(I.ContentType.Composite),...t.payload.reportParams,...(0,T.D)(t.payload)}};if((0,P.tfX)(e))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Composite,contentObj:{text:(null===(s=e.content_obj.text)||void 0===s?void 0:s.trim())||"",website_model:{pages:(null===(d=e.content_obj.website_model)||void 0===d?void 0:d.pages)||[]}},isReady:!0,isRegenerate:(0,S.YE)(t.payload),extraExt:t.payload.extraExt,reportParams:{message_type:(0,T.rH)(I.ContentType.Composite),...t.payload.reportParams,...(0,T.D)(t.payload)}};let v=(0,P.B$e)(e),c=(0,P.icE)(e),p=v?null===(o=e.content_obj.image_model)||void 0===o?void 0:o.image_list:c?null===(a=e.content_obj.file_model)||void 0===a?void 0:a.file_list:void 0;if(!(null==p?void 0:p[0]))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Text,contentObj:{text:(null===(u=e.content_obj.text)||void 0===u?void 0:u.trim())||""},isReady:!0,isRegenerate:(0,S.YE)(t.payload),extraExt:t.payload.extraExt,reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}};let m=p.map(e=>{let{key:t}=e;return t});return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentObj:v?{text:(null===(n=e.content_obj.text)||void 0===n?void 0:n.trim())||"",image_model:{image_list:m.map(e=>({key:e}))}}:c?{text:(null===(i=e.content_obj.text)||void 0===i?void 0:i.trim())||"",file_model:{file_list:p.map((e,t)=>({file_name:(0,ec.G)("file_name")(e),key:m[t]||""}))}}:{},contentType:I.ContentType.Composite,isReady:!0,isRegenerate:(0,S.YE)(t.payload),extraExt:t.payload.extraExt,reportParams:{message_type:(0,T.rH)(I.ContentType.Composite),...t.payload.reportParams,...(0,T.D)(t.payload)}}},eh=(e,t)=>{var o;let a=(0,i.Z)(e.content_obj);return null==a||null===(o=a.entities)||void 0===o||o.forEach(e=>{delete e.file_name_state,delete e.file_parse_state}),{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Nested,contentObj:a,isRegenerate:(0,S.YE)(t.payload),isReady:!0,extraExt:t.payload.extraExt,reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}},eI=(e,t)=>{var o,a,n,r,l,s,d;if((null==e?void 0:e.content_type)===er.zc.SamanthaCodeAssistantInput){let o=(0,i.Z)(e.content_obj);return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Composite,sendAttachments:[...e.attachments||[]],contentObj:o,isRegenerate:(0,S.YE)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,T.rH)(I.ContentType.Composite),...t.payload.reportParams,...(0,T.D)(t.payload)}}}if((null==e?void 0:e.content_type)===I.ContentType.Text)return{...em(e,t),extraExt:{...t.payload.extraExt,useSamanthaChat:"true"}};if((0,P.xop)(e)&&(0,es.Z)((0,ed.Z)(e,["content_obj","link_model","url"])))return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Composite,contentObj:{text:(null===(o=e.content_obj.text)||void 0===o?void 0:o.trim())||"",link_model:{url:(null===(a=e.content_obj.link_model)||void 0===a?void 0:a.url)||"",repo_id:(null===(r=e.content_obj.link_model)||void 0===r?void 0:null===(n=r.extra)||void 0===n?void 0:n.repo_id)||"",repo_name:(null===(s=e.content_obj.link_model)||void 0===s?void 0:null===(l=s.extra)||void 0===l?void 0:l.repo_name)||""}},isRegenerate:(0,S.YE)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,T.rH)(I.ContentType.Composite),...t.payload.reportParams,...(0,T.D)(t.payload)}};if((0,P.mQ9)(e)){let o=(0,i.Z)(e.content_obj);return null==o||null===(d=o.entities)||void 0===d||d.forEach(e=>{delete e.file_name_state,delete e.file_parse_state}),{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Nested,contentObj:o,isRegenerate:(0,S.YE)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}}return{...t.payload,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,contentType:I.ContentType.Nested,contentObj:{},isRegenerate:(0,S.YE)(t.payload),isReady:!0,extraExt:{...t.payload.extraExt,useSamanthaChat:"true"},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}},eC=(e,t)=>(t.payload.extraExt={...t.payload.extraExt,...(0,eu.Z)(null==e?void 0:e.ext,["browser_explain","reference_source","browser_plugin_info","translate","input_content_type","reference_resource"])},{...t.payload,contentType:e.content_type,isReady:!0,contentObj:e.content_obj,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,S.YE)(t.payload),reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}),ex=(e,t)=>({...t.payload,contentType:er.zc.SamanthaMediaUnderstandingByAsrInput,isReady:!0,contentObj:e.content_obj,resolvedConversationId:t.resolvedConversationId,localMessageId:t.localMessageId,isRegenerate:(0,S.YE)(t.payload),reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...t.payload.reportParams,...(0,T.D)(t.payload)}}),eb=(e,t)=>(t.payload.extraExt={source:t.source,...t.payload.extraExt,...(0,eu.Z)(null==e?void 0:e.ext,["msg_template_id","collection_id","input_skill","need_create_thread","reference_content","immersive_reading_files","pdf_hover_position","samantha_context","generate_mind_map","answer_with_suggest"])},(0,P.iMt)(e))?ex(e,t):(0,P.kwD)(e)?eI(e,t):(0,P.X6X)(e)?eg(e,t):(0,P.Brd)(e)?eC(e,t):(0,P.D28)(e)?eh(e,t):(0,P.G7Q)(e)?em(e,t):(0,P.qP0)(e)||(0,P.O72)(e)?e_(e,t):(0,P.xop)(e)?ef(e,t):(0,P.mQ9)(e)?eh(e,t):(0,P.A8i)(e)?ey(e,t):void 0;var eT=o(577518);let eS=()=>(0,eT.Z)(),eE=(e,t)=>{var o;if(!e)return[];let a=null==e?void 0:null===(o=e.ext)||void 0===o?void 0:o.collection_id;if(!a)return[e];let n=A.useMessageStore.getState(),i=n.messageLinkMap[t],r=n.messageMap[t];return i.filter(e=>{var t,o;return(0,P.Yns)(r[e.messageId])&&(null===(o=r[e.messageId])||void 0===o?void 0:null===(t=o.ext)||void 0===t?void 0:t.collection_id)===a}).map(e=>(0,j.K9)(n,t,e)).filter(el.Av)},eP=e=>{var t;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.Text,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim()},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...e.payload.reportParams,...(0,T.D)(e.payload)}}},eM=e=>{var t,o,a;let n=[],i=!!e.payload.image_key;return n.push({key:(null===(t=e.payload)||void 0===t?void 0:t.image_key)||"",image_ori:(null===(o=e.payload)||void 0===o?void 0:o.image_ori)||"",image_thumb:(null===(a=e.payload)||void 0===a?void 0:a.image_thumb)||""}),{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.Image,contentObj:{data:n},isReady:i,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Image),...e.payload.reportParams,...(0,T.D)(e.payload)}}},ek=e=>{let t=[],o=!!e.payload.file_key;return t.push({file_name:e.payload.file_name,key:e.payload.file_key}),{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.File,contentObj:{file_list:t},isReady:o,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.File),...e.payload.reportParams,...(0,T.D)(e.payload)}}},ew=e=>{var t,o,a,n;let i=!0,r=e=>{let t=[];return null==e||e.forEach(e=>{t.push(e),i&&(i=!!e.key)}),t};return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentObj:(0,S.qb)(e.payload)?{text:null===(t=e.payload.compositeContent)||void 0===t?void 0:t.text,image_model:{image_list:r(null===(o=e.payload.compositeContent)||void 0===o?void 0:o.images)}}:(0,S.VT)(e.payload)?{text:e.payload.compositeContent.text,file_model:{file_list:r(e.payload.compositeContent.files)}}:(0,S._z)(e.payload)?{text:e.payload.compositeContent.text,link_model:{url:e.payload.compositeContent.links[0]}}:(0,S.cz)(e.payload)?{text:null===(a=e.payload.compositeContent)||void 0===a?void 0:a.text,website_model:{pages:null===(n=e.payload.compositeContent)||void 0===n?void 0:n.websites}}:{},contentType:I.ContentType.Composite,isReady:i,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Composite),...e.payload.reportParams,...(0,T.D)(e.payload)}}},eR=e=>{let{nestedItems:t,text:o}=e.payload,a=null==t?void 0:t.map(e=>e.type===ei.U3.Image?{entity_type:e.type,entity_content:{image:e.image||{}},identifier:e.identifier,file_parse_state:e.parseState,file_name_state:e.reviewState}:e.fileType===ei.bQ.Audio||e.fileType===ei.bQ.Video?{entity_type:e.type,entity_content:{file:{file_name:e.fileName,key:e.fileKey,size:e.size,file_type:e.fileType,md5:e.md5,image:e.image}},identifier:e.identifier,file_parse_state:e.parseState,file_name_state:e.reviewState}:{entity_type:ei.U3.File,entity_content:{file:{file_name:e.fileName,key:e.fileKey,size:e.size,file_type:e.fileType,md5:e.md5,image:e.image}},identifier:e.identifier,file_parse_state:e.parseState,file_name_state:e.reviewState},[]);return(null==a?void 0:a.length)===0?{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.Text,contentObj:{text:null==o?void 0:o.trim()},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...e.payload.reportParams,...(0,T.D)(e.payload)}}:{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.Nested,contentObj:{text:null==o?void 0:o.trim(),entities:a},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Nested),...e.payload.reportParams,...(0,T.D)(e.payload)}}},ej=e=>{var t,o;if(!(null===(o=e.payload.operation)||void 0===o?void 0:null===(t=o.copySend)||void 0===t?void 0:t.messageLink))return;let{messageLink:a}=e.payload.operation.copySend,n=(0,j.K9)(e.store,e.resolvedConversationId,a);if(n)return eb(n,e)},eA=e=>{var t;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.Text,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim()},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},attachments:e.payload.attachments,reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...e.payload.reportParams,...(0,T.D)(e.payload)}}},eL=e=>{var t;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:I.ContentType.Text,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim(),action:e.payload.action,gen_ppt_input:e.payload.gen_ppt_input,gen_outline_input:e.payload.gen_outline_input},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...e.payload.reportParams,...(0,T.D)(e.payload)}}},eO=e=>{var t,o;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:er.zc.SamanthaSearchEngineInput,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim(),up_template_key:null===(o=e.payload)||void 0===o?void 0:o.up_template_key},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...e.payload.reportParams,...(0,T.D)(e.payload)}}},eD=e=>{var t,o;return{...e.payload,resolvedConversationId:e.resolvedConversationId,localMessageId:e.localMessageId,contentType:er.zc.SamanthaDeepResearchInput,contentObj:{text:null===(t=e.payload.text)||void 0===t?void 0:t.trim(),direct_research:null===(o=e.payload)||void 0===o?void 0:o.direct_research},isReady:!0,isRegenerate:(0,S.YE)(e.payload),extraExt:{...e.payload.extraExt,source:e.source},reportParams:{message_type:(0,T.rH)(I.ContentType.Text),...e.payload.reportParams,...(0,T.D)(e.payload)}}},eN=e=>{if((0,S.Zz)(e))return eL(e);if((0,S.RP)(e))return eD(e);if((0,S.gm)(e))return eO(e);if((0,S.sO)(e))return eR(e);if((0,S.BY)(e))return eP(e);else if((0,S.tn)(e))return eM(e);else if((0,S.L2)(e))return ek(e);else if((0,S.NC)(e))return ew(e);else if((0,S.Eu)(e))return ej(e);else if((0,S.MX)(e))return eA(e)},eU=e=>{var t,o;let a=eN(e);if(a)return[a];let{replace:n,resume:i,remove:r,regenerate:l,resend:s,newChat:d}=e.payload.operation||{},u=null!==(o=null===(t=n||i||r||s||d)||void 0===t?void 0:t.messageLink)&&void 0!==o?o:l?{messageId:l.sentMessageId,isLocalMessage:!1}:void 0,v=(null==d?void 0:d.conversationId)||e.resolvedConversationId,c=u?(0,j.K9)(e.store,v,u):void 0,p=(l?eE(c,v):[c].filter(el.Av)).map(t=>{var o,a,r,u,v,c;let p=(null==t?void 0:null===(o=t.ext)||void 0===o?void 0:o.source)||e.payload.reportParams.scene;e.source=l||n&&"edit"!==e.payload.reportParams.scene||s?p:e.payload.reportParams.scene;let m=eb(t,e);return i&&(null==m?void 0:m.extraExt)&&(m.extraExt.ugc_plugin_auth_infos=null!==(u=null===(r=e.payload.extraExt)||void 0===r?void 0:r.ugc_plugin_auth_infos)&&void 0!==u?u:""),d&&(null==m?void 0:m.extraExt)&&(m.extraExt.need_create_thread=null!==(c=null===(v=e.payload.extraExt)||void 0===v?void 0:v.need_create_thread)&&void 0!==c?c:""),(null==m?void 0:null===(a=m.operation)||void 0===a?void 0:a.replace)&&(null==m?void 0:m.extraExt)&&delete m.extraExt.collection_id,m}).filter(el.Av);if(p.length>1&&p.some(e=>{var t;return!(null===(t=e.extraExt)||void 0===t?void 0:t.collection_id)})){let e=eS();p.forEach(t=>(t.extraExt={...t.extraExt,collection_id:e},t))}if(!(0,en.Z)(p))return p;throw x.k.persist.warning("sendMsgUnsupportedTypeOrScene"),Error("Unsupported MessageType")};var eB=o(944746),eZ=o(380815),eG=o(126473);let ez=e=>{let t=eH(e);return t.used_prompt?e.reportParams.preset_prompt_type?{...t,prompt_type:"default_prompt",default_prompt_type:e.reportParams.preset_prompt_type}:{...t,prompt_type:"customized_prompt"}:{...t}},eH=e=>{var t;let o=!0;return(0,S.gg)(e)&&(null==e?void 0:e.text)===""&&(o=!1),((0,S.VT)(e)||(0,S.qb)(e))&&(null==e?void 0:null===(t=e.compositeContent)||void 0===t?void 0:t.text)===""&&(o=!1),(0,S.$r)(e)&&(o=!1),{used_prompt:+!!o}},eF=e=>{try{var t,o,a,n,i,l,s,d,u,v;if((0,S.Nr)(e)&&((null==e?void 0:null===(t=e.sendAttachments)||void 0===t?void 0:t.length)||0)>0){let t=e.sendAttachments,o=null==t?void 0:t.map(e=>e.key),n=null==t?void 0:t.map(e=>e.name||e.repo_name||""),i=null==t?void 0:t.map(e=>{var t;return(null==e?void 0:null===(t=e.type)||void 0===t?void 0:t.split("_").map(e=>(0,eB.Z)(e)).join(""))||""}),r=null==t?void 0:t.map(e=>e.size||0),l=new Set(i).size>1;return{upload_id:e.preGeneratedLocalMessageId,upload_file_num:null==t?void 0:t.length,upload_file_size:null==r?void 0:r.join(","),is_upload_file:1,is_upload_mix_type:+!!l,upload_file_type:null==i?void 0:i.join(","),collection_id:(null==o?void 0:o.length)===1?o[0]:(0,C.B)(o),collection_name:(null==n?void 0:n.length)===1?n[0]:(0,C.B)(n),upload_collection_way:(null==t?void 0:t.length)===0?void 0:(null==t?void 0:t.length)===1?"single":"multi",upload_from:null===(a=e.reportParams)||void 0===a?void 0:a.upload_from}}if((0,S.gg)(e)&&((null==e?void 0:null===(o=e.nestedItems)||void 0===o?void 0:o.length)||0)>=0){let t=e.nestedItems,o=null==t?void 0:t.map(e=>e.fileKey),a=null==t?void 0:t.map(e=>e.fileName||""),i=null==t?void 0:t.map(e=>(0,eG.JB)((0,eG.lm)(e.fileName))),r=null==t?void 0:t.map(e=>e.size||0),l=new Set(i).size>1;return{upload_id:e.preGeneratedLocalMessageId,upload_file_num:null==t?void 0:t.length,upload_file_size:null==r?void 0:r.join(","),is_upload_file:1,is_upload_mix_type:+!!l,upload_file_type:null==i?void 0:i.join(","),collection_id:(null==o?void 0:o.length)===1?o[0]:(0,C.B)(o),collection_name:(null==a?void 0:a.length)===1?a[0]:(0,C.B)(a),upload_collection_way:(null==t?void 0:t.length)===0?void 0:(null==t?void 0:t.length)===1?"single":"multi",upload_from:null===(n=e.reportParams)||void 0===n?void 0:n.upload_from}}if((0,S.VT)(e)||(0,S.qb)(e)){let t=(0,S.VT)(e)?e.compositeContent.files:null===(i=e.compositeContent)||void 0===i?void 0:i.images,o=(null==t?void 0:t.map(e=>"blob"in e&&e.blob?(0,ec.G)("name")(e.blob):"file_name"in e?e.file_name:void 0).filter(el.Av)[0])||"",a=(null==t?void 0:t.map(e=>{if("key"in e)return e.key}).filter(el.Av)[0])||"";return{is_upload_file:1,upload_id:e.preGeneratedLocalMessageId,upload_file_num:1,upload_file_size:"0",is_upload_mix_type:0,upload_file_type:(0,eG.JB)((0,eG.lm)(o)),collection_id:a,upload_collection_way:"single",upload_from:null===(l=e.reportParams)||void 0===l?void 0:l.upload_from}}if((0,S._z)(e)){let{links:t}=e.compositeContent,o=1===t.length?t[0]:(0,C.B)(t);return{is_upload_file:1,upload_file_num:null==t?void 0:t.length,upload_file_size:"0",upload_file_type:r.ol.UPLOAD_FILE_TYPE_LINK,collection_id:o,collection_name:o,upload_collection_way:(null==t?void 0:t.length)===0?void 0:1===t.length?"single":"multi",upload_from:null===(s=e.reportParams)||void 0===s?void 0:s.upload_from}}if((0,S.$r)(e)){if("image"in e&&e.image)return{is_upload_file:1,upload_id:e.preGeneratedLocalMessageId,upload_file_num:1,upload_file_size:String(e.image.size),is_upload_mix_type:0,upload_file_type:(0,eG.JB)((0,eG.lm)((0,ec.G)("name")(e.image))),collection_id:e.local_key,upload_collection_way:"single",upload_from:null===(d=e.reportParams)||void 0===d?void 0:d.upload_from};if("image_key"in e&&e.image_key)return{is_upload_file:1,upload_id:e.preGeneratedLocalMessageId,upload_file_num:1,upload_file_size:"0",is_upload_mix_type:0,upload_file_type:r.ol.UPLOAD_FILE_TYPE_IMAGE,collection_id:e.image_key,upload_collection_way:"single",upload_from:null===(u=e.reportParams)||void 0===u?void 0:u.upload_from};return{is_upload_file:0}}if((0,S.Nn)(e))return{is_upload_file:null!==(v=e.reportParams.is_upload_file)&&void 0!==v?v:0};return{is_upload_file:0}}catch(e){return{}}},e$=e=>{var t,o;let a=null===(t=e.extraExt)||void 0===t?void 0:t.reference_content;if(!a)return{is_quote:null!==(o=e.reportParams.is_quote)&&void 0!==o?o:0,quote_type:e.reportParams.quote_type};let n=(0,C.R)(a,[])[0];return n?{is_quote:1,quote_type:(0,eZ.DG)(n)?"text":(0,eZ.xR)(n)?"file":((0,eZ.sV)(n),"url")}:{is_quote:0,quote_type:void 0}},eY={onboarding_first_met:"onboarding_first_met_sug",onboarding_welcome_back:"onboarding_welcome_back_sug"},eK=e=>{let t=A.useMessageStore.getState();return(0,ea.Z)(e.map(e=>{e.reportParams={...e.reportParams,...eF(e),...e$(e),...ez(e)};let{preGeneratedLocalMessageId:o=""}=e,a=(0,T.XG)(e),n=eY[e.reportParams.scene]||e.reportParams.scene,{botId:i=""}=e;return eU({payload:e,resolvedConversationId:a,store:t,localMessageId:o,botId:i,source:n})}))},eV=e=>{var t,o;let{replace:a,remove:n,regenerate:i,resume:r}=e.operation||{};return{is_delta:!1,local_conversation_id:e.localConversationId,bot_id:e.botId,conversation_id:e.conversationId,section_id:e.sectionId,local_message_id:e.localMessageId,message_type:I.MessageType.Message,content_type:e.contentType,content_obj:e.contentObj,create_time:Date.now(),...a||n||r?{message_id:null===(o=a||n||r)||void 0===o?void 0:null===(t=o.messageLink)||void 0===t?void 0:t.messageId}:{},...i?{reply_id:i.sentMessageId,local_message_id:i.sentLocalMessageId}:{},...e.contentType===I.ContentType.Text?{content_source:e.reportParams.content_source||l.iz.Other,template_id:e.reportParams.content_source_template_id}:{},ext:e.extraExt,status:e.messageStatus}};var eX=o(249138),eq=o(586811),eW=o(297562);let eJ=e=>{var t,o,n,i,r,s,d,u,v,c,p,m,g,f,h,C,x;let{payload:b,store:S}=e,{regenerate:E}=b.operation||{},M=[],k=[...(0,eX.Id)(b.extraExt)],w={conversation_type:null!==(m=(0,y.QW)(_.useFeedStore.getState(),b.resolvedConversationId||"",!0))&&void 0!==m?m:b.conversationType,...eV(b),...(0,eq.PD)(b.extraExt),status:b.messageStatus,content_obj:b.contentObj,user_type:I.UserType.Human,attachments:M,references:k};return"sendAttachments"in b&&(null===(t=b.sendAttachments)||void 0===t?void 0:t.length)&&M.push(...b.sendAttachments),(null===(o=b.contentObj)||void 0===o?void 0:o.file_model)&&M.push(...(0,eX.ay)(null===(g=b.contentObj)||void 0===g?void 0:g.file_model)),(null===(n=b.contentObj)||void 0===n?void 0:n.link_model)&&M.push((0,eX.kl)(b.contentObj.link_model)),(null===(i=b.contentObj)||void 0===i?void 0:i.image_model)&&M.push(...(0,eX.df)(null===(f=b.contentObj.image_model)||void 0===f?void 0:f.image_list)),(null===(r=b.contentObj)||void 0===r?void 0:r.entities)&&M.push(...(0,eX.H0)(b.contentObj.entities,b.nestedItems)),(0,P.s0W)(w)&&M.push(...(0,eX.df)(null===(h=b.contentObj)||void 0===h?void 0:h.data)),(0,P.NB8)(w)&&M.push(...(0,eX.LX)(b.extraExt)),(0,P.Xz4)(w)&&M.push(...(0,eX.ay)(b.contentObj)),(0,P.EkH)(w)&&M.push(...(null==b?void 0:b.attachments)||[]),((0,P.G7Q)(w)||(0,P.qP0)(w))&&(0,a.Z)(w,{content_obj:{...w.content_obj,...(0,eq.tt)(w.ext),...(0,eq.gv)(w.ext),...(0,eq.Bk)(w.ext),...(0,eq.n)(w.ext),...(0,eq.v7)(w.ext),...(0,eq.op)(w.ext)}}),(null===(s=w.content_obj)||void 0===s?void 0:s.image_list)&&((0,a.Z)(w.content_obj,{data:w.content_obj.image_list}),null===(C=w.content_obj)||void 0===C||delete C.image_list),(null===(d=w.ext)||void 0===d?void 0:d.generate_mind_map)&&(0,a.Z)(w.content_obj,(0,eq.gI)(w.ext)),(null==w?void 0:null===(u=w.ext)||void 0===u?void 0:u.immersive_reading_files)&&(0,a.Z)(w.content_obj,(0,eq.cG)(w.ext)),(null==w?void 0:null===(v=w.ext)||void 0===v?void 0:v.need_reference)&&(0,a.Z)(w.content_obj,(0,eq.yj)(w.ext)),(null==w?void 0:null===(c=w.ext)||void 0===c?void 0:c.command)&&(0,a.Z)(w.content_obj,{command:w.ext.command}),(0,P.X6X)(w)&&(0,a.Z)(w,{content_type:er.zc.SamanthaWriteInput}),(null===(p=b.extraExt)||void 0===p?void 0:p.artifact_key)&&(0,a.Z)(w.content_obj,{artifact_key:null===(x=b.extraExt)||void 0===x?void 0:x.artifact_key}),(0,eW.W)({localMessageStatus:b.isReady?E?l.JR.SendingRegenerate:l.JR.Sending:l.JR.Preprocessing,message:w,failedExpired:(0,T.MF)(b.isReady,b.contentType),messageLinks:S.messageLinkMap[b.resolvedConversationId],isRegenerate:b.isRegenerate,prevMessageId:b.isRegenerate?null==E?void 0:E.regenerateTailMessageId:void 0,localKey:"local_key"in b?b.local_key:"",enterFrom:b.reportParams.enter_from,isReady:b.isReady,botType:b.botType,samanthaChatStage:b.reportParams.samantha_protocol_stage,isNova:b.reportParams.is_nova})};var eQ=o(623666),e0=o(844108),e1=o(298113),e6=o(969537),e2=o(257149);let e4=async function(e){let{beforeSendMessage:t,customSendWaitTimeout:o,lifeCycleContext:s}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,u.C)({slardar:{chat_session_scene:"chat_conversation"}});let v=A.useMessageStore.getState();try{var c,M,k,R,O,D,G,z,H,F,$,Y,K,V,X,q,W,J,Q,et,ea,en,ei,er,el,es,ed,eu,ev,ec,ep,em,e_,eg,ey,ef,eh,eI,eC,ex,eb;let u;for(let t of(e.forEach(e=>{var t;let{operation:o={},preGeneratedLocalMessageId:n}=e;!n&&(0,a.Z)(e,{preGeneratedLocalMessageId:(null==o?void 0:null===(t=o.regenerate)||void 0===t?void 0:t.sentLocalMessageId)||(0,b.z)()})}),e=await (0,e6.Ch)(e[0].localConversationId||e[0].conversationId||"","",e))){let{botId:e,conversationId:o=""}=t;(0,a.Z)(t,{sectionId:_.useFeedStore.getState().lastSectionIdMap[o]||"",botId:e||(0,g.SR)(o)||""})}let eT=eK(e);for(let e of eT){let t=(0,C.R)((null==e?void 0:null===(c=e.extraExt)||void 0===c?void 0:c.ext_skill_ab)||(null==e?void 0:null===(M=e.extraExt)||void 0===M?void 0:M.input_skill),{}),o=(null==t?void 0:t.skill_type)||0,n=(0,T.sb)(o),i=n===f.Bo.Release;(0,a.Z)(e,{reportParams:{...e.reportParams,samantha_protocol_stage:n,is_nova:i}})}let eS=eT[0].resolvedConversationId||"",eE=eT[0].localMessageId||"";eT=await (0,e6.uH)(eS,"",eT),await (0,e0.D)(A.useMessageStore,eS);let eP=e1.t.getSessionIdBySentMessageId(eS,eE);if(await (0,e6.bu)(eS,eP,{is_delta:!1}),s){let e=e1.t.getSessionLifeCycleContext(eS,eP);for(let[t,o]of(0,n.Z)(s))e.set(t,o)}for(let e of eT){let{operation:t}=e;if(null==t?void 0:null===(R=t.resend)||void 0===R?void 0:null===(k=R.messageLink)||void 0===k?void 0:k.messageId){v.logicalDeleteMessage({conversationId:eS,messageLink:null===(Y=t.resend)||void 0===Y?void 0:Y.messageLink,deleteReply:!0});continue}if(null==t?void 0:null===(D=t.replace)||void 0===D?void 0:null===(O=D.messageLink)||void 0===O?void 0:O.messageId){v.logicalDeleteMessage({conversationId:eS,messageLink:null===(K=t.replace)||void 0===K?void 0:K.messageLink,deleteReply:!0});let e=(0,j.K9)(v,eS,{isLocalMessage:!1,messageId:null===(X=t.replace)||void 0===X?void 0:null===(V=X.messageLink)||void 0===V?void 0:V.messageId});await (0,e2.X1)({replyId:null===(W=t.replace)||void 0===W?void 0:null===(q=W.messageLink)||void 0===q?void 0:q.messageId,localMessageId:null==e?void 0:e.local_message_id});continue}if(null==t?void 0:null===(z=t.resume)||void 0===z?void 0:null===(G=z.messageLink)||void 0===G?void 0:G.messageId){let e=(0,j.K9)(v,eS,{isLocalMessage:!1,messageId:null===(Q=t.resume)||void 0===Q?void 0:null===(J=Q.messageLink)||void 0===J?void 0:J.messageId});v.logicalDeleteMessage({conversationId:eS,messageLink:null===(et=t.resume)||void 0===et?void 0:et.messageLink,deleteReply:!0}),await (0,e2.X1)({replyId:null===(en=t.resume)||void 0===en?void 0:null===(ea=en.messageLink)||void 0===ea?void 0:ea.messageId,localMessageId:null==e?void 0:e.local_message_id});continue}if(null==t?void 0:null===(F=t.remove)||void 0===F?void 0:null===(H=F.messageLink)||void 0===H?void 0:H.messageId){let e=(0,j.K9)(v,eS,{isLocalMessage:!1,messageId:null===(er=t.remove)||void 0===er?void 0:null===(ei=er.messageLink)||void 0===ei?void 0:ei.messageId});v.logicalDeleteMessage({conversationId:eS,messageLink:null===(el=t.remove)||void 0===el?void 0:el.messageLink,deleteReply:!0}),v.updateMessageList({conversationId:eS,immerUpdate:(e,o)=>{var a,n,i,r;(null===(n=t.remove)||void 0===n?void 0:null===(a=n.messageLink)||void 0===a?void 0:a.messageId)&&o.resetMessageLink(null===(r=t.remove)||void 0===r?void 0:null===(i=r.messageLink)||void 0===i?void 0:i.messageId)}}),await (0,e2.X1)({replyId:null===(ed=t.remove)||void 0===ed?void 0:null===(es=ed.messageLink)||void 0===es?void 0:es.messageId,localMessageId:null==e?void 0:e.local_message_id});continue}if(null==t?void 0:null===($=t.regenerate)||void 0===$?void 0:$.sentMessageId){let e=(0,j.K9)(v,eS,{isLocalMessage:!1,messageId:null===(eu=t.regenerate)||void 0===eu?void 0:eu.sentMessageId});await (0,e2.X1)({replyId:null===(ev=t.regenerate)||void 0===ev?void 0:ev.sentMessageId,localMessageId:null==e?void 0:e.local_message_id})}}eT.map(e=>{e.extraExt=(0,T.aF)(e,v)}),eT.some(e=>e.isRegenerate)||function(e){let{conversationId:t,store:o}=e,{lastAvailableMessage:a}=Z(t);(0,E.bf)(a)&&o.updateMessageList({conversationId:t,immerUpdate(e){let{draftMessageLinks:t,draftRegenerateMessageMap:o,draftMessageMap:n,draftLocalMessageMap:i}=e,r=(0,L.Wi)({localMessageMap:i,messageMap:n});t.forEach(t=>{let n=r(t);if((null==n?void 0:n.reply_id)===(null==a?void 0:a.reply_id)){var i;(null===(i=o.messageMap)||void 0===i?void 0:i[t.messageId])&&delete o.messageMap[t.messageId],n&&(0,P.FFC)(n)&&t.isLocalMessage&&(0,w.Tt)(e,t)}})}})}({store:v,conversationId:eS}),v.clearSuggestMessage(eS);let eM=eT.map(e=>{var t;let o=eJ({payload:e,store:v});return(null===(t=e.operation)||void 0===t?void 0:t.remove)||N(v,o,e),(0,i.Z)(o)});for(let e of eM){let t=e.local_conversation_id||e.conversation_id||"",o=e1.t.getSessionIdBySentMessageId(t,e.local_message_id||""),a=e1.t.getSessionLifeCycleContext(t,o,""),n=ee.messageServiceContainer.get("chatBotService"),i=ee.messageServiceContainer.get("chatViewService"),s=ee.messageServiceContainer.get("chatConfigService"),{loginSource:u}=(null==s?void 0:s.chatReportParams)||{},{conversation:v}=(0,y.Bu)(_.useFeedStore.getState(),t,e.bot_id);a.set("chatTeaTraceEvent",new p({commonTraceParams:{chat_scene:eT[0].reportParams.scene,chat_sec_scene:eT[0].reportParams.scene===r.b3.SCENE_RESEND?r.oh.SEC_SCENE_RESEND:eT[0].reportParams.sec_scene,chat_type:(0,g.yT)("",t,(0,g.lC)(t).botInfo),canvas_type:null==i?void 0:null===(ec=i.getCanvasTeaParams())||void 0===ec?void 0:ec.canvas_type,canvas_sub_type:null==i?void 0:null===(ep=i.getCanvasTeaParams())||void 0===ep?void 0:ep.canvas_sub_type},teaEventTraceParams:{receive_suggests:{},receive_think_reason:{},receive_batch_message:{},send_message:{send_message_type:eT[0].reportParams.message_type,...(null==v?void 0:null===(em=v.thread_source)||void 0===em?void 0:em.source_type)===h.ThreadSourceType.MeetingMinutes?{canvas_id:null==v?void 0:null===(e_=v.thread_source.meeting_minutes)||void 0===e_?void 0:e_.identifier}:{},is_quote:+(null!==(ex=eT[0].reportParams.is_quote)&&void 0!==ex?!!ex:(Number(null===(eg=(0,C.R)(null===(ey=e.ext)||void 0===ey?void 0:ey.reference_content,{}))||void 0===eg?void 0:eg.length)||0)>0),...eT[0].reportParams.content_type===I.ContentType.Text?{original_content_source:eT[0].reportParams.content_source||l.iz.Other}:{},...u?{previous_page:u}:{},...(null===(ef=eT[0].reportParams)||void 0===ef?void 0:ef.enter_from)==="bot_discover"?{user_id:null==s?void 0:s.userId,req_id:eT[0].reportParams.bot_id?null==n?void 0:null===(eh=n.getBotIdToRequestIdMap())||void 0===eh?void 0:eh[eT[0].reportParams.bot_id]:"",recommend_from:r.RA.RECOMMEND_FROM_BOT_LIST_DISCOVER}:{},...location.pathname.includes("/chat/new-thread")||location.pathname.includes("/chat/local_")?{current_page:r.au.CURRENT_PAGE_CHAT}:{}}},teaEventOtherTraceParams:{...eT[0].reportParams,...null==i?void 0:i.getCanvasTeaParams()}})),a.set("chatEventContext",new m.v({params:{slardar:{chat_session_scene:"chat_conversation",chat_session_id:o,chat_scene:d(null===(eC=eT[0])||void 0===eC?void 0:null===(eI=eC.reportParams)||void 0===eI?void 0:eI.send_source)}}}))}null==t||t(eM);let ek=[];try{for(let e of eM){u=e;let t=e.local_conversation_id||e.conversation_id||"",o=e1.t.getSessionIdBySentMessageId(t,e.local_message_id||""),a=await (0,e6.pe)(t,o,e);ek.push(a)}}catch(e){if(x.k.console.info({message:"send message failed",error:e}),eT.forEach(e=>U(v,e)),u){let t=(0,i.Z)(u);t.final_status={message:null===(eb=t.final_status)||void 0===eb?void 0:eb.message,session:(0,eQ.RB)(e)},(0,e6.uM)(eS,eP,t)}return}ek.length||ek.push(...eM),ek.forEach((e,t)=>{var o;(null===(o=eT[t].operation)||void 0===o?void 0:o.remove)||B(v,e,eT[t])});let ew=(0,S.Pf)(null==ek?void 0:ek[0]);for(let e of(eo({messages:ek,customSendWaitTimeout:o,isNeedDowngrade:ew}),eM)){let t=e.local_conversation_id||e.conversation_id||"",o=e1.t.getSessionIdBySentMessageId(t,e.local_message_id||"");await (0,e6.zo)(t,o,e)}}catch(e){throw(0,e6.vw)("","",{is_delta:!1,final_status:{message:"Error",session:(0,eQ.RB)(e)}}),e}}},515646:function(e,t,o){o.d(t,{D:function(){return h},MF:function(){return x},XG:function(){return T},aF:function(){return b},rH:function(){return f},sb:function(){return C}});var a,n=o(228535),i=o(148824),r=o(589944),l=o(886421),s=o(67939),d=o(666396),u=o(455746),v=o(636674),c=o(771056),p=o(371924),m=o(744947),_=o(436462),g=o(54642);let y=((a={}).Text="text",a.Picture="pic",a.File="file",a),f=e=>{let t={[u.ContentType.Text]:y.Text,[u.ContentType.Image]:y.Picture,[u.ContentType.File]:y.File};return e&&t[e]||y.Text},h=e=>{var t;let o=e.botId||(0,l.SR)(e.conversationId)||"",a=g.messageServiceContainer.get("chatBotService"),n=null==a?void 0:a.getBot(o),i=null!==(t=e.reportParams.conversation_type)&&void 0!==t?t:(0,s.n)(e.conversationId);return{bot_id:o,chat_type:(0,l.yT)("",e.conversationId,n,i),conversation_type:i}},I=[v.SkillType.AcademicSearch],C=e=>{let t=g.messageServiceContainer.get("chatConfigService",!0),o=(null==t?void 0:t.appId)&&[p.XI,p.Qg,p.NI].includes(null==t?void 0:t.appId),a=!!~I.findIndex(t=>t===e);return o?a?void 0:c.Bo.Release:void 0},x=(e,t)=>{if(e){let{sendMessageStartTimeout:e=d.OY}=(0,r.$)("chatMessageConfig")||{};return Date.now()+e}if(t!==u.ContentType.File)return Date.now()+d.e1},b=(e,t)=>{let{resolvedConversationId:o,extraExt:a,reportParams:{scene:r}}=e,{replace:l,remove:s,regenerate:d,resume:u}=e.operation||{},v=function(e){var t;let{conversationId:o,store:a}=e,r=(0,m.M_)(a,o);if(!r||(0,n.qP0)(r)||(0,n.dqg)(r))return;let l=(0,_.vn)(a.messageLinkMap[o],e=>{let t=(0,m.K9)(a,o,e);return(0,i.Z_)(t)&&(0,i.bf)(t)});if(l&&!(null==l?void 0:l.isLocalMessage)&&(null===(t=(0,m.K9)(a,o,l))||void 0===t?void 0:t.reply_id)===r.reply_id)return l.messageId}({store:t,conversationId:o});return{stream:"1",answer_with_suggest:"1",wiki:"2",media_search_type:"1",...l?{replace:"1"}:{},...s?{delete:"1"}:{},...d?{regen:"1"}:{},...u?{resume:"1"}:{},...l||u||s||d||!v?{}:{lastRegenerateSelectedMessageId:v},..."onboarding_suggestion"===r?{onboarding_v2:"1"}:{},..."keyboard_unlog"===r?{scene:r}:{},...a}},T=e=>{let t=e.localConversationId||e.conversationId;if(!t)throw Error("conversationId is empty");return t}},54642:function(e,t,o){o.r(t),o.d(t,{messageServiceContainer:function(){return L},createChatMessageService:function(){return O},ChatMessageService:function(){return A}});var a=o(713273),n=o(144245),i=o(93708),r=o(15348),l=o(729813),s=o(28659),d=o(644367),u=o(508830),v=o(529537),c=o(302282),p=o(915234),m=o(154760),_=o(754068),g=o(708481),y=o(640981),f=o(530836),h=o(298113),I=o(969537),C=o(112847);let x={process(e){let{data:t}=e;if(t.event_type===C.t.Cmd){var o;return{cmd:null===(o=t.cmd)||void 0===o?void 0:o.cmd_type,data:{version:"1.0",data:t.cmd}}}if(t.cmd)return{cmd:t.cmd,data:{version:"2.0",data:t.downlink_body}}}};var b=o(126628);let T={handle:e=>{e.cmd&&e.data&&(0,b.Me)().then(t=>{let o=t.filter(t=>{var o;return null===(o=t.matchPlugin)||void 0===o?void 0:o.call(t,e)}).map(e=>e.pluginIdentifier);if(d.k.console.info({message:`Received Cmd: ${e.cmd}`}),!o.length){d.k.console.info({message:`Skip Cmd: ${e.cmd}`});return}(0,g.$h)(o).then(t=>{t.forEach(t=>{var o;return null==t?void 0:null===(o=t.handleCmd)||void 0===o?void 0:o.call(t,e)})})})}};var S=o(166766);async function E(e){let{getCommonSocketParams:t,reportEvent:o,config:a,featureConfig:n,refreshSocketConfig:l}=e;try{var s,d;let e=await (0,g.cf)("AliceChatSocket"),v=await (0,r.D)("chatSocketService");if(null==v||v.init({config:a,options:{consoleSocketPacket:null==n?void 0:n.consoleSocketPacket,refreshSocketConfig:l,getSocketParams:t}}),v){let e=await (0,r.D)("chatCommandService");null==e||e.registerSocketClient(v),null==e||e.registerCommandProcessor(x),null==e||e.registerCommandHandler(T)}let y=()=>{null==v||v.off("open",C)},f=setTimeout(()=>{null==o||o.error({reason:"ws_failed"}),y()},5e3),C=()=>{null==o||o.addDurationPoint("ws"),null==o||o.addDurationPoint("success"),null==o||o.success(),y(),clearTimeout(f)};null==e||e.init();let b=await (0,i.TB)("samanthaChatProtocolStore"),S=(0,_.U)((0,u.Z)(b.getState().samanthaChatTaskMap));S.length&&(S.forEach(e=>{var t,o;let a=(null===(o=e.messages)||void 0===o?void 0:null===(t=o[0])||void 0===t?void 0:t.conversation_id)||"",n=e.localMessageId;(0,I.UQ)(a,n)}),null===(s=await (0,g.cf)("SamanthaChat"))||void 0===s||s.resumeTask(S));let E=await (0,i.TB)("aliceChatProtocolStore");E.setState({aliceChatStreamInitConfig:{poolSize:3,retryAttempt:5,binaryType:null==n?void 0:n.binaryType},aliceChatFallbackInitConfig:a});let P=(0,_.U)((0,u.Z)(E.getState().aliceChatStreamTaskMap));P.length&&(P.forEach(e=>{let t=e.conversationId||"",o=e.replyId,a=h.t.getSessionIdBySentMessageId(t,o);h.t.getSessionLifeCycleContext(t,a,"").set("chatEventContext",new p.v({params:{slardar:{chat_session_scene:"resume_task",chat_session_id:a,chat_scene:m.V.DEFAULT}}})),(0,c.C)({slardar:{chat_session_scene:"resume_task",chat_session_id:a}}),(0,I.MV)(t,a,{is_delta:!1})}),null===(d=await (0,g.cf)("AliceChatStream"))||void 0===d||d.resumeTask(P)),null==v||v.on("open",C)}catch(e){throw(0,y.J)(),e}}let P=async()=>{try{var e,t,o,a;let n=await (await (0,S.p)()).rateLimit();f.useMessageStore.getState().updateRateLimitConfig({limitExpired:(null===(e=n.data)||void 0===e?void 0:e.limit_time)?Date.now()+(null===(t=n.data)||void 0===t?void 0:t.limit_time)*1e3:void 0,limitTips:(null===(o=n.data)||void 0===o?void 0:o.limit_tips)||"",isLimited:!!(null===(a=n.data)||void 0===a?void 0:a.is_limit)})}catch(e){e instanceof Error&&d.k.persist.error({message:"get rate limit failed",error:e})}},M=(0,v.Z)(E);var k=o(341662),w=o(72856);function R(e,t,o){var a;return(t="symbol"==typeof(a=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?a:a+"")in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}let j=(e,t)=>(0,a.Z)(e,e=>e.namespace===t);class A{_clearSendMessageCallbacks(){let{_sendMessageCallbacks:e}=this;this._sendMessageCallbacks=[],e.forEach(e=>e())}getMessageActionPlugins(){var e,t;return null!==(t=null===(e=this._messageActionPlugins)||void 0===e?void 0:e.map(e=>e.Plugin))&&void 0!==t?t:[]}async getAsyncMessageActionPlugins(){var e,t;return(null!==(t=await (null===(e=this._getAsyncMessageActionPlugins)||void 0===e?void 0:e.call(this)))&&void 0!==t?t:[]).map(e=>e.Plugin)}resetStore(){try{f.useMessageStore.setState(k.Xm),(0,i.TB)("samanthaChatProtocolStore").then(e=>{e.setState({samanthaChatTaskMap:{}})}),(0,i.TB)("aliceChatProtocolStore").then(e=>{e.setState({aliceChatStreamTaskMap:{}})})}catch(e){d.k.console.info("reset message service store failed")}}async tryInitMessageProtocolService(e){var t;return(e&&this._sendMessageCallbacks.push(e),null===(t=this._initMessageProtocolServiceConfig)||void 0===t?void 0:t.config)?(this._messageServiceIsInitialed||(await M(this._initMessageProtocolServiceConfig),this._messageServiceIsInitialed=!0,await P()),this._clearSendMessageCallbacks(),Promise.resolve({isInitialed:!0})):Promise.resolve({isInitialed:!1})}updateInitMessageProtocolServiceConfig(e){this._initMessageProtocolServiceConfig=e}handleAppInitialed(){this._appIsInitialed=!0,this.tryInitMessageProtocolService()}initEventBinding(){l.v.on("chat.service.resetAll",this.resetStore.bind(this)),s.l.on("app.init",this.handleAppInitialed.bind(this))}async sendMessage(e,t){let o=await (0,r.D)("chatMessageService");return(null==o?void 0:o.deprecatedSendMessage)?o.deprecatedSendMessage(e,t):(0,w.O)(e,t)}destroy(){l.v.off("chat.service.resetAll",this.resetStore),s.l.off("app.init",this.handleAppInitialed)}constructor(e){R(this,"ctx",void 0),R(this,"_appIsInitialed",!1),R(this,"_messageActionPlugins",void 0),R(this,"_initMessageProtocolServiceConfig",void 0),R(this,"_messageActionPluginInstances",void 0),R(this,"_messageServiceIsInitialed",!1),R(this,"_sendMessageCallbacks",[]),R(this,"_getAsyncMessageActionPlugins",void 0);let{plugins:t=[],messageProtocolServiceOptions:o}=e;this._initMessageProtocolServiceConfig=o,this._messageActionPlugins=j(t,"message-action"),this._getAsyncMessageActionPlugins=e.getAsyncMessageActionPlugins,this.initEventBinding(),this._appIsInitialed=!1,this._messageServiceIsInitialed=!1}}let L=(0,n.B)(),O=e=>(L.service||(L.service=new A(e)),L.service)},162902:function(e,t,o){o.d(t,{A1:function(){return s},Sh:function(){return v},UD:function(){return u},jp:function(){return c}});var a=o(477041),n=o(986091),i=o(742470),r=o(228535),l=o(910157);let s=e=>{if((0,r.G7Q)(e)||(0,r.lpb)(e)||(0,r.EkH)(e)){var t;return(0,r.fjb)(e)?d(e):null==e?void 0:null===(t=e.content_obj)||void 0===t?void 0:t.text}},d=e=>{var t,o,a,n,s;if(!e||!(0,r.fjb)(e))return;let d="";return Array.isArray(e.content_obj)?e.content_obj.filter(e=>(null==e?void 0:e.block_type)===i.zc.BLOCK_TEXT).forEach(e=>{let t=(0,l.R)(e.content,{});t.text&&(d+=`${t.text}
`)}):Array.isArray((null==e?void 0:null===(t=e.content_blocks_tree)||void 0===t?void 0:t.children)||{})&&(null==e||null===(s=e.content_blocks_tree)||void 0===s||null===(n=s.children)||void 0===n||null===(a=n.filter(e=>(null==e?void 0:e.block_type)===i.zc.BLOCK_TEXT))||void 0===a||a.forEach(e=>{let t=(null==e?void 0:e.content_obj)||{};(null==t?void 0:t.text)&&(d+=`${t.text}
`)})),d||(null==e?void 0:null===(o=e.content_obj)||void 0===o?void 0:o.text)},u=(e,t,o)=>{if(!e)return;let i=s(e);if((0,a.Z)(i))return i;if(!((0,r.FFC)(e)||(0,r.XD1)(e)))return t?(0,n.Z)(null==e?void 0:e.content_obj)?`${o} message.content\u{FF1A}${null==e?void 0:e.content}`:`${o} message.content\u{FF1A}

\`\`\`json
${JSON.stringify(null==e?void 0:e.content_obj,void 0,2)}
\`\`\`

`:o},v=e=>{var t;return(0,r.d8)(e)&&(null==e?void 0:null===(t=e.content_obj)||void 0===t?void 0:t.text)||""},c=e=>(0,r.q8s)(e)?"simple_search":(0,r.lcM)(e)?"deep_search":(0,r.RxW)(e)?"complex_search":"ai_search"},640981:function(e,t,o){o.d(t,{J:function(){return i}});var a=o(854356),n=o(708481);async function i(){let e=await (0,n.cf)("AliceChatStream"),t=await (0,n.cf)("AliceChatFallback"),o=await (0,n.cf)("SamanthaChat");(0,a.US)([e,t,o])}}}]);