"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["59798"],{462310:function(e,t,a){a.d(t,{useBotSupportLanguages:function(){return v},useLoadConversationMessage:function(){return h}});var n=a(713738),r=a(956801),o=a(83990),i=a(628338),s=a(230932),l=a(910214),d=a(198660),c=a(910321),u=a(856392);let h=()=>{let{canReport:e}=r.useTracingStore.getState(),t=(0,n.useRef)(null!=e&&e);return{initLoadMessageInChatPage:async(e,a)=>{let{reportFirstView:n=!1}=a||{};if(!e)return;s.useFeedStore.getState().updateChatCreateInFirstTime({conversationId:e,status:!1});let l=(0,d.getIsLoggedIn)(),h=o.useMessageStore.getState().initMessageList({conversationId:e,messageIndex:Number.MAX_SAFE_INTEGER,isGuest:!l,hasPreprocessTask:i.hasPreprocessTask});if(n&&t.current){var v,g;t.current=!1;let{chatLayoutCreateTime:a=0,chatLaunchSuccessTime:n=0,flowWebScriptJsFinish:i=0,enterPid:s}=r.useTracingStore.getState(),l=null===(g=o.useMessageStore.getState().messageLinkMap)||void 0===g?void 0:null===(v=g[e])||void 0===v?void 0:v.length,d=(0,u.createReportEvent)({eventName:"init_chat_app_first_conversation",meta:{chat_cached:l?"1":"0",enter_pid:s,"page_time.origin":-a,"page_time.dom_interactive":i-a,"page_time.launch_success":n-a,"page_time.start":(0,c.safelyGetNow)()-a}});r.useTracingStore.setState({chatCached:!!l}),await h.then(e=>{(null==e?void 0:e.length)?(d.addDurationPoint("success"),d.success({meta:{"page_time.success":(0,c.safelyGetNow)()-a}}),r.useTracingStore.getState().addDurationPoint("load_chat_finish")):(d.error({reason:"init_msg_list_empty"}),r.useTracingStore.getState().error("init_msg_list_empty"))},e=>{throw d.error({error:e,reason:"init_msg_inner_error"}),r.useTracingStore.getState().error("init_msg_inner_empty",e),e})}else n?await h.then(e=>{(null==e?void 0:e.length)?r.useTracingStore.getState().addDurationPoint("load_chat_finish"):r.useTracingStore.getState().error("init_msg_list_empty")},e=>{throw r.useTracingStore.getState().error("init_msg_inner_empty",e),e}):await h}}},v=e=>{let[t,a]=(0,n.useState)(null),[r,o]=(0,n.useState)(!0);return(0,n.useEffect)(()=>{o(!0),void 0!==e&&l.botApiService.LanguageList({bot_id:e}).then(e=>{let{data:t}=e;(null==t?void 0:t.support_language_list)!==void 0&&a(t.support_language_list),o(!1)}).catch(()=>{o(!1)})},[]),{languages:t,loading:r}}},651159:function(e,t,a){a.d(t,{useLocalThreadSendMessage:function(){return m},useSubscribeLocalConversationCreation:function(){return C}});var n=a(713738),r=a(743893),o=a(762707),i=a(4137),s=a(918952),l=a(101874),d=a(845647),c=a(698392),u=a(721118),h=a(230932),v=a(971857),g=a(831566),_=a(227587),p=a(856392);let m=e=>{let{chatType:t}=e,a=(0,_.useLocation)();return(e,n)=>{let i=(0,u.localConversationSelector)(h.useFeedStore.getState(),e);if(i){h.useFeedStore.getState().updateLocalConversationLocal(e,{createStatus:s.CreateConversationStatus.Creating});let c=(0,u.mainConvBotIdSelector)(h.useFeedStore.getState());return(0,r.default)(n).map(n=>{var r,s,u,h;return{...n,reportParams:{...null==n?void 0:n.reportParams,from:(null==n?void 0:null===(r=n.reportParams)||void 0===r?void 0:r.from)||"",enter_from:null==a?void 0:null===(s=a.state)||void 0===s?void 0:s.enter_from,conversation_type:l.PcchatExprConversationType.CocoWebSub},localConversationId:e,conversationId:"0",botId:c,chatType:null!=t?t:d.ChatType.NewThread,botType:"Main",extraExt:{...null==n?void 0:n.extraExt,...(null==i?void 0:null===(u=i.local)||void 0===u?void 0:u.relatedShareId)?{related_share_id:null==i?void 0:null===(h=i.local)||void 0===h?void 0:h.relatedShareId}:{},need_create_thread:"1"},reportEvents:{create_conversation_by_message:(0,p.createReportEvent)({eventName:"create_conversation_by_message",meta:{scene:"new_thread"}}),new_thread_message_full:(0,p.createReportEvent)({eventName:"new_thread_message_full",meta:{...(0,o.default)(n,["scene"]),...(0,o.default)(null==n?void 0:n.reportParams,["send_source"])}})}}})}return n}},C=e=>{let t=(0,v.useLocalConversation)(e);(0,n.useEffect)(()=>{if(t&&e)return h.useFeedStore.subscribe(t=>t.localConversationMap[e],t=>{var a,n,r,o,l,d,u,h;!(0,i.default)(t)&&((null===(a=t.local)||void 0===a?void 0:a.createStatus)===s.CreateConversationStatus.Done&&(null===(n=t.local)||void 0===n?void 0:n.newConversationId)?(null===(d=t.local)||void 0===d||null===(l=d.reportEvent)||void 0===l||l.success(),setTimeout(()=>{var a;(0,c.getChatStore)("chatViewCoreStore").setState({needSkipChatKey:e}),g.DeprecatedChatEvent.emit("chat.thread.created",{localConversationId:e,newConversationId:(null===(a=t.local)||void 0===a?void 0:a.newConversationId)||""})})):(null===(r=t.local)||void 0===r?void 0:r.createStatus)===s.CreateConversationStatus.Failed&&(null===(o=t.local)||void 0===o?void 0:o.failReason)===s.CreateConversationFailReason.ReachLimit&&(null==t||null===(h=t.local)||void 0===h||null===(u=h.reportEvent)||void 0===u||u.error({reason:"guest_reach_limit"}),setTimeout(()=>g.DeprecatedChatEvent.emit("chat.guest.login",{backToRoot:!0}))))},{fireImmediately:!0})},[t,e])}},717554:function(e,t,a){a.d(t,{useInitNewThread:function(){return _},useInitNewThreadOuterChatView:function(){return g}});var n=a(713738),r=a(101874),o=a(845647),i=a(698392),s=a(230932),l=a(604889),d=a(915299),c=a(441259),u=a(856392),h=a(178230),v=a(651159);let g=e=>{let{chatId:t,chatType:a,navigate:n}=e,l=(0,d.useTranslateFn)();return{localThreadSendMessage:(0,v.useLocalThreadSendMessage)({chatType:a}),sendMessageHelper:()=>{let e=t||s.useFeedStore.getState().addNewLocalConversation({reportEvent:(0,u.createReportEvent)({eventName:"create_conversation",meta:{from:"header"}}),conversation:{conversation_type:r.PcchatExprConversationType.CocoWebSub,name:l("sidebar_newChat_placeholder")},conversationId:t});return{resolveLocalConversationId:e,toNewChat:function(a){let r=!(arguments.length>1)||void 0===arguments[1]||arguments[1],s=arguments.length>2?arguments[2]:void 0;setTimeout(()=>{r&&(0,i.getChatStore)("chatInputStore").getState().updateHidePopoverWhenMount(t,!0);let l=new URLSearchParams({...s,type:`${o.ChatType.ThreadLocalConversation}`});null==n||n(`/chat/${e}?${l.toString()}`,{replace:a})},100)}}}}},_=e=>{let{chatId:t,chatType:a,eventPrefix:r="new_thread_view",navigate:o}=e,{chatInputRef:i}=(0,l.useChatRef)();return(0,n.useEffect)(()=>{if(!(0,c.getIsMobileOrIPad)()){var e;null===(e=i.current)||void 0===e||e.focus()}return h.logger.persist.info({eventName:`${r}_show`,meta:{localConversationId:t}}),()=>{t||h.logger.persist.warning({eventName:`${r}_without_localConversationId`})}},[]),g({chatId:t,chatType:a,navigate:o})}},577180:function(e,t,a){a.d(t,{getGuestNewChatConfig:function(){return S},useChatViewConfigByPath:function(){return y},useChatViewConfigFromUrl:function(){return I}});var n=a(713738),r=a(865607),o=a(754212),i=a(845647),s=a(101874),l=a(698392),d=a(230932),c=a(721118),u=a(73270),h=a(915299),v=a(198660),g=a(393752),_=a(460821),p=a(501108),m=a(64206),C=a(227587),f=a(856392);let S=()=>({isGuestAndNewChatReachLimit:(0,v.getIsGuest)()&&d.useFeedStore.getState().guestReachCreateThreadLimit}),I=()=>{var e;let{id:t}=(0,p.useParams)(),[a]=(0,m.useSearchParams)(),n=Number(a.get("type"));return t&&(0,g.isNumeric)(t)?{chatId:t,chatType:n}:n===i.ChatType.ThreadLocalConversation&&t||(null==t?void 0:null===(e=t.startsWith)||void 0===e?void 0:e.call(t,"local_"))&&!n?{chatId:t,chatType:i.ChatType.ThreadLocalConversation}:void 0},w=e=>{let t=(0,h.useTranslateFn)(),{currentLocalConversationId:a}=(0,l.getChatSlice)("chatViewCoreStore");if(a&&(0,c.localConversationSelector)(d.useFeedStore.getState(),a))return a;if(e)return"";let n=(0,u.createLocalConversationId)();return(0,l.getChatStore)("chatViewCoreStore").setState({currentLocalConversationId:n}),d.useFeedStore.getState().addNewLocalConversation({conversation:{conversation_type:s.PcchatExprConversationType.CocoWebSub,name:t("sidebar_newChat_placeholder")},reportEvent:(0,f.createReportEvent)({eventName:"create_conversation",meta:{from:"header"}}),conversationId:n}),n},y=()=>{let e=I(),t=w(e),a=(0,C.useLocation)(),s=(0,n.useMemo)(()=>a.pathname===o.WRITING_NEW_DOC_PAGE_ROUTE?i.ChatType.NewDoc:i.ChatType.NewThread,[a.pathname]);return(0,_.useCompareMemo)(e?{...e}:{chatId:t,chatType:s},r.shallow)}},754212:function(e,t,a){var n;a.d(t,{NEW_DOC_MOCK_ARTIFACT_ID:function(){return s},NEW_DOC_MOCK_CONVERSATION_ID:function(){return i},NewDocSource:function(){return d},WRITE_DOC_HOMEPAGE_ROUTE:function(){return l},WRITING_GUIDANCE_PAGE_ROUTE:function(){return r},WRITING_NEW_DOC_PAGE_ROUTE:function(){return o}});let r="/chat/write",o="/chat/new-doc",i="new_doc_mock_conversation_id",s="new_doc_mock_artifact_id",l="/doc/",d=((n={}).AI_SPACE="ai_space_my_folder",n.WRITING_DETAIL="writing_detailpage",n.PC_NEW_TAB="pc_new_tab",n)},609977:function(e,t,a){a.r(t),a.d(t,{default:function(){return J}});var n,r,o,i,s=a(713738),l=a(611833),d=a(30999),c=a(717554),u=a(144993),h=a(845647),v=a(666196),g=a(462310),_=a(698392),p=a(922851),m=a(178935),C=a(266035),f=a(835789),S=a(230932);function I(e,t,a){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}let w=((n={})[n.Timeout=-1001]="Timeout",n[n.ClientHandlerError=-1002]="ClientHandlerError",n);class y{uniqueClientId(){var e,t;return"function"==typeof(null===(t=window)||void 0===t?void 0:null===(e=t.crypto)||void 0===e?void 0:e.randomUUID)?window.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).substring(2)}`}onAckMessage(e){let{id:t,result:a,error:n,toClientId:r}=e;if(r!==this.clientId)return;let o=this.pendingMessages.get(t);if(o){let{resolve:e,reject:r}=o;this.pendingMessages.delete(t),n?r(n):e(a)}}postAckMessage(e,t,a){let n={type:this.channelType,clientId:this.clientId,toClientId:e.clientId,id:e.id,ack:!0};t?n.error=t:n.result=a,this.targetWindow.postMessage(n,{targetOrigin:this.targetOrigin})}postMessage(e){let{targetOrigin:t,transfer:a,timeout:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((r,o)=>{let i=this.messageId++,s={type:this.channelType,clientId:this.clientId,id:i,data:e},l={targetOrigin:t||this.targetOrigin};null!=a&&(l.transfer=a),this.targetWindow.postMessage(s,l),this.pendingMessages.set(i,{resolve:r,reject:o});let d=n||this.defaultTimeout;setTimeout(()=>{this.pendingMessages.has(i)&&(this.pendingMessages.delete(i),o(new E(`[MessageBridge] ${s.type} ${s.id} timeout of ${d}ms`,w.Timeout)))},d)})}release(){this.pendingMessages.clear(),this.targetWindow.removeEventListener("message",this.onMessage)}constructor({channelType:e,messageHandler:t,clientId:a,targetOrigin:n="*",defaultTimeout:r=500,targetWindow:o=window}){if(I(this,"targetWindow",void 0),I(this,"channelType",void 0),I(this,"clientId",void 0),I(this,"defaultTimeout",void 0),I(this,"pendingMessages",new Map),I(this,"messageId",void 0),I(this,"targetOrigin",void 0),I(this,"messageHandler",void 0),I(this,"onMessage",async e=>{let t=e.data;if((null==t?void 0:t.type)===this.channelType&&(null==t?void 0:t.clientId)!==this.clientId){if(null==t?void 0:t.ack){this.onAckMessage(t);return}if("function"==typeof this.messageHandler&&(null==t?void 0:t.data))try{await this.messageHandler(new T(this,e,t))}catch(a){let{message:e}=a;this.postAckMessage(t,{message:`[MessageBridge] client handler error: ${e}`,code:w.ClientHandlerError})}}}),!e)throw Error("[MessageBridge] channelType is required");this.channelType=e,this.targetWindow=o,this.defaultTimeout=r,this.pendingMessages=new Map,this.messageId=0,this.clientId=a||this.uniqueClientId(),this.targetOrigin=n,this.messageHandler=t,this.targetWindow.addEventListener("message",this.onMessage)}}class T{get data(){return this.payload.data}resolve(e){"pending"===this.state&&(this.bridge.postAckMessage(this.payload,void 0,e),this.state="fulfilled")}reject(e){"pending"===this.state&&(this.bridge.postAckMessage(this.payload,e),this.state="rejected")}constructor(e,t,a){I(this,"state","pending"),I(this,"bridge",void 0),I(this,"payload",void 0),I(this,"originEvent",void 0),this.bridge=e,this.originEvent=t,this.payload=a}}class E extends Error{constructor(e,t){super(e),I(this,"code",void 0),this.code=t}}let b=((r={}).SendMessage="sendMessage",r),M=((o={})[o.AskDoubao=0]="AskDoubao",o[o.AISearch=1]="AISearch",o[o.ContinueChat=2]="ContinueChat",o[o.Suggestion=3]="Suggestion",o[o.ImageAsk=4]="ImageAsk",o),N=((i={}).Web="flow-web",i.Extension="flow-web-ext",i);class A extends y{constructor(e){super({targetWindow:window,channelType:"flowExtensionMessage",clientId:e.clientId,targetOrigin:`${location.protocol}//${location.host}`,messageHandler:e.messageHandler})}}var L=a(524129),P=a(910214),k=a(198660),O=a(366119),x=a(190665),R=a(640380),D=a(178230),W=a(856392);let U=()=>{var e,t,a;let n=(0,x.useMatches)();return(null==n?void 0:null===(e=n[2])||void 0===e?void 0:e.id)==="main_chat/page"||(null==n?void 0:null===(t=n[3])||void 0===t?void 0:t.id)==="main_chat/(id$)/page"||(null===(a=n[0])||void 0===a?void 0:a.id)==="chat_layout"&&(!n[1]||"chat_(id)/page"===n[1].id)},F=e=>({text:e,extraExt:{input_skill:JSON.stringify({skill_id:String(L.SkillType.Search),skill_type:L.SkillType.Search,variables:{}}),earlier_search_result:"1",...(0,k.getIsLoggedIn)()?{}:{send_from_skill_guidance_or_suggestion:"1"}},reportParams:{scene:"highlight_search_result_tool",sec_scene:"highlight_search_result_ask"}}),G=(e,t)=>{let a="string"==typeof t?t:(null==t?void 0:t.type)==="text"?t.text:"";return{text:e,extraExt:{...a?{reference_content:JSON.stringify([{type:"text",text:a||""}])}:{}},reportParams:{scene:"text_input_box",sec_scene:a?"highlight_text_input_box":"web_text_input_box"}}},H=(e,t)=>{var a;let n=null==t?void 0:t[0];if(!(null==n?void 0:n.fileBlob)&&!(null==n?void 0:null===(a=n.fileBlobData)||void 0===a?void 0:a.length))return{text:e,reportParams:{scene:"unknown"}};let{fileKey:r,fileName:o,fileBlobData:i=[]}=n,s=n.fileBlob||new File([new Blob([new Uint8Array(i)])],o,{type:"image/png"}),d=(0,l.default)(),c={type:"image",localKey:d,blobUrl:URL.createObjectURL(s),file:s,key:r,fileKey:r,loading:!1,percent:100,failed:!1};(0,_.getChatStore)("attachmentUploadStore").setState(e=>({...e,preprocessTaskMap:{...e.preprocessTaskMap,[d]:c}}));let h=(0,m.makeNestedMessagePayload)({text:e,attachments:[{type:"image",file:s,localKey:d,from:""}],attachmentKeys:[n.fileKey],attachmentStates:[{type:"image",fileName:o,fileKey:n.fileKey,uploadPercent:100,status:u.AttachmentStatus.Normal}],enableImageVlm:!0},{from:"",scene:"image_ask_doubao",sec_scene:"image_ask_doubao"});return h||{text:e,reportParams:{scene:"unknown"}}},B=e=>{let t=(0,x.useMatches)(),a=(0,R.useNavigate)(),{sendMessage:n}=(0,v.useChatService)("chatMessageService"),{localThreadSendMessage:r,sendMessageHelper:o}=(0,c.useInitNewThreadOuterChatView)({chatId:"",chatType:h.ChatType.NewThread,navigate:a}),{run:i}=(0,O.default)(async(a,i)=>{let s=a.scene===M.AISearch?F(a.content):a.scene===M.Suggestion?{text:a.content,reportParams:{scene:"suggested_prompts"}}:a.scene===M.ContinueChat?G(a.content,a.ref):a.scene===M.ImageAsk?H(a.content,a.attachments||[]):{text:a.content,reportParams:{scene:"unknown"}};if(s.reportParams={...s.reportParams,...a.reportParams},i.resolveConversationId)n([{...s,conversationId:i.resolveConversationId}]);else if(t&&(null==e?void 0:e.chatType)===h.ChatType.Conversation&&!a.isNewChat)n([s]);else{let{resolveLocalConversationId:e,toNewChat:t}=o();i.resolveLocalConversationId=e,(0,_.getChatStore)("chatViewCoreStore").setState({currentLocalConversationId:e}),n(await r(e,[s])),t()}});return i},$=e=>{let t=U(),a=(0,R.useNavigate)(),{sendMessageHelper:n}=(0,c.useInitNewThreadOuterChatView)({chatId:"",chatType:h.ChatType.NewThread,navigate:a}),{run:r}=(0,O.default)(async(r,o)=>{let i=await (0,p.getChatService)("refContentStoreService"),s=null==e?void 0:e.chatId;if(o.resolveConversationId)s=o.resolveConversationId;else if(t&&(null==e?void 0:e.chatType)===h.ChatType.Conversation&&!r.isNewChat)s=null==e?void 0:e.chatId;else if(o.resolveLocalConversationId)s=o.resolveLocalConversationId;else{let{resolveLocalConversationId:e}=n();o.resolveLocalConversationId=e,s=e,(0,_.getChatStore)("chatViewCoreStore").setState({currentLocalConversationId:e}),setTimeout(()=>a(d.CHAT_PAGE_ROUTE),100)}s&&r.ref&&(null==i||i.setRefContents({refContents:"string"==typeof r.ref?[{type:"text",text:r.ref}]:[r.ref],channel:"default",source:L.SkillType.ReferenceAsk},s))});return r},V=e=>{let t=(0,R.useNavigate)(),a=U(),{initLoadMessageInChatPage:n}=(0,g.useLoadConversationMessage)(),{run:r}=(0,O.default)((r,o,i)=>{(async()=>{var i,s,l,c,u,v,g;if(!(null===(i=r.syncMessageIds)||void 0===i?void 0:i.length))return;a&&(null==e?void 0:e.chatType)===h.ChatType.Conversation&&!r.isNewChat?o.resolveConversationId=e.chatId:o.resolveConversationId=(null===(v=await (await (0,C.getConversationApiClient)()).threadCreate({bot_id:f.MAIN_BOT_ID}))||void 0===v?void 0:null===(u=v.data)||void 0===u?void 0:null===(c=u.thread_info)||void 0===c?void 0:null===(l=c.conversation)||void 0===l?void 0:l.conversation_id)||"",await P.messageApiService.PutChatRecord({conversation_id:o.resolveConversationId,tool_message_id:r.syncMessageIds,switch_message_id:(null==r?void 0:null===(s=r.syncMessageIds)||void 0===s?void 0:s[0])||"0"});let _=null!==(g=await S.useFeedStore.getState().fetchUpdateConversationInfo(o.resolveConversationId,"refreshChatView"))&&void 0!==g?g:null;(null==_?void 0:_.conversation_id)&&await n(null==_?void 0:_.conversation_id),o.resolveConversationId!==(null==e?void 0:e.chatId)&&setTimeout(()=>{t(d.CHAT_PAGE_ROUTE+o.resolveConversationId)},100)})().then(i).catch(e=>D.logger.persist.warning({message:"WebExtBridge Error: syncToChat failed",error:null==e?void 0:e.toString()}))});return r},K=e=>{let t=B(e),a=$(e),n=V(e);(0,s.useEffect)(()=>{let e=new A({clientId:N.Web,async messageHandler(e){var r,o;let i=(0,W.createReportEvent)({eventName:"web_extension_message_event",meta:{method:null===(r=e.data)||void 0===r?void 0:r.method,scene:null===(o=e.data)||void 0===o?void 0:o.scene}});try{let{data:r}=e;if((null==r?void 0:r.method)!==b.SendMessage)throw Error(`UnImplement ExtensionMessageMethod\u{FF1A}${null==r?void 0:r.method}`);let o={resolveLocalConversationId:"",resolveConversationId:""};(r.scene===M.Suggestion||r.scene===M.ContinueChat)&&(e.resolve(),await new Promise(e=>n(r,o,e))),(r.scene===M.AISearch||r.scene===M.Suggestion||r.scene===M.ContinueChat||r.scene===M.ImageAsk)&&t(r,o),(r.scene===M.AskDoubao||r.scene===M.ContinueChat||r.scene===M.ImageAsk)&&a(r,o),i.success({meta:{event_data:JSON.stringify(r)}}),e.resolve()}catch(t){i.error({reason:null==t?void 0:t.toString(),error:t}),e.reject(t)}}});return()=>{e.release()}},[])};var j=a(577180),q=a(345660),J=()=>(K((0,j.useChatViewConfigFromUrl)()),(0,q.jsx)("div",{className:"hidden flow-web-ext-bridge-ready"}))}}]);