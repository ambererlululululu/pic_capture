"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["27264"],{355664:function(t,e,a){a.r(e),a.d(e,{ChatRootLayoutDataLoaderPlugin:function(){return p}});var i=a(913821),n=a(436114),r=a(251913),o=a(229079),s=a(83019),u=a(996080),l=a(368107),g=a(956801),c=a(698392),d=a(922851),S=a(910214),h=a(177048),f=a(198660),L=a(715056),m=a(178230),y=a(467851);async function w(t){let{fetchGuestDataOnly:e}=t,a=(t,e)=>{var a,i;return e?(0,y.default)(null==t?void 0:null===(a=t.data)||void 0===a?void 0:a.is_login):(null==t?void 0:null===(i=t.data)||void 0===i?void 0:i.is_login)===!0};try{let t=await (0,s.getWindowInjectPromiseByName)(u.PromiseName.GuestLayoutMode);if(!t||!a(t,e))throw Error("html launch no data or not login / no web_id");return t}catch(t){if(t.message.includes("ttwid"))throw t.name="ttwidError",t;{let t=await S.samanthaApiService.GetSetting();if(!t||!a(t,e))throw Error("html launch no data or not login / no web_id");return t}}}function v(t,e,a){var i;return(e="symbol"==typeof(i=function(t,e){if("object"!=typeof t||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var i=a.call(t,e||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?i:i+"")in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class p{async handleInit(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{autoRetry:e,isGuest:a,showBoundary:n}=t,r=t=>m.logger.persist.log({message:t,meta:{time:Date.now(),loginState:(0,f.getLoginState)(),autoRetry:e,isGuest:!!a}});try{(0,c.getChatStore)("launcherRawSettingStore").setState(t=>({launchStatus:l.LaunchStatus.Loading,settingStatus:t.settingStatus===l.LaunchStatus.Success?l.LaunchStatus.Success:l.LaunchStatus.Loading}));let{data:t}=await w({fetchGuestDataOnly:a});(0,c.getChatStore)("launcherRawSettingStore").setState(e=>({settingStatus:l.LaunchStatus.Success,settingData:(0,i.default)(e.settingData,t)?e.settingData:t}));let{data:e}=await S.settingApiService.Launch();if(!e)throw Error("Service return empty launch data");if(!(null==e?void 0:e.config))throw Error("launch data config is empty");(0,c.getChatStore)("launcherRawSettingStore").setState({launchData:e})}catch(a){if((0,c.getChatStore)("launcherRawSettingStore").setState(t=>{let{launchStatus:e,settingStatus:a}=t;return{settingStatus:a===l.LaunchStatus.Loading?l.LaunchStatus.Failed:a,launchStatus:e===l.LaunchStatus.Loading?l.LaunchStatus.Failed:e}}),e){let e=(0,f.getLoginState)();if(e===L.LoginState.Success)r("Init error and retry immediately"),await this.handleInit({...t,autoRetry:!1});else if(e===L.LoginState.Loading){r("Init error and wait to retry");let e=null,a=()=>{e&&(clearTimeout(e),e=null),i()},i=(0,f.subscribeLoginState)(e=>{e===L.LoginState.Success?(r("Init error and retry in subscribe"),this.handleInit({...t,autoRetry:!1}),a()):e===L.LoginState.Failed&&a()});e=setTimeout(()=>{r("Init error and retry in timeout"),this.handleInit({...t,autoRetry:!1}),a()},5e3)}else e===L.LoginState.Failed?r("Init error and skip retry because of LoginState.Failed"):null==n||n(a)}else{var o;g.useTracingStore.getState().error("init_chat_app_error",a),String(null===(o=a.errorOption)||void 0===o?void 0:o.code)!==String(h.ErrorCodes.USER_BANNED)&&(null==n||n(a))}}}async preInitSetting(){try{(0,c.getChatStore)("launcherRawSettingStore").setState({settingStatus:l.LaunchStatus.Loading});let t=await (0,s.getWindowInjectPromiseByName)(u.PromiseName.GuestLayoutMode);(null==t?void 0:t.data)&&(0,c.getChatStore)("launcherRawSettingStore").setState({settingStatus:l.LaunchStatus.Success,settingData:null==t?void 0:t.data})}catch(t){}}constructor(){v(this,"logTracing",n.default),v(this,"waitHydrateAndLogin",async()=>Promise.all([(0,f.getLoginLoadingPromise)()])),v(this,"pageCreateTime",performance.now()),v(this,"onEnter",async(t,e)=>{let{showBoundary:a,navigate:i}=t;if(i&&(0,d.getChatService)("chatNavigateService").then(t=>{null==t||t.init(i)}),!e){this.pageCreateTime=performance.now(),this.preInitSetting(),await this.waitHydrateAndLogin();let t=(0,f.getIsGuest)();m.logger.persist.info({eventName:"hydrate_login_finish",meta:{messageHydrated:!0,feedHydrated:!0,isGuest:t}}),await this.handleInit({autoRetry:!0,isGuest:t,isOverallList:!t,setLaunchData:n.default,pageCreateTime:this.pageCreateTime,setReportEvent:n.default,showBoundary:a})}}),this.logTracing=(0,r.default)(()=>{let t=g.useTracingStore.getState();if(t.addDurationPoint("init_chat_app_start"),"undefined"!=typeof window){let e=(0,o.default)(window,"login_state_finish");t.addDurationPoint("login_state_finish",e)}})}}}}]);