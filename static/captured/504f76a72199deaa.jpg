"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["81922"],{427800:function(e,t,i){i.d(t,{default:function(){return r}}),i(713738);var n=i(430261),a=i(345660),r=(0,n.IconFactory)((0,a.jsx)(e=>(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"none",viewBox:"0 0 24 24",...e,children:(0,a.jsx)("path",{fill:"currentColor",fillRule:"evenodd",d:"M12.793 3.793a1 1 0 0 1 1.414 0l7.5 7.5a1 1 0 0 1 0 1.414l-7.5 7.5a1 1 0 0 1-1.414-1.414L18.586 13H3a1 1 0 1 1 0-2h15.586l-5.793-5.793a1 1 0 0 1 0-1.414",clipRule:"evenodd"})}),{}))},921219:function(e,t,i){i.d(t,{default:function(){return r}}),i(713738);var n=i(430261),a=i(345660),r=(0,n.IconFactory)((0,a.jsx)(e=>(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"none",viewBox:"0 0 48 48",...e,children:(0,a.jsx)("path",{fill:"currentColor",d:"M23.99 44q-4.104 0-7.725-1.568a20.2 20.2 0 0 1-6.389-4.318 20.6 20.6 0 0 1-4.318-6.389Q3.99 28.104 3.99 24t1.568-7.725a20.4 20.4 0 0 1 4.318-6.37 20.5 20.5 0 0 1 6.37-4.337Q19.867 4 23.97 4q4.124 0 7.744 1.568a20.4 20.4 0 0 1 6.39 4.337 20.2 20.2 0 0 1 4.336 6.37Q44.01 19.896 44.01 24t-1.569 7.725a20.45 20.45 0 0 1-4.337 6.39 20.2 20.2 0 0 1-6.389 4.317Q28.095 44 23.99 44m.02-16.65q1.723 0 1.761-1.801l.31-9.72q.039-.89-.561-1.451-.6-.581-1.53-.581-.948 0-1.53.58-.58.562-.541 1.433l.27 9.758q.06 1.782 1.82 1.781m0 6.66q.968 0 1.665-.62t.697-1.587q0-.95-.697-1.588a2.38 2.38 0 0 0-1.665-.639q-.988 0-1.685.639a2.07 2.07 0 0 0-.697 1.588q0 .968.697 1.587.717.62 1.685.62"})}),{}))},112719:function(e,t,i){i.d(t,{OverflowTextWithTooltip:function(){return o}});var n=i(713738),a=i(504694),r={"overflow-tooltip":"overflow-tooltip-efNYIo"},s=i(345660);let o=e=>{let{text:t,textClassName:i,lang:o,...l}=e,d=(0,n.useRef)(null),[u,c]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{d.current&&(d.current.scrollHeight>d.current.clientHeight?c(!0):c(!1))},[t]),(0,s.jsx)(s.Fragment,{children:u?(0,s.jsx)(a.default,{mouseEnterDelay:500,mouseLeaveDelay:500,position:"leftTop",motion:!1,showArrow:!0,arrowPointAtCenter:!1,content:t,className:r["overflow-tooltip"],...l,children:(0,s.jsx)("span",{lang:o,className:i,ref:d,children:t})}):(0,s.jsx)("span",{lang:o,className:i,ref:d,children:t})})}},926889:function(e,t,i){i.d(t,{SpanI18n:function(){return s}});var n=i(218679),a=i(445244),r=i(345660);let s=e=>{let{className:t,style:i,children:s,dir:o}=e,l=(0,a.useGetLanguageDirectionOfText)((0,n.default)(s)?s:"");return(0,n.default)(s)||(l=void 0),(0,r.jsx)("span",{className:t,style:i,dir:null!=o?o:l,children:s})}},573966:function(e,t,i){i.d(t,{useEstablished:function(){return a}});var n=i(713738);let a=e=>{let t=(0,n.useRef)(e);return t.current=t.current||e,t.current}},843174:function(e,t,i){i.d(t,{utf8:function(){return r}});var n=i(519428),a=i(436041);let r={length(e){let t=0,i=0;for(let n=0;n<e.length;++n)(i=e.charCodeAt(n))<128?t+=1:i<2048?t+=2:(64512&i)==55296&&(64512&e.charCodeAt(n+1))==56320?(++n,t+=4):t+=3;return t},read(e,t,i){if(i-t<1)return"";let n="";for(let a=t;a<i;){let t=e[a++];if(t<=127)n+=String.fromCharCode(t);else if(t>=192&&t<224)n+=String.fromCharCode((31&t)<<6|63&e[a++]);else if(t>=224&&t<240)n+=String.fromCharCode((15&t)<<12|(63&e[a++])<<6|63&e[a++]);else if(t>=240){let i=((7&t)<<18|(63&e[a++])<<12|(63&e[a++])<<6|63&e[a++])-65536;n+=String.fromCharCode(55296+(i>>10)),n+=String.fromCharCode(56320+(1023&i))}}return n},write(e,t,i){let n,a;let r=i;for(let r=0;r<e.length;++r)(n=e.charCodeAt(r))<128?t[i++]=n:(n<2048?t[i++]=n>>6|192:((64512&n)==55296&&(64512&(a=e.charCodeAt(r+1)))==56320?(n=65536+((1023&n)<<10)+(1023&a),++r,t[i++]=n>>18|240,t[i++]=n>>12&63|128):t[i++]=n>>12|224,t[i++]=n>>6&63|128),t[i++]=63&n|128);return i-r},posCalcRange(e,t){let i=0,r={},s=(0,n.default)(t);s=(0,a.default)(s.sort((e,t)=>e-t));for(let t=0;t<e.length&&(i===s[0]&&(r[s[0]]=t,s.shift()),(64512&e[t].charCodeAt(0))==55296&&(64512&e[t+1].charCodeAt(0))==56320?(i+=this.length(`${e[t]}${e[t+1]}`),t++):i+=this.length(e[t]),s.length);t++);return r},posCalc(e,t){let i="",n=0;for(let a=0;a<e.length;a++)if(i+=e[a],this.length(i)===t){n=a+1;break}return n}}},948673:function(e,t,i){i.d(t,{getDuplicatePluginIdentifier:function(){return n}});let n=e=>e.map(e=>e.toString()).filter(e=>!e.includes("infra:"))},556946:function(e,t,i){i.d(t,{useChatReceiveMessageBoxBottomPluginWithMessage:function(){return M},useChatReceiveMessageBoxLeftPluginWithMessage:function(){return S},useChatReceiveMessageBoxPluginWithMessage:function(){return _},useChatReceiveMessageBoxRightPluginWithMessage:function(){return C},useChatReceiveMessageBoxTopPluginWithMessage:function(){return b},useChatReceiveMessageCenterContentBlockPluginWithContentBlocks:function(){return h},useChatReceiveSuggestContentBlockPluginWithContentBlocks:function(){return f},useChatShareReceiveMessageBoxPluginWithMessage:function(){return y},useChatShareReceiveMessageCenterContentBlockPluginWithContentBlocks:function(){return p}});var n=i(713738),a=i(611833),r=i(226982),s=i(516655),o=i(689368),l=i(178230),d=i(948673),u=i(345660);let c=e=>{let{pluginIdentifier:t,contentBlock:i,pluginLoadCounter:r,duplicateIdentifierList:s,...d}=e,{plugin:c,loading:g,error:v}=(0,o.useChatReceiveMessageContentBlockPlugin)(t),m=(0,n.useMemo)(()=>(0,a.default)(),[t]);if((0,n.useEffect)(()=>{null==r||r(m,g)},[g]),(0,n.useEffect)(()=>(null==r||r(m,g),()=>{null==r||r(m,!1)}),[m]),v)throw v;if(g)return null;if(s.length>1){let e=Error(`${s.join(", ")}`);l.logger.persist.warning({eventName:"duplicate_matcher_of_receive_message_block",error:e})}return c?(0,u.jsx)(c.Content,{contentBlock:i,...d},i.id):null},g=e=>{let{pluginIdentifier:t,contentBlock:i,pluginLoadCounter:r,...s}=e,{plugin:l,loading:d,error:c}=(0,o.useChatShareReceiveMessageContentBlockPlugin)(t),g=(0,n.useMemo)(()=>(0,a.default)(),[t]);if((0,n.useEffect)(()=>{null==r||r(g,d)},[d]),(0,n.useEffect)(()=>(null==r||r(g,d),()=>{null==r||r(g,!1)}),[g]),c)throw c;return d?null:l?(0,u.jsx)(l.Content,{contentBlock:i,...s},i.id):null},v=(e,t)=>{let{matcher:i}=(0,s.useChatReceiveMessageContentBlockPluginMatcher)();return{contentBlockRenderConfigs:e.filter(t).map(e=>{var t;let n=null==i?void 0:null===(t=i.filter(t=>{var i;return t.matchContentBlock(e.block_type,{resourceType:null===(i=e.content_obj)||void 0===i?void 0:i.resource_type})}))||void 0===t?void 0:t.map(e=>e.pluginIdentifier);if(n)return{block:e,pluginIdentifier:n[0],duplicateIdentifierList:n}}).filter(e=>!!e).map(e=>({block:e.block,pluginIdentifier:e.pluginIdentifier,PluginContentRender:c,duplicateIdentifierList:e.duplicateIdentifierList}))}},m=(e,t)=>{let{matcher:i}=(0,s.useChatShareReceiveMessageContentBlockPluginMatcher)();return{contentBlockRenderConfigs:e.filter(t).map(e=>{var t;let n=null==i?void 0:null===(t=i.filter(t=>{var i;return t.matchContentBlock(e.block_type,{resourceType:null===(i=e.content_obj)||void 0===i?void 0:i.resource_type})}))||void 0===t?void 0:t.map(e=>e.pluginIdentifier);if(n)return{block:e,pluginIdentifier:n[0],duplicateIdentifierList:n}}).filter(e=>!!e).map(e=>({block:e.block,pluginIdentifier:e.pluginIdentifier,PluginContentRender:g,duplicateIdentifierList:e.duplicateIdentifierList}))}},f=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return v(e,e=>e.block_type===r.ContentType.SamanthaSuggest)},h=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return v(e,e=>e.block_type!==r.ContentType.SamanthaSuggest)},p=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return m(e,e=>e.block_type!==r.ContentType.SamanthaSuggest)},_=e=>{let{matcher:t}=(0,s.useChatReceiveMessageBoxPluginMatcher)(),i=(null!=t?t:[]).map(t=>t.matchPlugin(e)?t.pluginIdentifier:void 0).filter(e=>void 0!==e),r=i[0],l=(0,n.useMemo)(()=>(0,a.default)(),[r]),u=(0,d.getDuplicatePluginIdentifier)(i),{plugin:c,loading:g,error:v}=(0,o.useChatReceiveMessageBoxPlugin)(null!=r?r:"");if(v)throw v;return{pluginLoadId:l,plugin:c,pluginIdentifier:r,loading:g,duplicateIdentifierList:u}},y=e=>{let{matcher:t}=(0,s.useChatShareReceiveMessageBoxPluginMatcher)(),i=(null!=t?t:[]).map(t=>t.matchPlugin(e)?t.pluginIdentifier:void 0).filter(e=>void 0!==e),r=i[0],l=(0,n.useMemo)(()=>(0,a.default)(),[r]),u=(0,d.getDuplicatePluginIdentifier)(i),{plugin:c,loading:g,error:v}=(0,o.useChatShareReceiveMessageBoxPlugin)(null!=r?r:"");if(v)throw v;return{pluginLoadId:l,plugin:c,pluginIdentifier:r,loading:g,duplicateIdentifierList:u}},M=e=>{let{matcher:t=[]}=(0,s.useChatReceiveMessageBoxBottomPluginMatcher)(),i=(null!=t?t:[]).map(t=>t.matchPlugin(e)?t.pluginIdentifier:void 0).filter(e=>void 0!==e),n=i[0],a=(0,d.getDuplicatePluginIdentifier)(i),{plugin:r,loading:l}=(0,o.useChatReceiveMessageBoxBottomPlugin)(n);return{plugin:r,pluginIdentifier:n,loading:l,duplicateIdentifierList:a}},b=e=>{let{matcher:t=[]}=(0,s.useChatReceiveMessageBoxTopPluginMatcher)(),i=(null!=t?t:[]).map(t=>t.matchPlugin(e)?t.pluginIdentifier:void 0).filter(e=>void 0!==e),n=i[0],a=(0,d.getDuplicatePluginIdentifier)(i),{plugin:r,loading:l}=(0,o.useChatReceiveMessageBoxTopPlugin)(n);return{plugin:r,pluginIdentifier:n,loading:l,duplicateIdentifierList:a}},S=e=>{let{matcher:t=[]}=(0,s.useChatReceiveMessageBoxLeftPluginMatcher)(),i=(null!=t?t:[]).map(t=>t.matchPlugin(e)?t.pluginIdentifier:void 0).filter(e=>void 0!==e),n=i[0],a=(0,d.getDuplicatePluginIdentifier)(i),{plugin:r,loading:l}=(0,o.useChatReceiveMessageBoxLeftPlugin)(n);return{plugin:r,pluginIdentifier:n,loading:l,duplicateIdentifierList:a}},C=e=>{let{matcher:t=[]}=(0,s.useChatReceiveMessageBoxRightPluginMatcher)(),i=(null!=t?t:[]).map(t=>t.matchPlugin(e)?t.pluginIdentifier:void 0).filter(e=>void 0!==e),n=i[0],a=(0,d.getDuplicatePluginIdentifier)(i),{plugin:r,loading:l}=(0,o.useChatReceiveMessageBoxRightPlugin)(n);return{plugin:r,pluginIdentifier:n,loading:l,duplicateIdentifierList:a}}},918092:function(e,t,i){i.d(t,{RetryCounter:function(){return r}});var n=i(178230);function a(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class r{add(){n.logger.persist.info({eventName:"retry_counter_add",meta:{attempts:this._attempts}}),this._attempts++}reset(){n.logger.persist.info({eventName:"retry_counter_reset",meta:{attempts:this._attempts}}),this._attempts=0}updateConnectingTimeoutTimer(e){this._connectionHeartbeatTimeoutTimer&&clearTimeout(this._connectionHeartbeatTimeoutTimer),this._connectionHeartbeatTimeoutInterval&&(this._connectionHeartbeatTimeoutTimer=setTimeout(()=>{e()},this._connectionHeartbeatTimeoutInterval))}clearConnectionHeartbeatTimeoutTimer(){this._connectionHeartbeatTimeoutTimer&&(clearTimeout(this._connectionHeartbeatTimeoutTimer),this._connectionHeartbeatTimeoutTimer=null)}get attempts(){return this._attempts}matchMaxRetryAttempts(){return this._attempts>=this._maxRetryAttempts}constructor(e=0,t=0){this._maxRetryAttempts=e,this._connectionHeartbeatTimeoutInterval=t,a(this,"_attempts",0),a(this,"_connectionHeartbeatTimeoutTimer",null)}}},943143:function(e,t,i){i.d(t,{ErrorCode:function(){return n}});var n={Ok:0,HighRiskPrompt:0x2a521378}},670422:function(e,t,i){i.d(t,{ProtoVersion:function(){return n}});var n={VERSION_UNKNOWN:0,VERSION_NORAML:1,VERSION_BLOCK:2}},60795:function(e,t,i){i.d(t,{EventStreamContentType:function(){return a},LastEventId:function(){return n}});let n="last-event-id",a="text/event-stream"},292615:function(e,t,i){i.d(t,{createFetchStream:function(){return f}});var n=i(605173),a=i(678669),r=i(154922),s={CONNECTING:0,OPEN:1,CLOSED:2},o=i(843174);function l(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let d={decode:e=>e?o.utf8.read(e,0,e.byteLength):""};class u{feed(e){this._append(e),this._readLineLoop()}_new(){return{data:void 0,event:void 0,id:void 0,retry:void 0}}_readLineLoop(){let e=this._buffer.length;if(e)for(-1!==this._line.end&&(this._line.start=0);this._pos<e&&(this._line.end=-1,this._readLine(),-1!==this._line.end);)this._readField(this._buffer.subarray(this._line.start,this._line.end)),this._line.start=this._pos,this._fieldLen=-1,0!==this._line.start&&(this._buffer=this._buffer.subarray(this._line.start),this._pos-=this._line.start,this._line.start=this._pos)}_readLine(){let e=this._buffer.length;for(;this._pos<e&&-1===this._line.end;){switch(this._buffer[this._pos]){case 58:-1===this._fieldLen&&(this._fieldLen=this._pos-this._line.start);break;case 13:this._line.end=this._pos,this._skipTrailingNewLine();break;case 10:this._line.end=this._pos}this._pos+=1}}_skipTrailingNewLine(){10===this._buffer[this._pos+1]&&this._pos++}_readField(e){if(0===e.length&&(this._onMessage(this._message),this._message=this._new()),-1===this._fieldLen){let t=this._decoder.decode(e);this._writeField(t,"");return}if(this._fieldLen===e.length-1){let t=this._decoder.decode(e.subarray(0,this._fieldLen));this._writeField(t,"");return}if(this._fieldLen){let t=this._decoder.decode(e.subarray(0,this._fieldLen)),i=this._fieldLen+1;32===e[this._fieldLen+1]&&(i+=1);let n=this._decoder.decode(e.subarray(i));this._writeField(t,n);return}}_writeField(e,t){switch(e){case"data":void 0!==this._message.data?this._message.data=`${this._message.data}
${t}`:this._message.data=t;break;case"event":this._message.event=t;break;case"id":this._message.id=t;break;case"retry":this._message.retry=function(e){let t=Number(e);if(!Number.isNaN(t))return t}(t)}}_append(e){let t=this._buffer.length,i=new Uint8Array(t+e.length);i.set(this._buffer),i.set(e,t),this._buffer=i}constructor(e,t=d){this._onMessage=e,this._decoder=t,l(this,"_buffer",new Uint8Array),l(this,"_pos",void 0),l(this,"_fieldLen",void 0),l(this,"_line",void 0),l(this,"_message",void 0),this._message=this._new(),this._line={start:0,end:-1},this._fieldLen=-1,this._pos=0,this.feed=this.feed.bind(this)}}async function c(e,t){let i;let n=e.getReader(),a=new u(t);for(;!(i=await n.read()).done;)a.feed(i.value)}var g=i(60795);function v(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let m=class{async _startFetch(){try{var e,t;this._readyState=s.CONNECTING;let i=new AbortController,{headers:r}=this._requestOptions;r instanceof Headers&&this._lastEventId?r.set(g.LastEventId,String(this._lastEventId)):r=(0,n.default)(r)?[...r,[g.LastEventId,String(this._lastEventId)]]:{...r,[g.LastEventId]:String(this._lastEventId)},this._fetchInstance=fetch(this._input,{...(0,a.default)(this._requestOptions,"openInterceptor"),headers:r,signal:i.signal}),this._abortController=i;let o=await this._fetchInstance;await (null===(e=(t=this._requestOptions).openInterceptor)||void 0===e?void 0:e.call(t,o)),this._readyState=s.OPEN,await this._onOpen(o)}catch(e){this._onError(e)}}async _onOpen(e){let t=e.headers.get("content-type");if(!(null==t?void 0:t.startsWith(g.EventStreamContentType)))throw Error("Invalid Content-Type");if(!(null==e?void 0:e.ok)||!(null==e?void 0:e.body))throw Error("Invalid Response");this._emitter.emit("open",e),await c(e.body,this._onMessage.bind(this)),this._emitter.emit("close","done")}_onError(e){this._fetchInstance=void 0,this._readyState=s.CLOSED,this._emitter.emit("error",e)}_onMessage(e){this._lastEventId=Number(e.id),this._emitter.emit("message",e)}get lastEventId(){return this._lastEventId}get isAborted(){var e;return!!(null===(e=this._abortController)||void 0===e?void 0:e.signal.aborted)}get abortReason(){var e;return null===(e=this._abortController)||void 0===e?void 0:e.signal.reason}get readyState(){return this._readyState}start(){!this._fetchInstance&&this._startFetch()}on(e,t,i){this._emitter.on(e,t,i)}off(e,t,i,n){this._emitter.off(e,t,i,n)}cancel(e){var t;null===(t=this._abortController)||void 0===t||t.abort(e),this._fetchInstance=void 0}constructor(e,t){this._input=e,this._requestOptions=t,v(this,"CONNECTING",s.CONNECTING),v(this,"OPEN",s.OPEN),v(this,"CLOSED",s.CLOSED),v(this,"_emitter",void 0),v(this,"_readyState",s.CLOSED),v(this,"_lastEventId",void 0),v(this,"_fetchInstance",void 0),v(this,"_abortController",void 0),this._emitter=new r.default,this._startFetch()}},f=(e,t)=>{let i=new m(e,(0,a.default)(t,["onClose","onOpen","onError","onMessage"]));return t.onOpen&&i.on("open",t.onOpen),t.onClose&&i.on("close",t.onClose),t.onMessage&&i.on("message",t.onMessage),t.onError&&i.on("error",t.onError),i}},192843:function(e,t,i){i.d(t,{extractRefContentFromMessage:function(){return g}});var n=i(101874),a=i(629006),r=i(698392),s=i(722038),o=i(296493),l=i(717056);let d=e=>{var t,i,n;return(null===(t=e.content_obj)||void 0===t?void 0:t.link_model)&&((null===(n=(null===(i=e.content_obj)||void 0===i?void 0:i.link_model).extra)||void 0===n?void 0:n.repo_id)||"")||""},u=e=>{var t,i;return(null===(i=e.attachments)||void 0===i?void 0:null===(t=i.filter(e=>e.file_review_state!==s.ReviewState.ReviewState_NotCompliant&&e.file_parse_state!==s.ParseState.ParseState_Failed&&!!e.key))||void 0===t?void 0:t.map(t=>{var i;return{type:t.type!==n.AttachmentEnum.Link?t.type===n.AttachmentEnum.Directory?"directory":"attachment":"link",fileKey:t.key||(0,l.attachmentKeySelector)((0,r.getChatStore)("attachmentUploadStore").getState(),(null==e?void 0:null===(i=e.local)||void 0===i?void 0:i.localKey)||"")||"",fileName:t.name,link:t.url,identifier:t.identifier||d(e)}}))||[]},c=e=>{var t;return(0,a.isCompositeMessageWithWebsites)(e)&&(null===(t=e.content_obj.website_model)||void 0===t?void 0:t.pages).map(e=>{if(e.url&&e.title)return{type:"link",link:e.url}}).filter(o.notUndefined)||[]},g=e=>"attachments"in e?u(e):(0,a.isCompositeMessageWithWebsites)(e)?c(e):[]},717056:function(e,t,i){i.d(t,{attachmentKeySelector:function(){return d},extractRefContentFromPayload:function(){return _}});var n=i(304086),a=i(778816),r=i(257022),s=i(698392),o=i(296493),l=i(249254);let d=(e,t)=>e.preprocessTaskMap[t].key,u=e=>{if("image_key"in e)return{type:"attachment",fileKey:e.image_key||"",fileName:"Image"};if("image"in e&&e.local_key&&e.image){let t=d((0,s.getChatStore)("attachmentUploadStore").getState(),e.local_key);if(t)return{type:"attachment",fileKey:t,fileName:(0,l.pickAsString)("name")(e.image)||"Image"}}},c=e=>{if("file_key"in e&&e.file_key){let t=e.file_name||"";return{type:"attachment",fileKey:e.file_key,fileName:t||"File"}}if("file"in e&&e.local_key&&e.file){let t=(0,l.pickAsString)("name")(e.file),i=d((0,s.getChatStore)("attachmentUploadStore").getState(),e.local_key);if(!i)return;return{type:"attachment",fileKey:i,fileName:t||"File"}}},g=e=>{let{images:t}=e.compositeContent||{};if(!(null==t?void 0:t.length))return;let i=t[0];if("key"in i&&i.key)return{type:"attachment",fileKey:i.key,fileName:"Image"};if("blob"in i&&i.local_key&&i.blob){let e=d((0,s.getChatStore)("attachmentUploadStore").getState(),i.local_key);if(!e)return;return{type:"attachment",fileKey:e,fileName:(0,l.pickAsString)("name")(i.blob)||"Image"}}},v=e=>{let{files:t}=e.compositeContent;if(0===t.length)return;let i=t[0];if("key"in i&&i.key){let e="file_name"in i&&i.file_name||"";return{type:"attachment",fileKey:i.key,fileName:e||"File"}}if("blob"in i&&i.local_key&&i.blob){let e=(0,l.pickAsString)("name")(i.blob),t=d((0,s.getChatStore)("attachmentUploadStore").getState(),i.local_key);if(!t)return;return{type:"attachment",fileKey:t,fileName:e||"File"}}},m=e=>{let{links:t}=e.compositeContent;return t.map(e=>({type:"link",link:e}))},f=e=>{let{websites:t}=e.compositeContent||{};return(null==t?void 0:t.map(e=>({type:"link",link:e.url})))||[]},h=e=>{var t;return(null===(t=e.nestedItems)||void 0===t?void 0:t.map(e=>({type:"attachment",fileName:e.fileName,fileKey:e.fileKey,asrType:e.fileType===a.NestedMessageFileType.Audio?"audio":e.fileType===a.NestedMessageFileType.Video?"video":void 0})).filter(o.notUndefined))||[]},p=e=>{let{enableRefContent:t=!0}=e;if(!t)return[];if((0,r.isImageMessagePayload)(e))return[u(e)].filter(o.notUndefined);if((0,r.isFileMessagePayload)(e))return[c(e)].filter(o.notUndefined);if((0,r.isCompositeMessagePayloadWithImages)(e))return[g(e)].filter(o.notUndefined);if((0,r.isCompositeMessagePayloadWithFiles)(e))return[v(e)].filter(o.notUndefined);if((0,r.isCompositeMessagePayloadWithLinks)(e))return m(e);else if((0,r.isNestedMessagePayload)(e))return h(e);else if((0,r.isCompositeMessagePayloadWithWebsites)(e))return f(e);else return[]},_=e=>(0,n.default)(e.map(e=>p(e)))},842356:function(e,t,i){i.d(t,{handleMessage:function(){return H}});var n=i(101874),a=i(629006),r=i(674157),s=i(458524),o=i(178230),l=i(796349),d=i(459735),u=i(4137),c=i(519428),g=i(840738),v=i(883147),m=i(461141),f=i(645298),h=i(251132),p=i(687780),_=i(83990),y=i(277828),M=i(702427),b=i(555897);let S=e=>{let t=_.useMessageStore.getState(),{conversation_id:i,reply_id:s="",stream_id:o,message_id:l=""}=e;if(s)try{let c=(0,a.isMessageFailed)(e);t.updateMessageList({conversationId:i,immerUpdate:function(){for(var t,a,p=arguments.length,_=Array(p),M=0;M<p;M++)_[M]=arguments[M];let[b]=_,{draftLocalMessageMap:S}=b,C=(0,g.getTemporaryReplyMessageId)(s,o),{message:T,messageLink:k}=(0,h.deleteMockReceivingMessageCreatedBySending)(b,s)||{},P=l||C;S[P]||((0,h.addLocalReceivingMessage)({isRegenerate:(0,r.isRegenerateMessage)(T),immerUpdateMessage:_,newLocalMessageId:P,conversationId:i,replyId:s,messageId:"",sectionId:e.section_id,localMessageStatus:n.LocalMessageStatus.ReceivingFirstPackage,skillType:null==e?void 0:null===(t=e.skill)||void 0===t?void 0:t.skill_type}),(0,h.appendLocalReceivingMessageLink)({isRegenerate:(0,r.isRegenerateMessage)(T),immerUpdateMessage:_,newLocalMessageId:P,messageKey:null!==(a=null==k?void 0:k.messageKey)&&void 0!==a?a:(0,y.createLocalMessageKey)()}));let I=S[P];if(I){if((0,v.checkIsRemoteMessageLessThanMessageInLocal)(e,I))return;let{receiveStreamPackageUpdateTimeout:t=f.defaultReceiveStreamPackageUpdateTimeout}=(0,m.getChatConfig)("chatMessageConfig")||{};S[P]={...I,local:{...I.local,failed:c,failedExpired:c?void 0:Date.now()+t},...(0,d.default)(e,u.default)}}}});let p=M.messageLifeCycleManager.getSessionIdBySentMessageId(i,s);c?(0,b.emitBatchMessageReceivingEndByError)(i,p,e):(0,b.emitThinkingMessageUpdate)(i,p,e)}catch(a){var S;let t=(0,c.default)(e);t.final_status={message:null===(S=t.final_status)||void 0===S?void 0:S.message,session:(0,p.getLifeCycleError)(a)};let n=M.messageLifeCycleManager.getSessionIdBySentMessageId(i,s);throw(0,b.emitBatchMessageReceivingEndByError)(i,n,t),a}};var C=i(296493);let T=e=>{var t,i,n;let r=_.useMessageStore.getState(),{content_obj:s,conversation_id:l,reply_id:d,message_id:u}=e;try{let n=(0,a.isFinishReplyLocalMessage)(e);o.logger.console.info({namespace:null===(t=e.local_info)||void 0===t?void 0:t.from,message:"Suggest Message",meta:{message:e}});let{suggest:c,suggest_skill:g,deep_research_suggest:v=!1}=s||{},m=(0,C.isStringArray)(c)?c:[];if(!d){o.logger.console.warning({namespace:null===(i=e.local_info)||void 0===i?void 0:i.from,message:"invalid suggest message: expect reply_id but found undefined/null"});return}n&&d&&function(e,t,i,n,a){let{research_suggest:r,suggest_skill:s}=a||{};e.updateMessageList({conversationId:t,immerUpdate:e=>{let{draftMessageMap:t}=e,a=t[i];a&&(a.ext?(a.ext.sp=n,s&&(a.ext.suggest_skill=s),r&&(a.ext.research_suggest=r)):a.ext={sp:n,...s?{suggest_skill:s}:{},...r?{research_suggest:r}:{}})}})}(r,l,u,JSON.stringify(m),{suggest_skill:String(null!=g?g:""),research_suggest:g?String(0===g):String(v)}),r.updateSuggestMessage(l,t=>{var i,n,a;return v||0===g?t:(null===(i=e.ext)||void 0===i?void 0:i.onboarding)==="1"||(null===(n=e.ext)||void 0===n?void 0:n.onboarding)==="2"||(null==t?void 0:t.replyId)===d?{replyId:d,loading:!1,failed:!1,expired:void 0,suggests:m}:(o.logger.console.warning({namespace:null===(a=e.local_info)||void 0===a?void 0:a.from,message:"ignore suggest message: non-match reply_id"}),t)});let f=M.messageLifeCycleManager.getSessionIdBySentMessageId(l,d);(0,b.emitSuggestReceivingUpdate)(l,f,e),n&&(0,b.emitSuggestReceivingEnd)(l,f,e)}catch(a){let t=M.messageLifeCycleManager.getSessionIdBySentMessageId(l,d||""),i=(0,c.default)(e);throw i.final_status={message:null===(n=i.final_status)||void 0===n?void 0:n.message,session:(0,p.getLifeCycleError)(a)},(0,b.emitSuggestReceivingEnd)(l,t,i),a}};var k=i(344417),P=i(420177),I=i(725705),E=i(516655),w=i(689368),x=i(785926),R=i(230932),j=i(103359),N=i(637319),L=i(745829);let A=e=>{var t;return null===(t=e.ext)||void 0===t?void 0:t.collection_id},O=e=>{var t,i;if(!A(e))return!1;let n=null===(t=e.local_info)||void 0===t?void 0:t.message_list_count,a=null===(i=e.local_info)||void 0===i?void 0:i.in_message_list_pos;return(0,k.default)(n)&&(0,k.default)(a)&&a===n-1},B=e=>{var t,i,s,l,d;let{conversation_id:u,message_id:v,local_message_id:m,local_conversation_id:S,section_id:C}=e,T=S||u;try{let d=_.useMessageStore.getState(),c={namespace:null===(t=e.local_info)||void 0===t?void 0:t.from,meta:{message:e}};if(o.logger.console.info({...c,message:"Ack Message"}),!m){o.logger.console.warning({...c,message:"Invalid Ack Message: local_message_id"});return}d.finishSendMessageTask(m);let p=(0,N.getLocalMessageSelector)(_.useMessageStore.getState(),T,m);if((null===(i=e.local_info)||void 0===i?void 0:i.from)===n.MessageFrom.AliceChatSocket&&e.is_regen&&(null===(s=p.local)||void 0===s?void 0:s.status)===n.LocalMessageStatus.SentInLocalConversation){let e=(0,N.getLocalMessageSelector)(_.useMessageStore.getState(),u,m);e&&(p=e)}if((0,a.isMessageFailed)(e)){let t=M.messageLifeCycleManager.getSessionIdBySentMessageId(T,m);(0,b.emitMessageSendingEndByError)(T,t,e)}if(setTimeout(()=>{(0,E.getMessageErrorPluginMatcher)().then(t=>{let i=t.filter(t=>t.matchPlugin(e)).map(e=>e.pluginIdentifier);(0,w.getMessageErrorPluginList)(i).then(t=>{t.forEach(t=>{var i;null==t||null===(i=t.handleSendingMessageError)||void 0===i||i.call(t,e)})})})},1e3),!v){o.logger.console.warning({...c,message:"Invalid Ack Message: message_id"});return}if(!function(e,t){var i;let a=e=>{var i;o.logger.persist.warning({namespace:null===(i=t.local_info)||void 0===i?void 0:i.from,message:"Invalid Ack Message",meta:{reason:e,message:t}})};return e?!!(0,I.isLocalMessage)(e)&&(null==e?void 0:null===(i=e.local)||void 0===i?void 0:i.status)!==n.LocalMessageStatus.SentInLocalConversation||(a("local_sending_message has received ack"),!1):(a("local_sending_message is not exist"),!1)}(p,e))return;let S=(0,r.isRegenerateMessage)(p),k=(0,h.getAllLocalMessageByEqualReplyId)(_.useMessageStore.getState(),{conversationId:T,replyId:v}),B=(null===(l=(0,P.default)(k))||void 0===l?void 0:l.local_message_id)||(0,g.getTemporaryReplyMessageId)(v);(0,j.isLazyCreateConversation)(e)||d.updateMessageList({conversationId:u,immerUpdate:function(){for(var t,i,r,s=arguments.length,o=Array(s),l=0;l<s;l++)o[l]=arguments[l];let[d]=o;S||(0,L.replaceLocalMessageByRemote)({draft:d,localMessage:p,message:e});let{messageLink:c}=(0,L.deleteLocalReceivingMessage)(d,f.mockReplyConstantMessageId)||{};if(!S&&((0,N.findLastMessageByMatchEqualIdSelector)(_.useMessageStore.getState(),u,v)||A(e)&&!O(e)))return;let{draftMessageMap:g}=d;!(v&&(0,a.isMessageNotCompliant)(g[v]))&&((0,h.addLocalReceivingMessage)({conversationType:(0,x.conversationTypeByIdSelector)(R.useFeedStore.getState(),u),isRegenerate:S,immerUpdateMessage:o,newLocalMessageId:B,conversationId:u,replyId:v,messageId:"",sectionId:C,timeout:null==e?void 0:null===(t=e.ext)||void 0===t?void 0:t.timeout,skillType:null===(i=p.skill)||void 0===i?void 0:i.skill_type,localMessageStatus:n.LocalMessageStatus.ReceivingFirstPackage}),(0,h.appendLocalReceivingMessageLink)({isRegenerate:S,immerUpdateMessage:o,newLocalMessageId:B,messageKey:null!==(r=null==c?void 0:c.messageKey)&&void 0!==r?r:(0,y.createLocalMessageKey)()}),(0,h.filterLocalReceivingMessageLink)(o))}});let F=M.messageLifeCycleManager.getSessionIdBySentMessageId(T,m);(0,b.emitMessageSendingEndBySuccessAndBatchMessageReceivingStart)(T,F,{...e,is_regen:S})}catch(n){let t=(0,c.default)(e);t.final_status={message:null===(d=t.final_status)||void 0===d?void 0:d.message,session:(0,p.getLifeCycleError)(n)};let i=M.messageLifeCycleManager.getSessionIdBySentMessageId(T,e.local_message_id||"");throw(0,b.emitMessageSendingEndByError)(T,i,{...e}),n}};var F=i(239705),D=i(777210);let{ConnectionType:U}=s,H=e=>{var t,i,s;let{conversation_id:d,message_id:u=""}=e,c={namespace:null===(t=e.local_info)||void 0===t?void 0:t.from,meta:{message:e}};if(!function(e,t){var i,n;let a=D.messageServiceContainer.get("chatConfigService");(null==a?void 0:null===(i=a.localFeatureConfig)||void 0===i?void 0:i.consoleFullMessagePacket)&&o.logger.console.info({...t,message:`Full Message Received, From: ${null===(n=e.local_info)||void 0===n?void 0:n.from}`})}(e,c),!d){o.logger.console.warning({...c,message:"message.conversation_id is empty when update message in handleMessage"});return}let g={...e,conversation_id:d};if((0,a.isAckMessage)(e)){(0,j.isLazyCreateConversation)(g)?(M.messageLifeCycleManager.copySessionIdWithSentMessageId(g.local_conversation_id,g.local_message_id||"",g.message_id||""),M.messageLifeCycleManager.moveAllSessionLifeCycle(g.local_conversation_id,g.conversation_id)):M.messageLifeCycleManager.copySessionIdWithSentMessageId(g.conversation_id,g.local_message_id||"",g.message_id||""),B(g);return}if((null==e?void 0:null===(i=e.local_info)||void 0===i?void 0:i.from)!==n.MessageFrom.AliceChatFallback&&e.reply_id&&(0,F.handleRegisterAbortHttpLongPollingPullMessage)(e.reply_id),e.next_connection_type===U.HttpChunk&&(null==e?void 0:null===(s=e.local_info)||void 0===s?void 0:s.from)===n.MessageFrom.AliceChatSocket&&(0,F.handleRegisterHttpChunkPullMessage)(e),(0,r.isThinkingMessage)(e)){S(g);return}if(!u){o.logger.console.warning({...c,message:"message.message_id is empty when update message in handleMessage"});return}let v={...e,message_id:u,conversation_id:d};if((0,a.isSuggestMessage)(v)){T(v);return}(0,l.handleUpdateMessage)(v)}},988064:function(e,t,i){i.d(t,{convertExtOmitSkillDefault:function(){return v},convertJSONToString:function(){return g},transformMessageToAliceChatMessage:function(){return f}});var n=i(214071),a=i(788432),r=i(762707),s=i(456712),o=i(516655),l=i(689368),d=i(818289),u=i(165482),c=i(296493);function g(e){var t;return(null===(t=e.content_obj)||void 0===t?void 0:t.data)?(0,u.stringifyJSON)({image_list:e.content_obj.data}):(0,u.stringifyJSON)(e.content_obj)}function v(e){var t;if(null===(t=e.ext)||void 0===t?void 0:t.input_skill){let t=(0,s.getInputSkillNoDefault)(null==e?void 0:e.ext);if((0,n.default)(t))return{...e.ext,input_skill:void 0}}return e.ext}let m=async e=>{let t=await (0,o.getChatProtocolTransformPluginMatcher)();if(t){var i;let n=null===(i=t.find(t=>{var i;return null===(i=t.matchPluginForMessageToAliceChatMessage)||void 0===i?void 0:i.call(t,e)}))||void 0===i?void 0:i.pluginIdentifier,s=await (0,l.getChatProtocolTransformPlugin)(n);return(null==s?void 0:s.messageToAliceChatMessage)?null==s?void 0:s.messageToAliceChatMessage(e):(0,a.default)({},(0,r.default)(e,["local_conversation_id","bot_id","conversation_id","section_id","local_message_id","message_type","content_type","create_time","message_id","reply_id","content_source","template_id","ext","status"]),{ext:v(e),content:g(e)})}},f=async e=>{let t=await Promise.all(e.map(m));return function(e){if(!(e.length<=0))return{...1===e.length?{message:e[0]}:{message_list:e},event_type:d.EventType.Message}}(await Promise.all(t.filter(c.notUndefined)))}},103359:function(e,t,i){i.d(t,{isLazyCreateConversation:function(){return n}});function n(e){let{conversation_id:t,local_conversation_id:i,is_regen:n}=e;return!!i&&!!t&&!n}},214492:function(e,t,i){i.d(t,{BREAK_POINT_ALL:function(){return d},BREAK_POINT_MIN_LEFT:function(){return c},BREAK_POINT_NO_LEFT:function(){return u},CENTER_DEFAULT_PCT:function(){return o},CENTER_MIN_WIDTH:function(){return r},LEFT_SIDE_MIN_WIDTH:function(){return n},LEFT_SIDE_WIDTH:function(){return a},RIGHT_NARROW_MODE_WIDTH:function(){return s},TRANSITION_DURATION:function(){return l}});let n=0,a=280,r=400,s=400,o=35,l=500,d=1080,u=800,c=680},921741:function(e,t,i){i.d(t,{SuggestList:function(){return g},SuggestItem:function(){return c}});var n=i(427800),a=i(713738),r=i(812650),s=i.n(r),o=i(926889),l=i(414459),d={"suggest-message-list-wrapper":"suggest-message-list-wrapper-Hn7Sfr","suggest-message":"suggest-message-LJeEWd",icon:"icon-gW60yM",title:"title-nLMW1O","no-hover":"no-hover-p4Ov_W","no-padding-left":"no-padding-left-eSSqXk",fadeIn:"fadeIn-tLtmrV"},u=i(345660);let c=e=>{let{className:t,onClick:i,children:r}=e,l=(0,a.useRef)(!0),c=l.current;return l.current&&(l.current=!1),(0,u.jsxs)("div",{className:s()("suggest-list-item",d["suggest-message"],c?d.fadeIn:void 0,t),onClick:i,"data-testid":"suggest_message_item",children:[(0,u.jsx)(o.SpanI18n,{className:s()(d.title,"suggest-list-item-title"),children:r}),(0,u.jsx)(n.default,{className:d.icon,autoFitRTL:!0})]})},g=e=>{let{loading:t,suggests:i,message:n,onClick:a,className:r}=e;return t||(null==i?void 0:i.length)?(0,u.jsx)("div",{className:s()(d["suggest-message-list-wrapper"],r),"data-testid":"suggest_message_list",children:t?(0,u.jsx)("div",{className:s()(d["suggest-message"],d["no-hover"],d["no-padding-left"]),children:(0,u.jsx)(l.DotFlashing,{})}):i.filter(e=>e).map((e,t)=>{let{value:i,label:r}=e;return(0,u.jsx)(c,{onClick:()=>{a(i,t)},children:r},`${null==n?void 0:n.reply_id}_${t}`)})},null==n?void 0:n.reply_id):null}},278960:function(e,t,i){i.d(t,{ThinkingFlahsing:function(){return v},ThinkingFlahsingUI:function(){return m}});var n=i(713738),a=i(812650),r=i.n(a),s=i(674157),o=i(847857),l=i(414459),d=i(942054),u={"loading-container":"loading-container-Uv_TJ0","text-content":"text-content-wftFm6"},c=i(345660);let g=(0,n.memo)(l.DotFlashing),v=e=>{var t;let{message:i,className:n}=e,a=null!==(t=(0,o.getMessageText)(i,!1,""))&&void 0!==t?t:"",r=(0,s.isThinkingMessage)(i);return(0,c.jsx)(m,{content:a,isInThinking:r,className:n})},m=e=>{let{content:t,isInThinking:i,className:n}=e;return(0,c.jsxs)("div",{className:r()(u["loading-container"],n),children:[(0,c.jsx)(g,{"data-testid":i?"message_thinking":"message_loading"}),i?(0,c.jsx)(d.FlowingLightEffect,{className:u["text-content"],children:t}):null]})}},746168:function(e,t,i){i.r(t),i.d(t,{AliceChatFallbackProtocolPlugin:function(){return P}});var n=i(762707),a=i(436114),r=i(266655),s=i(154922),o=i(101874),l=i(629006),d=i(703409),u=i(988064),c=i(800477),g=i(842356),v=i(698392),m=i(461141),f=i(645298),h=i(246024),p=i(818289),_=i(910214),y=i(458524),M=i(165482),b=i(843174),S=i(178230),C=i(521780),T=i(15054);function k(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class P{init(e){!this._initialed&&(this._initialed=!0,this._config=e)}async _handleEvent(e,t){let i={...e};if(e.event_type===p.EventType.Message&&e.message){let n=await (0,c.transformAliceChatMessageToMessage)((0,T.addExtraInfoToAckMessage)(e.message),{local_info:{from:this.from,retried:!0,log_id:t}});i.message={...n,is_delta:!1}}if(e.event_type===p.EventType.Message&&e.message_list){let n=await Promise.all(e.message_list.map(async(e,i,n)=>({...await (0,c.transformAliceChatMessageToMessage)(e,{local_info:{from:this.from,retried:!0,log_id:t,message_list_count:n.length,in_message_list_pos:i}}),is_delta:!1})));i.message_list=n}(0,d.dispatchEvent)(i,this)}async sendMessage(e){var t;let i=await (0,v.getAsyncChatStore)("aliceChatProtocolStore");if(this._initialed||this.init(i.getState().aliceChatFallbackInitConfig),!this._initialed)return;let n=await (0,u.transformMessageToAliceChatMessage)(e);_.messageApiService.MessageReplay({payload:C.protoBase64.enc(new TextEncoder().encode((0,M.stringifyJSON)(n)))},{overrideParams:{aid:null===(t=this._config)||void 0===t?void 0:t.ws_app_id},overrideConfig:{timeout:f.sendMessageWaitTimeout}}).then(e=>{var t;if(!e.payload)throw Error("Invalid ack message");let i=C.protoBase64.dec(e.payload),n=(0,M.parseJSON)(b.utf8.read(i,0,i.byteLength),{});this._handleEvent(n,(0,h.getLogIdFromResponse)(e)),null===this||void 0===this||this.pullMessage([{reply_id:null===(t=n.message)||void 0===t?void 0:t.reply_id}])}).catch(e=>{S.logger.console.info(`get ack message failed: ${e.message}`)})}_fetchMessage(e){_.messageApiService.GetMessageReply({message_id:e.reply_id||e.message_id,conversation_id:e.conversation_id},{overrideConfig:{timeout:f.httpPullMessageTimeout}}).then(t=>{var i,a,r,s;if(this._pullMessage(e,f.httpPullMessageInterval),!(null===(a=t.data)||void 0===a?void 0:null===(i=a.message_list)||void 0===i?void 0:i.length))throw Error("message_list is empty");let o=t.data.message_list.filter(e=>!(0,l.isSuggestMessage)(e));for(let e of(o.sort((e,t)=>(Number(e.index)||0)-(Number(t.index)||0)),o))this._handleEvent({message:e,event_type:p.EventType.Message},(0,h.getLogIdFromResponse)(t)),(null==e?void 0:null===(r=e.ext)||void 0===r?void 0:r.sp)&&this._handleEvent({message:{...(0,n.default)(e,["conversation_id","section_id","message_id","reply_id","message_type"]),content_type:y.ContentType.Suggest,content:(0,M.stringifyJSON)({suggest:(0,M.parseJSON)(null==e?void 0:null===(s=e.ext)||void 0===s?void 0:s.sp,{})||""}),ext:{},meta_infos:[]},event_type:p.EventType.Message},(0,h.getLogIdFromResponse)(t))}).catch(t=>{this._pullMessage(e,f.httpPullMessageInterval),S.logger.console.info(`get message reply failed: ${t.message}`)})}_pullMessage(e,t){var i;let{reply_id:n}=e;if(!n||"0"===n){S.logger.console.info("reply_id is empty, skip pull message");return}if(!this._pullMessageTasks[n]){S.logger.console.info("task is empty, skip pull message");return}if(Date.now()-this._pullMessageTasks[n].expired>0)return;null===(i=this._pullMessageTasks[n])||void 0===i||i.clear();let a=setTimeout(()=>{this._fetchMessage(e)},t),r=()=>{clearTimeout(a)};this._pullMessageTasks[n].clear=r,this._pullMessageTasks[n].finish=()=>{r(),delete this._pullMessageTasks[n]}}pullMessage(e){let{reply_id:t}=e[0];if(t&&"0"!==t){if(this._pullMessageTasks[t])this._pullMessageTasks[t].clear();else{let{receiveMessageStartTimeout:e=f.defaultReceiveMessageStartTimeout}=(0,m.getChatConfig)("chatMessageConfig")||{};this._pullMessageTasks[t]={reply_id:t,finish:a.default,clear:a.default,expired:Date.now()+e}}this._pullMessage(e[0],1e4)}}cancelTask(e){var t;null===(t=this._pullMessageTasks[e])||void 0===t||t.finish()}drop(){for(let e of(0,r.default)(this._pullMessageTasks))e.finish();this._pullMessageTasks={}}resumeTask(e){}constructor(){k(this,"from",o.MessageFrom.AliceChatFallback),k(this,"_config",void 0),k(this,"_pullMessageTasks",{}),k(this,"_initialed",!1),k(this,"eventEmitter",new s.default),this._handleEvent=this._handleEvent.bind(this),(0,d.subscribeEvent)([this],{message:g.handleMessage})}}},891840:function(e,t,i){i.r(t),i.d(t,{AliceChatSocketProtocolPlugin:function(){return m}});var n=i(154922),a=i(101874),r=i(703409),s=i(988064),o=i(800477),l=i(842356),d=i(922851),u=i(818289),c=i(165482),g=i(15054);function v(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class m{async init(){if(this._initialed)return;this._initialed=!0;let e=await (0,d.getChatService)("chatSocketService");null==e||e.on("message",this._onMessage)}pullMessage(e){}cancelTask(e){}_onMessage(e){let{data:t,trace_id:i}=e;"object"==typeof t&&"event_type"in t&&t.event_type===u.EventType.Message&&this._handleEvent({event:t,trace_id:i})}async _handleEvent(e){let{event:t,trace_id:i}=e,n={...t};if(t.event_type===u.EventType.Message&&t.message){var a,s;(0,g.addExtraInfoToAckMessage)(t.message);let e=await (0,o.transformAliceChatMessageToMessage)(t.message,{local_info:{from:this.from,trace_id:i,log_id:(null==t?void 0:null===(s=t.message)||void 0===s?void 0:null===(a=s.ext)||void 0===a?void 0:a.inner_log_id)||i}});n.message={...e,is_delta:!1}}if(t.event_type===u.EventType.Message&&t.message_list){let e=await Promise.all(t.message_list.map(async(e,t,n)=>((0,g.addExtraInfoToAckMessage)(e),{...await (0,o.transformAliceChatMessageToMessage)(e,{local_info:{from:this.from,trace_id:i,message_list_count:n.length,in_message_list_pos:t}}),is_delta:!1})));n.message_list=e}(0,r.dispatchEvent)(n,this)}async sendMessage(e,t){let i=await (0,d.getChatService)("chatSocketService"),n=await (0,s.transformMessageToAliceChatMessage)(e);null==i||i.send((0,c.stringifyJSON)(n),t)}async drop(){let e=await (0,d.getChatService)("chatSocketService");null==e||e.off("message",this._onMessage)}resumeTask(e){}constructor(){v(this,"_initialed",!1),v(this,"from",a.MessageFrom.AliceChatSocket),v(this,"eventEmitter",new n.default),this._handleEvent=this._handleEvent.bind(this),this._onMessage=this._onMessage.bind(this),(0,r.subscribeEvent)([this],{message:l.handleMessage})}}},902487:function(e,t,i){i.r(t),i.d(t,{AliceChatStreamProtocolPlugin:function(){return Q}});var n,a=i(154922),r=i(101874),s=i(703409),o=i(842356),l=i(698392),d=i(495635),u=i(113849),c=i(486677),g=i(217957),v=i(266655),m=i(993478),f=i(351415),h=i(519428),p=i(678669),_=i(943143),y=i(818289),M=i(918092),b=i(629006),S=i(569248),C=i(521780),T=i(843174),k=i(388847);let P=e=>new k.BinaryReader(e,{decode:e=>e?T.utf8.read(e,0,e.byteLength):""});var I=i(979225),E=i(23e4);function w(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class x extends I.Message{static fromBinary(e,t){return new x().fromBinary(e,t)}static fromJson(e,t){return new x().fromJson(e,t)}static fromJsonString(e,t){return new x().fromJsonString(e,t)}static equals(e,t){return E.proto3.util.equals(x,e,t)}constructor(e){super(),w(this,"type",0),w(this,"info",void 0),E.proto3.util.initPartial(e,this)}}w(x,"runtime",E.proto3),w(x,"typeName","msg_pb.MetaInfo"),w(x,"fields",E.proto3.util.newFieldList(()=>[{no:1,name:"type",kind:"scalar",T:5},{no:2,name:"info",kind:"scalar",T:9,opt:!0}]));class R extends I.Message{static fromBinary(e,t){return new R().fromBinary(e,t)}static fromJson(e,t){return new R().fromJson(e,t)}static fromJsonString(e,t){return new R().fromJsonString(e,t)}static equals(e,t){return E.proto3.util.equals(R,e,t)}constructor(e){super(),w(this,"conversationId",void 0),w(this,"sectionId",void 0),w(this,"messageId",void 0),w(this,"localMessageId",void 0),w(this,"index",void 0),w(this,"secSender",void 0),w(this,"replyId",void 0),w(this,"status",void 0),w(this,"createTime",void 0),w(this,"messageType",void 0),w(this,"contentType",void 0),w(this,"content",void 0),w(this,"ttsContent",void 0),w(this,"ext",{}),w(this,"nextConnectionType",void 0),w(this,"chunkSeq",void 0),w(this,"isDelta",void 0),w(this,"metaInfos",[]),w(this,"localConversationId",void 0),w(this,"botId",void 0),w(this,"appletPayload",{}),w(this,"modelType",void 0),w(this,"updateTime",void 0),w(this,"threadId",void 0),E.proto3.util.initPartial(e,this)}}w(R,"runtime",E.proto3),w(R,"typeName","msg_pb.PushMessage"),w(R,"fields",E.proto3.util.newFieldList(()=>[{no:1,name:"conversation_id",kind:"scalar",T:9,opt:!0},{no:2,name:"section_id",kind:"scalar",T:9,opt:!0},{no:3,name:"message_id",kind:"scalar",T:9,opt:!0},{no:4,name:"local_message_id",kind:"scalar",T:9,opt:!0},{no:5,name:"index",kind:"scalar",T:3,opt:!0},{no:6,name:"sec_sender",kind:"scalar",T:9,opt:!0},{no:7,name:"reply_id",kind:"scalar",T:9,opt:!0},{no:8,name:"status",kind:"scalar",T:5,opt:!0},{no:9,name:"create_time",kind:"scalar",T:3,opt:!0},{no:10,name:"message_type",kind:"scalar",T:5,opt:!0},{no:11,name:"content_type",kind:"scalar",T:5,opt:!0},{no:12,name:"content",kind:"scalar",T:9,opt:!0},{no:13,name:"tts_content",kind:"scalar",T:9,opt:!0},{no:14,name:"ext",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:15,name:"next_connection_type",kind:"scalar",T:5,opt:!0},{no:16,name:"chunk_seq",kind:"scalar",T:3,opt:!0},{no:17,name:"is_delta",kind:"scalar",T:8,opt:!0},{no:18,name:"meta_infos",kind:"message",T:x,repeated:!0},{no:19,name:"local_conversation_id",kind:"scalar",T:9,opt:!0},{no:20,name:"bot_id",kind:"scalar",T:9,opt:!0},{no:21,name:"applet_payload",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:22,name:"model_type",kind:"scalar",T:5,opt:!0},{no:23,name:"update_time",kind:"scalar",T:3,opt:!0},{no:24,name:"thread_id",kind:"scalar",T:3,opt:!0}]));class j extends I.Message{static fromBinary(e,t){return new j().fromBinary(e,t)}static fromJson(e,t){return new j().fromJson(e,t)}static fromJsonString(e,t){return new j().fromJsonString(e,t)}static equals(e,t){return E.proto3.util.equals(j,e,t)}constructor(e){super(),w(this,"cmdType",void 0),w(this,"index",void 0),w(this,"conversationId",void 0),w(this,"messageId",void 0),w(this,"ext",{}),w(this,"upCmdType",void 0),w(this,"localMessageId",void 0),E.proto3.util.initPartial(e,this)}}w(j,"runtime",E.proto3),w(j,"typeName","msg_pb.PushCmd"),w(j,"fields",E.proto3.util.newFieldList(()=>[{no:1,name:"cmd_type",kind:"scalar",T:5,opt:!0},{no:2,name:"index",kind:"scalar",T:3,opt:!0},{no:3,name:"conversation_id",kind:"scalar",T:9,opt:!0},{no:4,name:"message_id",kind:"scalar",T:9,opt:!0},{no:5,name:"ext",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:6,name:"up_cmd_type",kind:"scalar",T:5,opt:!0},{no:7,name:"local_message_id",kind:"scalar",T:9,opt:!0}]));class N extends I.Message{static fromBinary(e,t){return new N().fromBinary(e,t)}static fromJson(e,t){return new N().fromJson(e,t)}static fromJsonString(e,t){return new N().fromJsonString(e,t)}static equals(e,t){return E.proto3.util.equals(N,e,t)}constructor(e){super(),w(this,"longitude",void 0),w(this,"latitude",void 0),w(this,"countryName",void 0),w(this,"provinceName",void 0),w(this,"cityName",void 0),w(this,"districtName",void 0),w(this,"townName",void 0),w(this,"countryCode",void 0),E.proto3.util.initPartial(e,this)}}w(N,"runtime",E.proto3),w(N,"typeName","msg_pb.GeoInfo"),w(N,"fields",E.proto3.util.newFieldList(()=>[{no:1,name:"longitude",kind:"scalar",T:9,opt:!0},{no:2,name:"latitude",kind:"scalar",T:9,opt:!0},{no:3,name:"country_name",kind:"scalar",T:9,opt:!0},{no:4,name:"province_name",kind:"scalar",T:9,opt:!0},{no:5,name:"city_name",kind:"scalar",T:9,opt:!0},{no:6,name:"district_name",kind:"scalar",T:9,opt:!0},{no:7,name:"town_name",kind:"scalar",T:9,opt:!0},{no:8,name:"country_code",kind:"scalar",T:9,opt:!0}]));class L extends I.Message{static fromBinary(e,t){return new L().fromBinary(e,t)}static fromJson(e,t){return new L().fromJson(e,t)}static fromJsonString(e,t){return new L().fromJsonString(e,t)}static equals(e,t){return E.proto3.util.equals(L,e,t)}constructor(e){super(),w(this,"messageId",void 0),w(this,"localMessageId",void 0),w(this,"replyId",void 0),w(this,"questionId",void 0),w(this,"createTime",void 0),w(this,"content",void 0),w(this,"ext",{}),w(this,"messageType",void 0),E.proto3.util.initPartial(e,this)}}w(L,"runtime",E.proto3),w(L,"typeName","msg_pb.AppAction"),w(L,"fields",E.proto3.util.newFieldList(()=>[{no:1,name:"message_id",kind:"scalar",T:3,opt:!0},{no:2,name:"local_message_id",kind:"scalar",T:9,opt:!0},{no:3,name:"reply_id",kind:"scalar",T:3,opt:!0},{no:4,name:"question_id",kind:"scalar",T:3,opt:!0},{no:5,name:"create_time",kind:"scalar",T:3,opt:!0},{no:6,name:"content",kind:"scalar",T:9,opt:!0},{no:7,name:"ext",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:8,name:"message_type",kind:"scalar",T:5,opt:!0}]));class A extends I.Message{static fromBinary(e,t){return new A().fromBinary(e,t)}static fromJson(e,t){return new A().fromJson(e,t)}static fromJsonString(e,t){return new A().fromJsonString(e,t)}static equals(e,t){return E.proto3.util.equals(A,e,t)}constructor(e){super(),w(this,"eventType",0),w(this,"message",void 0),w(this,"cmd",void 0),w(this,"geo",void 0),w(this,"appAction",void 0),w(this,"version",void 0),w(this,"messageList",[]),E.proto3.util.initPartial(e,this)}}w(A,"runtime",E.proto3),w(A,"typeName","msg_pb.PushEvent"),w(A,"fields",E.proto3.util.newFieldList(()=>[{no:1,name:"event_type",kind:"scalar",T:5},{no:2,name:"message",kind:"message",T:R,opt:!0},{no:3,name:"cmd",kind:"message",T:j,opt:!0},{no:4,name:"geo",kind:"message",T:N,opt:!0},{no:5,name:"app_action",kind:"message",T:L,opt:!0},{no:6,name:"version",kind:"scalar",T:5,opt:!0},{no:7,name:"message_list",kind:"message",T:R,repeated:!0}]));var O=i(800477),B=i(645298),F=i(177048),D=i(165482),U=i(292615),H=i(60795),V=i(856392),J=i(178230),W=i(674157),q=i(883147),K=i(458524);function G(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let $=((n={})[n.running=1]="running",n[n.idle=2]="idle",n);class z extends a.default{_fetchStream(e){var t,i;this._reporter=(0,V.createReportEvent)({eventName:"fetch_stream",logger:J.logger,meta:{conversation_id:(null==e?void 0:e.conversationId)||"",reply_id:e.replyId,seq_st:(Number(e.chunkSeq)||0)+1,binary_type:this._config.binaryType}}),this._fetchInstance=(0,U.createFetchStream)((0,S.getUrl)("/alice/message/stream_reply",null===(t=this._getCommonHttpParams)||void 0===t?void 0:t.call(this)),{method:"POST",headers:[["content-type","application/json"],...(0,c.default)((null===(i=this._getCommonHttpHeaders)||void 0===i?void 0:i.call(this))||{})],body:(0,D.stringifyJSON)({seq_st:(Number(e.chunkSeq)||0)+1,reply_id:e.replyId,binary_type:this._config.binaryType}),credentials:"same-origin",onError:this._handleError,onMessage:this._handleEventSource,openInterceptor:this._handleOpen})}async _handleOpen(e){var t;let i=e.headers.get("content-type");if(!(null==i?void 0:i.startsWith(H.EventStreamContentType)))throw Error(JSON.stringify(await e.json()));if(!(null==e?void 0:e.ok)||!(null==e?void 0:e.body))throw Error(JSON.stringify({msg:`Invalid Response, ResponseStatus: ${e.statusText}`,code:r.ErrorCode.ResponseIsInvalid}));null===(t=this._reporter)||void 0===t||t.addDurationPoint("fetch_stream_open"),this._logId=e.headers.get("x-tt-logid")||""}_handleEventSource(e){let t=async()=>{try{var t,i,n,a,s,o,l,d;let{data:u="",event:c}=e;switch((0,g.default)(null===(i=this._reporter)||void 0===i?void 0:null===(t=i.getDuration())||void 0===t?void 0:t.received_first_chunk_packet_by_sse)&&(null===(n=this._reporter)||void 0===n||n.addDurationPoint("received_first_chunk_packet_by_sse")),c){case"pb":try{let e=A.fromBinary(C.protoBase64.dec(u),{readerFactory:P}).toJson({useProtoFieldName:!0});(0,g.default)(null===(s=this._reporter)||void 0===s?void 0:null===(a=s.getDuration())||void 0===a?void 0:a.decode_first_chunk_packet_by_sse)&&(null===(o=this._reporter)||void 0===o||o.addDurationPoint("decode_first_chunk_packet_by_sse")),await this._handleEvent(e)}catch(e){throw e instanceof Error&&this._handleError({message:e.message,code:r.ErrorCode.StreamParseFailed}),e}return;case"json":await this._handleEvent((0,D.parseJSON)(u,{}));return;case"done":await this._handleFinish(!0),null===(l=this._reporter)||void 0===l||l.addDurationPoint("success"),null===(d=this._reporter)||void 0===d||d.success();return;case"err":await this._handleError({message:u,code:r.ErrorCode.ServerError});break;default:return}}catch(e){this._handleError(e)}};this.pqueue.add(t)}async _handleEvent(e){e.event_type===y.EventType.Message&&await this._batchUpdateMessage(e)}async _batchUpdateMessage(e){var t,i,n,a,r,s,o,l,d,u,c,v;let m=(0,g.default)(null===(i=this._reporter)||void 0===i?void 0:null===(t=i.getDuration())||void 0===t?void 0:t.merge_first_chunk_packet_by_sse),f=!1;if(e.message_list){let t=[];for(let i of e.message_list){let e=await this._mergeMessage(i);(0,g.default)(null===(a=this._reporter)||void 0===a?void 0:null===(n=a.getDuration())||void 0===n?void 0:n.received_first_text_packet_by_sse)&&(0,b.isWiderTextMessage)(e)&&(null===(r=this._reporter)||void 0===r||r.addDurationPoint("received_first_text_packet_by_sse"),f=!0),t.push(e)}let i={...e,message:void 0,message_list:t};m&&(null===(s=this._reporter)||void 0===s||s.addDurationPoint("merge_first_chunk_packet_by_sse")),this._emitEventThrottle([i]),i.message_list.every(e=>{var t;return(null==e?void 0:null===(t=e.ext)||void 0===t?void 0:t.is_finish)==="1"})&&this._emitEventThrottle.flush()}if(e.message){let{message:t}=e,i=await this._mergeMessage(t),n={...e,message_list:void 0,message:i};m&&(null===(c=this._reporter)||void 0===c||c.addDurationPoint("merge_first_chunk_packet_by_sse")),(0,g.default)(null===(l=this._reporter)||void 0===l?void 0:null===(o=l.getDuration())||void 0===o?void 0:o.received_first_text_packet_by_sse)&&(0,b.isWiderTextMessage)(i)&&(null===(v=this._reporter)||void 0===v||v.addDurationPoint("received_first_text_packet_by_sse"),f=!0),this._emitEventThrottle([n]),((null===(u=n.message)||void 0===u?void 0:null===(d=u.ext)||void 0===d?void 0:d.is_finish)==="1"||f)&&this._emitEventThrottle.flush()}}async _mergeMessage(e){var t,i;if(!this._chunkTask)return{...await (0,O.transformAliceChatMessageToMessage)(e),is_delta:!1};let{completionMessageMap:n,replyId:a}=this._chunkTask,{message_id:s}=e||{};n[B.thinkingConstantMessageId]&&delete n[B.thinkingConstantMessageId];let o=s||B.thinkingConstantMessageId,l=null===(t=this._reporter)||void 0===t?void 0:t.getDurationTimestamp(),d=await (0,O.transformAliceChatMessageToMessage)(e,{local_info:{from:r.MessageFrom.AliceChatStream,log_id:this._logId||"",retried:!!(null===(i=this._retryCounter)||void 0===i?void 0:i.attempts),...l}}),u=function(e,t){if(!e)return{...t,is_delta:!1};if(!t)return e;let i=(null==t?void 0:t.status)===K.PushMessageStatus.Broken,n={...e,...t,is_delta:!1};if(e.message_type!==t.message_type||e.content_type!==t.content_type||!t.is_delta)return{...t,is_delta:!1};if((0,W.isThinkingMessage)(t))return t;if(t.is_delta){var a,r,s,o,l,d,u,c,g,v,m,f,h,p,_,y,M;if((0,q.checkIsRemoteMessageLessThenOrEqualToMessageInLocal)(t,e))return e;if(t.content_obj)switch(t.content_type){case K.ContentType.Text:n.content_obj=(o=e.content_obj,l=i?void 0:t.content_obj,{...o,...l,text:((null==o?void 0:o.text)||"")+((null==l?void 0:l.text)||""),think:((null==o?void 0:o.think)||"")+((null==l?void 0:l.think)||"")});break;case K.ContentType.Suggest:n.content_obj=(d=e.content_obj,u=i?void 0:t.content_obj,{suggest:[...null!==(c=null==d?void 0:d.suggest)&&void 0!==c?c:[],...null!==(g=null==u?void 0:u.suggest)&&void 0!==g?g:[]]});break;case K.ContentType.CopilotCard:n.content_obj=(v=e.content_obj,m=i?void 0:t.content_obj,{copilot:[...null!==(f=null==v?void 0:v.copilot)&&void 0!==f?f:[],...null!==(h=null==m?void 0:m.copilot)&&void 0!==h?h:[]]});break;default:n.content_obj=i?e.content_obj:t.content_obj}(null===(a=n.ext)||void 0===a?void 0:a.ref_info_data)&&(n.ext.ref_info_data=function(e,t){if(!e&&!t)return"[]";let i=[],n=[];try{i=e&&"null"!==e?JSON.parse(e):[],n=t&&"null"!==t?JSON.parse(t):[]}catch(e){return J.logger.console.info(`json parse refInfoData error: ${e}`),null!=t?t:"[]"}return JSON.stringify([...i,...n])}(null==e?void 0:null===(r=e.ext)||void 0===r?void 0:r.ref_info_data,null==t?void 0:null===(s=t.ext)||void 0===s?void 0:s.ref_info_data)),n.tts_content=(p=e.tts_content,_=t.tts_content,`${p||""}${_||""}`),n.meta_infos=[...null!=(y=e.meta_infos)?y:[],...null!=(M=i?void 0:t.meta_infos)?M:[]]}return n}(n[o],d)||{...await (0,O.transformAliceChatMessageToMessage)(e),is_delta:!1};return n[o]=u,this.emit("update_task",a,u),u}_handleError(e){var t,i,n,a;let s={message:"string"==typeof e?e:"",code:0};if(e instanceof Error?s={message:e.message,code:r.ErrorCode.FetchFailed}:e&&(s=e),null===(t=this._reporter)||void 0===t||t.error({reason:null==s?void 0:s.message,meta:{error_info:s,log_id:this._logId},error:e}),(null===(i=this._fetchInstance)||void 0===i?void 0:i.isAborted)||(this._emitEventThrottle.flush(),null===(a=this._fetchInstance)||void 0===a||null===(n=a.cancel)||void 0===n||n.call(a),s.code===r.ErrorCode.AbortFetch))return;if(s.code===r.ErrorCode.FetchFailed){this._reFetchStream({message:"",code:0},!1);return}let o=(0,D.parseJSON)(s.message,{}),{code:l}=o;switch(l){case F.ErrorCodes.NETWORK_TIMEOUT:case F.ErrorCodes.MYSQL_ERROR:case F.ErrorCodes.REDIS_ERROR:case F.ErrorCodes.RECORD_NOT_FOUND:this._reFetchStream({message:o.msg,code:o.code});return;default:this._batchEmitErrorMessage({message:o.msg,code:o.code})}}async _reFetchStream(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(this._retryCounter.matchMaxRetryAttempts()){t&&this._batchEmitErrorMessage(e),this._handleFinish();return}this._retryCounter.add(),this._retryCounter.attempts>1&&await this._wait(this._retryCounter.attempts),this._chunkTask&&this._fetchStream(this._chunkTask)}_wait(e){return new Promise(t=>{setTimeout(t,this._getIntervalValue(e))})}_getIntervalValue(e){let{minFetchInterval:t=500,maxFetchInterval:i=5e3,fetchIntervalGrowFactor:n=2}=this._config||{},a=t*Math.pow(n,e-1);return a>i?i:a}_handleFinish(e){e&&this._batchFinishMessage(),this._reset(),this.emit("finish",this.id)}_batchEmitErrorMessage(e){if(!this._chunkTask)return;let{completionMessageMap:t}=this._chunkTask;for(let i of(0,v.default)(t))this.emit("event",function(e,t,i){let n=0x69f6bc7===t.code,a={...null!=e?e:{},error_details:{has_error:!0,error_code:n?_.ErrorCode.Ok:t.code,error_message:t.message,locale:""},local_info:{from:r.MessageFrom.AliceChatStream,log_id:i,finish_reply:!0}};return{event_type:y.EventType.Message,message:a}}(i,e,this._logId||""))}_batchFinishMessage(){if(!this._chunkTask)return;let{completionMessageMap:e}=this._chunkTask;for(let t of(this._emitEventThrottle.flush(),(0,m.default)(e))){let i={...e[t],local_info:{...e[t].local_info||{},finish_reply:!0,from:r.MessageFrom.AliceChatStream}};e[t]=i,this.emit("event",{event_type:y.EventType.Message,message:i})}}_reset(){var e;this.emit("clean",(null===(e=this._chunkTask)||void 0===e?void 0:e.replyId)||""),this._retryCounter.reset(),this._chunkTask=void 0,this.status=$.idle}_init(e){this.status=$.running,this._chunkTask=function(e){let t=(0,h.default)(e),{completionMessageMap:i}=t;for(let[e,t]of(0,c.default)(i))i[e]=(0,p.default)(t,["local","local_message_id"]);return t}(e),this._retryCounter.reset()}get replyId(){var e;return null===(e=this._chunkTask)||void 0===e?void 0:e.replyId}startTask(e){this._init(e),this._fetchStream(e)}abort(){var e,t;this._emitEventThrottle.flush(),null===(t=this._fetchInstance)||void 0===t||null===(e=t.cancel)||void 0===e||e.call(t),this._reset()}constructor(e){super(),this._config=e,G(this,"_retryCounter",void 0),G(this,"_fetchInstance",void 0),G(this,"_reporter",void 0),G(this,"_logId",void 0),G(this,"_chunkTask",void 0),G(this,"_getCommonHttpParams",void 0),G(this,"_getCommonHttpHeaders",void 0),G(this,"_emitEventThrottle",void 0),G(this,"pqueue",new u.default({concurrency:1})),G(this,"id",void 0),G(this,"status",void 0);let{maxRetryAttempts:t,getCommonHttpParams:i,getCommonHttpHeaders:n,chunkInterval:a=500}=this._config;this._retryCounter=new M.RetryCounter(t),this.id=Symbol("eventSourceWorker"),this.status=$.idle,this._handleEvent=this._handleEvent.bind(this),this._handleError=this._handleError.bind(this),this._handleFinish=this._handleFinish.bind(this),this._handleOpen=this._handleOpen.bind(this),this._handleEventSource=this._handleEventSource.bind(this),this._getCommonHttpParams=i,this._getCommonHttpHeaders=n;let r=this.emit.bind(this);this._emitEventThrottle=(0,f.default)(e=>{r("event",...e)},a)}}function Y(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class Q{init(e){var t;if(this._initialed)return;this._initialed=!0;let{getCommonHeaders:i,getCommonParams:n}=null!==(t=(0,d.getFlowApiOptions)())&&void 0!==t?t:{};this._getCommonHttpParams=n,this._getCommonHttpHeaders=i,this._poolSize=(null==e?void 0:e.poolSize)||1,this._maxRetryAttempt=(null==e?void 0:e.retryAttempt)||3,this._binaryType=(null==e?void 0:e.binaryType)||"pb"}sendMessage(e){}_initWorker(){let e=new z({maxRetryAttempts:this._maxRetryAttempt,getCommonHttpParams:this._getCommonHttpParams,getCommonHttpHeaders:this._getCommonHttpHeaders,binaryType:this._binaryType});return e.on("event",this._handleEvent),e.on("finish",this._handleFinish),e.on("clean",this._handleClean),e.on("update_task",this._handleUpdateTask),this._workerMap.set(e.id,e),e}async _handleUpdateTask(e,t){var i;let n=await (0,l.getAsyncChatStore)("aliceChatProtocolStore");null==n||null===(i=n.getState())||void 0===i||i.updateAliceChatStreamTask(e,{...t,is_delta:!1})}async _handleClean(e){var t;let i=await (0,l.getAsyncChatStore)("aliceChatProtocolStore");null==i||null===(t=i.getState())||void 0===t||t.removeAliceChatStreamTask(e)}_handleFinish(e){let t=this._workerMap.get(e);if((null==t?void 0:t.status)===$.idle){let e=this._queue.pop();e&&(null==t||t.startTask(e))}}_handleEvent(e){(0,s.dispatchEvent)(e,this)}_checkMessageInWorking(e){for(let t of this._workerMap.values())if(t.replyId===e)return!0;for(let t of this._queue)if(t.replyId===e)return!0;return!1}async resumeTask(e){let t=await (0,l.getAsyncChatStore)("aliceChatProtocolStore");if(this._initialed||this.init(t.getState().aliceChatStreamInitConfig),this._initialed)for(let t of e){let{replyId:e}=t;if(!e||this._checkMessageInWorking(e))return;this._pullMessage(t)}}async pullMessage(e){var t;let i=await (0,l.getAsyncChatStore)("aliceChatProtocolStore");if(this._initialed||this.init(i.getState().aliceChatStreamInitConfig),!this._initialed)return;let{reply_id:n}=e[0];if(!n||this._checkMessageInWorking(n))return;let a=null==i?void 0:null===(t=i.getState())||void 0===t?void 0:t.createAliceChatStreamTask(n,{...e[0],is_delta:!1});a&&this._pullMessage(a)}_pullMessage(e){for(let t of this._workerMap.values())if(t.status===$.idle){t.startTask(e);return}if(this._workerMap.size<this._poolSize){this._initWorker().startTask(e);return}this._queue.push(e)}cancelTask(e){let t=this._queue.findIndex(t=>t.replyId===e);if(~t){this._queue.splice(t,1),this._handleClean(e);return}for(let t of this._workerMap.values())t.replyId===e&&t.abort()}drop(){for(let e of(this._queue=[],this._workerMap.values()))e.abort()}constructor(){Y(this,"_workerMap",new Map),Y(this,"_poolSize",1),Y(this,"_queue",[]),Y(this,"_maxRetryAttempt",3),Y(this,"_binaryType","pb"),Y(this,"_getCommonHttpParams",void 0),Y(this,"_getCommonHttpHeaders",void 0),Y(this,"_initialed",!1),Y(this,"from",r.MessageFrom.AliceChatStream),Y(this,"eventEmitter",new a.default),this._handleEvent=this._handleEvent.bind(this),this._handleFinish=this._handleFinish.bind(this),this._handleClean=this._handleClean.bind(this),this._handleUpdateTask=this._handleUpdateTask.bind(this),(0,s.subscribeEvent)([this],{message:o.handleMessage})}}},15054:function(e,t,i){i.d(t,{addExtraInfoToAckMessage:function(){return a}});var n=i(458524);function a(e){return e.message_type===n.MessageType.Ack&&(e.user_type||(e.user_type=n.UserType.Human),e.ext?e.ext.is_finish="1":e.ext={is_finish:"1"}),e}},240485:function(e,t,i){i.r(t),i.d(t,{initAliceChatProtocolStore:function(){return v}});var n=i(952259),a=i(321647),r=i(266655),s=i(459735),o=i(746479),l=i(645298),d=i(191360);let u=e=>({aliceChatStreamTaskMap:e.aliceChatStreamTaskMap}),c=(e,t)=>({aliceChatStreamTaskMap:{},aliceChatFallbackInitConfig:{},aliceChatStreamInitConfig:{},updateAliceChatStreamTask:(i,n)=>(e((0,o.produce)(e=>{let t=e.aliceChatStreamTaskMap[i];if(t){let{completionMessageMap:e}=t;e[n.message_id||l.thinkingConstantMessageId]=n}})),t().aliceChatStreamTaskMap[i]),createAliceChatStreamTask(i,n){let a=t().aliceChatStreamTaskMap[i];return a||(e((0,o.produce)(e=>{if(i){let{message_id:t}=n,a={createTime:Date.now(),chunkSeq:Number((null==n?void 0:n.chunk_seq)||0),replyId:i,conversationId:(null==n?void 0:n.conversation_id)||"",completionMessageMap:{[t||l.thinkingConstantMessageId]:n}};e.aliceChatStreamTaskMap[i]=a}})),t().aliceChatStreamTaskMap[i])},removeAliceChatStreamTask(t){e((0,o.produce)(e=>{delete e.aliceChatStreamTaskMap[t]}))}}),g=(e,t)=>{var i;let n={...t,...e||{}};return(null===(i=(0,r.default)(n.aliceChatStreamTaskMap))||void 0===i?void 0:i.length)?{...n,aliceChatStreamTaskMap:(0,s.default)(n.aliceChatStreamTaskMap,e=>Date.now()-e.createTime>3e5)}:n},v=async e=>{let{prefix:t,isEnableDebug:i,reduxDevToolsSnapshot:r,merge:s,partialize:o,storage:l}=e,v=(0,d.createPersistOptions)({name:"chat-alice-chat-protocol-store",prefix:t||"default",version:1.5,partialize:null!=o?o:u,storage:l,merge:null!=s?s:g}),m=(0,n.persist)((0,n.subscribeWithSelector)(c),v);if(i&&r){let e=(0,a.create)()((0,n.devtools)(m,{name:`${t}-chat-samantha-chat-protocol-store`}));return e.persist.hasHydrated()?e:await new Promise(t=>e.persist.onFinishHydration(i=>{t(e)}))}{let e=(0,a.create)()(m);return e.persist.hasHydrated()?e:await new Promise(t=>e.persist.onFinishHydration(i=>{t(e)}))}}},71231:function(e,t,i){i.r(t),i.d(t,{defaultReceiveMessageBottomPluginMatcher:function(){return n}});let n={pluginIdentifier:i(947638).defaultReceiveMessageBottomPluginIdentifier,matchPlugin:e=>!0}},283477:function(e,t,i){i.r(t),i.d(t,{DefaultReceiveMessageBottomPlugin:function(){return o}});var n=i(947638),a=i(345660);function r(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let s=e=>{let{suggestList:t,actionBarComponentNode:i}=e,{suggestListComponentNode:n}=t||{};return(0,a.jsxs)(a.Fragment,{children:[i,n]})};class o{constructor(){r(this,"pluginIdentifier",n.defaultReceiveMessageBottomPluginIdentifier),r(this,"Content",s)}}},473768:function(e,t,i){i.r(t),i.d(t,{defaultSendMessageBottomPluginMatcher:function(){return n}});let n={pluginIdentifier:i(762873).defaultSendMessageBottomPluginIdentifier,matchPlugin:e=>!0}},388098:function(e,t,i){i.r(t),i.d(t,{DefaultSendMessageBottomPlugin:function(){return o}});var n=i(762873),a=i(345660);function r(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let s=e=>{let{actionBarComponentNode:t}=e;return(0,a.jsx)(a.Fragment,{children:t})};class o{constructor(){r(this,"pluginIdentifier",n.defaultSendMessageBottomPluginIdentifier),r(this,"Content",s)}}},210716:function(e,t,i){i.r(t),i.d(t,{defaultReceiveMessageBoxPluginMatcher:function(){return n}});let n={pluginIdentifier:i(67769).defaultReceiveMessageBoxPluginIdentifier,matchPlugin:e=>!0}},394990:function(e,t,i){i.r(t),i.d(t,{defaultSendMessageBoxPluginMatcher:function(){return n}});let n={pluginIdentifier:i(746376).defaultSendMessageBoxPluginIdentifier,matchPlugin:e=>!0}},981697:function(e,t,i){i.r(t),i.d(t,{DefaultSendMessageBoxPlugin:function(){return c}});var n=i(713738),a=i(667018),r=i(459046),s=i(915299),o=i(746376),l=i(345660);function d(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let u=e=>{var t;let{message:i}=e;return(0,n.useEffect)(()=>{(0,r.reportMessageShowError)({message:i,reason:"message_fallback_content",from:"message_fallback_content"})},[]),(0,l.jsx)(a.BubbleTextContent,{text:(null==i?void 0:null===(t=i.ext)||void 0===t?void 0:t.default_display_content)||(0,s.getUnreactiveTranslate)("chat_unsupported_message_type")})};class c{constructor(){d(this,"pluginIdentifier",o.defaultSendMessageBoxPluginIdentifier),d(this,"Content",u)}}},984652:function(e,t,i){i.r(t),i.d(t,{mobileRefSendMessageBoxPluginMatcher:function(){return a}});var n=i(629006);let a={pluginIdentifier:i(204573).mobileRefSendMessageBoxPluginIdentifier,matchPlugin:e=>(0,n.isMobileRefSendMessage)(e)}},396995:function(e,t,i){i.r(t),i.d(t,{MobileRefSendMessageBoxPlugin:function(){return f}});var n=i(229079),a=i(812650),r=i.n(a),s=i(634713),o=i(667018),l=i(47405),d=i(847857),u=i(915299),c=i(204573),g=i(345660);function v(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let m=e=>{var t,i;let{message:a,theme:c="samantha"}=e,v=(0,n.default)(a,"reference_info.display_content");return(0,g.jsxs)("div",{className:"flex flex-col items-end max-w-[var(--self-message-box-max-width,450px)]",children:[(0,g.jsx)(s.RefContentNode,{className:"mb-8 max-w-full",text:v||"",allowMultiLine:!0}),(0,g.jsx)(o.BubbleTextContent,{className:r()(null===(t=l.messageShareThemeCss[c])||void 0===t?void 0:t.sendClassNames),style:l.messageShareThemeCss[c].cssVar,text:(0,d.getMessageText)(a,!1,(null==a?void 0:null===(i=a.ext)||void 0===i?void 0:i.default_display_content)||(0,u.getUnreactiveTranslate)("chat_unsupported_message_type"))})]})};class f{constructor(){v(this,"pluginIdentifier",c.mobileRefSendMessageBoxPluginIdentifier),v(this,"Content",m)}}},205807:function(e,t,i){i.r(t),i.d(t,{textReceiveMessageBoxPluginMatcher:function(){return a}});var n=i(629006);let a={pluginIdentifier:i(65775).textReceiveMessageBoxPluginIdentifier,matchPlugin:e=>!(0,n.isUGCBotConversation)(e)&&(0,n.isWiderTextMessage)(e)}},166265:function(e,t,i){i.r(t),i.d(t,{TextReceiveMessageBoxPlugin:function(){return l}}),i(713738);var n=i(65775),a=i(535373),r=i(345660);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let o=e=>{let{inView:t,message:i}=e;return(0,r.jsx)(a.DefaultReceiveMessageBox,{inView:t,message:i,messageBlockText:void 0,messageBlockTextFinish:void 0,messageBlockTextBroken:void 0})};class l{constructor(){s(this,"pluginIdentifier",n.textReceiveMessageBoxPluginIdentifier),s(this,"Content",o)}}},906131:function(e,t,i){i.r(t),i.d(t,{textSendMessageBoxPluginMatcher:function(){return a}});var n=i(629006);let a={pluginIdentifier:i(904303).textSendMessageBoxPluginIdentifier,matchPlugin:e=>(0,n.isWiderTextMessage)(e)}},595007:function(e,t,i){i.r(t),i.d(t,{thinkingReceiveMessageBoxPluginMatcher:function(){return r}});var n=i(629006),a=i(674157);let r={pluginIdentifier:i(738402).thinkingReceiveMessageBoxPluginIdentifier,matchPlugin:e=>{let t=(0,n.isInSearchLoading)(e)||(0,n.isDeepSearchLoading)(e)||(0,n.isAcademicSearchLoading)(e)||(0,n.isWritingOutlineSearchLoading)(e);return(0,a.isThinkingMessage)(e)&&!t||(0,n.isMockLocalReplyMessage)(e)}}},330901:function(e,t,i){i.r(t),i.d(t,{ThinkingReceiveMessageBoxPlugin:function(){return d}});var n=i(629006),a=i(278960),r=i(738402),s=i(345660);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let l=e=>{let{message:t}=e;return(0,n.isMessageFailed)(t)?null:(0,s.jsx)("div",{className:"w-full pb-40",children:(0,s.jsx)(a.ThinkingFlahsing,{message:t})})};class d{constructor(){o(this,"pluginIdentifier",r.thinkingReceiveMessageBoxPluginIdentifier),o(this,"Content",l)}}},229748:function(e,t,i){i.r(t),i.d(t,{asyncFetchMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(416255).asyncFetchMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.MessageUpdate}},82084:function(e,t,i){i.r(t),i.d(t,{AsyncFetchMessageCmdPlugin:function(){return g}});var n=i(217957),a=i(101874),r=i(800477),s=i(472667),o=i(796349),l=i(178230),d=i(416255);function u(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}async function c(e,t){var i;let{data:n}=await (await (0,s.getMessageApiClient)()).getMessageListByIndexList({conversation_id:e,message_index_list:[t]});if(null==n?void 0:null===(i=n.message_list)||void 0===i?void 0:i.length){let{message_list:e}=n;return e[0]}}class g{constructor(){u(this,"pluginIdentifier",d.asyncFetchMessageCmdPluginIdentifier),u(this,"handleCmd",async e=>{if("1.0"===e.data.version){let{conversation_id:t,message_id:i,index:s}=e.data.data;if(l.logger.persist.info({message:"Cmd: MessageUpdate",meta:{conversation_id:t,message_id:i,index:s}}),!t||!i||(0,n.default)(s))return;let d=await c(t,s);if(!d)return;let u={...await (0,r.transformAliceChatMessageToMessage)(d,{local_info:{finish_reply:!0,from:a.MessageFrom.AsyncFetch}}),is_delta:!1,message_id:i,conversation_id:t};(0,o.handleUpdateMessage)(u)}})}}},345901:function(e,t,i){i.r(t),i.d(t,{clearContextMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(149059).clearContextMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.PushToast}},428873:function(e,t,i){i.r(t),i.d(t,{ClearContextMessageCmdPlugin:function(){return l}});var n=i(47563),a=i(178230),r=i(149059),s={clearContextToast:"clear-context-toast-TxNUmy"};function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",r.clearContextMessageCmdPluginIdentifier),o(this,"handleCmd",e=>{if("1.0"===e.data.version){var t,i;let{conversation_id:r}=e.data.data;a.logger.persist.info({message:"Cmd: PushToast",meta:{conversation_id:r}}),(null===(t=e.data.data.ext)||void 0===t?void 0:t.toast)&&n.Toast.warning({showClose:!1,content:null===(i=e.data.data.ext)||void 0===i?void 0:i.toast,className:s.clearContextToast})}})}}},502892:function(e,t,i){i.r(t),i.d(t,{conversationAddMessageCmdPluginMatcher:function(){return r}});var n=i(307481),a=i(722038);let r={pluginIdentifier:i(411469).conversationAddMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===a.CmdType.ConversationAdd||e.cmd===n.IMCMD.UPDATE_CONVERSATION_PARTICIPANT_NOTIFY}},547195:function(e,t,i){i.r(t),i.d(t,{ConversationAddMessageCmdPlugin:function(){return d}});var n=i(82760),a=i(230932),r=i(645298),s=i(178230),o=i(411469);function l(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class d{constructor(){l(this,"pluginIdentifier",o.conversationAddMessageCmdPluginIdentfier),l(this,"handleCmd",async e=>{let{version:t,data:i}=e.data;if("2.0"===t){let{conversation_id:e="",operate_type:t}=i.update_conv_participant_notify||{};if(s.logger.persist.info({message:"Cmd: ConversationAdd",meta:{conversation_id:e}}),t===n.UpdateConversationParticipantType.OPERATE_CONVERSATION_PARTICIPANT_CREATE_CONV)try{await a.useFeedStore.getState().fetchUpdateConversationInfo(e,"ConversationUpdateCmd"),a.useFeedStore.getState().loadOverallList({size:r.REFRESH_CHAT_CONVERSATION_COUNT,isRefresh:!0})}catch(e){e instanceof Error&&s.logger.persist.error({message:"ConversationUpdate failed",error:e})}}})}}},665171:function(e,t,i){i.r(t),i.d(t,{conversationArchiveMessageCmdPluginMatcher:function(){return r}});var n=i(307481),a=i(722038);let r={pluginIdentifier:i(58405).conversationArchiveMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===a.CmdType.ConversationArchive||e.cmd===n.IMCMD.DELETE_USER_CONVERSATION_NOTIFY}},929468:function(e,t,i){i.r(t),i.d(t,{ConversationArchiveMessageCmdPlugin:function(){return l}});var n=i(82760),a=i(230932),r=i(178230),s=i(58405);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",s.conversationArchiveMessageCmdPluginIdentfier),o(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t=""}=e.data.data||{};r.logger.persist.info({message:"Cmd: ConversationArchive",meta:{conversation_id:t}});let i=a.useFeedStore.getState();i.removeConversationFromMap({conversationId:t}),i.removeConversationFromLinks({conversationId:t}),i.markLatestArchivedConversationId(t)}if("2.0"===e.data.version){let{conversation_id:t="",mode:i}=e.data.data.delete_user_conversation_notify||{};if(r.logger.persist.info({message:"Cmd: ConversationArchive",meta:{conversation_id:t,mode:i}}),i===n.DeleteMode.DeleteMode_RealDelete){let e=a.useFeedStore.getState();e.removeConversationFromMap({conversationId:t}),e.removeConversationFromLinks({conversationId:t}),e.markLatestArchivedConversationId(t)}}})}}},304162:function(e,t,i){i.r(t),i.d(t,{conversationClearHistoryMessageCmdPluginMatcher:function(){return r}});var n=i(307481),a=i(722038);let r={pluginIdentifier:i(998426).conversationClearHistoryMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===a.CmdType.ConversationClearHistory||e.cmd===n.IMCMD.CLEAR_MSG_HISTORY_NOTIFY}},852140:function(e,t,i){i.r(t),i.d(t,{ConversationClearHistoryMessageCmdPlugin:function(){return l}});var n=i(680982),a=i(83990),r=i(178230),s=i(998426);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",s.conversationClearHistoryMessageCmdPluginIdentifier),o(this,"handleCmd",async e=>{if("1.0"===e.data.version){let{conversation_id:t=""}=e.data.data||{};r.logger.persist.info({message:"Cmd: ConversationClear",meta:{conversation_id:t}}),await (0,n.handleLocalBreak)(a.useMessageStore,t),a.useMessageStore.getState().clearConversationMessages(t)}if("2.0"===e.data.version){var t,i;let{conversation_id:s="",clear_message_index:o}=(null==e?void 0:null===(i=e.data)||void 0===i?void 0:null===(t=i.data)||void 0===t?void 0:t.clear_msg_history_notify)||{};r.logger.persist.info({message:"Cmd: ConversationClear",meta:{conversation_id:s,clear_message_index:o}}),await (0,n.handleLocalBreak)(a.useMessageStore,s),a.useMessageStore.getState().clearConversationMessages(s)}})}}},50422:function(e,t,i){i.r(t),i.d(t,{conversationCreateSectionMessageCmdPluginMatcher:function(){return r}});var n=i(307481),a=i(722038);let r={pluginIdentifier:i(939965).conversationCreateSectionMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===a.CmdType.ConversationCreateSection||e.cmd===n.IMCMD.CLEAR_MSG_CONTEXT_NOTIFY}},883844:function(e,t,i){i.r(t),i.d(t,{ConversationCreateSectionMessageCmdPlugin:function(){return o}});var n=i(230932),a=i(178230),r=i(939965);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.conversationCreateSectionMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){var t,i,r,s,o,l;let{conversation_id:d=""}=e.data.data||{};a.logger.persist.info({message:"Cmd: ConversationCreateSection",meta:{conversation_id:d,section_id:null===(i=e.data.data)||void 0===i?void 0:null===(t=i.ext)||void 0===t?void 0:t.section_id}}),(null===(s=e.data.data)||void 0===s?void 0:null===(r=s.ext)||void 0===r?void 0:r.section_id)&&n.useFeedStore.getState().updateLastSectionId(d,null===(l=e.data.data)||void 0===l?void 0:null===(o=l.ext)||void 0===o?void 0:o.section_id)}if("2.0"===e.data.version){let{conversation_id:t="",new_section_id:i}=e.data.data.clear_msg_context_notify||{};a.logger.persist.info({message:"Cmd: ConversationCreateSection",meta:{conversation_id:t,new_section_id:i}}),i&&n.useFeedStore.getState().updateLastSectionId(t,i)}})}}},301056:function(e,t,i){i.r(t),i.d(t,{conversationOperateMessageCmdPluginMatcher:function(){return a}});var n=i(307481);let a={pluginIdentifier:i(906050).conversationOperateMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.IMCMD.OPERATE_CONVERSATION_NOTIFY}},836629:function(e,t,i){i.r(t),i.d(t,{ConversationOperateMessageCmdPlugin:function(){return l}});var n=i(82760),a=i(230932),r=i(178230),s=i(906050);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",s.conversationOperateMessageCmdPluginIdentfier),o(this,"handleCmd",e=>{if("2.0"===e.data.version){var t,i,s;let{conversation_id:o="",operate_type:l}=e.data.data.operate_conv_notify||{};if(r.logger.persist.info({message:"Cmd: ConversationOperate",meta:{conversation_id:o,operate_type:l}}),l===n.ConvOperateType.TOP){if(null===(t=a.useFeedStore.getState().conversationMap[o])||void 0===t?void 0:t.pinned)return;try{a.useFeedStore.getState().insertConversationToLinks({conversationId:o,index:1,pinOperation:!0})}catch(e){e instanceof Error&&r.logger.persist.error({message:"ConversationOperate failed",error:e})}}if(l===n.ConvOperateType.CANCEL_TOP){if(!(null===(s=a.useFeedStore.getState().conversationMap)||void 0===s?void 0:null===(i=s[o])||void 0===i?void 0:i.pinned))return;try{a.useFeedStore.getState().insertConversationToLinks({conversationId:o,index:1,pinOperation:!0})}catch(e){e instanceof Error&&r.logger.persist.error({message:"ConversationOperate failed",error:e})}}}})}}},712127:function(e,t,i){i.r(t),i.d(t,{conversationReadMessageCmdPluginMatcher:function(){return r}});var n=i(307481),a=i(722038);let r={pluginIdentifier:i(185401).conversationReadMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===a.CmdType.ConversationRead||e.cmd===n.IMCMD.MARK_READ_NOTIFY}},504997:function(e,t,i){i.r(t),i.d(t,{ConversationReadMessageCmdPlugin:function(){return o}});var n=i(230932),a=i(178230),r=i(185401);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.conversationReadMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t,ext:{read_message_index:i,message_index:r,conversation_id:s=t||""}={}}=e.data.data;a.logger.persist.info({message:"Cmd: ConversationRead",meta:{conversation_id:s,read_message_index:i,message_index:r}}),i&&r&&n.useFeedStore.getState().updateConversationMessageIndex({conversationId:s,readMessageIndex:Number(i),messageIndex:Number(r)})}if("2.0"===e.data.version){let{conversation_id:t,badge_count:i,read_badge_count:r}=e.data.data.mark_read_notify||{};a.logger.persist.info({message:"Cmd: ConversationRead",meta:{conversation_id:t,badge_count:i,read_badge_count:r}}),t&&i&&r&&n.useFeedStore.getState().updateConversationMessageIndex({conversationId:t,badgeCount:Number(i),readBadgeCount:Number(r)})}})}}},486285:function(e,t,i){i.r(t),i.d(t,{conversationRedDotUpdateMessageCmdPluginMatcher:function(){return a}});var n=i(307481);let a={pluginIdentifier:i(506747).conversationRedDotUpdateMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.IMCMD.RED_DOT_NOTIFY}},190494:function(e,t,i){i.r(t),i.d(t,{ConversationRedDotUpdateMessageCmdPlugin:function(){return o}});var n=i(230932),a=i(178230),r=i(506747);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.conversationRedDotUpdateMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("2.0"===e.data.version){let{conversation_id:t,badge_count:i,read_badge_count:r}=e.data.data.red_dot_notify||{};a.logger.persist.info({message:"Cmd: ConversationRedDotUpdate",meta:{conversation_id:t,badge_count:i,read_badge_count:r}}),t&&i&&r&&n.useFeedStore.getState().updateConversationMessageIndex({conversationId:t,badgeCount:Number(i),readBadgeCount:Number(r)})}})}}},974027:function(e,t,i){i.r(t),i.d(t,{conversationUpdateNameMessageCmdPluginMatcher:function(){return a}});var n=i(307481);let a={pluginIdentifier:i(772409).conversationUpdateNameMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.IMCMD.UPDATE_CONVERSATION_NAME_NOTIFY}},776547:function(e,t,i){i.r(t),i.d(t,{ConversationUpdateMessageCmdPlugin:function(){return o}});var n=i(230932),a=i(178230),r=i(185401);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.conversationReadMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("2.0"===e.data.version){let{conversation_id:t,conversation_name:i}=e.data.data.update_conversation_name_notify||{};if(a.logger.persist.info({message:"Cmd: ConversationUpdateName",meta:{conversation_id:t}}),t&&i)try{n.useFeedStore.setState(e=>(e.conversationMap[t]&&(e.conversationMap[t].name=i),e))}catch(e){e instanceof Error&&a.logger.persist.error({message:"ConversationUpdateName failed",error:e})}}})}}},146656:function(e,t,i){i.r(t),i.d(t,{conversationUpdateMessageCmdPluginMatcher:function(){return r}});var n=i(307481),a=i(722038);let r={pluginIdentifier:i(144945).conversationUpdateMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===a.CmdType.ConversationUpdate||e.cmd===n.IMCMD.UPDATE_CONVERSATION_INFO_NOTIFY}},847055:function(e,t,i){i.r(t),i.d(t,{ConversationUpdateMessageCmdPlugin:function(){return l}});var n=i(230932),a=i(645298),r=i(178230),s=i(185401);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",s.conversationReadMessageCmdPluginIdentfier),o(this,"handleCmd",async e=>{if("1.0"===e.data.version){let{conversation_id:t=""}=e.data.data||{};r.logger.persist.info({message:"Cmd: ConversationUpdate",meta:{conversation_id:t}});try{await n.useFeedStore.getState().fetchUpdateConversationInfo(t,"ConversationUpdateCmd")}catch(e){e instanceof Error&&r.logger.persist.error({message:"ConversationUpdate failed",error:e})}}if("2.0"===e.data.version){let{conversation_info:t}=e.data.data.update_conv_info_notify||{},{conversation_id:i=""}=t||{};if(r.logger.persist.info({message:"Cmd: ConversationUpdate",meta:{conversation_id:i}}),t)try{n.useFeedStore.getState().updateConversationInfo(t),n.useFeedStore.getState().loadOverallList({size:a.REFRESH_CHAT_CONVERSATION_COUNT,isRefresh:!0})}catch(e){e instanceof Error&&r.logger.persist.error({message:"ConversationUpdate failed",error:e})}}})}}},928494:function(e,t,i){i.r(t),i.d(t,{mailboxActivatedMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(502136).mailboxActivatedMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.MailboxActivated}},233054:function(e,t,i){i.r(t),i.d(t,{MailboxActivatedMessageCmdPlugin:function(){return g}});var n=i(921219),a=i(777422),r=i(915299),s=i(996776),o=i(178230),l=i(502136),d={securityEncryptedNotifyModal:"security-encrypted-notify-modal-mvDNkM"},u=i(345660);function c(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class g{constructor(){c(this,"pluginIdentifier",l.mailboxActivatedMessageCmdPluginIdentifier),c(this,"handleCmd",e=>{"1.0"===e.data.version&&(o.logger.persist.info({message:"Cmd: MailboxActivated"}),"visible"===document.visibilityState&&(s.default.destroyAll(),s.default.info({className:d.securityEncryptedNotifyModal,title:(0,r.getUnreactiveTranslate)("settings_encryption_popupTitle_encryptionOn"),content:(0,r.getUnreactiveTranslate)("settings_encryption_popupDesc_encryptionOn"),okText:(0,r.getUnreactiveTranslate)("settings_encryption_popupBtn_ok"),centered:!0,icon:(0,u.jsx)(n.default,{}),footerFill:!0,closable:!1,hasCancel:!1,onOk:()=>{s.default.destroyAll(),(0,a.trackEvent)("privacy_mode_popup_click")}}),(0,a.trackEvent)("privacy_mode_popup_show")))})}}},28773:function(e,t,i){i.r(t),i.d(t,{messageDeleteMessageCmdPluginMatcher:function(){return a}});var n=i(307481);let a={pluginIdentifier:i(312131).messageDeleteMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.IMCMD.UPDATE_MSG_STATUS_NOTIFY}},65030:function(e,t,i){i.r(t),i.d(t,{MessageDeleteMessageCmdPlugin:function(){return u}});var n=i(266655),a=i(82760),r=i(83990),s=i(458524),o=i(178230),l=i(312131);function d(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class u{constructor(){d(this,"pluginIdentifier",l.messageDeleteMessageCmdPluginIdentfier),d(this,"handleCmd",e=>{if("2.0"===e.data.version){let{conversation_id:t="",message_body_list:i}=e.data.data.update_msg_status_notify||{};for(let e of(o.logger.persist.info({message:"Cmd: MessageDelete",meta:{conversation_id:t,message_body_list:i}}),(0,n.default)(i)))r.useMessageStore.getState().createUpdateMessageList(t)(t=>{let i=t.draftMessageMap;e.status&&(e.status===a.MessageStatus.MessageStatus_INVISIBLE||e.status===a.MessageStatus.MessageStatus_DELETED||e.status===a.MessageStatus.MessageStatus_NOT_EXIST||e.status===a.MessageStatus.MessageStatus_BEFOREEDIT||e.status===a.MessageStatus.MessageStatus_PLACE_HOLD)&&i[e.message_id]&&(i[e.message_id].status=s.PushMessageStatus.InVisible)})}})}}},69925:function(e,t,i){i.r(t),i.d(t,{messageFeedbackMessageCmdPluginMatcher:function(){return a}});var n=i(307481);let a={pluginIdentifier:i(549049).messageFeedbackMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.IMCMD.FEEDBACK_MSG_NOTIFY}},988018:function(e,t,i){i.r(t),i.d(t,{MessageFeedbackMessageCmdPlugin:function(){return l}});var n=i(83990),a=i(178230),r=i(549049),s=i(165482);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",r.messageFeedbackMessageCmdPluginIdentfier),o(this,"handleCmd",e=>{if("2.0"===e.data.version){let{extra:t="",message_id:i="",feedback_type:r,feedback_detail_type:o,feedback_detail_content:l}=e.data.data.feedback_msg_notify||{},{conversation_id:d=""}=(0,s.parseJSON)(t,{});a.logger.persist.info({message:"Cmd: MessageFeedback",meta:{conversation_id:d,message_id:i,feedback_type:r,feedback_detail_type:o,feedback_detail_content:l}}),n.useMessageStore.getState().updateMessageFeedbackStore({conversationId:d,messageId:i,detail:{feedback_type:r,feedback_detail_type:o,feedback_detail_content:l}})}})}}},712473:function(e,t,i){i.r(t),i.d(t,{messageNotCompliantMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(541078).messageNotCompliantMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.MessageNotCompliant}},601620:function(e,t,i){i.r(t),i.d(t,{MessageNotCompliantMessageCmdPlugin:function(){return m}});var n=i(695422),a=i(83990),r=i(745829),s=i(239705),o=i(637319),l=i(922851),d=i(645298),u=i(458524),c=i(178230),g=i(541078);function v(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class m{constructor(){v(this,"pluginIdentifier",g.messageNotCompliantMessageCmdPluginIdentifier),v(this,"handleCmd",e=>{if("1.0"===e.data.version){let{local_message_id:t,conversation_id:i,message_id:g}=e.data.data;c.logger.persist.info({message:"Cmd: MessageNotCompliant",meta:{conversation_id:i,message_id:g,local_message_id:t}}),i&&((0,l.getChatService)("chatInputStoreService").then(e=>{null==e||e.updateSendMessageStatus(i,n.ChatInputSendMessageStatus.Default)}),a.useMessageStore.getState().updateMessageList({conversationId:i,immerUpdate:e=>{let{draftLocalMessageMap:n,draftMessageMap:l}=e,c=u.PushMessageStatus.NotCompliant;if(t&&n[t]&&(n[t].status=c,(0,r.deleteLocalReceivingMessage)(e,d.mockReplyConstantMessageId),(0,s.abortPullMessage)({localMessageId:t})),g){let t=(0,o.getMessageSelector)(a.useMessageStore.getState(),i,{isLocalMessage:!1,messageId:g});l[g]&&(l[g].status=c),(0,s.abortPullMessage)({replyId:g,localMessageId:null==t?void 0:t.local_message_id}),(0,r.deleteLocalReplyMessageByReplyId)(e,g),(0,r.deleteMessageInLocalMessageMapByReplyId)(e,g)}}}))}})}}},416579:function(e,t,i){i.r(t),i.d(t,{mobileMessageSyncMessageCmdPluginMatcher:function(){return a}});var n=i(307481);let a={pluginIdentifier:i(939078).mobileMessageSyncMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.IMCMD.PULL_MSG_NOTIFY}},249934:function(e,t,i){i.r(t),i.d(t,{MobileMessageSyncMessageCmdPlugin:function(){return d}});var n=i(83990),a=i(628338),r=i(198660),s=i(178230),o=i(939078);function l(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class d{constructor(){l(this,"pluginIdentifier",o.mobileMessageSyncMessageCmdPluginIdentifier),l(this,"handleCmd",e=>{if("2.0"===e.data.version){let{conversation_id:t,message_index:i,limit:o,ext:l}=e.data.data.pull_msg_notify||{};if(s.logger.persist.info({message:"Cmd: MobileMessageSync",meta:{conversation_id:t,message_index:i,limit:o}}),t){let e=(0,r.getIsLoggedIn)(),i={pull_single_chain_scene:(null==l?void 0:l.pull_single_chain_scene)||""};n.useMessageStore.getState().initMessageList({conversationId:t,messageIndex:Number.MAX_SAFE_INTEGER,isGuest:!e,hasPreprocessTask:a.hasPreprocessTask,v2ApiExt:i})}}})}}},224385:function(e,t,i){i.r(t),i.d(t,{nestedMessageStateChangeMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(836670).nestedMessageStateChangeMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.NestedMessageStateChange}},800067:function(e,t,i){i.r(t),i.d(t,{NestedMessageStateChangeMessageCmdPlugin:function(){return h}});var n=i(159738),a=i(266655),r=i(83990),s=i(922851),o=i(698392),l=i(212183),d=i(777422),u=i(524129),c=i(165482),g=i(949932),v=i(178230),m=i(836670);function f(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class h{constructor(){f(this,"pluginIdentifier",m.nestedMessageStateChangeMessageCmdPluginIdentifier),f(this,"handleCmd",e=>{if("1.0"===e.data.version){var t;let{ext:i}=e.data.data,{conversation_id:m,local_message_id:f,update_entity_state_list:h=[]}=(0,c.parseJSON)(null==i?void 0:i.body,{});if(v.logger.persist.info({message:"Cmd: NestedMessageStateChange",meta:{conversation_id:m,update_entity_state_list:h,local_message_id:f}}),!m||!f||!(null==h?void 0:h.length))return;h.forEach(e=>{let t=e.identifier;(0,n.default)(e.update_fields,2)&&(0,s.getChatService)("attachmentUploadStoreService").then(i=>{null==i||i.updateAttachmentParseState(t,e.parse_state)}),(0,n.default)(e.update_fields,1)&&(0,s.getChatService)("attachmentUploadStoreService").then(i=>{null==i||i.updateAttachmentReviewState(t,e.review_state)})});let p=null===(t=(0,o.getChatSlice)("chatViewCoreStore").currentChatViewConfig)||void 0===t?void 0:t.chatId;p&&r.useMessageStore.getState().updateMessageList({conversationId:p,immerUpdate:e=>{let{draftMessageMap:t,draftMessageLinks:i}=e,r=i.find(e=>e.messageKey===f);r&&(r.messageKey=`${r.messageId}_invalid`);let s=(0,a.default)(t).find(e=>e.local_message_id===f);h.forEach(e=>{var t,i;let a=null==s?void 0:null===(t=s.attachments)||void 0===t?void 0:t.find(t=>{var i;return(t.identifier||(null===(i=s.local_info)||void 0===i?void 0:i.local_key))===e.identifier});a&&((0,n.default)(e.update_fields,2)&&(a.file_parse_state=e.parse_state,(0,d.trackEvent)("upload_parse_status",{status:0,error_code:"parse_failed",conversation_id:m,chat_type:(0,l.getChatTypeForTea)("",m,(0,l.getInfoByConversationId)(m).botInfo),skill_name:u.SkillType.ReadPDF.toString(),skill_id:"6",upload_id:null==s?void 0:s.local_message_id,upload_collection_way:((null==s?void 0:null===(i=s.attachments)||void 0===i?void 0:i.length)||0)>1?"multi":"single",upload_type:"Image"===(0,g.getFileType)(a.name||"")?"pic":"pdf",upload_file_type:(0,g.getFileType)((0,g.getFileExt)(a.name||"")),upload_file_size:String(a.size)})),(0,n.default)(e.update_fields,1)&&(a.file_review_state=e.review_state))})}})}})}}},834717:function(e,t,i){i.r(t),i.d(t,{onboardingBeginMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(709416).onboardingBeginMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.CmdType.OnboardingBegin}},189242:function(e,t,i){i.r(t),i.d(t,{OnboardingBeginMessageCmdPlugin:function(){return o}});var n=i(83990),a=i(178230),r=i(709416);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.onboardingBeginMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t=""}=e.data.data||{};a.logger.persist.info({message:"Cmd: OnboardingBegin",meta:{conversation_id:t}}),n.useMessageStore.getState().initOnboarding({conversationId:t})}})}}},772543:function(e,t,i){i.r(t),i.d(t,{onboardingCancelMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(511520).onboardingCancelMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.CmdType.OnboardingCancel}},214633:function(e,t,i){i.r(t),i.d(t,{OnboardingCancelMessageCmdPlugin:function(){return o}});var n=i(83990),a=i(178230),r=i(511520);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.onboardingCancelMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t=""}=e.data.data||{};a.logger.persist.info({message:"Cmd: OnboardingCancel",meta:{conversation_id:t}}),n.useMessageStore.getState().cancelOnboarding({conversationId:t})}})}}},916653:function(e,t,i){i.r(t),i.d(t,{onboardingFailMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(889052).onboardingFailMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.CmdType.OnboardingFail}},850055:function(e,t,i){i.r(t),i.d(t,{OnboardingFailMessageCmdPlugin:function(){return o}});var n=i(83990),a=i(178230),r=i(889052);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.onboardingFailMessageCmdPluginIdentfier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t=""}=e.data.data||{};a.logger.persist.info({message:"Cmd: OnboardingFail",meta:{conversation_id:t}}),n.useMessageStore.getState().cancelOnboarding({conversationId:t})}})}}},623691:function(e,t,i){i.r(t),i.d(t,{refImagesMessageStateChangeMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(867640).refImagesMessageStateChangeMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.MessageRefImagesNotCompliant}},696153:function(e,t,i){i.r(t),i.d(t,{RefImagesMessageStateChangeMessageCmdPlugin:function(){return u}});var n=i(266655),a=i(83990),r=i(922851),s=i(722038),o=i(165482),l=i(867640);function d(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class u{constructor(){d(this,"pluginIdentifier",l.refImagesMessageStateChangeMessageCmdPluginIdentifier),d(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t,local_message_id:i,ext:l}=e.data.data,{review_not_pass_ref_images:d}=(0,o.parseJSON)(null==l?void 0:l.body,{});t&&i&&(null==d?void 0:d.length)&&(d.forEach(e=>{(0,r.getChatService)("attachmentUploadStoreService").then(t=>{null==t||t.updateAttachmentReviewState(e,s.ReviewState.ReviewState_NotCompliant)})}),a.useMessageStore.getState().updateMessageList({conversationId:t,immerUpdate:e=>{let{draftMessageMap:t}=e,a=(0,n.default)(t).find(e=>e.local_message_id===i);if(null==a?void 0:a.attachments){let e=a.attachments;d.forEach(t=>{let i=null==e?void 0:e.find(e=>e.identifier===t);i&&(i.file_review_state=s.ReviewState.ReviewState_NotCompliant)})}}}))}})}}},678031:function(e,t,i){i.r(t),i.d(t,{touristReachChatLimitMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(687166).touristReachChatLimitMessageCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.TouristReachChatLimit}},887836:function(e,t,i){i.r(t),i.d(t,{TouristReachChatLimitMessageCmdPlugin:function(){return l}});var n=i(230932),a=i(831566),r=i(178230),s=i(687166);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class l{constructor(){o(this,"pluginIdentifier",s.touristReachChatLimitMessageCmdPluginIdentifier),o(this,"handleCmd",e=>{if("1.0"===e.data.version){let{conversation_id:t}=e.data.data||{};r.logger.persist.info({message:"Cmd: TouristReachChatLimit",meta:{conversation_id:t}}),t?(a.DeprecatedChatEvent.emit("chat.user.logoutToSignIn",{reason:"message-reach-limit"}),n.useFeedStore.getState().setNotReachLimitMap({[t]:!1})):r.logger.persist.warning({eventName:"conversation_id_is_empty_when_guest_reachLimit"})}})}}},864398:function(e,t,i){i.r(t),i.d(t,{touristReachThreadLimitMessageCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(661461).touristReachThreadLimitMessageCmdPluginIdentfier,matchPlugin:e=>e.cmd===n.CmdType.TouristReachThreadLimit}},925553:function(e,t,i){i.r(t),i.d(t,{TouristReachThreadLimitMessageCmdPlugin:function(){return d}});var n=i(230932),a=i(722038),r=i(178230),s=i(661461);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let l=e=>e.cmd_type===a.CmdType.TouristReachThreadLimit?e.conversation_id||"0":e.conversation_id;class d{constructor(){o(this,"pluginIdentifier",s.touristReachThreadLimitMessageCmdPluginIdentfier),o(this,"handleCmd",e=>{if("1.0"===e.data.version){let t=l(e.data.data);if(!t){r.logger.persist.warning({message:"Cmd: TouristReachThreadLimit: invalid conversation_id"});return}r.logger.persist.info({message:"Cmd: TouristReachThreadLimit",meta:{conversation_id:t}}),n.useFeedStore.getState().setGuestReachCreateThreadLimit(!0)}})}}},507757:function(e,t,i){i.r(t),i.d(t,{userBanReleaseMessageCmdLPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(497193).userBanReleaseMessageCmdLPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.UserBanRelease}},308569:function(e,t,i){i.r(t),i.d(t,{UserBanReleaseMessageCmdLPlugin:function(){return o}});var n=i(949349),a=i(178230),r=i(497193);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.userBanReleaseMessageCmdLPluginIdentifier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){var t,i,r,s;let{conversation_id:o}=e.data.data||{};a.logger.persist.info({message:"Cmd: UserBanRelease",meta:{conversation_id:o,index:e.data.data.index,error:null===(i=e.data.data)||void 0===i?void 0:null===(t=i.ext)||void 0===t?void 0:t.err_msg}}),n.apiErrorEventEmitter.emit(n.APIErrorEvent.USER_BAN_RELEASE,null===(s=e.data.data)||void 0===s?void 0:null===(r=s.ext)||void 0===r?void 0:r.err_msg)}})}}},656832:function(e,t,i){i.r(t),i.d(t,{userBannedMessageCmdLPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(584793).userBannedMessageCmdLPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.UserBanned}},213511:function(e,t,i){i.r(t),i.d(t,{UserBannedMessageCmdLPlugin:function(){return o}});var n=i(949349),a=i(178230),r=i(584793);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o{constructor(){s(this,"pluginIdentifier",r.userBannedMessageCmdLPluginIdentifier),s(this,"handleCmd",e=>{if("1.0"===e.data.version){var t,i;let{conversation_id:r=""}=e.data.data||{};a.logger.persist.info({message:"Cmd: UserBanned",meta:{conversation_id:r,...e}}),n.apiErrorEventEmitter.emit(n.APIErrorEvent.USER_BANNED,null===(i=e.data.data)||void 0===i?void 0:null===(t=i.ext)||void 0===t?void 0:t.err_msg)}})}}},724987:function(e,t,i){i.r(t),i.d(t,{userConfigUpdateCmdPluginMatcher:function(){return a}});var n=i(722038);let a={pluginIdentifier:i(392124).userConfigUpdateCmdPluginIdentifier,matchPlugin:e=>e.cmd===n.CmdType.UserConfigUpdate}},397682:function(e,t,i){i.r(t),i.d(t,{UserConfigUpdateMessageCmdPlugin:function(){return l}});var n=i(530088),a=i(946576),r=i(165482),s=i(178230),o=i(392124);class l{handleCmd(e){if("1.0"===e.data.version){var t;let{conversation_id:i=""}=e.data.data||{};s.logger.persist.info({message:"Cmd: UserConfigUpdate",meta:{conversation_id:i}});let o=(0,r.parseJSON)(null===(t=e.data.data.ext)||void 0===t?void 0:t.user_config_objects,{});(0,n.pullFeatureConfigFromUserConfigSingle)({reason:a.UserConfigPullReason.Notified,objects:o},!0)}}constructor(){var e,t,i;e="pluginIdentifier",t=o.userConfigUpdateCmdPluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},777399:function(e,t,i){i.r(t),i.d(t,{receiveTextMessageContentBlockMatcher:function(){return a}});var n=i(226982);let a={pluginIdentifier:i(404815).receiveTextContentBlockMergeIdentifier,matchContentBlock:e=>e===n.ContentType.SamanthaText}},903139:function(e,t,i){i.r(t),i.d(t,{receiveTextMessageContentBlockMergePlugin:function(){return a}});var n=i(404815);class a{mergeContentBlock(e,t){var i,n;let a=((null==e?void 0:null===(i=e.content_obj)||void 0===i?void 0:i.text)||"")+((null==t?void 0:null===(n=t.content_obj)||void 0===n?void 0:n.text)||"");return{...e,...t,content_obj:{...null==e?void 0:e.content_obj,...null==t?void 0:t.content_obj,text:a}}}constructor(){var e,t,i;e="pluginIdentifier",t=n.receiveTextContentBlockMergeIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},291740:function(e,t,i){i.r(t),i.d(t,{suggestsMessageBlockMergePluginMatcher:function(){return a}});var n=i(226982);let a={pluginIdentifier:i(823510).suggestsMessageBlockMergePluginIdentifier,matchContentBlock:e=>e===n.ContentType.SamanthaSuggest}},344911:function(e,t,i){i.r(t),i.d(t,{SuggestsMessageBlockMergePlugin:function(){return a}});var n=i(823510);class a{mergeContentBlock(e,t){let i=e.content_obj,n=t.content_obj;return t.is_delta?{...e,...t,content_obj:{suggest:"",suggestions:[...(null==i?void 0:i.suggestions)||[],...(null==n?void 0:n.suggestions)||[]]}}:t}constructor(){var e,t,i;e="pluginIdentifier",t=n.suggestsMessageBlockMergePluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},428938:function(e,t,i){i.r(t),i.d(t,{receiveTextContentBlockMergePluginMatcher:function(){return a}});var n=i(226982);let a={pluginIdentifier:i(733900).receiveTextContentBlockMergePluginIdentifier,matchContentBlock:e=>e===n.ContentType.SamanthaBlockText}},117867:function(e,t,i){i.r(t),i.d(t,{ReceiveTextContentBlockMergePlugin:function(){return a}});var n=i(733900);class a{mergeContentBlock(e,t){var i,n;if(!(null==t?void 0:t.is_delta))return t;let a=((null==e?void 0:null===(i=e.content_obj)||void 0===i?void 0:i.text)||"")+((null==t?void 0:null===(n=t.content_obj)||void 0===n?void 0:n.text)||"");return{...e,...t,content_obj:{...null==e?void 0:e.content_obj,...null==t?void 0:t.content_obj,text:a},meta_infos:(e.meta_infos||[]).concat(t.meta_infos||[])}}constructor(){var e,t,i;e="pluginIdentifier",t=n.receiveTextContentBlockMergePluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},48592:function(e,t,i){i.r(t),i.d(t,{receiveTextContentBlockPluginMatcher:function(){return a}});var n=i(226982);let a={pluginIdentifier:i(336358).receiveTextContentBlockIdentifier,matchContentBlock:e=>e===n.ContentType.SamanthaText}},79090:function(e,t,i){i.r(t),i.d(t,{ReceiveTextMessageContentBlockPlugin:function(){return c}});var n=i(674157),a=i(629006),r=i(336358),s=i(522715),o=i(535373),l=i(345660);function d(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let u=e=>{var t,i,r;let{inView:d=!1,contentBlock:u,message:c}=e,g=null==u?void 0:null===(t=u.content_obj)||void 0===t?void 0:t.text,v=(null===(i=c.content_blocks)||void 0===i?void 0:i.findIndex(e=>e.id===u.id))===((null===(r=c.content_blocks)||void 0===r?void 0:r.length)||0)-1,m=!v||(0,n.isMessageFinished)(c),f=!!v&&(0,a.isBrokenMessage)(c),h=(0,s.useCustomSlots)({bizMessage:c});return g?(0,l.jsx)(o.DefaultReceiveMessageBox,{inView:d,messageBlockText:g,messageBlockTextFinish:m,messageBlockTextBroken:f,message:c,customRenderOptions:{customSlots:h}}):null};class c{constructor(){d(this,"pluginIdentifier",r.receiveTextContentBlockIdentifier),d(this,"type","Content"),d(this,"Content",u)}}},993338:function(e,t,i){i.r(t),i.d(t,{receiveRiskTipsBlockPluginMatcher:function(){return a}});var n=i(82760);let a={pluginIdentifier:i(3027).receiveRiskTipsBlockPluginIdentifier,matchContentBlock:e=>e===n.ContentType.BLOCK_TIPS}},160454:function(e,t,i){i.r(t),i.d(t,{ReceiveRiskTipsMessageContentBlockPlugin:function(){return l}});var n=i(403649),a=i(3027),r=i(345660);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let o=e=>{let{contentBlock:t}=e;if(!t)return null;let i=t.content_obj;return(0,r.jsx)(n.RiskTips,{tips:[i],isBlock:!0})};class l{constructor(){s(this,"pluginIdentifier",a.receiveRiskTipsBlockPluginIdentifier),s(this,"type","Content"),s(this,"Content",o)}}},745740:function(e,t,i){i.r(t),i.d(t,{suggestsMessageBlockPluginMatcher:function(){return a}});var n=i(226982);let a={pluginIdentifier:i(179778).suggestsMessageBlockPluginIdentifier,matchContentBlock:e=>e===n.ContentType.SamanthaSuggest}},869843:function(e,t,i){i.r(t),i.d(t,{SuggestsMessageBlockPlugin:function(){return l}});var n=i(946985),a=i(179778),r=i(345660);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let o=e=>{var t;let{message:i,contentBlock:a}=e,s=(null==a?void 0:null===(t=a.content_obj)||void 0===t?void 0:t.suggestions)||[];return(0,r.jsx)(n.SuggestListWrapper,{message:i,loading:!1,suggests:s})};class l{constructor(){s(this,"type","Content"),s(this,"pluginIdentifier",a.suggestsMessageBlockPluginIdentifier),s(this,"Content",o)}}},142260:function(e,t,i){i.r(t),i.d(t,{receiveTextContentBlockPluginMatcher:function(){return a}});var n=i(226982);let a={pluginIdentifier:i(215381).receiveTextContentBlockPluginIdentifier,matchContentBlock:e=>e===n.ContentType.SamanthaBlockText}},737483:function(e,t,i){i.r(t),i.d(t,{ReceiveTextMessageContentBlockPlugin:function(){return v}});var n=i(713738),a=i(296557),r=i(674157),s=i(629006),o=i(540498),l=i(215381),d=i(522715),u=i(345660);function c(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let g=e=>{var t,i,l,c;let{inView:g=!1,contentBlock:v,message:m,customRenderOptions:f={}}=e,h=null==v?void 0:null===(t=v.content_obj)||void 0===t?void 0:t.text,p=null!==(c=null==v?void 0:v.meta_infos)&&void 0!==c?c:[],_=(null===(i=m.content_blocks)||void 0===i?void 0:i.findIndex(e=>e.id===v.id))===((null===(l=m.content_blocks)||void 0===l?void 0:l.length)||0)-1,y=!_||(0,r.isMessageFinished)(m),M=!!_&&(0,s.isBrokenMessage)(m),{showRun:b}=(0,a.useShowRun)(),S=(0,n.useMemo)(()=>({...f,customSlotsProps:{CodeBlock:{showRun:b}}}),[b]),C=(0,d.useCustomSlots)({bizMessage:m});return h?(0,u.jsx)(o.MessageTextContent,{inView:g,messageBlockText:h,messageBlockMeta:p,messageBlockTextFinish:y,messageBlockTextBroken:M,message:m,customRenderOptions:{...S,customSlots:C}}):null};class v{constructor(){c(this,"pluginIdentifier",l.receiveTextContentBlockPluginIdentifier),c(this,"type","Content"),c(this,"Content",g)}}},950881:function(e,t,i){i.r(t),i.d(t,{botInvalidMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(804471).botInvalidMessageErrorPluginIdentifier,matchPlugin:e=>{var t;return[n.ErrorCodes.BOT_INVALID,n.ErrorCodes.BOT_BANNED,n.ErrorCodes.BOT_REVIEWING].includes(Number(null===(t=e.error_details)||void 0===t?void 0:t.error_code))}}},941408:function(e,t,i){i.r(t),i.d(t,{BotInvalidMessageErrorPlugin:function(){return o}});var n=i(884181),a=i(785926),r=i(230932),s=i(177048);class o{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{var t;if(!e.conversation_id)return;let i=n.feedServiceContainer.get("chatBotService");if((null===(t=e.error_details)||void 0===t?void 0:t.error_code)===s.ErrorCodes.BOT_REVIEWING){let t=(0,a.getBotIdByConversationIdSelector)(r.useFeedStore.getState(),e.conversation_id);null==i||i.updateBot({id:t,disabled:!0})}else r.useFeedStore.getState().fetchUpdateConversationInfo(e.conversation_id,"botInvalid")},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},710715:function(e,t,i){i.r(t),i.d(t,{conversationInvalidMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(950301).conversationInvalidMessageErrorPluginIdentifier,matchPlugin:e=>{var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.CONVERSATION_INVALID}}},38878:function(e,t,i){i.r(t),i.d(t,{ConversationInvalidMessageErrorPlugin:function(){return r}});var n=i(230932),a=i(949349);class r{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{if(!e.conversation_id){a.apiErrorEventEmitter.emit(a.APIErrorEvent.CONVERSATION_INVALID);return}let{removeConversationFromLinks:t,removeConversationFromMap:i}=n.useFeedStore.getState();t({conversationId:e.conversation_id}),i({conversationId:e.conversation_id}),a.apiErrorEventEmitter.emit(a.APIErrorEvent.CONVERSATION_INVALID)},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},101123:function(e,t,i){i.r(t),i.d(t,{guestMessageLimitMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(562644).guestMessageLimitMessageErrorPluginIdentifier,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.GUEST_REACH_LIMIT}}},472464:function(e,t,i){i.r(t),i.d(t,{GuestMessageLimitMessageErrorPlugin:function(){return u}});var n=i(918952),a=i(83990),r=i(745829),s=i(922851),o=i(230932),l=i(831566),d=i(645298);class u{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{let{conversation_id:t,local_message_id:i}=e;if(t&&i){if("0"===t){var u,c,g;let r=null!==(g=null!==(c=null==e?void 0:e.local_conversation_id)&&void 0!==c?c:null===(u=Object.entries(a.useMessageStore.getState().localMessageMap).find(e=>{let[,t]=e;return!!t[i]}))||void 0===u?void 0:u[0])&&void 0!==g?g:t;r&&o.useFeedStore.getState().updateLocalConversationLocal(r,{createStatus:n.CreateConversationStatus.Failed,failReason:n.CreateConversationFailReason.ReachLimit})}else o.useFeedStore.getState().setNotReachLimitMap({[t]:!1}),l.DeprecatedChatEvent.emit("chat.user.logoutToSignIn",{reason:"message-reach-limit"}),(0,s.getChatService)("chatNavigateService").then(e=>null==e?void 0:e.navigateToLoginPage("message-reach-limit")),l.DeprecatedChatEvent.emit("chat.guest.login",{source:"message-reach-limit"}),a.useMessageStore.getState().updateMessageList({conversationId:t,immerUpdate:e=>{(0,r.logicalDeleteMessage)(e,{isLocalMessage:!0,messageId:i}),(0,r.deleteLocalReceivingMessage)(e,d.mockReplyConstantMessageId)}})}},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},894854:function(e,t,i){i.r(t),i.d(t,{guestReachCreateThreadLimitMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(531213).guestReachCreateThreadLimitMessageErrorPluginIdentifier,matchPlugin:e=>{var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.GUEST_CONVERSATION_REACH_LIMIT}}},221540:function(e,t,i){i.r(t),i.d(t,{GuestReachCreateThreadLimitMessageErrorPlugin:function(){return a}});var n=i(230932);class a{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{n.useFeedStore.getState().setGuestReachCreateThreadLimit(!0)},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},460640:function(e,t,i){i.r(t),i.d(t,{guestReachThreadLimitMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(441361).guestReachThreadLimitMessageErrorPluginIdentifier,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.GUEST_CONVERSATION_REACH_LIMIT}}},328002:function(e,t,i){i.r(t),i.d(t,{GuestReachThreadLimitMessageErrorPlugin:function(){return l}});var n=i(83990),a=i(745829),r=i(922851),s=i(831566),o=i(645298);class l{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{(0,r.getChatService)("chatNavigateService").then(e=>null==e?void 0:e.navigateToLoginPage()),s.DeprecatedChatEvent.emit("chat.guest.login");let{conversation_id:t,local_message_id:i}=e;t&&i&&n.useMessageStore.getState().updateMessageList({conversationId:t,immerUpdate:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let[r]=t;(0,a.logicalDeleteMessage)(r,{isLocalMessage:!0,messageId:i}),(0,a.deleteLocalReceivingMessage)(r,o.mockReplyConstantMessageId)}})},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},637192:function(e,t,i){i.r(t),i.d(t,{imageSafetyMessageErrorPluginMatcher:function(){return r}});var n=i(177048),a=i(458524);let r={pluginIdentifier:i(935919).imageSafetyMessageErrorPluginIdentifer,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.IMAGE_SAFETY_ERROR||(null==e?void 0:e.status)===a.PushMessageStatus.NotCompliant}}},743481:function(e,t,i){i.r(t),i.d(t,{ImageSafetyMessageErrorPlugin:function(){return o}});var n=i(101874),a=i(83990),r=i(745829),s=i(645298);class o{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{let{conversation_id:t,local_message_id:i}=e;t&&i&&a.useMessageStore.getState().updateMessageList({conversationId:t,immerUpdate:function(){for(var t=arguments.length,a=Array(t),o=0;o<t;o++)a[o]=arguments[o];let[l]=a,d=l.draftLocalMessageMap[i];d.local={...d.local,status:n.LocalMessageStatus.SafetyError,failed:!0},d.ext={...d.ext,...e.ext},(0,r.deleteLocalReceivingMessage)(l,s.mockReplyConstantMessageId)}})},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},221272:function(e,t,i){i.r(t),i.d(t,{messageIllegalMessageErrorPluginMatcher:function(){return r}});var n=i(177048),a=i(458524);let r={pluginIdentifier:i(76397).messageIllegalMessageErrorPluginIdentifer,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.CLEAR_LAST_PROMPT||(null==e?void 0:e.status)===a.PushMessageStatus.NotCompliant}}},226234:function(e,t,i){i.r(t),i.d(t,{MessageIllegalMessageErrorPlugin:function(){return s}});var n=i(83990),a=i(745829),r=i(178230);class s{constructor(){var e,t,i;e="handleReceivingMessageError",t=e=>{r.logger.persist.warning({message:"illegal_prompt",meta:{message_id:e.message_id,reply_id:e.reply_id}});let{conversation_id:t,reply_id:i,message_id:s}=e;t&&i&&s&&n.useMessageStore.getState().updateMessageList({conversationId:t,immerUpdate:e=>{let t=(0,a.physicalDeleteMessage)(e,{isLocalMessage:!1,messageId:i});~t&&e.draftMessageLinks.splice(t,1);let n=(0,a.physicalDeleteMessage)(e,{isLocalMessage:!1,messageId:s});~n&&e.draftMessageLinks.splice(n,1),(0,a.deleteLocalReplyMessageByReplyId)(e,i)}})},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},368218:function(e,t,i){i.r(t),i.d(t,{messageLimitMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(914669).messageLimitMessageErrorPluginIdentifer,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.LIMIT_TO_SEND_MESSAGE}}},733137:function(e,t,i){i.r(t),i.d(t,{MessageLimitMessageErrorPlugin:function(){return a}});var n=i(83990);class a{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{let{limit_time:t,limit_tips:i}=e.ext||{};n.useMessageStore.getState().updateRateLimitConfig({isLimited:!0,limitExpired:Date.now()+1e3*Number(t)||0,limitTips:i})},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},181520:function(e,t,i){i.r(t),i.d(t,{sharkErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(391520).sharkErrorPluginIdentifier,matchPlugin(e){var t,i;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.COUNTRY_RESTRICTED||(null===(i=e.error_details)||void 0===i?void 0:i.error_code)===n.ErrorCodes.SHARK_BLOCKED}}},794878:function(e,t,i){i.r(t),i.d(t,{SharkMessageErrorPlugin:function(){return o}});var n=i(777422),a=i(690619),r=i(233486),s=i(391520);class o{handleSendingMessageError(e){var t,i;r.default.warning({content:null===(t=e.error_details)||void 0===t?void 0:t.error_message,showClose:!1}),(0,a.getFlowAccount)().passportApi.logout({reason:"shark_block",trackMeta:{from:"frontier",msg:null===(i=e.error_details)||void 0===i?void 0:i.error_message},loginRoute:"/"}).then(()=>{(0,n.trackEvent)("logout_result",{scene:"frontier",success:1})}).catch(e=>{throw(0,n.trackEvent)("logout_result",{scene:"frontier",success:0}),e})}constructor(){var e,t,i;e="pluginIdentifier",t=s.sharkErrorPluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},510926:function(e,t,i){i.r(t),i.d(t,{MessageLimitSharkVerifyMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(356981).messageLimitSharkVerifyPluginIdentifier,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.LIMIT_TO_SEND_MESSAGE}}},686985:function(e,t,i){i.r(t),i.d(t,{MessageLimitSharkVerifyMessageErrorPlugin:function(){return d}});var n=i(531102),a=i(510534),r=i(777210),s=i(178230),o=i(896855),l=i(356981);class d{async handleSendingMessageError(e){var t,i;let l=null===(i=e.error_details)||void 0===i?void 0:null===(t=i.extra_info)||void 0===t?void 0:t.decision,d=await (0,n.getTTVerifyCenter)();l&&d.init({commonOptions:{aid:(0,a.getAid)(),iid:"0",did:"0",repoId:o.REPO_ID},captchaOptions:{fp:await (0,n.getFPForVerifyCenter)(),showMode:"mask",errorCb:e=>{s.logger.persist.error({error:e,message:e.message})},successCb:()=>{var t;null===(t=r.messageServiceContainer.service)||void 0===t||t.sendMessage([{conversationId:e.conversation_id,localConversationId:e.local_conversation_id,reportParams:{scene:"resend"},operation:{resend:{messageLink:{isLocalMessage:!0,messageId:e.local_message_id||""}}}}]),s.logger.persist.success("message limit CAPTCHA verify success")}}},()=>{s.logger.persist.success("CAPTCHA service init success"),d.render({verify_data:l})},e=>{let t=Error(`type: ${e.type}, message: ${e.msg}`);s.logger.persist.error({error:t,message:t.message})})}constructor(){var e,t,i;e="pluginIdentifier",t=l.messageLimitSharkVerifyPluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},826088:function(e,t,i){i.r(t),i.d(t,{userBanMessageErrorPluginMatcher:function(){return a}});var n=i(177048);let a={pluginIdentifier:i(654360).userBanMessageErrorPluginIdentifier,matchPlugin(e){var t;return(null===(t=e.error_details)||void 0===t?void 0:t.error_code)===n.ErrorCodes.USER_BANNED}}},997246:function(e,t,i){i.r(t),i.d(t,{UserBanMessageErrorPlugin:function(){return a}});var n=i(949349);class a{constructor(){var e,t,i;e="handleSendingMessageError",t=e=>{var t;n.apiErrorEventEmitter.emit(n.APIErrorEvent.USER_BANNED,null==e?void 0:null===(t=e.error_details)||void 0===t?void 0:t.error_message)},(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},240675:function(e,t,i){i.r(t),i.d(t,{localBreakMessageLifeCyclePluginMatcher:function(){return n}});let n={pluginIdentifier:i(309101).localBreakMessageLifeCyclePluginIdentifier,matchPlugin:e=>!0,matchPluginWithPayload:e=>!0}},47751:function(e,t,i){i.r(t),i.d(t,{LocalBreakMessageLifeCyclePlugin:function(){return d}});var n=i(695422),a=i(674157),r=i(629006),s=i(922851),o=i(698392),l=i(309101);class d{onMessageSendingEnd(e,t){var i;let a=t.conversation_id,r=t.local_conversation_id;return(null===(i=t.final_status)||void 0===i?void 0:i.message)==="Success"&&(0,s.getChatService)("chatInputStoreService").then(e=>{if(r&&a){null==e||e.moveSendMessageStatus(r,a),(0,o.getChatStore)("chatInputStore").getState().sendMessageStatusMap[a]!==n.ChatInputSendMessageStatus.Default&&(null==e||e.updateSendMessageStatus(a,n.ChatInputSendMessageStatus.Receiving));return}if(a){null==e||e.updateSendMessageStatus(a,n.ChatInputSendMessageStatus.Receiving);return}}),t}onMessageReceivingUpdate(e,t){let i=t.conversation_id;return(0,a.isMessageFinished)(t)||(0,r.isBrokenMessage)(t)||(0,s.getChatService)("chatInputStoreService").then(e=>{i&&(null==e||e.updateSendMessageStatus(i,n.ChatInputSendMessageStatus.Receiving))}),t}onBatchMessageReceivingEnd(e,t){let i=t.local_conversation_id,r=t.conversation_id;return i&&(0,a.isMessageFinished)(t)&&(0,s.getChatService)("chatInputStoreService").then(e=>null==e?void 0:e.updateSendMessageStatus(i,n.ChatInputSendMessageStatus.Default)),r&&(0,a.isMessageFinished)(t)&&(0,s.getChatService)("chatInputStoreService").then(e=>null==e?void 0:e.updateSendMessageStatus(r,n.ChatInputSendMessageStatus.Default)),t}constructor(){var e,t,i;e="pluginIdentifier",t=l.localBreakMessageLifeCyclePluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},727050:function(e,t,i){i.r(t),i.d(t,{messageLimitMessageLifeCyclePluginMatcher:function(){return n}});let n={pluginIdentifier:i(296358).messageLimitMessageLifeCyclePluginIdentifier,matchPlugin:e=>!0,matchPluginWithPayload:e=>!0}},283172:function(e,t,i){i.r(t),i.d(t,{MessageLimitMessageLifeCyclePlugin:function(){return u}});var n=i(83990),a=i(884181),r=i(230932),s=i(178230),o=i(296358);let l=e=>{var t;return{local_message_id:e.localMessageId,conversation_id:e.conversationId,conversation_type:null===(t=e.reportParams)||void 0===t?void 0:t.conversation_type}},d=(e,t)=>{s.logger.persist.info({eventName:"send_message_cancel",meta:{...e,reason:t}})};class u{onProcessMessageEnd(e,t){let i=t[0],s=a.feedServiceContainer.get("chatBotService"),o=r.useFeedStore.getState().conversationMap[i.resolvedConversationId],u=(null==o?void 0:o.bot_id)?null==s?void 0:s.getBot(o.bot_id):{};return n.useMessageStore.getState().rateLimitConfig.isLimited?(d(l(i),"rate limit"),Promise.reject(Error("send message cancel, because reach rate limit"))):(null==u?void 0:u.disabled)?(d(l(i),"bot deleted"),Promise.reject(Error("send message cancel, because bot has been deleted"))):t}constructor(){var e,t,i;e="pluginIdentifier",t=o.messageLimitMessageLifeCyclePluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},654669:function(e,t,i){i.r(t),i.d(t,{MessageTimeoutMessageLifeCyclePluginMatcher:function(){return n}});let n={pluginIdentifier:i(148087).messageTimeoutMessageLifeCyclePluginIdentifier,matchPlugin:e=>!0,matchPluginWithPayload:e=>!0}},484933:function(e,t,i){i.r(t),i.d(t,{MessageTimeoutMessageLifeCyclePlugin:function(){return m}});var n=i(695422),a=i(101874),r=i(725705),s=i(629006),o=i(83990),l=i(637319),d=i(239705),u=i(745829),c=i(922851),g=i(645298),v=i(148087);class m{onMessageReceivingEnd(e,t){var i;if((null===(i=t.final_status)||void 0===i?void 0:i.message)==="Timeout"){let{conversation_id:e=""}=t,i=o.useMessageStore.getState();if(e&&(0,c.getChatService)("chatInputStoreService").then(t=>null==t?void 0:t.updateSendMessageStatus(e,n.ChatInputSendMessageStatus.Default)),t&&(0,r.isLocalMessage)(t)&&(0,s.isOnBoardingMessage)(t))return i.cancelOnboarding({conversationId:e}),t;if(!(0,s.isOnBoardingMessage)(t)){let n=(0,l.getMessageSelector)(i,e,{isLocalMessage:!1,messageId:t.reply_id||""});(0,d.abortPullMessage)({replyId:t.reply_id,localMessageId:null==n?void 0:n.local_message_id})}i.updateMessageList({conversationId:e||"",immerUpdate:e=>{if(!t.local_message_id)return;let{draftLocalMessageMap:i,draftMessageLinks:n}=e,r=i[t.local_message_id];r&&(r.local={...r.local,status:a.LocalMessageStatus.StreamingTimeout,failed:!0,failedExpired:void 0});let s=n.find(e=>e.messageId===t.message_id);s&&(s.messageKey=`${s.messageId}_timeout`)}})}return t}onMessageSendingEnd(e,t){var i;if((null===(i=t.final_status)||void 0===i?void 0:i.message)==="Timeout"){let{conversation_id:e=""}=t,i=o.useMessageStore.getState();if(e&&(0,c.getChatService)("chatInputStoreService").then(t=>null==t?void 0:t.updateSendMessageStatus(e,n.ChatInputSendMessageStatus.Default)),t&&(0,r.isLocalMessage)(t)&&(0,s.isOnBoardingMessage)(t))return i.cancelOnboarding({conversationId:e}),t;(null==t?void 0:t.local_message_id)&&(o.useMessageStore.getState().finishSendMessageTask(t.local_message_id),(0,d.abortPullMessage)({localMessageId:t.local_message_id})),i.updateMessageList({conversationId:e||"",immerUpdate:e=>{let i=t.local_message_id;if(!i)return;(0,u.deleteLocalReceivingMessage)(e,g.mockReplyConstantMessageId);let{draftLocalMessageMap:n,draftMessageLinks:r}=e,s=n[i];s&&(s.local={...s.local,status:a.LocalMessageStatus.Timeout,failed:!0,failedExpired:void 0});let o=r.find(e=>e.messageId===i);o&&(o.messageKey=`${o.messageId}_timeout`)}})}return t}onSuggestReceivingEnd(e,t){let{conversation_id:i="",reply_id:n=""}=t||{};return o.useMessageStore.getState().updateSuggestMessage(i,e=>({replyId:n,loading:!1,failed:!1,expired:void 0,suggests:(null==e?void 0:e.replyId)===n&&(null==e?void 0:e.suggests)||[]})),t}constructor(){var e,t,i;e="pluginIdentifier",t=v.messageTimeoutMessageLifeCyclePluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},278614:function(e,t,i){i.r(t),i.d(t,{sessionIdUpdateMessageLifeCyclePluginMatcher:function(){return n}});let n={pluginIdentifier:i(290214).sessionIdUpdateMessageLifeCyclePluginIdentifier,matchPlugin:e=>!0,matchPluginWithPayload:e=>!0}},927686:function(e,t,i){i.r(t),i.d(t,{SessionIdUpdateMessageLifeCyclePlugin:function(){return r}});var n=i(230932),a=i(290214);class r{onMessageSendingEnd(e,t){let{conversation_id:i=""}=t;if(t.index){let e=Number(t.index);n.useFeedStore.getState().updateConversationMessageIndex({conversationId:i,readMessageIndex:e,messageIndex:e,readBadgeCount:e,badgeCount:e})}return t.section_id&&n.useFeedStore.getState().updateLastSectionId(i,t.section_id),t}constructor(){var e,t,i;e="pluginIdentifier",t=a.sessionIdUpdateMessageLifeCyclePluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},793025:function(e,t,i){i.r(t),i.d(t,{defaultReceiveMessageSuggestPluginMatcher:function(){return n}});let n={pluginIdentifier:i(469252).defaultReceiveMessageSuggestPluginIdentifier,matchPlugin:e=>!0}},423467:function(e,t,i){i.r(t),i.d(t,{DefaultReceiveMessageSuggestsMessagePlugin:function(){return p}});var n=i(214071),a=i(746167),r=i(666196),s=i(629006),o=i(921741),l=i(637319),d=i(83990),u=i(192843),c=i(198660),g=i(165482),v=i(469252),m=i(345660);function f(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let h=e=>{let{message:t,suggests:i,loading:v,onTrackClickEvent:f}=e,{sendMessage:h}=(0,r.useChatService)("chatMessageService"),p=(0,c.useIsLoggedIn)();return(0,m.jsx)(o.SuggestList,{message:t,loading:v,suggests:i,onClick:(e,i)=>{var r,o;let c=(0,s.isSearchTextMessage)(t),v=(0,s.isCodeTextMessage)(t),m=(0,l.getMessageSelector)(d.useMessageStore.getState(),(null==t?void 0:t.conversation_id)||"",{messageId:(null==t?void 0:t.reply_id)||"",isLocalMessage:!1}),_=m&&(0,u.extractRefContentFromMessage)(m),y=t?{skill_type:null===(r=t.skill)||void 0===r?void 0:r.skill_type,skill_id:String(null===(o=t.skill)||void 0===o?void 0:o.skill_type)}:{};h([{text:e,reportParams:{scene:"suggested_prompts",preset_prompt_type:"default_prompt",send_source:a.ChatTeaSendSource.SUGGEST},extraExt:{...p?{}:{send_from_skill_guidance_or_suggestion:"1"},..._&&!(0,n.default)(_)?{reference_content:(0,g.stringifyJSON)(_)}:{},...c||v?{input_skill:(0,g.stringifyJSON)(y)}:{}}}]),f(e,i)}})};class p{constructor(){f(this,"pluginIdentifier",v.defaultReceiveMessageSuggestPluginIdentifier),f(this,"Content",h)}}},251185:function(e,t,i){i.r(t),i.d(t,{GenericConversationProtocolransformPluginMatcher:function(){return r}});var n=i(226982),a=i(629006);let r={pluginIdentifier:i(199008).genericConversationProtocolTransformPluginIdentifier,matchPluginForAliceChatMessageToMessage(e){var t,i;return(0,a.isMainBotConversation)(e)&&((0,a.isTextMessage)(e)&&((null===(t=e.skill)||void 0===t?void 0:t.skill_type)===n.SkillType.SkillFreeChat||(null===(i=e.skill)||void 0===i?void 0:i.skill_type)===n.SkillType.SkillCodeAssistant)&&!(0,a.isSearchTextMessage)(e)&&!(0,a.isImageTextLoadingMessage)(e)&&!(0,a.isMindMapPushMessage)(e)&&!(0,a.isWriteArtifactMessage)(e)&&!(0,a.isCodeArtifactMessage)(e)&&!(0,a.isProfessionalWritingOutlineMessage)(e)||(0,a.isNestedMessage)(e)||(0,a.isCompositeMessage)(e)||(0,a.isExtSamanthaSkillMessage)(e))},matchPluginForMessageToSamanthaChatMessage(e){var t;let i=(null===(t=e.skill)||void 0===t?void 0:t.skill_type)===n.SkillType.SkillFreeChat;return(0,a.isMainBotConversation)(e)&&i&&!(0,a.isMindMapMessage)(e)&&!(0,a.isDocxActionSendMessage)(e)},matchPluginForSamanthaChatMessageToMessage(e){var t,i;return(0,a.isMainBotConversation)(e)&&((0,a.isTextMessage)(e)&&((null===(t=e.skill)||void 0===t?void 0:t.skill_type)===n.SkillType.SkillFreeChat||(null===(i=e.skill)||void 0===i?void 0:i.skill_type)===n.SkillType.SkillCodeAssistant)&&!(0,a.isCodeArtifactMessage)(e)&&!(0,a.isSearchTextMessage)(e)&&!(0,a.isImageTextLoadingMessage)(e)&&!(0,a.isMindMapPushMessage)(e)&&!(0,a.isWriteArtifactMessage)(e)&&!(0,a.isProfessionalWritingOutlineMessage)(e)||(0,a.isNestedMessage)(e)||(0,a.isCompositeMessage)(e))},matchPluginForMessageToAliceChatMessage(e){var t;let i=(null===(t=e.skill)||void 0===t?void 0:t.skill_type)===n.SkillType.SkillFreeChat;return(0,a.isMainBotConversation)(e)&&i&&!(0,a.isMindMapMessage)(e)}}},948554:function(e,t,i){i.r(t),i.d(t,{GenericConversationProtocolTransformPlugin:function(){return m}});var n=i(788432),a=i(762707),r=i(567134),s=i(750874),o=i(226982),l=i(590475),d=i(629006),u=i(972057),c=i(458524),g=i(165482),v=i(199008);class m{aliceChatMessageToMessage(e){var t,i,a,r,o;let l=[];(0,d.isNestedMessage)(e)&&l.push(...(0,u.getAttachmentsFromNestedContentEntities)(null===(o=e.content_obj)||void 0===o?void 0:o.entities,e.nestedItems)),(null===(t=e.content_obj)||void 0===t?void 0:t.file_model)&&l.push(...(0,u.getAttachmentsFromContentFileModel)(e.content_obj.file_model)),(null===(i=e.content_obj)||void 0===i?void 0:i.link_model)&&l.push((0,u.getAttachmentFromContentLinkModel)(e.content_obj.link_model)),(null===(a=e.content_obj)||void 0===a?void 0:a.image_model)&&l.push(...(0,u.getAttachmentsFromImageContentEntities)(e.content_obj.image_model.image_list)),(null==l?void 0:l.length)&&(0,n.default)(e,{attachments:l});let g=(0,u.getReferencesFromExt)(e.ext);if((null==g?void 0:g.length)&&(0,n.default)(e,{references:g}),null===(r=e.meta_infos)||void 0===r?void 0:r.some(e=>e.type===c.MetaType.Think)){let{text:t,is_hide:i}=(0,s.getDeepThinkingContent)(e.meta_infos);return{...e,content_obj:{...e.content_obj,think:t},has_think_reason:!0,think_reason_default_expand:!0,think_reason_is_hide:i}}return e}samanthaChatMessageToMessage(e){var t;if(null===(t=e.meta_infos)||void 0===t?void 0:t.some(e=>e.type===c.MetaType.Think)){let{text:t,is_hide:i}=(0,s.getDeepThinkingContent)(e.meta_infos);return{...e,content_obj:{...e.content_obj,think:t},has_think_reason:!0,think_reason_default_expand:!0,think_reason_is_hide:i}}return e}messageToSamanthaChatMessage(e){let t=e.content_obj,i={text:(null==t?void 0:t.text)||"",...(0,a.default)(t,["immersive_files","need_reference","prompt_tpl","hover_position"])},n=[...(0,u.getReferencesFromExt)(e.ext)],s=[...e.attachments||[]];if((null==t?void 0:t.file_model)&&s.push(...(0,u.getAttachmentsFromContentFileModel)(t.file_model)),(null==t?void 0:t.link_model)&&s.push((0,u.getAttachmentFromContentLinkModel)(t.link_model)),null==t?void 0:t.image_model){var d;s.push(...(0,u.getAttachmentsFromImageContentEntities)(null===(d=t.image_model)||void 0===d?void 0:d.image_list))}return(null==t?void 0:t.entities)&&s.push(...(0,u.getAttachmentsFromNestedContentEntities)(t.entities)),{content:(0,g.stringifyJSON)(i),content_type:l.SkillTypeToSamanthaContentTypeMap[o.SkillType.SkillFreeChat],attachments:(0,r.default)(s,(e,t)=>e.type===t.type&&e.key===t.key&&e.identifier===t.identifier),references:n}}constructor(){var e,t,i;e="pluginIdentifier",t=v.genericConversationProtocolTransformPluginIdentifier,(e="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string"))?i:i+"")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}}},502844:function(e,t,i){i.r(t),i.d(t,{ShareDefaultReceiveMessageBoxContent:function(){return h},ShareDefaultReceiveMessageBoxPlugin:function(){return p}});var n=i(713738),a=i(812650),r=i.n(a),s=i(674157),o=i(629006),l=i(667018),d=i(47405),u=i(459046),c=i(403649),g=i(915299),v=i(67769),m=i(345660);function f(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let h=e=>{var t,i,a,v;let{message:f,theme:h="samantha"}=e;return(0,n.useEffect)(()=>{(0,u.reportMessageShowError)({message:f,reason:"message_fallback_content",from:"message_fallback_content"})},[]),(0,m.jsx)(l.BorderlessTextContent,{className:r()(null===(t=d.messageShareThemeCss[h])||void 0===t?void 0:t.receiveClassNames),style:d.messageShareThemeCss[h].cssVar,text:(null==f?void 0:null===(i=f.ext)||void 0===i?void 0:i.default_display_content)||(0,g.getUnreactiveTranslate)("chat_unsupported_message_type"),afterNode:(0,s.isMessageFinished)(f)||(0,o.isBrokenMessage)(f)?(0,m.jsx)(c.RiskTips,{jsonString:null===(v=f.verbose)||void 0===v?void 0:null===(a=v.extra)||void 0===a?void 0:a.risk_tips}):null})};class p{constructor(){f(this,"pluginIdentifier",v.defaultReceiveMessageBoxPluginIdentifier),f(this,"Content",h)}}},665091:function(e,t,i){i.r(t),i.d(t,{ShareTextReceiveMessageBoxPlugin:function(){return l}}),i(713738);var n=i(65775),a=i(535373),r=i(345660);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let o=e=>(0,r.jsx)(a.DefaultReceiveMessageBoxLitePure,{...e,messageBlockText:void 0,messageBlockTextFinish:void 0,messageBlockTextBroken:void 0,showRiskTips:!0});class l{constructor(){s(this,"pluginIdentifier",n.textReceiveMessageBoxPluginIdentifier),s(this,"Content",o)}}},799098:function(e,t,i){i.r(t),i.d(t,{ShareReceiveTextMessageContentBlockPlugin:function(){return l}});var n=i(336358),a=i(535373),r=i(345660);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let o=e=>{var t;let{inView:i,contentBlock:n,message:s}=e,o=null==n?void 0:null===(t=n.content_obj)||void 0===t?void 0:t.text;return o?(0,r.jsx)(a.DefaultReceiveMessageBoxLitePure,{inView:null!=i&&i,message:s,messageBlockText:o,messageBlockTextBroken:void 0,messageBlockTextFinish:void 0}):null};class l{constructor(){s(this,"pluginIdentifier",n.receiveTextContentBlockIdentifier),s(this,"type","Content"),s(this,"Content",o)}}},759275:function(e,t,i){i.r(t),i.d(t,{ShareSuggestsMessageBlockPlugin:function(){return l}});var n=i(946985),a=i(179778),r=i(345660);function s(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let o=e=>{var t;let{message:i,contentBlock:a}=e,s=(null==a?void 0:null===(t=a.content_obj)||void 0===t?void 0:t.suggestions)||[];return(0,r.jsx)(n.SuggestListWrapper,{message:i,loading:!1,suggests:s})};class l{constructor(){s(this,"type","Content"),s(this,"pluginIdentifier",a.suggestsMessageBlockPluginIdentifier),s(this,"Content",o)}}},226058:function(e,t,i){i.r(t),i.d(t,{ShareReceiveTextMessageContentBlockPlugin:function(){return d}});var n=i(274372),a=i(215381),r=i(522715),s=i(345660);function o(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let l=e=>{var t,i;let{inView:a,contentBlock:o,message:l}=e,d=null==o?void 0:null===(t=o.content_obj)||void 0===t?void 0:t.text,u=null!==(i=null==o?void 0:o.meta_infos)&&void 0!==i?i:[],c=(0,r.useCustomSlots)({bizMessage:l});return d?(0,s.jsx)(n.MessageTextContentLitePure,{inView:null!=a&&a,messageBlockText:d,messageBlockMeta:u,messageBlockTextFinish:void 0,messageBlockTextBroken:void 0,message:l,customRenderOptions:{customSlots:c}}):null};class d{constructor(){o(this,"pluginIdentifier",a.receiveTextContentBlockPluginIdentifier),o(this,"type","Content"),o(this,"Content",l)}}},634713:function(e,t,i){i.d(t,{RefContentNode:function(){return d}});var n=i(52963),a=i(812650),r=i.n(a),s=i(792642),o=i(112719),l=i(345660);let d=e=>{let{text:t,icon:i,className:a,allowMultiLine:d,onClick:u,onClickClassName:c}=e,g=(0,s.useIsNarrowScreen)();return(0,l.jsxs)("div",{"data-testid":"ref-content-wrapper",className:r()("flex items-center py-4 text-s-color-text-quaternary rounded-10 !max-w-[var(--self-message-box-max-width,450px)]",u&&(null!=c?c:"hover:bg-s-color-bg-content-base active:bg-s-color-bg-base cursor-pointer"),a),onClick:u,children:[(0,l.jsx)(n.default,{className:r()("text-16 p-2 ml-8 shrink-0",d&&"self-end")}),i,(0,l.jsx)("div",{"data-testid":"ref-content",className:r()("text-W3r3dj","ml-4 mr-8 s-font-small-strong whitespace-normal !font-[450]",d?"line-clamp-3":"truncate"),children:(0,l.jsx)(o.OverflowTextWithTooltip,{textClassName:r()("hyphens-auto",d?"line-clamp-3":"truncate"),lang:"en",text:t,position:g?"bottom":"leftTop"})})]})}},404491:function(e,t,i){i.r(t),i.d(t,{SamanthaChatProtocolPlugin:function(){return eu}});var n,a=i(113849),r=i(266655),s=i(486677),o=i(907929),l=i(154922),d=i(728369),u=i(101874),c=i(60795),g=i(292615),v=i(918092),m=i(703409),f=i(569248),h=i(842356),p=i(698392),_=i(461141),y=i(645298),M=i(495635),b=i(322206),S=i(165482),C=i(178230),T=i(531102),k=i(275859),P=i(106643),I=i(879633),E=i(658080),w=i(670422),x=i(226982),R=i(458524);let j=(e,t,i)=>{var n,a,r;let s=null==t?void 0:null===(n=t.messages)||void 0===n?void 0:n[0],o=null!==(a=e.local_conversation_id)&&void 0!==a?a:null==t?void 0:t.local_conversation_id,l=null!==(r=e.local_message_id)&&void 0!==r?r:null==t?void 0:t.local_message_id;return{message_type:d.EventType.ACK,user_type:R.UserType.Human,content_type:null==s?void 0:s.content_type,conversation_id:e.conversation_id,conversation_type:e.conversation_type,local_message_id:l,local_conversation_id:o,message_id:e.message_id,index:e.message_index,section_id:e.section_id,attachments:null==s?void 0:s.attachments,references:null==s?void 0:s.references,is_delta:!1,reply_id:"0",local_info:i,is_finish:!0,final_status:{message:"Success",session:"Success"}}},N=(e,t,i)=>{var n;let a=null==t?void 0:null===(n=t.messages)||void 0===n?void 0:n[0];return{user_type:R.UserType.Human,message_type:d.EventType.ACK,content_type:null==a?void 0:a.content_type,conversation_id:String(null==t?void 0:t.conversation_id)||"",local_message_id:null==t?void 0:t.local_message_id,local_conversation_id:null==t?void 0:t.local_conversation_id,attachments:null==a?void 0:a.attachments,references:null==a?void 0:a.references,is_delta:!1,reply_id:"0",error_details:{has_error:!0,error_message:e.msg,error_code:e.code,locale:""},local_info:i,is_finish:!0,final_status:{message:"Error",session:"Error"}}},L=(e,t,i)=>{var n;let a=null==t?void 0:null===(n=t.messages)||void 0===n?void 0:n[0],r=e.error_detail;return{user_type:R.UserType.Human,message_type:d.EventType.ACK,content_type:null==a?void 0:a.content_type,conversation_id:String(null==t?void 0:t.conversation_id)||"",local_message_id:null==t?void 0:t.local_message_id,local_conversation_id:null==t?void 0:t.local_conversation_id,attachments:null==a?void 0:a.attachments,references:null==a?void 0:a.references,is_delta:!1,reply_id:"0",error_details:{has_error:!0,error_message:(null==r?void 0:r.message)||"",error_code:(null==r?void 0:r.code)||0,locale:(null==r?void 0:r.locale)||"",extra_info:null==r?void 0:r.ext},local_info:i,is_finish:!0}},A=(e,t,i,n,a,r)=>{let s=e.error_detail;return{user_type:R.UserType.Bot,message_type:d.EventType.CMPL,content_type:x.ContentType.SamanthaLoading,conversation_id:n,reply_id:t,local_conversation_id:null==a?void 0:a.local_conversation_id,is_delta:!1,section_id:i,error_details:{has_error:!0,error_message:(null==s?void 0:s.message)||"",error_code:(null==s?void 0:s.code)||0,locale:(null==s?void 0:s.locale)||"",extra_info:null==s?void 0:s.ext},local_info:r,is_finish:!0}};var O=i(519428),B=i(943143),F=i(674157),D=i(629006),U=i(516655),H=i(689368);let V=(e,t)=>{if(!e||!(null==t?void 0:t.id))return;let i=t.id,n=e[i];for(t.delete_block&&(J(null==t?void 0:t.content_type,{operation:"delete",contentBlockTree:null,contentBlockNodeId:i}),i=t.parent_id);i&&"0"!==i&&(n=e[i]);)J(n.block_type,{operation:"update",contentBlockNodeId:i,contentBlockTree:n}),i=n.parent_id},J=async(e,t)=>{let i=(await (0,U.getChatReceiveMessageContentBlockResolvePluginMatcher)()).find(i=>{var n;return i.matchContentBlock(e,{resourceType:t.contentBlockTree?null===(n=t.contentBlockTree.content_obj)||void 0===n?void 0:n.resource_type:void 0})});if(!i)return;let n=await (0,H.getChatReceiveMessageContentBlockResolvePlugin)(i.pluginIdentifier);null==n||n.resolveContentBlock(t)};var W=i(678669),q=i(884277);async function K(e,t){var i,n,a,r,s,o,l,d,u,c;if((0,D.isThinkingMessageBlock)(t))return e;if(t&&!(null==t?void 0:t.is_delta)&&!t.delete_block){let a={is_delta:!1,is_deleted:!1,is_finish:null!==(i=t.finish_block)&&void 0!==i&&i,block_type:t.content_type,content_obj:t.content_obj,id:t.id,parent_id:t.parent_id,meta_infos:t.meta_infos},{contentBlocksTree:r,contentBlockNodes:s}=(0,q.buildContentBlockTree)([a]);return{...(0,W.default)(t,["block_type","id","parent_id","content_obj"]),content_type:null!==(n=null==e?void 0:e.content_type)&&void 0!==n?n:null==t?void 0:t.content_type,content_blocks:[a],content_blocks_tree:r,content_block_nodes:s,is_delta:!1}}let g={...e,...(0,W.default)(t,["block_type","id","parent_id","content_obj"]),content_type:null!==(a=null==e?void 0:e.content_type)&&void 0!==a?a:null==t?void 0:t.content_type,is_delta:!1,is_finish:null!==(r=null==e?void 0:e.is_finish)&&void 0!==r?r:null==t?void 0:t.is_finish,has_suggest:null!==(s=null==e?void 0:e.has_suggest)&&void 0!==s?s:null==t?void 0:t.has_suggest,content_blocks:(0,O.default)(null==e?void 0:e.content_blocks)||[],tts_content:null!==(o=null==e?void 0:e.tts_content)&&void 0!==o?o:null==t?void 0:t.tts_content},v=null==t?void 0:t.content_type,m=g.content_blocks,f=m.findIndex(e=>e.id===(null==t?void 0:t.id));if(~f){let e=await (0,U.getChatReceiveMessageContentBlockMergePluginMatcher)(),i=(null==t?void 0:t.content_obj)&&(null===(l=t.content_obj)||void 0===l?void 0:l.resource_type)?{resourceType:null===(d=t.content_obj)||void 0===d?void 0:d.resource_type}:void 0,n=e.find(e=>e.matchContentBlock(v,i));if(!n)return g;let a=await (0,H.getChatReceiveMessageContentBlockMergePlugin)(n.pluginIdentifier);if(a&&t){let e={is_delta:!t.reset_block,is_deleted:!!t.delete_block,is_finish:null!==(u=t.finish_block)&&void 0!==u&&u,block_type:t.content_type,content_obj:t.content_obj,id:t.id,parent_id:t.parent_id,meta_infos:t.meta_infos};m[f]=a.mergeContentBlock((0,O.default)(m[f]),e)}}else t&&m.push({is_delta:!1,is_finish:null!==(c=t.finish_block)&&void 0!==c&&c,is_deleted:!!t.delete_block,block_type:t.content_type,content_obj:t.content_obj,id:t.id,parent_id:t.parent_id,meta_infos:t.meta_infos});let{contentBlocksTree:h,contentBlockNodes:p}=(0,q.buildContentBlockTree)(m);return g.content_blocks=m,g.content_blocks_tree=h,g.content_block_nodes=p,g}var G=i(754358),$=i(159738),z=((n=z||{})[n.Start=1]="Start",n[n.Finish=2]="Finish",n);function Y(e,t){if(!e)return{...t,is_delta:!1};if(!t)return e;let i={...e,...t,is_delta:!1};if(e.content_type!==t.content_type)return{...t,is_delta:!1};if(!t.is_delta)return t;if((0,F.isThinkingMessage)(t))return{...t,is_delta:!1};if(t.is_delta){if(t.content_obj){var n,a,r,s,o,l,d,u,c,g,v,m,f,h;(0,$.default)([x.ContentType.SamanthaText,x.ContentType.SamanthaReadOutput],t.content_type)?i.content_obj=(n=e.content_obj,a=t.content_obj,{...n,...a,text:((null==n?void 0:n.text)||"")+((null==a?void 0:a.text)||"")}):(0,$.default)([x.ContentType.SamanthaText,x.ContentType.SamanthaSearchText,x.ContentType.SamanthaWriteOutlineOutput,x.ContentType.SamanthaWriteArtifactOutput],t.content_type)?i.content_obj=(r=e.content_obj,s=t.content_obj,{...r,...s,text:((null==r?void 0:r.text)||"")+((null==s?void 0:s.text)||""),think:((null==r?void 0:r.think)||"")+((null==s?void 0:s.think)||"")}):(0,$.default)([x.ContentType.SamanthaCodeAssistantOutput],t.content_type)?i.content_obj=function(e,t){var i,n,a,r,s,o,l,d;let u;let c=(0,O.default)(t),g=(0,O.default)(e);if(g||(g={}),(null==g?void 0:g.artifact_meta)||(g.artifact_meta=[]),(null==g?void 0:g.artifact_meta)&&!Array.isArray(g.artifact_meta)&&(g.artifact_meta=[g.artifact_meta]),null==c||!c.artifact_meta||(null==c?void 0:null===(i=c.artifact_meta)||void 0===i?void 0:i.code)||(c.artifact_meta={...c.artifact_meta,code:{node_id:"root"}}),(null==c?void 0:null===(n=c.artifact_meta)||void 0===n?void 0:n.code)&&Array.isArray(null==g?void 0:g.artifact_meta)){let e=!1;for(let t=0;t<(null==g?void 0:null===(a=g.artifact_meta)||void 0===a?void 0:a.length);t++){let i=g.artifact_meta[t];if((null==i?void 0:i.code)&&i.artifact_key===c.artifact_meta.artifact_key&&((null===(r=i.code)||void 0===r?void 0:r.node_id)&&(null===(s=i.code)||void 0===s?void 0:s.node_id)===c.artifact_meta.code.node_id||(null===(o=i.code)||void 0===o?void 0:o.path)&&(null===(l=i.code)||void 0===l?void 0:l.path)===c.artifact_meta.code.path)){i.code={...i.code,...c.artifact_meta.code},i.status=null!==(d=c.artifact_meta.status)&&void 0!==d?d:z.Finish,e=!0;break}}e||(c.artifact_meta.code.content="",g.artifact_meta=[...g.artifact_meta,c.artifact_meta])}return Array.isArray(null==g?void 0:g.artifact_meta)&&(u=(0,G.default)(null==g?void 0:g.artifact_meta,e=>{var t;return(null==e?void 0:e.status)===z.Start&&(null==e?void 0:null===(t=e.code)||void 0===t?void 0:t.node_id)!=="root"})),(null==c?void 0:c.text)&&((null==u?void 0:u.code)?u.code.content+=c.text:(null==g?void 0:g.text)?g.text+=c.text:g.text=c.text),(null==c?void 0:c.think)&&((null==g?void 0:g.think)||(g.think=""),g.think+=c.think),g}(e.content_obj,t.content_obj):(0,$.default)([x.ContentType.SamanthaAiPodcastOutput],t.content_type)?i.content_obj=(o=e.content_obj,l=t.content_obj,{...o,...l}):(0,$.default)([x.ContentType.SamanthaCodeInterpreterOutput],t.content_type)?i.content_obj=(d=e.content_obj,u=t.content_obj,{...d,...u,ci_meta:{...(null==d?void 0:d.ci_meta)||{},...(null==u?void 0:u.ci_meta)||{},uri_to_url:{...(null==d?void 0:null===(c=d.ci_meta)||void 0===c?void 0:c.uri_to_url)||{},...(null==u?void 0:null===(g=u.ci_meta)||void 0===g?void 0:g.uri_to_url)||{}}},text:((null==d?void 0:d.text)||"")+((null==u?void 0:u.text)||"")}):(0,$.default)([x.ContentType.SamanthaSuggest],t.content_type)?i.content_obj=(v=e.content_obj,m=t.content_obj,{suggest:[...null!==(f=null==v?void 0:v.suggest)&&void 0!==f?f:[],...null!==(h=null==m?void 0:m.suggest)&&void 0!==h?h:[]]}):i.content_obj=t.content_obj}i.meta_infos=function(e,t){let i=(0,O.default)(e),n=null==i?void 0:i.find(e=>e.type===R.MetaType.Think),a=null==t?void 0:t.find(e=>e.type===R.MetaType.Think);if(n&&a){let e=(0,S.parseJSON)(n.info,{}),t=(0,S.parseJSON)(a.info,{});return e.text=(e.text||"")+(t.text||""),e.title=t.title||e.title||"",e.references=[...e.references||[],...t.references||[]],n.info=(0,S.stringifyJSON)(e),i}return[...null!=e?e:[],...null!=t?t:[]]}(e.meta_infos,t.meta_infos)}return i}let Q={[u.MessageLoadingMachineState.Init]:{[u.MessageLoadingMachineAction.StartText]:u.MessageLoadingMachineState.Text,[u.MessageLoadingMachineAction.StartThink]:u.MessageLoadingMachineState.ThinkStart},[u.MessageLoadingMachineState.Text]:{[u.MessageLoadingMachineAction.StartReference]:u.MessageLoadingMachineState.Reference,[u.MessageLoadingMachineAction.StartText]:u.MessageLoadingMachineState.Text},[u.MessageLoadingMachineState.Reference]:{[u.MessageLoadingMachineAction.StartThink]:u.MessageLoadingMachineState.ThinkStart,[u.MessageLoadingMachineAction.StartText]:u.MessageLoadingMachineState.Text,[u.MessageLoadingMachineAction.EndThink]:u.MessageLoadingMachineState.ThinkEnd},[u.MessageLoadingMachineState.ThinkStart]:{[u.MessageLoadingMachineAction.EndThink]:u.MessageLoadingMachineState.ThinkEnd,[u.MessageLoadingMachineAction.StartText]:u.MessageLoadingMachineState.Text},[u.MessageLoadingMachineState.ThinkEnd]:{}},X={0:u.MessageLoadingMachineAction.StartText,4:u.MessageLoadingMachineAction.StartText,2:u.MessageLoadingMachineAction.StartText,1:u.MessageLoadingMachineAction.StartText,5:u.MessageLoadingMachineAction.StartText,3:u.MessageLoadingMachineAction.StartReference,6:u.MessageLoadingMachineAction.EndThink};function Z(){return{in_loading:!1,state_machine_version:"V1",current_state:{state:u.MessageLoadingMachineState.Init,text:""},loading_state_records:[]}}class ee{getAction(e){return X[e]}nextAction(e,t){let i=Q[this.loading_state.current_state.state][e],n=this.loading_state.current_state;i&&(n.state===u.MessageLoadingMachineState.Init&&i===u.MessageLoadingMachineState.ThinkStart&&(this.loading_state.state_machine_version="V3"),n.state===u.MessageLoadingMachineState.Init&&i===u.MessageLoadingMachineState.Text&&(this.loading_state.state_machine_version="V1"),n.state===u.MessageLoadingMachineState.Reference&&i===u.MessageLoadingMachineState.ThinkStart&&(this.loading_state.state_machine_version="V2"),this.loading_state.current_state.state=i,this.loading_state.loading_state_records.push({state:i,text:t}))}getLoadingState(){return(0,O.default)(this.loading_state)}setIsInLoading(e){this.loading_state.in_loading=e}isInitState(){return this.loading_state.current_state.state===u.MessageLoadingMachineState.Init}resetState(){this.loading_state=Z()}constructor(e=Z()){var t,i,n;i=void 0,(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t="loading_state","string"))?n:n+"")in this?Object.defineProperty(this,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[t]=i,this.loading_state=e}}function et(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class ei{setVersion(e){this._version=e}getPackageInfo(){return this._packagesInfo}recordPackageInfo(e){var t;let{chunk_seq:i}=e;this._packagesInfo=[...this._packagesInfo,{chunkSeq:i,isText:!!(null===(t=e.content_obj)||void 0===t?void 0:t.text)}]}getPackageLength(){return this._packagesInfo.length}writeAsyncTask(e){this._async_task=e}async writeMessage(e){var t,i;this._hasReceivedHasSuggest=!!(null==e?void 0:e.has_suggest);let n=this._completionMessage;if(this._version===w.ProtoVersion.VERSION_NORAML&&((0,F.isThinkingMessage)(e)&&this._loadingMachine.isInitState()||!(0,F.isThinkingMessage)(e))&&(n=Y(this._completionMessage,e)),this._version===w.ProtoVersion.VERSION_BLOCK&&((0,D.isThinkingMessageBlock)(e)?n=Y(this._completionMessage,e):((0,F.isThinkingMessage)(this._completionMessage)&&(this._completionMessage={}),(n=await K(this._completionMessage,e))&&V(n.content_block_nodes,e))),n){if((0,F.isThinkingMessage)(e)){let t=this._loadingMachine.getAction(e.content_obj.type);this._loadingMachine.nextAction(t,e.content_obj.text),this._loadingMachine.setIsInLoading(!0)}else this._loadingMachine.setIsInLoading(!1);t=n,i=this._loadingMachine.getLoadingState(),n={...t,loading_state:i,has_think_reason:t.has_think_reason||(null==i?void 0:i.current_state.state)===u.MessageLoadingMachineState.ThinkStart},this.assignCompletionMessage(n),this.recordPackageInfo(e),(null==n?void 0:n.is_finish)&&this._loadingMachine.resetState()}}writeVerbose(e){this._verboseData={...this._verboseData,...e}}writeConversationId(e){e&&(this._conversationId=e)}writeError(e){var t,i,n;let{errorEvent:a,sentEvent:r,logId:s,traceId:o}=e,l=this._completionMessage,d=a.error_detail,c={...l,...!l&&r?{local_message_id:r.local_message_id,local_conversation_id:String(r.local_conversation_id)}:{},is_delta:!1,message_id:(null==d?void 0:null===(t=d.ext)||void 0===t?void 0:t.message_id)||(null==l?void 0:l.message_id)||"",conversation_id:(null==d?void 0:null===(i=d.ext)||void 0===i?void 0:i.conversation_id)||(null==l?void 0:l.conversation_id)||"",reply_id:(null==d?void 0:null===(n=d.ext)||void 0===n?void 0:n.reply_id)||(null==l?void 0:l.reply_id)||"",error_details:{has_error:!this._hasReceivedHasSuggest,error_message:(null==d?void 0:d.message)||"",error_code:(null==d?void 0:d.code)||B.ErrorCode.Ok,locale:(null==d?void 0:d.locale)||"",extra_info:null==d?void 0:d.ext},local_info:{from:u.MessageFrom.SamanthaChat,log_id:s,trace_id:o},status:this._hasReceivedHasSuggest?R.PushMessageStatus.Available:R.PushMessageStatus.InVisible,final_status:{message:this._hasReceivedHasSuggest?"Success":"Error",suggest:this._hasReceivedHasSuggest?"Error":void 0,session:"Error"}};this.assignCompletionMessage(c)}assignCompletionMessage(e){this._completionMessage=e,this._async_task&&(this._completionMessage.async_task=this._async_task),this._completionMessage.verbose=this._verboseData}writeFin(){let e={...this._completionMessage,is_delta:!1,is_finish:!0};this.assignCompletionMessage(e)}writeFinishReply(e){var t;let{sentEvent:i,logId:n,traceId:a}=e,r={local_conversation_id:String((null==i?void 0:i.local_conversation_id)||""),conversation_id:String(this._conversationId||(null==i?void 0:i.conversation_id)||""),is_delta:!1,...this._completionMessage,local_info:{...null===(t=this._completionMessage)||void 0===t?void 0:t.local_info,finish_reply:!0,log_id:n,trace_id:a,from:u.MessageFrom.SamanthaChat}};this.assignCompletionMessage(r)}read(){return this._completionMessage?{...this._completionMessage}:void 0}constructor(e,t,i){et(this,"streamId",void 0),et(this,"_completionMessage",void 0),et(this,"_conversationId",void 0),et(this,"_packagesInfo",[]),et(this,"_verboseData",{}),et(this,"_loadingMachine",void 0),et(this,"_version",w.ProtoVersion.VERSION_NORAML),et(this,"_async_task",void 0),et(this,"_hasReceivedAck",!1),et(this,"_hasReceivedHasSuggest",!1),this.streamId=e,this._version=t,this._conversationId=null==i?void 0:i.conversation_id,this._completionMessage=i,this._hasReceivedAck=!!i,this._hasReceivedHasSuggest=!!(null==i?void 0:i.has_suggest),this._loadingMachine=new ee((0,O.default)(null==i?void 0:i.loading_state))}}function en(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class ea{_createMessagePipeIfNeed(e){return this.messagePipes[e]||(this.messagePipes[e]=new ei(e,this._version),this.messagePipes[e].writeConversationId(this._conversationId)),this.messagePipes[e]}setVersion(e){this._version=e.proto_version||w.ProtoVersion.VERSION_NORAML,(0,r.default)(this.messagePipes).forEach(t=>{t.setVersion(e.proto_version)})}writeConversationId(e){e&&(this._conversationId=e)}writeSentMessageId(e){e&&(this._sentMessageId=e)}writeSentSectionId(e){e&&(this._sentSectionId=e)}getPackageInfo(){return this._packagesInfo}recordPackageInfo(e,t){this._packagesInfo=[...this._packagesInfo,{chunkSeq:t,isText:e}]}getPackageLength(){return this._packagesInfo.length}createAckMessage(e,t,i,n){return this.hasReceivedAck=!0,j(e,t,{log_id:i,from:u.MessageFrom.SamanthaChat,trace_id:n})}createAckErrorMessageInGateway(e,t,i,n){return N(e,t,{log_id:i,from:u.MessageFrom.SamanthaChat,trace_id:n})}createAckErrorMessageInErrorEvent(e,t,i,n){return L(e,t,{log_id:i,from:u.MessageFrom.SamanthaChat,trace_id:n})}createReceiveLoadingErrorMessageInErrorEvent(e,t,i,n){if(this._sentMessageId&&this._sentSectionId)return A(e,this._sentMessageId,this._sentSectionId,this._conversationId||(null==t?void 0:t.conversation_id)||"",t,{log_id:i,from:u.MessageFrom.SamanthaChat,trace_id:n})}getMessages(){let e=(0,s.default)(this.messagePipes).map(e=>{let[t,i]=e;return[t,i.read()]}).filter(e=>!!e[1]);return(0,E.default)(e)}getAllMessagePipes(){return(0,r.default)(this.messagePipes)}getMessagePipeByReceiveMessageId(e){let t=(0,r.default)(this.messagePipes).find(t=>{var i;return(null===(i=t.read())||void 0===i?void 0:i.message_id)===e});return t||this._createMessagePipeIfNeed(`0_${e}`)}getMessagePipeByStreamId(e){return this._createMessagePipeIfNeed(e)}constructor(e,t=w.ProtoVersion.VERSION_NORAML,i){en(this,"_packagesInfo",[]),en(this,"messagePipes",{}),en(this,"_version",void 0),en(this,"hasReceivedAck",!1),en(this,"_conversationId",void 0),en(this,"_sentMessageId",void 0),en(this,"_sentSectionId",void 0),this.hasReceivedAck=e,this._version=t,i&&(this.messagePipes=(0,E.default)((0,s.default)(i).map(e=>{let[t,i]=e;return[t,new ei(t,this._version,i)]})))}}function er(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class es{async writeBlock(e){for(let t of e){let e=this._completionMessage;if(!(e=await K(this._completionMessage,t)))return;V(e.content_block_nodes,t),this.assignCompletionMessage(e)}}writeError(e){let{errorEvent:t,logId:i,traceId:n}=e,a=this._completionMessage,r=t.error_detail,s={...a,is_delta:!1,error_details:{has_error:!0,error_message:(null==r?void 0:r.message)||"",error_code:(null==r?void 0:r.code)||B.ErrorCode.Ok,locale:(null==r?void 0:r.locale)||"",extra_info:null==r?void 0:r.ext},local_info:{from:u.MessageFrom.AsyncTask,async_task_log_id:i,async_task_trace_id:n},final_status:{message:"Error",session:"Error"}};this.assignCompletionMessage(s)}writeFinishAsyncReply(e){var t,i,n;let{sentEvent:a,logId:r,traceId:s,finEvent:o}=e,l={is_delta:!1,...this._completionMessage,async_task:{id:a.task_id||"",status:null!==(n=null==o?void 0:null===(t=o.async_task)||void 0===t?void 0:t.status)&&void 0!==n?n:d.AsyncTaskStatus.AsyncTaskStatusSucceed},local_info:{...null===(i=this._completionMessage)||void 0===i?void 0:i.local_info,finish_async_reply:!0,async_task_log_id:r,async_task_trace_id:s,from:u.MessageFrom.AsyncTask}};this.assignCompletionMessage(l)}assignCompletionMessage(e){this._completionMessage=e,this._completionMessage.verbose=this._verboseData}read(){return this._completionMessage?{...this._completionMessage}:void 0}writeVerbose(e){this._verboseData={...this._verboseData,...e}}constructor(e){er(this,"_completionMessage",void 0),er(this,"_verboseData",{}),this._completionMessage=e,this._verboseData=(null==e?void 0:e.verbose)||{}}}function eo(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class el{updateCommonHttpConfig(e){this._getCommonHttpParams=e.getCommonHttpParams,this._getCommonHttpHeaders=e.getCommonHttpHeaders}_generateHandlers(e,t){let i=i=>{C.logger.persist.error({error:i,message:"unexpected_error_fetch_async_sse_stream_failed",meta:{task_id:t}});let{retryCounter:n,instance:a,sentEvent:r,lastEventId:s}=this._fetchEntriesMap[t]||{};if((null==a?void 0:a.isAborted)||(null==n?void 0:n.matchMaxRetryAttempts()))return;let o=e.read();this._createTask({sentEvent:r,lastEventId:s,message:o,retryCounter:n}),null==n||n.add()};return{onError:i,onOpen:e=>{C.logger.persist.info({eventName:"fetch_async_sse_stream_start",meta:{task_id:t}});let i=this._fetchEntriesMap[t],n=e.headers.get("content-type");if(!(null==e?void 0:e.ok)||!(null==e?void 0:e.body))throw Error(`Invalid Response, ResponseStatus: ${e.statusText}`);if(i&&(i.logId=e.headers.get("x-tt-logid")||"",i.traceId=e.headers.get("x-tt-trace-id")||"",!(null==n?void 0:n.startsWith(c.EventStreamContentType))))throw this.cancelTask(t),Error("Invalid Response, Invalid Content-Type")},onMessage:n=>{let a=this._fetchEntriesMap[t];if(!a)return;let r=async()=>{try{let i=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore"),{logId:r,sentEvent:s,traceId:o}=a,{data:l=""}=n,{event_data:c="",event_type:g,event_id:v}=(0,S.parseJSON)(l,{});switch(v&&(a.lastEventId=v,i.getState().updateSamanthaChatAsyncTaskEventId(s.task_id||"",v)),g){case d.EventType.BLOCKLIST:{let t=(0,S.parseJSON)(c,{}).blocks.map(e=>({is_delta:!0,id:e.id,content_type:e.content_type,content_obj:(0,S.parseJSON)(e.content,{}),meta_infos:e.meta_infos,parent_id:e.pid,reset_block:e.reset,finish_block:e.is_finish,delete_block:e.deleted,local_info:{from:u.MessageFrom.AsyncTask,async_task_log_id:r,async_task_trace_id:o}}));await e.writeBlock(t);let n=e.read();n&&(i.getState().updateSamanthaChatAsyncTaskMessage(s.task_id||"",n),this.eventEmitter.emit("message",n));return}case d.EventType.ERR:{let t=(0,S.parseJSON)(c,{});e.writeError({errorEvent:t,logId:r,traceId:o});let n=e.read();n&&(i.getState().updateSamanthaChatAsyncTaskMessage(s.task_id||"",n),this.eventEmitter.emit("message",n));return}case d.EventType.FIN:{let n=(0,S.parseJSON)(c,{});e.writeFinishAsyncReply({sentEvent:s,logId:r,finEvent:n,traceId:o});let a=e.read();a&&(i.getState().updateSamanthaChatAsyncTaskMessage(s.task_id||"",a),this.eventEmitter.emit("message",a)),this._handleFinish(t);return}case d.EventType.VERBOSE:{let t=(0,S.parseJSON)(c,{});e.writeVerbose(t);return}default:return}}catch(e){i(e)}};a.pqueue.add(r)},onClose:e=>{C.logger.persist.info({eventName:"fetch_async_sse_stream_close",meta:{close_event:e,task_id:t}})}}}async _handleFinish(e){let t=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore");delete this._fetchEntriesMap[e],t.getState().removeSamanthaAsyncChatTask(e)}_createTask(e){var t,i;let{sentEvent:n,message:r,lastEventId:o="0",retryCounter:l=new v.RetryCounter(5)}=e;if(!n)return;let d=new es(r),u=new a.default({concurrency:1}),c=this._generateHandlers(d,n.task_id||""),m=(0,g.createFetchStream)((0,f.getUrl)("/samantha/chat/async/stream",null===(t=this._getCommonHttpParams)||void 0===t?void 0:t.call(this)),{method:"POST",headers:[["content-type","application/json"],["Agw-Js-Conv","str"],...(0,s.default)((null===(i=this._getCommonHttpHeaders)||void 0===i?void 0:i.call(this))||{})],body:(0,S.stringifyJSON)({...n,event_id:Number(o)}),credentials:"same-origin",onError:c.onError,onMessage:c.onMessage,openInterceptor:c.onOpen,onClose:c.onClose});m&&(this._fetchEntriesMap[n.task_id||""]={instance:m,logId:"",sentEvent:n,lastEventId:o,retryCounter:l,pqueue:u,messagePipe:d,traceId:""})}async createTask(e,t){!this._fetchEntriesMap[t]&&((await (0,p.getAsyncChatStore)("samanthaChatProtocolStore")).getState().createSamanthaAsyncChatTask(t,{task_id:t},e),this._createTask({message:e,sentEvent:{task_id:t}}))}async cancelTask(e){var t,i;let n=Error("cancel request");Error.captureStackTrace&&Error.captureStackTrace(n),C.logger.console.error({error:n}),null===(i=this._fetchEntriesMap[e])||void 0===i||null===(t=i.instance)||void 0===t||t.cancel(n.message),delete this._fetchEntriesMap[e],(await (0,p.getAsyncChatStore)("samanthaChatProtocolStore")).getState().removeSamanthaAsyncChatTask(e)}resumeTask(e){for(let t of e){let{taskId:e}=t;if(this._fetchEntriesMap[e])return;this._createTask({lastEventId:t.lastEventId,sentEvent:t.sentEvent,message:t.message})}}async drop(){let e=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore");for(let i of(0,o.default)((0,r.default)(this._fetchEntriesMap),e=>!!e)){var t;null==i||i.instance.cancel("drop adapter");let n=null==i?void 0:null===(t=i.sentEvent)||void 0===t?void 0:t.task_id;n&&e.getState().removeSamanthaAsyncChatTask(n)}this._fetchEntriesMap={}}constructor(e){eo(this,"eventEmitter",new l.default),eo(this,"_fetchEntriesMap",{}),eo(this,"_createFetchStream",void 0),eo(this,"_getCommonHttpParams",void 0),eo(this,"_getCommonHttpHeaders",void 0),eo(this,"_initialed",!1),this.eventEmitter.on("message",e.handleMessage)}}function ed(e,t,i){var n;return(t="symbol"==typeof(n=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?n:n+"")in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class eu{init(){var e;if(this._initialed)return;this._initialed=!0;let{getCommonHeaders:t,getCommonParams:i}=null!==(e=(0,M.getFlowApiOptions)())&&void 0!==e?e:{};this._getCommonHttpParams=i,this._getCommonHttpHeaders=t,this._asyncTaskManager.updateCommonHttpConfig({getCommonHttpParams:i,getCommonHttpHeaders:t})}pullMessage(e){}_generateHandlers(e,t){let i=i=>{var n,a;C.logger.persist.error({error:i,message:"unexpected_error_fetch_sse_stream_failed"});let{retryCounter:r,instance:s,sentEvent:o,lastEventId:l}=this._fetchEntriesMap[t]||{};if((null==o?void 0:null===(n=o.completion_option)||void 0===n?void 0:n.launch_stage)===b.LaunchStage.Diff||(null==s?void 0:s.isAborted)&&(null==s?void 0:s.abortReason)!=="timeout"||(null==r?void 0:r.matchMaxRetryAttempts()))return;let d=e.getMessages();(null==o?void 0:null===(a=o.completion_option)||void 0===a?void 0:a.is_regen)&&(o.completion_option.is_regen=!1),this._sendMessage({sentEvent:o,lastEventId:l,messages:d,retryCounter:r}),null==r||r.add()};return{onError:i,onOpen:async i=>{let n=this._fetchEntriesMap[t],a=i.headers.get("content-type");if(!(null==i?void 0:i.ok)||!(null==i?void 0:i.body))throw Error(`Invalid Response, ResponseStatus: ${i.statusText}`);if(n){if(n.logId=i.headers.get("x-tt-logid")||"",n.traceId=i.headers.get("x-tt-trace-id")||"",!(null==a?void 0:a.startsWith(c.EventStreamContentType))){let a=await i.json(),{logId:r,sentEvent:s,traceId:o}=n,l=e.createAckErrorMessageInGateway(a,s,r,o);throw l&&this.eventEmitter.emit("message",l),this.cancelTask(t),Error("Invalid Response, Invalid Content-Type")}(0,k.checkLoginStatusAndLogout)(i)}},onMessage:n=>{var a;let r=this._fetchEntriesMap[t];if(!r)return;null==r||null===(a=r.retryCounter)||void 0===a||a.updateConnectingTimeoutTimer(()=>{var e,t;null==r||null===(t=r.instance)||void 0===t||null===(e=t.cancel)||void 0===e||e.call(t,"timeout"),C.logger.persist.info("fetch_sse_stream_heartbeat_timeout")});let s=async()=>{try{var a,s,o,l,u,c,g;let i=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore"),{logId:v,sentEvent:m,traceId:f}=r,{data:h="",event:_}=n;if((null==m?void 0:null===(a=m.completion_option)||void 0===a?void 0:a.launch_stage)===b.LaunchStage.Diff)return;if("gateway-error"===_&&!e.hasReceivedAck){let i=e.createAckErrorMessageInErrorEvent({error_detail:{code:0x2a520e5e,message:h,locale:"",ext:{}},code:0x2a520e5e,message:h},m,v,f);i&&this.eventEmitter.emit("message",i),null==r||null===(s=r.retryCounter)||void 0===s||s.clearConnectionHeartbeatTimeoutTimer(),this._handleFinish(t);return}let{event_data:y="",event_type:M,event_id:T}=(0,S.parseJSON)(h,{});switch(T&&1!==M&&(r.lastEventId=T,i.getState().updateSamanthaChatTaskEventId(m.local_message_id||"",T)),M){case d.EventType.ACK:{let t=(0,S.parseJSON)(y,{});e.writeConversationId(t.conversation_id),e.writeSentMessageId(t.message_id),e.writeSentSectionId(t.section_id);let i=e.createAckMessage(t,m,v,f);i&&this.eventEmitter.emit("message",i);return}case d.EventType.CMPL:{let t=(0,S.parseJSON)(y,{}),n=e.getMessagePipeByStreamId(String(t.stream_id)),{reason:a,async_task:r}=t.fin_reason||{},s=a===d.FinReasonEnum.FinReasonAsyncTask&&(null==r?void 0:r.id);s&&n.writeAsyncTask(r),await n.writeMessage(await (0,P.transformSamanthaChatMessageToMessage)(t,{log_id:v,trace_id:f,from:this.from,event_id:T}));let l=n.read();l&&(e.recordPackageInfo(!!(null==l?void 0:null===(o=l.content_obj)||void 0===o?void 0:o.text),String(l.chunk_seq)),i.getState().updateSamanthaChatTaskMessage(m.local_message_id||"",n.streamId,l),s&&this._asyncTaskManager.createTask(l,r.id),this.eventEmitter.emit("message",l));return}case d.EventType.FIN:for(let t of e.getAllMessagePipes()){t.writeFinishReply({sentEvent:m,logId:v,traceId:f});let n=t.read();if(n){i.getState().updateSamanthaChatTaskMessage(m.local_message_id||"",t.streamId,n);let a={...n,local_info:n.local_info?{...n.local_info,trace_pkg_info:e.getPackageInfo()}:void 0};this.eventEmitter.emit("message",a)}}null==r||null===(l=r.retryCounter)||void 0===l||l.clearConnectionHeartbeatTimeoutTimer(),this._handleFinish(t);return;case d.EventType.VERBOSE:{let t=(0,S.parseJSON)(y,{});e.getMessagePipeByStreamId(String(t.stream_id)).writeVerbose(t);return}case d.EventType.ERR:{let t=(0,S.parseJSON)(y,{});if(C.logger.persist.info(`received_error_event: ${JSON.stringify(t)}`),!e.hasReceivedAck){let i=e.createAckErrorMessageInErrorEvent(t,m,v,f);i&&this.eventEmitter.emit("message",i);return}if(e.hasReceivedAck){let n=null==t?void 0:null===(g=t.error_detail)||void 0===g?void 0:null===(c=g.ext)||void 0===c?void 0:c.message_id,a=n?[e.getMessagePipeByReceiveMessageId(n)]:e.getAllMessagePipes();if(!a.length){let i=e.createReceiveLoadingErrorMessageInErrorEvent(t,m,v,f);i&&this.eventEmitter.emit("message",i);return}for(let e of a){e.writeError({errorEvent:t,sentEvent:m,logId:v,traceId:f});let n=e.read();n&&(i.getState().updateSamanthaChatTaskMessage(m.local_message_id||"",e.streamId,n),this.eventEmitter.emit("message",n))}return}null==r||null===(u=r.retryCounter)||void 0===u||u.clearConnectionHeartbeatTimeoutTimer();return}case d.EventType.VERSION:{let t=(0,S.parseJSON)(y,{});e.setVersion(t),i.getState().updateSamanthaChatTaskProtoVersion(m.local_message_id||"",t.proto_version);return}default:return}}catch(e){i(e)}};r.pqueue.add(s)}}}async _handleFinish(e){let t=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore");delete this._fetchEntriesMap[e],t.getState().removeSamanthaChatTask(e)}async _sendMessage(e){var t,i,n;let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{headers:{}},{receiveStreamPackageUpdateTimeout:l=y.defaultReceiveStreamPackageUpdateTimeout}=(0,_.getChatConfig)("chatMessageConfig")||{},{sentEvent:d,messages:u,lastEventId:c="0",retryCounter:m=new v.RetryCounter(5,l),protoVersion:h}=e;if(!d)return;let p=new ea(!!(null===(t=(0,r.default)(u))||void 0===t?void 0:t.length),h,u),M=new a.default({concurrency:1}),b=this._generateHandlers(p,d.local_message_id||""),C=(0,g.createFetchStream)((0,f.getUrl)("/samantha/chat/completion",{...null===(i=this._getCommonHttpParams)||void 0===i?void 0:i.call(this),fp:await (0,T.getFPForVerifyCenter)()}),{method:"POST",headers:[["content-type","application/json"],["Agw-Js-Conv","str"],...(0,s.default)((null===(n=this._getCommonHttpHeaders)||void 0===n?void 0:n.call(this))||{}),...(0,s.default)(o.headers)],body:(0,S.stringifyJSON)({...d,completion_option:{...d.completion_option,event_id:c}}),credentials:"same-origin",onError:b.onError,onMessage:b.onMessage,openInterceptor:b.onOpen});C&&(this._fetchEntriesMap[d.local_message_id||""]={instance:C,logId:"",sentEvent:d,lastEventId:c,retryCounter:m,pqueue:M,pipeManager:p,traceId:""})}async sendMessage(e,t){var i,n,a,r;let s=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore");this._initialed||this.init();let o=null===(n=e[0])||void 0===n?void 0:null===(i=n.ext)||void 0===i?void 0:i.useSamanthaChat,l=await (0,I.transformMessageToSamanthaChatMessage)(e,{launchStage:o?1:null===(r=e[0])||void 0===r?void 0:null===(a=r.local)||void 0===a?void 0:a.samanthaChatStage});s.getState().createSamanthaChatTask(l.local_message_id||"",l),this._sendMessage({sentEvent:l},t)}async cancelTask(e){var t,i;let n=Error("cancel request");Error.captureStackTrace&&Error.captureStackTrace(n),C.logger.console.error({error:n});let a=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore");null===(i=this._fetchEntriesMap[e])||void 0===i||null===(t=i.instance)||void 0===t||t.cancel(n.message),delete this._fetchEntriesMap[e],a.getState().removeSamanthaChatTask(e)}resumeTask(e){for(let i of(this._initialed||this.init(),e)){var t;let{localMessageId:e}=i;if(!e||this._fetchEntriesMap[e])return;(null===(t=i.sentEvent.completion_option)||void 0===t?void 0:t.is_regen)&&(i.sentEvent.completion_option.is_regen=!1),this._sendMessage({lastEventId:i.lastEventId,sentEvent:i.sentEvent,messages:i.messages,protoVersion:i.protoVersion})}}createAsyncTask(e,t){this._initialed||this.init(),this._asyncTaskManager.createTask(e,t)}resumeAsyncTask(e){this._initialed||this.init(),this._asyncTaskManager.resumeTask(e)}cancelAsyncTask(e){this._asyncTaskManager.cancelTask(e)}async drop(){let e=await (0,p.getAsyncChatStore)("samanthaChatProtocolStore");for(let n of(0,o.default)((0,r.default)(this._fetchEntriesMap),e=>!!e)){var t,i;null==n||n.instance.cancel("drop adapter"),null==n||null===(t=n.retryCounter)||void 0===t||t.clearConnectionHeartbeatTimeoutTimer();let a=null==n?void 0:null===(i=n.sentEvent)||void 0===i?void 0:i.local_message_id;a&&e.getState().removeSamanthaChatTask(a)}this._fetchEntriesMap={},this._asyncTaskManager.drop()}constructor(){ed(this,"from",u.MessageFrom.SamanthaChat),ed(this,"eventEmitter",new l.default),ed(this,"_fetchEntriesMap",{}),ed(this,"_createFetchStream",void 0),ed(this,"_getCommonHttpParams",void 0),ed(this,"_getCommonHttpHeaders",void 0),ed(this,"_initialed",!1),ed(this,"_asyncTaskManager",void 0),(0,m.subscribeEvent)([this],{message:h.handleMessage}),this._asyncTaskManager=new el({handleMessage:h.handleMessage})}}},490819:function(e,t,i){i.r(t),i.d(t,{initSamanthaChatProtocolStore:function(){return v}});var n=i(952259),a=i(321647),r=i(266655),s=i(459735),o=i(746479),l=i(670422),d=i(191360);let u=e=>({samanthaChatTaskMap:e.samanthaChatTaskMap,samanthaChatAsyncTaskMap:e.samanthaChatAsyncTaskMap}),c=(e,t)=>({samanthaChatTaskMap:{},samanthaChatAsyncTaskMap:{},updateSamanthaChatAsyncTaskEventId:(i,n)=>(e((0,o.produce)(e=>{let t=e.samanthaChatAsyncTaskMap[i];t&&(t.lastEventId=n)})),t().samanthaChatAsyncTaskMap[i]),updateSamanthaChatAsyncTaskMessage:(i,n)=>(e((0,o.produce)(e=>{let t=e.samanthaChatAsyncTaskMap[i];t&&(t.message=n)})),t().samanthaChatAsyncTaskMap[i]),createSamanthaAsyncChatTask(i,n,a){let r=t().samanthaChatAsyncTaskMap[i];return r||(e((0,o.produce)(e=>{i&&(e.samanthaChatAsyncTaskMap[i]={createTime:Date.now(),taskId:i,sentEvent:n,message:a})})),t().samanthaChatAsyncTaskMap[i])},removeSamanthaAsyncChatTask(t){e((0,o.produce)(e=>{delete e.samanthaChatAsyncTaskMap[t]}))},updateSamanthaChatTaskMessage:(i,n,a)=>(e((0,o.produce)(e=>{let t=e.samanthaChatTaskMap[i];t&&(t.messages||(t.messages={}),t.messages[n]=a)})),t().samanthaChatTaskMap[i]),updateSamanthaChatTaskProtoVersion:(i,n)=>(e((0,o.produce)(e=>{let t=e.samanthaChatTaskMap[i];t&&(t.protoVersion=n)})),t().samanthaChatTaskMap[i]),updateSamanthaChatTaskEventId:(i,n)=>(e((0,o.produce)(e=>{let t=e.samanthaChatTaskMap[i];t&&(t.lastEventId=n)})),t().samanthaChatTaskMap[i]),createSamanthaChatTask(i,n){let a=t().samanthaChatTaskMap[i];return a||(e((0,o.produce)(e=>{i&&(e.samanthaChatTaskMap[i]={createTime:Date.now(),localMessageId:i,sentEvent:n,protoVersion:l.ProtoVersion.VERSION_NORAML})})),t().samanthaChatTaskMap[i])},removeSamanthaChatTask(t){e((0,o.produce)(e=>{delete e.samanthaChatTaskMap[t]}))}}),g=(e,t)=>{var i;let n={...t,...e||{}};return(null===(i=(0,r.default)(n.samanthaChatTaskMap))||void 0===i?void 0:i.length)?{...n,samanthaChatTaskMap:(0,s.default)(n.samanthaChatTaskMap,e=>Date.now()-e.createTime>3e5),samanthaChatAsyncTaskMap:(0,s.default)(n.samanthaChatAsyncTaskMap,e=>Date.now()-e.createTime>36e5)}:n},v=async e=>{let{prefix:t,isEnableDebug:i,reduxDevToolsSnapshot:r,merge:s,partialize:o,storage:l}=e,v=(0,d.createPersistOptions)({name:"chat-samantha-chat-protocol-store",prefix:t||"default",version:1.5,partialize:null!=o?o:u,storage:l,merge:null!=s?s:g}),m=(0,n.persist)((0,n.subscribeWithSelector)(c),v);if(i&&r){let e=(0,a.create)()((0,n.devtools)(m,{name:`${t}-chat-samantha-chat-protocol-store`}));return e.persist.hasHydrated()?e:await new Promise(t=>e.persist.onFinishHydration(i=>{t(e)}))}{let e=(0,a.create)()(m);return e.persist.hasHydrated()?e:await new Promise(t=>e.persist.onFinishHydration(i=>{t(e)}))}}},879633:function(e,t,i){i.d(t,{transformMessageToSamanthaChatMessage:function(){return c}});var n=i(229079),a=i(217957),r=i(516655),s=i(689368),o=i(322206),l=i(165482),d=i(296493);let u=async e=>{let t=await (0,r.getChatProtocolTransformPluginMatcher)();if(t){var i;let n=null===(i=t.find(t=>{var i;return null===(i=t.matchPluginForMessageToSamanthaChatMessage)||void 0===i?void 0:i.call(t,e)}))||void 0===i?void 0:i.pluginIdentifier,a=await (0,s.getChatProtocolTransformPlugin)(n);if(null==a?void 0:a.messageToSamanthaChatMessage)return null==a?void 0:a.messageToSamanthaChatMessage(e)}},c=async function(e){var t,i,r,s,c,g,v,m,f,h,p,_,y,M,b,S,C,T,k,P,I,E,w,x,R,j,N,L,A,O,B,F,D,U,H,V,J,W,q,K,G,$,z,Y,Q,X,Z,ee,et;let ei,en=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{memoryType:ea,launchStage:er}=en,es=await Promise.all(e.map(u)),eo=null===(i=e[0])||void 0===i?void 0:null===(t=i.ext)||void 0===t?void 0:t.samantha_onboarding,el=(0,d.toValidBoolean)((null===(s=e[0])||void 0===s?void 0:null===(r=s.ext)||void 0===r?void 0:r.use_deep_think)==="1"||!["0","2"].includes((null===(g=e[0])||void 0===g?void 0:null===(c=g.ext)||void 0===c?void 0:c.use_deep_think)||"")&&void 0),ed=null!==(Z=null===(m=e[0])||void 0===m?void 0:null===(v=m.ext)||void 0===v?void 0:v.artifact_key)&&void 0!==Z?Z:(0,n.default)((0,l.parseJSON)(null===(f=e[0].ext)||void 0===f?void 0:f.input_skill,{}),"variables.artifact_key"),eu=(0,d.toValidBoolean)((0,n.default)((0,l.parseJSON)(null===(h=e[0].ext)||void 0===h?void 0:h.input_skill,{}),"variables.disable_canvas")),ec=(0,a.default)(ed)||eu?void 0:String(ed);return(null===(_=e[0])||void 0===_?void 0:null===(p=_.ext)||void 0===p?void 0:p.thread_source)&&(ei=null===(et=e[0])||void 0===et?void 0:null===(ee=et.ext)||void 0===ee?void 0:ee.thread_source),{messages:es.filter(d.notUndefined),completion_option:{is_regen:(null===(M=e[0])||void 0===M?void 0:null===(y=M.ext)||void 0===y?void 0:y.regen)==="1",with_suggest:(null===(S=e[0])||void 0===S?void 0:null===(b=S.ext)||void 0===b?void 0:b.answer_with_suggest)==="1",need_create_conversation:!!(null===(C=e[0])||void 0===C?void 0:C.local_conversation_id),launch_stage:er,is_replace:(null===(k=e[0])||void 0===k?void 0:null===(T=k.ext)||void 0===T?void 0:T.replace)==="1",is_delete:(null===(I=e[0])||void 0===I?void 0:null===(P=I.ext)||void 0===P?void 0:P.delete)==="1",memory_type:ea,message_from:(null===(w=e[0])||void 0===w?void 0:null===(E=w.ext)||void 0===E?void 0:E.send_from_desktop_launcher_share)==="1"?o.MessageFrom.SharedApp:(null===(R=e[0])||void 0===R?void 0:null===(x=R.ext)||void 0===x?void 0:x.send_from_desktop_launcher)==="1"?o.MessageFrom.DesktopLauncher:(null===(N=e[0])||void 0===N?void 0:null===(j=N.ext)||void 0===j?void 0:j.send_from_pc_push)==="1"?o.MessageFrom.DesktopPush:(null===(A=e[0])||void 0===A?void 0:null===(L=A.ext)||void 0===L?void 0:L.send_from_skill_guidance_or_suggestion)==="1"?o.MessageFrom.GuidanceOrSuggestion:(null===(B=e[0])||void 0===B?void 0:null===(O=B.ext)||void 0===O?void 0:O.send_from_canvas_action_bar)==="1"?o.MessageFrom.CanvasActionbar:o.MessageFrom.InputBox,onboarding:eo||void 0,artifact_key:ec,disable_canvas:eu,use_deep_think:el,use_auto_cot:(0,d.toValidBoolean)((null===(D=e[0])||void 0===D?void 0:null===(F=D.ext)||void 0===F?void 0:F.use_deep_think)==="2"),selected_regen_id:null===(H=e[0])||void 0===H?void 0:null===(U=H.ext)||void 0===U?void 0:U.lastRegenerateSelectedMessageId,shared_app_name:(null===(J=e[0])||void 0===J?void 0:null===(V=J.ext)||void 0===V?void 0:V.send_from_desktop_launcher_share)==="1"?null===(q=e[0])||void 0===q?void 0:null===(W=q.ext)||void 0===W?void 0:W.shared_app_name:void 0,resend_for_regen:(null===(G=e[0])||void 0===G?void 0:null===(K=G.ext)||void 0===K?void 0:K.resend_for_regen)==="1",thread_source:ei},evaluate_option:{web_ab_params:(null===(z=e[0])||void 0===z?void 0:null===($=z.ext)||void 0===$?void 0:$.web_ab_params)||""},related_share_id:null===(Q=e[0])||void 0===Q?void 0:null===(Y=Q.ext)||void 0===Y?void 0:Y.related_share_id,section_id:(null===(X=e[0])||void 0===X?void 0:X.section_id)||void 0,conversation_id:e[0].conversation_id||void 0,local_conversation_id:e[0].local_conversation_id,local_message_id:e[0].local_message_id,message_id:e[0].message_id||void 0,reply_id:e[0].reply_id||void 0}}},106643:function(e,t,i){i.d(t,{transformSamanthaChatMessageToMessage:function(){return u}});var n=i(728369),a=i(590475),r=i(516655),s=i(689368),o=i(588426),l=i(458524),d=i(165482);let u=async(e,t)=>{var i,a,u,g,v,m,f,h,p,_,y,M,b,S,C;let T=e.is_finish?"Success":void 0,k={...e.message,bot_id:e.bot_id,conversation_type:(0,o.getConversationTypeById)(e.conversation_id)||(0,o.getConversationTypeById)(e.local_conversation_id,!0),message_type:n.EventType.CMPL,conversation_id:e.conversation_id,local_conversation_id:e.local_conversation_id,message_id:e.message_id,index:e.message_index,is_delta:e.is_delta,has_suggest:e.has_suggest,reply_id:e.reply_id,status:e.status,user_type:l.UserType.Bot,chunk_seq:null==t?void 0:t.event_id,local_info:t,content_obj:(0,d.parseJSON)(null===(i=e.message)||void 0===i?void 0:i.content,{}),section_id:e.section_id,is_regen:e.is_regen,regen_active:e.is_regen,is_finish:e.is_finish,stream_id:e.stream_id,...c(e.input_content_type||(null===(a=e.message)||void 0===a?void 0:a.content_type)),tts_content:e.tts_content,message_action_bar:{invisible:null===(u=e.message_action_bar)||void 0===u?void 0:u.invisible,config:(0,d.parseJSON)(null===(g=e.message_action_bar)||void 0===g?void 0:g.config,{})},final_status:{message:T,session:T}};(null===(v=e.message)||void 0===v?void 0:v.pid)!==void 0&&(k.parent_id=null===(p=e.message)||void 0===p?void 0:p.pid),(null===(m=e.message)||void 0===m?void 0:m.reset)!==void 0&&(k.reset_block=null!==(y=null===(_=e.message)||void 0===_?void 0:_.reset)&&void 0!==y&&y),(null===(f=e.message)||void 0===f?void 0:f.is_finish)!==void 0&&(k.finish_block=null!==(b=null===(M=e.message)||void 0===M?void 0:M.is_finish)&&void 0!==b&&b),(null===(h=e.message)||void 0===h?void 0:h.pid)!==void 0&&(k.parent_id=null===(S=e.message)||void 0===S?void 0:S.pid);let P=await (0,r.getChatProtocolTransformPluginMatcher)();if(P){let i=null===(C=P.find(e=>{var t;return null===(t=e.matchPluginForSamanthaChatMessageToMessage)||void 0===t?void 0:t.call(e,k)}))||void 0===C?void 0:C.pluginIdentifier,n=await (0,s.getChatProtocolTransformPlugin)(i);if(null==n?void 0:n.samanthaChatMessageToMessage)return n.samanthaChatMessageToMessage(k,e,t)}return k},c=e=>{var t;let i=null!==(t=a.SamanthaContentTypeToSkillTyeMap[e])&&void 0!==t?t:0;return{skill:{skill_type:i,skill_type_no_default:i||null,skill_id:`${i}`,skill_id_no_default:i?`${i}`:null}}}},275859:function(e,t,i){i.d(t,{checkLoginStatusAndLogout:function(){return o}});var n=i(102249),a=i(992847),r=i(198660),s=i(690619);function o(e){let t=e.headers.get("x-tt-flow-login")||e.headers.get("x-tt-agw-login"),i=(0,r.getIsLoggedIn)();"0"===t&&i&&(0,n.getFGLoadedValue)("response_header_user_logout",{source:a.FGBuiltinNames.tea,defaultValue:!1}).then(t=>{if(t)try{(0,s.getFlowAccount)().passportApi.logout({reason:"response_header_user_logout",trackMeta:{from:"chat_completion_response_header",logout_resp_header_logid:e.headers.get("x-tt-logid")}})}catch(e){}})}},531102:function(e,t,i){i.d(t,{getFPForVerifyCenter:function(){return s},getTTVerifyCenter:function(){return r}});var n=i(643404);let a=null,r=async()=>await (0,n.retryLoadWithFallBack)({fn:async()=>await i.e("48606").then(i.bind(i,829707))}),s=async()=>{if(a)return a;let e=await r();return a=await e.getFp()}},935257:function(e,t,i){i.r(t),i.d(t,{defaultReceiveMessageSuggestPluginMatcher:function(){return l},suggestsMessageBlockPluginMatcher:function(){return o}});var n=i(469252),a=i(179778),r=i(226982),s=i(629006);let o={pluginIdentifier:a.suggestsMessageBlockPluginIdentifier,matchContentBlock:e=>e===r.ContentType.SamanthaSuggest},l={pluginIdentifier:n.defaultReceiveMessageSuggestPluginIdentifier,matchPlugin:e=>(0,s.isWiderCodeMessage)(e)}}}]);