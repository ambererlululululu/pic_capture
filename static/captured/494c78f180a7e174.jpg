"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["99632"],{883147:function(e,s,a){a.d(s,{checkIsRemoteMessageLessThanMessageInLocal:function(){return n},checkIsRemoteMessageLessThenOrEqualToMessageInLocal:function(){return i}});var t=a(4137);let i=(e,s)=>{let a=e.chunk_seq,i=null==s?void 0:s.chunk_seq;return!!(!(0,t.default)(a)&&!(0,t.default)(i)&&Number(a)<=Number(i))},n=(e,s)=>{let a=e.chunk_seq,i=null==s?void 0:s.chunk_seq;return!!(!(0,t.default)(a)&&!(0,t.default)(i)&&Number(a)<Number(i))}},239705:function(e,s,a){a.d(s,{abortPullMessage:function(){return l},handleRegisterAbortHttpLongPollingPullMessage:function(){return n},handleRegisterHttpChunkPullMessage:function(){return i}});var t=a(689368);let i=async e=>{let s=await (0,t.getChatProtocolPlugin)("AliceChatStream");null==s||s.pullMessage([e])},n=async e=>{let s=await (0,t.getChatProtocolPlugin)("AliceChatFallback");null==s||s.cancelTask(e)},l=async e=>{let{replyId:s,localMessageId:a}=e;if(s){let e=await (0,t.getChatProtocolPlugin)("AliceChatStream"),a=await (0,t.getChatProtocolPlugin)("AliceChatFallback");null==e||e.cancelTask(s),null==a||a.cancelTask(s)}if(a){let e=await (0,t.getChatProtocolPlugin)("SamanthaChat");null==e||e.cancelTask(a)}}},796349:function(e,s,a){a.d(s,{handleUpdateMessage:function(){return I}});var t=a(459735),i=a(4137),n=a(519428),l=a(226982),g=a(101874),o=a(674157),r=a(629006),c=a(883147),d=a(461141),u=a(689368),M=a(516655),m=a(785926),f=a(230932),_=a(645298),v=a(178230),p=a(251132),h=a(687780),S=a(637319),y=a(745829),L=a(83990),k=a(277828),R=a(702427),B=a(555897);let I=e=>{var s,a;let I=L.useMessageStore.getState(),{conversation_id:C,message_id:E,reply_id:P="",stream_id:b}=e,T=!!(null===(s=e.content_blocks)||void 0===s?void 0:s.find(e=>e.block_type===l.ContentType.SamanthaSuggest));try{let s=(0,m.conversationTypeByIdSelector)(f.useFeedStore.getState(),C),a=(0,o.isMessageFinished)(e),l=(0,r.isMessageFailed)(e),h=(0,r.isMessageIllegalError)(e),w=(0,r.isOnBoardingMessage)(e),A=(0,o.isRegenerateMessage)(e),F=(0,r.isFinishReplyLocalMessage)(e),D=(0,r.isBrokenMessage)(e),U=w?_.onBoardingConstantMessageId:P;if(I.updateMessageList({conversationId:C,immerUpdate:function(){for(var o,r,M,m,f=arguments.length,h=Array(f),S=0;S<f;S++)h[S]=arguments[S];let[L]=h,{draftLocalMessageMap:R,draftMessageMap:B,draftMessageLinks:I,draftRegenerateMessageMap:P}=L,T=!!B[E],w=R[E];if(!T&&!w){let{messageLink:a}=(0,p.deleteMockReceivingMessageCreatedBySending)(L,U,b)||{};(0,p.addLocalReceivingMessage)({isRegenerate:A,immerUpdateMessage:h,newLocalMessageId:E,messageId:"",conversationId:C,replyId:U,message:e,sectionId:e.section_id,localMessageStatus:g.LocalMessageStatus.ReceivingStream,conversationType:s,skillType:null==e?void 0:null===(o=e.skill)||void 0===o?void 0:o.skill_type}),(0,p.appendLocalReceivingMessageLink)({isRegenerate:A,immerUpdateMessage:h,newLocalMessageId:E,messageKey:null!==(r=null==a?void 0:a.messageKey)&&void 0!==r?r:(0,k.createLocalMessageKey)()}),w=R[E]}if(!T&&w){if((0,c.checkIsRemoteMessageLessThanMessageInLocal)(e,w))return;let{receiveStreamPackageUpdateTimeout:s=_.defaultReceiveStreamPackageUpdateTimeout}=(0,d.getChatConfig)("chatMessageConfig")||{};if(R[E]={...w,local:{...w.local,status:g.LocalMessageStatus.ReceivingStream,failed:!1,failedExpired:a||l?void 0:Date.now()+s},...(0,t.default)(e,i.default),local_message_id:w.local_message_id},a){if(v.logger.console.info({namespace:null===(M=e.local_info)||void 0===M?void 0:M.from,message:"replaceLocalMessageByRemote",meta:{message:e}}),(0,y.replaceLocalMessageByRemote)({draft:L,localMessage:w,message:e}),w.local.isRegenerate){let s=(0,n.default)(e);s.is_regen=!0,s.regen_active=!0,P.messageMap={...P.messageMap,[E]:s}}U&&(0,u.getChatProtocolPlugin)("AliceChatFallback").then(e=>null==e?void 0:e.cancelTask(U))}}else{let s=B[E];if((0,c.checkIsRemoteMessageLessThanMessageInLocal)(e,s))return;B[E]=e,T||I.push({isLocalMessage:!1,messageId:E}),a&&v.logger.persist.info({namespace:null===(m=e.local_info)||void 0===m?void 0:m.from,message:"Receive Non-local Finished Message",meta:{message_id:E,conversation_id:C,is_exist:T}})}}}),e.section_id&&!h){let s=w?void 0:(0,S.getMessageSelector)(L.useMessageStore.getState(),C,{isLocalMessage:!1,messageId:U});(null==s?void 0:s.section_id)!==e.section_id&&f.useFeedStore.getState().updateLastSectionId(C,e.section_id)}let N=(0,r.isMessageHasSuggest)(e);if(a&&N&&e.reply_id){let{receiveStreamPackageUpdateTimeout:e=_.defaultReceiveStreamPackageUpdateTimeout}=(0,d.getChatConfig)("chatMessageConfig")||{};I.updateSuggestMessage(C,()=>({replyId:P,loading:!0,failed:!1,expired:Date.now()+e,suggests:[]}))}F&&N&&I.updateSuggestMessage(C,()=>{});let q=R.messageLifeCycleManager.getSessionIdBySentMessageId(C,P);F||(T?(0,B.emitSuggestReceivingUpdate)(C,q,e):(0,B.toggleMessageReceivingEmitter)(C,q,e)),l?(0,B.emitBatchMessageReceivingEndByError)(C,q,e):D?(0,B.emitBatchMessageReceivingEndByBreak)(C,q,e):a&&N&&!F?(0,B.emitBatchMessageReceivingEndBySuccessAndStartSuggestionReceiving)(C,q,e):F&&(T?(0,B.emitSuggestReceivingEnd)(C,q,e):(0,B.emitBatchMessageReceivingEndBySuccessAndEndMessageSession)(C,q,e)),(0,M.getMessageErrorPluginMatcher)().then(s=>{let a=s.filter(s=>s.matchPlugin(e)).map(e=>e.pluginIdentifier);(0,u.getMessageErrorPluginList)(a).then(s=>{s.forEach(s=>{var a;null==s||null===(a=s.handleReceivingMessageError)||void 0===a||a.call(s,e)})}),a.length>0&&v.logger.persist.warning({message:"receive message failed"})})}catch(i){let s=(0,n.default)(e);s.final_status={message:null===(a=s.final_status)||void 0===a?void 0:a.message,session:(0,h.getLifeCycleError)(i)};let t=R.messageLifeCycleManager.getSessionIdBySentMessageId(C,P);throw T?(0,B.emitSuggestReceivingEnd)(C,t,e):((0,B.emitMessageReceivingEndByError)(C,t,s),(0,B.emitBatchMessageReceivingEndByError)(C,t,s)),i}}},251132:function(e,s,a){a.d(s,{addLocalReceivingMessage:function(){return v},appendLocalReceivingMessageLink:function(){return p},deleteMockReceivingMessageCreatedBySending:function(){return S},filterLocalReceivingMessageLink:function(){return h},getAllLocalMessageByEqualReplyId:function(){return _}});var t=a(918404),i=a(266655),n=a(754358),l=a(101874),g=a(840738),o=a(461141),r=a(645298),c=a(458524),d=a(752544),u=a(884068),M=a(630768),m=a(140666),f=a(745829);function _(e,s){let{conversationId:a,replyId:n}=s,l=(0,t.default)(e.localMessageMap[a],e=>(null==e?void 0:e.reply_id)===n);return(0,i.default)(l)}function v(e){var s;let{isRegenerate:a,immerUpdateMessage:t,newLocalMessageId:i,conversationId:n,replyId:l,sectionId:g,message:m={},timeout:f=0,localMessageStatus:_}=e,[v]=t,{receiveMessageStartTimeout:p=r.defaultReceiveMessageStartTimeout}=(0,o.getChatConfig)("chatMessageConfig")||{},h=(0,d.createGetRemoteMessage)({messageMap:v.draftMessageMap});v.draftLocalMessageMap[i]=(0,u.createLocalMessage)({prevMessageId:a?null===(s=(0,M.findLastRemoteMessageLink)(v.draftMessageLinks,e=>{var s;return(null===(s=h(e))||void 0===s?void 0:s.reply_id)===l}))||void 0===s?void 0:s.messageId:l,localMessageStatus:_,message:{...m,is_delta:!1,user_type:c.UserType.Bot,conversation_id:n,section_id:g,local_message_id:i,reply_id:l},failedExpired:Date.now()+(1e3*Number(f)||p),messageLinks:v.draftMessageLinks,isRegenerate:a})}function p(e){let{immerUpdateMessage:s,newLocalMessageId:a,messageKey:t}=e,[i]=s;if(!(0,n.default)(i.draftMessageLinks,e=>e.messageId===a)){let e={isLocalMessage:!0,messageId:a,...t?{messageKey:t}:{}};i.draftMessageLinks.push(e)}}function h(e){let[s]=e,{draftLocalMessageMap:a,draftMessageLinks:t,draftMessageMap:i}=s;t.filter(e=>{var s,t;let{isLocalMessage:i,messageId:n}=e;return i&&(null===(t=a[n])||void 0===t?void 0:null===(s=t.local)||void 0===s?void 0:s.status)===l.LocalMessageStatus.ReceivingFirstPackage}).sort((e,s)=>(0,m.compareMessageIndex)(i[a[s.messageId].reply_id||""],i[a[e.messageId].reply_id||""])).forEach((e,a)=>{a&&(0,f.logicalDeleteMessage)(s,e)})}function S(e,s,a){let{draftLocalMessageMap:t}=e,i=(0,g.getTemporaryReplyMessageId)(s,a),n=(0,g.getTemporaryReplyMessageId)(s),l=t[r.mockReplyConstantMessageId],o=t[n],c=t[i];return l?(0,f.deleteLocalReceivingMessage)(e,r.mockReplyConstantMessageId):o?(0,f.deleteLocalReceivingMessage)(e,n):c?(0,f.deleteLocalReceivingMessage)(e,i):void 0}},680982:function(e,s,a){a.d(s,{handleLocalBreak:function(){return B}});var t=a(519428),i=a(678669),n=a(70692),l=a.n(n),g=a(101874),o=a(725705),r=a(674157),c=a(629006),d=a(831566),u=a(458524),M=a(910214),m=a(856392),f=a(178230),_=a(425311),v=a(630768),p=a(637319),h=a(83990),S=a(702427),y=a(555897),L=a(796349),k=a(239705);async function R(e,s,a,n){if(!a)return;let{message_id:v,local_message_id:R,reply_id:B}=a,I=e.getState();if((0,o.isLocalMessage)(a)&&((0,r.isMessageSending)(a)||(0,c.isMessageSendingRegenerate)(a)||(0,r.isMessageWaitingAck)(a))){I.finishSendMessageTask(R),await I.updateMessageList({conversationId:s,immerUpdate:e=>{let{draftLocalMessageMap:s}=e,t=s[(null==a?void 0:a.local_message_id)||""];t&&(t.local.hasBroken=!0,t.status=u.PushMessageStatus.InVisible,t.local.status=g.LocalMessageStatus.Broken)}}),d.DeprecatedChatEvent.emit("chat.localBreak");let e=(0,t.default)(a);e.final_status={message:"Broken",session:"Broken"};let i=S.messageLifeCycleManager.getSessionIdBySentMessageId(s,a.local_message_id||"");await (0,y.emitMessageSendingEndByBreak)(s,i,e),await (0,k.abortPullMessage)({localMessageId:(0,r.isMessageWaitingAck)(a)?null==a?void 0:a.reply_id:null==a?void 0:a.local_message_id});return}if(!(0,r.isMessageFinished)(a)||(0,o.isLocalMessage)(a)&&(0,c.isMessageReceiving)(a)){let e=(0,p.getMessageSelector)(h.useMessageStore.getState(),s,{isLocalMessage:!1,messageId:B||""});if((0,o.isLocalMessage)(a)&&(0,r.isMessageReceivingFirstPackage)(a))await I.updateMessageList({conversationId:s,immerUpdate:e=>{let{draftLocalMessageMap:i,draftMessageLinks:n}=e,l=i[R||""];l&&(l.local.hasBroken=!0,l.status=u.PushMessageStatus.InVisible,l.local.status=g.LocalMessageStatus.Broken,l.final_status={message:"Broken",session:"Broken"});let o=n.find(e=>e.messageId===R);o&&(o.messageKey=`${o.messageId}_break`);let r=S.messageLifeCycleManager.getSessionIdBySentMessageId(s,a.reply_id||"");(0,y.emitBatchMessageReceivingEndByBreak)(s,r,(0,t.default)(l))}});else if(((0,o.isLocalMessage)(a)&&(0,c.isMessageReceivingStream)(a)||!(0,r.isMessageFinished)(a))&&v){let e={conversation_id:s,message_id:v,...(0,i.default)(a,["local","local_message_id"]),status:u.PushMessageStatus.Broken,chunk_seq:"999999",is_finish:!0,is_delta:!1,final_status:{message:"Broken",session:"Broken"}};(0,L.handleUpdateMessage)(e)}await (0,k.abortPullMessage)({replyId:B||"",localMessageId:null==e?void 0:e.local_message_id}),d.DeprecatedChatEvent.emit("chat.localBreak");let C=B||v,E=(0,m.createReportEvent)({eventName:"break_message"});if(!function(e){if(!e)return!1;let s=(0,_.transToMilliSecondIfIsSecond)(Number(e.create_time||Date.now()));return l()().isBefore(l()(s).add(10,"minute"))}(a)||!C||(null==s?void 0:s.startsWith("local"))||(0,c.isBrokenMessage)(a)){f.logger.persist.log({eventName:"break_message_invalid",meta:{replyId:String(C),conversation_id:String(s),is_finished:(0,r.isMessageFinished)(a)?"1":"0",create_time:String(a.create_time),message_type:String(a.message_type),content_type:String(a.content_type),status:String(a.status),localMessageStatus:(0,o.isLocalMessage)(a)&&String(a.local.status)}});return}M.messageApiService.MessageReport({reply_id:C,conversation_id:s,action:"break"}).then(()=>{E.addDurationPoint("success"),E.success()},e=>{E.error({reason:"break message failed",error:e,meta:{replyId:String(C),conversation_id:String(s),is_finished:(0,r.isMessageFinished)(a)?"1":"0",create_time:String(a.create_time),message_type:String(a.message_type),content_type:String(a.content_type),status:String(a.status),localMessageStatus:(0,o.isLocalMessage)(a)&&String(a.local.status)}}),null==n||n()})}}async function B(e,s){let a=e.getState(),t=(0,p.getLastStreamingMessageSelector)(a,s);if((0,c.isBatchMessage)(t)){let a=(0,v.findLatestBatchMessages)(s);(null==a?void 0:a.length)&&await Promise.all(null==a?void 0:a.map(a=>R(e,s,a)))}else{if((0,r.isAsyncTaskMessage)(t))return;await R(e,s,t)}}}}]);